{% extends "base.html" %}

{% block title %}הצעות מחיר - מערכת CRM{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-file-contract ms-2"></i>
        הצעות מחיר
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createProposalModal">
                <i class="fas fa-plus ms-1"></i>
                הצעת מחיר חדשה
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-file-pdf ms-1"></i>
                הוצאת דוח
            </button>
        </div>
    </div>
</div>

<!-- Proposal Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">{{ total_proposals or 0 }}</h5>
                <p class="card-text">סה"כ הצעות</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">{{ accepted_proposals or 0 }}</h5>
                <p class="card-text">אושרו</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h5 class="card-title">{{ pending_proposals or 0 }}</h5>
                <p class="card-text">ממתינות</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">{{ total_value or 0 }}₪</h5>
                <p class="card-text">סה"כ שווי</p>
            </div>
        </div>
    </div>
</div>

<!-- Proposals List -->
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">רשימת הצעות מחיר</h5>
            </div>
            <div class="col-auto">
                <div class="row g-2">
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="statusFilter" onchange="filterProposals()">
                            <option value="">כל הסטטוסים</option>
                            <option value="draft">טיוטה</option>
                            <option value="sent">נשלחה</option>
                            <option value="viewed">נצפתה</option>
                            <option value="accepted">אושרה</option>
                            <option value="rejected">נדחתה</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="חיפוש..." onkeyup="filterProposals()">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="proposalsTable">
                <thead class="table-dark">
                    <tr>
                        <th>מס' הצעה</th>
                        <th>לקוח</th>
                        <th>כותרת</th>
                        <th>סכום</th>
                        <th>סטטוס</th>
                        <th>תאריך יצירה</th>
                        <th>תאריך תפוגה</th>
                        <th>פעולות</th>
                    </tr>
                </thead>
                <tbody>
                    {% if proposals %}
                        {% for proposal in proposals %}
                        <tr>
                            <td>
                                <span class="fw-bold">#{{ proposal.id or 'חדש' }}</span>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-bold">{{ proposal.customer_name or 'לא ידוע' }}</div>
                                    <small class="text-muted">{{ proposal.customer_phone or 'ללא טלפון' }}</small>
                                </div>
                            </td>
                            <td>{{ proposal.title or 'ללא כותרת' }}</td>
                            <td>
                                <span class="fw-bold">{{ "{:,.0f}".format(proposal.total_amount) if proposal.total_amount else 0 }}₪</span>
                            </td>
                            <td>
                                {% if proposal.status == 'accepted' %}
                                    <span class="badge bg-success">אושרה</span>
                                {% elif proposal.status == 'sent' %}
                                    <span class="badge bg-info">נשלחה</span>
                                {% elif proposal.status == 'viewed' %}
                                    <span class="badge bg-primary">נצפתה</span>
                                {% elif proposal.status == 'rejected' %}
                                    <span class="badge bg-danger">נדחתה</span>
                                {% else %}
                                    <span class="badge bg-secondary">טיוטה</span>
                                {% endif %}
                            </td>
                            <td>{{ proposal.created_at.strftime('%d/%m/%Y') if proposal.created_at else 'לא ידוע' }}</td>
                            <td>
                                {% if proposal.expiry_date %}
                                    {% if proposal.expiry_date < today %}
                                        <span class="text-danger">{{ proposal.expiry_date.strftime('%d/%m/%Y') }}</span>
                                    {% else %}
                                        {{ proposal.expiry_date.strftime('%d/%m/%Y') }}
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">ללא תפוגה</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="viewProposal({{ proposal.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" onclick="editProposal({{ proposal.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% if proposal.status == 'draft' %}
                                    <button type="button" class="btn btn-outline-success" onclick="sendProposal({{ proposal.id }})">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-info" onclick="downloadProposal({{ proposal.id }})">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="duplicateProposal({{ proposal.id }})">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="fas fa-file-contract fa-3x mb-3"></i>
                                    <p>עדיין אין הצעות מחיר במערכת</p>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProposalModal">
                                        צור הצעת מחיר ראשונה
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Proposal Modal -->
<div class="modal fade" id="createProposalModal" tabindex="-1" aria-labelledby="createProposalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProposalModalLabel">יצירת הצעת מחיר חדשה</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="סגור"></button>
            </div>
            <form action="/proposals/create" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proposalCustomer" class="form-label">לקוח *</label>
                                <select class="form-select" id="proposalCustomer" name="customer_id" required>
                                    <option value="">בחר לקוח...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.name }} - {{ customer.phone }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proposalTitle" class="form-label">כותרת ההצעה *</label>
                                <input type="text" class="form-control" id="proposalTitle" name="title" required placeholder="לדוגמה: הצעת מחיר לאתר אינטרנט">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proposalValidUntil" class="form-label">תוקף ההצעה</label>
                                <input type="date" class="form-control" id="proposalValidUntil" name="valid_until">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proposalCategory" class="form-label">קטגוריה</label>
                                <select class="form-select" id="proposalCategory" name="category">
                                    <option value="">בחר קטגוריה...</option>
                                    <option value="website">פיתוח אתרים</option>
                                    <option value="marketing">שיווק דיגיטלי</option>
                                    <option value="consulting">ייעוץ</option>
                                    <option value="maintenance">תחזוקה</option>
                                    <option value="design">עיצוב</option>
                                    <option value="other">אחר</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="proposalDescription" class="form-label">תיאור ההצעה</label>
                        <textarea class="form-control" id="proposalDescription" name="description" rows="4" placeholder="תיאור מפורט של השירות או המוצר..."></textarea>
                    </div>
                    
                    <!-- Items Section -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">פריטי ההצעה</h6>
                        </div>
                        <div class="card-body">
                            <div id="proposalItems">
                                <div class="row proposal-item mb-2">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" name="item_name[]" placeholder="שם הפריט" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="item_quantity[]" placeholder="כמות" value="1" min="1" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="item_price[]" placeholder="מחיר יחידה" step="0.01" required onchange="calculateTotal()">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control item-total" readonly placeholder="סה״כ">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItem()">
                                <i class="fas fa-plus ms-1"></i>
                                הוסף פריט
                            </button>
                        </div>
                    </div>
                    
                    <!-- Totals -->
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span>סכום ביניים:</span>
                                        <span id="subtotal">0₪</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>מע"ם (17%):</span>
                                        <span id="vat">0₪</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>סה"כ:</span>
                                        <span id="total">0₪</span>
                                    </div>
                                    <input type="hidden" name="total_amount" id="totalAmount" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendImmediately" name="send_immediately">
                            <label class="form-check-label" for="sendImmediately">
                                שלח מיד ללקוח
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">צור הצעת מחיר</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function addItem() {
    const itemsContainer = document.getElementById('proposalItems');
    const newItem = document.createElement('div');
    newItem.className = 'row proposal-item mb-2';
    newItem.innerHTML = `
        <div class="col-md-5">
            <input type="text" class="form-control" name="item_name[]" placeholder="שם הפריט" required>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" name="item_quantity[]" placeholder="כמות" value="1" min="1" required>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" name="item_price[]" placeholder="מחיר יחידה" step="0.01" required onchange="calculateTotal()">
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control item-total" readonly placeholder="סה״כ">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    itemsContainer.appendChild(newItem);
}

function removeItem(button) {
    button.closest('.proposal-item').remove();
    calculateTotal();
}

function calculateTotal() {
    let subtotal = 0;
    
    document.querySelectorAll('.proposal-item').forEach(item => {
        const quantity = parseFloat(item.querySelector('input[name="item_quantity[]"]').value) || 0;
        const price = parseFloat(item.querySelector('input[name="item_price[]"]').value) || 0;
        const itemTotal = quantity * price;
        
        item.querySelector('.item-total').value = itemTotal.toFixed(2) + '₪';
        subtotal += itemTotal;
    });
    
    const vat = subtotal * 0.17;
    const total = subtotal + vat;
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2) + '₪';
    document.getElementById('vat').textContent = vat.toFixed(2) + '₪';
    document.getElementById('total').textContent = total.toFixed(2) + '₪';
    document.getElementById('totalAmount').value = total.toFixed(2);
}

function filterProposals() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#proposalsTable tbody tr');
    
    rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        if (cells.length === 1) return; // Skip empty state row
        
        const customer = cells[1].textContent.toLowerCase();
        const title = cells[2].textContent.toLowerCase();
        const status = row.querySelector('.badge')?.textContent.trim().toLowerCase() || '';
        
        const matchesSearch = customer.includes(searchTerm) || title.includes(searchTerm);
        const matchesStatus = !statusFilter || status.includes(statusFilter);
        
        if (matchesSearch && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function viewProposal(proposalId) {
    window.open(`/proposals/view/${proposalId}`, '_blank');
}

function editProposal(proposalId) {
    window.location.href = `/proposals/edit/${proposalId}`;
}

function sendProposal(proposalId) {
    if (confirm('האם לשלוח את הצעת המחיר ללקוח?')) {
        fetch(`/proposals/send/${proposalId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('הצעת המחיר נשלחה בהצלחה');
                location.reload();
            } else {
                alert('שגיאה בשליחת ההצעה: ' + data.message);
            }
        });
    }
}

function downloadProposal(proposalId) {
    window.open(`/proposals/download/${proposalId}`, '_blank');
}

function duplicateProposal(proposalId) {
    if (confirm('האם ליצור עותק של הצעת המחיר?')) {
        fetch(`/proposals/duplicate/${proposalId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('הצעת המחיר שוכפלה בהצלחה');
                location.reload();
            } else {
                alert('שגיאה בשכפול ההצעה: ' + data.message);
            }
        });
    }
}

// Set minimum date to today
document.getElementById('proposalValidUntil').min = new Date().toISOString().split('T')[0];

// Calculate total when inputs change
document.addEventListener('change', function(e) {
    if (e.target.name === 'item_quantity[]' || e.target.name === 'item_price[]') {
        calculateTotal();
    }
});
</script>
{% endblock %}