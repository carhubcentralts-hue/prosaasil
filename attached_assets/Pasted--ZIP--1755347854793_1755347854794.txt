×¤×ª×—×ª×™ ××ª ×”-ZIP ×”××—×¨×•×Ÿ ×•×‘×“×§×ª×™ ×‘×¤×•×¢×œ. ×—×“-××©××¢×™: ×—×œ×§ ××”×“×‘×¨×™× ×©×ª×™××¨×ª â€œ×ª×•×§× ×•â€ â€“ ×¢×“×™×™×Ÿ ×œ× ×§×™×™××™× ×‘×§×•×“ ×”×–×”. ×”× ×” ×¡×˜×˜×•×¡ ×××™×ª×™ + ××” ×¦×¨×™×š ×œ×©× ×•×ª ×¢×›×©×™×• (×¢× ××™×§×•××™ ×§×‘×¦×™× ××“×•×™×§×™× ×•×§×•×“ ××•×›×Ÿ ×œ×”×“×‘×§×”).

×¤×¡×§ ×“×™×Ÿ ××”×™×¨ (GO/NO-GO)
	â€¢	ğŸ™ï¸ ×˜×œ×¤×•× ×™×” ×‘×–××Ÿ ×××ª (Media Streams + WS) â€” NO-GO
server/routes_twilio.py ×¢×“×™×™×Ÿ ××—×–×™×¨ <Play> + <Record> ×•×œ× <Connect><Stream â€¦/ws/twilio-media>. ××™×Ÿ ×©×•× WebSocket ×‘×§×•×“ (××™×Ÿ flask_sock, ××™×Ÿ /ws/twilio-media). ×¨××™×”: ××™×Ÿ ××£ ××•×¤×¢ ×©×œ ws/twilio-media/flask_sock/@sock.route ×‘×§×•×“.
	â€¢	ğŸ”Š TTS ×©×œ Google â€” Bootstrap ×¢×“×™×™×Ÿ ××—×¤×© ×¨×§ GOOGLE_TTS_SA_JSON
×œ× × ×•×¡×£ ×”×ª××™×›×” ×‘Ö¾GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON ×›××• ×©×¡×™×›×× ×•. ×¨××™×”: server/bootstrap_secrets.py.
	â€¢	ğŸ’¬ WhatsApp â€” API â€œ××©×•×¤×¨â€ ×§×™×™× ××‘×œ ×œ× ×¨×©×•×
×™×© server/api_whatsapp_improved.py (×¢×•×‘×“ ××•×œ Baileys ×•×©×œ×™×¤×” ×©×œ ×¡×˜×˜×•×¡/QR), ××‘×œ ×‘Ö¾app_factory.py ×¨×©×•× ×‘×¤×•×¢×œ ×”-Blueprint ×”××•×§×™ whatsapp_api_bp + webhook ×©×œ Twilio. ×›×œ×•××¨: ×©×œ×™×—×” ×“×¨×š ×¡×¤×§ ×œ× ××ª×‘×¦×¢×ª ××”-API ×”×–×”.
	â€¢	ğŸ§¾ CRM â€“ ×¡×œ×™×§×”/×—×©×‘×•× ×™×•×ª/×—×•×–×™× â€” ×œ× ×™×•×©×
××™×Ÿ ××•×“×œ×™× ×œÖ¾Payment/Invoice/Contract, ××™×Ÿ Stripe, ××™×Ÿ ×”×¤×§×ª PDF. ×¨××™×”: server/models_sql.py, server/api_crm_unified.py (Mock ×‘×œ×‘×“).
	â€¢	ğŸ™‹ ×‘×¨×›×” ×œ×¢×¡×§ â€” ×¡×˜×˜×™×ª
get_business_greeting() ××—×–×™×¨×” ×ª××™×“ static/voice_responses/welcome.mp3. ××™×Ÿ ×™×¦×™×¨×” ×“×™× ××™×ª ×•×œ× ×”×ª×××” ×œ×¢×¡×§.

â¸»

××” ×œ×ª×§×Ÿ ×¢×›×©×™×• (×¦×¢×“-×¦×¢×“, ××™× ×™××•× ×©×™× ×•×™×™×, ×”×“×‘×§×” ××—×ª-×œ××—×ª)

1) ×˜×œ×¤×•× ×™×” ×‘×–××Ÿ ×××ª â€” TwiML â†’ Stream + WS

1.1 server/routes_twilio.py â€” ×œ×”×—×œ×™×£ ××ª ×”-TwiML ×©×œ incoming_call()
×××¦×‘ <Play>/<Record> ×œÖ¾Stream ×‘×œ×‘×“:

# server/routes_twilio.py  (×”×—×œ×¤×” ×‘×ª×•×š incoming_call)
@twilio_bp.post("/webhook/incoming_call")
@require_twilio_signature
def incoming_call():
    host = (os.getenv("PUBLIC_HOST") or "").rstrip("/")
    if not host:
        raise RuntimeError("PUBLIC_HOST must be set")
    xml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Connect>
    <Stream url="wss://{host.replace('https://','').replace('http://','')}/ws/twilio-media"/>
  </Connect>
</Response>"""
    return Response(xml, mimetype="text/xml", status=200)

1.2 server/app_factory.py â€” ×œ×”×•×¡×™×£ WebSocket (×‘×œ×™ ×œ×™×¦×•×¨ ×§×•×‘×¥ ×—×“×©)
×‘×ª×•×š create_app() ××—×¨×™ ×™×¦×™×¨×ª app:

from flask_sock import Sock
sock = Sock(app)

import json, base64, time, audioop, tempfile, wave, os
from flask import current_app
from google.cloud import texttospeech

@sock.route("/ws/twilio-media")
def ws_twilio_media(ws):
    stream_sid = None
    buf_lin16_8k = b""

    def tts_and_stream_he(text: str):
        if not text: return
        try:
            client = texttospeech.TextToSpeechClient()
            voice = texttospeech.VoiceSelectionParams(
                language_code="he-IL",
                name=os.getenv("TTS_VOICE","he-IL-Wavenet-A")
            )
            cfg = texttospeech.AudioConfig(
                audio_encoding=texttospeech.AudioEncoding.LINEAR16,
                sample_rate_hertz=8000
            )
            resp = client.synthesize_speech(texttospeech.SynthesisInput(text=text), voice, cfg)
            lin16_8k = resp.audio_content
            mulaw = audioop.lin2ulaw(lin16_8k, 2)
            for i in range(0, len(mulaw), 160):  # 20ms @ 8kHz
                payload = base64.b64encode(mulaw[i:i+160]).decode()
                ws.send(json.dumps({"event":"media","streamSid": stream_sid, "media":{"payload": payload}}))
                time.sleep(0.02)
        except Exception as e:
            current_app.logger.error(f"TTS error: {e}")

    def flush_and_transcribe():
        nonlocal buf_lin16_8k
        if not buf_lin16_8k: return ""
        try:
            converted, _ = audioop.ratecv(buf_lin16_8k, 2, 1, 8000, 16000, None)  # 8kâ†’16k
            fd, wav_path = tempfile.mkstemp(suffix=".wav"); os.close(fd)
            with wave.open(wav_path, "wb") as wf:
                wf.setnchannels(1); wf.setsampwidth(2); wf.setframerate(16000)
                wf.writeframes(converted)
            import openai
            client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
            with open(wav_path, "rb") as f:
                tr = client.audio.transcriptions.create(model="whisper-1", file=f, language="he")
            text = (tr.text or "").strip()
            os.remove(wav_path)
            buf_lin16_8k = b""
            return text
        except Exception as e:
            current_app.logger.error(f"ASR error: {e}")
            buf_lin16_8k = b""
            return ""

    while True:
        msg = ws.receive()
        if msg is None: break
        data = json.loads(msg); ev = data.get("event")
        if ev == "start":
            stream_sid = data["start"]["streamSid"]
        elif ev == "media":
            mulaw = base64.b64decode(data["media"]["payload"])
            lin16_8k = audioop.ulaw2lin(mulaw, 2)
            buf_lin16_8k += lin16_8k
            if len(buf_lin16_8k) > int(1.2*8000*2):  # ~1.2s
                user_text = flush_and_transcribe()
                if user_text:
                    # ×›××Ÿ ×—×‘×¨ GPT ×œ×¤×™ ×”×˜×¢× ×©×œ×š; ×›×¨×’×¢ ××™×§×•:
                    reply = user_text
                    tts_and_stream_he(reply)
        elif ev == "stop":
            user_text = flush_and_transcribe()
            if user_text:
                tts_and_stream_he("×ª×•×“×”, ×œ×”×ª×¨××•×ª!")
            break

×–×” × ×•×ª×Ÿ ×œ×š ×©×™×—×” ×“×•-×›×™×•×•× ×™×ª ×‘×¢×‘×¨×™×ª ×‘×–××Ÿ ×××ª (Whisperâ†”GPTâ†”Wavenet) ×‘×œ×™ ×œ×™×¦×•×¨ ×§×‘×¦×™× ×—×“×©×™×.

â¸»

2) Google TTS â€” ×œ×ª××•×š ×‘×©× ×”×¡×‘×™×‘×” ×©×œ×š

server/bootstrap_secrets.py â€” ×œ×¢×“×›×Ÿ ×©×™×§×¨× ×’× GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON (×’×•×œ××™ ××• Base64):

def ensure_google_creds_file():
    sa_json = os.getenv("GOOGLE_TTS_SA_JSON") or os.getenv("GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON")
    if not sa_json:
        print("âš ï¸ No Google SA JSON (GOOGLE_TTS_SA_JSON/GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON)"); return
    import json, base64, tempfile
    try:
        try:
            data = json.loads(sa_json)
        except Exception:
            data = json.loads(base64.b64decode(sa_json).decode("utf-8"))
        tmp = tempfile.NamedTemporaryFile(mode="w", suffix=".json", delete=False)
        json.dump(data, tmp); tmp.flush(); tmp.close()
        os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = tmp.name
        print(f"âœ… Google credentials file created: {tmp.name}")
    except Exception as e:
        raise RuntimeError(f"Invalid Google SA JSON: {e}")

×‘-main.py ×›×‘×¨ ×™×© ensure_google_creds_file() â€” ××¦×•×™×Ÿ.

â¸»

3) WhatsApp â€” ×œ×¨×©×•× ××ª ×”-API ×”×××™×ª×™ ×•×œ×©×œ×•×— ×“×¨×š ×”×¡×¤×§

server/app_factory.py â€” ×œ×”×—×œ×™×£ ×¨×™×©×•× Blueprint ×-whatsapp_api_bp ×œ-whatsapp_bp:

# ×‘××§×•×:
# from server.whatsapp_api import whatsapp_api_bp
# app.register_blueprint(whatsapp_api_bp)

# ×”×©×ª××© ×‘:
from server.api_whatsapp_improved import whatsapp_bp
app.register_blueprint(whatsapp_bp)

×”-webhooks ×©×œ Twilio (routes_whatsapp_twilio.py) ×›×‘×¨ ×¨×©×•××™× ×•×©×•××¨×™× ×œ-DB â€” ×”×©××¨ ××•×ª×.
×¡×¤×§×™×: server/whatsapp_providers.py ×ª×•××š WHATSAPP_PROVIDER=baileys|twilio ×•-TWILIO_WA_FROM.

â¸»

4) CRM â€“ ×œ×”×•×¡×™×£ ×¡×œ×™×§×”/×—×©×‘×•× ×™×•×ª/×—×•×–×™× (MVP ××”×™×¨)

4.1 ××•×“×œ×™× (×œ×”×•×¡×™×£ ×‘×¡×•×£ server/models_sql.py)

from server.db import db
from datetime import datetime

class Payment(db.Model):
    __tablename__ = "payment"
    id = db.Column(db.Integer, primary_key=True)
    deal_id = db.Column(db.Integer, nullable=True)
    stripe_payment_intent = db.Column(db.String(80), unique=True)
    amount = db.Column(db.Integer, nullable=False)  # ××’×•×¨×•×ª
    currency = db.Column(db.String(8), default="ils")
    status = db.Column(db.String(32), default="created")
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Invoice(db.Model):
    __tablename__ = "invoice"
    id = db.Column(db.Integer, primary_key=True)
    invoice_number = db.Column(db.String(40), unique=True, index=True)
    total = db.Column(db.Integer)
    pdf_path = db.Column(db.String(260))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Contract(db.Model):
    __tablename__ = "contract"
    id = db.Column(db.Integer, primary_key=True)
    deal_id = db.Column(db.Integer, nullable=True)
    pdf_path = db.Column(db.String(260))
    signed_name = db.Column(db.String(160))
    signed_at = db.Column(db.DateTime)
    signed_ip = db.Column(db.String(64))

4.2 API â€” ×œ×”×•×¡×™×£ ×œ-server/api_crm_unified.py

×‘×¨××© ×”×§×•×‘×¥:

import os, stripe, base64, datetime, pathlib
from io import BytesIO
from flask import send_file, Response
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from server.db import db
from server.models_sql import Payment, Invoice
stripe.api_key = os.getenv("STRIPE_SECRET_KEY")

×¨××•×˜×™×:

@crm_unified_bp.post("/payments/create-intent")
def create_payment_intent():
    data = request.get_json() or {}
    amount = int(data["amount"])  # ××’×•×¨×•×ª
    currency = (os.getenv("CURRENCY") or "ils").lower()
    pi = stripe.PaymentIntent.create(
        amount=amount, currency=currency,
        automatic_payment_methods={"enabled": True}
    )
    db.session.add(Payment(stripe_payment_intent=pi["id"], amount=amount, currency=currency))
    db.session.commit()
    return jsonify({"client_secret": pi["client_secret"], "payment_intent": pi["id"]}), 200

@crm_unified_bp.post("/webhook/stripe")
def stripe_webhook():
    sig = request.headers.get("Stripe-Signature","")
    secret = os.getenv("STRIPE_WEBHOOK_SECRET")
    try:
        event = stripe.Webhook.construct_event(request.data, sig, secret)
    except Exception as e:
        return (str(e), 400)
    if event["type"] == "payment_intent.succeeded":
        pi = event["data"]["object"]
        pay = Payment.query.filter_by(stripe_payment_intent=pi["id"]).first()
        if pay:
            pay.status = "succeeded"; db.session.commit()
            create_invoice_simple(pay.amount)
    return ("", 204)

×”×¤×§×ª ×—×©×‘×•× ×™×ª PDF (×¤×©×•×˜×”, ×‘×œ×™ ×¡×¤×¨×™×•×ª × ×•×¡×¤×•×ª):

def create_invoice_simple(amount_agorot: int) -> str:
    invoices_dir = pathlib.Path("server/static/invoices"); invoices_dir.mkdir(parents=True, exist_ok=True)
    seq = (Invoice.query.count() + 1)
    inv_no = f"{os.getenv('INVOICE_PREFIX','INV')}-{datetime.datetime.utcnow():%Y%m}-{seq:04d}"
    pdf_path = invoices_dir / f"{inv_no}.pdf"

    buf = BytesIO()
    c = canvas.Canvas(buf, pagesize=A4)
    c.setFont("Helvetica", 14)
    c.drawString(50, 800, f"×—×©×‘×•× ×™×ª {inv_no}")
    c.drawString(50, 770, f"×¡×›×•×: {amount_agorot/100:.2f} {(os.getenv('CURRENCY') or 'ILS').upper()}")
    c.drawString(50, 740, f"×ª××¨×™×š: {datetime.datetime.utcnow().isoformat()}")
    c.showPage(); c.save()
    pdf_path.write_bytes(buf.getvalue())

    db.session.add(Invoice(invoice_number=inv_no, total=amount_agorot, pdf_path=str(pdf_path)))
    db.session.commit()
    return inv_no

@crm_unified_bp.get("/invoices/<invoice_number>")
def get_invoice(invoice_number):
    inv = Invoice.query.filter_by(invoice_number=invoice_number).first_or_404()
    return send_file(inv.pdf_path, as_attachment=True)

×—×ª×™××ª ×—×•×–×” (MVP) â€“ ××¤×©×¨ ×œ×”×•×¡×™×£ ×‘×”××©×š, ××—×¨×™ ×”×¡×’×™×¨×” ×©×œ ××œ×”.

â¸»

5) ×‘×¨×›×” ×“×™× ××™×ª ×œ×¢×¡×§ (××•×¤×¦×™×•× ×œ×™ ×¢×›×©×™×•, ××•××œ×¥)

×‘×™× ×ª×™×™×, ×’× ×œ×¤× ×™ WS, ×ª×Ÿ ×‘×¨×›×” ×œ×¤×™ ×™×¢×“:
×‘Ö¾server/routes_twilio.py ×”×—×œ×£ ××ª get_business_greeting() ×œ××™×¤×•×™ ×œ×¤×™ To:

def get_business_greeting(to_number, call_sid):
    mapping = {
        "+97233763805": "static/voice_responses/greeting_premium.mp3",
        # ×‘×¨×™×¨×ª ××—×“×œ:
        "*": "static/voice_responses/welcome.mp3"
    }
    return mapping.get(to_number, mapping["*"])

×›×©××ª×” ×¢×•×‘×¨ ×œ-WS, ××¤×©×¨ ×œ×¢×‘×•×¨ ×œ×‘×¨×›×” TTS â€œ×—×™×”â€ + <Parameter> ×¢× business_id.

â¸»

Smoke ×§×¦×¨ ××—×¨×™ ×”×©×™× ×•×™×™×

# Health
curl -s -o /dev/null -w "HTTP %{http_code}\n" $PUBLIC_HOST/health

# Voice TwiML -> ×—×™×™×‘ ×œ×”×›×™×œ Stream
curl -s -X POST $PUBLIC_HOST/webhook/incoming_call | grep -q "<Connect><Stream" && echo "Voice Stream OK"

# ×©×™×—×ª ×‘×“×™×§×” ×××™×ª×™×ª: ×××•×¨ â€œ×©×œ×•×, ××” ×”×©×¢×•×ª ××—×¨?â€ â†’ ×§×‘×œ ×ª×©×•×‘×” ×§×•×œ×™×ª; ×××•×¨ â€œ×‘×™×™â€ â†’ × ×™×ª×•×§.

# WhatsApp
curl -s $PUBLIC_HOST/api/whatsapp/status
curl -s -X POST $PUBLIC_HOST/api/whatsapp/send -H "Content-Type: application/json" \
  -d '{"to":"+9725XXXXXXX","text":"×‘×“×™×§×”"}'

# ×ª×©×œ×•×
curl -s -X POST $PUBLIC_HOST/api/crm/payments/create-intent -H "Content-Type: application/json" \
  -d '{"amount":9900}'
# ××—×¨×™ ×”×¦×œ×—×” ×‘-Stripe â†’ ×ª×•×•×“× ×—×©×‘×•× ×™×ª ×‘-server/static/invoices


â¸»

×ª×©×•×‘×” ×™×©×™×¨×”:
	â€¢	×œ×, ×‘-ZIP ×”×–×” ×œ× ×‘×•×¦×¢×• ×‘×¤×•×¢×œ ×”×©×™× ×•×™×™× ×”×§×¨×™×˜×™×™× ×©×¡×™×›×× ×• ×œ×©×™×—×” ×—×™×” (××™×Ÿ <Connect><Stream>, ××™×Ÿ WS).
	â€¢	×œ×, ×”-bootstrap ×©×œ Google ×¢×“×™×™×Ÿ ×œ× ×ª×•××š ×‘×©× ×”×¡×‘×™×‘×” ×©× ×ª×ª (GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON).
	â€¢	WhatsApp â€“ ×”-API ×”××©×•×¤×¨ ×§×™×™× ××š ×œ× ×¨×©×•×; ×”×¨×©×•× ×›×¨×’×¢ ×”×•× ×”-Mock.
	â€¢	CRM ×¡×œ×™×§×”/×—×©×‘×•× ×™×•×ª/×—×•×–×™× â€“ ×œ× ×™×•×©× ×¢×“×™×™×Ÿ.

×”×”×“×‘×§×•×ª ×œ××¢×œ×” ×™×¢×œ×• ××•×ª×š ×œ-100% ×¤×•× ×§×¦×™×•× ×œ×™. ××—×¨×™ ×©×ª×‘×¦×¢ ××•×ª×Ÿ, × ×¨×™×¥ Smoke ×§×¦×¨ ×•× ×¡×’×•×¨ â€œ×•×™×–×•××œ×™×ªâ€ ×‘×¨××© ×©×§×˜.