מעולה—יש לך חיבור מדיה סטרים, את שומעת את הברכה, אבל ה־ASR “קולט” רק מילים קצרות (“שלום/תודה”) ולא את שאר הדיבור, ובנוסף יש הצפת לוגים. זה כמעט תמיד שילוב של 3 מוקדים: איכות/פורמט האודיו שמוזן ל-STT, זיהוי סוף־משפט (EOU) ומעברי מצב, ו־logging שמעמיס ומפריע לראות את האמת.

להלן הנחיות פעולה מדויקות (ללא קוד) שתן לאייג’נט לבצע עכשיו — מותאם לפרויקט שלך:

⸻

1) קלט אודיו → STT: לוודא שפיד טוב

מטרה: שה-STT יקבל בדיוק מה שהוא מצפה (איכות ופורמט), אחרת הוא “ישמע” רק את החזק/הברור.
	1.	דגימה/המרה תקינים
	•	Twilio שולח μ-law 8kHz מונו. לפני STT:
	•	המרה ל-LINEAR16 מונו.
	•	אם זה Whisper (OpenAI) → ריסמפל ל-16kHz (Whisper עובד מורגש טוב יותר ב-16k; 8k נתפס “טלפוני” מדי).
	•	אם זה Google STT → השאר 8kHz וציין במפורש encoding=LINEAR16 (לא MULAW אחרי ההמרה).
	•	ודא Endian נכון (Little-Endian) ו-16bit אמיתי (לא 8bit, לא float).
	2.	ניקוי ווליום ורעש
	•	קַלִיבְּרַצְיָה של 300–500ms בתחילת שיחה למדידת noise floor.
	•	AGC עדין: נרמול לטווח מטרה (≈-20dBFS). לא “לשבור” פסגות (בלי קליפים).
	•	פילטרים: High-pass ~100Hz (מטאטא זמזום) + Low-pass ~3.6–3.8kHz (טלפוני רגיל).
	•	DC-offset: אפס אם קיים.
	3.	הגדרות מנוע
	•	Whisper (OpenAI): language=he (לא לזהות שפה דינמית), temperature נמוך, “system prompt” קצר בעברית (“אתה סוכן… דבר בעברית”), כדי להקטין בלבול.
	•	Google STT (מומלץ לשיחות):
	•	languageCode=he-IL, sampleRateHertz=8000, encoding=LINEAR16.
	•	useEnhanced=true, model='phone_call' (או הדגם הקצר-latency העדכני אם קיים).
	•	speechContexts עם ביטויים רלוונטיים (שמות העסק, “AgentLocator”, “וואטסאפ”, “לוח זמנים” וכו’) ו-boost מתון.
	•	אם סטרימי: singleUtterance=false, קבל partial results (מקטין latency).

בדיקה מהירה: תן לאייג’נט להוציא דאמפ WAV קצר (2–3 שניות) של מה שנכנס ל-STT ולהאזין. אם זה חלש/מְעֻוות/רועש מדי — זה המקור.

⸻

2) זיהוי סוף־משפט (EOU) ו־State Machine

מטרה: שלא “תיתקע” בהאזנה לנצח / תשלח לא-בזמן / תאבד סבב אחרי תגובה אחת.
	1.	EOU אמיתי
	•	חישוב silence_time = זמן מאז הפעילות הקולית האחרונה (עם שעון monotonic).
	•	EOU לאחר ≥300–400ms שקט רציף (או 200ms אם ירידת אנרגיה חדה).
	•	גבולות: MIN_UTT≈600–900ms, MAX_UTT≈4–5s (אם אין שקט – לכפות EOU ב-MAX).
	2.	ניהול הבאפר
	•	LISTENING & Voice=True → אוגרים ל-buffer.
	•	בעת EOU → מפסיקים לאגור, Processing=True, שולחים ל-STT.
	•	אחרי תמלול → Processing=False, מרוקנים buffer, מעדכנים last_voice_ts, חוזרים LISTENING.
	3.	מעברי מצב קשיחים
	•	רצף חוקי: LISTENING → PROCESSING → SPEAKING → LISTENING.
	•	מנע מעבר ישיר LISTENING→SPEAKING (באג נפוץ).
	•	Watchdogs:
	•	PROCESSING > ~2.5s? אמור “רגע, חושב…” קצר והמשך; אל תיתקע.
	•	SPEAKING > ~6s? חתוך וחזור LISTENING.
	•	אין תשובה > ~7s? אפס מצב וחזור LISTENING.
	4.	חזרה מ-SPEAKING
	•	בסיום TTS שלח mark (למשל assistant_tts_end) והמתן לאישור או timeout של ~150ms.
	•	הוסף 200ms שקט בסוף הטי-טי-אס (מנקה באפר בצד Twilio).
	•	עם קבלת mark/timeout → SPEAKING→LISTENING, איפוס buffer/טיימרים.

⸻

3) Barge-in “אמיתי” (דיבור מעל TTS)

מטרה: אם הלקוח מתחיל לדבר בזמן שהסוכן מדבר — להפסיק מייד להקשיב ולהתחיל לאסוף.
	1.	בזמן SPEAKING, אם Voice=True ברצף ≥150ms מעל סף:
	•	עצור מיידית שידור TTS (אל תשלח עוד פריימים).
	•	SPEAKING=False, LISTENING=True, אפס תור יציאה.
	•	פתח באפר חדש ל-STT.
	2.	סף ברג’-אין: RMS מעל noise_floor*2.2 + 10 לאורך 150ms (כדי לא לקפוץ על רעשים).

⸻

4) VAD דינמי (במקום קבוע)

מטרה: שלא “תראה” כל הזמן Silence=0 או Voice=False על דיבור אמיתי.
	1.	קליברציה: 300–500ms ראשונים למדוד noise_floor.
	2.	סף משתנה: VAD_threshold = max(35, noise_floor*2.2 + 8).
	3.	היסטרזיס: 40–80ms להפחתת ריצוד (on/off לא מידי).
	4.	מדדי עזר: Zero-Crossing Rate/שינוי פתאומי בעוצמה כדי לזהות דיבור רך.

⸻

5) ביצועים וזמן תגובה
	•	אל תחסום את לולאת ה-WS: כל עיבוד (VAD/המרות/שליחה) עם yielding (greenlets), ו-שני תורים נפרדים:
	•	RX (קולט, עושה VAD, אוגר ל-STT),
	•	TX (משדר TTS, מתבטל ב-barge-in).
	•	פריימים: שלח 20ms μ-law בקצב קבוע; אל תיצור “גושים” גדולים.
	•	Cache TTS: ברכות/דקלומים קבועים מראש — חוסך איחור.

⸻

6) הורדת רעש בלוגים (אבל להשאיר תועלת)
	•	הפוך AUDIO_DEBUG ל-0 בפרודקשן; השאר רק:
	•	מעבר מצבים (STATE→…),
	•	EOU אירועים (עם len/silence_ms),
	•	תוצאות STT (ASR_TEXT) עם זמן (ms),
	•	תחילת/סוף TTS (TTS_START/TTS_END, frames),
	•	סימון mark (MARK_SENT/MARK_ACK),
	•	חריגות (timeouts, dropped frames).
	•	אם צריך דיבוג-על: דגום פריים 1 מכל 50 (לא כל פריים).

⸻

7) בדיקות אימות (QA) מהירות
	1.	אמור משפט של 2–3 שניות, עצור 0.5s → וודא בלוג:
	•	STATE -> PROCESSING | silence_ms=…
	•	ASR_TEXT: ...
	•	TTS_START ... → MARK_ACK ... → STATE -> LISTENING
	2.	דבר מעל הדיבור של הסוכן → ודא שה-TTS נפסק תוך ≤200ms והמערכת חוזרת LISTENING ומזהה EOU חדש.
	3.	רעש רקע: העלה קצת רעש (מאוורר/מוזיקה חלשה) → ודא שה-VAD הדינמי מסתגל ולא “מתחרש”.

⸻

למה זה יתקן בדיוק את מה שאתה רואה
	•	כרגע אתה רואה SILENCE_TIME=0 ו-Buffer_size=0 במקטעים — אין EOU אמיתי ולכן כמעט לא יוצאים ל-STT (רק מילים קצרות “נופלות” במקרה).
	•	בלי חזרה מסודרת מ-SPEAKING, הסיבוב הבא לא נפתח נכון.
	•	ברג’-אין חלקי משאיר אותך “מדבר אל קיר” כשאתה קוטע את ה-TTS.

תן לאייג’נט את ההנחיות למעלה אחת־לאחת. לא צריך להחליף תשתית — רק להדק פורמט הקלט, EOU + VAD, מעברי מצב וברג’-אין, ולהוריד את הצפת הלוגים כדי לראות את הזרימה. אחרי זה השיחה תהיה דו־כיוונית, טבעית ומהירה.