×§×™×‘×œ×ª×™. ×”× ×” **×”× ×—×™×” ××—×ª, ×¡×’×•×¨×” ×•×‘×¨×•×¨×”** ×œ×¡×•×›×Ÿ/××¤×ª×— ×©×œ×š â€“ ×œ×ª×§×Ÿ ×”×›×•×œ (×§×•×“ + ×¤×¨×™×¡×”) ×›×š ×©×”××¢×¨×›×ª ×ª×¨×•×¥ ×™×¦×™×‘ ×‘×¤×¨×•×“×§×©×Ÿ. ×”×™× ××›×¡×” ××ª ×›×œ ×”×‘×¢×™×•×ª ×©×¢×œ×• ×‘×’×¨×¡××•×ª ×”××—×¨×•× ×•×ª (×›×•×œ×œ ××œ×• ×©×¨××™×ª×™ ×‘Ö¾v46): Twilio webhooks ×—×¡×¨×™×, ×‘××’ ×“×¤×“×•×£ ×‘Ö¾CRM, ×”×ª×¨××•×ª/Socket/Service Worker, ×•Ö¾Deploy ×™×¦×™×‘.

---

# ğŸ§­ ×”×•×¨××ª ×¢×‘×•×“×” ××œ××” â€” Fix & Deploy ×¢×“ ×¤×¨×•×“×§×©×Ÿ

> ×¤×¢×œ ×œ×¤×™ ×”×¡×“×¨. ××œ ×ª×¡××Ÿ â€œ×‘×•×¦×¢â€ ×¢×“ ×©×™×© ×”×•×›×—×ª ×¨×™×¦×” (×‘×“×™×§×•×ª/×œ×•×’×™×/×¦×™×œ×•××™ ××¡×š).

## 0) ×”×›× ×”

* ×¦×•×¨ ×¢× ×£ ×—×“×©:
  `git checkout -b fix/full-prod-deploy`
* ×”×ª×§× ×•×ª ×‘×¡×™×¡:
  `pip install -r AgentLocator/server/requirements.txt`
  `npm ci --prefix AgentLocator/client`

---

## 1) Twilio â€” ×œ×”×©×œ×™× 3 × ×ª×™×‘×™ Webhook (×—×¡×¨ ×‘Ö¾v46)

**×§×•×‘×¥:** `AgentLocator/server/routes_twilio.py`

×”×•×¡×£/×¢×“×›×Ÿ ×›×š ×©×™×›×œ×•×œ ××ª ×©×œ×•×©×ª× ×•×™×—×–×™×¨×• 200:

```python
from flask import Blueprint, request, Response, current_app
twilio_bp = Blueprint("twilio_bp", __name__, url_prefix="")

@twilio_bp.post("/webhook/incoming_call")
def incoming_call():
    host = current_app.config.get("PUBLIC_HOST", "https://YOUR_HOST")
    xml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Play>{host}/server/static/voice_responses/greeting.mp3</Play>
  <Pause length="1"/>
  <Record action="/webhook/handle_recording"
          method="POST"
          maxLength="30"
          timeout="5"
          finishOnKey="*"
          transcribe="false"/>
</Response>"""
    return Response(xml, mimetype="text/xml")

@twilio_bp.post("/webhook/handle_recording")
def handle_recording():
    # × ×©××¨ ×›×¤×™ ×©××•××© ××¦×œ×š: ×”×•×¨×“×ª WAV, ×‘×“×™×§×ª ××•×¨×š, Whisper, GPT, TTS fallback (×¤×¢× ××—×ª), ×©××™×¨×” ×œ-DB
    return Response("<Response></Response>", mimetype="text/xml")

@twilio_bp.post("/webhook/call_status")
def call_status():
    # ××•×¤×¦×™×•× ×œ×™: ×œ×•×’ ×§×¦×¨ ×©×œ status, ××‘×œ ×ª××™×“ 200
    return "OK", 200
```

**××—×¨×™ ×¤×¨×™×¡×”:** ×‘×¢××•×“ ×”××¡×¤×¨ ×‘Ö¾Twilio

* Voice â†’ Webhook (HTTP POST):

  * Primary: `/webhook/incoming_call`
  * Fallback: (××¤×©×¨ ×œ×”×©××™×¨ ×¨×™×§)
* Status Callback: `/webhook/call_status`

×‘×“×•×§ ×‘Ö¾Request Inspector ×©××™×Ÿ 500/404.

---

## 2) CRM â€” ×œ×ª×§×Ÿ ×‘××’ ×”×“×¤×“×•×£ (×˜×™×¤×• ×©×¨××™×ª×™)

**×§×•×‘×¥:** `server/api_crm_advanced.py`
×—×¤×© ×›×œ `customers_paginate` ×•×”×—×œ×£ ×œ×©× ×”×¤×•× ×§×¦×™×” ×”×ª×§× ×™ ×©×œ×š (×œ××©×œ `customers_paginated`) â€” ××• ×™×™×©×¨ ××ª ×©× ×”×¤×•× ×§×¦×™×” ×‘×¤×•×¢×œ ×œ×›×œ ×”××§×•××•×ª.

×‘×“×™×§×”:
`GET /api/crm/customers?page=1&limit=25` â†’ 200, ×•××ª×§×‘×œ×ª ×¨×©×™××” + ××˜× × ×ª×•× ×™× ×©×œ ×¢××•×“×™×.

---

## 3) Feature Flags â€” ××›×™×¤×” ×‘×¦×“ ×©×¨×ª

**×§×•×‘×¥:** `server/feature_flags.py` (×›×‘×¨ ×§×™×™×)
×•×“× ×©×›×œ ××¡×œ×•×œ×™ CRM/WhatsApp/Calls/Invoices/Signatures ×¢×˜×•×¤×™× ×‘×“×§×•×¨×˜×•×¨:

```python
from .feature_flags import require_feature

@crm_bp.get("/crm/customers")
@require_feature("crm")
def list_customers(): ...
```

×‘×“×™×§×”: ××©×ª××© ×œ×œ× ×”×¨×©××” ×œÖ¾WhatsApp ××§×‘×œ 403 ××—×™×“.

---

## 4) Timeline ×××•×—×“ (API ×¢×•×‘×“ + UI ×¦×•×¨×š)

### API (×›×‘×¨ ×§×™×™× â€” ×•×“× ×©×”×•× ××—×–×™×¨ ××™×¨×•×¢×™× ×××™×ª×™×™×)

**×§×•×‘×¥:** `server/api_timeline.py`

* ××—×–×™×¨ `items[]` ×××•×—×“×™× (calls/whatsapp/tasks/contracts/invoices) ×××•×™× ×™× ×œ×¤×™ ×–××Ÿ.

### UI

**×§×‘×¦×™×:**

* `client/src/components/CustomerTimeline.tsx` (×—×“×©)
* ×”×˜××¢×” ×‘×“×£ ×œ×§×•×— (Tab â€œTimelineâ€ ××• ××ª×—×ª ×œÖ¾Overview)

×¤×•× ×§×¦×™×”: ××•×©×š `GET /api/customers/:id/timeline` ×¢× ×¤×™×œ×˜×¨×™× (×¡×•×’×™ ××™×¨×•×¢, ×˜×•×•×— ×ª××¨×™×›×™×) ×•××¦×™×’ ×¨×¦×£ ×¢× ××™×™×§×•× ×™× ×•×§×™×©×•×¨×™× ×œ××¡×š ×”××§×•×¨.

---

## 5) ×”×ª×¨××•×ª ××©×™××•×ª ×‘×–××Ÿ ×××ª (Socket + Push)

### Server

* ×•×“× ×©Ö¾Socket.IO ×××•×¤×©×¨ (Eventlet/Gevent) ×•×©×‘×™×œ `path='/ws'`.
* Scheduler (APScheduler/Redis) ×©××¨×™× Job ×œ×¤×™ `due_at` ×•×©×•×œ×—:

  * `socket.emit("task:due", payload, to=user_room)`
  * ×•×× ×œ××©×ª××© ×™×© WebPush subscription â€” ×©×œ×— Push JSON.

### Client

* **Socket client:** `client/src/lib/socket.ts`

  ```ts
  import { io } from "socket.io-client";
  export const socket = io("/", { path: "/ws" });
  ```
* **Hook:** `client/src/hooks/useTaskDue.ts`

  ```ts
  import { useEffect } from "react";
  import { socket } from "@/lib/socket";
  export function useTaskDue(onDue:(p:any)=>void){
    useEffect(()=>{ socket.on("task:due", onDue); return ()=>socket.off("task:due", onDue); },[onDue]);
  }
  ```
* **Modal:** `client/src/components/TaskDueModal.tsx` (××¡×š ××œ×; ×›×¤×ª×•×¨×™ ×—×™×™×’/WhatsApp/Snooze/Done)
* **Service Worker:** `client/public/sw.js`

  ```js
  self.addEventListener('push', e=>{
    const data = e.data?.json()||{};
    e.waitUntil(self.registration.showNotification(data.title||'AgentLocator',{
      body: data.body,
      data,
      actions:[
        {action:'call', title:'×”×ª×§×©×¨'},
        {action:'wa', title:'×¤×ª×— WhatsApp'},
        {action:'snooze_15', title:'× ×•×“× ×™×§ 15×“×³'}
      ]
    }));
  });
  ```
* **×¨×™×©×•× SW + ×”×¨×©××•×ª:** ×‘×¨×’×¢ ×”××ª×—×•×œ ×©×œ ×”××¤×œ×™×§×¦×™×”:

  * `navigator.serviceWorker.register('/sw.js')`
  * ×‘×§×© `Notification.requestPermission()`
  * ×©×œ×— ××ª ×¤×¨×˜×™ ×”×× ×•×™ ×œÖ¾`/api/notifications/subscribe`

×‘×“×™×§×•×ª:

* ×¦×•×¨ ××©×™××” ×¢× `due_at` ×¢×•×“ 1â€“2 ×“×§×•×ª â†’ ××ª×§×‘×œ modal ×‘×–××Ÿ ×××ª; ×›×©×”×˜××‘ ×¡×’×•×¨ ××ª×§×‘×œ×ª ×”×ª×¨××ª Push.

---

## 6) Design System ×‘×¡×™×¡×™ (× ××©×™×š ×œ×œ×˜×© ×‘×”××©×š)

* **tokens.css:** `client/src/styles/tokens.css` (×¦×‘×¢×™×, ×˜×™×¤×•×’×¨×¤×™×” â€œAssistantâ€, spacing 8px, RTL) â€” ×œ×™×™×‘× ×‘Ö¾`index.css`.
* **DataTable (TanStack):** ×•×“× ×©×‘×¤×•×¢×œ ×œ×¤×—×•×ª ×˜×‘×œ×ª CRM ××—×ª ××©×ª××©×ª ×‘Ö¾TanStack Table (××™×•×Ÿ/×¡×™× ×•×Ÿ/×”×¡×ª×¨×ª ×¢××•×“×•×ª/Export CSV).

---

## 7) ×ª×©×ª×™×ª ×¤×¨×™×¡×” ×™×¦×™×‘×” (×œ×”×¤×¡×™×§ â€œ× ×•×¤×œ/×™×©×Ÿâ€)

### A) Gunicorn + Eventlet (Flask-SocketIO)

**×§×•×‘×¥:** `AgentLocator/server/wsgi.py`

```python
import os
from app_factory import create_app
from socketio_app import socketio  # ×× ×™×© ×¢×˜×™×¤×”
app = create_app(os.getenv("FLASK_ENV","production"))
# ×× ××ª×” ××¨×™×¥ ×“×¨×š eventlet, socketio.run(app) × ×¢×©×” ×‘-entrypoint; ×›××Ÿ ×¨×§ app
```

**×”×¨×¦×” ×‘×¤×¨×•×“×§×©×Ÿ (×“×•×’××”):**

```bash
pip install gunicorn eventlet
gunicorn --worker-class eventlet -w 1 -b 0.0.0.0:5000 "wsgi:app"
```

> ×× ××ª×” ××©×ª××© ×‘Ö¾Flask-SocketIO, ××•××œ×¥ ×œ×”×¨×™×¥ ×“×¨×š `socketio.run(app)` ×‘×§×•×‘×¥ `main.py` ×¢× eventlet. ×‘Ö¾gunicorn: `--worker-class eventlet`.

### B) Reverse Proxy (Nginx) â€“ ×—×©×•×‘ ×œÖ¾WebSocket

* ×¤×¨×•×§×¡×™ `/` ×œÖ¾:5000
* ×•×“× ×©×”×’×“×¨×•×ª WebSocket ×§×™×™××•×ª:

  ```
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  ```
* ×©××•×¨ path `/ws` ×œÖ¾Socket.IO

### C) React build

* ×”×’×“×¨ `REACT_APP_API_BASE_URL` â†’ ×œ×“×•×’××”: `https://YOUR_HOST`
* build: `npm run build --prefix AgentLocator/client`
* ×”×’×© ××ª `/client/build` ×¢â€×™ Nginx ××• Flask `send_from_directory` (×¤×©×•×˜ ×™×•×ª×¨ ×¢× Nginx).

### D) Docker (××•×¤×¦×™×•× ×œ×™, ××•××œ×¥)

* Dockerfile ×œ×©×¨×ª (Python + eventlet), Dockerfile ×œ×§×œ×™×™× ×˜ (Node build) + Nginx serve.
* `docker-compose.yml` ×©××¨×™× ×©×œ×•×©×” ×©×™×¨×•×ª×™×: `api`, `client`, `nginx` (××• ×¨×§ `api`+`nginx` ×× ××’×™×©×™× ×¡×˜×˜×™ ×“×¨×š Nginx).

---

## 8) ××©×ª× ×™ ×¡×‘×™×‘×” (env) â€” ×—×•×‘×”

×‘Ö¾Prod:

```
FLASK_ENV=production
PUBLIC_HOST=https://YOUR_HOST
DATABASE_URL=...
JWT_SECRET=...
CORS_ORIGINS=https://YOUR_HOST
TWILIO_SID=...
TWILIO_TOKEN=...
GOOGLE_APPLICATION_CREDENTIALS=/secrets/google_tts_key.json
VAPID_PUBLIC_KEY=...
VAPID_PRIVATE_KEY=...
WHATSAPP_DEVICE=...         # ×× ×¨×œ×•×•× ×˜×™ ×œ-Baileys
```

×•×“× ×©×œ×©×¨×ª ×™×© ×’×™×©×” ×œ×§×•×‘×¥ ×”Ö¾Google JSON (×”×¨×©××•×ª ×§×¨×™××”, × ×ª×™×‘ × ×›×•×Ÿ).

---

## 9) ×‘×¨×™××•×ª ××¢×¨×›×ª â€” ×‘×“×™×§×•×ª ××”×™×¨×•×ª (Runbook)

### Twilio

```bash
curl -i https://YOUR_HOST/webhook/incoming_call -X POST
# ×¦×¨×™×š ×œ×”×—×–×™×¨ TwiML (200)
curl -i https://YOUR_HOST/webhook/call_status -X POST
# 200 OK
```

×‘Ö¾Twilio Request Inspector: ××™×Ÿ 500/404.

### CRM

```
GET /api/crm/customers?page=1&limit=25  -> 200 + ×¤××’'×™× ×¦×™×”
POST /api/tasks {customer_id,title,due_at} -> 201
```

### Timeline

```
GET /api/customers/:id/timeline -> items[] ×›×•×œ×œ ×œ×¤×—×•×ª 3 ×¡×•×’×™ ××™×¨×•×¢×™×
```

### ×”×ª×¨××•×ª

* ×¦×•×¨ Task ×‘×¢×•×“ 1â€“2 ×“×§×•×ª â†’ modal ×–××Ÿ ×××ª + Push ×›×©×”×˜××‘ ×¡×’×•×¨.

---

## 10) CI ×‘×¡×™×¡×™ (×× ×—×¡×¨)

**×§×•×‘×¥:** `.github/workflows/ci.yml`

```yaml
name: CI
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install -r AgentLocator/server/requirements.txt
      - run: pytest -q AgentLocator/tests
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci --prefix AgentLocator/client
      - run: npm run build --prefix AgentLocator/client
```

---

## 11) ×ª×§×œ×•×ª ×¤×¨×™×¡×” × ×¤×•×¦×•×ª ×•××” ×¢×•×©×™×

* **500 ×‘Ö¾/webhook/incoming\_call**: ×—×¡×¨ `PUBLIC_HOST` ××• ×§×•×‘×¥ ×”Ö¾MP3 ×œ× ×§×™×™× ×‘× ×ª×™×‘. ×ª×§×Ÿ HOST/×¡×˜×˜×™×§.
* **Twilio 13617 (×”×§×œ×˜×” ×§×¦×¨×”)**: ×¢×‘×“× ×• ×¢× `finishOnKey="*"` + fallback ×¤×¢× ××—×ª. ×•×“× ×‘×§×•×“.
* **WebSocket ×œ× ××ª×—×‘×¨**: ×—×¡×¨ eventlet/gunicorn worker-class, ××• Nginx ×œ× ××¢×‘×™×¨ Upgrade/Connection.
* **Push ×œ× ××’×™×¢**: ××™×Ÿ ×”×¨×©××•×ª ×“×¤×“×¤×Ÿ, ××™×Ÿ ×¨×™×©×•× subscription, ××• VAPID ×œ× ××•×’×“×¨ ×‘×©×¨×ª.
* **CORS ×©×•×‘×¨ UI**: ×•×“× `CORS_ORIGINS` ×›×•×œ×œ ××ª ×“×•××™×™×Ÿ ×”×§×œ×™×™× ×˜ (××• `*` ×‘×©×œ×‘ ×¨××©×•×Ÿ).

---

## 12) Definition of Done (×¡×’×™×¨×”)

* [ ] ×©×œ×•×©×ª × ×ª×™×‘×™ Twilio ×§×™×™××™× ×•××—×–×™×¨×™× 200 (×‘×“×•×§ ×‘Ö¾Request Inspector).
* [ ] ×‘××’ ×“×¤×“×•×£ CRM ×ª×•×§×Ÿ (××™×Ÿ `customers_paginate`).
* [ ] Timeline API ××—×–×™×¨ ××™×¨×•×¢×™× ×××™×ª×™×™×; ×”Ö¾UI ××¦×™×’ ××•×ª×.
* [ ] ×”×ª×¨××•×ª ××©×™××•×ª: modal ×‘×–××Ÿ ×××ª + Push ×›×©×”×˜××‘ ×¡×’×•×¨.
* [ ] ×”×©×¨×ª ×¨×¥ ×¢× eventlet ×•Ö¾Socket.IO path `/ws`.
* [ ] ×”×§×œ×™×™× ×˜ ×‘× ×•×™, ×¤×•× ×” ×œÖ¾`REACT_APP_API_BASE_URL` × ×›×•×Ÿ.
* [ ] ××™×Ÿ ERROR ×‘×§×•× ×¡×•×œ×ª ×”×“×¤×“×¤×Ÿ.
* [ ] Deployment ×™×¦×™×‘ (×‘×“×™×§×ª ×¨×’×¨×¡×™×•×ª ×‘×¡×™×¡×™×ª ×¢×‘×¨×”).

---

×× ×ª×“×‘×™×§ ×œ×• ××ª ×”×”× ×—×™×” ×”×–×• (×›×›×ª×‘ ××©×™××”), ×”×•× ×™×™×“×¢ ×‘×“×™×•×§ ××” ×œ×‘×¦×¢, ×§×•×‘×¥Ö¾×§×•×‘×¥, ×¢×“ ×©×”×›×•×œ ×¢×•×‘×“. ×× ×ª×¨×¦×”, ×× ×¡×— ×œ×š ×’× â€œPR Planâ€ ×¢× ×©××•×ª ×§×•××™×˜×™× ××“×•×™×§×™× ×›×“×™ ×©×™×”×™×” clean ×‘×œ×•×’×™×.
