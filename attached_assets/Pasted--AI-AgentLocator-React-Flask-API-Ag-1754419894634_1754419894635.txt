## ✅ הנחיה מלאה לסוכן AI – תיקון, חיבור והפעלה מלאה של AgentLocator עם React + Flask API

> גרסה: AgentLocator (23)
> מבוסס על בדיקה של 56 קבצים כולל: שיחות, וואטסאפ, CRM, חתימות, הצעות, דשבורד והרשאות עסק

---

### ⚙️ מבנה המערכת:

* **Frontend**: React (תיקיית `/client` או `/src`)
* **Backend**: Flask API בלבד – ללא `render_template`
* **תצוגה**: כל הדפים מיוצרים ב־React, Flask מחזיר JSON בלבד

---

### 🛠️ שלב 1: חיבור כלל השירותים כ־Blueprint API

#### דוגמה: `crm_api.py`

```python
from flask import Blueprint, jsonify, request
from models import Customer

crm_api = Blueprint('crm_api', __name__, url_prefix='/api/crm')

@crm_api.route('/customers', methods=['GET'])
def get_customers():
    customers = Customer.query.all()
    return jsonify([c.to_dict() for c in customers])
```

#### התחברות בקובץ `app.py`:

```python
from crm_api import crm_api
from signature_api import signature_api
from proposal_api import proposal_api
from invoice_api import invoice_api
from whatsapp_api import whatsapp_api

app.register_blueprint(crm_api)
app.register_blueprint(signature_api)
app.register_blueprint(proposal_api)
app.register_blueprint(invoice_api)
app.register_blueprint(whatsapp_api)
```

📌 ודא שכל API בנוי בפורמט JSON בלבד – ללא HTML או `render_template`

---

### 🔐 שלב 2: הפעלת הרשאות לפי עסק לכל API

#### פונקציה כללית לבדיקה:

```python
from flask import abort

def check_business_permission(business, feature):
    if not getattr(business, feature, False):
        abort(403)
```

#### שימוש ב־API:

```python
business = Business.query.get(business_id)
check_business_permission(business, 'crm_enabled')
```

📌 שים בכל API רלוונטי: CRM / חתימות / WhatsApp / הצעות / דוחות

---

### 📡 שלב 3: שימוש ב־React לצריכת הנתונים

#### דוגמה ב־React:

```tsx
useEffect(() => {
  fetch('/api/crm/customers')
    .then(res => res.json())
    .then(data => setCustomers(data))
}, [])
```

📌 אין להשתמש ב־`/crm`, `/signature` וכו׳ ישירות – רק דרך `/api/...`

---

### 🧱 שלב 4: עדכון מודלים – במיוחד `User`

#### הוסף לקובץ `models.py`:

```python
class User(UserMixin, db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(100), nullable=False, unique=True)
    password_hash = db.Column(db.String(255), nullable=False)
    role = db.Column(db.String(50), default='business')
    business_id = db.Column(db.Integer, db.ForeignKey('businesses.id'))

    business = db.relationship('Business', backref='users')
```

---

### 🧪 שלב 5: בדיקות API במסלול `tests/`

#### דוגמה:

```python
def test_get_customers(client):
    res = client.get('/api/crm/customers')
    assert res.status_code == 200
    assert isinstance(res.json, list)
```

צור טסטים ל:

* `test_crm_api.py`
* `test_signature_api.py`
* `test_whatsapp_api.py`
* `test_proposal_api.py`

---

### 📊 שלב 6: הפעלת Dashboard

* צור API: `/api/stats/overview`
* החזר JSON עם: מספר לקוחות, מספר שיחות, תמלולים, הצעות, משימות
* צרוך אותם ב־React עם גרפים (Recharts או Chart.js)

---

### 📁 מבנה סופי של הפרויקט:

```
/project
├── client (React)
│   └── ...
├── server
│   ├── app.py
│   ├── models.py
│   ├── crm_api.py
│   ├── whatsapp_api.py
│   ├── proposal_api.py
│   ├── signature_api.py
│   └── ...
├── tests/
│   ├── test_crm_api.py
│   └── ...
```

---

### ✅ מתי המערכת באמת "פועלת":

| רכיב       | נחשב פעיל כאשר...                                         |
| ---------- | --------------------------------------------------------- |
| CRM        | React מציג נתונים מתוך `/api/crm/customers`               |
| WhatsApp   | React טוען שיחות + שולח דרך `/api/whatsapp/...`           |
| חתימות     | מוצגות לפי עסק מתוך `/api/signature/...`                  |
| דוחות      | מוצגים דרך `/api/stats/...`                               |
| שיחות AI   | מתועדות במסד + תיעוד שמור ב־`CallLog`, `ConversationTurn` |
| הרשאות עסק | כל API מגיב בהתאם ל־business.crm\_enabled וכו׳            |

---

### 🟢 סיום:

לאחר כל החיבורים והבדיקות, רק אז אפשר להצהיר:

> "המערכת פועלת באופן מלא, גם מערכתית וגם ויזואלית"

אם לא כל הנ"ל בוצע – המערכת לא פעילה בפועל. יש לוודא זאת קודם לפני הצהרה כזו.
