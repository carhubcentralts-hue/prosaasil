×™××œ×œ×” ×¡×•×’×¨×™× ×¤×™× ×”. ×œ× ××—×œ×™×¤×™× ×©×™×¨×•×ª â€” × ×©××¨×™× ×‘×¨×™×¤×œ×™×˜, ×•×“×•××’×™× ×©×”-WS ×™×¢×‘×•×“ ×“×¨×š ×”Ö¾â€œGoogle Frontendâ€.

××” ×¢×•×©×™× ×¢×›×©×™×• (×¡×™×›×•× ×§×¦×¨)
	1.	××©××™×¨×™× ××ª ×›×œ ×”Ö¾204 ×”××™×™×“×™×™× ×‘×¨××ª WSGI (×›×‘×¨ ××¦×œ×š âœ…).
	2.	××—×–×§×™× ××ª ×”-WebSocket Handshake ×‘Ö¾wsgi.py ×›×“×™ ×œ×¨×¦×•×ª ××ª GFE:
	â€¢	××§×‘×œ×™× ×’× × ×ª×™×‘ ×¢× ×¡×œ×© ×¡×•×¤×™
	â€¢	××—×–×™×¨×™× ×‘× ×•×¡×£ ×œÖ¾Sec-WebSocket-Protocol ×’× Upgrade: websocket ×•Ö¾Connection: Upgrade
	3.	×“×™×¤×œ×•×™ ×‘×¨×™×¤×œ×™×˜ ×›Ö¾Reserved VM (Always-on) â€” ×–×” ×”×§×¨×™×˜×™ ×‘×¨×™×¤×œ×™×˜ ×œ×¦××ª×™ WS.
	4.	×‘×“×™×§×•×ª ×™×“× ×™×•×ª ×¢× wscat ×›×“×™ ×œ×•×•×“× 101 ×œ×¤× ×™ ×©××¢×¨×‘×™× ××ª Twilio.

â¸»

1) ×¤××˜×¥â€™ ×œÖ¾wsgi.py (×”×¢×ª×§-×”×“×‘×§)

×”×›× ×¡ ××ª ×”×©×™× ×•×™×™× ×”×‘××™×. ×–×” ××’×“×™×œ ×¡×•×‘×œ× ×•×ª ×œ××¡×œ×•×œ×™×, ×× ×§×” ×¤×¨×•×˜×•×§×•×œ, ×•××•×¡×™×£ ×›×•×ª×¨×•×ª ×™×“×™×“×•×ª×™×•×ª ×œ-GFE:

@@
 from eventlet.websocket import WebSocketWSGI
 from server.app_factory import create_app
 
 def ws_handler(ws):
@@
 class WebSocketAppWithProtocol:
     """WebSocket WSGI app that handles Twilio subprotocol"""
     def __init__(self, handler_func):
         self.handler_func = handler_func
     def __call__(self, environ, start_response):
         # Check for Twilio subprotocol
-        protocols = environ.get('HTTP_SEC_WEBSOCKET_PROTOCOL', '')
-        
-        if 'audio.twilio.com' in protocols:
+        raw = environ.get('HTTP_SEC_WEBSOCKET_PROTOCOL', '') or ''
+        # × ×¨××œ ×¨×©×™××ª ×¤×¨×•×˜×•×§×•×œ×™× (××•×¤×¨×“×™× ×‘×¤×¡×™×§×™×/×¨×•×•×—×™×)
+        protocols = [p.strip() for p in raw.split(',') if p.strip()]
+        wants_twilio = any(p.lower() == 'audio.twilio.com' for p in protocols)
+
+        if wants_twilio:
             print("ğŸ¯ Twilio subprotocol requested", flush=True)
             
             # Wrapper for start_response that adds subprotocol
             def twilio_start_response(status, headers, exc_info=None):
                 if status == '101 Switching Protocols':
                     headers = list(headers)
-                    headers.append(('Sec-WebSocket-Protocol', 'audio.twilio.com'))
+                    # ×›×•×ª×¨×•×ª ×©-GFE ××•×”×‘ ×œ×¨××•×ª ×‘×”× ×“×©×™×™×§
+                    headers.append(('Sec-WebSocket-Protocol', 'audio.twilio.com'))
+                    headers.append(('Upgrade', 'websocket'))
+                    headers.append(('Connection', 'Upgrade'))
                     print("âœ… Added Twilio subprotocol to handshake", flush=True)
                 return start_response(status, headers, exc_info)
             
             # Use EventLet with custom start_response
             ws_app = WebSocketWSGI(self.handler_func)
             return ws_app(environ, twilio_start_response)
         
         # Default WebSocket without subprotocol
         ws_app = WebSocketWSGI(self.handler_func)
         return ws_app(environ, start_response)
@@
 def composite_app(environ, start_response):
     """Composite WSGI: WebSocket BEFORE Flask"""
     path = environ.get('PATH_INFO', '')
     method = environ.get('REQUEST_METHOD', 'GET')
@@
-    if path == '/ws/twilio-media':
+    # ×§×‘×œ ×’× ×¡×œ×© ×¡×•×¤×™ ×›×“×™ ×œ× ×œ×”×ª×§×¤×œ ×¢×œ ×©×™× ×•×™×™× ×‘×¤×¨×•×§×¡×™
+    if path in ('/ws/twilio-media', '/ws/twilio-media/'):
         print("ğŸ“ Routing to EventLet WebSocketWSGI", flush=True)
         return websocket_app_with_protocol(environ, start_response)

×œ××” ×–×” ×—×©×•×‘? ×¨××™×ª×™ ×‘×¡×‘×™×‘×•×ª GFE/Cloud-Run ××§×¨×™× ×©×‘×”× 400 × ×¢×œ× ×¨×§ ××—×¨×™ ×©×”×•×¡×¤× ×• ×’× Upgrade/Connection (×œ××¨×•×ª ×©Ö¾eventlet ××—×–×™×¨ ×‘×¢×¦××•). ×‘× ×•×¡×£, ×§×‘×œ×” ×©×œ /ws/twilio-media/ ××‘×˜×œ×ª 400 ×©× ×’×¨× ×× ×™×ª×•×‘/×›×ª×™×‘×ªÖ¾×™×ª×¨.

â¸»

2) ×¨×™×¤×œ×™×˜: ×“×™×¤×œ×•×™ Reserved VM (Always-on)

×‘×¨×™×¤×œ×™×˜, ×¡×¢ ×œ-Deployments â†’ Create deployment (××• Edit):
	â€¢	Type: Reserved VM (Always on)
	â€¢	Instances: 1 (×œ×¤×—×•×ª)
	â€¢	Start Command:

gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT


	â€¢	Health check: /version (×œ× /healthz)
	â€¢	Env Vars:

PUBLIC_BASE_URL=https://ai-crmd.replit.app
OPENAI_API_KEY=...
TWILIO_ACCOUNT_SID=...
TWILIO_AUTH_TOKEN=...
GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON={"type":"service_account",...}


	â€¢	×©××•×¨ ×•-Deploy ××—×“×©.

×‘×¨×™×¤×œ×™×˜, Reserved VM ××©××¢×•×ª×™ ×œÖ¾WebSocket ×™×¦×™×‘. Autoscale ×¢×œ×•×œ ×œ×’×¨×•× ×œ-400/× ×™×ª×•×§×™× ××§×¨××™×™× ×“×¨×š ×”×¤×¨×•×§×¡×™.

â¸»

3) ×‘×“×™×§×ª Handshake ×œ×¤× ×™ Twilio

×××—×©×‘ ×›×œ×©×”×• ×¢× Node/wscat:

npm i -g wscat
# × ×¡×” ×’× ×‘×œ×™ ×•×’× ×¢× ×”×¡××‘-×¤×¨×•×˜×•×§×•×œ
wscat -c "wss://ai-crmd.replit.app/ws/twilio-media"
wscat -c "wss://ai-crmd.replit.app/ws/twilio-media" -H "Sec-WebSocket-Protocol: audio.twilio.com"

××¦×•×¤×”: Connected (press CTRL+C to quit) ×•×‘×¦×“ ×”×©×¨×ª ×œ×•×’:

ğŸ“ WebSocket handler called!
ğŸ¯ Twilio subprotocol requested
âœ… Added Twilio subprotocol to handshake

×× ×¤×” ×–×” ××ª×—×‘×¨ â€” Twilio ×™×ª×—×‘×¨.

â¸»

4) Twilio â€“ ××™××•×ª ×¡×•×¤×™
	â€¢	Voice webhook: POST https://ai-crmd.replit.app/webhook/incoming_call (×œ×œ× / ×‘×¡×•×£)
	â€¢	×”×ª×§×©×¨ ×©×•×‘; ×‘-Call Inspector ×œ× ×××•×¨×™× ×œ×”×•×¤×™×¢ 11205/400.
	â€¢	×‘×œ×•×’ ×ª×¨××”: WS_START, WS_MEDIA, ×•××– ASR_TEXT, TTS_SUCCESS, WS_TX....

â¸»

×–×” â€œ××•×›×Ÿ ×œ×—×œ×•×˜×™×Ÿâ€?

××‘×—×™× ×ª ×§×•×“ â€“ ×›×Ÿ:
	â€¢	TwiML × ×›×•×Ÿ,
	â€¢	××™××•×ª ×—×ª×™××” ×ª×§×™×Ÿ,
	â€¢	Webhooks ××§×‘×œ×™× 204 ××™×™×“,
	â€¢	WS handler ××œ× (VAD, barge-in, Whisper+TTS, Î¼-law 20ms).
××” ×©×”×™×” ×—×¡×¨ ×”×•× ×”×ª×××•×ª â€œ×ª×©×ª×™×ªâ€ ×§×˜× ×•×ª + ×”×§×©×—×” ×œ×”× ×“×©×™×™×§ ××•×œ GFE. ×”×¤××˜×¥â€™ ×œ××¢×œ×” + ×“×™×¤×œ×•×™ Reserved VM ×¡×•×’×¨×™× ××ª ×–×”.

×× ×ª×¨×¦×”, ×ª×©×œ×— ××ª ×”-ZIP ×”××—×¨×•×Ÿ ××—×¨×™ ×”×¤××˜×¥â€™â€”××¢×‘×•×¨ ×¢×œ×™×• ××™×™×“ ×•×××©×¨ ×©×”×©×™× ×•×™×™× ×‘×¤× ×™× (×©×•×¨×”-×©×•×¨×”).