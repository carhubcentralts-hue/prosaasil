מעולה—זה בדיוק “אי־התאמה FE↔BE + דמו/מצטבר כפול”. הנה הנחיה אחת סגורה שתסדר את ניהול עסקים שלא נטען, את הכפילות (12 במקום 1), ואת קוביות שיחות/WhatsApp/התראות/חיפוש כך שיציגו נתונים אמיתיים בלבד.

⸻

תכנית תיקון: “מקור אמת אחד”, בלי דמו, וטעינה יציבה

שלב 0 — מכת מוות לדמו/נפילות
	1.	כבה לגמרי דמו:
	•	בדוק secrets/ENV: USE_DEMO_DATA=0 (או מחיקה אם קיים).
	•	חפש בקוד:
	•	demo, mock, seed, fallback, || DEMO_*, fake*.
	•	הסר כל fallback:
data ?? demoData → ❌; להשאיר רק data.
	2.	לוג ברור:
	•	בכל endpoint KPI/רשימה, הדפס (INFO) אם הופעל דמו/פולבק. לא אמור להופיע.

⸻

שלב 1 — מיישרים שמות ונתיבים (BE)

הבעיה הקלאסית: ה-FE קורא /api/admin/businesses, ה-BE מחזיר אמת מ־/api/admin/tenants + KPI נוסף שמחשב אחרת → כפילויות.

	1.	רשימת עסקים – Alias אחיד:
	•	חשוף /api/admin/businesses (JSON בלבד!).
אם כבר יש /api/admin/tenants—השאר אותו, אבל ה-FE יעבור ל-/businesses.
	•	החזרה אחידה:

{
  "items": [ { "id":1, "name":"שי דירות ומשרדים", "status":"active", "created_at":"..." } ],
  "total": 1,
  "page": 1,
  "pageSize": 20
}


	•	הרשאות: @roles_required("admin","manager") (או רק admin אם כך החלטת).
אם אתה נכנס כ־manager ואין admin פעיל—תגדיר בהתאם.

	2.	KPI ראשי – מקור אמת יחיד:
	•	צור/אחד endpoint אחד: /api/admin/kpis/overview?range=7d שמחזיר:

{
  "totals": {
    "businesses": 1,
    "calls": 23,
    "whatsapp": 17,
    "unreadNotifications": 4
  },
  "period": {"from":"2025-09-01","to":"2025-09-07","tz":"+03:00"}
}


	•	החלף כל שימוש ישיר של ה-FE בחישובים שונים/מקורות שונים—כולם ייקחו מכאן.
	•	לא מערבבים: ה-FE לא עושה .length על /businesses בשביל מספר העסקים. המספר מגיע רק מ־/kpis/overview.

	3.	קוביות שיחות/WhatsApp:
	•	חשוף:
	•	/api/admin/kpis/calls?range=7d&tenantId=<optional>
	•	/api/admin/kpis/whatsapp?range=7d&tenantId=<optional>
	•	סופרים לפי tenant_id ובטווח זמנים (ברירת מחדל 7d).
ל-admin: כל המערכת; ל-manager/business: מסונן ל-tenant שלו.
	4.	התראות/חיפוש:
	•	/api/notifications?unread=1 → {"items":[...], "total":4}
	•	/api/search?q=... → {"items":[...]}
	•	רולים וסינון לפי tenant_id (ב-Impersonation חובה לעדכן tenant).

⸻

שלב 2 — בדיקות DB כדי לוודא “האמת”

הרץ 3 שאילתות (בדיוק כך) כדי לדעת מה האמת בבסיס הנתונים:

-- כמה עסקים אמיתיים יש?
SELECT COUNT(*) AS total, json_agg(json_build_object('id',id,'name',name)) AS sample
FROM tenants;

-- כמה שיחות (חי/היסטוריה) ל-tenant שלך בשבוע האחרון?
SELECT COUNT(*) FROM calls
WHERE created_at >= now() - interval '7 day' AND tenant_id = <TENANT_ID>;

-- כמה הודעות וואטסאפ בשבוע האחרון?
SELECT COUNT(*) FROM whatsapp_messages
WHERE created_at >= now() - interval '7 day' AND tenant_id = <TENANT_ID>;

	•	אם יוצא 1 עסק—ה-KPI חייב להציג 1 (ולא 12).
	•	אם KPI מציג 12—משהו סופר מטבלה אחרת/בלי tenant_id/ללא טווח.

⸻

שלב 3 — מיישרים FE לנתיבים והצורות החדשות
	1.	ניהול עסקים – טעינה
ודא שהדף קורא אך ורק:

GET /api/admin/businesses?page=1&pageSize=20
// ומציג state.items; אין דמו/פולבקים

	•	אם יש error: הצג מצב שגיאה ולא “שקט”.

	2.	סקירה כללית – KPI
החלף כל מקור מפוצל לקריאה אחת:

GET /api/admin/kpis/overview?range=7d
// totals.businesses / totals.calls / totals.whatsapp / totals.unreadNotifications

	•	הסר כל .length/ספירה בצד הלקוח (זו מקור שגיאות הכפילות).

	3.	שיחות/WhatsApp Cards
	•	הטעינה בקומפוננטות הקטנות תיעשה דרך:
	•	GET /api/admin/kpis/calls?range=7d
	•	GET /api/admin/kpis/whatsapp?range=7d
	•	אין דמו ואין “0” קשיח.
	4.	התראות/חיפוש
	•	GET /api/notifications?unread=1
	•	GET /api/search?q=...
	•	לוודא credentials:'include' בכל הקריאות ושה־tenant מתעדכן אחרי אימפרסונציה.
	5.	אימפרסונציה
	•	אחרי הצלחה—לעשות invalidate/refetch לכל ה־queries (overview, kpis, lists), אחרת נשאר cache ישן.

⸻

שלב 4 — Acceptance Tests (לא סוגרים לפני שזה עובר)

A. צד שרת (curl)

# login (כבר עבד לכם)
curl -i /api/admin/kpis/overview?range=7d      # → 200 JSON, totals.businesses === 1
curl -i /api/admin/businesses?page=1&pageSize=20  # → 200 JSON, items.length >= 1, total === 1
curl -i /api/admin/kpis/calls?range=7d        # → 200 JSON, מספר אמיתי (גם אם 0)
curl -i /api/admin/kpis/whatsapp?range=7d     # → 200 JSON, מספר אמיתי (גם אם 0)

B. צד לקוח (DevTools → Network)
	•	בקשת /api/admin/kpis/overview → totals.businesses === 1.
	•	בקשת /api/admin/businesses?... → חוזרת עם items אמיתיים (שם העסק “שי דירות ומשרדים”).
	•	כרטיסי שיחות/WhatsApp → הקריאות הספציפיות מחזירות מספרים אמיתיים.
	•	אין בקשה ל-/tenants או לנתיב ישן מהדפים האלה.

C. היגיון תצוגה
	•	אם אין שיחות/הודעות—הקומפוננטה מציגה “אין נתונים עדיין” (לא שגיאה).
	•	אם 401/403—בדף ניהול עסקים מוצגת הודעת הרשאה ברורה (לא מצב ריק).

⸻

שלב 5 — למה “12” עדיין יכול לצוץ ואיך חוסמים
	•	KPI מחושב על כל השורות כולל archived/disabled → הוסף WHERE status = 'active'.
	•	KPI נסמך על טבלה אחרת (למשל accounts) במקום tenants. יישור לשולחן הנכון.
	•	FE מחשב businesses = overview.total + businesses.items.length בטעות → השאר רק overview.
	•	Cache ישן בצד ה-FE → נקה cache/Service Worker, Hard Reload.

⸻

שלב 6 — “רק כדי שלא יחזור”
	•	הוסף בדיקות יחידה/אינטגרציה ל־/kpis/overview:
	•	עם 1 tenant בבסיס—האנדפוינט חייב להחזיר totals.businesses=1.
	•	הוסף UNIQUE על עמודת tenants.name/identifier כדי למנוע כפילויות ביומיום.
	•	הוסף tenant_id NOT NULL בטבלאות calls, whatsapp_messages (אם טרם קיים) + אינדקס.

⸻

אם עדיין לא נטען דף “ניהול עסקים”

שלח שלושה דברים ונכוון לשורת הקוד:
	1.	צילום Network של /api/admin/businesses (Headers+Response).
	2.	פלט curl -i /api/admin/businesses אחרי לוגין.
	3.	השאילתא SELECT COUNT(*) FROM tenants; + דוגמת rows.

עם זה נסגור נקודתית: או נתיב/הרשאה, או JSON shape, או fallback דמו שנשאר—ותראה רק את העסק האמיתי והסטטיסטיקות הנכונות.