מצוין. נתקדם כמו טכנאי־שטח: נייצב את השרת (שהוא “עולה” ואז לא מגיב) ואז נריץ את השיחות. אין קוד—רק פעולות ופקודות עם “מה מצופה לראות”. הדבק אחד־אחד ובקש ממנו להחזיר את התוצרים.

⸻

חלק A — השרת “עולה” אבל לא מגיב (Connection Refused)

A1) ודאות שאנחנו מריצים Gunicorn+Eventlet על ה־PORT הנכון

מה לעשות
	1.	עצור כל תהליך ישן:
	•	הרוג כל gunicorn|python|flask|main שרץ ברקע (גם ב-Replit).
תוצאה צפויה: אין פלטים של שרתים קודמים.
	2.	בדוק מהו הפורט החיצוני:
	•	הדפס את $PORT. אם ריק, קבע זמנית PORT=8000 (או מה שהפלטפורמה דורשת).
	3.	הרץ פרודקשן בלבד (שורה אחת):

python3 -m gunicorn \
  -k eventlet -w 1 -b 0.0.0.0:$PORT \
  --timeout 120 --graceful-timeout 30 --keep-alive 75 \
  --log-level debug --access-logfile '-' --error-logfile '-' \
  AgentLocator.main:app

מה מצופה לראות: לוג של Gunicorn (לא של Flask Dev), “Listening at: http://0.0.0.0:”, ללא יציאה מידית.

אם אתה רואה “Running on all addresses (0.0.0.0)” — זה ה־Dev server של Flask. אל תריץ אותו. רק Gunicorn.

⸻

A2) מקרה קלאסי: השרת “עולה” ואז לא מגיב — תהליך קורס/ננעל

מה לעשות
	1.	בדיקת חיים מידית (מחשב אחר/טרמינל נוסף):

curl -s -S -m 3 https://<PUBLIC_BASE_URL>/healthz -i
curl -s -S -m 3 https://<PUBLIC_BASE_URL>/version -i

מצופה: HTTP/2 200 ותוכן “ok”/DEPLOY_ID. אם Connection Refused → התהליך כלל לא מקשיב/קרס.
	2.	אם נפל מיד אחרי עלייה:

	•	זה כמעט תמיד אתחול כבד בזמן import (DB/GCP/OpenAI) שחוסם/מקריס.
	•	הנחיה: אל תטען קרדנציאלס/לקוחות כבדים ב־import. טען “Lazy” בקריאה הראשונה.
(מבחינתך: בקש ממנו “לדחות התחברויות כבדות לשלב ריצה, לא בזמן import/app_factory”.)

	3.	ודא שמוגדרים כל משתני הסביבה הבסיסיים (ערכים אמיתיים או “דמה” אם צריך רק לעלות):

	•	PUBLIC_BASE_URL, PORT, DATABASE_URL, JWT_SECRET
	•	אם GCP חובה כבר באתחול—הגדר מלא (GOOGLE_APPLICATION_CREDENTIALS או GCP_CREDENTIALS_JSON), אחרת לבקש ממנו לדחות את השימוש עד לשיחה הראשונה.

	4.	ודא שה־DB מאותחל באתחול אפליקציה (לא בתוך קוד ה־WS):

	•	db.init_app(app) קורה ב־create_app()
	•	יש סכימה/טבלאות (ריצה חד־פעמית של create_all או מיגרציות)
	•	/readyz צריך לכלול "db":"ok"

מה מצופה לראות: אחרי הפעלה—/healthz, /readyz, /version מחזירים 200; אין “קפיאה”.

⸻

A3) הפניית פרונט + SPA Fallback (מונע 404/קשיחות)

מה לעשות
	1.	ודא שהשרת מגיש build יחיד (למשל auth-app/dist), לא תיקיות ישנות במקביל.
	2.	SPA Fallback: כניסה ישירה ל־/app/* מחזירה index.html (200).

בדיקה

curl -s -S -m 3 https://<PUBLIC_BASE_URL>/app/admin/overview -I

מצופה: 200 ולא 404/405.

⸻

חלק B — החזרת השיחות (Twilio Voice) לאחר שהשרת יציב

B1) TwiML + webhooks (מיסגור נכון)

מה לבדוק
	•	POST /webhook/incoming_call מחזיר <Connect><Stream ...> (בלי // כפולים ב־URL).
	•	POST /webhook/stream_status → קורא form ומחזיר 204 ריק (ללא אימות חתימה).
	•	POST /webhook/stream_ended → 204 ריק.

בדיקה (הדבק את התוצאות):

curl -s -S https://<BASE>/webhook/incoming_call -d "CallSid=CA_TEST"
curl -i -X POST https://<BASE>/webhook/stream_status \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=connected"

מצופה: TwiML עם <Connect><Stream...> ו־HTTP/2 204.

⸻

B2) Handshake WS — נוגעים בבעיה המרכזית 31920

מה לעשות
	1.	ודא שמסלול wss://<BASE>/ws/twilio-media מחזיר בהנדשייק:
Sec-WebSocket-Protocol: audio.twilio.com
(אם זה לא חוזר — Twilio יפיל 31920/31924, והברכה תתנגן ואז ינתק.)
	2.	בדיקת עשן יזומה:

wscat -c wss://<BASE>/ws/twilio-media \
      -H "Sec-WebSocket-Protocol: audio.twilio.com"

מצופה: 101 Switching Protocols ובתשובה רואים את ה־Sec-WebSocket-Protocol: audio.twilio.com.

אם לא — המימוש/פרוקסי שלך לא “מהדהד” את הסאב־פרוטוקול. בקש ממנו להחליף מימוש ה־WS (או להגדיר פרוקסי שמחזיר את הכותרת). בלי זה—השיחות לא יתחברו.

⸻

B3) STT/TTS — למנוע “שקט”

מה לעשות
	1.	STT (Inbound)
	•	ה־WS מקבל start/media/stop.
	•	media.payload הוא μ-law 8k base64.
	•	מוגדר אחד: GOOGLE_APPLICATION_CREDENTIALS (קובץ SA אמיתי) או GCP_CREDENTIALS_JSON (JSON מלא שורה אחת).
	•	לוגים מבוקשים: WS_START, STT_PARTIAL, STT_FINAL.
	2.	TTS (Outbound)
	•	מייצרים μ-law (PCMU) 8000Hz, מונו.
	•	שולחים frames של 20ms ל־WS כ־{"event":"media", "media":{"payload":"..."}}.
	•	Keepalive ping/pong כל ~5–15ש׳.
	•	לוגים: TTS_LEN_ms=…, MEDIA_TX=<מספר פריימים>, PNG_PONG_TX/RX.

בדיקה
	•	/readyz או לוג שקול מראה "stt":"ok","tts":"ok".
	•	בשיחה אמיתית: שומעים תשובה ≤ 3–6ש׳; בלוג יש STT_FINAL ו־MEDIA_TX.

⸻

B4) Turn-taking (בלי לופים/חיתוכים)

מה לעשות
	•	מצבונים: LISTENING → THINKING → SPEAKING → LISTENING.
	•	EoU: שקט 300–600ms לפני יצירת תשובה.
	•	Barge-in: אם האדם מתחיל לדבר בזמן TTS → לעצור מיד את המדיה ולחזור ל־LISTENING.
	•	אנטי־לופים: לא לחזור על פתיח/זהות; תגובה אחת לכל utterance.

בדיקה
	•	לוגים מראים EoU_ms=…, BARGE_IN=…; בטלפון אין הד/חזרה כפולה.

⸻

חלק C — מה בדיוק לבקש ממנו עכשיו (deliverables ברורים)
	1.	שרת חי
	•	פלט curl -i https://<BASE>/healthz ו־/version (200 + DEPLOY_ID חדש).
	•	צילום DevTools/Network: CSS יחיד (Tailwind 4.1), JS 200, Console נקי.
	2.	WS Handshake
	•	צילום/פלט של wscat שמראה 101 + Sec-WebSocket-Protocol: audio.twilio.com.
	3.	Twilio Inspector (שיחה אחת)
	•	incoming_call=200, stream_status=204 ≥ 2 אירועים, stream_ended=204, ללא 31920.
	4.	לוג שיחה
	•	רצף: WS_START → STT_PARTIAL/FINAL → EoU_ms → TTS_LEN_ms → MEDIA_TX → PNG_PONG_TX/RX.
	5.	שיחה אמיתית (וידאו קצר)
	•	תשובה נשמעת ≤ 3–6ש׳, אין הד/לופ, barge-in עובד.

⸻

למה זה פותר את התקלה שלך
	•	“Running on all addresses” אבל “connection refused” = או שרץ Dev server לא קשור ל־PUBLIC_BASE_URL/PORT, או שהתהליך קורס/ננעל אחרי עלייה. הרצה נקייה של Gunicorn+Eventlet על $PORT הנכון + דחיית init כבד פותרת.
	•	שגיאת 31920 = Handshake בלי החזרת audio.twilio.com. ברגע שזה מוחזר—הזרם ייפתח, והברכה לא תסתיים בניתוק.
	•	“שקט” אחרי החיבור = חסר STT/TTS נכון (μ-law 8k) או לא משודרים frames חזרה. הבדיקות B3 מוודאות את זה.

אם הוא נתקע באחד הצעדים—תגיד לי באיזה מספר צעד ובאיזה פלט מדויק הוא מקבל, ואני אתן ניתוח זריז לשלב הבא.