××¢×•×œ×”. ×”× ×” ×”× ×—×™×” ××—×ª, ×¡×•×¤×¨Ö¾××“×•×™×§×ª ×•××¢×©×™×ª ×œ××¤×ª×— â€” ××¡×•×“×¨×ª ×œ×¤×™ ×©×œ×‘×™×, ×¢× ×§×˜×¢×™ ×§×•×“ ×œ×”×¢×ª×§×”, ×›×“×™ ×©×”×›×•×œ ×™×¢×‘×•×“ ××”×¨, ×™×¦×™×‘ ×•×œ×œ× â€œ× ×¤×™×œ×•×ªâ€.

â¸»

ğŸ¯ ××˜×¨×•×ª
	â€¢	×ª××œ×•×œ (STT) ×¡×˜×¨×™××™× ×’ ×××™×ª×™ ×¢× ×–××Ÿ ×ª×’×•×‘×” ×›×•×œ×œ â‰¤ 2â€“3 ×©× ×³.
	â€¢	×“×™×•×§ ×¢×‘×¨×™×ª ×’×‘×•×” (×‘×œ×™ ××•×“×œ×™× ×œ× × ×ª××›×™×).
	â€¢	Session ××—×“ ×œ×©×™×—×” (×œ× ×œ×›×œ ×××™×¨×”), ×™×¦×™×‘ ×’× ×‘×¨×™×‘×•×™ ×©×™×—×•×ª.
	â€¢	Fallback ×œ×Ö¾×—×•×¡× ×›×©×¦×¨×™×š.
	â€¢	WebSocket ×©×œ Twilio ×™×¦×™×‘, ×œ× × ×¡×’×¨/â€œ× ×¨×“×â€.
	â€¢	×§×•× ×¤×™×’ ×•××™××•×ª ×¤×©×•×˜×™× ×›×“×™ ×œ×ª×¤×•×¡ ×—×¨×™×’×•×ª ××™×“.

â¸»

1) ×”×¤×¢×œ×ª ×¡×˜×¨×™××™× ×’ ×‘×§×•×“ (×’× ×× ENV ×œ× × ×˜×¢×Ÿ)

×§×•×‘×¥: server/media_ws_ai.py â€” ×‘×ª×—×™×œ×ª ×”×§×•×‘×¥, ×œ×™×“ ×˜×¢×™× ×ª ENV:

import os, asyncio

# ×“×™×¤×•×œ×˜ ××•×¤×¢×œ ×‘×§×•×“, ×›×“×™ ×©×œ× × ×™×¤×•×œ ×œ×¡×™× ×’×œ-×¨×™×§×•×•×¡×˜ ×× ENV ×œ× × ×˜×¢×Ÿ
USE_STREAMING_STT = True
if os.getenv("ENABLE_STREAMING_STT", "").lower() in ("false","0","no"):
    USE_STREAMING_STT = False

print(f"ğŸš€ Streaming STT enabled: {USE_STREAMING_STT}", flush=True)

×–×” ××•× ×¢ â€œ× ×¤×™×œ×•×ª ×©×§×˜×•×ªâ€ ×œ××¦×‘ ××™×˜×™ ×›×©×‘×¤×¨×™×¡×” ×—×¡×¨ secret.

â¸»

2) ×¤×¨××˜×¨×™× ××”×™×¨×™× ×œÖ¾STT (×§×¨×™×˜×™ ×œÖ¾latency)

×§×•×‘×¥: server/services/gcp_stt_stream.py â€” ×‘×¨××© ×”×§×•×‘×¥:

import os, time
from google.cloud import speech

BATCH_MS         = int(os.getenv("STT_BATCH_MS", "80"))     # 60â€“120ms
DEBOUNCE_MS      = int(os.getenv("STT_PARTIAL_DEBOUNCE_MS", "120"))
TIMEOUT_MS       = int(os.getenv("STT_TIMEOUT_MS", "450"))  # ×¡×’×™×¨×ª ×××™×¨×” ×›×©××™×Ÿ ×§×•×œ


â¸»

3) ×‘×—×™×¨×ª ××•×“×œ ×—×›××” ×œ×¢×‘×¨×™×ª + ××–×•×¨ EU/US

×œ×¢×‘×¨×™×ª he-IL ××™×Ÿ model phone_call ×¨×©××™ ×‘×¨×•×‘ ×”××–×•×¨×™×. ×œ×›×Ÿ: ×œ×‘×—×•×¨ ××•×˜×•××˜×™×ª â€” ×œ× ×¡×•×ª phone_call; ×× â€œ×œ× ×–××™×Ÿâ€, ×œ×™×¤×•×œ ×œÖ¾default+enhanced ×‘×œ×™ ×œ×©×‘×•×¨ ×›×œ×•×.

×‘××•×ª×• ×§×•×‘×¥ (gcp_stt_stream.py) ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×•×‘×—×™×¨×” ×‘×–××Ÿ ××ª×—×•×œ:

def choose_stt_model(language="he-IL"):
    preferred = os.getenv("GCP_STT_MODEL", "phone_call").strip()
    order = []
    for m in (preferred, "phone_call", "default"):
        if m not in order:
            order.append(m)

    client = speech.SpeechClient(
        client_options={"api_endpoint": os.getenv("GOOGLE_CLOUD_SPEECH_ENDPOINT", "europe-west1-speech.googleapis.com")}
    )

    silent_bytes = b"\x00" * int(8000 * 0.3 * 2)  # 300ms ×©×§×˜ @ 8kHz PCM16

    for model in order:
        try:
            cfg = speech.RecognitionConfig(
                encoding=speech.RecognitionConfig.AudioEncoding.LINEAR16,
                sample_rate_hertz=8000,
                language_code=language,
                model=model,
                use_enhanced=True,  # × × ×¡×” enhanced; ×× ×œ× × ×ª××š â€” Google ×ª×ª×¢×œ×
                enable_automatic_punctuation=True,
            )
            scfg = speech.StreamingRecognitionConfig(
                config=cfg, interim_results=True, single_utterance=False
            )
            # ×¤×¨×•×‘ ×§×¦×¨ ×œ×‘×“×•×§ ×–××™× ×•×ª ×”××•×“×œ ×œ×©×¤×”/××–×•×¨
            client.streaming_recognize(requests=[
                speech.StreamingRecognizeRequest(streaming_config=scfg),
                speech.StreamingRecognizeRequest(audio_content=silent_bytes)
            ])
            print(f"âœ… [STT] Selected model: {model} (enhanced=True)", flush=True)
            return {"model": model, "use_enhanced": True}
        except Exception as e:
            msg = str(e).lower()
            if "model" in msg and "not available" in msg:
                print(f"âš ï¸ [STT] Model '{model}' not available for {language}, trying nextâ€¦", flush=True)
                continue
            print(f"âš ï¸ [STT] Probe failed for '{model}': {e}", flush=True)
            continue

    print("âŒ [STT] Falling back to default (enhanced=False)", flush=True)
    return {"model": "default", "use_enhanced": False}

MODEL_CFG = choose_stt_model("he-IL")

recognition_config = speech.RecognitionConfig(
    encoding=speech.RecognitionConfig.AudioEncoding.LINEAR16,
    sample_rate_hertz=8000,
    language_code="he-IL",
    model=MODEL_CFG["model"],
    use_enhanced=MODEL_CFG["use_enhanced"],
    enable_automatic_punctuation=True,
)

streaming_config = speech.StreamingRecognitionConfig(
    config=recognition_config,
    interim_results=True,
    single_utterance=False,
)

×›×š, ×× phone_call ×œ× × ×ª××šâ€”× ××©×™×š ××•×˜×•××˜×™×ª ×¢× default+enhanced ×•× ×”× ×” ×Ö¾streaming ××”×™×¨.

â¸»

4) Session ××—×“ ×œ×©×™×—×” + callbacks ×§×‘×•×¢×™×

×¢×™×§×¨×•×Ÿ: ×›×©× ×¤×ª×— WebSocket ××˜×•×•×™×œ×™×• â†’ ×¦×•×¨ GcpStreamingSTT ×™×—×™×“ ×œ×©×™×—×” (×œ×¤×™ call_sid).
×”Ö¾callbacks (on_partial, on_final) ×—×™×™× ×›×œ ×”×©×™×—×”. ×œ× ×¤×•×ª×—×™×/×¡×•×’×¨×™× session ×œ×›×œ â€œ×××™×¨×”â€.

×‘Ö¾media_ws_ai.py (×¤×¡××•×“×•, ×œ×”×ª××™× ×œ×©××•×ª ××¦×œ×š):

# ×¢×œ ×—×™×‘×•×¨ WS (per call_sid)
self.stt_sessions[call_sid] = GcpStreamingSTT(streaming_config, on_partial=self._on_partial, on_final=self._on_final)
self.stt_sessions[call_sid].start()  # ×¤×•×ª×— ××ª ×”×–×¨× ×¤×¢× ××—×ª

# ×›×©××’×™×¢ ××•×“×™×• (×›×œ 20ms~):
self.stt_sessions[call_sid].send(audio_chunk_bytes)

# ×¢×œ × ×™×ª×•×§/×¡×•×£ ×©×™×—×”:
self.stt_sessions[call_sid].stop()
del self.stt_sessions[call_sid]

_on_partial(text) â€” ×©×•××¨/××¨×¢× ×Ÿ ×˜×™×™××¡×˜××¤; ×× partial â‰¥ 15 ×ª×•×•×™× ××• × ×’××¨ ×‘×¤×™×¡×•×§ .,?! â†’ â€œEarly Finalizeâ€.
_on_final(text) â€” ×¡×•×’×¨ ×××™×¨×”, ×©×•×œ×— ×œÖ¾AI, ×× ×§×” ×‘×•×¤×¨.

â¸»

5) Retry ×œ×¤× ×™ fallback (×œ× ×œ×™×¤×•×œ ×™×©×¨ ×œ××™×˜×™)

×‘××§×•× ×©××ª×—×™×œ×™× ×¡×˜×¨×™××™× ×’:

for attempt in range(3):
    try:
        self._start_streaming_locked(streaming_config)
        print(f"âœ… [STT] Streaming started (attempt {attempt+1})", flush=True)
        break
    except Exception as e:
        print(f"âš ï¸ [STT] Streaming start failed (attempt {attempt+1}): {e}", flush=True)
        time.sleep(0.2)
else:
    print("âŒ [STT] All streaming attempts failed â€” using fallback single request", flush=True)
    self.use_single_request = True


â¸»

6) ×× × ×¤×œ× ×• ×œÖ¾fallback â€” ×œ× ×œ×—×¡×•× ××ª ×©×¨×©×•×¨ ×”×©×™×—×”

×‘Ö¾media_ws_ai.py ×”×—×œ×£ ×§×¨×™××” ×—×¡×™××ª×™×ª ×œÖ¾STT ×‘Ö¾executor:

# ×‘××§×•×:
# text = self._hebrew_stt(audio_data)

loop = asyncio.get_event_loop()
text = await loop.run_in_executor(None, self._hebrew_stt, audio_data)


â¸»

7) VAD/EOU ××”×™×¨×™× (×œ×”×©××™×¨ ×›×¤×™ ×©×§×™×¦×¨×ª×)

×‘Ö¾media_ws_ai.py (××• ×”××§×•× ×©××—×©×‘ ×¡×•×£ ×××™×¨×”):
	â€¢	buffer_big_enough = len(self.buf) > 8000  (â‰ˆ 0.5s)
	â€¢	min_duration = 0.6
	â€¢	min_silence â‰ˆ 0.5 / 1.8
	â€¢	Early finalize ×œ×¤×™ partial ×—×–×§ â€” ×œ×”×©××™×¨.

â¸»

8) Twilio Media Streams â€” ×™×¦×•×‘ ×”×—×™×‘×•×¨
	â€¢	TwiML:

<Start>
  <Stream url="wss://<PUBLIC_HOST>/ws/twilio-media"
          track="both_tracks"
          statusCallback="https://<PUBLIC_HOST>/webhook/stream_status"
          statusCallbackEvent="start mark stop"/>
</Start>


	â€¢	×‘Ö¾WS ×©×¨×ª:
	â€¢	subprotocol: "audio.twilio.com".
	â€¢	×›×œ ~15â€“20 ×©× ×³ ×©×œ×— keep-alive ×§×˜×Ÿ (×˜×§×¡×˜/×¤×™× ×’) ×›×“×™ ×œ×× ×•×¢ idle timeout ×‘×¤×¨×•×§×¡×™.
	â€¢	×§×™×“×•×“ Î¼-law/8kHz/BASE64 â€” ×”×©×ª××©×• ×‘Ö¾lookup table ×”××”×™×¨ ×©×›×‘×¨ ×™×© ×œ×›×.

â¸»

9) ENV/Secrets (Replit/Cloud Run)

ENABLE_STREAMING_STT=true
GCP_STT_LANGUAGE=he-IL
GCP_STT_MODEL=phone_call            # ×× ×œ× ×–××™×Ÿ â€” ×”×‘×—×™×¨×” ×”×“×™× ××™×ª ×ª×¤×•×œ ×œ-default+enhanced
GOOGLE_CLOUD_SPEECH_ENDPOINT=europe-west1-speech.googleapis.com  # ××• us-... ×× EU ×œ× ×™×¦×™×‘ ××¦×œ×š
STT_BATCH_MS=80
STT_PARTIAL_DEBOUNCE_MS=120
STT_TIMEOUT_MS=450


â¸»

10) ××™××•×ª ××—×¨×™ ×¤×¨×™×¡×” (××” ×œ×—×¤×© ×‘×œ×•×’×™×)
	â€¢	×‘×¢×ª ×¢×œ×™×™×ª ×”×©×¨×ª:

ğŸš€ Streaming STT enabled: True


	â€¢	×‘×©×™×—×” ×¨××©×•× ×”:

âœ… [STT] Selected model: phone_call (enhanced=True)
# ××•:
âœ… [STT] Selected model: default (enhanced=True)
âœ… [STT] Streaming started (attempt 1)
[LATENCY] partial=0.5â€“0.8s final=1.0â€“1.4s totalâ‰ˆ1.8â€“2.3s


	â€¢	×× ×ª×¨××”:

âŒ [STT] All streaming attempts failed â€” using fallback single request

â†’ ×‘×“×•×§ endpoint/×§×¨×“× ×¦×³×™××œ/×¨×©×ª; ××‘×œ ×œ×¤×—×•×ª ×–×” ×œ× ×™×—×¡×•× ××ª ×”×©×™×—×”.

â¸»

11) ×‘×“×™×§×ª ×¢×•××¡ (2â€“5 ×©×™×—×•×ª ×‘×•Ö¾×–×× ×™×ª)
	â€¢	×•×“× ×©×™×© dict ×©×œ call_sid â†’ stt_session.
	â€¢	××™×Ÿ ×’×œ×•×‘×œ×™× ×©××©×•×ª×¤×™× ×‘×™×Ÿ ×©×™×—×•×ª.
	â€¢	×‘×¡×•×£ ×›×œ ×©×™×—×”: stop() + del.

â¸»

âœ… ×ª×•×¦××” ××¦×•×¤×”
	â€¢	partial ×¨××©×•×Ÿ: 0.5â€“0.8s
	â€¢	final: 1.0â€“1.4s
	â€¢	TTS: ~0.4â€“0.6s
	â€¢	×–××Ÿ ×ª×’×•×‘×” ×›×•×œ×œ: 1.8â€“2.3s (×™×¦×™×‘)

â¸»

×× ××—×¨×™ ×”×™×™×©×•× ×ª×¨××” ×¢×“×™×™×Ÿ 4â€“5 ×©× ×³: ×©×œ×— 10 ×©×•×¨×•×ª ×œ×•×’ ×¡×‘×™×‘ ×ª×—×™×œ×ª ×”×©×™×—×” (Selected model, Streaming started, [LATENCY]) ×•×× ×™ ××’×™×“ ×œ×š ××™×“ ×”×™×›×Ÿ ×¦×•×•××¨ ×”×‘×§×‘×•×§ (endpoint, ×¨×©×ª, fallback ××• EOU).