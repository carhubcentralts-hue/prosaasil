נושם עמוק—‏Twilio 12100 = השרת שלך לא מחזיר TwiML תקין. זה לא קשור ל-WebSocket אלא רק לתגובה הראשונה של /webhook/incoming_call. הנה איך לסגור את זה ב־5 דקות, בלי לנחש.

⸻

מה מתקנים (בול־פגיעה)

1) תחזיר TwiML “סטרילי” עם ה-SDK של Twilio

אל תבנה XML ידנית, אל תחזיר HTML/JSON/204.

# server/routes_twilio.py
from flask import Response, request
from twilio.twiml.voice_response import VoiceResponse
from .blueprints import twilio_bp
from .csrf import csrf
from .auth import require_twilio_signature  # אם אתם מאמתים חתימה

def _twiml(vr: VoiceResponse) -> Response:
    xml = str(vr)
    return Response(xml, status=200, headers={'Content-Type': 'text/xml; charset=utf-8'})

@twilio_bp.post("/webhook/incoming_call")
@csrf.exempt
@require_twilio_signature
def incoming_call():
    # שלב א: בדיקת "Say" בלבד (מאוד חשוב! תתחיל ככה)
    vr = VoiceResponse()
    vr.say("Hello from AgentLocator", language="en-US")
    return _twiml(vr)

עד שלא תראה שהגרסה הזו עוברת — לא ממשיכים ל-Stream. זה מסיר 12100 ברוב המקרים, כי אין XML שבור/תוכן לא נכון.

2) תאשר שזה באמת מה שהשרת מחזיר

הרץ מהמחשב:

curl -sS -i -X POST https://<PUBLIC_HOST>/webhook/incoming_call | sed -n '1,200p'

מצופה:
	•	HTTP/1.1 200 OK
	•	Content-Type: text/xml (או text/xml; charset=utf-8)
	•	גוף שמתחיל ב־

<?xml version="1.0" encoding="UTF-8"?>
<Response><Say>...</Say></Response>



אם אתה רואה HTML/JSON/500/403/301 → זה מקור ה-12100. (Twilio ניסתה לפרסר את הגוף כ-TwiML ונכשלה.)

3) רק אחרי שזה עבר—תחזיר את ה-Stream

כשה-Say עובד ב־Twilio בלי 12100, תחליף ל־Stream:

@twilio_bp.post("/webhook/incoming_call")
@csrf.exempt
@require_twilio_signature
def incoming_call():
    host = os.getenv("PUBLIC_HOST", "").strip() or request.headers.get("X-Forwarded-Host","").strip()
    if host.startswith("http"):  # חשוב: בלי הפרוטוקול
        host = host.split("://", 1)[-1]

    vr = VoiceResponse()
    vr.say("שלום, מחברים את השיחה.", language="he-IL", voice="Polly-Noa")

    connect = vr.connect(action=f"https://{host}/webhook/stream_ended")
    connect.stream(
        url=f"wss://{host}/ws/twilio-media",
        statusCallback=f"https://{host}/webhook/stream_status",
    )

    return _twiml(vr)


⸻

10 גורמי 12100 נפוצים (תסרוק מהר)
	1.	Content-Type לא text/xml → תקן לפי _twiml() למעלה.
	2.	החזרת HTML/JSON/500/403/301/302 במקום XML. (למשל CSRF, 401, redirect).
	3.	רווח/אמוג׳י/תווים לפני ה־<?xml …?> (גם BOM).
	4.	בניית XML ידנית—סוגריים/ציטוטים שבורים.
	5.	מחזיר 204 No Content → Twilio מצפה ל-XML.
	6.	WAF/Proxy מחזיר דף שגיאה HTML (יש לזה כותרות של text/html).
	7.	שימוש ב-PUBLIC_HOST לא נכון (מכיל https:// → יוצר wss://https://…).
	8.	הגדרת נתיב GET בזמן שטוויליו שולחת POST (עדיין תחזיר 405/HTML).
	9.	middleware שמגרד/מצרף טקסט לפני ה־XML.
	10.	gzip/דחיסה לא צפויה בלי כותרות תואמות (נדיר, אבל ראיתי).

⸻

בדיקות GO/NO-GO (ממש עכשיו)
	1.	Say בלבד (הקוד למעלה) → curl -i מראה text/xml ו-<Response>…</Response>.
	2.	חיוג אמיתי: אתה שומע את ההודעה; ב-Debugger אין 12100.
	3.	מחזיר Stream (<Connect><Stream …/>) → curl -i מראה את ה-WSS; שוב חיוג → אין 12100, ורואים stream-started.

אם אחרי שלב 1 עדיין יש 12100—תדביק בדיוק את פלט curl -i (כותרות + גוף), ואם אפשר את 2–3 השורות מלוג השרת, ואני אגיד לך בשורה אחת איפה זה נשבר (כמעט תמיד Content-Type/HTML/רווח לפני ה־XML).