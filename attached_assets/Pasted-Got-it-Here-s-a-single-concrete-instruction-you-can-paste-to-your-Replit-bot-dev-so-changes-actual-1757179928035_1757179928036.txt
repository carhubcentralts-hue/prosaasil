Got it. Here’s a single, concrete instruction you can paste to your Replit bot/dev so changes actually show, impersonation works, and Calendar appears in the sidebar—without breaking the backend.

⸻

ACTION PLAN (Do exactly in this order)

A) Stop the “I changed it but nothing shows” loop

Pick ONE preview mode and prove it with a version stamp.
	1.	Use Vite dev server for Preview (recommended):
	•	Terminal A: npm --prefix client run dev (Vite, usually :5173)
	•	Terminal B: python wsgi.py (Flask API on :5000)
	•	Ensure client/vite.config.* has:
server: { proxy: { '/api': 'http://localhost:5000' } }
	•	Open the 5173 preview URL (not the Flask URL).
OR (if you insist on Flask serving FE in preview):
Every change requires a rebuild:

rm -rf dist
npm --prefix client ci
npm --prefix client run build
cp -R client/dist dist
python wsgi.py


	2.	Add a visible build stamp (proof-of-change):
	•	In client/index.html, add:
<meta name="x-version" content="test-impersonate-01"> and change <title> slightly.
	•	Reload. If you don’t see it in View Source, you are not previewing the correct server.
	3.	Assets must return correct MIME:
	•	Open /assets/index-*.css and /assets/index-*.js in the browser → they must be text/css and application/javascript, not HTML.
	•	If they return HTML, fix Flask static routes so /assets/* is served before SPA fallback.
	4.	Disable caching in DevTools and Unregister Service Workers (Application → Clear storage).
No SW until production is stable.

⸻

B) Fix “Impersonate business” redirecting back to /login

Root cause: cookie/session not applied or /api/auth/me doesn’t honor it.
Do not rename endpoints. Align session usage.
	1.	Server (Flask) — single source of truth:
	•	POST /api/admin/businesses/:id/impersonate:
	•	Validate admin; then set session:

session['original_user'] = <admin>
session['user'] = <tenant_user with role 'business'>
session['tenant_id'] = <tenant_id>
session['impersonating'] = True


	•	Return 200 { ok:true, tenantUser, tenant } (no redirect).

	•	POST /api/admin/impersonate/exit: restore session['user'] = session['original_user'], clear original_user/tenant_id/impersonating.
	•	GET /api/auth/me:
	•	If session.get('user') exists → return it including { role, tenant_id, impersonating: bool }.
	•	Stop using session['user_id']. Use session['user'] everywhere.
Cookie flags for Preview:
	•	SESSION_COOKIE_SECURE = False
	•	SESSION_COOKIE_SAMESITE = 'Lax'
	•	SESSION_COOKIE_PATH = '/'

	2.	Client (React) — call with credentials and only then navigate:
	•	All API calls use credentials: 'include'.
	•	Impersonate handler:
	•	POST /impersonate → await
	•	Immediately GET /api/auth/me → expect 200 with impersonating:true or role:'business'
	•	Only then navigate('/app/business/overview')
	•	<RoleGuard> must accept the impersonated role when me.impersonating === true.
	3.	3 DevTools checks to confirm:
	•	POST /impersonate shows Set-Cookie (no Secure in HTTP preview).
	•	Next GET /api/auth/me returns 200 with impersonating:true.
	•	Navigation to /app/business/overview no longer bounces to /login.

⸻

C) Sidebar: Calendar item missing

One source of truth for nav + show it for both admin & business.
	1.	In your MainLayout/Sidebar component:
	•	Ensure there is a static item:
	•	Label: “לוח שנה”
	•	Route: /app/calendar (even if it’s a placeholder page right now)
	•	Icon: same style as others
	•	Item is not role-gated (visible to admin & business). If you must gate, allow both.
	2.	In routes.tsx add a placeholder route so it doesn’t 404:
	•	/app/calendar → simple page “Calendar coming soon” (no console errors).
	3.	Mobile drawer and desktop sidebar must read the same items array so the link cannot “disappear” in one view.
	4.	Hard refresh, check both desktop & mobile breakpoints.

⸻

D) Final quick checklist (send me screenshots)
	•	View Source shows <meta name="x-version" content="test-impersonate-01">.
	•	/assets/index-*.css → text/css (not HTML).
	•	POST /impersonate shows Set-Cookie in Network pane.
	•	GET /api/auth/me (after impersonate) → { impersonating:true, user.role:'business' }.
	•	/app/business/overview opens without redirect to /login.
	•	Calendar appears in sidebar (desktop + mobile), route /app/calendar works (placeholder OK).
	•	No red errors in Console.

If any checkbox fails, tell me which one and attach the Network/Console screenshot—I’ll pinpoint the exact line to fix.