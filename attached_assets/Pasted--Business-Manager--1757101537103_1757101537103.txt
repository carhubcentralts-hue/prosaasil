קיבלתי. זה הנחיה לבנייה של דף “ניהול עסקים” (Business Manager) ברמת פרודקשן: ניתובים, הרשאות, מבנה מסך, פעולות (עריכה, שינוי סיסמה, התחזות, הקפאה, מחיקה), חוזי-API, ו-DoD. ההנחיה באנגלית למפתח — הבקאנד לא משתנה, ואם חסר חוזה JSON נשתמש ב־Adapter הקיים.

⸻

DEV BRIEF — Business Manager (Admin-only)

0) Scope (this iteration)
	•	New routes:
	•	/app/admin/businesses (list)
	•	/app/admin/businesses/:id (details drawer/page)
	•	Roles: admin | manager only. Business role is denied.
	•	Actions per business: Edit, Reset password, Impersonate, Suspend/Resume, Delete (soft).
	•	Mobile-first, RTL, accessible, fast.

⸻

1) Routing & Guards
	•	Add to routes.tsx:
	•	Wrap in <AuthGuard> and <RoleGuard roles={['admin','manager']}>.
	•	index → /app/admin/businesses
	•	:id → details view (drawer over list or a full page on mobile).
	•	From anywhere:
	•	Sidebar item Business Manager → /app/admin/businesses
	•	CTA “View all businesses” in Admin Overview → /app/admin/businesses
	•	Clicking a tenant name in Activity → /app/admin/businesses/:id

Guard behavior
	•	Missing session → redirect /login.
	•	Role mismatch → redirect /app/admin/overview with toast “Insufficient permissions”.

⸻

2) Page UX (RTL + Mobile)

A) List (/app/admin/businesses)
	•	Header: Title “ניהול עסקים”, search (debounced 300ms), filters (Status: Active/Suspended, Date Created), quick action “+ New business” (disabled if not needed yet).
	•	Table (desktop) with columns: Name, Domain, Phone/WhatsApp, Users, Status, Created, Actions (⋯).
	•	Cards (mobile): stacked, same info, primary actions visible; secondary behind “⋯”.
	•	Row actions: Edit / Impersonate / Reset password / Suspend|Resume / Delete.
	•	Pagination: server-side (page,size,query,filters,sort).
	•	Empty/Loading/Error: skeleton rows, empty state with CTA, retry button.

B) Details (/app/admin/businesses/:id)
	•	Header: tenant name + status pill (Active/Suspended).
	•	Tabs: Overview | Users | Integrations | Audit
	•	Overview: domain, default phone (Twilio), WhatsApp JID (Baileys), timezone, business hours, address, notes, created/updated.
	•	Users: list (name, email, role, last login), quick “Reset password” per user.
	•	Integrations: Twilio numbers mapped, WhatsApp session status, webhooks health, last error.
	•	Audit: recent actions (who, what, when, IP).
	•	Primary actions (top-right): Edit, Impersonate, Suspend|Resume, Delete.

⸻

3) Actions — Behavior & Safety

Edit
	•	Opens side-drawer form:
	•	name, domain, default_phone_e164, whatsapp_jid, timezone, business_hours (JSON), address.
	•	Validation: domain format, E.164 phone, JID format, tz in Olson list.
	•	Optimistic UI: only if API guarantees idempotency; otherwise standard save → refetch.

Reset Password
	•	Target: owner/main user of the business (or choose from list).
	•	Flow: confirm modal → POST → toast success “Reset email sent if user exists”.
	•	Security: always 200; don’t leak account existence.

Impersonate (Login as business)
	•	Confirm modal with re-auth (admin password prompt) or short OTP.
	•	POST returns impersonation cookie + { tenantUser, tenant }.
	•	Show top banner: “Impersonating ‘שי דירות…’ — Exit”.
	•	“Exit impersonation” endpoint restores original admin session.
	•	Audit log entry for start/stop.

Suspend / Resume
	•	PATCH status: active ↔ suspended.
	•	Suspended tenants can’t send/receive (enforced on BE).
	•	UI: status pill switches color; toast; activity log.

Delete (Soft delete)
	•	2-step confirm: type business name to enable delete.
	•	Soft-delete only; show tooltip about retention window (e.g., 30 days).
	•	On success: row grays out or disappears after toast; activity log.

⸻

4) Data Contracts (Adapters if needed)

If your current BE endpoints differ, map them in your Flask adapter to these shapes.

List

GET /api/admin/businesses?query=&status=&page=1&pageSize=20&sort=createdAt:desc

{
  "items":[
    {
      "id": 10,
      "name": "שי דירות ומשרדים",
      "domain": "shai.co.il",
      "defaultPhoneE164": "+97233763805",
      "whatsappJid": "9725XXXX@s.whatsapp.net",
      "users": 5,
      "status": "active",
      "createdAt": "2025-08-01T10:22:00Z"
    }
  ],
  "page": 1,
  "pageSize": 20,
  "total": 37
}

Details

GET /api/admin/businesses/10

{
  "id":10,
  "name":"שי דירות ומשרדים",
  "domain":"shai.co.il",
  "defaultPhoneE164":"+97233763805",
  "whatsappJid":"9725XXXX@s.whatsapp.net",
  "timezone":"Asia/Jerusalem",
  "businessHours":{
    "sun":[{"from":"09:00","to":"18:00"}],
    "mon":[{"from":"09:00","to":"18:00"}]
  },
  "address":"... ",
  "stats":{"users":5,"leads":248,"unread":7,"callsToday":8,"waToday":19},
  "status":"active",
  "createdAt":"2025-08-01T10:22:00Z",
  "updatedAt":"2025-09-03T08:11:00Z"
}

Edit

PATCH /api/admin/businesses/10

{
  "name":"שי דירות ומשרדים",
  "domain":"shai.co.il",
  "defaultPhoneE164":"+97233763805",
  "whatsappJid":"9725XXXX@s.whatsapp.net",
  "timezone":"Asia/Jerusalem",
  "businessHours": {...},
  "address":"..."
}

→ 200 { ok:true }

Reset password

POST /api/admin/businesses/10/reset-password (optional {"userId":123})
→ 200 { ok:true }

Impersonate

POST /api/admin/businesses/10/impersonate
→ 200 { ok:true, tenantUser:{id,email,role:'business'}, tenant:{id,name} } (+ sets cookie)
POST /api/admin/impersonate/exit → 200 { ok:true }

Suspend/Resume

PATCH /api/admin/businesses/10/status with { "status":"suspended" } or { "status":"active" }
→ 200 { ok:true, status:"suspended" }

Delete (soft)

DELETE /api/admin/businesses/10
→ 200 { ok:true, deletedAt:"2025-09-05T10:00:00Z" }

Users

GET /api/admin/businesses/10/users?page=1&pageSize=20

{
  "items":[{"id":123,"name":"…","email":"…","role":"business","lastLogin":"2025-09-04T11:22:00Z"}],
  "page":1,"pageSize":20,"total":5
}

Audit

GET /api/admin/businesses/10/audit?page=1&pageSize=20

{
  "items":[
    {"ts":"2025-09-04T09:12:10Z","actor":"admin@…","action":"impersonate.start","ip":"1.2.3.4"},
    {"ts":"2025-09-04T10:55:22Z","actor":"admin@…","action":"status.suspended","ip":"1.2.3.4"}
  ],
  "page":1,"pageSize":20,"total":42
}


⸻

5) Components to implement
	•	BusinessTable (desktop) / BusinessCardList (mobile)
	•	BusinessFilters (search + status + date)
	•	BusinessActionsMenu (⋯) with handlers for all actions
	•	BusinessEditDrawer
	•	ConfirmDialog (with type-to-confirm for delete)
	•	ImpersonationBanner (visible when impersonating)
	•	AuditList (virtualized if >100)
	•	ProviderBadges (reuse from Admin Overview)
	•	Toast + global error boundary

⸻

6) Security & Compliance
	•	All admin endpoints validated on BE (don’t trust FE role only).
	•	Impersonate requires re-auth (password prompt / short OTP) → BE validates.
	•	Every admin action writes an audit log entry (who/when/IP/what).
	•	Soft delete only; background cleanup later.
	•	Rate limit mutating endpoints; idempotency keys for potentially repeated clicks.
	•	CSRF safe (cookie + same-site); no tokens in localStorage.

⸻

7) Performance
	•	Server-side pagination + sorting.
	•	Debounced search (300ms); cancel in-flight requests.
	•	Cache list and details in memory; optimistic UI only when safe.
	•	Skeletons for table/cards; lazy-load Audit tab.

⸻

8) Definition of Done (acceptance)
	•	Routes + guards enforce admin|manager only. Business role denied with JSON 403 from BE and toast + redirect on FE.
	•	List shows correct data, search/filters/pagination work.
	•	Details view shows Overview/Users/Integrations/Audit.
	•	All actions (Edit, Reset password, Impersonate, Suspend/Resume, Delete) function with proper confirmations, toasts, and audit entries.
	•	Mobile: list becomes cards; actions accessible; drawer full-screen; 44px hit targets.
	•	RTL: sidebar right, table aligns properly; numbers/phones wrapped dir="ltr".
	•	No console errors; assets load with correct MIME; /version and health endpoints 200.

⸻

9) Build order (suggested)
	1.	Routes + Guards + empty shells.
	2.	List view (table/cards) + fetch.
	3.	Details shell + Overview tab (read-only).
	4.	Actions: Edit → Save → refetch.
	5.	Actions: Reset password, Impersonate (with banner & exit), Suspend/Resume, Delete (type-to-confirm).
	6.	Users/Integrations/Audit tabs.
	7.	Polish: skeletons, empty/error, mobile behaviors, a11y.

⸻

תגיד “הנחיה” כשאתה רוצה שאמיר את זה למשימות קצרות (צ׳ק־רשימה) למפתח/בוט לביצוע מיידי.