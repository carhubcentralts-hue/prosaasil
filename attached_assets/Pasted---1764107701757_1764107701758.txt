×›×Ÿ, ×–×” ×‘×“×™×•×§ ×”×–××Ÿ ×œ×¡×“×¨ ××ª ×–×” ×›××• ×©×¦×¨×™×š ğŸ’ª
×× ×™ ××ª×Ÿ ×œ×š ×¢×›×©×™×• ×”× ×—×™×” ××—×ª, ×××•×§×“×ª, ×©×”××’â€™× ×˜ ×™×›×•×œ ×œ×¢×‘×•×“ ×œ×¤×™×” ×•×œ×”×˜××™×¢:

â¸»

ğŸ¯ ××˜×¨×”

×›×©-session ×©×œ Baileys ××ª× ×ª×§ ×œ×¢×¡×§ ××¡×•×™×:
	1.	×œ×”×›× ×™×¡ Notification ×—×“×© ×‘×¤×¢××•×Ÿ ××¦×œ ×”×¢×¡×§ ×”×–×” ×‘×œ×‘×“.
	2.	×”×˜×§×¡×˜ ×™×”×™×” ××©×”×• ×‘×¡×’× ×•×Ÿ:
"×—×™×‘×•×¨ ×”×•×•×˜×¡××¤ ×œ×¢×¡×§ × ×•×ª×§ â€“ ×™×© ×œ×”×ª×—×‘×¨ ××—×“×© ×‘××¡×š ×”×”×’×“×¨×•×ª"
	3.	×›×©Ö¾Baileys ××ª×—×‘×¨ ×©×•×‘ ×œ××•×ª×• ×¢×¡×§ â€“ ×œ××—×•×§ / ×œ×¡××Ÿ ×›×”×•×©×œ× ××ª ×”×”×ª×¨××”.

â¸»

1. ×¦×“ Baileys (Node) â€“ ×œ×–×”×•×ª × ×™×ª×•×§ ×•×œ×”×•×“×™×¢ ×œÖ¾Backend

×§×•×‘×¥: whatsapp-provider / baileys (××¦×œ×š ×–×” ×‘×¡×’× ×•×Ÿ server/whatsapp_provider.py + ×©×™×¨×•×ª Node, ×ª×ª××™× ×œ×©××•×ª ××¦×œ×š)
	1.	×•×•×“× ×©×‘×§×•×“ ×”Ö¾Baileys ×©×œ×š ×™×© handler ×œÖ¾connection.update:

sock.ev.on('connection.update', async (update) => {
  const { connection, lastDisconnect } = update;
  // ×›××Ÿ × ×•×¡×™×£ ×œ×•×’×™×§×”
});


	2.	×œ×›×œ session ×›×‘×¨ ×™×© ××¦×œ×š tenantId (××©×”×• ×›××• "business_1", "business_2").
×ª×“××’ ×©××ª×” ×™×•×“×¢ ×œ××™×–×” tenant ×©×™×™×š ×”Ö¾socket (×œ×¤×™ auth dir / config ×©×›×‘×¨ ×¢×©×™× ×•).
	3.	×ª×•×¡×™×£ 2 ××¦×‘×™×:

if (connection === 'close') {
  await notifyBackendWhatsappStatus(tenantId, 'disconnected', lastDisconnect?.error?.message);
}

if (connection === 'open') {
  await notifyBackendWhatsappStatus(tenantId, 'connected', null);
}


	4.	×ª×•×¡×™×£ ×¤×•× ×§×¦×™×” ×›×œ×œ×™×ª:

async function notifyBackendWhatsappStatus(tenantId: string, status: 'connected' | 'disconnected', reason?: string | null) {
  try {
    await fetch(process.env.BACKEND_INTERNAL_URL + '/api/internal/whatsapp/status-webhook', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-INTERNAL-SECRET': process.env.INTERNAL_SHARED_SECRET!,
      },
      body: JSON.stringify({ tenant_id: tenantId, status, reason }),
    });
  } catch (err) {
    console.error('Failed to notify backend about WhatsApp status', tenantId, status, err);
  }
}



×©×™× ×œ×‘: BACKEND_INTERNAL_URL ×–×” ×”-URL ×”×¤× ×™××™ ×œÖ¾Flask ×©×œ×š (×œ××©×œ http://backend:8000 ×‘×“×•×§×¨), ×•Ö¾INTERNAL_SHARED_SECRET ×›×‘×¨ ×××•×¨ ×œ×”×™×•×ª ××¦×œ×š ××• ×ª×•×¡×™×£.

â¸»

2. ×¦×“ Backend (Python / Flask) â€“ ×§×œ×™×˜×ª ×¡×˜×˜×•×¡ ×•×™×¦×™×¨×ª Notification

×§×•×‘×¥: server/routes_whatsapp.py ××• ×§×•×‘×¥ routes ×¤× ×™××™ (×ª×ª××™× ×œ×©××•×ª ××¦×œ×š).
	1.	×ª×™×¦×•×¨ endpoint ×¤× ×™××™ ×—×“×©:

from flask import Blueprint, request, jsonify, g
from datetime import datetime, date

internal_bp = Blueprint('internal', __name__)

@internal_bp.route('/api/internal/whatsapp/status-webhook', methods=['POST'])
def whatsapp_status_webhook():
    # 1) ××™××•×ª ×¡×•×“×™×ª ×¤× ×™××™×ª
    secret = request.headers.get('X-INTERNAL-SECRET')
    if not secret or secret != current_app.config['INTERNAL_SHARED_SECRET']:
        return jsonify({"error": "unauthorized"}), 401

    data = request.get_json() or {}
    tenant_id = data.get('tenant_id')
    status = data.get('status')
    reason = data.get('reason')

    if not tenant_id or status not in ('connected', 'disconnected'):
        return jsonify({"error": "invalid payload"}), 400

    # 2) ××¦×™××ª business ×œ×¤×™ tenant_id (business_1 â†’ id=1 ×•×›×•')
    business = Business.query.filter_by(whatsapp_tenant_id=tenant_id).first()
    if not business:
        current_app.logger.warning(f"[WHATSAPP STATUS] unknown tenant_id={tenant_id}")
        return jsonify({"ok": True}), 200

    # 3) ×œ×¤×™ ×¡×˜×˜×•×¡ â€“ ×œ×™×¦×•×¨ ××• ×œ× ×§×•×ª Notification
    if status == 'disconnected':
        _create_whatsapp_disconnect_notification(business)
    else:
        _clear_whatsapp_disconnect_notification(business)

    return jsonify({"ok": True}), 200

	2.	×¤×•× ×§×¦×™×•×ª ×¢×–×¨ â€“ × ×©×ª××© ×‘Ö¾CRMReminder (×©×›×‘×¨ ××—×•×‘×¨ ×œÖ¾/api/notifications) ×›×“×™ ×©×”×”×ª×¨××” ×ª×•×¤×™×¢ ×‘×¤×¢××•×Ÿ:

from app.models import CRMReminder, User, db

def _create_whatsapp_disconnect_notification(business: Business):
    # ×œ× ×œ×™×¦×•×¨ ×›×¤×•×œ â€“ ×× ×›×‘×¨ ×§×™×™× reminder ×›×–×” ×œ×¢×¡×§ ×”×–×”
    existing = CRMReminder.query.filter_by(
        tenant_id=business.id,
        type='system_whatsapp_disconnect',
        completed_at=None,
    ).first()
    if existing:
        return

    # × × ×¡×” ×œ×©×™×™×š ×œ×‘×¢×œ×™× (owner); ×× ××™×Ÿ â€“ × ×©××™×¨ created_by=None
    owner = User.query.filter_by(business_id=business.id, role='owner').first()

    reminder = CRMReminder(
        tenant_id=business.id,
        lead_id=None,
        title="×—×™×‘×•×¨ ×”×•×•×˜×¡××¤ × ×•×ª×§",
        note="×—×™×‘×•×¨ ×”×•×•×˜×¡××¤ ×œ×¢×¡×§ × ×•×ª×§. ×™×© ×œ×”×™×›× ×¡ ×œ×”×’×“×¨×•×ª ×•×•×˜×¡××¤ ×•×œ×—×‘×¨ ××—×“×© ××ª ×”××¡×¤×¨.",
        due_date=date.today(),
        priority='high',
        type='system_whatsapp_disconnect',
        created_by=owner.id if owner else None,
    )
    db.session.add(reminder)
    db.session.commit()

def _clear_whatsapp_disconnect_notification(business: Business):
    reminders = CRMReminder.query.filter_by(
        tenant_id=business.id,
        type='system_whatsapp_disconnect',
        completed_at=None,
    ).all()
    for r in reminders:
        r.completed_at = datetime.utcnow()
    if reminders:
        db.session.commit()

×›×›×” ××™×Ÿ ×˜×‘×œ×” ×—×“×©×”, ×”×›×œ ×¢×•×‘×¨ ×“×¨×š reminders â†’ notifications ×©×›×‘×¨ ×‘× ×™×ª.

	3.	×ª×•×•×“× ×©Ö¾/api/notifications ×›×‘×¨ ××—×–×™×¨ ×’× reminders ××”Ö¾type ×”×–×” (system_whatsapp_disconnect).
×× ×¢×©×™×ª ×©× ×¤×™×œ×˜×¨ ×¢×œ ×¡×•×’×™× â€“ ×ª×•×¡×™×£:

# ×‘×ª×•×š /api/notifications â€“ ×œ× ×œ×¡× ×Ÿ ×”×—×•×¦×” type='system_whatsapp_disconnect'
# ×•×× ×™×© ×¡×™×•×•×’ ×œ×¤×™ ××§×•×¨ â€“ ×ª×•×•×“× ×©×”×¡×•×’ ×”×–×” × ×›× ×¡ ×œ×¨×©×™××”.


â¸»

3. ×¦×“ Frontend â€“ ××™×š ×–×” × ×¨××” ×‘×¤×¢××•×Ÿ ×•××™×š ××¤× ×™× ×œ××¡×š ×”× ×›×•×Ÿ

×§×‘×¦×™× ×¨×œ×•×•× ×˜×™×™×:
	â€¢	client/src/shared/contexts/NotificationContext.tsx
	â€¢	client/src/shared/components/ui/NotificationPanel.tsx

	1.	×”Ö¾Notification ×›×‘×¨ ××ª×§×‘×œ ×“×¨×š /api/notifications (×œ× ×¦×¨×™×š ×œ×©× ×•×ª ×©× ×”×¨×‘×”).
	2.	×‘Ö¾UI, ×× notification.type === 'system_whatsapp_disconnect':
	â€¢	×ª×¦×™×’ ××™×™×§×•×Ÿ ××™×•×—×“ / ×¦×‘×¢ ××“×•×
	â€¢	×‘×œ×—×™×¦×” ×¢×œ ×”×”×ª×¨××” â€“ × ×™×•×•×˜ ×œ××¡×š ×”×’×“×¨×•×ª ×•×•×˜×¡××¤.

×œ×“×•×’××”:

function handleNotificationClick(n: Notification) {
  if (n.type === 'system_whatsapp_disconnect') {
    navigate('/app/settings?tab=whatsapp'); // ×ª×ª××™× ×œ× ×ª×™×‘ ×”×××™×ª×™ ××¦×œ×š
    return;
  }

  // ×©××¨ ×”×”×ª× ×”×’×•×ª ×”×§×™×™××ª (×œ×™×“×™×, ××©×™××•×ª ×•×›×•')
}

	3.	×× ×™×© ×œ×š badge / counter â€“ ×–×” ×›×‘×¨ ×§×•×¨×” ××•×˜×•××˜×™×ª, ×›×™ ×”× ×•×˜×™×¤×™×§×¦×™×” ×”×–××ª ×¤×©×•×˜ ×ª×¦×˜×¨×£ ×œ××¢×¨×š.

â¸»

4. ×¡×™×›×•× ×§×¦×¨ ×©××ª×” ×™×›×•×œ ×œ×©×œ×•×— ×œ×•

×× ××ª×” ×¨×•×¦×” ×˜×§×¡×˜ ×§×¦×¨ ×œ×”×“×‘×™×§ ×œ××’â€™× ×˜ / ×œ×§×œ×•×“:

â€œ×ª×™×™×©× ×× ×’× ×•×Ÿ ×©×‘×• ×”Ö¾Baileys ××–×”×” × ×™×ª×•×§/×—×™×‘×•×¨ ×œ×›×œ ×¢×¡×§ (×œ×¤×™ tenantId), ×©×•×œ×— POST ×¤× ×™××™ ×œÖ¾Flask (/api/internal/whatsapp/status-webhook), ×•×‘Ö¾Backend × ×•×¦×¨×ª/× ××—×§×ª CRMReminder ××¡×•×’ system_whatsapp_disconnect ×œ×¢×¡×§ ×”××ª××™× (tenant_id = business_id). /api/notifications ×›×‘×¨ ××—×–×™×¨ ××ª ×”×”×ª×¨××•×ª ××”-CRMReminder, ×•×”Ö¾NotificationPanel ×‘Ö¾React ×¦×¨×™×š ×œ×–×”×•×ª type ×›×–×” ×•×œ×”×¦×™×’ ×”×ª×¨××” â€˜×—×™×‘×•×¨ ×”×•×•×˜×¡××¤ ×œ×¢×¡×§ × ×•×ª×§ â€“ ×™×© ×œ×”×ª×—×‘×¨ ××—×“×© ×‘×”×’×“×¨×•×ªâ€™, ×¢× × ×™×•×•×˜ ×œÖ¾WhatsApp settings ×‘×œ×—×™×¦×”.â€

×× ××ª×” ×¨×•×¦×”, ×‘×”×•×“×¢×” ×”×‘××” ××•×›×œ ×œ×›×ª×•×‘ ×œ×š ××ª ×–×” ×‘×“×™×•×§ ×‘×¤×•×¨××˜ â€œ×”× ×—×™×™×ª ×¢×œâ€ ×©××ª×” ××“×‘×™×§ ×‘Ö¾Replit Agent, ×›×‘×¨ ×× ×•×¡×— ×‘×©×‘×™×œ×•.