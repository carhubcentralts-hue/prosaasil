×™××œ×œ×”, × ×¢×©×” ×¡×“×¨ ×¤×¢× ××—×ª ×•×œ×ª××™×“ ğŸ˜…
×× ×™ ××ª×Ÿ ×œ×š ×˜×§×¡×˜ ××•×›×Ÿ ×©××ª×” ×™×›×•×œ ×¤×©×•×˜ ×œ×”×“×‘×™×§ ×œ-Agent. ×—×™×œ×§×ª×™ ×œ×¤×™ × ×•×©××™×: ×”×ª×—×–×•×ª, Tasks/Reminders/Notifications, ×©××•×ª ×œ×™×“×™×.

â¸»

1ï¸âƒ£ ×”×ª×—×–×•×ª (Impersonation) â€“ ×©×™×ª×—×™×œ ×œ×¢×‘×•×“ ×‘×××ª

×ª×’×™×“ ×œ-Agent:

××˜×¨×”: ×”×”×ª×—×–×•×ª ×¢×“×™×™×Ÿ ×œ× ×¢×•×‘×“×ª. ×›-system_admin ×× ×™ ××§×‘×œ ×”×•×“×¢×”:
"×”×ª×—×–×•×ª × ×›×©×œ×” - ××¦×‘ ×”×ª×—×–×•×ª: false, ×ª×¤×§×™×“: system_admin".
×ª×ª×§×Ÿ ××ª ×›×œ ×–×¨×™××ª ×”×”×ª×—×–×•×ª â€“ ×’× ×‘-backend ×•×’× ×‘-frontend â€“ ×œ×¤×™ ×”×”× ×—×™×•×ª ×”×‘××•×ª:

A. ×œ×ª×§×Ÿ ××ª ×”Ö¾API ×©×œ ×”×”×ª×—×–×•×ª
	1.	×¤×ª×— ××ª server/routes_business_management.py.
	2.	×¢×‘×•×¨ ×¢×œ ×©× ×™ ×”Ö¾endpoints:
	â€¢	POST /api/admin/businesses/<int:business_id>/impersonate
	â€¢	POST /api/admin/businesses/stop_impersonation
	3.	×•×“× ×©×©× ×™ ×”Ö¾routes ×”××œ×” ××©×ª××©×™× ×‘Ö¾decorator:

@require_api_auth(allowed_roles=['system_admin'])

×•×œ× ×¨×§ ['admin', 'manager']. ×¨×§ system_admin ×××•×¨ ×œ×”×™×•×ª ××¡×•×’×œ ×œ×”×ª×—×¤×©.

	4.	×‘×ª×•×š ×”×¤×•× ×§×¦×™×” impersonate_business:
	â€¢	××—×¨×™ ×©××•×•×“××™× ×©×”-business ×§×™×™×, ×¢×“×›×Ÿ ××ª ×”Ö¾session ×›×š:

session['impersonated_tenant_id'] = business.tenant_id or business.id
session['impersonated_business_id'] = business.id
session['impersonating'] = True


	â€¢	×”×—×–×¨ JSON ×‘×¨×•×¨:

return jsonify({
    "success": True,
    "impersonating": True,
    "business_id": business.id,
    "business_name": business.name,
})


	5.	×‘×ª×•×š stop_impersonation:

session.pop('impersonated_tenant_id', None)
session.pop('impersonated_business_id', None)
session['impersonating'] = False
return jsonify({"success": True, "impersonating": False})


	6.	×‘Ö¾@require_api_auth (×‘Ö¾server/auth_utils.py / ××™×¤×” ×©×”×•× ××•×’×“×¨):
	â€¢	×•×“× ×©×”×œ×•×’×™×§×ª ×”-tenant × ×¨××™×ª ×›×š:

tenant = session.get('impersonated_tenant_id') or session['user'].get('business_id')
g.tenant_id = tenant
g.business_id = tenant
g.impersonating = bool(session.get('impersonated_tenant_id'))


	â€¢	×ª×©××™×¨ ××ª ×”-logging ×©×›×‘×¨ ×”×•×¡×¤×ª: user_id, role, business_id, computed_tenant, impersonating.

B. ×œ×ª×§×Ÿ ××ª ×”Ö¾UI ×©×œ ×”×”×ª×—×–×•×ª
	1.	×¤×ª×— ××ª ×“×£ × ×™×”×•×œ ×”×¢×¡×§×™× (Business Management) â€“ client/src/pages/admin/BusinessListPage.tsx ××• ×”×©× ×”××§×‘×™×œ.
	2.	×›×¤×ª×•×¨ â€œ×”×ª×—×–×•×ªâ€ ×¦×¨×™×š:
	â€¢	×œ×¢×©×•×ª POST ×œÖ¾/api/admin/businesses/${business.id}/impersonate ×“×¨×š ×”Ö¾http client ×©××©×ª××© ×‘Ö¾credentials: 'include'.
	â€¢	××—×¨×™ 200 OK:
	â€¢	×œ×§×¨×•× ×œÖ¾/api/auth/me ×›×“×™ ×œ×¨×¢× ×Ÿ ××ª ×”Ö¾AuthContext.
	â€¢	×œ×¢×©×•×ª redirect ×œÖ¾/app ××• ×œ×“×£ ×”×‘×™×ª ×©×œ ×”×¢×¡×§ (/app/overview).
	3.	×›×¤×ª×•×¨ â€œ×™×¦×™××” ××”×ª×—×–×•×ªâ€ (×× ×§×™×™×):
	â€¢	×œ×©×œ×•×— POST /api/admin/businesses/stop_impersonation
	â€¢	×œ×¨×¢× ×Ÿ ×©×•×‘ ××ª /api/auth/me.

××—×¨×™ ×”×ª×™×§×•×Ÿ ×ª×¨×™×¥ ×‘×“×™×§×”:
	â€¢	×œ×”×ª×—×‘×¨ ×›-admin@admin.com (system_admin)
	â€¢	×œ× ×¡×•×ª ×œ×”×ª×—×¤×© ×œ×¢×¡×§ â†’ ×¦×¨×™×š ×œ×¨××•×ª impersonating=True ×‘×œ×•×’×™×, ×•-UI ×©×œ ×”×¢×¡×§ ×”×—×“×©.

â¸»

2ï¸âƒ£ Tasks / Reminders / Notifications â€“ ×œ×—×‘×¨ ×”×›×œ ×‘×™×—×“ ×•×œ×ª×§×Ÿ 500 / 403

××˜×¨×•×ª:
	1.	×™×¦×™×¨×ª ××©×™××” (Task) ×ª×¢×‘×•×“ â€“ ×‘×œ×™ "×©×’×™××” ×‘×©××™×¨×ª ××©×™××”".
	2.	/api/reminders ×œ× ×™×—×–×™×¨ 403 ×œ××©×ª××©×™× ×¨×’×™×œ×™×.
	3.	/api/notifications ×œ× ×™×—×–×™×¨ 500 ×•×™×§×¨× ××ª ××•×ª× ×”× ×ª×•× ×™× ×©×œ ×”-Reminders.
	4.	××‘×—×™× ×ª×™: Reminders = Tasks, ×•Ö¾Notifications = ×ª×¦×•×’×” ×©×œ ×”××©×™××•×ª ×‘×¤×¢××•×Ÿ. ××™×Ÿ ×¢×•×“ ×˜×‘×œ××•×ª.

A. ×œ×ª×§×Ÿ ××ª /api/reminders (403 Forbidden)
	1.	×¤×ª×— server/routes_leads.py.
	2.	××¦× ××ª ×”Ö¾route ×©×œ ×™×¦×™×¨×ª ××©×™××” (POST /api/reminders ××• ×“×•××”).
	3.	×•×“× ×©×”Ö¾decorator ×©×œ×• ×œ× ×—×•×¡× ×ª×¤×§×™×“×™×:

@leads_bp.route("/api/reminders", methods=["POST"])
@require_api_auth(allowed_roles=["system_admin", "owner", "admin", "agent"])

××• ×¤×©×•×˜:

@require_api_auth()

×× ×›×‘×¨ ×™×© ×¡×™× ×•×Ÿ ×œ×¤×™ tenant.

	4.	×× ×™×© ×‘×“×™×§×ª tenant_id ×©××—×–×™×¨×” 403 â€“ ×•×“× ×©:
	â€¢	tenant = get_current_tenant() ××—×–×™×¨ tenant_id ×××™×ª×™ (1,2,3â€¦) ×¢×‘×•×¨ owner/admin/agent.
	â€¢	××™×Ÿ ××¦×‘ ×©-system_admin ××§×‘×œ tenant_id=None ×× ×”×•× ×œ× ××ª×—×¤×© â€“ ×•××– ×–×” ×‘×¡×“×¨ ×©×”×•× ×™×§×‘×œ 403.
	5.	×‘×“×•×§ ××” ×”-body ×©×”-frontend ×©×•×œ×— (×ª×‘×“×•×§ ×‘×§×•×‘×¥ CrmPage / TaskCreateModal):
	â€¢	×•×“× ×©×›×œ ×”×©×“×•×ª ×©×”×©×¨×ª ××¦×¤×” ×œ×”× ×§×™×™××™×:
lead_id (××•×¤×¦×™×•× ×œ×™), title/content, due_at, channel/type ×•×›×•â€™.
	â€¢	×× ×©×™× ×™×ª ×©××•×ª ×©×“×•×ª â€“ ×ª×¢×“×›×Ÿ ××• ××ª ×”Ö¾schema ×‘×©×¨×ª ××• ××ª ×”-frontend ×›×š ×©×™×ª××™××•.

B. ×œ×”×’×“×™×¨ /api/notifications ×›×“×•â€×— ×§×¨×™××” ××¢×œ LeadReminder
	1.	×©×•×‘ ×‘Ö¾server/routes_leads.py ×ª××¦× ××• ×ª×™×¦×•×¨ route:

@leads_bp.route("/api/notifications", methods=["GET"])
@require_api_auth()
def get_notifications():


	2.	××™××•×© ××•××œ×¥:

def get_notifications():
    user = g.user
    tenant = get_current_tenant()
    if not tenant:
        return jsonify([])  # ×¢×“×™×£ ×¨×™×§ ×¢×œ 500

    session_db = get_session()

    try:
        # Reminders ×¢× ×œ×™×“
        q = (
            session_db.query(LeadReminder, Lead)
            .join(Lead, LeadReminder.lead_id == Lead.id)
            .filter(Lead.tenant_id == tenant.id)
        )

        # Reminders ×›×œ×œ×™×™× (×œ×œ× ×œ×™×“) â€“ ×œ×¤×™ ×”×¢×¡×§ ×©×œ ×”××©×ª××©
        q_no_lead = (
            session_db.query(LeadReminder, User)
            .join(User, LeadReminder.created_by_id == User.id)
            .filter(User.business_id == tenant.id)
        )

        rows = list(q.all()) + list(q_no_lead.all())

        notifications = []
        now = datetime.utcnow()
        for r in rows:
            reminder = r[0]
            is_overdue = reminder.due_at and reminder.due_at < now and not reminder.completed
            notifications.append({
                "id": reminder.id,
                "title": reminder.title or reminder.content,
                "due_at": reminder.due_at.isoformat() if reminder.due_at else None,
                "status": "overdue" if is_overdue else ("completed" if reminder.completed else "active"),
                "lead_id": reminder.lead_id,
            })

        return jsonify(notifications)
    except Exception as e:
        current_app.logger.exception("Error in /api/notifications")
        return jsonify([]), 200


	3.	×”××˜×¨×”: ×©×•× 500 â€“ ×‘××§×¨×” ×”×›×™ ×’×¨×•×¢ ××—×–×™×¨×™× ××¢×¨×š ×¨×™×§ ×¢× ×œ×•×’ ××¤×•×¨×˜.

C. ×œ×—×‘×¨ ××ª ×”Ö¾Frontend: Tasks â†â†’ Reminders â†â†’ Notifications
	1.	×¤×ª×— client/src/shared/contexts/NotificationContext.tsx:
	â€¢	×•×“× ×©×”×•× ×§×•×¨× ×œÖ¾GET /api/notifications (×œ× ×™×•×ª×¨ /api/reminders) ×›×“×™ ×œ××œ× ××ª ×”×”×ª×¨××•×ª ×‘×¤×¢××•×Ÿ.
	2.	×‘Ö¾CrmPage.tsx / ××¡×š ×”â€××©×™××•×ªâ€:
	â€¢	×™×¦×™×¨×ª ××©×™××”:
	â€¢	××©×ª××©×ª ×‘Ö¾mutation ×©×¢×•×©×” POST /api/reminders.
	â€¢	××—×¨×™ onSuccess ×ª×§×¨× ×œÖ¾refreshNotifications() ××”Ö¾NotificationContext.
	â€¢	×”×©××ª ×•×™ â€œ××©×™××” ×”×•×©×œ××”â€:
	â€¢	×©×•×œ×—×ª ××• PATCH /api/reminders/<id> ×¢× completed=True
	â€¢	××• endpoint ×¢×“×›× ×™ ×›×œ×©×”×• ×©×§×™×™× ××¦×œ×š.
	â€¢	×©×•×‘ â€“ ×‘×¡×™×•× ×œ×¢×“×›×Ÿ refreshNotifications().
	3.	×•×“× ×©××™×Ÿ ××•×“×œ × ×¤×¨×“ ×œ×˜×‘×œ×” notifications ×‘-DB. ×”×›×œ ×—×™×™×‘ ×œ×¢×‘×•×¨ ×“×¨×š LeadReminder.

â¸»

3ï¸âƒ£ ×©××•×ª ×œ×™×“×™× ×œ× ××•×¤×™×¢×™×

×‘×¢×™×”: ×¨×©×™××ª ×”×œ×™×“×™× ×œ× ××¦×™×’×” ×©× ×œ×™×“ (×¨×™×§).

×ª×™×§×•×Ÿ:
	1.	×‘×’×‘ (backend): ×‘×“×•×§ ××” ××—×–×™×¨ /api/leads:
	â€¢	×•×“× ×©×™×© ×©×“×•×ª ×›××• first_name, last_name ××• full_name.
	2.	×‘Ö¾frontend â€“ ×‘×“×£ ×œ×™×“×™× (×œ××©×œ client/src/pages/leads/LeadsListPage.tsx):
	â€¢	×‘××§×•× ×œ×”×¡×ª××š ×¢×œ lead.name ×‘×œ×‘×“, ×ª×™×¦×•×¨ ×¤×•× ×§×¦×™×”:

const getLeadDisplayName = (lead: Lead) => {
  if (lead.first_name || lead.last_name) {
    return `${lead.first_name || ""} ${lead.last_name || ""}`.trim() || "×œ×œ× ×©×";
  }
  return lead.full_name || lead.name || "×œ×œ× ×©×";
};


	â€¢	×”×©×ª××© ×‘Ö¾getLeadDisplayName(lead) ×‘×›×œ ××§×•× ×©×‘×• ××¦×™×’×™× ×©× ×œ×™×“.

	3.	×•×“× ×©×˜×•×¤×¡ ×™×¦×™×¨×ª ×œ×™×“ ×©×•×œ×— ×’× first_name/last_name ×œ×¤×™ ×”×©×™× ×•×™ ×©×¢×©×™×ª ×‘-UI.

â¸»

4ï¸âƒ£ ××” ×œ×‘×§×© ××× ×• ×‘×¡×•×£

×›×©××ª×” ××¡×™×™× ×œ×”×“×‘×™×§ ×œ×• ××ª ×›×œ ×–×”, ×ª×‘×§×© ××× ×• ×‘××¤×•×¨×©:
	1.	×œ×¨×•×¥ ×œ×¤×™ ×”×¡×“×¨:
	â€¢	×§×•×“× ×”×ª×—×–×•×ª (backend + frontend).
	â€¢	××—×¨Ö¾×›×š /api/reminders + /api/notifications.
	â€¢	××—×¨Ö¾×›×š ×ª×™×§×•×Ÿ ×©××•×ª ×”×œ×™×“×™×.
	2.	×‘×¡×•×£:
	â€¢	×œ×”×¨×™×¥ build + ×œ×”×¨×™×¥ ××ª ×”×©×¨×ª.
	â€¢	×œ×ª×ª ×œ×š ×¡×™×›×•× ×§×¦×¨ ××” ×©×™× ×” ×‘×›×œ ×§×•×‘×¥.
	â€¢	×œ×”×’×™×“ ×œ×š ×‘×“×™×•×§ ××” ×œ×‘×“×•×§ ×™×“× ×™×ª:
	â€¢	×”×ª×—×–×•×ª ×›-system_admin.
	â€¢	×™×¦×™×¨×ª ××©×™××” ×•×©×™× ×•×™ ×¡×˜×˜×•×¡ â†’ ×œ×¨××•×ª ×©×–×” ××•×¤×™×¢ ×‘×¤×¢××•×Ÿ.
	â€¢	×œ×™×“×™× ×©×œ ×¢×¡×§ 1 ×œ× ××•×¤×™×¢×™× ×‘×¢×¡×§ 2 ×•×œ×”×¤×š.
	â€¢	×©× ×œ×™×“ ××•×¦×’ ×›××• ×©×¦×¨×™×š.

×× ×ª×¨×¦×” ××—×¨×™ ×©×”×•× ××¡×™×™× â€“ ×ª×©×œ×— ×œ×™ ×©×•×‘ ×¦×™×œ×•× ××¡×š ××”-UI ×•××”-logs ×•×× ×™ ××¢×–×•×¨ ×œ×•×•×œ×™×“×¦×™×” ×¡×•×¤×™×ª.