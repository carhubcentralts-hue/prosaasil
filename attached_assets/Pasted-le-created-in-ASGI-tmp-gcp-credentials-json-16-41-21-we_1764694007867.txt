le created in ASGI: /tmp/gcp_credentials.json
16:41:21 web.1     | ================================================================================
16:41:21 web.1     | âœ… ASGI BUILD 88 READY - LAZY FLASK INIT
16:41:21 web.1     | ================================================================================
16:41:21 web.1     | âš¡ Flask warmup initiated in background
16:41:21 web.1     | INFO:     Started server process [12696]
16:41:21 web.1     | INFO:     Waiting for application startup.
16:41:21 web.1     | INFO:     Application startup complete.
16:41:21 web.1     | INFO:     Uvicorn running on http://0.0.0.0:5000 (Press CTRL+C to quit)
16:41:21 web.1     | ğŸ”¥ [WARMUP] Starting Flask app initialization...
16:41:21 web.1     | ğŸ”§ Creating Flask app (first request)...
16:41:23 web.1     | âš¡ PHASE 1: Async logging enabled (Eventlet-based)
16:41:23 web.1     | ğŸ”§ GCP credentials loaded from file path: /tmp/gcp_credentials.json...
16:41:23 web.1     | ğŸ”§ FE_DIST=/home/runner/workspace/server/../client/dist
16:41:23 web.1     | ğŸ”§ APP_SHA=f29fabbb
16:41:23 web.1     | ğŸš© APP_START {'build': 87, 'sha': 'f29fabbb', 'fe': 'client/dist', 'time': '2025-12-02 16:41:23', 'app': 'AgentLocator-Complete', 'commit': 'f29fabbb', 'startup_ts': 1764693683}
16:41:23 web.1     | ğŸ”§ DB_DRIVER: postgresql
16:41:23 web.1     | âœ… Auth blueprints registered
16:41:23 web.1     | âœ… User Management API blueprint registered
16:41:25 web.1     | âœ… Agent API blueprint registered
16:41:25 web.1     | âœ… Agent Ops API blueprint registered
16:41:25 web.1     | ğŸ”§ WebSocket: Handled by ASGI layer (Starlette WebSocket)
16:41:25 web.1     | ğŸ“ /ws/twilio-media â†’ ASGI WebSocket (asgi.py)
16:41:25 web.1     | âœ… WebSocket test route added: /test-websocket-version
16:41:25 web.1     | ğŸ” ALL REGISTERED ROUTES:
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /<path:filename>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/business/<tenant>/prompts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/<int:business_id>/prompt
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/admin/businesses/<int:business_id>/prompt
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/business/current/prompt
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/business/current/prompt
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/<int:business_id>/prompt/history
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/business/current/prompt/history
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/statuses
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/statuses
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/statuses/<int:status_id>
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/statuses/<int:status_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/statuses/reorder
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/statuses/initialize/<int:business_id>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/auth/csrf
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/login
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/forgot
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/reset
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/logout
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/auth/me
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/auth/current
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/init-admin
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/users
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/overview
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/businesses
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/revenue
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/<int:business_id>/overview
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/overview
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/calls
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/whatsapp
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/tenants
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/calls
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/leads
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/leads/stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/phone-numbers
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/prompts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/support/profile
16:41:25 web.1     |   {'GET', 'HEAD', 'PUT', 'OPTIONS'} /api/admin/support/prompt
16:41:25 web.1     |   {'GET', 'HEAD', 'PUT', 'OPTIONS'} /api/admin/support/phones
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/threads
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/threads/<thread_id>/messages
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/threads/<thread_id>/summary
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/customers
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/active
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/history
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/contracts
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/contracts
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/payments/create
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments/paypal/return/success
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments/paypal/return/cancel
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments/tranzila/return/success
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments/tranzila/return/fail
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/invoices/<invoice_number>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/contracts/sign
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/deals
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/deals
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/search
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/tasks
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/tasks
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/crm/tasks/<int:task_id>
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/crm/tasks/<int:task_id>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/business/<int:business_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/business
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/admin/business/<int:business_id>
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/admin/business/<int:business_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/business/<int:business_id>/change-password
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/user
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/user/<int:user_id>
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/admin/user/<int:user_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/user/<int:user_id>/change-password
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/user/<int:user_id>/toggle-status
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/businesses/<int:business_id>/impersonate
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/impersonate/exit
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/business/current
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/business/current/settings
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/business/faqs
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/business/faqs
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/business/faqs/<int:faq_id>
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/business/faqs/<int:faq_id>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /webhook/incoming_call_preview
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /webhook/voice
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /webhook/incoming-call
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /webhook/incoming_call
16:41:25 web.1     |   {'POST', 'OPTIONS'} /webhook/stream_ended
16:41:25 web.1     |   {'POST', 'OPTIONS'} /webhook/handle_recording
16:41:25 web.1     |   {'POST', 'OPTIONS'} /webhook/stream_status
16:41:25 web.1     |   {'POST', 'OPTIONS'} /webhook/call_status
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /webhook/test
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /webhook/debug-method
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /webhook/test_media_streams_1756667590
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calendar/appointments
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/calendar/appointments
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calendar/appointments/<int:appointment_id>
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/calendar/appointments/<int:appointment_id>
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/calendar/appointments/<int:appointment_id>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calendar/stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads/<int:lead_id>
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/leads/<int:lead_id>
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/leads/<int:lead_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads/<int:lead_id>/status
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads/<int:lead_id>/reminders
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads/<int:lead_id>/activities
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads/<int:lead_id>/reminders
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/leads/<int:lead_id>/move
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads/<int:lead_id>/reminders/<int:reminder_id>
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/leads/<int:lead_id>/reminders/<int:reminder_id>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/reminders/due
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/notifications
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads/bulk-delete
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/leads/bulk
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads/<int:lead_id>/message/whatsapp
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/reminders
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/reminders
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/reminders/<int:reminder_id>
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/reminders/<int:reminder_id>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users/<int:user_id>
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users/<int:user_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users/<int:user_id>/change-password
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/businesses/<int:business_id>/owner
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/<call_sid>/details
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/<call_sid>/download
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/calls/cleanup
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/stats
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/calls/<call_sid>/transcript
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/calls/<call_sid>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/receipts
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/receipts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/contracts
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/contracts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/contracts/<int:contract_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/contracts/<int:contract_id>/sign
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/billing/invoice/<invoice_id>/view
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/billing/invoice/<invoice_id>/download
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/billing/contract/<contract_id>/view
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/billing/contract/<contract_id>/download
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/status
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/qr
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/start
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/reset
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/disconnect
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/ai-state
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/ai-state
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/contacts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/messages
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/messages/<phone_number>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/conversation/<phone_number>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/stats
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/prompts/<int:business_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/webhook/incoming
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/send
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/toggle-ai
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/ai-state/<phone_number>
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /api/whatsapp/webhook/meta
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/test
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/whatsapp/provider
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/provider-info
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/active-chats
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/process-stale-sessions
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/summaries
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/internal/whatsapp/status-webhook
16:41:25 web.1     |   {'POST', 'OPTIONS'} /webhook/whatsapp/incoming
16:41:25 web.1     |   {'POST', 'OPTIONS'} /webhook/whatsapp/status
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/intelligence/customers
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/intelligence/stats
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/agent/booking
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/agent/sales
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/agent/status
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/agent/ops
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/channels/
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/channels/business/<int:business_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/channels/
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/admin/channels/<int:channel_id>
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/channels/businesses
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/dashboard/stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/dashboard/activity
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /healthz
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /readyz
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /version
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /livez
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /warmup
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /db-check
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /app/admin
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /app/biz
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/admin/overview
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/admin/switch_business
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/admin/tenants/new
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/admin/users/new
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/admin/tenants
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/admin/users
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/whatsapp/threads
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/whatsapp/messages
16:41:25 web.1     |   {'POST', 'OPTIONS'} /ui/whatsapp/send
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/calls/active
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/calls/history
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/biz/contacts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/biz/contacts/new
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/biz/users/new
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /ui/biz/users
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/ui/login
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /api/ui/logout
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/tenants
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/users
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/biz/users
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/contacts
16:41:25 web.1     |   {'POST', 'OPTIONS'} /admin/impersonate/<int:business_id>
16:41:25 web.1     |   {'POST', 'OPTIONS'} /admin/stop-impersonate
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /biz/invoices
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /biz/contracts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /logout
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /unauthorized
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /test-websocket-version
16:41:25 web.1     | ğŸ” Route registration complete
16:41:25 web.1     | ğŸ”§ WebSocket routes removed from Flask - handled by wsgi.py composite
16:41:25 web.1     | âœ… Health routes handled by health_endpoints.py blueprint
16:41:25 web.1     | âœ… Factory debug route registered: /debug-factory-http
16:41:25 web.1     | âœ… /healthz route added directly to app_factory
16:41:25 web.1     | ğŸ†˜ Emergency healthz-direct route added
16:41:25 web.1     | âœ… WhatsApp routes removed - using unified only
16:41:25 web.1     | âœ… Baileys proxy routes: 0 /wa/* endpoints
16:41:25 web.1     | âœ… Legacy proxy routes: 0 /api/wa-proxy/* endpoints
16:41:25 web.1     | FE_DIST = /home/runner/workspace/client/dist mtime = 1764452869.5993035
16:41:25 web.1     | âš¡ Server starting immediately - DB initialization running in background
16:41:25 web.1     | ğŸ”¥ Service warmup initiated
16:41:25 web.1     | ğŸ”¥ Periodic warmup started (every 7-8 minutes)
16:41:25 web.1     | 
16:41:25 web.1     | === URL MAP ===
16:41:25 web.1     |   {'POST', 'OPTIONS'} /admin/impersonate/<int:business_id> -> ui.admin_impersonate_business
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/business -> business_management.create_business
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/business/<int:business_id> -> business_management.get_business
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/admin/business/<int:business_id> -> business_management.update_business
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/admin/business/<int:business_id> -> business_management.delete_business
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/business/<int:business_id>/change-password -> business_management.change_business_password
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses -> admin_bp.api_admin_businesses
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/businesses/<int:business_id>/impersonate -> business_management.impersonate_business
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/<int:business_id>/overview -> admin_bp.get_business_overview
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/businesses/<int:business_id>/owner -> user_mgmt_api.set_business_owner
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/<int:business_id>/prompt -> ai_prompt.get_business_prompt
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/admin/businesses/<int:business_id>/prompt -> ai_prompt.update_business_prompt
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/<int:business_id>/prompt/history -> ai_prompt.get_prompt_history
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users -> user_mgmt_api.get_business_users
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users -> user_mgmt_api.create_business_user
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users/<int:user_id> -> user_mgmt_api.update_business_user
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users/<int:user_id> -> user_mgmt_api.delete_business_user
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/businesses/<int:business_id>/users/<int:user_id>/change-password -> user_mgmt_api.change_business_user_password
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/businesses/prompts -> admin_bp.admin_businesses_prompts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/calls -> admin_bp.api_admin_calls
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/channels/ -> admin_channels.get_all_channels
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/channels/ -> admin_channels.create_channel
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/admin/channels/<int:channel_id> -> admin_channels.remove_channel
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/channels/business/<int:business_id> -> admin_channels.get_business_channels
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/channels/businesses -> admin_channels.get_businesses
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/impersonate/exit -> business_management.exit_impersonation
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/businesses -> admin_bp.api_kpis_businesses
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/calls -> admin_bp.api_admin_kpis_calls
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/overview -> admin_bp.api_admin_kpis_overview
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/revenue -> admin_bp.api_kpis_revenue
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/kpis/whatsapp -> admin_bp.api_admin_kpis_whatsapp
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/leads -> admin_bp.admin_leads
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/leads/stats -> admin_bp.admin_leads_stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/overview -> admin_bp.api_overview
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/phone-numbers -> admin_bp.admin_phone_numbers
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/run-migrations -> run_migrations_endpoint
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/stats -> api_adapter.admin_stats
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/statuses/initialize/<int:business_id> -> status_management.initialize_default_statuses
16:41:25 web.1     |   {'GET', 'HEAD', 'PUT', 'OPTIONS'} /api/admin/support/phones -> admin_bp.admin_support_phones
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/support/profile -> admin_bp.admin_support_profile
16:41:25 web.1     |   {'GET', 'HEAD', 'PUT', 'OPTIONS'} /api/admin/support/prompt -> admin_bp.admin_support_prompt
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/tenants -> admin_bp.api_tenants
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/tenants -> ui.api_admin_tenants_create
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/user -> business_management.create_user
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/user/<int:user_id> -> business_management.get_user
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/admin/user/<int:user_id> -> business_management.update_user
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/user/<int:user_id>/change-password -> business_management.change_user_password
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/user/<int:user_id>/toggle-status -> business_management.toggle_user_status
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/admin/users -> admin_bp.get_all_users
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/admin/users -> ui.api_admin_users_create
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/agent/booking -> agent_api.agent_booking
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/agent/ops -> agent_ops.agent_ops
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/agent/sales -> agent_api.agent_sales
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/agent/status -> agent_api.agent_status
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/auth/csrf -> auth_api.get_csrf
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/auth/current -> auth_api.get_current_user_legacy
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/forgot -> auth_api.forgot_password
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/init-admin -> auth_api.init_admin
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/login -> auth_api.login
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/logout -> auth_api.logout
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/auth/me -> auth_api.get_current_user
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/auth/reset -> auth_api.reset_password
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/billing/contract/<contract_id>/download -> receipts_contracts.download_contract
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/billing/contract/<contract_id>/view -> receipts_contracts.view_contract
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/billing/invoice/<invoice_id>/download -> receipts_contracts.download_invoice
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/billing/invoice/<invoice_id>/view -> receipts_contracts.view_invoice
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/biz/users -> ui.api_biz_users_create
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/business/<tenant>/prompts -> ai_prompt.save_prompt
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/business/current -> business_management.get_current_business
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/business/current/prompt -> ai_prompt.get_current_business_prompt
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/business/current/prompt -> ai_prompt.update_current_business_prompt
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/business/current/prompt/history -> ai_prompt.get_current_prompt_history
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/business/current/settings -> business_management.update_current_business_settings
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/business/faqs -> business_management.get_business_faqs
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/business/faqs -> business_management.create_faq
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/business/faqs/<int:faq_id> -> business_management.update_faq
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/business/faqs/<int:faq_id> -> business_management.delete_faq
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calendar/appointments -> calendar.get_appointments
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/calendar/appointments -> calendar.create_appointment
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calendar/appointments/<int:appointment_id> -> calendar.get_appointment
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/calendar/appointments/<int:appointment_id> -> calendar.update_appointment
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/calendar/appointments/<int:appointment_id> -> calendar.delete_appointment
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calendar/stats -> calendar.get_calendar_stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls -> calls.list_calls
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/calls/<call_sid> -> calls.delete_call
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/<call_sid>/details -> calls.get_call_details
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/<call_sid>/download -> calls.download_recording
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/calls/<call_sid>/transcript -> calls.update_transcript
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/active -> crm_bp.api_active_calls
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/calls/cleanup -> calls.cleanup_old_recordings
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/history -> crm_bp.api_call_history
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/calls/stats -> calls.get_calls_stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/contracts -> receipts_contracts.list_contracts
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/contracts -> receipts_contracts.create_contract
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/contracts/<int:contract_id> -> receipts_contracts.get_contract
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/contracts/<int:contract_id>/sign -> receipts_contracts.sign_contract
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/contacts -> ui.api_crm_contacts_create
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/contracts -> crm_bp.get_contracts
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/contracts -> crm_bp.create_contract
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/contracts/sign -> crm_bp.contract_sign
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/customers -> crm_bp.api_customers
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/deals -> crm_bp.list_deals
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/deals -> crm_bp.create_deal
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/invoices/<invoice_number> -> crm_bp.get_invoice
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments -> crm_bp.get_payments
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/payments/create -> crm_bp.payments_create
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments/paypal/return/cancel -> crm_bp.paypal_cancel
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments/paypal/return/success -> crm_bp.paypal_success
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments/tranzila/return/fail -> crm_bp.tranzila_fail
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/payments/tranzila/return/success -> crm_bp.tranzila_success
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/tasks -> crm_bp.get_crm_tasks
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/crm/tasks -> crm_bp.create_crm_task
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/crm/tasks/<int:task_id> -> crm_bp.update_crm_task
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/crm/tasks/<int:task_id> -> crm_bp.delete_crm_task
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/threads -> crm_bp.api_threads
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/threads/<thread_id>/messages -> crm_bp.api_thread_messages
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/crm/threads/<thread_id>/summary -> crm_bp.api_thread_summary
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/dashboard/activity -> api_adapter.dashboard_activity
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/dashboard/stats -> api_adapter.dashboard_stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/intelligence/customers -> intelligence.get_intelligent_customers
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/intelligence/stats -> intelligence.get_intelligence_stats
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/internal/whatsapp/status-webhook -> internal_whatsapp.whatsapp_status_webhook
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads -> leads_bp.list_leads
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads -> leads_bp.create_lead
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads/<int:lead_id> -> leads_bp.get_lead_detail
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/leads/<int:lead_id> -> leads_bp.update_lead
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/leads/<int:lead_id> -> leads_bp.delete_lead
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads/<int:lead_id>/activities -> leads_bp.get_lead_activities
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads/<int:lead_id>/message/whatsapp -> leads_bp.send_whatsapp_message
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/leads/<int:lead_id>/move -> leads_bp.move_lead_in_kanban
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads/<int:lead_id>/reminders -> leads_bp.get_lead_reminders
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads/<int:lead_id>/reminders -> leads_bp.create_reminder
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/leads/<int:lead_id>/reminders/<int:reminder_id> -> leads_bp.get_reminder
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/leads/<int:lead_id>/reminders/<int:reminder_id> -> leads_bp.update_reminder
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads/<int:lead_id>/status -> leads_bp.update_lead_status
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/leads/bulk -> leads_bp.bulk_update_leads
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/leads/bulk-delete -> leads_bp.bulk_delete_leads
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/notifications -> leads_bp.get_notifications
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/receipts -> receipts_contracts.list_receipts
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/receipts -> receipts_contracts.create_receipt
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/reminders -> leads_bp.get_all_reminders
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/reminders -> leads_bp.create_general_reminder
16:41:25 web.1     |   {'PATCH', 'OPTIONS'} /api/reminders/<int:reminder_id> -> leads_bp.update_general_reminder
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/reminders/<int:reminder_id> -> leads_bp.delete_general_reminder
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/reminders/due -> leads_bp.get_due_reminders
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/search -> crm_bp.global_search
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/statuses -> status_management.get_business_statuses
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/statuses -> status_management.create_status
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/statuses/<int:status_id> -> status_management.update_status
16:41:25 web.1     |   {'DELETE', 'OPTIONS'} /api/statuses/<int:status_id> -> status_management.delete_status
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/statuses/reorder -> status_management.reorder_statuses
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/ui/login -> ui.api_login
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /api/ui/logout -> ui.api_logout
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/active-chats -> whatsapp.get_active_chats
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/ai-state -> whatsapp.set_ai_state
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/ai-state -> whatsapp.get_ai_state
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/ai-state/<phone_number> -> whatsapp.get_ai_state_for_conversation
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/contacts -> whatsapp.api_wa_contacts
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/conversation/<phone_number> -> whatsapp.get_conversation
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/disconnect -> whatsapp.disconnect
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/messages -> whatsapp.api_wa_messages
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/messages/<phone_number> -> whatsapp.api_wa_messages_by_phone
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/process-stale-sessions -> whatsapp.trigger_stale_session_processing
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/prompts/<int:business_id> -> whatsapp.save_whatsapp_prompt
16:41:25 web.1     |   {'PUT', 'OPTIONS'} /api/whatsapp/provider -> whatsapp.update_provider
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/provider-info -> whatsapp.get_provider_info
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/qr -> whatsapp.qr
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/reset -> whatsapp.reset
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/send -> whatsapp.send_manual_message
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/start -> whatsapp.start
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/stats -> whatsapp.api_wa_stats
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/status -> whatsapp.status
16:41:25 web.1     |   {'GET', 'HEAD', 'OPTIONS'} /api/whatsapp/summaries -> whatsapp.get_whatsapp_summaries
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/test -> whatsapp.whatsapp_test
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/toggle-ai -> whatsapp.toggle_ai_for_conversation
16:41:25 web.1     |   {'POST', 'OPTIONS'} /api/whatsapp/webhook/incoming -> whatsapp.baileys_webhook
16:41:25 web.1     |   {'GET', 'HEAD', 'POST', 'OPTIONS'} /api/whatsapp/webhook/meta -> whatsapp.meta_webhook
16:41:25 web.1     | ================
16:41:25 web.1     | âœ… Simple SPA routes registered (no blueprint)
16:41:25 web.1     | ğŸ”¥ğŸ”¥ğŸ”¥ WARMUP STARTING - Preloading all services...ğŸ”§ [BACKGROUND] Running migrations...
16:41:25 web.1     |   ğŸ”¥ Warming OpenAI client...
16:41:25 web.1     | 
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ”¥ STARTING TTS PRE-WARMUP...
16:41:26 web.1     |     âœ… OpenAI client ready
16:41:26 web.1     |   ğŸ”¥ Warming Google TTS client...
16:41:26 web.1     |     âœ… TTS client ready
16:41:26 web.1     |   ğŸ”¥ Warming Google STT client...
16:41:26 web.1     | âŒ TTS prewarm EXCEPTION: TTS synthesis failed during warmup
16:41:26 web.1     | Traceback: Traceback (most recent call last):
16:41:26 web.1     |   File "/home/runner/workspace/server/app_factory.py", line 862, in create_app
16:41:26 web.1     |     success = maybe_warmup()
16:41:26 web.1     |               ^^^^^^^^^^^^^^
16:41:26 web.1     |   File "/home/runner/workspace/server/services/gcp_tts_live.py", line 262, in maybe_warmup
16:41:26 web.1     |     raise RuntimeError("TTS synthesis failed during warmup")
16:41:26 web.1     | RuntimeError: TTS synthesis failed during warmup
16:41:26 web.1     | 
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | 
16:41:26 web.1     | ğŸ”¥ Starting agent warmup...
16:41:26 web.1     | 
16:41:26 web.1     | ğŸ”¥ WARMUP: Pre-creating agents for active businesses...
16:41:26 web.1     | âœ… Agent warmup started in background thread (with app context)
16:41:26 web.1     | âœ… App singleton set - future calls will reuse this instance
16:41:26 web.1     | 
16:41:26 web.1     | ğŸ—‘ï¸ Starting automatic recording cleanup scheduler...
16:41:26 web.1     | ğŸ—‘ï¸ Recording cleanup scheduler started (runs every 6 hours)
16:41:26 web.1     | âœ… Recording cleanup scheduler started (7-day retention, runs every 6 hours)
16:41:26 web.1     | 
16:41:26 web.1     | ğŸ“± Starting WhatsApp session processor...
16:41:26 web.1     | [WA-SESSION] ğŸ“± Background processor thread started - checking every 5 minutes
16:41:26 web.1     | âœ… WhatsApp session processor started (15-min inactivity auto-summary)
16:41:26 web.1     | âœ… Flask app created
16:41:26 web.1     | âœ… [WARMUP] Flask app ready for Realtime calls
16:41:26 web.1     |     âœ… STT client ready
16:41:26 web.1     | ğŸ”’ LAYER 1 (BEFORE): 0 FAQs in database
16:41:26 web.1     | ğŸ“Š Found 2 businesses to warm up
16:41:26 web.1     | ğŸ“‹ PROMPT LOADING: business_id=10, channel=calls, custom_instructions provided=False
16:41:26 web.1     | ğŸ”’ LAYER 1 (BEFORE): 9 leads in database
16:41:26 web.1     | ğŸ“‹ LOADING PROMPT: business_id=10, business_name=×©×™×©×™×©×™  ğŸ”¥ Warming 2 active businesses (Agent Cache)...
16:41:26 web.1     | 
16:41:26 web.1     | âœ… Loaded calls prompt from DB for business=10 (53 chars)
16:41:26 web.1     | ğŸ“ PROMPT PREVIEW: ××ª×” ×¢×•×–×¨ AI ×œ××›×™×¨×•×ª × ×“×œ"×Ÿ. ×©××•×¨ ×¢×œ ×©×™×—×” ×§×¦×¨×” ×•×××•×§×“×ª....
16:41:26 web.1     | ğŸ”¨ CALLING create_booking_agent(business_id=10, channel=calls)
16:41:26 web.1     | 
16:41:26 web.1     | âœ… Using DB prompt for ×©×™×©×™×©×™ (53 chars)
16:41:26 web.1     |    System rules: 4173 chars (prepended)
16:41:26 web.1     |    DB prompt: 53 chars
16:41:26 web.1     |    = Total: 4226 chars
16:41:26 web.1     | 
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ“œ AGENT INSTRUCTIONS (first 500 chars):
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ”’ SYSTEM CONTEXT (READ BUT DON'T MENTION):
16:41:26 web.1     | TODAY: 2025-12-02 18:41 (Israel)
16:41:26 web.1     | TOMORROW: 2025-12-03
16:41:26 web.1     | APPOINTMENT INTERVALS: ×ª×•×¨×™× ×‘×¢×¡×§ ×”×–×” × ×™×ª× ×™× ×œ×§×‘×™×¢×” ×›×œ ×©×¢×” (60 ×“×§×•×ª)
16:41:26 web.1     | 
16:41:26 web.1     | âš ï¸ CRITICAL ANTI-HALLUCINATION RULES (BUILD 112):
16:41:26 web.1     | 1. NEVER say "×§×‘×¢×ª×™"/"×”×¤×’×™×©×” × ×§×‘×¢×”" UNLESS you called calendar_create_appointment() THIS turn and got ok:true
16:41:26 web.1     | 2. NEVER say "×ª×¤×•×¡"/"×¤× ×•×™"/"×™×© ×ª×•×¨" UNLESS you called calendar_find_slots() THIS turn
16:41:26 web.1     | 3. NEVER say "×©×œ×—×ª×™ ××™×©×•×¨" UNLESS you called whatsapp_send() THIS turn
16:41:26 web.1     | 4. ğŸ”¥ BUILD 112: 
16:41:26 web.1     | ...
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ“… Today calculated as: 2025-12-02 (Tuesday)
16:41:26 web.1     | ğŸ“… Tomorrow calculated as: 2025-12-03
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | 
16:41:26 web.1     | âœ… create_booking_agent RETURNED: True
16:41:26 web.1     | â±ï¸  AGENT_CREATION_TIME: 80ms
16:41:26 web.1     | âœ… Warmed: ×©×™×©×™×©×™ (calls)  âœ… ×©×™×©×™×©×™ (calls): 16ms
16:41:26 web.1     | ğŸ“‹ PROMPT LOADING: business_id=10, channel=whatsapp, custom_instructions provided=False
16:41:26 web.1     | 
16:41:26 web.1     | ğŸ“‹ LOADING PROMPT: business_id=10, business_name=×©×™×©×™×©×™
16:41:26 web.1     | âœ… Loaded whatsapp prompt from DB for business=10 (58 chars)
16:41:26 web.1     | ğŸ“ PROMPT PREVIEW: ××ª×” ×¢×•×–×¨ AI ×œ××›×™×¨×•×ª × ×“×œ"×Ÿ ×‘-WhatsApp. ×”×™×” ×™×“×™×“×•×ª×™ ×•××§×¦×•×¢×™....
16:41:26 web.1     | ğŸ”¨ CALLING create_booking_agent(business_id=10, channel=whatsapp)
16:41:26 web.1     | 
16:41:26 web.1     | âœ… Using DB prompt for ×©×™×©×™×©×™ (58 chars)
16:41:26 web.1     |    System rules: 4173 chars (prepended)
16:41:26 web.1     |    DB prompt: 58 chars
16:41:26 web.1     |    = Total: 4231 chars
16:41:26 web.1     | 
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ“œ AGENT INSTRUCTIONS (first 500 chars):
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ”’ SYSTEM CONTEXT (READ BUT DON'T MENTION):
16:41:26 web.1     | TODAY: 2025-12-02 18:41 (Israel)
16:41:26 web.1     | TOMORROW: 2025-12-03
16:41:26 web.1     | APPOINTMENT INTERVALS: ×ª×•×¨×™× ×‘×¢×¡×§ ×”×–×” × ×™×ª× ×™× ×œ×§×‘×™×¢×” ×›×œ ×©×¢×” (60 ×“×§×•×ª)
16:41:26 web.1     | 
16:41:26 web.1     | âš ï¸ CRITICAL ANTI-HALLUCINATION RULES (BUILD 112):
16:41:26 web.1     | 1. NEVER say "×§×‘×¢×ª×™"/"×”×¤×’×™×©×” × ×§×‘×¢×”" UNLESS you called calendar_create_appointment() THIS turn and got ok:true
16:41:26 web.1     | 2. NEVER say "×ª×¤×•×¡"/"×¤× ×•×™"/"×™×© ×ª×•×¨" UNLESS you called calendar_find_slots() THIS turn
16:41:26 web.1     | 3. NEVER say "×©×œ×—×ª×™ ××™×©×•×¨" UNLESS you called whatsapp_send() THIS turn
16:41:26 web.1     | 4. ğŸ”¥ BUILD 112: 
16:41:26 web.1     | ...
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ“… Today calculated as: 2025-12-02 (Tuesday)
16:41:26 web.1     | ğŸ“… Tomorrow calculated as: 2025-12-03
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | 
16:41:26 web.1     | âœ… create_booking_agent RETURNED: True
16:41:26 web.1     | â±ï¸  AGENT_CREATION_TIME: 68ms
16:41:26 web.1     | âœ… Warmed: ×©×™×©×™×©×™ (whatsapp)
16:41:26 web.1     |   âœ… ×©×™×©×™×©×™ (whatsapp): 47ms
16:41:26 web.1     | ğŸ“‹ PROMPT LOADING: business_id=1, channel=calls, custom_instructions provided=False
16:41:26 web.1     | ğŸ“‹ LOADING PROMPT: business_id=1, business_name=×¤×¨×• ×¡××¡
16:41:26 web.1     | âœ… Loaded calls prompt from DB for business=1 (1516 chars)
16:41:26 web.1     | ğŸ“ PROMPT PREVIEW: ğŸ­ ROLE
16:41:26 web.1     | 
16:41:26 web.1     | You are a professional Hebrew-speaking assistant for Calliber, a platform that connects cust...
16:41:26 web.1     | ğŸ”¨ CALLING create_booking_agent(business_id=1, channel=calls)
16:41:26 web.1     | 
16:41:26 web.1     | âœ… Using DB prompt for ×¤×¨×• ×¡××¡ (1516 chars)
16:41:26 web.1     |    System rules: 4173 chars (prepended)
16:41:26 web.1     |    DB prompt: 1516 chars
16:41:26 web.1     |    = Total: 5689 chars
16:41:26 web.1     | 
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ“œ AGENT INSTRUCTIONS (first 500 chars):
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ”’ SYSTEM CONTEXT (READ BUT DON'T MENTION):
16:41:26 web.1     | TODAY: 2025-12-02 18:41 (Israel)
16:41:26 web.1     | TOMORROW: 2025-12-03
16:41:26 web.1     | APPOINTMENT INTERVALS: ×ª×•×¨×™× ×‘×¢×¡×§ ×”×–×” × ×™×ª× ×™× ×œ×§×‘×™×¢×” ×›×œ ×©×¢×” (60 ×“×§×•×ª)
16:41:26 web.1     | 
16:41:26 web.1     | âš ï¸ CRITICAL ANTI-HALLUCINATION RULES (BUILD 112):
16:41:26 web.1     | 1. NEVER say "×§×‘×¢×ª×™"/"×”×¤×’×™×©×” × ×§×‘×¢×”" UNLESS you called calendar_create_appointment() THIS turn and got ok:true
16:41:26 web.1     | 2. NEVER say "×ª×¤×•×¡"/"×¤× ×•×™"/"×™×© ×ª×•×¨" UNLESS you called calendar_find_slots() THIS turn
16:41:26 web.1     | 3. NEVER say "×©×œ×—×ª×™ ××™×©×•×¨" UNLESS you called whatsapp_send() THIS turn
16:41:26 web.1     | 4. ğŸ”¥ BUILD 112: 
16:41:26 web.1     | ...
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ“… Today calculated as: 2025-12-02 (Tuesday)
16:41:26 web.1     | ğŸ“… Tomorrow calculated as: 2025-12-03
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | 
16:41:26 web.1     | âœ… create_booking_agent RETURNED: True
16:41:26 web.1     | â±ï¸  AGENT_CREATION_TIME: 67ms
16:41:26 web.1     | âœ… Warmed: ×¤×¨×• ×¡××¡ (calls)
16:41:26 web.1     |   âœ… ×¤×¨×• ×¡××¡ (calls): 30ms
16:41:26 web.1     | ğŸ“‹ PROMPT LOADING: business_id=1, channel=whatsapp, custom_instructions provided=False
16:41:26 web.1     | ğŸ“‹ LOADING PROMPT: business_id=1, business_name=×¤×¨×• ×¡××¡
16:41:26 web.1     | âœ… Loaded whatsapp prompt from DB for business=1 (3349 chars)
16:41:26 web.1     | ğŸ“ PROMPT PREVIEW: ××ª×” Assistant ××§×¦×•×¢×™ ×©×œ ×—×‘×¨×ª ProSaaS.
16:41:26 web.1     | 
16:41:26 web.1     | ×ª×¤×§×™×“×š ×œ× ×”×œ ×©×™×—×” ×˜×‘×¢×™×ª, ×©×™×¨×•×ª×™×ª ×•× ×¢×™××” ×¢× ×œ×§×•×—×•×ª ×©××ª×¢× ×™×™× ×™× ×‘...
16:41:26 web.1     | ğŸ”¨ CALLING create_booking_agent(business_id=1, channel=whatsapp)
16:41:26 web.1     | 
16:41:26 web.1     | âœ… Using DB prompt for ×¤×¨×• ×¡××¡ (3349 chars)
16:41:26 web.1     |    System rules: 4173 chars (prepended)
16:41:26 web.1     |    DB prompt: 3349 chars
16:41:26 web.1     |    = Total: 7522 chars
16:41:26 web.1     | 
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ“œ AGENT INSTRUCTIONS (first 500 chars):
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ”’ SYSTEM CONTEXT (READ BUT DON'T MENTION):
16:41:26 web.1     | TODAY: 2025-12-02 18:41 (Israel)
16:41:26 web.1     | TOMORROW: 2025-12-03
16:41:26 web.1     | APPOINTMENT INTERVALS: ×ª×•×¨×™× ×‘×¢×¡×§ ×”×–×” × ×™×ª× ×™× ×œ×§×‘×™×¢×” ×›×œ ×©×¢×” (60 ×“×§×•×ª)
16:41:26 web.1     | 
16:41:26 web.1     | âš ï¸ CRITICAL ANTI-HALLUCINATION RULES (BUILD 112):
16:41:26 web.1     | 1. NEVER say "×§×‘×¢×ª×™"/"×”×¤×’×™×©×” × ×§×‘×¢×”" UNLESS you called calendar_create_appointment() THIS turn and got ok:true
16:41:26 web.1     | 2. NEVER say "×ª×¤×•×¡"/"×¤× ×•×™"/"×™×© ×ª×•×¨" UNLESS you called calendar_find_slots() THIS turn
16:41:26 web.1     | 3. NEVER say "×©×œ×—×ª×™ ××™×©×•×¨" UNLESS you called whatsapp_send() THIS turn
16:41:26 web.1     | 4. ğŸ”¥ BUILD 112: 
16:41:26 web.1     | ...
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | ğŸ“… Today calculated as: 2025-12-02 (Tuesday)
16:41:26 web.1     | ğŸ“… Tomorrow calculated as: 2025-12-03
16:41:26 web.1     | ================================================================================
16:41:26 web.1     | 
16:41:26 web.1     | âœ… create_booking_agent RETURNED: True
16:41:26 web.1     | â±ï¸  AGENT_CREATION_TIME: 67ms
16:41:26 web.1     | âœ… Warmed: ×¤×¨×• ×¡××¡ (whatsapp)
16:41:26 web.1     | 
16:41:26 web.1     | ğŸ‰ WARMUP COMPLETE: 4 agents ready in 492ms
16:41:26 web.1     |   âœ… ×¤×¨×• ×¡××¡ (whatsapp): 48ms
16:41:26 web.1     | 
16:41:26 web.1     | ğŸ”¥ğŸ”¥ğŸ”¥ WARMUP COMPLETE: 4/4 agents ready in 240ms
16:41:26 web.1     | ğŸš€ System preheated - First AI response will be FAST!
16:41:26 web.1     | 
16:41:26 web.1     | âœ… Service warmup thread completed
16:41:28 web.1     | âœ… DATA PROTECTION: 0 FAQs preserved (no deletions)
16:41:28 web.1     | âœ… DATA PROTECTION: 9 leads preserved (no deletions)
16:41:28 web.1     | âœ… [BACKGROUND] Migrations applied
16:41:28 web.1     | ğŸ”„ Starting admin roles migration...
16:41:28 web.1     | ğŸ“Š Found 1 users with legacy roles
16:41:28 web.1     | ğŸ“ Business admin: 'admin@shai-realestate.co.il' (ID=7): admin -> admin (business_id=1)
16:41:28 web.1     | 
16:41:28 web.1     | âœ… Successfully migrated 1 users to new role structure!
16:41:28 web.1     | âœ… [BACKGROUND] Admin roles migrated
16:41:28 web.1     | ğŸ‘¤ Admin exists (ID=8), resetting password to 'admin123'
16:41:29 web.1     | âœ… Admin password reset: admin@admin.com / admin123
16:41:29 web.1     | ğŸ”§ Starting database initialization...
16:41:29 web.1     | âœ… Business exists: ×©×™×©×™×©×™ (ID: 10)
16:41:29 web.1     | âœ… System admin user exists: admin@admin.com (ID: 8, role: system_admin, business_id: None)
16:41:29 web.1     | 
16:41:29 web.1     | ğŸ“Š Total users in database: 5
16:41:29 web.1     |   - User 3: manager@shai-realestate.co.il | role=agent | business_id=1
16:41:29 web.1     |   - User 2: business@shai-offices.co.il | role=owner | business_id=1
16:41:29 web.1     |   - User 7: admin@shai-realestate.co.il | role=admin | business_id=1
16:41:29 web.1     |   - User 9: freezeb123@gmail.com | role=owner | business_id=1
16:41:29 web.1     |   - User 8: admin@admin.com | role=system_admin | business_id=None
16:41:29 web.1     | âœ… Lead statuses exist: 7 statuses found
16:41:29 web.1     | âœ… FAQs table exists: 0 FAQs found across all businesses
16:41:29 web.1     | âœ… Business settings exist (slot_size: 60min, 24/7: False)
16:41:29 web.1     | ğŸ‘¥ Checking user ownership...
16:41:29 web.1     | ğŸ”„ Starting User-to-Owner migration...
16:41:29 web.1     | ğŸ“Š Found 2 businesses
16:41:29 web.1     | âš ï¸  Business '×©×™×©×™×©×™' (ID=10) has NO users
16:41:29 web.1     |    â†’ Admin must create owner via UI: /app/admin/businesses
16:41:29 web.1     | âœ… Business '×¤×¨×• ×¡××¡' (ID=1) already has owner: business@shai-offices.co.il
16:41:29 web.1     | 
16:41:29 web.1     | âœ… User-to-Owner migration completed!
16:41:29 web.1     | 
16:41:29 web.1     | âš ï¸  1 businesses need manual owner creation:
16:41:29 web.1     |    - ×©×™×©×™×©×™ (ID=10)
16:41:29 web.1     | 
16:41:29 web.1     |    â†’ Login as system_admin and use BusinessUsersModal to create owners
16:41:29 web.1     | âœ… User ownership check completed
16:41:29 web.1     | âœ… Database initialization completed successfully!
16:41:29 web.1     | ğŸ“§ Admin login: admin@admin.com / admin123
16:41:29 web.1     | ğŸ¢ Business ID: 10
16:41:29 web.1     | âœ… [BACKGROUND] DB initialized successfully
16:41:36 web.1     | ğŸ”§ LazyASGI: Creating Flask app on first request...
16:41:36 web.1     | âœ… LazyASGI: Flask app wrapped in ASGI
16:41:36 web.1     | INFO:     172.31.72.130:42872 - "GET / HTTP/1.1" 200 OK
16:41:36 web.1     | INFO:     172.31.72.130:42872 - "GET /assets/index-BWJ5VfoL.js HTTP/1.1" 200 OK
16:41:36 web.1     | INFO:     172.31.72.130:42884 - "GET /assets/index-0lRSZTt5.css HTTP/1.1" 200 OK
16:41:37 web.1     | INFO:     172.31.72.130:42872 - "GET /api/auth/csrf HTTP/1.1" 200 OK
16:41:37 web.1     | INFO:     172.31.72.130:42872 - "GET /favicon.ico HTTP/1.1" 200 OK
16:41:37 web.1     | INFO:     172.31.72.130:42872 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:41:37 web.1     | INFO:     172.31.72.130:42872 - "GET /api/auth/me HTTP/1.1" 401 Unauthorized
16:42:26 web.1     | [WA-SESSION] ğŸ“± Check #1: Found 0 stale sessions to process
16:44:37 web.1     | ğŸ” LOGIN ATTEMPT: email=freezeb123@gmail.com
16:44:37 web.1     | âœ“ Found user: id=9, email=freezeb123@gmail.com, role=owner
16:44:37 web.1     | âœ“ Password hash: scrypt:32768:8:1$orTTirCs2vzSHaPs$405d47e27c9f2abf...
16:44:37 web.1     | âœ“ Password verification result: True
16:44:38 web.1     | ğŸ” LOGIN SUCCESS: user_id=9, email=freezeb123@gmail.com, role=owner, business_id=1
16:44:38 web.1     | INFO:     172.31.72.130:35816 - "POST /api/auth/login HTTP/1.1" 200 OK
16:44:38 web.1     | INFO:     172.31.72.130:35816 - "GET /api/auth/csrf HTTP/1.1" 200 OK
16:44:38 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:38 web.1     | ğŸ”” /api/notifications - tenant_id=1, g.tenant=1
16:44:38 web.1     | ğŸ”” Querying reminders for tenant_id=1, is_system_admin=False
16:44:38 web.1     | ğŸ”” Found 0 reminders
16:44:38 web.1     | INFO:     172.31.72.130:35816 - "GET /api/notifications HTTP/1.1" 200 OK
16:44:38 web.1     | INFO:     172.31.72.130:35818 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:38 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:38 web.1     | INFO:     172.31.72.130:35818 - "GET /api/admin/businesses?pageSize=1 HTTP/1.1" 403 Forbidden
16:44:38 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:39 web.1     | INFO:     172.31.72.130:35818 - "GET /api/dashboard/stats HTTP/1.1" 200 OK
16:44:39 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:39 web.1     | INFO:     172.31.72.130:35816 - "GET /api/dashboard/activity HTTP/1.1" 200 OK
16:44:39 web.1     | INFO:     172.31.72.130:35832 - "GET /api/auth/csrf HTTP/1.1" 200 OK
16:44:39 web.1     | INFO:     172.31.72.130:35840 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:39 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:39 web.1     | INFO:     172.31.72.130:35816 - "GET /api/admin/businesses?pageSize=1 HTTP/1.1" 403 Forbidden
16:44:39 web.1     | CSRF-DBG cookie= None header= None ct= None
16:44:39 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:39 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:39 web.1     | INFO:     172.31.72.130:35816 - "GET /api/business/current/prompt HTTP/1.1" 200 OK
16:44:39 web.1     | INFO:     172.31.72.130:35818 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:39 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:39 web.1     | INFO:     172.31.72.130:35854 - "GET /api/whatsapp/status HTTP/1.1" 200 OK
16:44:39 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:40 web.1     | INFO:     172.31.72.130:35858 - "GET /api/crm/threads HTTP/1.1" 200 OK
16:44:40 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:40 web.1     | INFO:     172.31.72.130:35818 - "GET /api/whatsapp/provider-info HTTP/1.1" 200 OK
16:44:41 web.1     | INFO:     172.31.72.130:35858 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:41 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:42 web.1     | INFO:     172.31.72.130:35816 - "GET /api/calls?search=&status=all&direction=all&limit=50 HTTP/1.1" 200 OK
16:44:44 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:44 web.1     | INFO:     172.31.72.130:35816 - "GET /api/whatsapp/status HTTP/1.1" 200 OK
16:44:44 web.1     | INFO:     172.31.72.130:35858 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:44 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:45 web.1     | INFO:     172.31.72.130:35872 - "GET /api/crm/threads HTTP/1.1" 200 OK
16:44:45 web.1     | CSRF-DBG cookie= None header= None ct= None
16:44:45 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:45 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:45 web.1     | INFO:     172.31.72.130:35876 - "GET /api/business/current/prompt HTTP/1.1" 200 OK
16:44:45 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:45 web.1     | INFO:     172.31.72.130:35858 - "GET /api/whatsapp/provider-info HTTP/1.1" 200 OK
16:44:45 web.1     | INFO:     172.31.72.130:35816 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:45 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:45 web.1     | INFO:     172.31.72.130:35882 - "GET /api/statuses HTTP/1.1" 200 OK
16:44:45 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:46 web.1     | INFO:     172.31.72.130:35896 - "GET /api/leads HTTP/1.1" 200 OK
16:44:46 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:46 web.1     | INFO:     172.31.72.130:35876 - "GET /api/statuses HTTP/1.1" 200 OK
16:44:46 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:46 web.1     | INFO:     172.31.72.130:35896 - "GET /api/statuses HTTP/1.1" 200 OK
16:44:47 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:47 web.1     | INFO:     172.31.72.130:35896 - "GET /api/statuses HTTP/1.1" 200 OK
16:44:47 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:47 web.1     | INFO:     172.31.72.130:35896 - "GET /api/whatsapp/status HTTP/1.1" 200 OK
16:44:47 web.1     | INFO:     172.31.72.130:35872 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:47 web.1     | CSRF-DBG cookie= None header= None ct= None
16:44:47 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:47 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:47 web.1     | INFO:     172.31.72.130:35896 - "GET /api/business/current/prompt HTTP/1.1" 200 OK
16:44:47 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:48 web.1     | INFO:     172.31.72.130:36246 - "GET /api/crm/threads HTTP/1.1" 200 OK
16:44:48 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:48 web.1     | INFO:     172.31.72.130:35872 - "GET /api/whatsapp/provider-info HTTP/1.1" 200 OK
16:44:49 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:49 web.1     | INFO:     172.31.72.130:35896 - "GET /api/calls?search=&status=all&direction=all&limit=50 HTTP/1.1" 200 OK
16:44:49 web.1     | INFO:     172.31.72.130:36234 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:49 web.1     | INFO:     172.31.72.130:36234 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:49 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:50 web.1     | INFO:     172.31.72.130:35896 - "GET /api/reminders HTTP/1.1" 200 OK
16:44:50 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:50 web.1     | INFO:     172.31.72.130:36260 - "GET /api/leads HTTP/1.1" 200 OK
16:44:50 web.1     | INFO:     172.31.72.130:35896 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:50 web.1     | INFO:     172.31.72.130:36234 - "GET /api/auth/me HTTP/1.1" 200 OK
16:44:50 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:50 web.1     | INFO:     172.31.72.130:36234 - "GET /api/admin/users HTTP/1.1" 200 OK
16:44:52 web.1     | INFO:     172.31.72.130:36234 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:52 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:52 web.1     | INFO:     172.31.72.130:35896 - "GET /api/business/current HTTP/1.1" 200 OK
16:44:53 web.1     | INFO:     172.31.72.130:35896 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:53 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:53 web.1     | INFO:     172.31.72.130:35896 - "GET /api/calendar/appointments HTTP/1.1" 200 OK
16:44:54 web.1     | INFO:     172.31.72.130:35896 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:44:54 web.1     | INFO:     172.31.72.130:36234 - "GET /api/auth/me HTTP/1.1" 200 OK
16:44:55 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:44:55 web.1     | INFO:     172.31.72.130:36234 - "GET /api/admin/users HTTP/1.1" 200 OK
16:45:08 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:45:08 web.1     | ğŸ”” /api/notifications - tenant_id=1, g.tenant=1
16:45:08 web.1     | ğŸ”” Querying reminders for tenant_id=1, is_system_admin=False
16:45:08 web.1     | ğŸ”” Found 0 reminders
16:45:08 web.1     | INFO:     172.31.72.130:36234 - "GET /api/notifications HTTP/1.1" 200 OK
16:45:17 web.1     | CSRF-DBG cookie= None header= None ct= None
16:45:17 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:45:17 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:45:18 web.1     | INFO:     172.31.72.130:36234 - "GET /api/business/current/prompt HTTP/1.1" 200 OK
16:45:18 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:45:18 web.1     | INFO:     172.31.72.130:35896 - "GET /api/whatsapp/status HTTP/1.1" 200 OK
16:45:18 web.1     | INFO:     172.31.72.130:37764 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:45:18 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:45:18 web.1     | INFO:     172.31.72.130:37778 - "GET /api/crm/threads HTTP/1.1" 200 OK
16:45:18 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:45:18 web.1     | INFO:     172.31.72.130:35896 - "GET /api/whatsapp/provider-info HTTP/1.1" 200 OK
16:45:19 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:45:19 web.1     | INFO:     172.31.72.130:37778 - "GET /api/calls?search=&status=all&direction=all&limit=50 HTTP/1.1" 200 OK
16:45:19 web.1     | INFO:     172.31.72.130:36234 - "GET /favicon.ico HTTP/1.1" 304 Not Modified
16:45:34 web.1     | âš ï¸ DEV MODE: VALIDATE_TWILIO_SIGNATURE=false - signature validation skipped
16:45:34 web.1     | âœ… Resolved business_id=1 from to_number=+97233763805 (Business: ×¤×¨×• ×¡××¡)
16:45:34 web.1     | âœ… call_log created immediately for CAd6165e66be48fd9848e94fc1e825877a
16:45:34 web.1     | ğŸŸ¢ INCOMING_CALL - Starting thread to create lead for +972504294724, call_sid=CAd6165e66be48fd9848e94fc1e825877a
16:45:34 web.1     | ğŸ”µ CREATE_LEAD_FROM_CALL - Starting for +972504294724, call_sid=CAd6165e66be48fd9848e94fc1e825877ağŸŸ¢ INCOMING_CALL - Thread started successfully
16:45:34 web.1     | âœ… incoming_call: 233ms - CAd6165e66be48fd
16:45:34 web.1     | 
16:45:34 web.1     | ğŸ”¥ TWIML_HOST=f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.devğŸ”µ CREATE_LEAD_FROM_CALL - App context created
16:45:34 web.1     | 
16:45:34 web.1     | ğŸ”¥ TWIML_WS=wss://f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev/ws/twilio-media
16:45:34 web.1     | ğŸ”¥ TWIML_FULL=<?xml version="1.0" encoding="UTF-8"?><Response><Connect action="https://f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev/webhook/stream_ended"><Stream url="wss://f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev/ws/twilio-media"><Parameter name="CallSid" value="CAd6165e66be48fd9848e94fc1e825877a" /><Parameter name="To" value="+97233763805" /></Stream></Connect></Response>
16:45:34 web.1     | INFO:     172.31.72.130:36234 - "POST /webhook/incoming_call HTTP/1.1" 200 OK
16:45:34 web.1     | ğŸ“ WebSocket connection attempt: headers={'host': 'f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev', 'user-agent': 'Twilio.TmeWs/1.0', 'accept-encoding': 'gzip', 'connection': 'Upgrade', 'sec-websocket-key': 'gOL0aVqdJDxONqQFZtFisQ==', 'sec-websocket-version': '13', 'upgrade': 'websocket', 'x-forwarded-for': '44.222.211.67, 10.81.11.133', 'x-forwarded-proto': 'https', 'x-replit-user-bio': '', 'x-replit-user-id': '', 'x-replit-user-name': '', 'x-replit-user-profile-image': '', 'x-replit-user-roles': '', 'x-replit-user-teams': '', 'x-replit-user-url': '', 'x-twilio-signature': 'xN146EpEIFGvWAhoDyQbRWlGGQY='}
16:45:34 web.1     | INFO:     172.31.72.130:35286 - "WebSocket /ws/twilio-media" [accepted]
16:45:34 web.1     | âœ… WebSocket accepted with subprotocol: audio.twilio.com
16:45:34 web.1     | ğŸ“ WebSocket connected: /ws/twilio-media
16:45:35 web.1     | ================================================================================
16:45:35 web.1     | âš¡ BUILD 116 - SUB-2S RESPONSE OPTIMIZATION + REALTIME API
16:45:35 web.1     | ================================================================================
16:45:35 web.1     | [BOOT] DEBUG = True
16:45:35 web.1     | [BOOT] ğŸš€ USE_REALTIME_API = True (OpenAI Realtime for calls)
16:45:35 web.1     | [BOOT] ğŸ’° REALTIME_MODEL = gpt-4o-realtime-preview ($0.06-0.24/min (standard))
16:45:35 web.1     | [BOOT] USE_STREAMING_STT = True
16:45:35 web.1     | [BOOT] ENABLE_BARGE_IN = True (ğŸ¯ Smart barge-in with state tracking)
16:45:35 web.1     | [BOOT] GOOGLE_CLOUD_REGION = europe-west1
16:45:35 web.1     | [BOOT] GCP_STT_MODEL = default (ENHANCED=True enforced)
16:45:35 web.1     | [BOOT] GCP_STT_LANGUAGE = he-IL
16:45:35 web.1     | [BOOT] STT_BATCH_MS = 30
16:45:35 web.1     | [BOOT] STT_PARTIAL_DEBOUNCE_MS = 80 (ğŸ”¥ Ultra-fast)
16:45:35 web.1     | [BOOT] STT_TIMEOUT_MS = 300 (ğŸ”¥ Ultra-fast - was 400ms)
16:45:35 web.1     | [BOOT] VAD_HANGOVER_MS = 120
16:45:35 web.1     | ================================================================================
16:45:35 web.1     | ğŸš€ STT MODE: Real-time Streaming (Session-per-call)
16:45:35 web.1     | ğŸ§¹ [REAPER] Session cleanup thread started
16:45:35 web.1     | INFO:     connection open
16:45:35 web.1     | ğŸ”§ receive_loop started
16:45:35 web.1     | ğŸ”§ send_loop started
16:45:35 web.1     | ğŸ“¨ Received: connected
16:45:35 web.1     | ğŸ“¨ Received: start
16:45:35 web.1     | ğŸ”§ [HANDLER] Getting Flask app...âœ… MediaStreamHandler thread started
16:45:35 web.1     | 
16:45:35 web.1     | ğŸ”§ [HANDLER] Flask app ready
16:45:35 web.1     | ğŸ”§ Creating MediaStreamHandler...
16:45:35 web.1     | ğŸ¯ AI CONVERSATION STARTED
16:45:35 web.1     | ğŸ”§ Starting MediaStreamHandler.run()...
16:45:35 web.1     | âœ… Debug written to /tmp/ws_handler_debug_1764693935.txt
16:45:35 web.1     | âœ… Debug written to /tmp/websocket_debug.txt
16:45:35 web.1     | âœ… Debug written to /tmp/handler_called.txt
16:45:35 web.1     | âœ… Debug written to /home/runner/workspace/handler_debug.txt
16:45:35 web.1     | âœ… Debug written to /tmp/HANDLER_WORKS_1764693935.txt
16:45:35 web.1     | âœ… Debug files written: 5/5
16:45:35 web.1     | WS_START sid=None mode=AI call_sid=None
16:45:35 web.1     | ğŸ¯ CONVERSATION READY (VAD threshold: 65)
16:45:35 web.1     | ğŸ¯ [CALL DEBUG] MediaStreamHandler.run() entered main loop
16:45:35 web.1     | ğŸ¯ [CALL DEBUG] START EVENT RECEIVED! call_sid will be extracted...
16:45:35 web.1     | 
16:45:35 web.1     | ğŸ“ START EVENT (customParameters path):
16:45:35 web.1     |    customParams.From: None
16:45:35 web.1     |    customParams.CallFrom: None
16:45:35 web.1     |    âœ… self.phone_number set to: 'None'
16:45:35 web.1     |    âœ… self.to_number set to: '+97233763805'
16:45:35 web.1     | ğŸ¯ [T0=1764693935.156] WS_START sid=MZea9b3bd9e7bd447aff20b6a9e38c67db call_sid=CAd6165e66be48fd9848e94fc1e825877a from=None to=+97233763805 mode=AI
16:45:35 web.1     | ğŸš€ [PARALLEL] Starting OpenAI at T0+0ms (BEFORE DB query!)
16:45:35 web.1     | ğŸš€ [REALTIME] Thread started for call CAd6165e (FRESH SESSION)
16:45:35 web.1     | âš¡ ULTRA-FAST: ×–×™×”×•×™ ×¢×¡×§ + ×‘×¨×›×” + ×”×’×“×¨×•×ª ×‘×©××™×œ×ª×” ××—×ª: to_number=+97233763805
16:45:35 web.1     | ğŸ“¤ [REALTIME] Audio output bridge started
16:45:35 web.1     | ğŸš€ [REALTIME] Async loop starting - connecting to OpenAI IMMEDIATELY
16:45:35 web.1     | â±ï¸ [PARALLEL] Client created in 0ms
16:45:35 web.1     | ğŸ”Œ [CALL DEBUG] Connecting to OpenAI: model=gpt-4o-realtime-preview, api_key_present=True
16:45:35 web.1     | âœ… ××¦× ×¢×¡×§: ×¤×¨×• ×¡××¡ (id=1)
16:45:35 web.1     | âš¡ COMBINED QUERY: biz+greeting+settings in 198ms
16:45:35 web.1     |    bot_speaks_first=True, auto_end_goodbye=True
16:45:35 web.1     | ğŸ” [SETTINGS LOADED] required_lead_fields=['name', 'service_type', 'city']
16:45:35 web.1     | ğŸ” [SETTINGS LOADED] smart_hangup_enabled=True
16:45:35 web.1     | ğŸ” [SETTINGS LOADED] _call_settings_loaded=True (prevents duplicate load)
16:45:35 web.1     | âš¡ DB QUERY: business_id=1 in 220ms
16:45:35 web.1     | ğŸ”§ DB_URL_AT_WRITE: driver=postgresql, BIZ=1, SID=CAd6165e66be48fd9848e94fc1e825877aâœ… CustomerIntelligence SUCCESS: customer_id=8, lead_id=86, was_created=False
16:45:35 web.1     | 
16:45:35 web.1     | ğŸ”Š TX_LOOP_START: Audio transmission thread startedğŸ¯ [T1=1764693935.390] STORING GREETING FOR REALTIME!
16:45:35 web.1     | âœ… [REALTIME] Greeting stored: '×©×œ×•× ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×˜×œ×™×ª ×©×œ ×§×œ×™×‘×¨, ×‘××™×–×” ×ª×—×•× ×ª×¨×¦×”...' (len=56)
16:45:35 web.1     | ğŸš€ [PARALLEL] Signaling business info ready at T0+234ms
16:45:35 web.1     | 
16:45:35 web.1     | â±ï¸ [PARALLEL] OpenAI connected in 294ms (T0+308ms)
16:45:35 web.1     | âœ… [REALTIME] Connected to OpenAI using gpt-4o-realtime-preview (STANDARD)
16:45:35 web.1     | â³ [PARALLEL] Waiting for business info from DB query...
16:45:35 web.1     | âœ… [PARALLEL] Business info ready! Wait time: 0ms
16:45:35 web.1     | â±ï¸ [PARALLEL] Using greeting: '×©×œ×•× ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×˜×œ×™×ª ×©×œ ×§×œ×™×‘×¨, ×‘××™×–×” ×ª×—×•× ×ª×¨×¦×”...'
16:45:35 web.1     | ğŸ¤ [VOICE] Using voice=shimmer for entire call (business=1)
16:45:35 web.1     | ğŸ¤ [GREETING] max_tokens=200 for greeting length=56 chars
16:45:35 web.1     | â±ï¸ [PHASE 1] Session configured in 1ms (total: 296ms)
16:45:35 web.1     | âœ… [REALTIME] FAST CONFIG: greeting prompt ready, voice=shimmer
16:45:35 web.1     | ğŸ¤ [GREETING] Bot speaks first - triggering greeting at 1764693935.465
16:45:35 web.1     | âœ… [BUILD 163] response.create sent! OpenAI=296ms, T0â†’speak=310ms
16:45:35 web.1     | âš ï¸ [CRM] No customer phone - skipping lead creation
16:45:35 web.1     | ğŸ“¤ [REALTIME] Audio sender started
16:45:35 web.1     | ğŸ“¥ [REALTIME] Audio receiver started
16:45:35 web.1     | ğŸ“ [REALTIME] Text sender started
16:45:35 web.1     | [REALTIME] sending audio TO OpenAI: chunk#1, Î¼-law bytes=160, first5=65 6f f8 fc 6e, rms=558
16:45:35 web.1     | ğŸ™ï¸ REAL_VOICE: rms=558.0 > threshold=200.0
16:45:35 web.1     | [REALTIME] sending audio TO OpenAI: chunk#2, Î¼-law bytes=160, first5=c6 da 64 48 3c, rms=2158
16:45:35 web.1     | [REALTIME] event: response.created
16:45:35 web.1     | ğŸ¯ [REALTIME] Response started: resp_CiNnLFHRLmc09SOGV6ncH
16:45:35 web.1     | [REALTIME] sending audio TO OpenAI: chunk#3, Î¼-law bytes=160, first5=bc be c1 c7 cd, rms=1831
16:45:35 web.1     | âœ… Call log already exists for CAd6165e66be48fd9848e94fc1e825877a
16:45:35 web.1     | âœ… Updated call_log with customer_id=8
16:45:35 web.1     | ğŸ“ [PROMPT] Final length: 2625 chars
16:45:35 web.1     | [REALTIME] event: input_audio_buffer.speech_started
16:45:35 web.1     | ğŸ›¡ï¸ [PROTECT GREETING] Ignoring speech_started - greeting still playing
16:45:35 web.1     | â³ [PHASE 2] Waiting for greeting to finish before session.update...
16:45:35 web.1     | [REALTIME] event: response.done
16:45:36 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=644, voice_frames=0
16:45:36 web.1     | âœ… Recording started for CAd6165e66be48fd9848e94fc1e825877a: REb2717c6aab62d887a3a9f0e48cbbf617
16:45:36 web.1     | ğŸ›ï¸ VAD CALIBRATED (noise=21.0, threshold=121.0)
16:45:37 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=15, voice_frames=0
16:45:37 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 100 noise frames (rms=15)
16:45:38 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=9034, voice_frames=0
16:45:39 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=11, voice_frames=0
16:45:40 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=16, voice_frames=0
16:45:40 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 200 noise frames (rms=91)
16:45:40 web.1     | ğŸ¤ END OF UTTERANCE: 1.3s audio, conversation #0
16:45:40 web.1     | ğŸ§  STATE -> PROCESSING | len=21440 | silence_ms=2040
16:45:40 web.1     | â­ï¸ [REALTIME] Skipping Google STT/TTS - using Realtime API only
16:45:40 web.1     | âœ… Processing complete for conversation #0
16:45:40 web.1     | ğŸ™ï¸ REAL_VOICE: rms=270.0 > threshold=121.0
16:45:41 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=162, voice_frames=0
16:45:41 web.1     | ğŸ¤ END OF UTTERANCE: 0.6s audio, conversation #1
16:45:41 web.1     | ğŸ§  STATE -> PROCESSING | len=9600 | silence_ms=580
16:45:41 web.1     | â­ï¸ [REALTIME] Skipping Google STT/TTS - using Realtime API only
16:45:41 web.1     | âœ… Processing complete for conversation #1
16:45:42 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=44, voice_frames=0
16:45:42 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:45:42 web.1     | ğŸ”” /api/notifications - tenant_id=1, g.tenant=1
16:45:42 web.1     | ğŸ”” Querying reminders for tenant_id=1, is_system_admin=False
16:45:43 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=15, voice_frames=0
16:45:43 web.1     | ğŸ”” Found 0 reminders
16:45:43 web.1     | INFO:     172.31.72.130:36234 - "GET /api/notifications HTTP/1.1" 200 OK
16:45:43 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 300 noise frames (rms=13)
16:45:43 web.1     | ğŸ™ï¸ REAL_VOICE: rms=149.0 > threshold=121.0
16:45:44 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=517, voice_frames=0
16:45:44 web.1     | [REALTIME] event: input_audio_buffer.speech_stopped
16:45:44 web.1     | [REALTIME] event: input_audio_buffer.committed
16:45:44 web.1     | [REALTIME] event: conversation.item.created
16:45:44 web.1     | [REALTIME] event: response.created
16:45:44 web.1     | ğŸ¯ [REALTIME] Response started: resp_CiNnUYzm8Bq3tFgB0LapA
16:45:45 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=46, voice_frames=0
16:45:45 web.1     | ğŸ’“ WS_KEEPALIVE #1 (prevents 5min timeout)
16:45:45 web.1     | ğŸ“¨ Received: mark
16:45:45 web.1     | [REALTIME] event: response.output_item.added
16:45:45 web.1     | [REALTIME] event: conversation.item.created
16:45:45 web.1     | [REALTIME] event: response.content_part.added
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | âœ… [AUDIO] Frame #1: 160 bytes, first5=fe fe ff ff 7d, buffer=640
16:45:45 web.1     | âœ… [AUDIO] Frame #2: 160 bytes, first5=58 dd 6c 5a d5, buffer=480
16:45:45 web.1     | âœ… [AUDIO] Frame #3: 160 bytes, first5=cd 5f 5f d0 4b, buffer=320
16:45:45 web.1     | [TX_LOOP] Frame 0: type=None, event=media, has_media=True
16:45:45 web.1     | [TX_LOOP] Sent Realtime format: success=True
16:45:45 web.1     | [TX_LOOP] Frame 1: type=None, event=media, has_media=True
16:45:45 web.1     | [TX_LOOP] Sent Realtime format: success=True
16:45:45 web.1     | [TX_LOOP] Frame 2: type=None, event=media, has_media=True
16:45:45 web.1     | [TX_LOOP] Sent Realtime format: success=True
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | ğŸ“¦ [AUDIO] OpenAI chunk #2: 1200 bytes â†’ splitting into 7 frames
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | ğŸ“¦ [AUDIO] OpenAI chunk #3: 2000 bytes â†’ splitting into 12 frames
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 400 noise frames (rms=13)
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | ğŸ“¨ Received: stop
16:45:45 web.1     | WS_STOP sid=MZea9b3bd9e7bd447aff20b6a9e38c67db rx=540 tx=30
16:45:45 web.1     | ğŸ“¤ [REALTIME] Audio sender ended
16:45:45 web.1     | ğŸ“ [REALTIME] Text sender ended
16:45:45 web.1     | ğŸ§¹ Waiting for 5 background threads...
16:45:45 web.1     | ğŸ“¤ [REALTIME] Stop signal received
16:45:45 web.1     | ğŸ“¤ [REALTIME] Audio output bridge ended (sent 112 frames, 18000 bytes)
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:45 web.1     | âš ï¸ DEV MODE: VALIDATE_TWILIO_SIGNATURE=false - signature validation skipped
16:45:45 web.1     | STREAM_ENDED call=CAd6165e66be48fd9848e94fc1e825877a stream=N/A status=N/A
16:45:45 web.1     | INFO:     172.31.72.130:36234 - "POST /webhook/stream_ended HTTP/1.1" 204 No Content
16:45:45 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:46 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:46 web.1     | âš ï¸ DEV MODE: VALIDATE_TWILIO_SIGNATURE=false - signature validation skipped
16:45:46 web.1     | INFO:     172.31.72.130:36234 - "POST /webhook/call_status HTTP/1.1" 204 No Content
16:45:46 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:46 web.1     | âœ… Found existing recording for CAd6165e66be48fd9848e94fc1e825877a: /2010-04-01/Accounts/ACcd09431f076a309088b18ed1f286f32e/Recordings/REb2717c6aab62d887a3a9f0e48cbbf617.json
16:45:46 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:46 web.1     | âœ… CALL FINALIZED: CAd6165e66be48fd9848e94fc1e825877a
16:45:46 web.1     | ğŸ“ Summary: ×©×™×—×” ×§×¦×¨×”
16:45:46 web.1     | ğŸ¯ Intent: general_inquiry
16:45:46 web.1     | ğŸ“Š Next Action: ××¢×§×‘ ×ª×•×š 24 ×©×¢×•×ª
16:45:46 web.1     | â„¹ï¸ Appointment handling: Managed by Agent during call (BUILD 119)
16:45:46 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:46 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:46 web.1     | [REALTIME] event: response.audio.done
16:45:46 web.1     | ğŸ¤ [GREETING] Greeting finished at 1764693946.256 (duration: 10790ms)
16:45:46 web.1     | âœ… [GREETING] Barge-in now ENABLED for rest of call
16:45:46 web.1     | ğŸ›¡ï¸ [PROTECTION] Greeting completed - hangup blocked for 3000ms
16:45:46 web.1     | ğŸ”‡ [REALTIME] AI stopped speaking (response.audio.done)
16:45:46 web.1     | â³ [AUDIO] 8 frames still in queue - letting them play (NO TRUNCATION)
16:45:46 web.1     | [REALTIME] event: response.audio_transcript.done
16:45:46 web.1     | ğŸ¤– [REALTIME] AI said: ×©×œ×•×, ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×™×˜×œ×™×ª ×©×œ ×§×œ×™×‘×¨. ×‘××™×–×” ×ª×—×•× ×ª×¨×¦×” ×¢×–×¨×”?
16:45:46 web.1     | âœ… [LEAD STATE] Updated: service_type=×ª×¨×¦×” ×¢×–×¨×”
16:45:46 web.1     | ğŸ“‹ [LEAD STATE] Current state: {'service_type': '×ª×¨×¦×” ×¢×–×¨×”'}
16:45:46 web.1     | ğŸ›¡ï¸ [PROTECTION] Ignoring AI goodbye - only 0ms since greeting
16:45:46 web.1     | [GOODBYE CHECK] No goodbye phrase: '×©×œ×•×, ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×™×˜×œ×™×ª ×©×œ ...'
16:45:46 web.1     | [REALTIME] event: response.content_part.done
16:45:46 web.1     | [REALTIME] event: response.output_item.done
16:45:46 web.1     | â³ [AUDIO] 8 frames still in queue - letting them play (NO TRUNCATION)
16:45:46 web.1     | [REALTIME] event: response.done
16:45:46 web.1     | [REALTIME] event: rate_limits.updated
16:45:46 web.1     | âœ… Recording queued for processing: CAd6165e66be48fd9848e94fc1e825877a
16:45:46 web.1     | âœ… [PHASE 2] Greeting finished after 10.6s - now updating session
16:45:46 web.1     | âœ… [PHASE 2] Session updated with full prompt: 2625 chars, voice=shimmer locked
16:45:46 web.1     | âŒ Receive error: (<CloseCode.NO_STATUS_RCVD: 1005>, '')
16:45:46 web.1     | ğŸ”§ receive_loop ended
16:45:46 web.1     | INFO:     connection closed
16:45:46 web.1     | ğŸ”§ send_loop ended
16:45:47 web.1     | [REALTIME] event: conversation.item.input_audio_transcription.completed
16:45:47 web.1     | ğŸ’° [COST] User utterance: 11.77s (135 chunks total)
16:45:47 web.1     | ğŸ‘¤ [REALTIME] User said: Åimdi gÃ¶rÃ¼ÅŸmek Ã¼zere, selam.
16:45:47 web.1     | ğŸ” [DEBUG] Calling NLP after user transcript: 'Åimdi gÃ¶rÃ¼ÅŸmek Ã¼zere, selam....'
16:45:47 web.1     | ğŸ” [DEBUG] _check_appointment_confirmation called with transcript: 'Åimdi gÃ¶rÃ¼ÅŸmek Ã¼zere, selam....'
16:45:47 web.1     | ğŸ” [DEBUG] Conversation history length: 2
16:45:47 web.1     | ğŸ” [DEBUG] User messages for hash: ['Åimdi gÃ¶rÃ¼ÅŸmek Ã¼zere, selam.']
16:45:47 web.1     | ğŸ” [DEBUG] Current conversation hash: 2d4359f9...
16:45:47 web.1     | ğŸ” [DEBUG] First NLP run - processing
16:45:47 web.1     | ğŸ” [NLP] âœ… WILL PROCESS new conversation state (hash=2d4359f9...)
16:45:47 web.1     | ğŸ” [DEBUG] CRM context exists: False
16:45:47 web.1     | ğŸš€ [NLP] Launching NLP thread...
16:45:47 web.1     | âœ… [NLP] Thread launched
16:45:47 web.1     | ğŸ” [NLP] Running async NLP parser...ğŸ›¡ï¸ [PROTECTION] Ignoring user goodbye - only 1029ms since greeting
16:45:47 web.1     | ğŸ” [NLP] â–¶ï¸ Analyzing conversation for appointment intent...
16:45:47 web.1     | ğŸ” [NLP] Conversation history has 2 messages
16:45:47 web.1     | ğŸ” [NLP] Last 3 messages: [{'speaker': 'ai', 'text': '×©×œ×•×, ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×™×˜×œ×™×ª ×©×œ ×§×œ×™×‘×¨. ×‘××™×–×” ×ª×—×•× ×ª×¨×¦×” ×¢×–×¨×”?', 'ts': 1764693946.2557354}, {'speaker': 'user', 'text': 'Åimdi gÃ¶rÃ¼ÅŸmek Ã¼zere, selam.', 'ts': 1764693947.2842543}]
16:45:47 web.1     | ğŸ” [NLP ENTRY] extract_appointment_request called
16:45:47 web.1     | ğŸ” [NLP ENTRY] business_id=1, history_length=2
16:45:47 web.1     | ğŸ” [NLP] Formatted 2 messages for GPT-4o-mini
16:45:47 web.1     | ğŸ” [NLP] Conversation text: × ×¦×™×’: ×©×œ×•×, ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×™×˜×œ×™×ª ×©×œ ×§×œ×™×‘×¨. ×‘××™×–×” ×ª×—×•× ×ª×¨×¦×” ×¢×–×¨×”?
16:45:47 web.1     | ×œ×§×•×—: Åimdi gÃ¶rÃ¼ÅŸmek Ã¼zere, selam....
16:45:47 web.1     | ğŸ” [NLP] Calling GPT-4o-mini with model=gpt-4o-mini, temperature=0.1
16:45:47 web.1     | 
16:45:47 web.1     | ğŸ” [DEBUG] _check_lead_captured: required_fields from self = ['name', 'service_type', 'city']
16:45:47 web.1     | â³ [SMART HANGUP] Still missing fields: ['name', 'city'] | Collected: ['service_type=×ª×¨×¦×” ×¢×–×¨×”']
16:45:47 web.1     | [SAFETY] Transcription successful (total failures: 0)
16:45:47 web.1     | âš ï¸ DEV MODE: VALIDATE_TWILIO_SIGNATURE=false - signature validation skipped
16:45:47 web.1     | âœ… Resolved business_id=1 from to_number=+97233763805 (Business: ×¤×¨×• ×¡××¡)
16:45:47 web.1     | âœ… call_log created immediately for CAc34f08c1c97e8ddbbac6918d8f9cf3fa
16:45:47 web.1     | ğŸŸ¢ INCOMING_CALL - Starting thread to create lead for +972504294724, call_sid=CAc34f08c1c97e8ddbbac6918d8f9cf3fa
16:45:47 web.1     | ğŸ”µ CREATE_LEAD_FROM_CALL - Starting for +972504294724, call_sid=CAc34f08c1c97e8ddbbac6918d8f9cf3fa
16:45:47 web.1     | ğŸ”µ CREATE_LEAD_FROM_CALL - App context createdğŸŸ¢ INCOMING_CALL - Thread started successfully
16:45:47 web.1     | 
16:45:47 web.1     | âœ… incoming_call: 346ms - CAc34f08c1c97e8d
16:45:47 web.1     | ğŸ”¥ TWIML_HOST=f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev
16:45:47 web.1     | ğŸ”¥ TWIML_WS=wss://f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev/ws/twilio-media
16:45:47 web.1     | ğŸ”¥ TWIML_FULL=<?xml version="1.0" encoding="UTF-8"?><Response><Connect action="https://f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev/webhook/stream_ended"><Stream url="wss://f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev/ws/twilio-media"><Parameter name="CallSid" value="CAc34f08c1c97e8ddbbac6918d8f9cf3fa" /><Parameter name="To" value="+97233763805" /></Stream></Connect></Response>
16:45:47 web.1     | INFO:     172.31.72.130:36234 - "POST /webhook/incoming_call HTTP/1.1" 200 OK
16:45:47 web.1     | ğŸ“ WebSocket connection attempt: headers={'host': 'f6bc9e3d-e344-4c65-83e9-6679c9c65e69-00-30jsasmqh67fq.picard.replit.dev', 'user-agent': 'Twilio.TmeWs/1.0', 'accept-encoding': 'gzip', 'connection': 'Upgrade', 'sec-websocket-key': 'BkgLsIkFVS1rAxeAx+tF/Q==', 'sec-websocket-version': '13', 'upgrade': 'websocket', 'x-forwarded-for': '3.83.117.201, 10.81.6.216', 'x-forwarded-proto': 'https', 'x-replit-user-bio': '', 'x-replit-user-id': '', 'x-replit-user-name': '', 'x-replit-user-profile-image': '', 'x-replit-user-roles': '', 'x-replit-user-teams': '', 'x-replit-user-url': '', 'x-twilio-signature': 'xN146EpEIFGvWAhoDyQbRWlGGQY='}
16:45:47 web.1     | INFO:     172.31.72.130:39586 - "WebSocket /ws/twilio-media" [accepted]
16:45:47 web.1     | âœ… WebSocket accepted with subprotocol: audio.twilio.com
16:45:47 web.1     | ğŸ“ WebSocket connected: /ws/twilio-media
16:45:47 web.1     | INFO:     connection open
16:45:47 web.1     | ğŸ”§ receive_loop started
16:45:47 web.1     | ğŸ”§ send_loop started
16:45:47 web.1     | ğŸ“¨ Received: connected
16:45:47 web.1     | ğŸ“¨ Received: start
16:45:47 web.1     | ğŸ”§ [HANDLER] Getting Flask app...âœ… MediaStreamHandler thread started
16:45:47 web.1     | 
16:45:47 web.1     | ğŸ”§ [HANDLER] Flask app ready
16:45:47 web.1     | ğŸ”§ Creating MediaStreamHandler...
16:45:47 web.1     | ğŸ¯ AI CONVERSATION STARTED
16:45:47 web.1     | ğŸ”§ Starting MediaStreamHandler.run()...
16:45:47 web.1     | âœ… Debug written to /tmp/ws_handler_debug_1764693947.txt
16:45:47 web.1     | âœ… Debug written to /tmp/websocket_debug.txt
16:45:47 web.1     | âœ… Debug written to /tmp/handler_called.txt
16:45:47 web.1     | âœ… Debug written to /home/runner/workspace/handler_debug.txt
16:45:47 web.1     | âœ… Debug written to /tmp/HANDLER_WORKS_1764693947.txt
16:45:47 web.1     | âœ… Debug files written: 5/5
16:45:47 web.1     | WS_START sid=None mode=AI call_sid=None
16:45:47 web.1     | ğŸ¯ CONVERSATION READY (VAD threshold: 65)
16:45:47 web.1     | ğŸ¯ [CALL DEBUG] MediaStreamHandler.run() entered main loop
16:45:47 web.1     | ğŸ¯ [CALL DEBUG] START EVENT RECEIVED! call_sid will be extracted...
16:45:47 web.1     | 
16:45:47 web.1     | ğŸ“ START EVENT (customParameters path):
16:45:47 web.1     |    customParams.From: None
16:45:47 web.1     |    customParams.CallFrom: None
16:45:47 web.1     |    âœ… self.phone_number set to: 'None'
16:45:47 web.1     |    âœ… self.to_number set to: '+97233763805'
16:45:47 web.1     | ğŸ¯ [T0=1764693947.945] WS_START sid=MZcf07f1e9f174fbd3a2099bee2ee81d3c call_sid=CAc34f08c1c97e8ddbbac6918d8f9cf3fa from=None to=+97233763805 mode=AI
16:45:47 web.1     | ğŸš€ [PARALLEL] Starting OpenAI at T0+0ms (BEFORE DB query!)
16:45:47 web.1     | ğŸš€ [REALTIME] Thread started for call CAc34f08 (FRESH SESSION)
16:45:47 web.1     | ğŸ“¤ [REALTIME] Audio output bridge started
16:45:47 web.1     | âš¡ ULTRA-FAST: ×–×™×”×•×™ ×¢×¡×§ + ×‘×¨×›×” + ×”×’×“×¨×•×ª ×‘×©××™×œ×ª×” ××—×ª: to_number=+97233763805ğŸš€ [REALTIME] Async loop starting - connecting to OpenAI IMMEDIATELY
16:45:47 web.1     | â±ï¸ [PARALLEL] Client created in 0ms
16:45:47 web.1     | ğŸ”Œ [CALL DEBUG] Connecting to OpenAI: model=gpt-4o-realtime-preview, api_key_present=True
16:45:47 web.1     | 
16:45:48 web.1     | âœ… ××¦× ×¢×¡×§: ×¤×¨×• ×¡××¡ (id=1)
16:45:48 web.1     | âš¡ COMBINED QUERY: biz+greeting+settings in 193ms
16:45:48 web.1     |    bot_speaks_first=True, auto_end_goodbye=True
16:45:48 web.1     | ğŸ” [SETTINGS LOADED] required_lead_fields=['name', 'service_type', 'city']
16:45:48 web.1     | ğŸ” [SETTINGS LOADED] smart_hangup_enabled=True
16:45:48 web.1     | ğŸ” [SETTINGS LOADED] _call_settings_loaded=True (prevents duplicate load)
16:45:48 web.1     | âš¡ DB QUERY: business_id=1 in 213ms
16:45:48 web.1     | ğŸ”§ DB_URL_AT_WRITE: driver=postgresql, BIZ=1, SID=CAc34f08c1c97e8ddbbac6918d8f9cf3fağŸ”Š TX_LOOP_START: Audio transmission thread started
16:45:48 web.1     | 
16:45:48 web.1     | ğŸ¯ [T1=1764693948.160] STORING GREETING FOR REALTIME!
16:45:48 web.1     | âœ… [REALTIME] Greeting stored: '×©×œ×•× ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×˜×œ×™×ª ×©×œ ×§×œ×™×‘×¨, ×‘××™×–×” ×ª×—×•× ×ª×¨×¦×”...' (len=56)
16:45:48 web.1     | ğŸš€ [PARALLEL] Signaling business info ready at T0+215ms
16:45:48 web.1     | âœ… CustomerIntelligence SUCCESS: customer_id=8, lead_id=86, was_created=False
16:45:48 web.1     | â±ï¸ [PARALLEL] OpenAI connected in 273ms (T0+275ms)
16:45:48 web.1     | âœ… [REALTIME] Connected to OpenAI using gpt-4o-realtime-preview (STANDARD)
16:45:48 web.1     | â³ [PARALLEL] Waiting for business info from DB query...
16:45:48 web.1     | âœ… [PARALLEL] Business info ready! Wait time: 0ms
16:45:48 web.1     | â±ï¸ [PARALLEL] Using greeting: '×©×œ×•× ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×˜×œ×™×ª ×©×œ ×§×œ×™×‘×¨, ×‘××™×–×” ×ª×—×•× ×ª×¨×¦×”...'
16:45:48 web.1     | ğŸ¤ [VOICE] Using voice=shimmer for entire call (business=1)
16:45:48 web.1     | ğŸ¤ [GREETING] max_tokens=200 for greeting length=56 chars
16:45:48 web.1     | â±ï¸ [PHASE 1] Session configured in 0ms (total: 274ms)
16:45:48 web.1     | âœ… [REALTIME] FAST CONFIG: greeting prompt ready, voice=shimmer
16:45:48 web.1     | ğŸ¤ [GREETING] Bot speaks first - triggering greeting at 1764693948.220
16:45:48 web.1     | âœ… [BUILD 163] response.create sent! OpenAI=274ms, T0â†’speak=276ms
16:45:48 web.1     | âš ï¸ [CRM] No customer phone - skipping lead creation
16:45:48 web.1     | ğŸ“¤ [REALTIME] Audio sender started
16:45:48 web.1     | ğŸ“¥ [REALTIME] Audio receiver started
16:45:48 web.1     | ğŸ“ [REALTIME] Text sender started
16:45:48 web.1     | [REALTIME] event: response.created
16:45:48 web.1     | ğŸ¯ [REALTIME] Response started: resp_CiNnYKOhrnI21NahbAzr4
16:45:48 web.1     | âœ… Call log already exists for CAc34f08c1c97e8ddbbac6918d8f9cf3fa
16:45:48 web.1     | âœ… Updated call_log with customer_id=8
16:45:48 web.1     | ğŸ“ [PROMPT] Final length: 2625 chars
16:45:48 web.1     | â³ [PHASE 2] Waiting for greeting to finish before session.update...
16:45:48 web.1     | [REALTIME] event: response.output_item.added
16:45:48 web.1     | [REALTIME] event: conversation.item.created
16:45:48 web.1     | [REALTIME] event: response.content_part.added
16:45:48 web.1     | [REALTIME] sending audio TO OpenAI: chunk#1, Î¼-law bytes=160, first5=fe fc fe 7e fe, rms=135
16:45:48 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:48 web.1     | âœ… [AUDIO] Frame #1: 160 bytes, first5=7e 7d 7d 7d 7d, buffer=640
16:45:48 web.1     | âœ… [AUDIO] Frame #2: 160 bytes, first5=54 d7 65 61 d2, buffer=480
16:45:48 web.1     | âœ… [AUDIO] Frame #3: 160 bytes, first5=bd 4b 69 c7 3c, buffer=320
16:45:48 web.1     | [TX_LOOP] Frame 0: type=None, event=media, has_media=True
16:45:48 web.1     | [TX_LOOP] Sent Realtime format: success=True
16:45:48 web.1     | [TX_LOOP] Frame 1: type=None, event=media, has_media=True
16:45:48 web.1     | [TX_LOOP] Sent Realtime format: success=True
16:45:48 web.1     | [TX_LOOP] Frame 2: type=None, event=media, has_media=True
16:45:48 web.1     | [TX_LOOP] Sent Realtime format: success=True
16:45:48 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:48 web.1     | ğŸ“¦ [AUDIO] OpenAI chunk #2: 1200 bytes â†’ splitting into 7 frames
16:45:48 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:48 web.1     | ğŸ“¦ [AUDIO] OpenAI chunk #3: 2000 bytes â†’ splitting into 12 frames
16:45:48 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:48 web.1     | ğŸ›ï¸ VAD CALIBRATED (noise=18.2, threshold=118.2)
16:45:48 web.1     | 
16:45:48 web.1     | ============================================================
16:45:48 web.1     | ğŸ” [NLP RESULT] GPT-4o-mini extraction complete
16:45:48 web.1     | ============================================================
16:45:48 web.1     | ğŸ“„ [NLP RESULT] Raw response: {"action":"none","date":null,"time":null,"name":null,"confidence":0.0}
16:45:48 web.1     | ğŸ“Š [NLP RESULT] Parsed values:
16:45:48 web.1     | ğŸ“Š [NLP RESULT]   - action: none
16:45:48 web.1     | ğŸ“Š [NLP RESULT]   - date: None
16:45:48 web.1     | ğŸ“Š [NLP RESULT]   - time: None
16:45:48 web.1     | ğŸ“Š [NLP RESULT]   - name: None
16:45:48 web.1     | ğŸ“Š [NLP RESULT]   - confidence: 0.0
16:45:48 web.1     | ============================================================
16:45:48 web.1     | 
16:45:48 web.1     | ğŸ” [NLP] â—€ï¸ NLP result: {'action': 'none', 'date': None, 'time': None, 'name': None, 'confidence': 0.0}
16:45:48 web.1     | ğŸ“­ [NLP] No appointment action detected (action=none)
16:45:48 web.1     | âœ… [NLP] Async NLP parser completed successfully
16:45:48 web.1     | âœ… [NLP] Cache updated after successful processing
16:45:48 web.1     | ğŸ”“ [NLP] Cleared nlp_is_processing flag
16:45:48 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:48 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)ğŸ” [BARGE-IN DEBUG] is_ai_speaking=True, user_has_spoken=False, waiting_for_dtmf=False, rms=13, voice_frames=0
16:45:48 web.1     | 
16:45:48 web.1     | âš ï¸ Background thread 0 still running after timeout
16:45:48 web.1     | âœ… All background threads cleanup complete
16:45:48 web.1     | 
16:45:48 web.1     | ================================================================================
16:45:48 web.1     | ğŸ’°ğŸ’°ğŸ’° [CALL COST SUMMARY] ğŸ’°ğŸ’°ğŸ’°
16:45:48 web.1     | ================================================================================
16:45:48 web.1     | ğŸ“ Model: gpt-4o-realtime-preview
16:45:48 web.1     | â±ï¸  Total duration: 13.8s (0.2 min)
16:45:48 web.1     | ğŸ™ï¸  Audio IN (user speaking): 135 chunks (0.045 min)
16:45:48 web.1     |    â””â”€ Cost: 0.045 min Ã— $0.06/min = $0.0027
16:45:48 web.1     | ğŸ”Š Audio OUT (AI speaking): 0 chunks (0.000 min)
16:45:48 web.1     |    â””â”€ Cost: 0.000 min Ã— $0.24/min = $0.0000
16:45:48 web.1     | â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
16:45:48 web.1     | ğŸ’µ TOTAL COST: $0.0027 (â‰ˆ â‚ª0.01)
16:45:48 web.1     | ================================================================================
16:45:48 web.1     | 
16:45:48 web.1     | WS_DONE sid=MZea9b3bd9e7bd447aff20b6a9e38c67db rx=540 tx=30
16:45:48 web.1     | âœ… MediaStreamHandler completed
16:45:48 web.1     | âœ… Handler thread join completed
16:45:48 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:48 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:48 web.1     | âœ… Recording started for CAc34f08c1c97e8ddbbac6918d8f9cf3fa: REeacc6acd3dab79e6eb068c29ed97d440
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [REALTIME] sending audio TO OpenAI: chunk#2, Î¼-law bytes=160, first5=7e 7e 7e 7c 7e, rms=123
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [REALTIME] sending audio TO OpenAI: chunk#3, Î¼-law bytes=160, first5=ce 4b d1 65 68, rms=191
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [GREETING] Passing greeting audio to caller (greeting_sent=True, user_has_spoken=False)
16:45:49 web.1     | [REALTIME] event: response.audio.done
16:45:49 web.1     | ğŸ¤ [GREETING] Greeting finished at 1764693949.677 (duration: 1457ms)
16:45:49 web.1     | âœ… [GREETING] Barge-in now ENABLED for rest of call
16:45:49 web.1     | ğŸ›¡ï¸ [PROTECTION] Greeting completed - hangup blocked for 3000ms
16:45:49 web.1     | ğŸ”‡ [REALTIME] AI stopped speaking (response.audio.done)
16:45:49 web.1     | â³ [AUDIO] 1 frames still in queue - letting them play (NO TRUNCATION)
16:45:49 web.1     | [REALTIME] event: response.audio_transcript.done
16:45:49 web.1     | ğŸ¤– [REALTIME] AI said: ×©×œ×•×, ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×™×˜×œ×™×ª ×©×œ ×§×œ×™×‘×¨. ×‘××™×–×” ×ª×—×•× ×ª×¨×¦×” ×¢×–×¨×”?
16:45:49 web.1     | âœ… [LEAD STATE] Updated: service_type=×ª×¨×¦×” ×¢×–×¨×”
16:45:49 web.1     | ğŸ“‹ [LEAD STATE] Current state: {'service_type': '×ª×¨×¦×” ×¢×–×¨×”'}
16:45:49 web.1     | ğŸ›¡ï¸ [PROTECTION] Ignoring AI goodbye - only 0ms since greeting
16:45:49 web.1     | [GOODBYE CHECK] No goodbye phrase: '×©×œ×•×, ×× ×™ ×”×¢×•×–×¨×ª ×”×“×™×’×™×˜×œ×™×ª ×©×œ ...'
16:45:49 web.1     | [REALTIME] event: response.content_part.done
16:45:49 web.1     | [REALTIME] event: response.output_item.done
16:45:49 web.1     | [REALTIME] event: response.done
16:45:49 web.1     | [REALTIME] event: rate_limits.updated
16:45:49 web.1     | âœ… [PHASE 2] Greeting finished after 1.4s - now updating session
16:45:49 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=20, voice_frames=0
16:45:49 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 100 noise frames (rms=16)
16:45:50 web.1     | âœ… [PHASE 2] Session updated with full prompt: 2625 chars, voice=shimmer locked
16:45:50 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=8, voice_frames=0
16:45:51 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=8, voice_frames=0
16:45:51 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 200 noise frames (rms=8)
16:45:52 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=8, voice_frames=0
16:45:53 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=8, voice_frames=0
16:45:53 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 300 noise frames (rms=8)
16:45:54 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=False, waiting_for_dtmf=False, rms=8, voice_frames=0
16:45:55 web.1     | ğŸ™ï¸ REAL_VOICE: rms=1389.0 > threshold=118.2
16:45:55 web.1     | [REALTIME] event: input_audio_buffer.speech_started
16:45:55 web.1     | ğŸ¤ [REALTIME] User started speaking - setting user_has_spoken=True
16:45:55 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=551, voice_frames=0
16:45:56 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=20, voice_frames=0
16:45:56 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 400 noise frames (rms=26)
16:45:57 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=30, voice_frames=0
16:45:58 web.1     | ğŸ’“ WS_KEEPALIVE #1 (prevents 5min timeout)
16:45:58 web.1     | ğŸ“¨ Received: mark
16:45:58 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=33, voice_frames=0
16:45:59 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 500 noise frames (rms=36)
16:45:59 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=26, voice_frames=0
16:46:00 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=38, voice_frames=0
16:46:01 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 600 noise frames (rms=30)
16:46:01 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=40, voice_frames=0
16:46:02 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=35, voice_frames=0
16:46:02 web.1     | ğŸ™ï¸ REAL_VOICE: rms=149.0 > threshold=118.2
16:46:03 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 700 noise frames (rms=35)
16:46:03 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=25, voice_frames=0
16:46:04 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=21, voice_frames=0
16:46:05 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 800 noise frames (rms=60)
16:46:05 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=23, voice_frames=0
16:46:06 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=17, voice_frames=0
16:46:07 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 900 noise frames (rms=16)
16:46:07 web.1     | ğŸ™ï¸ REAL_VOICE: rms=283.0 > threshold=118.2
16:46:07 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=258, voice_frames=0
16:46:08 web.1     | ğŸ’“ WS_KEEPALIVE #2 (prevents 5min timeout)
16:46:08 web.1     | ğŸ“¨ Received: mark
16:46:08 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=15, voice_frames=0
^[[A16:46:09 web.1     | ğŸ” AUTH DEBUG: user_id=9, role=owner, business_id=1, computed_tenant=1, impersonating=False
16:46:09 web.1     | ğŸ”” /api/notifications - tenant_id=1, g.tenant=1
16:46:09 web.1     | ğŸ”” Querying reminders for tenant_id=1, is_system_admin=False
16:46:09 web.1     | ğŸ”” Found 0 reminders
16:46:09 web.1     | INFO:     172.31.72.130:36234 - "GET /api/notifications HTTP/1.1" 200 OK
^[[A16:46:09 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 1000 noise frames (rms=11)
^[[A^[[A^[[A16:46:09 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=14, voice_frames=0
^[[A^[[A16:46:10 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=9, voice_frames=0
16:46:11 web.1     | ğŸ¤ END OF UTTERANCE: 1.8s audio, conversation #0
16:46:11 web.1     | ğŸ§  STATE -> PROCESSING | len=28480 | silence_ms=2821
16:46:11 web.1     | â­ï¸ [REALTIME] Skipping Google STT/TTS - using Realtime API only
16:46:11 web.1     | âœ… Processing complete for conversation #0
16:46:11 web.1     | ğŸ”‡ [AUDIO GATE] Blocked 1100 noise frames (rms=12)
16:46:11 web.1     | ğŸ™ï¸ REAL_VOICE: rms=144.0 > threshold=118.2
16:46:11 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=21, voice_frames=0
16:46:12 web.1     | ğŸ” [BARGE-IN DEBUG] is_ai_speaking=False, user_has_spoken=True, waiting_for_dtmf=False, rms=13, voice_frames=0
16:46:13 web.1     | ğŸ“¨ Received: stop
16:46:13 web.1     | WS_STOP sid=MZcf07f1e9f174fbd3a2099bee2ee81d3c rx=1254 tx=270
16:46:13 web.1     | âš ï¸ [BRIDGE GAP] 23329ms wait for queue - chunk #21
16:46:13 web.1     | ğŸ“¤ [REALTIME] Stop signal received
16:46:13 web.1     | ğŸ“¤ [REALTIME] Audio output bridge ended (sent 270 frames, 43200 bytes)
16:46:13 web.1     | ğŸ“¤ [REALTIME] Audio sender ended
16:46:13 web.1     | ğŸ“ [REALTIME] Text sender ended
16:46:13 web.1     | âš ï¸ DEV MODE: VALIDATE_TWILIO_SIGNATURE=false - signature validation skipped
16:46:13 web.1     | STREAM_ENDED call=CAc34f08c1c97e8ddbbac6918d8f9cf3fa stream=N/A status=N/A
16:46:13 web.1     | INFO:     172.31.72.130:36234 - "POST /webhook/stream_ended HTTP/1.1" 204 No Content
16:46:13 web.1     | âš ï¸ DEV MODE: VALIDATE_TWILIO_SIGNATURE=false - signature validation skipped
16:46:13 web.1     | INFO:     172.31.72.130:36234 - "POST /webhook/call_status HTTP/1.1" 204 No Content
16:46:13 web.1     | âœ… Found existing recording for CAc34f08c1c97e8ddbbac6918d8f9cf3fa: /2010-04-01/Accounts/ACcd09431f076a309088b18ed1f286f32e/Recordings/REeacc6acd3dab79e6eb068c29ed97d440.json
16:46:13 web.1     | âœ… Recording queued for processing: CAc34f08c1c97e8ddbbac6918d8f9cf3fa
16:46:13 web.1     | ğŸ§¹ Waiting for 5 background threads...
16:46:14 web.1     | âŒ Receive error: (<CloseCode.NO_STATUS_RCVD: 1005>, '')
16:46:14 web.1     | ğŸ”§ receive_loop ended
16:46:14 web.1     | INFO:     connection closed
16:46:14 web.1     | ğŸ”§ send_loop ended
16:46:16 web.1     | âš ï¸ Background thread 0 still running after timeout
16:46:19 web.1     | âš ï¸ Background thread 4 still running after timeout
16:46:19 web.1     | âœ… All background threads cleanup complete
16:46:19 web.1     | 
16:46:19 web.1     | ================================================================================
16:46:19 web.1     | ğŸ’°ğŸ’°ğŸ’° [CALL COST SUMMARY] ğŸ’°ğŸ’°ğŸ’°
16:46:19 web.1     | ================================================================================
16:46:19 web.1     | ğŸ“ Model: gpt-4o-realtime-preview
16:46:19 web.1     | â±ï¸  Total duration: 31.5s (0.5 min)
16:46:19 web.1     | ğŸ™ï¸  Audio IN (user speaking): 94 chunks (0.031 min)
16:46:19 web.1     |    â””â”€ Cost: 0.031 min Ã— $0.06/min = $0.0019
16:46:19 web.1     | ğŸ”Š Audio OUT (AI speaking): 0 chunks (0.000 min)
16:46:19 web.1     |    â””â”€ Cost: 0.000 min Ã— $0.24/min = $0.0000
16:46:19 web.1     | â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
16:46:19 web.1     | ğŸ’µ TOTAL COST: $0.0019 (â‰ˆ â‚ª0.01)
16:46:19 web.1     | ================================================================================
16:46:19 web.1     | 
16:46:19 web.1     | WS_DONE sid=MZcf07f1e9f174fbd3a2099bee2ee81d3c rx=1254 tx=270
16:46:19 web.1     | âœ… MediaStreamHandler completed
16:46:19 web.1     | âœ… Handler thread join completed
16:46:19 web.1     | âœ… CALL FINALIZED: CAc34f08c1c97e8ddbbac6918d8f9cf3fa
16:46:19 web.1     | ğŸ“ Summary: ### ×¡×•×’ ×”×¤× ×™×™×” ×•×”×ª×—×•×:
16:46:19 web.1     | ×©×™×—×” ×¢× ×œ×§×•×— ×¤×•×˜× ×¦×™××œ×™ ×‘×ª×—×•× ×”× ×“×œ"×Ÿ ×•×ª×™×•×•×š, ×”××¢×•× ×™×™×Ÿ ×‘×©×™×¨×•×ª×™ ×ª×™×•×•×š ×œ×¨×›×™×©×ª × ×›×¡.
16:46:19 web.1     | 
16:46:19 web.1     | ### ×¤×¨×˜×™× ×¡×¤×¦×™×¤×™×™×:
16:46:19 web.1     | ×”×œ×§×•×— ××—×¤×© × ×›×¡ ×‘××–×•×¨ ×ª×œ ××‘×™×‘. ×”×•× ××¢×•× ×™×™×Ÿ ×‘×“×™×¨×” ×¢× 3 ×—×“×¨×™×, ×ª×§×¦×™×‘ ×©×œ ×¢×“ 3 ××™×œ×™×•×Ÿ ×©"×—. ×”×œ×§×•×— ×”×“×’×™×© ××ª ×”×¦×•×¨×š ×‘× ×’×™×©×•×ª ×œ×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×©×™×¨×•×ª×™× ×§×”×™×œ×ª×™×™× ×‘×¡×‘×™×‘×”.
16:46:19 web.1     | 
16:46:19 web.1     | ### ×¤×¨×˜×™ ×”×œ×§×•×—:
16:46:19 web.1     | ×œ×¦×¢×¨×™, ×œ× × ××¡×¨×• ×¤×¨×˜×™ ×§×©×¨ ××• ×©× ×”×œ×§×•×— ×‘×©×™×—×”.
16:46:19 web.1     | 
16:46:19 web.1     | ### ×¡×˜×˜×•×¡ ×•××¢×§×‘:
16:46:19 web.1     | - ×œ× × ×§×‘×¢×” ×¤×’×™×©×”, ××š ×”×œ×§×•×— ××ª×¢× ×™×™×Ÿ ×‘××™×“×¢ × ×•×¡×£ ×¢×œ × ×›×¡×™× ×–××™× ×™×.
16:46:19 web.1     | - ×“×—×™×¤×•×ª: ×’×‘×•×”×”, ×”×œ×§×•×— ××¢×•× ×™×™×Ÿ ×œ×‘×¦×¢ ×¨×›×™×©×” ×‘×”×§×“×.
16:46:19 web.1     | - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª: ×™×© ×œ×©×œ×•×— ×œ×œ×§×•×— ×¨×©×™××” ×©×œ × ×›×¡×™× ××ª××™××™× ×•×œ×ª×× ×¤×’×™×©×” ×œ×”××©×š ×ª×”×œ×™×š.
16:46:19 web.1     | 
16:46:19 web.1     | ### ×”×¢×¨×•×ª ×—×©×•×‘×•×ª:
16:46:19 web.1     | ×™×© ×œ×”×“×’×™×© ×œ×œ×§×•×— ××ª ×”×™×ª×¨×•× ×•×ª ×©×œ ×”××©×¨×“, ×›×•×œ×œ × ×™×¡×™×•×Ÿ ×‘×©×•×§ ×”×ª×œ ××‘×™×‘×™ ×•×™×›×•×œ×ª ×œ×¡×™×™×¢ ×‘××¦×™××ª × ×›×¡×™× ×©××ª××™××™× ×œ×¦×¨×›×™×•.
16:46:19 web.1     | ğŸ¯ Intent: general_inquiry
16:46:19 web.1     | ğŸ“Š Next Action: ××¢×§×‘ ×ª×•×š 24 ×©×¢×•×ª
16:46:19 web.1     | â„¹ï¸ Appointment handling: Managed by Agent 