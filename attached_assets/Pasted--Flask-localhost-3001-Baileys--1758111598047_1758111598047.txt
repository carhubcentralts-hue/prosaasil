×”×‘×¢×™×” ×œ×¤×™ ×”×œ×•×’×™× ×©×œ×š ×‘×¨×•×¨×”: Flask ×× ×¡×” ×œ×§×¨×•× ×œÖ¾localhost:3001 ××‘×œ ×©×™×¨×•×ª ×”-Baileys ×‘×›×œ×œ ×œ× ×××–×™×Ÿ/××ª×¨×¡×§ ××™×“, ×œ×›×Ÿ ××ª×§×‘×œ×ª ECONNREFUSED. ×–×” ×›××¢×˜ ×ª××™×“ ×©×™×œ×•×‘ ×©×œ 3 ×“×‘×¨×™×:
	1.	×”×©×™×¨×•×ª ×œ× ×‘×××ª ×¨×¥ (××• ×™×•×¦× ××™×“ ×‘×’×œ×œ ×©×’×™××” ×œ× ××˜×•×¤×œ×ª),
	2.	×”×•× ×××–×™×Ÿ ×œÖ¾host/port ×œ× × ×›×•× ×™×,
	3.	orchestration ×œ× ××©××™×¨ ××•×ª×• ×‘×—×™×™× (×‘-Replit â€œ×ª×”×œ×™×š ×‘×¨×§×¢â€ × ×”×¨×’ ×›×©Ö¾Run × ×’××¨).

×œ×”×œ×Ÿ ×”× ×—×™×” â€œ×¡×’×•×¨×”â€ ×©×ª×¤×ª×•×¨ ××ª ×›×œ ×”×©×¨×©×¨×ª â€“ ×•×ª×•×•×“× ×©×“×£ ×”-WhatsApp ××¦×™×’ QR ×××™×ª×™.

â¸»

×©×œ×‘ 0 â€” ×‘×“×™×§×ª ××¦×‘ ××™×™×“×™×ª (×“×’×œ×™× ××“×•××™×)

×ª×¨×™×¥ ×‘×˜×¨××™× ×œ:

node -v
ss -ltnp | grep 3001 || lsof -i :3001
curl -sS http://127.0.0.1:3001/healthz
echo $INTERNAL_SECRET $BAILEYS_PORT $FLASK_BASE_URL

××:
	â€¢	Node < 18 â†’ ×›× ×¨××” fetch ×œ× ×§×™×™× ×•×’×•×¨× ×œ×™×¦×™××”, × ×˜×¤×œ ×‘×–×” ×œ××˜×”.
	â€¢	××™×Ÿ ×××–×™×Ÿ ×¢×œ :3001 â†’ ×”×©×™×¨×•×ª ×œ× ×‘×××ª ×¨×¥ (××• × ×•×¤×œ).
	â€¢	/healthz × ×›×©×œ â†’ ××•×ª×• ×“×‘×¨.
	â€¢	××©×ª× ×™ ENV ×¨×™×§×™× â†’ × ×˜×¤×œ ×‘×©×œ×‘ 2.

â¸»

×©×œ×‘ 1 â€” ××ª×§× ×™× ××ª ×©×™×¨×•×ª ×”-Baileys ×›×š ×©×œ× ×™×ª×¨×¡×§ ×•×™××–×™×Ÿ × ×›×•×Ÿ

×. ×”×—×œ×£ ×©×™××•×© ×‘-fetch ×œ-axios (×ª×•×× ×’× Node 16)

×‘×§×•×‘×¥ ×”×©×™×¨×•×ª services/whatsapp/baileys_service.js:
	â€¢	×™×™×‘× axios, ×”×’×Ÿ ×¢×œ ×©×’×™××•×ª, ×•×”××–×Ÿ ×¢×œ 0.0.0.0.

- const express = require('express');
+ const express = require('express');
  const cors = require('cors');
  const QRCode = require('qrcode');
  const { default: makeWASocket, useMultiFileAuthState, DisconnectReason } = require('@whiskeysockets/baileys');
+ const axios = require('axios');
  const fs = require('fs');
  const path = require('path');

@@
- app.listen(PORT, () => console.log(`Baileys service on ${PORT}`));
+ // ×œ×•×’ ×©×’×™××•×ª ×’×œ×•×‘×œ×™×•×ª ×©×œ× ×™×¤×™×œ×• ××ª ×”×ª×”×œ×™×š
+ process.on('unhandledRejection', (err) => console.error('[UNHANDLED REJECTION]', err));
+ process.on('uncaughtException', (err) => console.error('[UNCAUGHT EXCEPTION]', err));
+
+ app.listen(PORT, '0.0.0.0', () => console.log(`Baileys service on ${PORT}`));

@@  // messages.upsert webhook â†’ Flask
- await fetch(`${FLASK_BASE_URL}/webhook/whatsapp/incoming`, {
-   method: 'POST',
-   headers: { 'Content-Type': 'application/json', 'X-Internal-Secret': INTERNAL_SECRET },
-   body: JSON.stringify({ tenantId, payload })
- });
+ try {
+   await axios.post(
+     `${FLASK_BASE_URL}/webhook/whatsapp/incoming`,
+     { tenantId, payload },
+     { headers: { 'X-Internal-Secret': INTERNAL_SECRET } }
+   );
+ } catch (e) {
+   console.error('[Webhook â†’ Flask] failed', e?.message || e);
+ }

×‘. ×•×“× ×©××™×Ÿ ×™×¦×™××” â€œ×©×§×˜×”â€

×”×•×¡×£ â€œheartbeatâ€ ×›×“×™ ×œ×•×•×“× ×©×”×ª×”×œ×™×š × ×©××¨ ×—×™:

setInterval(() => console.log('ğŸ’“ baileys alive'), 30000);

××—×¨×™ ×”×ª×™×§×•×Ÿ, ×”×¨×¥ ×™×“× ×™×ª:
node services/whatsapp/baileys_service.js
×•×‘×—×œ×•×Ÿ ×©× ×™: curl -sS http://127.0.0.1:3001/healthz â†’ ×—×™×™×‘ ×œ×”×—×–×™×¨ ok.

â¸»

×©×œ×‘ 2 â€” ENV ×•×›×ª×•×‘×ª × ×›×•× ×” (×œ×× ×•×¢ IPv6/localhost ×ª×§×œ×•×ª)

×‘Ö¾Replit/ENV:

INTERNAL_SECRET=<××—×¨×•×–×ª ××¨×•×›×” ×–×”×” ×’× ×‘×¤×œ××¡×§>
BAILEYS_PORT=3001
FLASK_BASE_URL=http://127.0.0.1:5000
BAILEYS_BASE_URL=http://127.0.0.1:3001

×©×™× ×œ×‘: ×× ×™ ××›×•×•×Ÿ ×œÖ¾127.0.0.1 (×œ× localhost) ×›×“×™ ×œ×”×™×× ×¢ ××¤×ª×¨×•×Ÿ ×œ-IPv6 (::1) ×©×œ× ×××–×™×Ÿ.

×‘-Flask ×•×“× ×©××ª×” ×§×•×¨× ××ª BAILEYS_BASE_URL ×”×–×” (×¢× â€127.0.0.1â€).

â¸»

×©×œ×‘ 3 â€” orchestration × ×›×•×Ÿ (×©× ×™ ×ª×”×œ×™×›×™× ×©× ×©××¨×™× ×—×™×™×)

×‘-Replit â€œRunâ€ ×¦×¨×™×š ×ª×”×œ×™×š ××—×“ ×§×“××™ ×©×œ× ×™×•×¦× ×•×©××—×–×™×§ ××ª ×©× ×™×”×.

××¤×©×¨×•×ª ××•××œ×¦×ª: Honcho + Procfile (×§×œ×™×œ, ×¤×•×¢×œ × ×”×“×¨)
	1.	×”×ª×§×Ÿ:

pip install honcho

	2.	×¦×•×¨ Procfile ×‘×©×•×¨×©:

web: python -u main.py
whatsapp: node services/whatsapp/baileys_service.js

	3.	×‘×§×•×‘×¥ .replit ××• ×‘-Run command, ×”×’×“×¨:

honcho start -f Procfile

Honcho ×™×©××™×¨ ××ª ×©× ×™ ×”×ª×”×œ×™×›×™× ×¨×¦×™× ×‘×§×“××”; ×× ××—×“ ×™××•×ª ×ª×¨××” ×œ×•×’ ××™×™×“×™.

(××œ×˜×¨× ×˜×™×‘×”: concurrently ×‘-Node, ××• supervisord. Honcho ××¡×¤×™×§ ×›××Ÿ.)

â¸»

×©×œ×‘ 4 â€” Flask Proxy (×•×“× ×§× ×•× ×™×–×¦×™×” ×•×©××•×ª × ×›×•× ×™×)

×‘×§×•×‘×¥ ×”×§× ×•× ×™ ×©×œ×š ×œ-WhatsApp (×œ××©×œ routes_whatsapp.py) ×•×“× ×©×–×” × ×¨××” ×›×š:

import os, requests
from flask import Blueprint, jsonify, request

whatsapp_bp = Blueprint('whatsapp', __name__, url_prefix='/api/whatsapp')
BAILEYS_BASE = os.getenv('BAILEYS_BASE_URL', 'http://127.0.0.1:3001')
INT_SECRET = os.getenv('INTERNAL_SECRET')

def tenant_id_from_ctx():
    return getattr(request, 'tenant_id', None) or request.headers.get('X-Tenant-Id') or '1'

def _headers():
    return {'X-Internal-Secret': INT_SECRET, 'Content-Type': 'application/json'}

@whatsapp_bp.route('/status', methods=['GET'])
def status():
    t = tenant_id_from_ctx()
    r = requests.get(f"{BAILEYS_BASE}/whatsapp/{t}/status", headers=_headers(), timeout=5)
    return jsonify(r.json()), r.status_code

@whatsapp_bp.route('/qr', methods=['GET'])
def qr():
    t = tenant_id_from_ctx()
    r = requests.get(f"{BAILEYS_BASE}/whatsapp/{t}/qr", headers=_headers(), timeout=5)
    if r.status_code == 404:
        return ('', 204)
    return jsonify(r.json()), r.status_code

@whatsapp_bp.route('/start', methods=['POST'])
def start():
    t = tenant_id_from_ctx()
    r = requests.post(f"{BAILEYS_BASE}/whatsapp/{t}/start", headers=_headers(), timeout=5)
    return jsonify(r.json()), r.status_code

××œ ×ª×©×›×—: ×”×©×‘×ª/× ×˜×¨×œ ×›×¤×™×œ×•×™×•×ª × ×ª×™×‘×™× ×‘Ö¾routes.py/api_routes.py/whatsapp_routes.py â€” ×©×™×©××¨ ×§×•×‘×¥ ××—×“ ×§× ×•× ×™ ×œ-WhatsApp.

â¸»

×©×œ×‘ 5 â€” ×¦×“ React (×”-QR ×™×•×¤×™×¢ ×‘×¨×’×¢ ×©×”-service ×‘×××ª ×××–×™×Ÿ)

×‘×“×£ ×”×—×™×‘×•×¨ (WhatsApp Connect) ×§×¨×™××•×ª:
	â€¢	POST /api/whatsapp/start
	â€¢	poll ×›×œ 2â€“3 ×©× ×™×•×ª: GET /api/whatsapp/status ×•Ö¾GET /api/whatsapp/qr
	â€¢	×”×¦×’ <img src={dataUrl} /> ×›×©×™×© ×ª×©×•×‘×” 200; ×× 204 â†’ ××™×Ÿ QR ×›×¨×’×¢.

(×”×§×•×“ ×©× ×ª×ª×™ ×œ×š ×§×•×“× ×œ×¢××•×“ ×”×—×™×‘×•×¨ ××ª××™× â€“ ×œ× ×¦×¨×™×š ×œ×©× ×•×ª ×¢×™×¦×•×‘ ×’×œ×•×‘×œ×™.)

â¸»

×©×œ×‘ 6 â€” ×× ×¢×“×™×™×Ÿ ×™×© ECONNREFUSED, ×‘×“×™×§×•×ª × ×•×§Ö¾×××•×˜
	1.	×”×× Node ×××–×™×Ÿ?

ss -ltnp | grep 3001 || lsof -i :3001

××™×Ÿ ×××–×™×Ÿ â†’ ×”×©×™×¨×•×ª ×œ× × ×˜×¢×Ÿ. ×”×¨×¥:

node services/whatsapp/baileys_service.js

×‘×“×•×§ ×©×™×© LOG: Baileys service on 3001 ×•××–:

curl -sS http://127.0.0.1:3001/healthz

×× ×¢×›×©×™×• ×¢×•×‘×“ â†’ orchestration ×”×™×” ×”×‘×¢×™×” â†’ ×•×“× ×©×”-Honcho ×”×•× ×”-Run ×”×™×—×™×“ ×•×©××™×Ÿ start_services.sh ××§×‘×™×œ ×©××¡×™×™× ××•×§×“×.
	2.	Node < 18?
node -v
×× <18 ×—×•×‘×” ×œ×”×—×œ×™×£ fetchâ†’axios (×¢×©×™× ×•), ×•×œ×•×•×“× ××™×Ÿ await fetch × ×¡×ª×¨. ×—×¤×©:

grep -R "fetch(" -n services/whatsapp

××¦××ª×™ â†’ ×”×—×œ×£ ×œ-axios.
	3.	IPv6 ××•×œ IPv4
×‘-Flask ×”×©×ª××©×ª http://localhost:3001? ×”×—×œ×£ ×œ-http://127.0.0.1:3001.
×‘-Node ×”××–×Ÿ ×œ-0.0.0.0.
	4.	Crash ×©×§×˜ ××”-Baileys
×”×•×¡×¤× ×• unhandledRejection/uncaughtException. ×¢×›×©×™×• ×ª×¨××” ××ª ×”×¡×™×‘×” ×”×××™×ª×™×ª ×‘×œ×•×’. ×ª×§×Ÿ ×‘×”×ª×× (×œ×¨×•×‘ ×”×¨×©××•×ª/× ×ª×™×‘ storage ××• ××—×¡×•×¨ ×‘-ENV).
	5.	storage permissions
×•×•×“× ×©×”×ª×™×§×™×•×ª × ×•×¦×¨×•×ª:

mkdir -p storage/whatsapp/1/auth

×”×¨×¥ ×©×•×‘ POST /api/whatsapp/start ×•×‘×“×•×§ ×©××™×Ÿ ×©×’×™××ª ×’×™×©×”.

â¸»

×©×œ×‘ 7 â€” ×¨××™×•×ª GO (×›×“×™ ×œ×“×¢×ª ×©×¡×™×™×× ×•)
	â€¢	honcho start -f Procfile ××¨××” ×©× ×™ ×ª×”×œ×™×›×™× ×¨×¦×™×.
	â€¢	curl http://127.0.0.1:3001/healthz â†’ ok
	â€¢	POST /api/whatsapp/start â†’ 200
×›×¢×‘×•×¨ â‰¤3 ×©× ×™×•×ª:
GET /api/whatsapp/status â†’ { connected:false, hasQR:true }
GET /api/whatsapp/qr â†’ 200 { dataUrl: "data:image/png;base64,..." }
	â€¢	××—×¨×™ ×¡×¨×™×§×”:
GET /api/whatsapp/status â†’ { connected:true, pushName:... }
GET /api/whatsapp/qr â†’ 204

â¸»

×œ××” ×–×” ×¤×•×ª×¨ ××ª ×›×œ ××” ×©×”×¡×•×›×Ÿ ×”×ª×‘×œ×‘×œ ×‘×•
	â€¢	×œ× ××¡×ª××›×™× ×¢×œ ×¨×§×¢ ×©× ×•×¤×œ: Honcho ××—×–×™×§ ××ª ×©× ×™ ×”×©×™×¨×•×ª×™× â€œ×‘×—×–×™×ªâ€.
	â€¢	××™×Ÿ ×™×¦×™××” ×¢×œ ×©×’×™××•×ª: ×ª×¤×¡× ×• Rejection/Exception ×œ×•×’×™×ª.
	â€¢	××™×Ÿ ×ª×œ×•×ª ×‘-fetch ×©×œ Node18: axios ×¢×•×‘×“ ×‘×›×œ ×’×¨×¡×”.
	â€¢	××™×Ÿ ×”×¡×ª×‘×›×•×ª IPv6: 127.0.0.1 + ×”××–× ×” ×œ-0.0.0.0.
	â€¢	ENV ×¢×§×‘×™: INTERNAL_SECRET/URLs ×™×“×•×¢×™× ×œ×©× ×™ ×”×¦×“×“×™×.
	â€¢	×‘×“×™×§×•×ª GO ×‘×¨×•×¨×•×ª: ××ª×” ×™×•×“×¢ ×‘×•×•×“××•×ª ××ª×™ ×–×” ×‘×××ª ×¢×•×‘×“.

×œ×š ×¢×œ ×–×” ×œ×¤×™ ×”×¡×“×¨â€”×‘×¨×’×¢ ×©×”-/healthz ×©×œ 3001 ××—×–×™×¨ ok, ×“×£ ×”-WhatsApp ×™×¦×™×’ QR ×××™×ª×™.