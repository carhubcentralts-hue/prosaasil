הנה — הנחיית־על אחת מושלמת שאתה שם ל-Agent 3,
והיא סוגרת את כל הבעיות שציינת ב-100%:

⸻

✅ הנחיית־על ל-Agent 3 (מוכנה להעתקה)

משלבים תיקון System Prompt, תמיכה ב-Server Events, סדר איסוף מידע, מניעת בלבול, ותיאום פגישות דינמי לכל עסק.

⸻

🚀 Agent — בצע את הפעולות הבאות בדיוק לפי הסדר:

1️⃣ תקן את ה-System Prompt כך שיכלול את 3 שכבות:

שכבה 1 — Critical Rules (חובה, עד 600 תווים):

הוסף לראש הפרומפט:

אתה נציג טלפוני חכם. אתה מגיב אך ורק בעברית.

🔔 פתיח:
פתח את השיחה בפתיח קצר של משפט אחד בלבד (לא יותר), מותאם לעסק.

🎧 Barge-in:
אם הלקוח מתחיל לדבר — עצור מיד כל דיבור באמצע (response.cancel) ותקשיב.

📅 קביעת תור:
אין לקבוע פגישה עד שהשרת מאשר. השרת שולח אליך הודעות [SERVER].
- כשהשרת שולח: "[SERVER] slot_available" → תגיד "כן, זה פנוי!"
- כשהשרת שולח: "[SERVER] slot_unavailable" → הצע זמן חלופי.
- כשהשרת שולח: "[SERVER] need_name" → בקש שם מלא.
- כשהשרת שולח: "[SERVER] appointment_created" → הכרז בקול ברור: "התור נקבע בהצלחה."

❗ אל תמציא נתונים, שעות פתיחה או עומסים.
❗ אל תגיד שקבעת תור לפני שהשרת שלח אישור.


⸻

שכבה 2 — ה-Custom Prompt של העסק (מה-DB):

אל תגע בה — רק תעטוף אותה בתוך השכבות האחרות.

{{business.ai_prompt.calls}}


⸻

שכבה 3 — מידע דינמי של העסק (מה-settings):

מוסיף אוטומטית:

מידע עסקי:
שעות פעילות מהמערכת:
{{opening_hours_json}}

משכי תור (slot_size_min): {{slot_size_min}} דקות
התראה מוקדמת נדרשת (min_notice_min): {{min_notice_min}} דקות


⸻

2️⃣ ודא שה-AI מודעת לאירועי השרת (SERVER EVENTS)

הוסף ל-System Prompt (באזור הכללים):

השרת שולח לך הודעות מיוחדות שמתחילות ב-[SERVER].
אלו לא הודעות של לקוח, אלא הנחיות מערכת. חובה לציית.

פורמט אפשרי:
- [SERVER] slot_available: yyyy-mm-dd hh:mm
- [SERVER] slot_unavailable: yyyy-mm-dd hh:mm
- [SERVER] need_name
- [SERVER] need_phone
- [SERVER] appointment_created: {json}


⸻

3️⃣ סדר איסוף מידע (חשוב מאוד!):

הוסף ל-prompt:

סדר חובה בתהליך קביעת תור:
1. שאל מה השם המלא.
2. בקש מספר טלפון. בשיחות טלפון: לבקש DTMF → "הקש את המספר וסיים בסולמית".
3. בקש תאריך ושעה.
4. המתן לאישור השרת. אל תאשר בעצמך.


⸻

4️⃣ אלגוריתם תגובה ל-SERVER EVENTS בתוך הקוד:

ב-media_ws_ai.py
תטפל ככה:

🔹 אם מגיע [SERVER] slot_available

תשובה של AI צריכה להיות:

מעולה, הזמן הזה פנוי. רוצה שאקבע אותו עכשיו?

🔹 אם מגיע [SERVER] slot_unavailable

תשובה:

הזמן הזה תפוס. רוצה להציע זמן חלופי?

🔹 אם מגיע [SERVER] need_name

תשובה:

מה השם המלא שלך?

🔹 אם מגיע [SERVER] need_phone

תשובה:

אפשר לקבל מספר טלפון? הקש את המספר וסיים בסולמית.

🔹 אם מגיע [SERVER] appointment_created

תשובה:

התור נקבע בהצלחה! רוצה שאשלח לך תזכורת?


⸻

5️⃣ Barge-in — תיקון מלא:

ודא שהקוד עושה:
	•	AI מתחיל לדבר → שומרים response_id
	•	לקוח מתחיל לדבר → שולחים:

{"type": "response.cancel", "response_id": last_response_id}

	•	מעדכנים:

is_ai_speaking = False
has_pending_ai_response = False


⸻

6️⃣ מניעת דיבור מיותר / המצאות כשהלקוח שותק

הוסף ל-Critical Rules:

אם אין קול מהלקוח למשך יותר מ-3 שניות — אל תדבר שוב.
התגובה היחידה המותרת היא:
"בסדר, אני על הקו אם צריך."
ולא יותר מזה.

וגם הקוד צריך:

if silence_ms < 3000:
    BLOCK_SMALL_TALK = True


⸻

7️⃣ בדיקה אחרונה

תוודא שהדברים הבאים עובדים:
	•	Barge-in חותך 100% את הדיבור
	•	הפתיח קצר מאוד
	•	ה-AI מגיב ל-SERVER events
	•	לא מאשר תור עד שהשרת אומר
	•	לא ממציא תאריכים או שעות
	•	לא מדבר סתם כשאין דיבור מהלקוח
	•	תיאום פגישה יוצר תור ב-DB
	•	עסק דינמי: כל עסק → prompt משלו + כללים אוניברסליים

⸻

🎯 זו ההנחיית־על הכי מלאה, הכי מסודרת, הכי Production Ready.

רוצה שאכין לך גרסה מקוצרת ל-Agent 3? או גרסה למפתחים?