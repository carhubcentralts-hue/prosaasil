×¡×‘×‘×”â€”× × ×¢×œ×™× ×•××¡×™×™××™× ××ª ×”-400/×©×§×˜ ××—×ª ×•×œ×ª××™×“. ×”× ×” ×ª×›× ×™×ª ×§×¨×‘×™×ª ×§×¦×¨×”, ×¡×•×¤×¨-××“×•×™×§×ª, ×œ×‘×™×¦×•×¢ â€œ×›××• ×¨×•×‘×•×˜â€. ×× ×ª×¢×§×•×‘ ×œ×¤×™ ×”×¡×“×¨, × ×§×‘×œ 101 Handshake, ×–×¨×™××ª ××“×™×”, ×•×©×™×—×” ×—×™×”.

â¸»

GO PLAN â€” Twilio Media Streams ×™×¦×™×‘ (Eventlet + WSGI Composite)

0) ×ª× ××™ ×¡×£ (×—×•×‘×”)

requirements.txt (××™× ×™××•×, ×‘×œ×™ gevent/uvloop/Flask-SocketIO):

Flask
gunicorn
eventlet==0.36.1
greenlet>=3.0,<3.3
simple-websocket

Run (×’× ×‘-Workspace ×•×’× ×‘×“×™×¤×œ×•×™):
	â€¢	××©×ª× ×™×: EVENTLET_NO_GREENDNS=1, EVENTLET_HUB=select
	â€¢	×•×•×¨×§×¨: gunicorn -k eventlet -w 1 --worker-connections 256

â¸»

1) ×“×™×¤×œ×•×™ ×‘-Replit ×‘×œ×™ Nix (×‘×—×¨ ××—×ª)

×. ××•×¢×“×£ â€” ×œ×›×¤×•×ª Python: ×”×–×–/×©× ×”-×©× package.json ××”×©×•×¨×© ×œÖ¾client/ (××• package.json.off).
×•××– ×‘×“×™×¤×œ×•×™ (ğŸš€):
	â€¢	Build:
python -m pip install -U pip setuptools wheel && python -m pip install -r requirements.txt
	â€¢	Run:
python -m gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT --worker-connections 256 --timeout 120 --keep-alive 75 --log-level info --access-logfile - --error-logfile -
	â€¢	Env: EVENTLET_NO_GREENDNS=1, EVENTLET_HUB=select, DEPLOY_ID=<stamp>
	â€¢	Health check: /healthz (200), Startup timeout: 300s

×‘. ×× ×—×™×™×‘×™× ×œ×”×©××™×¨ package.json ×‘×©×•×¨×© â€” ×œ×”×‘×™× Python ×¢× uv:
	â€¢	Build:
curl -fsSL https://astral.sh/uv/install.sh | sh && ~/.local/bin/uv python install 3.11 && ~/.local/bin/uv pip install -r requirements.txt
	â€¢	Run:
~/.local/bin/uv run --python 3.11 -m gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT --worker-connections 256 --timeout 120 --keep-alive 75 --log-level info --access-logfile - --error-logfile -
	â€¢	Env/Health ×›××• ×‘×â€™.

××˜×¨×”: ×‘×“×™×¤×œ×•×™ ×œ×•×’×™ ×”×¤×ª×™×—×” ×ª×¨××” Using worker: eventlet ×•-wsgi:app.

â¸»

2) × ×§×•×“×ª ×›× ×™×¡×” ××—×ª â€” wsgi:app ×‘×œ×‘×“
	â€¢	×‘Ö¾wsgi.py:
import eventlet; eventlet.monkey_patch() ×‘×¨××© ×”×§×•×‘×¥.
××—×¨×™ ×–×” ×˜×¢×Ÿ ××ª ××¤×œ×™×§×¦×™×™×ª Flask (×¨×¦×•×™ create_app(); ××• from main import app ×× ××™×Ÿ ××¤×¢×œ).
	â€¢	××œ ×ª×¨×™×¥ app.run ×‘×©×•× ××§×•×; ×›×œ ×”×”×¨×¦×” ×“×¨×š Gunicorn.

â¸»

3) ×”-WebSocket ×œ× ×›-route ×©×œ Flask â€” Composite WSGI

××˜×¨×”: ×œ×× ×•×¢ ×-catch-all ×©×œ Flask â€œ×œ×‘×œ×•×¢â€ ××ª /ws/*.

×‘-wsgi.py (×ª×™××•×¨ ×‘×™×¦×•×¢, ×‘×œ×™ ×§×•×“):
	1.	×›×ª×•×‘ ×¤×•× ×§×¦×™×™×ª handler ws_handler(ws) ×©××˜×¤×œ×ª ×‘××™×¨×•×¢×™ Twilio: start / media / stop (JSON).
	2.	×¢×˜×•×£ ×›Ö¾eventlet.websocket.WebSocketWSGI(ws_handler, protocols=['audio.twilio.com']).
×–×” ××—×–×™×¨ ××ª ×”-subprotocol ×‘×ª×©×•×‘×ª ×”-upgrade â€” ×§×¨×™×˜×™ ×œ-Twilio.
	3.	×‘× ×” Composite WSGI:
×× PATH_INFO == '/ws/twilio-media' â†’ ×§×¨× ×œÖ¾ws_app(environ, start_response)
××—×¨×ª â†’ ×”×¢×‘×¨ ×œÖ¾flask_app.wsgi_app(environ, start_response).
	4.	×”×™×™×¦×•× ×”×¡×•×¤×™ ××”×§×•×‘×¥: app = composite_app (×œ× Flask).
×‘×œ×™ DispatcherMiddleware ×× ×”×•× â€œ×œ× × ×ª×¤×¡â€ ××¦×œ×š. ×”-composite ×§×•×“Öµ× ×œ×›×œ ×“×‘×¨.

â¸»

4) ×œ× ×§×•×ª ××—×¡×•××™×
	â€¢	××¡×•×¨ ×©×™×©××¨ @app.route('/ws') ××• @app.route('/ws/<path:p>'). ××—×§/× ×˜×¨×œ.
	â€¢	×× ×™×© catch-all (×œ××©×œ @app.route('/', defaults=...)//<path:path>): ×–×” ×‘×¡×“×¨ â€” ×”-composite ×™×¢×§×•×£ ×œ×¤× ×™ Flask. ×¨×§ ×•×“× ×©-export ×”×•× ×”-composite.

â¸»

5) TwiML × ×›×•×Ÿ (×‘×–××Ÿ ×“×™×‘×•×’ ×‘×œ×™ <Play>)

×‘Ö¾incoming_call:

<Connect action="https://{BASE}/webhook/stream_ended">
  <Stream url="wss://{BASE}/ws/twilio-media"
          statusCallback="https://{BASE}/webhook/stream_status">
    <Parameter name="call_sid" value="{CALL_SID}"/>
  </Stream>
</Connect>

	â€¢	×‘×œ×™ // ×›×¤×•×œ×™× ×‘-URL.
	â€¢	stream_status ××§×‘×œ form-urlencoded ×•××—×–×™×¨ ×ª××™×“ 204 (×‘×œ×™ ××™××•×ª ×—×ª×™××”/extra ×‘×œ×•×’×™×).

â¸»

6) ×•×™×“×•× Handshake (×©×•×‘×¨ 400/31920)

×œ×¤× ×™ Twilio, ×‘×“×•×§ ×™×“× ×™×ª:

wscat -c wss://{BASE}/ws/twilio-media \
      -H "Sec-WebSocket-Protocol: audio.twilio.com"

××¦×•×¤×”:
	â€¢	101 Switching Protocols
	â€¢	×•×‘×ª×©×•×‘×” ××•×¤×™×¢×” ×›×•×ª×¨×ª Sec-WebSocket-Protocol: audio.twilio.com

×œ× ××•×¤×™×¢? â†’ ×–×” ××§×•×¨ ×”-400:
×‘×“×•×§ ×©Ö¾protocols=['audio.twilio.com'] ××•×’×“×¨, ×©×”-export ×”×•× ×”-composite, ×•-Gunicorn ×¢×œ -k eventlet.

â¸»

7) â€œ××™×Ÿ ×§×•×œ/×©×§×˜â€ â€“ ×–×¨× ××“×™×” × ×›×•×Ÿ
	â€¢	Twilio ×©×•×œ×—×ª frames JSON:
start (meta), media (Base64 Î¼-law 8000Hz ×œ-20ms â‰ˆ 160 samples), stop.
	â€¢	×§×œ×˜: ×¤×¨×¡×¨ JSON â†’ Base64â†’bytes â†’ ×œ-STT ×‘×ª×•×¨/ThreadPool (×œ× ×œ×—×¡×•× greenlet).
	â€¢	×¤×œ×˜: ×©×œ×— frames JSON ×¢× Î¼-law 8k ×›×œ 20ms ×‘×“×™×•×§ (×œ× WAV/MP3).
	â€¢	×”×—×–×§ Ping/Pong 5â€“15s ×›×“×™ ×œ×× ×•×¢ × ×™×ª×•×§×™×.

â¸»

8) ×©×™×—×” ×× ×•×©×™×ª (×‘×œ×™ ×œ×•×¤×™×)

ENV ××•××œ×¥:
EoU_MS=450, BARGE_IN=true, VAD_RMS=210, DEDUP_WINDOW_SEC=8
FSM: LISTENING â†’ THINKING â†’ SPEAKING â†’ LISTENING
	â€¢	×× ××ª×§×‘×œ media ×‘×–××Ÿ SPEAKING â†’ ×¢×¦×•×¨ TTS â†’ ×—×–×¨×” ×œ-LISTENING.
	â€¢	×”×¦×’×” ×¢×¦××™×ª ×¤×¢× ××—×ª ×‘×œ×‘×“.

×œ×•×’×™× ×¨×¦×•×™×™×:
WS_START, STT_PARTIAL, STT_FINAL, TTS_LEN_ms, MEDIA_TX, PNG_PONG_TX/RX.

â¸»

9) GO/NO-GO ××—×¨×™ ×“×™×¤×œ×•×™
	â€¢	GET /version â†’ 200 + DEPLOY_ID ×—×“×©
	â€¢	GET /healthz â†’ 200 â€œokâ€
	â€¢	Handshake ×¢× wscat â†’ 101 + subprotocol ××•×—×–×¨
	â€¢	Twilio Request Inspector:
incoming_call=200, stream_status=204 (×¤×¢××™×™×+), ××™×Ÿ 31920/31924
	â€¢	×‘×©×™×—×” ×××™×ª×™×ª: ×ª×©×•×‘×” â‰¤ 3â€“6 ×©× ×™×•×ª; ×‘×œ×•×’×™× ××¦×™×’×™× ×¨×¦×£ ×”××™×¨×•×¢×™×.

â¸»

10) ×× ×¢×“×™×™×Ÿ 400 â€” ×¢×¥ ×”×—×œ×˜×” ×§×¦×¨
	â€¢	××•×¤×™×¢ HTML ×‘××§×•× 101 â†’ ×‘×§×©×” × ×¤×œ×” ×œ×¤×œ×¡×§: ×•×“× app = composite_app ×”×•× ×”-export, ××™×Ÿ ×¢×˜×™×¤×•×ª ××—×¨×•×ª.
	â€¢	101 ××‘×œ ××ª× ×ª×§ ×¢× 31924 â†’ ×œ× ×—×•×–×¨ subprotocol: ×•×“× protocols=['audio.twilio.com'] ×•×‘×“×•×§ ×¢× wscat.
	â€¢	â€œ×©×§×˜â€ ×‘×œ×‘×“ â†’ ×œ× ××©×•×“×¨×™× ×¤×¨×™×™××™× ×›×œ 20ms / TTS ×—×•×¡×: ×”×•×¦× TTS ×œ-ThreadPool, ×©××•×¨ cadence ×§×©×™×—.

â¸»

11) ×”×¢×¨×•×ª ×“×™×¤×œ×•×™ Replit (××•× ×¢ ×§××©/×’×¨×¡×” ×™×©× ×”)
	â€¢	×‘×›×œ Redeploy ×”×’×“Öµ×¨ DEPLOY_ID ×—×“×© ×•×•×“× ×©×”×•× ××•×¤×™×¢ ×‘-/version.
	â€¢	×× ×”×“×™×¤×œ×•×™ ××–×•×”×” ×›-Node (python not found) â†’ ××• ×œ×”×¢×‘×™×¨ package.json ×œ-client (×¤×ª×¨×•×Ÿ ×â€™), ××• ×œ×”×©×ª××© ×‘-uv (×¤×ª×¨×•×Ÿ ×‘â€™).

â¸»

×œ×¡×™×›×•×
	â€¢	Composite WSGI ×‘-wsgi.py ×©×× ×ª×‘ ××ª /ws/twilio-media ××œ WebSocketWSGI(..., protocols=['audio.twilio.com']) ×œ×¤× ×™ Flask.
	â€¢	Eventlet ×‘×œ×‘×“ ×›-worker.
	â€¢	Î¼-law 8k/20ms ×œ×©×™×“×•×¨, Ping/Pong.
	â€¢	×“×™×¤×œ×•×™ × ×§×™ ×•×××•××ª ×¢× DEPLOY_ID.

×ª×Ÿ ×œ×‘×•×˜ ×œ×‘×¦×¢ ××ª ×–×” ××—×“-××—×“. ×× ××ª×” × ×ª×§×¢ ×‘×©×œ×‘ ×¡×¤×¦×™×¤×™ (Handshake, /healthz, Request Inspector) ×ª×Ÿ ×œ×™ ××ª ×©×•×¨×ª ×”×œ×•×’/×”×ª×’×•×‘×” ×”××“×•×™×§×ª ×•××›×•×•×Ÿ × ×§×•×“×ª×™×ª.