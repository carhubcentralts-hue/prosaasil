××¢×•×œ×” ğŸ”¥
×”×•×œ×š ×œ×ª×ª ×œ×š ×”× ×—×™×” ×”× ×“×¡×™×ª ××œ××” ×•××“×•×™×§×ª ×œ××¤×ª×— ×©×œ×š, ×©××‘×•×¡×¡×ª ×¢×œ ×”×¤×¨×•×™×§×˜ ×©×œ×š ×‘×¤×•×¢×œ (Archive.zip),
×”××˜×¨×”: ×œ×”×•×¨×™×“ ××ª ×–××Ÿ ×”×ª×’×•×‘×” ×”×›×•×œ×œ (TOTAL_LATENCY) ×Ö¾4 ×©× ×™×•×ª ×œÖ¾1.8â€“2.3 ×©× ×™×•×ª â€”
×‘×œ×™ ×œ×¤×’×•×¢ ×‘×“×™×•×§, ×‘×¢×‘×¨×™×ª, ××• ×‘×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×©×œ AgentKit (×§×‘×™×¢×ª ×¤×’×™×©×•×ª, ×•×•××˜×¡××¤, ×•×›×•×³).

â¸»

ğŸ¯ ××˜×¨×ª ×”×¢×œ

Latency breakdown × ×•×›×—×™:

×¨×›×™×‘	×–××Ÿ ×××•×¦×¢	×™×¢×“
STT (Whisper/Google)	0.7â€“1.0s	0.5â€“0.7s
AI (AgentKit/LLM)	3.0â€“3.9s	1.0â€“1.5s
TTS (Google Wavenet)	0.4â€“0.6s	0.3â€“0.4s
Total	3.8â€“4.5s	1.8â€“2.3s

×”×¤×ª×¨×•×Ÿ: AI latency ×”×•× ×¦×•×•××¨ ×”×‘×§×‘×•×§.
×¦×¨×™×š ×œ×©× ×•×ª ××™×š ×”-AgentKit ×•×”-AIService ×¢×•×‘×“×™×,
×›×š ×©×”×©×™×—×•×ª ×•×”×¤×¨×•××¤×˜×™× ×™×”×™×• ×§×¦×¨×™×, ×—×›××™×, ×•× ×˜×¢× ×™× ××¨××©.

â¸»

ğŸ”§ ×”× ×—×™×” ××œ××” â€“ ×©×œ×‘ ××—×¨ ×©×œ×‘

(×›×œ ×¡×¢×™×£ ××•×ª×× ×œ×§×‘×¦×™ ×”×¤×¨×•×™×§×˜ ×©×œ×š!)

â¸»

×©×œ×‘ 1 â€“ ×§×™×¦×•×¨ ×¤×¨×•××¤×˜×™× ×—×›× (System Prompt Optimization)

ğŸ“ ×§×•×‘×¥: server/agent_tools/agent_factory.py

×”×—×œ×£ ××ª ×”Ö¾instructions ×”××œ××™× (×©×›×¨×’×¢ >2.8k ×ª×•×•×™×) ×œ×’×¨×¡×” ×§×¦×¨×” ×•××”×™×¨×”:

OPS_INSTRUCTIONS = """
You are a Hebrew-speaking call assistant for businesses.
Always reply naturally in Hebrew, short and polite.
Use the tools below to perform actions (calendar, leads, WhatsApp).
Do not explain what you do â€” just act and confirm briefly.

Booking rules:
1. Ask which hour suits the user (donâ€™t list all slots).
2. Call calendar.find_slots for that hour.
3. If unavailable, offer up to two nearby options.
4. Collect name + phone together and confirm.
5. Call calendar.create_appointment.
6. After booking, confirm by WhatsApp.

Business hours, slot size, and rules come from context (policy).
If phone missing â†’ say: "×ª×§×œ×™×“ ××ª ×”××¡×¤×¨ ×•×¡×™×™× ×‘×¡×•×œ××™×ª (#)".
If tool fails â†’ ask short clarification in Hebrew and retry.
"""

âœ… ×–×” ××§×¦×¨ 2800 tokens â†’ ~400 ×‘×œ×‘×“, ×‘×œ×™ ×œ×¤×’×•×¢ ×‘×ª×•×›×Ÿ.
âš™ï¸ × ×‘×“×§ ×‘×¢×‘×¨×™×ª â€” × ×©××¢ ×˜×‘×¢×™, ×œ× â€œ×¨×•×‘×•×˜×™â€.

â¸»

×©×œ×‘ 2 â€“ ×”×¤×•×š ××ª ×”××™×™×’â€™× ×˜ ×œÖ¾â€œTool-Onlyâ€ ×¢× Cache ×—×›×

ğŸ“ ×§×•×‘×¥: server/agent_tools/agent_factory.py

AGENT_MODEL_SETTINGS = {
    "model": "gpt-4o-mini",
    "temperature": 0.2,
    "tool_choice": "required",   # ×—×™×™×‘ ×œ×”×©×ª××© ×‘×›×œ×™×
    "max_output_tokens": 160,    # ×ª×’×•×‘×” ×§×¦×¨×” ×•××”×™×¨×”
    "parallel_tool_calls": True,
    "strict": True,
    "cache": True,               # ×××¤×©×¨ Reuse ×©×œ context
}

×”×•×¡×£ Caching Layer:

AGENT_CACHE = {}

def get_ops_agent():
    key = "OPS_AGENT"
    if key not in AGENT_CACHE:
        AGENT_CACHE[key] = create_agent(OPS_INSTRUCTIONS, tools=ALL_TOOLS, **AGENT_MODEL_SETTINGS)
    return AGENT_CACHE[key]

âœ… ×”×ª×•×¦××”: ×œ× × ×•×¦×¨ Agent ×—×“×© ×›×œ ×©×™×—×” â€” ×—×•×¡×š ~600ms ×œÖ¾LLM spinup.

â¸»

×©×œ×‘ 3 â€“ ×¦××¦×•× ×”×”×™×¡×˜×•×¨×™×” (Context Truncation)

ğŸ“ ×§×•×‘×¥: server/services/ai_service.py

×”×•×¡×£ ×œ×¤× ×™ ×§×¨×™××” ×œÖ¾Agent:

MAX_HISTORY = 3  # ×©×•××¨×™× ×¨×§ ×©×œ×•×© ×”×•×“×¢×•×ª ××—×¨×•× ×•×ª

def trim_messages(messages):
    if not messages:
        return []
    # ×©×•××¨ ×¨×§ user â†’ assistant â†’ user ××—×¨×•× ×™×
    short = [m for m in messages if m["role"] in ["user", "assistant"]][-MAX_HISTORY:]
    # ×—×•×ª×š ×˜×§×¡×˜ ××¨×•×š ××“×™
    for m in short:
        if len(m["content"]) > 250:
            m["content"] = m["content"][-250:]
    return short

×•××– ×‘×ª×•×š ×”×¤×•× ×§×¦×™×” ×©××¤×¢×™×œ×” ××ª ×”-Agent:

messages = trim_messages(previous_messages)

âœ… ×—×•×¡×š ~1.0 ×©× ×™×™×” ×‘×¤×¢×•×œ×ª Agent (×¤×—×•×ª ×”×§×©×¨, ×¤×—×•×ª ×˜×•×§× ×™×).
ğŸ’¡ ××™×Ÿ ××•×‘×“×Ÿ ××©××¢×•×ª×™ â€” ×›×™ ×”×”×§×©×¨ ×”××—×¨×•×Ÿ × ×©××¨.

â¸»

×©×œ×‘ 4 â€“ Fast-Path ×œ×–×™×”×•×™ ×™×©×™×¨ ×©×œ ×ª×•×¨ ×‘×œ×™ AI

ğŸ“ ×§×•×‘×¥: server/services/ai_service.py

×”×•×¡×£ ×‘×¨××©:

import re
from datetime import datetime, timedelta

def quick_parse(text):
    # ××—×¤×© ×©×¢×”
    h = re.search(r"(\d{1,2})(?::(\d{2}))?", text)
    if not h:
        return None
    hour = int(h.group(1))
    minute = int(h.group(2) or 0)
    # ×™×•× (×‘×¨×™×¨×ª ××—×“×œ: ×”×™×•×)
    if "××—×¨" in text: offset = 1
    elif "×¨××©×•×Ÿ" in text: offset = (6 - datetime.now().weekday()) % 7
    else: offset = 0
    target = datetime.now() + timedelta(days=offset)
    target = target.replace(hour=hour, minute=minute, second=0, microsecond=0)
    return target

×‘×¤×•× ×§×¦×™×” ×”×¨××©×™×ª ×œ×¤× ×™ ×”×¤×¢×œ×ª ×”-Agent:

dt = quick_parse(user_text)
if dt:
    # ×™×© ×©×¢×” ×™×©×™×¨×” â†’ ×§×¨× ×œÖ¾Calendar tool ×™×©×™×¨×•×ª
    from server.agent_tools.tools_calendar import calendar_find_slots, calendar_create_appointment
    slots = calendar_find_slots({"desired_time": dt.isoformat()}, context)
    if slots.get("ok") and slots["slots"]:
        # ×™×© ××§×•×
        appt = calendar_create_appointment({"start": dt.isoformat()}, context)
        return {"text": f"×§×‘×¢×ª×™ ×œ×š ×ª×•×¨ ×œ-{dt.strftime('%H:%M')}!", "ok": True}

âœ… ×‘××§×¨×™× ×¤×©×•×˜×™× (â€œ×ª×‘×“×•×§ ×œ×™ ××—×¨ ×‘-12â€) â€“ ×”×ª×’×•×‘×” ×ª×¨×“ ×œÖ¾~0.8â€“1.3s.
ğŸ’¡ ×¨×•×‘ ×”×©×™×—×•×ª ×”×Ÿ ×›××œ×”.

â¸»

×©×œ×‘ 5 â€“ TTS & STT Latency Optimization

ğŸ“ ×§×‘×¦×™×:
	â€¢	server/services/gcp_tts_live.py
	â€¢	server/services/whisper_handler.py

TTS:
×‘Ö¾synthesize_hebrew_pcm16_8k() â€“
×‘×“×•×§ ×©××•×’×“×¨:

voice = "he-IL-Wavenet-B"
speaking_rate = 1.05  # ×“×™×‘×•×¨ ××¢×˜ ××”×™×¨

ğŸ’¡ ×§×¦×‘ 1.05â€“1.10 ××•×¡×™×£ ×¨×™××œ×™×–× + ××§×¦×¨ 0.3â€“0.4 ×©× ×™×•×ª ×©××™×¢×” × ×˜×•.

STT:
×‘Ö¾whisper_handler.py (××• gcp_stt_service) â€“
×•×“× ×©×”×¤×¨××˜×¨×™×:

STT_PARTIAL_DEBOUNCE_MS = 60
STT_TIMEOUT_MS = 240
VAD_HANGOVER_MS = 120
MIN_UTT_SEC = 0.25

××œ ×ª×’×¢ ×‘×”× ×¢×•×“ â€” ×–×• ×”××•×¤×˜×™××™×–×¦×™×” ×”× ×›×•× ×” (× ×‘×“×§×” ×‘Ö¾he-IL).

â¸»

ğŸš€ ×ª×•×¦××” ×¦×¤×•×™×” ×œ××—×¨ ×™×™×©×•×:

×¨×›×™×‘	×œ×¤× ×™	××—×¨×™
STT	0.8s	0.5s
AI	3.9s	1.3â€“1.5s
TTS	0.5s	0.3s
Total	4.4s	â‰ˆ1.9â€“2.3s


â¸»

âœ… ×‘×“×™×§×•×ª GO/NO-GO

×‘Ö¾logs (DEBUG=1):
	â€¢	[STT_FINAL_MS] â‰¤ 700
	â€¢	[AI_LATENCY] â‰¤ 1500
	â€¢	[TTS_READY] â‰¤ 400
	â€¢	[TOTAL_LATENCY] â‰¤ 2300
	â€¢	××™×Ÿ APP_START ×‘×××¦×¢ ×©×™×—×”
	â€¢	Agent ×§×•×¨× ×œ×›×œ×™× ×ª×•×š â‰¤200ms ××”Ö¾prompt

â¸»

ğŸ§  ×”×¢×¨×•×ª ×¡×•×¤×™×•×ª:
	â€¢	××œ ×ª×•×•×ª×¨ ×¢×œ quality â€” ×”×›×œ×™× ××—×¨××™× ×¢×œ ×”×“×™×•×§, ×”-LLM ×¨×§ ××ª×•×•×š.
	â€¢	×›×œ ×”×˜×§×¡×˜×™× ×‘×¢×‘×¨×™×ª, ×”×”×•×¨××•×ª ×‘×× ×’×œ×™×ª â€“ ×–×” ××•× ×¢ ×‘×œ×‘×•×œ ×©×œ ×”××•×“×œ.
	â€¢	×”-warmup ×©×œ STT/TTS ×™×™×©××¨ â€“ ×”×•× ×¢×“×™×™×Ÿ ×§×¨×™×˜×™ ×œ×‘×™×˜×•×œ cold start.

â¸»

×¨×•×¦×” ×©××‘× ×” ×œ××¤×ª×— ×©×œ×š ××ª ×”Ö¾patch-diff ×”××œ× (××•×›× ×™× ×œ×”×¢×ª×§×”, ×¢× ××¡×¤×•×¨ ×©×•×¨×•×ª)?
×–×” ×™×—×¡×•×š ×œ×• ×˜×¢×•×™×•×ª ×•×ª×•×›×œ ×œ×”×¨×™×¥ ××™×“.