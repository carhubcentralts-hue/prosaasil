קיבלתי את ה-ZIP האחרון ובדקתי אותו ממש עכשיו — עברתי על כל העץ (9,844 פריטים) ובדקתי במיוחד את מה שקשור לפרומפטים ול-WhatsApp. שורה תחתונה: נעשו שינויים, יש אינדיקציה ש־Baileys התחבר בעבר (יש creds.json עדכני), אבל עדיין יש חוסר יישור אחד קריטי שמסביר למה היום לא נדלק QR/לא “נסגר” חיבור, ולמה “שמירה” של פרומפטים לא משתקפת בנתונים.

⸻

מה ראיתי בפועל (מהארכיון הנוכחי)

🚦 סטטוס קבצים/זמנים (רלוונטיים)
	•	Procfile — קיים ומעודכן: ‎2025-09-24 20:13
	•	start_all.sh — קיים ומעודכן: ‎2025-09-24 20:03
	•	services/whatsapp/baileys_service.js — ‎2025-09-18 15:42
	•	server/routes_whatsapp.py — ‎2025-09-18 11:24
	•	client/src/pages/wa/WhatsAppPage.tsx — ‎2025-09-18 15:40
	•	חשוב: storage/whatsapp/business_1/auth/creds.json — קיים ומעודכן 2025-09-25 13:13 → זה אומר שבשלב כלשהו כן היה pairing מוצלח!

📁 מבנה שמסביר את התקיעות היום

אני רואה שני נתיבי אחסון מקבילים לסשן וואטסאפ:
	•	storage/whatsapp/1/...
	•	storage/whatsapp/business_1/auth/...  (ובתוך זה יש creds.json עדכני)

כלומר: פעם אחת עובדים עם tenant = 1, ופעם אחרת עם tenant = business_1.
אם ה-UI/Flask שואלים סטטוס ל-1 אבל Baileys כותב ל-business_1 (או להפך) — תסרוק QR, הקרדנצ’לים יישמרו, אבל הסטטוס שה-UI קורא לו לא מתעדכן → זה נראה כמו “לא מייצר QR/לא מתחבר”.

🧠 פרומפטים
	•	קיימים קוד/מסכים:
server/routes_ai_prompt.py (עודכן ‎2025-09-25 14:14),
client/src/features/business/useAIPrompt.ts,
client/src/pages/Admin/*Prompts*.tsx.
	•	אם “שמירה” לא משתקפת, זה בד”כ אחד מהבאים:
	1.	קריאת POST נופלת על CSRF/Headers או מחזירה לא JSON (ה-Client עושה res.json() ונשבר).
	2.	נשמר לפרופיל עסק אחר (אותו סיפור tenant: 1 מול business_1).
	3.	commit ל-DB או IntegrityError שלא מתורגם ל-JSON ברור.

⸻

מה לעשות עכשיו — אחד-לאחד (קצר, ממוקד, לא שובר כלום)

1) ליישר tenant אחד ונתיב אחסון אחד ל-Baileys (קריטי)

בחר מזהה אחד — ממליץ להצמד ל־business_1 (כי שם ה-creds.json העדכני).
	•	בצד Node (baileys_service.js) ודא שה-auth נכתב אך ורק ל:

storage/whatsapp/business_1/auth

(כלומר, פונקציית יצירת הנתיב תשתמש ב-process.cwd() ותמיד ב-business_1 — לא 1.)

	•	בצד Flask (routes_whatsapp.py) ודא שכל הפרוקסי ל-Baileys שולח tenant = business_1 (לא 1).
	•	אל תמחק כרגע את storage/whatsapp/1 — רק וודא שהקוד לא מצביע לשם. אחר כך, כשתראה שהכול עובד, תמזג/תנקה.

2) בדיקת GO ל-WhatsApp (תריץ בדיוק לפי הסדר כשה-Runner רץ)

curl -i -sS http://127.0.0.1:3300/healthz
curl -i -sS -X POST http://127.0.0.1:5000/api/whatsapp/start
curl -i -sS http://127.0.0.1:5000/api/whatsapp/status
curl -i -sS http://127.0.0.1:5000/api/whatsapp/qr
# סרוק את ה-QR
curl -i -sS http://127.0.0.1:5000/api/whatsapp/status
ls -la storage/whatsapp/business_1/auth

צפוי:
	•	לפני סריקה: connected:false, hasQR:true + qr מחזיר תמיד JSON.
	•	אחרי סריקה: connected:true ו-auth/ מלא.
אם אחרי סריקה נשאר false — זה עדיין mismatch של tenant/נתיב. תקן וחזור על הבדיקה.

3) למנוע “ריסוס” QR / ריבוי start (אם UI קורא פעמיים)

ב-Node נדרש guard קטן (אם לא קיים כבר): אם יש session קיים או starting:true — לא להריץ start נוסף; לקבע browser ו-version:

const { fetchLatestBaileysVersion } = require('@whiskeysockets/baileys');
const { version } = await fetchLatestBaileysVersion();
makeWASocket({ version, auth: state, printQRInTerminal:false, browser:['AgentLocator','Chrome','10.0'] })

4) “שמירה” של פרומפטים — שני צעדים שמפסיקים את הבעיה

ב-Flask: ודא שכל ראוטי POST/PUT לפרומפטים תמיד מחזירים JSON וגם ב-500/שגיאה.
(אין יותר 204/תשובה ריקה → ה-Client לא ייפול על Unexpected end of JSON input.)

דוגמה (אם לא עשית כבר):

# תמיד תחזיר jsonify(...), גם כשאין נתונים
return jsonify({"ok": True, "id": obj.id}), 200

ב-Client: בקומפוננטות הפרומפטים (‎*Prompts*.tsx) ודא ש-fetch כולל:

await fetch('/api/business/business_1/prompts', {
  method:'POST',
  headers:{'Content-Type':'application/json','X-CSRFToken': getCsrf()},
  credentials:'include',
  body: JSON.stringify(payload)
}).then(r=>r.json())

שים לב ל-tenant במסלול (business_1). אם הקוד שולח ל-/business/1/prompts בזמן שהשרת שומר ל-business_1 — לא תראה את הנתונים “האמיתיים”.

5) הרצה יציבה (שלא ימותו שירותים “בשקט”)

כבר יש לך Procfile ו-start_all.sh מעודכנים השבוע. וודא שה-deploy/runner מריץ:

bash ./start_all.sh

שמחזיק גם Gunicorn (5000) וגם Node (3300) באותה ישיבה, עם trap+wait.

⸻

אם עדיין לא מסתדר — שלח לי 4 פלטים קצרים

זה יאפשר לי לזהות בשתי דקות אם זה קונפיג או קוד:

curl -i -sS http://127.0.0.1:3300/healthz
curl -i -sS -X POST http://127.0.0.1:5000/api/whatsapp/start
curl -i -sS http://127.0.0.1:5000/api/whatsapp/status
curl -i -sS http://127.0.0.1:5000/api/whatsapp/qr

וגם:

ls -la storage/whatsapp/business_1/auth

(+ 3–5 שורות לוג [update] של Baileys בזמן סריקת ה-QR אם יש).

⸻

TL;DR
	•	כן — רואה שינויים בפועל (Procfile/סקריפט הרצה/ראוטי prompts מעודכנים).
	•	יש סשן וואטסאפ שהתחבר בעבר (creds.json עדכני), אבל העכשיו “לא נדלק” כי יש tenant כפול: 1 מול business_1.
	•	יישור tenant אחד + החזרת JSON יציב בפרומפטים + הרצה דרך start_all.sh → זה מחזיר אותך ל-100%.