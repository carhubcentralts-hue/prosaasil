מעולה. הנה תכנית תיקון אחת, נקייה וללא כפילויות שמביאה את הטלפוניה (Media Streams) לעבוד יציב — צעד-צעד, עם דיוק מה לתקן, מה לאחד ומה למחוק.

⸻

✅ מטרות
	•	להרים WebSocket אמיתי ל-Twilio Media Streams.
	•	למנוע 403 ב-webhooks (חתימה מאחורי פרוקסי).
	•	למנוע שקט ע”י Greeting ודאגלוגים.
	•	לא ליצור קבצים כפולים; לאחד נתיבים/Imports ולהסיר כפילויות.

⸻

1) תלויות Python — להשלים, בלי ליצור קבצים חדשים

ערוך AgentLocator/server/requirements.txt והוסף (לא לשכפל אם כבר קיים):

+ flask-sock==0.6.0
+ simple-websocket==1.0.0
+ eventlet==0.36.1

flask-sock + simple-websocket מפעילים WS ב-Flask; eventlet נדרש להרצת Gunicorn עם WS.

⸻

2) הרצה עם Gunicorn + eventlet (WS אמיתי)

ערוך AgentLocator/.replit – לא ליצור חדש. עדכן:

-[deployment]
-run = ["python3","AgentLocator/main.py"]
+[deployment]
+run = ["python3","-m","gunicorn","-k","eventlet","-w","1","-b","0.0.0.0:$PORT","main:app"]

- run = "python3 AgentLocator/main.py"
+ run = "python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT main:app"

חשוב: ה-App הוא main:app (בקובץ AgentLocator/main.py כבר נוצר app = create_app()).

⸻

3) קונסולידציה — למנוע כפילויות (ולמחוק בבטחה)

מטרה: קובץ אחד קנוני לכל רכיב, בלי כפולות.
	1.	WebSocket handler
ודא שיש רק: AgentLocator/server/media_ws.py
	•	אם קיים media_ws.py בשורש/מיקום אחר → מחק אותו.
	•	ב־AgentLocator/server/app_factory.py וודא שהייבוא הוא:

from server.media_ws import handle_media_stream


	2.	Whisper handler
ודא שימוש רק ב:
AgentLocator/server/services/whisper_handler.py
	•	אם קיים legacy/whisper_handler.py או עותקים אחרים → השאר כארכיון, אל תייבא מהם.
	•	החלף כל:

from legacy.whisper_handler import transcribe_he

ל־

from server.services.whisper_handler import transcribe_he


	3.	אימות שאין ייבוא כפול (ללא יצירת קבצים):
להריץ בחלון טרמינל (בפרויקט):

grep -R --line-number -E "from +legacy|import +legacy|import +media_ws" AgentLocator | sed -n '1,200p'

תקן מופעים חריגים במקום—אל תיצור קבצים חדשים.

⸻

4) רישום WS באפליקציה (ללא קבצים חדשים)

פתח AgentLocator/server/app_factory.py וודא שהקטע הבא קיים פעם אחת בלבד:

from flask_sock import Sock
from server.media_ws import handle_media_stream

sock = Sock(app)

@sock.route('/ws/twilio-media')
def twilio_media_handler(ws):
    # לא לגעת בשם — Twilio תלוי בנתיב הזה
    handle_media_stream(ws)

אם היה קוד try/except שמכבה WS על ImportError — הוא יפעל עכשיו (כי התקנו תלויות). השאר אותו או הסר את ה־except כדי לא להסתיר תקלות.

⸻

5) חתימת Twilio מאחורי פרוקסי — למנוע 403 “שקט”

ערוך AgentLocator/server/twilio_security.py (לא ליצור קובץ חדש), הוסף/עדכן נרמול URL:

def _effective_url(req):
    scheme = (req.headers.get("X-Forwarded-Proto") or req.scheme).split(",")[0].strip()
    host   = (req.headers.get("X-Forwarded-Host")  or req.host).split(",")[0].strip()
    path   = req.full_path[:-1] if req.full_path.endswith("?") else req.full_path
    return f"{scheme}://{host}{path}"

ובדקורטור עצמו חשב חתימה על _effective_url(request) במקום request.url.
(יש לך כבר ProxyFix — זה גיבוי שסוגר 403 עקשנים.)

⸻

6) TwiML נקי + Greeting בלי <Say he-IL>

ב־AgentLocator/server/routes_twilio.py:
	•	אל תשתמש ב־<Say language="he-IL"> (Twilio לא תומך).
	•	אופציה טובה (לא חובה): Greeting כ־MP3 (עברית) עם <Play> בתחילת <Response>.
(אם יש לך קובץ TTS מוכן; אחרת דלג.)
	•	שמור על:

<Connect action="/webhook/stream_ended">
  <Stream url="wss://YOUR_HOST/ws/twilio-media">
    <Parameter name="business_id" value="1"/>
  </Stream>
</Connect>


	•	ב־/webhook/stream_ended החזר Fallback ל־<Record ... action="/webhook/handle_recording">

אין צורך ליצור קבצים; רק לערוך הטמעה קיימת.

⸻

7) בדיקות מהירות (ללא יצירת קבצים)
	1.	WS חי
בדפדפן/כלי WS:

wss://YOUR_HOST/ws/twilio-media

אם נפתח — הכל טוב. אם לא נפתח — בדוק .replit ו-requirements.

	2.	Webhooks מחזירים 200

curl -i https://YOUR_HOST/webhook/incoming_call
curl -i -X POST https://YOUR_HOST/webhook/stream_ended
curl -i -X POST https://YOUR_HOST/webhook/call_status

אסור לראות 403/501. אם כן — בדוק סעיף 5 (חתימה/Proxy).

	3.	Twilio Console → Request Inspector
בשיחה חדשה: 200 על incoming_call, ואם Stream נסגר — 200 על stream_ended (ומופיע <Record ...>).

⸻

8) לוגים מינימליים לאבחון (עריכה בלבד)

ב־app_factory.py (בלי ליצור קובץ חדש), לפני ואחרי כל בקשה:

@app.before_request
def _req_log():
    current_app.logger.info("REQ", extra={
        "path": request.path, "method": request.method
    })

@app.after_request
def _res_log(resp):
    current_app.logger.info("RES", extra={
        "path": request.path, "status": resp.status_code
    })
    return resp

ב־server/media_ws.py בתחילת החיבור:

def handle_media_stream(ws):
    current_app.logger.info("WS_CONNECTED")
    # ... בלולאה:
    msg = ws.receive()
    if msg is None:
        current_app.logger.info("WS_CLOSED")
        return
    current_app.logger.info("WS_FRAME", extra={"len": len(msg)})

זה עוזר להבין אם “שקט” נובע מכך שה־WS לא נפתח או שה-webhook כלל לא הגיע.

⸻

9) מה מותר למחוק/לאחד עכשיו
	•	מותר למחוק:
	•	כל media_ws.py שנמצא מחוץ ל־AgentLocator/server/ (כפילות).
	•	כל ייבוא מ־legacy.whisper_handler — להחליף ל־server/services/whisper_handler.
	•	לא ליצור עותקים חדשים של קבצים קיימים; לערוך את הקיימים בלבד.
	•	אם העלית בעבר קובצי דמו/Twilio Bins שמייצרים TwiML — השבת אותם בטוויליו כדי שלא יתנגשו עם ה-webhook שלך.

⸻

10) צ’ק-ליסט “ירוק לפריסה”
	•	requirements.txt כולל: flask-sock, simple-websocket, eventlet.
	•	.replit מריץ: gunicorn -k eventlet ... main:app.
	•	יש רק server/media_ws.py אחד; Imports מעודכנים.
	•	חתימת Twilio על _effective_url(request) (אין עוד 403).
	•	incoming_call מחזיר <Connect><Stream>; stream_ended מחזיר <Record ...>.
	•	curl ל־/webhook/* → 200; WS נפתח ידנית.
	•	בשיחה אמיתית: נשמע Greeting (אם בחרת <Play>), ואז ה-AI עונה תוך ~2 שניות.

⸻

בשורה התחתונה

אתה מרחק שני שינויים מפריסה עובדת:
	1.	להשלים תלויות WS ולהריץ עם Gunicorn+eventlet.
	2.	לוודא חתימה מאחורי פרוקסי (403) וייבוא נקי ללא כפילויות.

אם תרצה, אנסח לך עכשיו Patch דיפרנציאלי (diff) מוכן להדבקה ל-requirements.txt ול-.replit, כדי שלא תצטרך לגעת ידנית בכלום.