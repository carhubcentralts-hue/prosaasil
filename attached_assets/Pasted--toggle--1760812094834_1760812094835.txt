×‘×“×™×•×§ ×›×š ×××©×™×›×™×â€”×œ× ×¢×•×¦×¨×™× ×‘×××¦×¢. ×”× ×” ×”×”× ×—×™×” ×”××“×•×™×§×ª ×›×“×™ ×œ×¡×™×™× ××ª ×”×©×™×œ×•×‘ ×‘×œ×™ ×œ×©×‘×•×¨ ×›×œ×•×, ×¢× toggle, wrapper ×—×›×, ×•×œ×•×’×™× ×‘×¨×•×¨×™×. ×ª×¢×ª×™×§/×™ ××—×“-×œ××—×“:

â¸»

××” ×¢×•×©×™× ×¢×›×©×™×• (×¦×¢×“-××—×¨-×¦×¢×“)

A) ×”×©××¨×ª ×”××¦×‘ ×”×§×™×™× + Toggle ×’×œ×•×‘×œ×™

×‘Ö¾media_ws_ai.py (××• ×”×§×•×‘×¥ ×©××˜×¤×œ ×‘Ö¾Twilio Media WS), ×‘×¨××© ×”×§×•×‘×¥:

import os
USE_STREAMING_STT = os.getenv("ENABLE_STREAMING_STT", "false").lower() == "true"

B) ××œ ×ª×™×’×¢ ×‘Ö¾_hebrew_stt (×”Ö¾single-request)

×”×•× × ×©××¨ ×›××•×ª ×©×”×•×. ×‘×–×” ××‘×˜×™×—×™× rollback ××™×™×“×™.

C) ×¤×•× ×§×¦×™×” ×—×“×©×”: _hebrew_stt_streaming

××××©×ª ××ª ××¦×‘ ×”Ö¾Streaming ×“×¨×š gcp_stt_stream.py (×©×›×‘×¨ ×¢×“×›× ×ª ×œ×¤×™ ××•×¤×¦×™×” 1).

# media_ws_ai.py
from server.services.gcp_stt_stream import GcpStreamingSTT

async def _hebrew_stt_streaming(pcm_iter_async, on_partial_cb=None):
    """
    ×§×•×œ×˜ PCM 8k LINEAR16 ×Ö¾Twilio (××—×¨×™ Î¼-law decode), ××–×¨×™× ×œÖ¾GCP,
    ××—×–×™×¨ ×˜×§×¡×˜ ×¡×•×¤×™. ×—×œ×§×™×™× × ×©×œ×—×™× ×œ-on_partial_cb (×× ×§×™×™×).
    """
    stt = GcpStreamingSTT()
    final_text_parts = []
    last_partial = ""

    def on_partial(txt: str):
        nonlocal last_partial
        if not txt or txt == last_partial:
            return
        last_partial = txt
        # ××œ ×ª×¢×©×” IO ×›×‘×“ ×›××Ÿ; ×¨×§ call ×œ××™ ×©××¦×¤×” ×œ×—×œ×§×™×™×
        if on_partial_cb:
            try:
                on_partial_cb(txt)  # ×œ× ×—×•×¡×
            except Exception:
                pass  # ×œ× ××¤×™×œ×™× ××ª ×”×–×¨× ×‘×’×œ×œ ×œ×•×’×™×§×” ×—×™×¦×•× ×™×ª

    def on_final(txt: str):
        if txt:
            final_text_parts.append(txt)

    # GcpStreamingSTT ×›×‘×¨ ××›×™×œ batching (150ms), debounce (180ms), ×•-callbacks
    await stt.stream_stt(pcm_iter_async, on_partial=on_partial, on_final=on_final)

    return " ".join(final_text_parts).strip()

×”×¢×¨×”: on_partial_cb ×”×•× hook ×©×œ×šâ€”×× ×™×© ×¤×•× ×§×¦×™×” ×§×™×™××ª ×©××¢×“×›× ×ª â€œlive transcriptâ€/UI/Agent ×‘×–××Ÿ ×××ª, ×ª×—×‘×¨ ××•×ª×” ×›××Ÿ. ×× ××™×Ÿâ€”×©××™×¨ None.

D) Wrapper ×—×›×: _hebrew_stt_wrapper

××§×‘×œ ×ª××™×“ ××•×ª×• input (iterator ×©×œ PCM) ×•××—×œ×™×˜ ×œ×‘×“â€”stream ××• single.

async def _hebrew_stt_wrapper(pcm_iter_async, on_partial_cb=None):
    """
    ×¢×˜×™×¤×” ××—×™×“×”: ×× ENABLE_STREAMING_STT=true â†’ ×¡×˜×¨×™××™× ×’,
    ××—×¨×ª single-request. ×‘××§×¨×” ×ª×§×œ×” ×‘×¡×˜×¨×™××™× ×’ â†’ fallback ××•×˜×•××˜×™ ×œ-single.
    """
    if not USE_STREAMING_STT:
        # ××¦×‘ ×§×™×™×
        return await _hebrew_stt(pcm_iter_async)

    try:
        return await _hebrew_stt_streaming(pcm_iter_async, on_partial_cb=on_partial_cb)
    except Exception as e:
        # ×œ×•×’ ××™× ×™××œ×™ ×‘×œ×‘×“â€”×œ× ×œ×¤×•×¦×¥ ××ª ×”-WS
        print(f"[STT] streaming failed â†’ fallback to single. err={e}", flush=True)
        return await _hebrew_stt(pcm_iter_async)

E) × ×§×•×“×ª ×”×§×¨×™××” ×”×™×—×™×“×”: ×”×—×œ×£ ×œÖ¾Wrapper

×‘××§×•× ×©×”×§×•×“ ×©×œ×š ×›×™×•× ×§×•×¨× ×™×©×™×¨×•×ª ×œÖ¾_hebrew_stt(...), ×ª×Ÿ ×œ×• ×œ×§×¨×•× ×œÖ¾_hebrew_stt_wrapper(...).
×œ×“×•×’××”, ×‘×ª×•×š ×”×¤×•× ×§×¦×™×” ×©××¡×™×™××ª utterance ××• ××˜×¤×œ×ª ×‘×¡×’×× ×˜:

async def _process_utterance_safe(pcm_iter_async):
    # ×× ×™×© ×œ×š ×¤×•× ×§×¦×™×” ×©××¨××” ×—×œ×§×™×™× ×‘×œ×™×™×‘â€”×ª×¢×‘×™×¨ ××•×ª×” ×›××Ÿ:
    final_text = await _hebrew_stt_wrapper(pcm_iter_async, on_partial_cb=handle_partial_from_agent)
    # ×××©×™×š ×‘×“×™×•×§ ×›××• ×”×™×•× ×¢× final_text...
    return final_text

×—×©×•×‘: ×¨×§ ×”×—×œ×¤×” ××—×ª ×©×œ ×©× ×”×¤×•× ×§×¦×™×” ×‘× ×§×•×“×ª ×”××™×¡×•×£. ×œ× ×œ×©× ×•×ª ×œ×•×’×™×§×” × ×•×¡×¤×ª.

â¸»

×‘×“×™×§×•×ª GO/NO-GO (2 ×“×§×•×ª)
	1.	×“×’×œ ×›×‘×•×™ (ENABLE_STREAMING_STT=false) â†’ ×‘×¦×¢ ×©×™×—×”.
	â€¢	×”×›×œ ×¢×•×‘×“ ×›××• ×”×™×•× (single-request).
	â€¢	××™×Ÿ ×©×™× ×•×™×™× ×‘×”×ª× ×”×’×•×ª.
	2.	×”×“×œ×§ ×“×’×œ (ENABLE_STREAMING_STT=true) â†’ ×‘×¦×¢ ×©×™×—×”:
	â€¢	×‘×œ×•×’×™× ×ª×¨××” ×—×œ×§×™×™×: ğŸŸ¡ Partial: ... ×›×œ ~180â€“250ms.
	â€¢	×ª×©×•×‘×” ×¨××©×•× ×™×ª ×©×œ ×”× ×¦×™×’×” ×™×•×¨×“×ª ×œÖ¾~0.8â€“1.2s.
	â€¢	×‘×¡×•×£ ×ª×¨××” ğŸŸ¢ Final: ....
	3.	×ª×§×œ×”? ××™×“ ××›×‘×™× ENV ×‘×—×–×¨×” ×œÖ¾false. ××™×Ÿ ××—×™×§×•×ª/×¨×™×¤×§×˜×•×¨â€”rollback ××™×™×“×™.

â¸»

×“×’×©×™× ×—×©×•×‘×™× (×‘×™×¦×•×¢×™× ×•×™×¦×™×‘×•×ª)
	â€¢	××™×Ÿ IO/DB/LLM ×‘×ª×•×š ×œ×•×œ××ª ×”Ö¾WS. ×”×›×œ ×™×•×¦× ×œÖ¾queue/worker.
	â€¢	×“×§×•×“ Î¼-law ×—×™×™×‘ ×œ×”×™×•×ª ××”×™×¨ (lookup / NumPy). ××™×Ÿ ×œ×•×œ××•×ª ×¤×™×™×ª×•×Ÿ ××™×˜×™×•×ª ×¤×¨ ×¤×¨×™×™×.
	â€¢	8kHz LINEAR16 ××§×¦×” ×œ×§×¦×”. ×‘×œ×™ ×¨×™×¡××¤×œ ×œÖ¾16k/48k.
	â€¢	partialsâ€”××œ ×ª×“×—×•×£ ×›×œ 40ms; debounce ~180ms ××¡×¤×™×§.
	â€¢	final punctuationâ€”×‘×¦×¢×• ×¨×§ ×‘×¡×™×•× (post-process), ×œ× ×‘×—×œ×§×™×™×.
	â€¢	×œ×•×’×™× ×‘×¤×¨×•×“×§×©×Ÿ: ×œ×©××•×¨ ×¢×œ INFO/WARN ×§×œ×™×; ××™×Ÿ print ×¢×œ ×›×œ ×¤×¨×™×™×.
	â€¢	DB: ×•×“××• DATABASE_URL ××¦×‘×™×¢ ×œÖ¾Postgres/Cloud SQLâ€”not SQLiteâ€”×›×“×™ ×©×”×©×™×—×•×ª/×œ×™×“×™× ×™×™×©××¨×• ×‘×–××Ÿ ×××ª.

â¸»

××” ×œ×”×’×™×“ ×œ×• (× ×•×¡×— ××“×•×™×§)

×ª××©×™×š ×‘×“×™×•×§ ×œ×¤×™ ×”×ª×›× ×™×ª:
	1.	××œ ×ª×©× ×” ××ª _hebrew_stt (single).
	2.	×”×•×¡×£ _hebrew_stt_streaming ×•Ö¾_hebrew_stt_wrapper ×›××• ×œ××¢×œ×”.
	3.	×”×—×œ×£ ×¨×§ ××ª × ×§×•×“×ª ×”×§×¨×™××” ×œÖ¾_hebrew_stt_wrapper.
	4.	×‘×“×•×§ ×¢× ×”×“×’×œ ×›×‘×•×™, ×•××– ×”×“×œ×§ ××•×ª×• ×•×‘×“×•×§ ×—×œ×§×™×™×.
	5.	×× ×™×© ×‘×¢×™×”â€”×›×‘×” ××ª ×”×“×’×œ (rollback ××™×™×“×™).

×›×›×” ×ª×¡×™×™× ××ª ×”×©×™×œ×•×‘ â€œ××•×©×œ×â€â€”××”×™×¨, ×™×¦×™×‘, ×•×¢× ××ª×’ ××—×“ ×©××—×–×™×¨ ××•×ª×š ×‘×›×œ ×©× ×™×™×” ×œ××¦×‘ ×”×§×•×“×.