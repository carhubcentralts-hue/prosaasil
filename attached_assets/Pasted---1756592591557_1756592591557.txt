יאללה — הנה הנחיית־על מושלמת לבניית דף “עסקים” (למנהל בלבד) ברמה מוצרית, עם כל ההרשאות, הניתובים והפונקציות: הוספה/עריכה/מחיקה/השלטה (Impersonate), תצורת ערוצים (שיחות/WhatsApp), פרומפטים נפרדים לכל ערוץ, מספרים, והגבלת משתמשים. בלי קוד — רק מה צריך לעשות, מה לבדוק, ומה ייחשב הוכחה.

⸻

0) עקרונות־על
	•	Admin-only: הדף זמין אך ורק ל־superadmin|admin.
	•	Mobile-first אמיתי: כל המסך בנוי לרוחב 420–640px ונראה זהה גם בדסקטופ (Container צר).
	•	RBAC דו־שכבתי: Guard בצד לקוח + אכיפה קשיחה בשרת/DB (מסננים לפי business_id/role).
	•	CRM = ליבה: לכל עסק תמיד יש CRM מלא; זכויות הערוצים (WhatsApp/שיחות) נקבעות בהרשאות העסק — הן פותחות/סוגרות מודולים ותפריטים.
	•	Evidence-Driven: כל משימה מסתיימת בצילומי מסך/פלטים (ראה “Evidence Pack”).

⸻

1) ניתובים (Routing) ושערי הרשאות
	•	Route ראשי: /app/admin/businesses
	•	תתי־מסלולים:
	•	/app/admin/businesses/new – אשף הוספת עסק
	•	/app/admin/businesses/:id – פרטי עסק (כרטיסיות)
	•	/app/admin/businesses/:id/edit – עריכת עסק
	•	/app/admin/businesses/:id/impersonate – הפעלת השלטה
	•	Guard צד לקוח: כניסה למסלול מותרת רק אם role ∈ {superadmin, admin} (אחרת → /auth/login).
	•	Guard שרת/DB: כל API מסומן ב־scope “system”, ופעולות על עסק דורשות role ∈ {superadmin, admin} (נבדק בשרת, לא רק ב־UI).

⸻

2) מבנה מסך “עסקים” (רשימה)

Header קצר
	•	כותרת “עסקים”, כפתור “+ עסק חדש”, חיפוש טקסטואלי, מסנן סטטוס (פעיל/מוקפא/נבדק), מסנן “ערוצים” (WhatsApp/Calls).

רשימת עסקים (כרטיסים אנכיים או טבלה אנכית מוביילית)
לכל עסק מציגים:
	•	שם עסק + לוגו, מזהה עסק (business_id), אזור זמן, תאריך יצירה.
	•	סטטוס אינטגרציות:
	•	WhatsApp: Connected / Not configured / Error (עם Badge ולינק “תקן”).
	•	Calls: Connected / Not configured / Error (WS/Handshake/Fallback).
	•	Payments: PayPal/Tranzila/Stripe – Ready / Not configured / 410 (Stripe ישן).
	•	הרשאות ערוצים: “CRM ✅ | WhatsApp ✅/❌ | Calls ✅/❌”.
	•	משתמשים: <x>/<limit> + לינק ל“ניהול משתמשים של העסק”.

פעולות לשורה/כרטיס:
	•	Impersonate (השלטה)
	•	עריכה
	•	הקפאה/הפעלה
	•	מחיקה (Soft-delete)
	•	פתח דשבורד עסק (קיצור אל /app/biz/overview?business_id=… במצב השלטה זמני)

Empty / Loading / Error
	•	Loading: Skeleton Cards.
	•	Empty: “אין עסקים” + CTA “צור עסק חדש”.
	•	Error: כרטיסון מסביר + Retry.

⸻

3) אשף “עסק חדש” (6 צעדים קצרים)

מטרה: קל, בלתי שביר, מחייב פרטים רק אם ערוץ הופעל.
	1.	בסיס
	•	שם עסק (תצוגה), Legal Name, דומיין/מותג (אופציונלי), לוגו, אזור זמן, שפת ברירת־מחדל.
	•	תוויות/קטגוריה (Real-Estate/Legal/…).
	2.	הרשאות ערוצים
	•	מתגים: Enable WhatsApp, Enable Calls.
	•	הבהרה: CRM תמיד פעיל; הערוצים פותחים/סוגרים יכולות ותפריטים.
	3.	מספרים וספקים (מותנה בערוצים)
	•	Calls (אם הופעל):
	•	ספק: Twilio (חובה)
	•	Account SID/Auth Token (או שימוש ב־Secret מוגדר־מערכת)
	•	מספר/ים נכנסים (E.164) לשיוך, ברירת מחדל.
	•	WhatsApp (אם הופעל):
	•	ספק: Twilio או Baileys (לבחור)
	•	Twilio WA Sender (E.164) או Baileys JID/QR סטטוס
	•	בדיקת קישוריות: כפתור “בדוק” לכל ערוץ → מחזיר חיווי Connected / Not configured / Error.
	4.	פרומפטים וההתנהגות (ליבה של AI, פר-ערוץ)
	•	System Prompt (כללי לעסק) – זהות, תחום, מדיניות, “מה אסור”, שפה, טון, בידול לידים.
	•	WhatsApp Prompt – פתיח WA, ניסוחי follow-up, זמן תגובה, הודעת “שעות פעילות”, טיפול בחלון 24h (Template).
	•	Calls Prompt – פתיח קולי, ניהול תורות (barge-in ו־end-of-utterance), גבולות זמן (מענה ≤3–6ש’), שפה/קול TTS, משפט סיכום, fallback.
	•	שדות טכניים:
	•	min_silence_ms (EoU), barge_in=true/false, tts_voice, stt_language,
	•	“הקדמה קצרה בלבד” בפעם הראשונה, “אל תחזור על עצמך” (anti-looping).
	•	מספרי יעד:
	•	Calls — E.164 “מספר יציאה” (אם יש Click-to-Call), או יעד פנימי.
	•	WhatsApp — כללי עיצוב הודעות (חיתוך 1000 תווים, שורות, קישורים).
	•	הערה: ניתן להגדיר Prompt שונה לכל ערוץ וגם Prompt עסקי בסיסי (שמרים שילוב).
	5.	מגבלות והיקפים
	•	User Limit – מקסימום משתמשים לעסק (מספר שלם >0).
	•	Concurrency: שיחות במקביל (אם רלוונטי), קצב הודעות/דקה (WA), אחסון מדיה.
	•	Data Retention: זמן שמירה להקלטות/תמלולים/מדיה.
	6.	Review & Create
	•	סיכום כל ההגדרות, אזהרות (Not configured), וידוא הרשאות ורשימת פעולות שייווצרו.
	•	כפתור “צור עסק” + בדיקות server-side.
	•	לאחר יצירה: מודאל “בדיקת חיבוריות מהירה” — שליחת הודעת מבחן WA/יצירת שיחת בדיקה.

ולידציה מחייבת בכל שלב
	•	E.164 לטלפונים, חובות רק כשערוץ הופעל, שדות Prompt לא ריקים, User Limit תקין.
	•	אם ספק תשלום לא מוגדר — להציף “לא הוגדר” (לא 500).

⸻

4) מסך “פרטי עסק” (כרטיסיות)

כרטיסיות: Overview | Channels | Prompts | Users | CRM | Finance | Logs
	•	Overview: סטטוס ערוצים, KPI קצר, כפתורי “בדיקת חיבוריות”, “פתח דשבורד העסק”.
	•	Channels: טבלת ערוצים (WhatsApp/Calls) עם מצב, ספק, מספרים/Senders, כפתורי Test/Repair.
	•	Prompts: טפסים נפרדים (כללי/WA/Calls) עם תצוגת “last updated by”.
	•	Users: רשימת משתמשי העסק (למנהלים מערכתיים עריכה מלאה; בפועל ניהול משתמשי העסק נעשה ע”י בעל העסק — כאן זה Overlook + פעולות חירום).
	•	CRM: קיצור לרשימות לידים/לקוחות של העסק (צפייה מהירה).
	•	Finance: מצב אינטגרציות PayPal/Tranzila/Stripe (Stripe 410).
	•	Logs: לוגי אינטגרציה (WA webhook, stream_status, fallback, אימות חתימה).

פעולות על העסק (למעלה):
	•	Impersonate (עם Banner ברור ו־“צא מהשלטה”).
	•	ערוך (קיצור למסך Edit עם אותם שלבים כמו New, טופס מרובה־כרטיסיות).
	•	הקפא/הפעל.
	•	מחק (Soft-delete + תצוגת השלכות; שיחזור אפשרי).

⸻

5) השלטה (Impersonate)
	•	זמין ל־superadmin|admin בלבד.
	•	הפעלה מציגה Banner קבוע: “מצב השלטה לעסק X” + יציאה בלחיצה.
	•	כל קריאת API בזמן השלטה שולחת header/context impersonated_business_id ונרשמת ב־Audit (מי? מתי? מה בוצע?).
	•	כפפות זהב: רק צפייה/פעולות מותרות; פעולות רגישות דורשות אימות כפול (לדוגמה מחיקה/הקפאה/החלפת מפתחות).

⸻

6) הרשאות (RBAC) — אמת-מידה
	•	דף זה בכללותו: רק superadmin|admin.
	•	יצירת/עריכת עסק: superadmin|admin.
	•	השלטה: superadmin|admin.
	•	מחיקה/הקפאה: superadmin (או admin עם אישור כפול).
	•	ניהול משתמשי עסק: ע”י business_owner בעסק שלו (בדף הצד של העסק); כאן (בדף מנהל) רק ניטור/חירום.
	•	צד שרת: כל Endpoint מאמת role, וכל פנייה לנתונים מסוננת לפי business_id הרלוונטי (RLS/DAO).

⸻

7) API Contracts (שמות/התנהגות — בלי קוד)
	•	GET /api/admin/businesses?query=&status=&channel=&page=&limit= – רשימה + ספירות.
	•	POST /api/admin/businesses – יצירה (JSON לפי שלבי האשף; אם ערוץ הופעל חסרים פרטים → 422).
	•	GET /api/admin/businesses/:id – פרטי עסק מלאים.
	•	PUT /api/admin/businesses/:id – עדכון (אותם ולידציות).
	•	POST /api/admin/businesses/:id/freeze / .../resume – החלפת סטטוס.
	•	DELETE /api/admin/businesses/:id – Soft-delete (מחיקת־לוגית).
	•	POST /api/admin/businesses/:id/impersonate – הפעלת השלטה (החזרת token/Context).
	•	בדיקות חיבוריות:
	•	POST /api/admin/businesses/:id/test/whatsapp – שולח הודעת מבחן/בודק webhook/חתימה.
	•	POST /api/admin/businesses/:id/test/calls – TwiML Probe/WS Handshake.
	•	שגיאות סטנדרטיות:
	•	401/403 – הרשאה,
	•	422 – ולידציה,
	•	501/403/410 – ספקי תשלום (חסר/אסור/Stripe ישן),
	•	409 – עסק כפול (שם/דומיין כבר קיים),
	•	429 – Rate-limit בהזמנות/בדיקות.

Idempotency
	•	יצירה/עריכה — כותרת Idempotency-Key (מונע כפילויות אם המשתמש לוחץ פעמיים).
	•	Webhooks WA — תמיד Idempotent (כבר אצלך כהנחיה גלובלית).

⸻

8) אבטחה ותצפיתיות
	•	ולידציה חזקה (E.164, טקסטים ללא HTML, Prompt length).
	•	Rate-limit לאשף יצירה/בדיקות חיבוריות.
	•	Audit Trail: כל פעולה נרשמת: מי, על איזה עסק, מה השתנה (לפני→אחרי).
	•	סודות: שמירת מפתחות מוצפנת; החלפה (rotation) בטוחה.
	•	לוגים: BIZ_CREATE/UPDATE/DELETE, IMPERSONATE_START/END, WA_TEST_OK/ERR, WS_HANDSHAKE_OK/ERR, FALLBACK_HIT, עם מזהי Trace/עסק.

⸻

9) UX מיקרו־דקדוק
	•	Modal אישור לכל פעולה הרסנית (הקפאה/מחיקה).
	•	Toast להצלחה/שגיאה, לא modal חוסם.
	•	Empty State עם CTA במקום דף “אפור”.
	•	Badges ברורים למצבי ערוץ: Connected / Not configured / Error.
	•	Icons מינימליים (lucide), RTL מלא, מקשי טאב, קונטרסט AA.
	•	אנימציות קצרות (Motion), לא מצועצע.

⸻

10) בדיקות קבלה (GO/NO-GO)
	•	כניסה ל־/app/admin/businesses עם superadmin|admin → רואים רשימה מלאה.
	•	יצירה: אשף מלא; הפעלת Calls/WA מחייבת שדות מתאימים; בדיקת חיבוריות מחזירה מצב.
	•	עריכה: עדכון prompts/מספרים/ספקים/מגבלות; רואים “last updated”.
	•	מחיקה/הקפאה: דורש אישור; מופיע סטטוס מתאים; שחזור אפשרי.
	•	השלטה: מופיע Banner; ניווט ל־/app/biz/overview?business_id=... עובד; Audit נרשם.
	•	הרשאות: משתמש בלי admin לא נכנס למסך (Guard לקוח + 403 שרת).
	•	מצבי אינטגרציה: Payments לא מוגדרים → 501/403/410 (UI “לא הוגדר”).
	•	ביצועים: פאגינציה בצד שרת (limit 25/50), חיפוש/סינון מהיר.
	•	מובייל/דסקטופ: זהה וקריא; אין גלילה אופקית ב־320–375px.
	•	קונסול: נקי מאדום; Lighthouse למסך ≥ 90.

⸻

11) Evidence Pack — מה לבקש בסוף מהבוט (חובה)
	1.	צילום /app/admin/businesses עם חיפוש/סינון פעיל ו־Badges ערוצים.
	2.	וידאו 15–20ש’: יצירת עסק חדש (כולל הפעלת ערוץ אחד לפחות), בדיקת חיבוריות, חזרה לרשימה עם סטטוס “Connected/Not configured”.
	3.	צילום מסך “עריכת עסק” (כרטיסיית Prompts) עם עדכון ושמירה.
	4.	צילום “השלטה”: Banner פעיל + ניווט לדף עסק.
	5.	צילום מחיקה/הקפאה עם Modal אישור ואז שינוי סטטוס.
	6.	צילום Network: כל הקריאות 200/422/403 נכונים; אין 500.
	7.	צילום לוגים: BIZ_CREATE, IMPERSONATE_START, WA_TEST_OK/WS_HANDSHAKE_OK.
	8.	צילום Lighthouse למסך (≥90) ו־DevTools → CSS יחיד, OKLCH ב־Styles.

⸻

עם ההנחיות האלה, אתה מקבל דף עסקים מוצרי: מנהל רואה הכול, יכול להקים/לתחזק/להשבית, לשגר בדיקות, ולהשתלט בבטחה; כל זה תוך הפרדה חדה של הרשאות ועם UX שמרגיש מובייל אמיתי בכל מקום.