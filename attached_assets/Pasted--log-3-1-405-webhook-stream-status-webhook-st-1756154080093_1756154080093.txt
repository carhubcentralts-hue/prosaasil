קיבלתי. לפי ה־log שצירפת יש 3 תקלות חד־משמעיות:

1. **405 על `/webhook/stream_status` ו־`/webhook/stream_ended`** → הנתיבים קיימים אבל לא מקבלים `POST` (או רשומים בנתיב לא תואם).
2. **`//` כפול ב־URLים בתשובת ה־TwiML** → לא תמיד שובֵר, אבל מיותר ועלול לבלבל reverse proxy.
3. **WS Handshake Error (31920)** → השרת **לא מחזיר** את תת־הפרוטוקול `Sec-WebSocket-Protocol: audio.twilio.com`, ש-Twilio דורש.

הנה תיקון ממוקד, בטוח ו־Idempotent — מוכן להדבקה:

---

# 1) `routes_twilio.py` — לתקן URLs ולפתוח את ה־POSTים

```diff
@@
-from flask import Blueprint, request, current_app, jsonify
+from flask import Blueprint, request, current_app, jsonify
+from urllib.parse import urljoin

 twilio_bp = Blueprint("twilio_bp", __name__, url_prefix="/webhook")

+def abs_url(path: str) -> str:
+    base = current_app.config.get("PUBLIC_BASE_URL", "").rstrip("/")
+    return f"{base}/{path.lstrip('/')}"  # מבטל '//' כפול

@@
-@twilio_bp.post("/stream_status")
-def stream_status():
-    form = request.form.to_dict(flat=True)
-    current_app.logger.info("STREAM_STATUS call=%s stream=%s event=%s",
-                            form.get("CallSid"), form.get("StreamSid"), form.get("Status"))
-    return ("", 204)
+@twilio_bp.post("/stream_status")
+def stream_status():
+    # אסור חתימה כאן, אסור extra בלוגים
+    form = request.form.to_dict(flat=True)
+    print(f"STREAM_STATUS call={form.get('CallSid')} stream={form.get('StreamSid')} event={form.get('Status')}")
+    return ("", 204)

+@twilio_bp.post("/stream_ended")
+def stream_ended():
+    form = request.form.to_dict(flat=True)
+    print(f"STREAM_ENDED call={form.get('CallSid')} stream={form.get('StreamSid')} status={form.get('Status')}")
+    return ("", 204)

@@  # בתוך incoming_call – לבנות TwiML עם URLs מוחלטים וללא '//' כפול
-  <Connect action="https://{PUBLIC_BASE_URL}/webhook/stream_ended">
-    <Stream url="wss://{PUBLIC_BASE_URL}/ws/twilio-media"
-            statusCallback="https://{PUBLIC_BASE_URL}/webhook/stream_status">
+  <Connect action="{abs_url('/webhook/stream_ended')}">
+    <Stream url="wss://{wss_host}/ws/twilio-media"
+            statusCallback="{abs_url('/webhook/stream_status')}">
       <Parameter name="call_sid" value="{call_sid}"/>
     </Stream>
   </Connect>
```

> הערות:
>
> * ודא שה־Blueprint רשום עם `url_prefix="/webhook"` ואז **הנתיבים בפנים הם רק** `"/stream_status"` ו־`"/stream_ended"` (לא לשים `/webhook/...` בתוך הדקורטור, אחרת יתקבל `/webhook/webhook/...`).
> * ה־`abs_url` מבטל את ה־`//` הכפול.

---

# 2) נתיב ה־WebSocket — לקבל את תת־הפרוטוקול של Twilio

Twilio שולח `Sec-WebSocket-Protocol: audio.twilio.com`. השרת צריך **להחזיר אותו**. עם `simple-websocket` עושים כך:

```diff
-from simple_websocket import Server, ConnectionClosed
+from simple_websocket import Server, ConnectionClosed

 ws_bp = Blueprint("ws_bp", __name__)

-@ws_bp.route("/ws/twilio-media", methods=["GET"])
-def ws_twilio_media():
-    ws = Server(request.environ)  # ← כאן חסר subprotocol
+@ws_bp.route("/ws/twilio-media", methods=["GET"])
+def ws_twilio_media():
+    # Twilio requires Sec-WebSocket-Protocol: audio.twilio.com
+    ws = Server(request.environ, protocols=["audio.twilio.com"])
     try:
         print("WS_START")
         # אופציונלי: ping/keepalive
         # לולאת RX/TX...
     except ConnectionClosed:
         print("WS_END")
     finally:
         try:
             ws.close()
         except Exception:
             pass
     return ("", 204)

+# אופציונלי – גם עם '/' בסוף כדי שלא יפול על סלאש:
+@ws_bp.route("/ws/twilio-media/", methods=["GET"])
+def ws_twilio_media_slash():
+    return ws_twilio_media()
```

---

# 3) פקודת דיפלוי (אם עדיין לא עשית)

ב־`Procfile` / `start_all.sh`:

```diff
- web: python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT main:app
+ web: python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app
```

---

## Smoke (תוך דקה)

1. **תיקון ה־`//` + 204**:

```bash
curl -i -X POST https://ai-crmd.replit.app/webhook/stream_status \
     -H "Content-Type: application/x-www-form-urlencoded" \
     --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=connected"
# מצופה: HTTP/1.1 204 No Content
```

2. **`stream_ended`**:

```bash
curl -i -X POST https://ai-crmd.replit.app/webhook/stream_ended \
     -H "Content-Type: application/x-www-form-urlencoded" \
     --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=completed"
# מצופה: 204
```

3. **WS** – בדוק שמקבלים 101 ושב־Response Headers יש `Sec-WebSocket-Protocol: audio.twilio.com`.
   (בכל כלי WS; אם אין echo של הפרוטוקול – Twilio ייתן 31920.)

---

## למה זה סוגר לך את כל השגיאות בלוג

* **405 → 204**: פתחנו את שיטת ה־`POST` בדיוק לשני ה־callbacks, אז Twilio יפסיק להתריע.
* **`//` כפול**: נעלם בזכות `abs_url()`.
* **31920 Handshake**: שרת ה־WS עכשיו **מחזיר** את תת־הפרוטוקול ש-Twilio דורש, אז ה־upgrade יעבור ל־101.

תבצע את 3 התיקונים שלמעלה—ותראה ב־Request Inspector שלך:

* `POST /webhook/stream_status` = 204 (ללא 15003)
* `POST /webhook/stream_ended` = 204
* ללא 31920; ה־WS מתחבר ומזרים אודיו.
