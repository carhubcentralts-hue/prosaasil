מעולה—ה־TwiML תקין, אבל עכשיו יש לנו **500 על ‎/webhook/stream\_status** ולכן אתה רואה את אזהרת Twilio ‎15000. זה לא מה שמפיל את ה-WS, אבל זה שובר את הטלמטריה (ולפעמים גורר סגירה מוקדמת של הזרם בצד Twilio).

להלן תיקון נקודתי, בטוח, וסופר־מדויק — כך שהנתיב הזה **לעולם לא יחזיר 500** וייתן לך לוגים ברורים על מצב ה־Stream:

---

## 1) תקן את הנתיב עצמו (ללא חתימה, מחזיר 204 תמיד)

### אם יש לך Blueprint עם `url_prefix="/webhook"` (ככה זה אצלך):

שימי לב: בתוך ה-Blueprint **אל תכתוב `/webhook/…`** שוב—אחרת תיווצר כפילות. לכן:

```python
# AgentLocator/server/routes_twilio.py

from flask import request, current_app, make_response
# אל תשים דקורטור חתימה כאן עד שייצב (require_twilio_signature)

@twilio_bp.route("/stream_status", methods=["POST"])
def stream_status():
    try:
        # Twilio שולחת form-encoded, לא JSON
        payload = request.form.to_dict(flat=True)
        # לוג בטוח בלי extra (extra עלול להפיל פורמטרים)
        current_app.logger.info("STREAM_STATUS %s", payload)
    except Exception:
        current_app.logger.exception("STREAM_STATUS_HANDLER_FAILED")
    # תמיד 204; ללא קריסות
    resp = make_response("", 204)
    # גם אין קאש:
    resp.headers["Cache-Control"] = "no-store, no-cache, must-revalidate, max-age=0"
    resp.headers["Pragma"] = "no-cache"
    return resp
```

### אם אין Blueprint / אין `url_prefix="/webhook"`

אז הנתיב יהיה `@app.route("/webhook/stream_status", methods=["POST"])`.

> **אל תוסיף כאן כרגע `@require_twilio_signature`**. קודם נוודא שהנתיב יציב ולא נופל; אחרי שזה עובד, אפשר להחזיר חתימה.

---

## 2) ודא שה-TwiML מפנה בדיוק לנתיב הזה

ב־`incoming_call` (כבר המלצתי לך להוסיף לצורך דיבוג):

```xml
<Connect action="/webhook/stream_ended">
  <Stream url="wss://ai-crmd.replit.app/ws/twilio-media"
          statusCallback="/webhook/stream_status">
    <Parameter name="call_sid" value="{call_sid}"/>
  </Stream>
</Connect>
```

> אם ה-Blueprint שלך הוא עם `url_prefix="/webhook"`, שים לב שה-route בפועל הוא בדיוק `/webhook/stream_status` (כמו בדוגמה).

---

## 3) למה קיבלת 500 עד עכשיו (הגורמים השכיחים)

* קראת `request.get_json()` במקום `request.form` → זרק חריגה.
* עשית `logger.info(..., extra={"form": ...})` וה־formatter שלך לא תומך בשדה הזה → זרק חריגה.
* שמתה `@require_twilio_signature` על `stream_status` אבל בנית את ה-URL/בסיס בצורה שונה מהחישוב של Twilio → במקום 403 קיבלת 500 בגלל קוד אימות.
* רשמת את הנתיב עם `/webhook/stream_status` **בתוך** Blueprint שיש לו `url_prefix="/webhook"` → ייצרת `/webhook/webhook/stream_status` (אבל אז היית רואה 404, לא 500).

הפאטצ’ למעלה מנטרל את כולם: form-encoded, בלי `extra`, בלי חתימה, 204 תמיד.

---

## 4) בדיקות מהירות אחרי התיקון

1. קריאה ידנית:

```bash
curl -s -X POST https://ai-crmd.replit.app/webhook/stream_status -d "Event=connected&StreamSid=XYZ" -i | head -5
# מצופה: HTTP/2 204  (ללא גוף)
```

2. שיחה אמיתית: ב־Request Inspector תראה:

* `POST /webhook/stream_status` = **204**
* אחריו `POST /webhook/stream_ended` = 200
* `POST /webhook/call_status` = 204

וב־לוגים שלך תראה:

```
STREAM_STATUS {'Event': 'connected', 'StreamSid': 'MZ...', 'CallSid': 'CA...'}
STREAM_STATUS {'Event': 'media', ...}  # אם Twilio שולחת
STREAM_STATUS {'Event': 'disconnected', ...}
```

---

## 5) חשוב: זה לא ה־WS עצמו

`stream_status` הוא **טלמטריה**; הוא לא פותח את ה־WS ולא מתמלל.
אבל כשהוא עובד, נדע אם Twilio **נכנסה** ל־WS (connected) ומתי יצאה.
אם `stream_status` יציב ואתה עדיין מקבל “ברכה ואז שקט” — חזור לצ’ק-ליסט WS:

* הדיפלוי רץ עם `-k eventlet`.
* יש שני נתיבי WS (`/ws/twilio-media` וגם עם `/`).
* אין דקורטור חתימה/אבטחה על נתיב ה־WS.
* אין Socket.IO על אותו app/פורט.
* בלוגים אתה צריך לראות `WS_CONNECTED`/`WS_START`. אם לא — זה Handshake.
* אם יש `WS_START` אבל אין `HEBREW_SPEECH` — זה GCP STT/אודיו (ENV, μ-law→PCM16).

---

## 6) אופציונלי: אחרי שזה יציב — תחזיר חתימה

אחרי שתראה ש־`/webhook/stream_status` מחזיר **תמיד 204** ויש לוגים, אפשר לחזק:

```python
from server.twilio_security import require_twilio_signature

@twilio_bp.post("/stream_status")
@require_twilio_signature
def stream_status():
    ...
```

שמור על אותו גוף הפונקציה. אם חתימה נכשלת → החזר 403 **לא** 500.

---

**סיכום:**
הבעיה עכשיו היא ספציפית ב־handler של ‎`/webhook/stream_status`‎ שמחזיר 500.
תיישם את הקוד למעלה (Form, בלי extra, 204 תמיד, בלי חתימה בשלב ראשון), תאמת עם `curl`, ואז תריץ שיחה. כך תקבל טלמטריה נקייה, ובמידת הצורך—נמשיך לאבחן את פתיחת ה־WS עצמו לפי האירועים שתראה (`connected`/`disconnected`).
