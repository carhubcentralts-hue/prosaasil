×›×Ÿâ€”×”×•× × ×ª×§×¢ ×‘×“×™×•×§ ×‘× ×§×•×“×ª ×”-async/sync. ××œ ×ª×”×¤×•×š ××ª ×›×œ ×”×¤×•× ×§×¦×™×•×ª ×œ-async (×–×” ×™×©×‘×•×¨ ×”×¨×‘×” ××§×•××•×ª). ×‘××§×•× ×–×”, ×ª×Ÿ ×œ×• â€œ×’×©×¨â€ ×§×˜×Ÿ ×©×××¤×©×¨ ×œ×”×¨×™×¥ ××ª ×”×¤×•×œ×‘××§ ×”×¡×™× ×›×¨×•× ×™ ×‘×¨×§×¢ ×•×œ×”×–×¨×™× ××ª ×”×ª×•×¦××” ×—×–×¨×” ×œÖ¾loop â€” ×‘×œ×™ ×œ×—×¡×•× ××ª ×©×¨×©×•×¨ ×”×©×™×—×”.

×œ×”×œ×Ÿ ×”× ×—×™×” ×××•×§×“×ª ×©××™×™×©×‘×ª ××ª ×–×” ×‘×¦×•×¨×” × ×§×™×™×”, ×¢× ××™× ×™××•× ×©×™× ×•×™×™× ×•××§×¡×™××•× ×™×¦×™×‘×•×ª.

â¸»

âœ… ×¤×ª×¨×•×Ÿ × ×§×™ ×œ-fallback ×‘×œ×™ ×œ×©×‘×•×¨ ××ª ×”×¡× ×›×¨×•×Ÿ

×¢×™×§×¨×•×Ÿ
	â€¢	×œ× ××©× ×™× ××ª _hebrew_stt (× ×©××¨×ª ×¡×™× ×›×¨×•× ×™×ª).
	â€¢	××•×¡×™×¤×™× ×©×ª×™ ×¢×˜×™×¤×•×ª:
	1.	×¢×˜×™×¤×” async ×œ×©×™××•×© ×›×©×›×‘×¨ × ××¦××™× ×‘×ª×•×š ×§×•×“ async.
	2.	×¢×˜×™×¤×” ×œ×-×—×•×¡××ª ×œ×©×™××•×© ×›×©×× ×—× ×• ×‘×ª×•×š ×§×•×“ ×¡×™× ×›×¨×•× ×™â€”×©×¨×¦×” ××ª ×”-STT ×‘Ö¾thread ×•××—×–×™×¨×” ××™×“; ×›×©×”×ª×•×¦××” ××•×›× ×” ×”×™× × ×©×œ×—×ª ×—×–×¨×” ×“×¨×š ×ª×•×¨/×§×•×œ×‘×§.

0) ×“×¨×™×©×•×ª ×§×˜× ×•×ª ××¨××©

×‘××—×œ×§×” ×©×œ ×”Ö¾call/session (×‘×“×¨×š ×›×œ×œ ×‘Ö¾media_ws_ai.py) ×•×“× ×©×§×™×™×:

import asyncio
from concurrent.futures import ThreadPoolExecutor
from collections import deque

class MediaStreamHandler:
    def __init__(self, ...):
        self.loop = asyncio.get_event_loop()  # ×”-loop ×”×¨××©×™
        self.exec = ThreadPoolExecutor(max_workers=1)  # ×¤×¨-×©×™×—×”, ×œ× ×’×œ×•×‘×œ×™
        self.events_q = asyncio.Queue(maxsize=32)      # ×ª×•×¨ ××™×¨×•×¢×™× ×¤× ×™××™
        # ... ×©××¨ ×”×©×“×•×ª ×©×œ×š (buffers, state, ×•×›×•')

1) ×¢×˜×™×¤×” Async ×œ×¤×•×œ×‘××§ (×›×©×”×§×•×“ ×§×•×¨× ××ª×•×š async)

×§×•×‘×¥: server/media_ws_ai.py (×‘××•×ª×” ××—×œ×§×”)

async def _stt_fallback_async(self, audio_data: bytes) -> str:
    # ××¨×™×¥ ××ª ×”-STT ×”×¡×™× ×›×¨×•× ×™ ×‘-thread, ×œ× ×—×•×¡× ××ª ×”×œ×•×œ××”
    return await asyncio.get_running_loop().run_in_executor(
        self.exec, self._hebrew_stt, audio_data
    )

×©×™××•×©: ×× ××ª×” ×›×‘×¨ ×‘×ª×•×š ×¤×•× ×§×¦×™×” async def â€” ×ª×•×›×œ await self._stt_fallback_async(...) ×‘××§×•× ×œ×—×¡×•×.

2) ×¢×˜×™×¤×” ×œ×-×—×•×¡××ª ×œ×©×™××•×© ××ª×•×š ×§×•×“ ×¡×™× ×›×¨×•× ×™

×× ×™×© ×œ×š ××§×•× ×¡×™× ×›×¨×•× ×™ (×œ××©×œ _process_utterance_safe ×× ××™× × ×” async) ×©×‘×• ×”×™×•× ×›×ª×•×‘:

text = self._hebrew_stt(audio_data)   # â† ×–×” ×—×•×¡×!
self._handle_transcript_ready(text)

×”×—×œ×£ ×œ×–×”:

self._stt_fallback_nonblocking(audio_data)  # ×œ× ×—×•×¡×. ××—×–×™×¨ ××™×“.

×•×××© ××ª ×”×¢×˜×™×¤×” ×•×”×§×•×œ×‘×§:

def _stt_fallback_nonblocking(self, audio_data: bytes) -> None:
    # ×©×•×œ×—×™× ××ª ×”×¢×‘×•×“×” ×œ-thread ×™×—×™×“ ×©×œ ×”×©×™×—×”
    fut = self.exec.submit(self._hebrew_stt, audio_data)
    # ×›×©××•×›×Ÿ, ×œ×”×—×–×™×¨ ×œ-loop ×‘×¦×•×¨×” ×‘×˜×•×—×” (thread-safe)
    fut.add_done_callback(lambda f: self.loop.call_soon_threadsafe(
        self._on_stt_fallback_done, f
    ))

def _on_stt_fallback_done(self, fut):
    try:
        text = fut.result()
    except Exception as e:
        print(f"âŒ STT fallback failed: {e}", flush=True)
        text = ""
    # ×“×•×—×¤×™× ××™×¨×•×¢ ×œ×ª×•×¨ ×”×-×¡×™× ×›×¨×•× ×™ ×©×œ ×”×©×™×—×” (×©×™×˜×•×¤×œ ×‘×œ×•×œ××ª ×”-async)
    try:
        self.events_q.put_nowait(("stt_final_text", text))
    except asyncio.QueueFull:
        print("âš ï¸ events_q full; dropping final text", flush=True)

×•×‘××§×•× ×›×œ×©×”×• ×‘×œ×•×œ××” ×”×-×¡×™× ×›×¨×•× ×™×ª ×©×œ ×”×©×™×—×” (×›×‘×¨ ×™×© ×œ×›× consumer), ×”×•×¡×£ ×˜×™×¤×•×œ ×‘××™×¨×•×¢:

async def _pump_events(self):
    while self.running:
        kind, payload = await self.events_q.get()
        if kind == "stt_final_text":
            await self._handle_transcript_ready_async(payload)  # ××• sync ×¢× run_in_executor
        # ... ××™×¨×•×¢×™× × ×•×¡×¤×™× (partial, TTS ready, ×•×›×•')

×”×™×ª×¨×•×Ÿ: ×œ× ×©×™× ×™×ª ××ª ×—×ª×™××ª _hebrew_stt ×•×œ× ×”×›×¨×—×ª ××ª _process_utterance_safe ×œ×”×¤×•×š ×œÖ¾async â€” ×•×‘×›×œ ×–××ª ××™×Ÿ ×™×•×ª×¨ ×—×¡×™××•×ª.

â¸»

ğŸ¯ ××™×¤×” ×œ×©×™× ××” â€” ×¦â€™×§ ×œ×™×¡×˜ ×§×¦×¨
	1.	×‘Ö¾__init__ ×©×œ ×”Ö¾handler: self.loop, self.exec, self.events_q.
	2.	×”×•×¡×£ ××ª _stt_fallback_async (×œ×©×™××•×© ××ª×•×š ×¤×•× ×§×¦×™×•×ª async ×§×™×™××•×ª).
	3.	×”×—×œ×£ ×§×¨×™××•×ª ×—×¡×™××ª×™×•×ª ×œÖ¾_hebrew_stt(...) ×‘Ö¾_stt_fallback_nonblocking(...) ×‘××§×•××•×ª ×¡×™× ×›×¨×•× ×™×™×.
	4.	×•×“× ×©×™×© ×œ×š consumer ×-×¡×™× ×›×¨×•× ×™ ×©××˜×¤×œ ×‘Ö¾self.events_q ×•××ª×” ×›×‘×¨ ×§×•×¨× ×œÖ¾_handle_transcript_ready_async(text) ××× ×•.

â¸»

âš™ï¸ ×©×™×œ×•×‘ ×¢× ×™×ª×¨ ×”× ×—×™×•×ª ×”-STT (××”×¡×™×‘×•×‘ ×”×§×•×“×)
	â€¢	×¡×˜×¨×™××™× ×’ ×“×™×¤×•×œ×˜ ×‘×§×•×“ (×•×’× ×“×¨×š ENV):

USE_STREAMING_STT = True
if os.getenv("ENABLE_STREAMING_STT", "").lower() in ("false","0","no"):
    USE_STREAMING_STT = False
print(f"ğŸš€ Streaming STT enabled: {USE_STREAMING_STT}", flush=True)


	â€¢	×‘×—×™×¨×ª ××•×“×œ ×“×™× ××™×ª ×œ×¢×‘×¨×™×ª: × ×¡×” phone_call; ×× â€œnot availableâ€ â†’ default+enhanced.
(×”×¤×•× ×§×¦×™×” choose_stt_model ×›×¤×™ ×©× ×ª×ª×™ â€” ×ª×©××™×¨ ×›××• ×©×”×™×).
	â€¢	EU/US endpoint ×“×¨×š ENV:

GOOGLE_CLOUD_SPEECH_ENDPOINT=europe-west1-speech.googleapis.com

(××• us-... ×× ×”Ö¾RTT ××¦×œ×š × ××•×š ×™×•×ª×¨ ×œ×©×.)

	â€¢	×¤×¨××˜×¨×™× ××”×™×¨×™× ×‘×§×•×‘×¥ ×”Ö¾STT:

STT_BATCH_MS=80
STT_PARTIAL_DEBOUNCE_MS=120
STT_TIMEOUT_MS=450
VAD_HANGOVER_MS=220


	â€¢	Retry ×œ×¤× ×™ ×¤×•×œ×‘××§ (×©×œ×•×© × ×™×¡×™×•× ×•×ª, 200ms ××¨×•×•×—).
	â€¢	Early finalize ×œ×¤×™ partial â€œ×—×–×§â€ (â‰¥15 ×ª×•×•×™× ××• .,?!) â€” ×œ×”×©××™×¨.
	â€¢	Twilio WS: subprotocol="audio.twilio.com", ×©××™×¨×” ×¢×œ ×¤×™× ×’/keep-alive, ×•×•×“× ×©×”Ö¾WS route ×¨×©×•× ×œ×¤× ×™ ×©×™×¨×•×ª ×”-SPA.

â¸»

ğŸ§ª ××™××•×ª (××” ×œ×—×¤×© ×‘×œ×•×’×™×)
	â€¢	×‘×¢×œ×™×™×”:
ğŸš€ Streaming STT enabled: True
âœ… [STT] Selected model: default (enhanced=True) (××• phone_call ×× ×–××™×Ÿ)
	â€¢	×‘×ª×—×™×œ×ª ×©×™×—×”:
âœ… [STT] Streaming started (attempt 1)
××™×¨×•×¢×™ [LATENCY] ××¨××™×: partial ~0.5â€“0.8s, final ~1.0â€“1.4s, total ~1.8â€“2.3s.
	â€¢	×× ×”×¤×•×œ×‘××§ ×”×•×¤×¢×œ:
×ª×¨××” ×”×“×¤×¡×” ××”Ö¾executor, ××‘×œ ×‘×œ×™ ×©×”-WebSocket × ×ª×§×¢/××•×©×”×”.

â¸»

ğŸ’¡ ×œ××” ×–×” ×”×¤×ª×¨×•×Ÿ ×”× ×›×•×Ÿ ×›××Ÿ
	â€¢	××¤×¡ ×¨×™×¤×§×˜×•×¨ ××¡×•×›×Ÿ: ×œ× ××©× ×™× ×—×ª×™××•×ª, ×¨×§ ××•×¡×™×¤×™× ×¢×˜×™×¤×•×ª.
	â€¢	××™×Ÿ ×—×¡×™××•×ª ×‘-loop ×”×¨××©×™ â€” ×’× ×›×©× ×•×¤×œ×™× ×œ×¤×•×œ×‘××§.
	â€¢	××ª××™× ×œ×¨×™×‘×•×™ ×©×™×—×•×ª: executor ×¤×¨-×©×™×—×”, ×ª×•×¨ ×¤×¨-×©×™×—×”, ××™×Ÿ ×’×œ×•×‘×œ×™×.

×× ×”×•× ×¢×“×™×™×Ÿ × ×ª×§×¢ â€” ×ª×Ÿ ×œ×™ 10 ×©×•×¨×•×ª ×œ×•×’ ×¡×‘×™×‘ ×”××§×•× ×©×‘×• ×§×¨××ª ×œ×¤×•×œ×‘××§ (×›×•×œ×œ [LATENCY]) ×•××›×•×•×Ÿ ××•×ª×• ×œ×©×•×¨×ª ×”×§×•×“ ×”××“×•×™×§×ª.