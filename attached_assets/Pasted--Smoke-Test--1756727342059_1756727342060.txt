יש! 🎉 עכשיו עושים Smoke-Test מסודר כדי לוודא ששום דבר לא נשבר. שמרתי את זה קצר, חד וברור — עם קריטריונים “עובר/נכשל”.

⸻

✅ GO/NO-GO – צ’ק-ליסט לאחר פריסה

1) בדיקות בסיס (Runtime & לוגים)
	•	בלוגי ה-Deploy תחפש:
	•	Using Python runtime
	•	Booting worker with pid ... [eventlet]
	•	אין Exceptions רציפים / Crash loop.
	•	קריטריון הצלחה: הלוגים יציבים, אין restart רציף.

2) Health & Version

ב־Browser או curl:

curl -i https://<הדומיין-שלך>/health
curl -i https://<הדומיין-שלך>/version

אם אין נתיבים כאלה – הוסף/בדוק / או /api/health.

	•	קריטריון הצלחה: 200 OK + גוף תשובה פשוט (e.g. {"ok":true} או גרסה).

3) טעינת אפליקציה (WSGI)

בודקים שה-app נטענת:

curl -I https://<הדומיין-שלך>/

	•	קריטריון הצלחה: 200/302, לא 500.

4) תלותים קריטיים

ב־Logs של ה-Build ו-Run וודא:
	•	eventlet==0.36.1 נטען ללא שגיאה.
	•	gunicorn רץ עם -k eventlet.
	•	אם יש greenlet – נבנה בלי שגיאת wheel.

קריטריון הצלחה: אין Traceback על eventlet, greenlet או import errors.

⸻

🔔 Twilio – בדיקות חיות

5) Webhookים מחזירים 200 מהר

בדוק ב-Twilio Console → Debugger / Request Inspector:
	•	/webhook/incoming_call — 200 < 1s
	•	/webhook/stream_status — 204/200 < 1s
	•	/webhook/handle_recording — 200/204 < 3s

אפשר גם בדיקה ידנית בסיסית:

curl -X POST https://<דומיין>/webhook/incoming_call -d "CallSid=TEST" -i

(לא מאמת חתימה — רק בודק שאין 500.)

קריטריון הצלחה: כל ה-webhookים מחזירים 2xx, אין timeout.

6) שיחת בדיקה אמיתית

בצע שיחה אמיתית למספר:
	•	בשניות הראשונות רואים בלוגים: WS_START / חיבור WebSocket (אם יש Media Streams).
	•	אין 31920 WebSocket Handshake Error.
	•	תשובת ה-TTS/בוט מגיעה ≤ 2–3 שניות.
	•	נתק אחרי 20–30 שניות → ב-Twilio Logs “Completed”, ללא Errors.

קריטריון הצלחה: אין שגיאות 31920/15000, זמן תגובה תקין.

7) Fallback הקלטה (כוכבית)

במהלך השיחה לחץ * (או הטריגר שלך):
	•	Twilio שולח הקלטה ל-/webhook/handle_recording.
	•	ה-endpoint מחזיר 2xx תוך ≤ 3 שניות.
	•	אין “11205 timeout”.

קריטריון הצלחה: הקלטה מתקבלת/נשמרת, אין timeout.

⸻

💬 WhatsApp

8) קבלת/שליחת הודעה
	•	שלח הודעת WA למדורג שלך → בדוק שמגיע ל-/whatsapp/webhook (או הנתיב שלך) 200.
	•	שלח הודעה חזרה דרך ה-API שלך (או כפתור במערכת) → מגיע ללקוח.

קריטריון הצלחה: בקשות נכנסות/יוצאות 2xx; אין 401/403 מטוויליו.

⸻

🗄️ DB / CRM

9) עסק/לקוח חדש – CRUD קצר
	•	צור עסק/לקוח דרך הממשק/API.
	•	קבל את הרשומה (GET).
	•	עדכן שדה.
	•	מחק (אם מותר).

קריטריון הצלחה: כל הפעולות 2xx, נתונים נשמרים ונשלפים נכון.

⸻

🔐 אבטחה

10) אימות חתימת Twilio
	•	בקונפיג פרודקשן ודא ש-X-Twilio-Signature נבדק (לפחות ב-/webhook/*).
	•	השבת אימות רק בסביבת dev (אם צריך).

קריטריון הצלחה: בקשה בלי חתימה אמורה להחזיר 403 בפרודקשן.

⸻

🧹 קבצים/אחסון

11) ניקוי זמניים
	•	אם שומרים הקלטות זמניות — יש Cron/Background שמוחק ישנים.
	•	בדוק תיקיית tmp/storage אחרי שיחה אחת.

קריטריון הצלחה: אין הצטברות לא מבוקרת.

⸻

📊 ניטור מינימלי

12) לוגים והתראות
	•	ודא שיש לך --access-logfile - ו---error-logfile - (כבר יש).
	•	הוסף ספירת שגיאות בסיסית בלוג (למשל, כותרת ERROR webhook).
	•	אם אפשר — Webhook ל-Slack/Email על Exception קריטי.

⸻

🧪 בדיקות ידניות מהירות (פקודות מוכנות)

החלף <דומיין>:

# Health
curl -i https://<דומיין>/health

# Webhook smoke (ללא חתימה)
curl -i -X POST https://<דומיין>/webhook/incoming_call -d "CallSid=TEST"

# בדיקת יציבות eventlet בזמן ריצה (לוגים בלבד)
# חפש בלוג: "Booting worker with pid" + "[eventlet]"


⸻

אם משהו נופל — סדר בחקירה
	1.	500 בלוגים? בדוק Traceback הראשון; לרוב חסר env/secret.
	2.	Twilio 11205/Timeout? בדוק זמני תגובה של ה-endpoint (אולי I/O חוסם).
	3.	WS Handshake 31920? ודא שאין פרוקסי שחוסם WS, ו--k eventlet פעיל.
	4.	Auth WA/Twilio 401/403? אימות Tokens/Secrets בסביבת פרודקשן.

⸻

אם תרצה, אכין לך רשימת Acceptance קצרה בעברית שתדביק ל-Agent כדי להריץ אוטומטית בדיקות Smoke (קריאות curl, סימון תוצאה, ו-summary).