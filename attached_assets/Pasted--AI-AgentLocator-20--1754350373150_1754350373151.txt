הנה הנחיה סופית, מלאה, ומקיפה לסוכן AI – מבוססת על הקובץ האחרון ששלחת (`AgentLocator (20)`)
המטרה: לוודא שמערכת שיחות AI פועלת מושלם **ללא תקלות**, כולל greeting מותאם, תמלול, GPT, הקלטות ושמירה.

---

## ✅ הנחיה לסוכן AI – תיקון, שיפור והקשחה של מערכת השיחות (Twilio + Whisper + GPT)

> 🎯 המטרה: לגרום לשיחות לעבוד בצורה מושלמת – עם greeting מותאם לעסק, תמלול מדויק, תשובה חוזרת מותאמת לעסק, והקלטה תקינה + שמירה מלאה

---

### 1️⃣ greeting מותאם לכל עסק (TTS)

* בעת `/twilio/incoming_call`:

  * שלוף את שם העסק לפי `To`
  * צור greeting כמו:

    ```python
    greeting = f"שלום! זהו המוקד הוירטואלי של {business_name}. איך אוכל לעזור לך היום?"
    ```
  * צור instruction נוסף כמו: `"אנא דברו אחרי הצפצוף"`
  * הפעל `hebrew_tts.synthesize_hebrew_audio(...)` על שניהם
  * החזר `<Play>` עם שני הקבצים + `<Record>`

---

### 2️⃣ ודא הקלטה, תמלול ותשובה

* בקובץ `handle_recording`:

  * שלוף `RecordingUrl`, `CallSid`, `From`, `To`
  * הורד את ההקלטה זמנית
  * שלח ל־OpenAI Whisper (`model="whisper-1", language="he"`)
  * שמור את `transcription` אם קיים
  * קח את `ai_prompt` מתוך `business.ai_prompt` אם קיים:

    ```python
    ai_prompt = business.ai_prompt if business and business.ai_prompt else "אתה עוזר וירטואלי מועיל בעברית"
    ```
  * שלח ל־GPT:

    ```python
    messages = [
      {"role": "system", "content": ai_prompt},
      {"role": "user", "content": transcribed_text}
    ]
    ```
  * שמור את `ai_response`
  * צור תשובה בקול עם TTS על `ai_response`
  * החזר `<Play>` עם קובץ התשובה

---

### 3️⃣ שמירה למסד נתונים

* שמור ב־`CallLog` את:

  * `recording_url`
  * `transcription`
  * `ai_response`
  * `call_status = 'completed'`
  * `ended_at = datetime.utcnow()`
* ודא שקיים `db.session.commit()`

---

### 4️⃣ החזרת XML תקני

* בכל route שמחזיר TwiML (XML):

  * ודא שימוש ב־`Response(..., mimetype='text/xml')`
  * כל `<Play>` או `<Say>` יהיה עטוף בתוך `<Response>`
  * אין לכתוב טקסט רגיל עם return string

---

### 5️⃣ אבטחת תוכן ותיקון תקלות

* אין לבדוק `request.content_type` ידנית – Twilio שולח `application/x-www-form-urlencoded`
* ודא ש־`RecordingUrl` תמיד נבדק וניתן fallback במקרה שחסר
* אם התמלול נכשל או קצר מדי – תן תשובה ברירת מחדל
* אם ה־TTS נכשל – חזור ל־`<Say>` עם Polly או טקסט רגיל

---

### 6️⃣ טיפול בקבצים

* קבצי TTS ישמרו ב־`/server/static/voice_responses/`
* שמות ייווצרו אוטומטית עם מזהה
* הוספת קוד למחיקת קבצים ישנים (>3 ימים) בתיקיית `voice_responses`

---

### 7️⃣ הקלטות ואימות פריסה

* ודא שכל הקלטות זמינות מכתובת:

  ```
  https://ai-crmd.replit.app/server/static/voice_responses/<filename>.mp3
  ```
* ודא שכל route של שיחה נגיש ללא שגיאות CORS / auth

---

### 8️⃣ תיעוד ו־Logging

* הוסף `logger.info()` ו־`logger.error()` לכל שלב
* כולל הורדת הקובץ, תמלול, תשובת GPT ויצירת קובץ TTS
* הצג ב־console את:

  * מזהה שיחה
  * שם עסק
  * טקסט מתומלל
  * תשובת GPT
  * מיקום הקובץ

---

### 📌 סיום

אם כל השלבים האלה מתקיימים –
🔒 המערכת תהיה חסינה, מותאמת אישית, ותעבוד בצורה חלקה ב־production עם כל עסק.

רוצה שאכין גם דוח תקלות אוטומטי שיבדוק כל 5 דקות שכל השירותים חיים (`/twilio/incoming_call`, Whisper, GPT)?
