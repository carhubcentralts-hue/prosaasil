קיבלתי. ננעלים ומסדרים הכל — “צפייה בעסק” לא עובד, “התחזות” לא עובדת, אין איפה לערוך פרומפט, וחלק מהכפתורים לא מציגים נתונים אמיתיים. הנה הנחיה ממוקדת, קצה-אל-קצה, שתוציא אותך לדרך בתוך השבוע.

⸻

מה עושים קודם (Do-First)
	1.	Origin יחיד: ה-SPA וה-API חייבים להגיע מאותו דומיין (Flask מגיש את ה-dist). אין Preview נפרד.
	2.	Build טרי ומסומן: BUILD badge ברור (BUILD: 25) + index.html עם Cache-Control: no-store.
	3.	SeaSurf יחיד: אינסטנס אחד, שמות עקביים:
SEASURF_COOKIE_NAME='XSRF-TOKEN', SEASURF_HEADER='X-CSRFToken'.
לוגין/לוגאאוט ו-webhooks פטורים; התחזות לא פטורה.

⸻

A) Backend — נתיבים מחייבים (JSON בלבד, בלי HTML)

הפעל/ודא את ה-endpoints הבאים (שמות ועיצוב אחידים!):

A1) ניהול עסקים (Admin)
	•	GET /api/admin/businesses?page=&pageSize=&q=
מחזיר:

{"items":[{"id":1,"name":"שי דירות ומשרדים בע״מ","phone_e164":"+97233763805","status":"active","whatsapp_status":"connected","call_status":"ready","created_at":"..."}],"total":1,"page":1,"pageSize":20}


	•	GET /api/admin/businesses/:id → אובייקט מלא לעריכה (אותם שמות שדות כמו למעלה + email/address).
	•	PATCH /api/admin/businesses/:id (CSRF) → מעדכן “רשימת שדות לבנה” ומחזיר את הרשומה המעודכנת.

A2) צפייה/התחזות
	•	צפייה (Admin View בלבד, ללא שינוי סשן):
GET /api/admin/businesses/:id/overview → נתוני סקירה “קריא-בלבד” לעמוד צפייה בעסק (admin).
	•	התחזות (משנה סשן; חייב CSRF):
POST /api/admin/businesses/:id/impersonate →
כותב לסשן: impersonating=True, tenant_id=:id, role='business' → {"ok":true,"tenant_id":id}
POST /api/admin/impersonate/exit → מנקה.
	•	עסק “נוכחי” (אחרי התחזות):
GET /api/business/current → העסק של session.tenant_id.

חשוב: ההתחזות לא ב־exempt paths. לוגין/לוגאאוט כן.

A3) Agent Prompts (שיחות / וואטסאפ — נפרד)
	•	Admin:
	•	GET /api/admin/businesses/:id/prompt →
{"calls_prompt":"...","whatsapp_prompt":"...","version":7,"updated_at":"..."}
	•	PUT /api/admin/businesses/:id/prompt (CSRF) → עידכון (שדות אופציונליים: calls_prompt, whatsapp_prompt) + יצירת revision (prompt_revisions) + החזרה עם הגרסה החדשה.
	•	Business (אחרי התחזות):
	•	GET /api/business/current/prompt
	•	PUT /api/business/current/prompt (CSRF)

Runtime Apply: אחרי PUT פרסם אירוע agent-config:<tenant_id> (Redis/pubsub) כדי לרענן את הפרומפט בצד השיחות/וואטסאפ בלי ריסטרט. לוג: Agent prompt reloaded for tenant <id> v<n>.

⸻

B) Frontend — הופכים את הכל לעובד (React + Tailwind)

B1) עמוד “ניהול עסקים” — אמיתי, בלי דמו
	•	הנתונים מגיעים אך ורק מ־GET /api/admin/businesses. אין פולבקים/דמו.
	•	כפתורים בכל שורה:
	•	Edit → פותח BusinessEditModal. בפתיחה GET /api/admin/businesses/:id → ממלא את הטופס (שדות לפי ה-JSON של השרת).
שמירה → PATCH /api/admin/businesses/:id (CSRF) → Toast + רענון הטבלה.
	•	View (Admin) → ניווט ל־/app/admin/businesses/:id/view
העמוד מביא GET /api/admin/businesses/:id/overview ומציג קריא-בלבד (בלי סשן).
	•	Enter as Business (Impersonate) → קריאה ל-POST /api/admin/businesses/:id/impersonate עם X-CSRFToken → על 200:
await apiFetch('/api/auth/me') לעדכון קונטקסט → ניווט ל־/app/business/overview → invalidate/refetch לנתונים תלויי tenant (סקירה, לידים, שיחות, וואטסאפ).

מפרידים “צפייה” (ללא סשן) מ“התחזות” (משנה סשן). זה גם UX ברור וגם עוזר דיבוג.

B2) עמוד “עסק” (Business) — לשימוש אחרי התחזות

Tabs: Overview / Calls / WhatsApp / Leads / Agent / Settings
	•	טאב Agent מציג שני אזורים:
	•	Calls Prompt — textarea + “Save” (PUT …/prompt)
	•	WhatsApp Prompt — textarea + “Save”
	•	“History” (Modal של גרסאות), “Revert” לגרסה נבחרת (PUT).
	•	הרשאות:
	•	אם נכנסת ב-Impersonation → אפשר עריכה.
	•	אם רק צפייה כאדמין (עמוד view) → מציג קריא-בלבד, בלי כפתורי Save.

B3) Client HTTP (קריטי ל-CSRF)

ב-http.ts ודא:
	•	credentials: 'include' בכל הבקשות.
	•	ב־POST/PUT/PATCH/DELETE:
	•	Content-Type:'application/json'
	•	X-CSRFToken: <ערך מ-cookie XSRF-TOKEN> (ללא מרכאות/JSON.stringify)
	•	X-Requested-With:'XMLHttpRequest'
	•	פעם אחרי לוגין: GET /api/auth/csrf לייצר את הקוקי הקריא (HttpOnly=False).

DevTools → Network על “Impersonate”:
	•	Request Headers: יש גם Cookie XSRF-TOKEN=... וגם Header X-CSRFToken: ... עם אותו ערך.
	•	Response: 200 JSON. אז GET /api/auth/me מציג impersonating:true.

⸻

C) למה עכשיו זה “לא רואים כלום” ומה עוצר
	1.	Router לא מגיע לנתיב: רענון על /app/...—ודא שיש catch-all ב-Flask שמגיש index.html לכל נתיב שאינו /api|/assets|/static|/webhook.
	2.	Assets לא נטענים: בדוק ש-Vite base:'/' וה-JS/CSS מגיעים מ־/assets/*.js.
	3.	Auth לא נשמר: אם GET /api/auth/me מחזיר 401 אחרי לוגין—הקוקי לא נשלח (Origin שונה).
	4.	CSRF חסר: Header/ cookie לא תואמים (שמות לא עקביים).
	5.	דמו/פולבק: ודא שאין data ?? demoData בשום מקום.

⸻

D) Acceptance — לא סוגרים לפני שזה עובר

שרת (curl):

# לוגין (פטור CSRF)
curl -i -c /tmp/c -b /tmp/c -X POST /api/auth/login -H 'Content-Type: application/json' --data '{"email":"admin@...","password":"..."}'

# טוקן CSRF
TOKEN=$(curl -s -c /tmp/c -b /tmp/c /api/auth/csrf | python -c "import sys,json;print(json.load(sys.stdin)['csrfToken'])")

# רשימת עסקים (חייב אמיתי, total=1)
curl -i -c /tmp/c -b /tmp/c /api/admin/businesses

# פרטי עסק לעריכה
curl -i -c /tmp/c -b /tmp/c /api/admin/businesses/1

# צפייה בעסק (admin view, קריא-בלבד)
curl -i -c /tmp/c -b /tmp/c /api/admin/businesses/1/overview

# התחזות — בלי טוקן → 400
curl -i -c /tmp/c -b /tmp/c -X POST /api/admin/businesses/1/impersonate -H 'Content-Type: application/json' --data '{}'

# התחזות — עם טוקן → 200
curl -i -c /tmp/c -b /tmp/c -X POST /api/admin/businesses/1/impersonate -H 'Content-Type: application/json' -H "X-CSRFToken: $TOKEN" --data '{}'

# /me צריך impersonating:true + tenant_id
curl -i -c /tmp/c -b /tmp/c /api/auth/me

# פרומפטים
curl -i -c /tmp/c -b /tmp/c /api/admin/businesses/1/prompt
curl -i -c /tmp/c -b /tmp/c -X PUT /api/admin/businesses/1/prompt -H 'Content-Type: application/json' -H "X-CSRFToken: $TOKEN" --data '{"calls_prompt":"...", "whatsapp_prompt":"..."}'

קליינט (Network):
	•	“View (Admin)” → GET /api/admin/businesses/:id/overview 200 ומוצג.
	•	“Enter as Business” → POST /impersonate 200, ואז /api/auth/me מציג impersonating, ניווט ל־/app/business/overview.
	•	טאב Agent: GET prompt מציג טקסט אמיתי; PUT prompt שומר ומגדיל version; מופיע toast + refetch; לוג runtime refresh.

⸻

E) אם עדיין לא עובד — מה להביא כדי לנעול
	1.	צילום Network של הבקשה שנופלת (Headers+Cookies+Response).
	2.	פלט curl המדויק ל-/api/admin/businesses, /api/admin/businesses/:id, /impersonate (עם/בלי CSRF).
	3.	שורת הקונפיג של SEASURF_COOKIE_NAME ו-SEASURF_HEADER, ותוכן ה-cookie/ header בלוג הדיבוג:

@app.before_request
def _dbg_csrf_headers():
    if request.path.startswith('/api/admin/businesses/') and request.method == 'POST':
        print('[CSRF-DBG] cookie=', request.cookies.get('XSRF-TOKEN'), ' header=', request.headers.get('X-CSRFToken'))


⸻

מילה על הדד־ליין

אל תוותר על ההפרדה “צפייה בעסק” (admin view) מול “התחזות”. זה נותן לך מיד דף עובד (ללא סשן) גם אם CSRF עוד בשפצורים, ומונע ממך להיתקע. במקביל סוגרים את CSRF נכון — ואז “התחזות” תעבוד בלי טריקים.

בצע לפי הסדר הזה — ותוך כדי, כל דף “ניהול עסקים” יציג נתונים אמיתיים, הכפתורים יעבדו, ותהיה לך לשונית Agent בעמוד העסק לעריכת פרומפטים לשיחות/וואטסאפ עם החלה בזמן אמת.