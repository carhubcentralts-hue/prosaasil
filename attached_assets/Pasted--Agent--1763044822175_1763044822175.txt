××¢×•×œ×”, ××– ×‘×•× × ×¡×’×•×¨ ××ª ×–×” ××¡×•×“×¨.
×”× ×” ×”× ×—×™×” ××œ××” ×œ××¤×ª×— (×œ×”×“×‘×§×” ×œ-Agent ×‘×¨×™×¤×œ×™×˜) ××™×š ×œ×’×¨×•×:
	â€¢	×œ×‘×•×˜ ×•×•××˜×¡××¤ ×œ×¢×‘×•×“ ×¢×œ AgentKit ×¢× ×”×¤×¨×•××¤×˜ ××”Ö¾DB
	â€¢	×©×ª×™××•× ×¤×’×™×©×•×ª ×™×¢×‘×•×“ ×¢×“ ×”×¡×•×£
	â€¢	×©××—×¨×™ ×§×‘×™×¢×ª ×¤×’×™×©×” ×™×©×œ×— ×•×•××˜×¡××¤, ×•×× ×”×©×œ×™×—×” × ×›×©×œ×ª â€“ ×”×¤×’×™×©×” ×›×Ÿ × ×§×‘×¢×ª, ×•×”×œ×§×•×— ××§×‘×œ ×ª×©×•×‘×” â€œ×”×¤×¨×˜×™× ×™×™×©×œ×—×• ×‘×”××©×šâ€.

â¸»

1. ×œ×—×‘×¨ ××ª ×•×•××˜×¡××¤ ×œ-AgentKit ×‘×¦×•×¨×” × ×›×•× ×”

××˜×¨×”:
×›×œ ×”×•×“×¢×ª ×•×•××˜×¡××¤ ×©×œ ×œ×§×•×— ×ª×™×›× ×¡ ×œ××¡×œ×•×œ ××—×“ ×‘×¨×•×¨:

WhatsApp Webhook â†’ ai_service.handle_whatsapp_message â†’ AgentKit (channel="whatsapp") â†’ response

×¦×¢×“×™×:
	1.	×‘Ö¾server/services/ai_service.py
	â€¢	××ª×¨ ××ª ×”×¤×•× ×§×¦×™×” ×©××˜×¤×œ×ª ×‘×‘×•×˜ ×•×•××˜×¡××¤ (××©×”×• ×‘×¡×’× ×•×Ÿ handle_whatsapp_message / process_whatsapp_message).
	â€¢	×•×“× ×©×‘×ª×•×š ×”×¤×•× ×§×¦×™×” ×”×–×• ××ª×” ×œ× ××¨×™×¥ ×©×•× FAQ fast-path ×•×œ× ×œ×•×’×™×§×ª if/else ××•×¨×›×‘×ª ×œ×¤× ×™ ×”-agent, ××œ×:

from agents.agent_factory import get_or_create_agent, run_agent_conversation

async def handle_whatsapp_message(business_id: int, from_phone: str, text: str):
    # 1) ×‘× ×” ×”×™×¡×˜×•×¨×™×” ×§×¦×¨×” â€“ ×¨×§ ×”×”×•×“×¢×” ×”××—×¨×•× ×” ×©×œ ×”×œ×§×•×—
    messages = [
        {"role": "user", "content": text}
    ]

    # 2) ×”×‘× Agent ×¡×¤×¦×™×¤×™ ×œ×•×•××˜×¡××¤
    agent = get_or_create_agent(
        business_id=business_id,
        channel="whatsapp",
    )

    # 3) ×”×¨×¥ ××ª ×”-AgentKit
    result = await run_agent_conversation(
        agent=agent,
        business_id=business_id,
        channel="whatsapp",
        conversation_messages=messages,
        context={
            "business_id": business_id,
            "customer_phone": from_phone,
        },
    )

    reply_text = result.final_output_as(str) or ""
    return reply_text


	2.	×‘××•×ª×• ×§×•×‘×¥ â€“ ×•×“× ×©×‘Ö¾WhatsApp ×œ× ××¨×™×¦×™× FAQ fast-path:
	â€¢	×× ×™×© ×§×•×“ ×‘×¡×’× ×•×Ÿ:

if channel == "phone":
    try_faq...

×ª×©××™×¨.

	â€¢	×× ×™×© ×¡×¢×™×£ if channel == "whatsapp": try_faq... â€“ ×œ×”×¡×™×¨. ×•×•××˜×¡××¤ ×ª××™×“ â†’ AgentKit.

â¸»

2. ×œ×”×©×ª××© ×‘×¤×¨×•××¤×˜ ×”×¢×¡×§×™ ××”Ö¾DB ×’× ×‘×•×•××˜×¡××¤

××˜×¨×”:
×©×’× ×‘×•×•××˜×¡××¤, ×”-AgentKit ×™×§×‘×œ:

SYSTEM_RULES (×›×œ×œ×™ ××¢×¨×›×ª + ×›×œ×œ×™ ×›×œ×™×) + BUSINESS_PROMPT (×”×˜×§×¡×˜ ×©××ª×” ×›×•×ª×‘ ×‘××¡×š ×”×’×“×¨×•×ª ×”×¢×¡×§)

×¦×¢×“×™×:
	1.	×‘Ö¾server/agents/agent_factory.py
	â€¢	×‘×¤×•× ×§×¦×™×” get_or_create_agent(business_id, channel):

def get_or_create_agent(business_id: int, channel: str) -> Agent:
    cache_key = (business_id, channel)
    ...

    # ×˜×¢×Ÿ ××ª ×”×¤×¨×•××¤×˜ ×”×¢×¡×§×™ ××”-DB
    custom_instructions = load_business_prompt_from_db(business_id, channel=channel)
    # ×× ××™×Ÿ ×¤×¨×•××¤×˜ ×™×™×¢×•×“×™ ×œ×•×•××˜×¡××¤ â€“ ×§×— ××ª ×‘×¨×™×¨×ª ×”××—×“×œ ×©×œ ×”×¢×¡×§


	â€¢	×•×“× ×©Ö¾custom_instructions ×”×•× ×¨×§ ×˜×§×¡×˜ ×¢×¡×§×™ (××™ ×× ×—× ×•, ×©×¢×•×ª, ××—×™×¨×™× ×•×›×•â€™) â€“ ×‘×œ×™ ××™×œ×™× ×¢×œ tools ×•-JSON.

	2.	×‘××•×ª×• ×§×•×‘×¥ â€“ ×‘×•× ×” ×”-Agent ×¢×¦××•:

base_system_rules = """
ğŸ”’ SYSTEM CONTEXT:
- You are an appointment & customer assistant for this business.
- NEVER claim an action (appointment booked, WhatsApp sent, slot free/busy) without calling the proper tool THIS TURN.
- calendar_find_slots â†’ only then you can say "×¤× ×•×™"/"×ª×¤×•×¡".
- calendar_create_appointment â†’ only then you can say "×§×‘×¢×ª×™".
- whatsapp_send â†’ only then "×©×œ×—×ª×™ ××™×©×•×¨"/"×©×œ×—×ª×™ ×”×•×“×¢×”".
"""

full_instructions = base_system_rules + "\n\n" + custom_instructions

	â€¢	×•××ª full_instructions ×ª×¢×‘×™×¨ ×œ×™×¦×™×¨×ª ×”-Agent:

agent = Agent(
    model="gpt-4o-mini",
    instructions=full_instructions,
    tools=tools_to_use,
    ...
)



â¸»

3. ×œ×”×–×™×– ××ª ×›×œ ××•×¨×›×¡×˜×¨×¦×™×™×ª ×”×¤×’×™×©×” ×œÖ¾calendar_create_appointment

××˜×¨×”:
×›×©×™×© ×§×¨×™××” ×œÖ¾calendar_create_appointment â€“ ×”×›×œ ×§×•×¨×” ×‘××§×•× ××—×“:
	1.	×§×‘×™×¢×ª ×”×¤×’×™×©×” ×‘×™×•××Ÿ
	2.	×¢×“×›×•×Ÿ/×™×¦×™×¨×ª ×œ×™×“ (leads_upsert)
	3.	× ×™×¡×™×•×Ÿ ×©×œ×™×—×ª ×•×•××˜×¡××¤ (whatsapp_send)
	4.	×”×—×–×¨×ª ×¡×˜×˜×•×¡ ×‘×¨×•×¨ ×œ-AgentKit:
	â€¢	"whatsapp_status": "sent" / "pending" / "failed"

×¦×¢×“×™×:
	1.	×‘Ö¾server/agents/tools_calendar.py
	â€¢	××ª×¨ ××ª ×”Ö¾impl: _calendar_create_appointment_impl(input_data: CreateAppointmentInput)
	â€¢	××—×¨×™ ×©××ª×” ××¦×œ×™×— ×œ×©××•×¨ ××ª ×”×¤×’×™×©×” (transaction commit), ×”×•×¡×£:

from agents.tools_leads import leads_upsert_impl
from agents.tools_whatsapp import whatsapp_send_impl

def _calendar_create_appointment_impl(input_data: CreateAppointmentInput) -> CreateAppointmentResult:
    ...
    # ××—×¨×™ ×™×¦×™×¨×ª ×”×¤×’×™×©×” ×‘-DB (appointment)
    lead_result = None
    whatsapp_status = "skipped"

    # 1) leads_upsert
    try:
        lead_result = leads_upsert_impl(
            business_id=input_data.business_id,
            customer_name=input_data.customer_name,
            customer_phone=input_data.customer_phone,
            source="phone_booking",  # ××• "whatsapp_booking"
            appointment_id=appointment.id,
        )
    except Exception as e:
        # ×œ× ××¤×™×œ×™× ××ª ×”×¤×’×™×©×” â€“ ×¨×§ ×œ×•×’
        logger.exception("LEADS_UPSERT_FAILED", extra={"error": str(e)})
        lead_result = None

    # 2) whatsapp_send â€“ ×× ×¡×™× ×¤×¢× ××—×ª ×‘×œ×‘×“
    try:
        if input_data.customer_phone:
            wa_res = whatsapp_send_impl(
                business_id=input_data.business_id,
                to_phone=input_data.customer_phone,
                template="booking_confirmation",
                data={
                    "customer_name": input_data.customer_name,
                    "date_display": date_display,
                    "time_display": time_display,
                    "room_name": input_data.extra.get("room_name"),
                },
            )
            whatsapp_status = "sent" if wa_res.status == "sent" else "failed"
        else:
            whatsapp_status = "pending"
    except Exception as e:
        logger.exception("WHATSAPP_SEND_FAILED", extra={"error": str(e)})
        whatsapp_status = "failed"

    return CreateAppointmentResult(
        appointment_id=appointment.id,
        date_iso=date_iso,
        time_display=time_display,
        whatsapp_status=whatsapp_status,
        lead_id=lead_result.lead_id if lead_result else None,
    )


	2.	×•×“× ×©×”Ö¾wrapper ×©×œ ×”×›×œ×™ ×‘Ö¾agent_factory.py ××—×–×™×¨ ××ª ×”×©×“×” ×”×—×“×© ×œ-AgentKit:

@function_tool
def calendar_create_appointment_wrapped(...):
    ...
    result = _calendar_create_appointment_impl(input_data)
    return result.model_dump()  # ×›×•×œ×œ whatsapp_status



â¸»

4. ×œ×”×“×¨×™×š ××ª ×”-AgentKit ××™×š ×œ×“×‘×¨ ×œ×¤×™ ×”×¡×˜×˜×•×¡ ×©×œ ×”×•×•××˜×¡××¤

×›×“×™ ×©×™×§×¨×” ××” ×©×‘×™×§×©×ª:

â€œ×× ×¤×¢× ××—×ª ×”×•× ×œ× ××¦×œ×™×— ×©×™×’×™×“ ×©× ×§×‘×¢×” ×”×¤×’×™×©×” ××‘×œ ×™×©×œ×— ×¤×¨×˜×™× ×‘×”××©×šâ€

× ×•×¡×™×£ ×§×˜×¢ ×‘×¨×•×¨ ×œ-base_system_rules (×‘Ö¾agent_factory.py):

ğŸ“± WHATSAPP CONFIRMATION RULES:
- calendar_create_appointment returns "whatsapp_status":
  - "sent"    â†’ ×ª×’×™×“ ×œ×œ×§×•×—: "×§×‘×¢×ª×™ ×œ×š ××ª ×”×¤×’×™×©×” ×•×©×œ×—×ª×™ ×¢×›×©×™×• ××™×©×•×¨ ×‘×•×•×˜×¡××¤."
  - "failed"  â†’ ×ª×’×™×“: "×§×‘×¢×ª×™ ×œ×š ××ª ×”×¤×’×™×©×”, ×”×¤×¨×˜×™× ×™×™×©×œ×—×• ××œ×™×š ×××•×—×¨ ×™×•×ª×¨ ×‘×•×•×˜×¡××¤."
  - "pending" â†’ ×ª×’×™×“: "×§×‘×¢×ª×™ ×œ×š ××ª ×”×¤×’×™×©×”, ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ × ×©××¨ ×•×”×¤×¨×˜×™× ×™×™×©×œ×—×• ×‘×”××©×š."
- ××œ ×ª×’×™×“ "×©×œ×—×ª×™ ××™×©×•×¨" ×× whatsapp_status ××™× ×• "sent".

×›×š ×”-LLM ×¨×•××” ×‘××¤×•×¨×© ××™×š ×œ×”×©×ª××© ×‘×©×“×” whatsapp_status ×©×—×–×¨ ××”×›×œ×™.

×‘× ×•×¡×£, ×ª×©××™×¨ ××ª ×”-HARD BLOCK ×©×›×‘×¨ ×‘× ×™×ª× ×‘-ai_service.py (×©×‘×•×“×§ ×× ×‘×××ª × ×§×¨××• ×”×›×œ×™× ×œ×¤× ×™ ×©×”×•× ×××¤×©×¨ ×œ-LLM ×œ×”×’×™×“ â€œ×§×‘×¢×ª×™â€ ××• â€œ×©×œ×—×ª×™â€).

â¸»

5. Fine-tuning ×œ××”×™×¨×•×ª ×©×œ ×•×•××˜×¡××¤

×‘×’×œ×œ ×©×•×•××˜×¡××¤ ×–×” ×˜×§×¡×˜ (×œ× ×§×•×œ) ×•×”×•× ×›×‘×¨ ×™×—×¡×™×ª ××”×™×¨, ××‘×œ ×¢×“×™×™×Ÿ ×”×›×•×œ ×¢×•×‘×¨ ×“×¨×š AgentKit, ×›×“××™:
	1.	×‘Ö¾agent_factory.py â€“ ×¢×‘×•×¨ channel="whatsapp":

if channel == "whatsapp":
    model_settings = ModelSettings(
        temperature=0.2,
        max_tokens=120,   # ×˜×™×¤×” ×™×•×ª×¨ ××¨×•×š ××˜×œ×¤×•×Ÿ, ××‘×œ ×¢×“×™×™×Ÿ ×§×¦×¨
        tool_choice="auto",
        parallel_tool_calls=True,
    )
else:  # phone
    model_settings = ModelSettings(
        temperature=0.2,
        max_tokens=60,
        tool_choice="auto",
        parallel_tool_calls=True,
    )


	2.	×œ×”×©××™×¨ timeout ×©×œ client ×¢×œ ~4 ×©× ×™×•×ª, ×›×™ ×œ×¤×¢××™× ×¦×¨×™×š ×’× tools ×•×’× ×ª×©×•×‘×”. ×‘×–×” ×œ× ×œ×’×¢×ª ×›×¨×’×¢, ×¨×§ ×œ×•×•×“× ×©×œ× ×”×¢×œ×™×ª× ××ª ×–×” ×œÖ¾10+ ×©× ×™×•×ª.

â¸»

6. ××” ×××•×¨ ×œ×§×¨×•×ª ×¢×›×©×™×• ×‘×¤×•×¢×œ (×ª×¨×—×™×© ××œ×)

×©×™×—×ª ×˜×œ×¤×•×Ÿ
	1.	×œ×§×•×—: â€œ×× ×™ ×¨×•×¦×” ×œ×§×‘×•×¢ ×ª×•×¨ ×œ××—×¨ ×‘-10 ×œ×—×“×¨ ×“×•×‘××™â€
	2.	AgentKit:
	â€¢	×§×•×¨× calendar_find_slots ×œ×ª××¨×™×š ×”××‘×•×§×©
	â€¢	×× ×¤× ×•×™ ×‘-10 â†’ ×§×•×¨× calendar_create_appointment
	â€¢	×‘×ª×•×š ×”×›×œ×™:
	â€¢	×™×•×¦×¨ appointment
	â€¢	×¢×•×©×” leads_upsert
	â€¢	×× ×¡×” whatsapp_send
	3.	calendar_create_appointment ××—×–×™×¨:
{..., "whatsapp_status": "failed"} (×œ×“×•×’××”, ×›×™ ×•×•××˜×¡××¤ ×œ××˜×”)
	4.	×”-Agent:
	â€¢	××•××¨: â€œ×§×‘×¢×ª×™ ×œ×š ××ª ×”×¤×’×™×©×” ×œ××—×¨ ×‘-10:00, ×”×¤×¨×˜×™× ×™×™×©×œ×—×• ××œ×™×š ×‘×”××©×š ×‘×•×•×˜×¡××¤.â€
	â€¢	×œ× ××©×§×¨ ×¢×œ ×©×œ×™×—×ª ×”×•×“×¢×”.

×•×•××˜×¡××¤
	1.	×œ×§×•×—: â€œ×”×™×™, ××¤×©×¨ ×¤×¨×˜×™× ×¢×œ ×”×—×“×¨ × ×™×• ×™×•×¨×§?â€
â†’ handle_whatsapp_message â†’ AgentKit (channel=â€œwhatsappâ€) + business prompt
â†’ ×ª×©×•×‘×” ×§×¦×¨×”, ××”×™×¨×”.
	2.	×œ×§×•×—: â€œ×ª×‘×“×•×§ ×œ×™ ×©×™×©×™ ×”×‘× ×‘×©×¢×” 21:00 ×—×“×¨ ×‘×¨×¦×œ×•× ×”â€
â†’ AgentKit ×§×•×¨× calendar_find_slots + calendar_create_appointment ×›××• ×‘×˜×œ×¤×•×Ÿ
â†’ whatsapp_status="sent" â†’ ×ª×©×•×‘×”:
â€œ×§×‘×¢×ª×™ ×œ×š ××ª ×”×—×“×¨ ×‘×¨×¦×œ×•× ×” ×œ×©×™×©×™ ×”×‘× ×‘-21:00, ×•×©×œ×—×ª×™ ×¢×›×©×™×• ××™×©×•×¨ ×‘×•×•×˜×¡××¤.â€

â¸»

×× ×ª×¢×‘×™×¨ ×œ××¤×ª×— ××ª ×”×”× ×—×™×” ×”×–×• ××—×“-×œ××—×“, ×”×•× ×™×“×¢:
	â€¢	××™×¤×” ×‘×§×•×“ ×œ×”×›× ×™×¡ ××ª ×”×©×™× ×•×™×™×
	â€¢	××™×š AgentKit ×¦×¨×™×š ×œ×”×©×ª××© ×‘×¤×¨×•××¤×˜ ××”Ö¾DB
	â€¢	××™×š ×œ×‘× ×•×ª ××ª ×–×¨×™××ª ×”×¤×’×™×©×” + ×•×•××˜×¡××¤ ×›×š ×©×”×™× ×’× ××”×™×¨×”, ×’× ×××™× ×”, ×•×’× ×œ× ××©×§×¨×ª.