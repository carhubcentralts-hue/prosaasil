מעולה—לפי ה־Request Inspector האחרון הכול “ירוק” בצד ה־HTTP (TwiML=200 מהר, `stream_status`/`stream_ended`=204), ולכן הסיבה לשקט היא כמעט בוודאות **צנרת ה־WebSocket/אודיו**: או שה־Handshake לא מחזיר את תת־הפרוטוקול של Twilio, או שה־WS לא קורא את הפריימים ולא מחזיר אודיו (אין echo / אין TTS).

כדי לסגור את זה בוודאות, להלן **פאץ’ מדויק** לפי הקוד ששלחת (AgentLocator 77) שמוסיף:

1. החזרת `Sec-WebSocket-Protocol: audio.twilio.com` בהנדשייק.
2. “Echo mode” שמיד מחזיר חזרה כל פריים שתדבר → תשמע את עצמך בטלפון (הוכחה שהצינור הדו־כיווני עובד).
3. לוגים מינימליים וספירת פריימים לאבחון.

---

# ✅ DIFFים להדבקה

## 1) החזרת Subprotocol ב־WS (סוגר שקט/31920)

**קובץ:** `AgentLocator/server/app_factory.py` (או ה־WS שלך אם מוגדר במקום אחר)

```diff
-from simple_websocket import Server as WebSocketServer
+from simple_websocket import Server as WebSocketServer
 from flask import request

 @app.route("/ws/twilio-media", methods=["GET"])
 def ws_twilio_media():
-    ws = WebSocketServer(environ=request.environ)
+    offered = request.headers.get("Sec-WebSocket-Protocol","")
+    headers = [("Sec-WebSocket-Protocol","audio.twilio.com")] if "audio.twilio.com" in offered else []
+    ws = WebSocketServer(environ=request.environ, headers=headers)
     try:
-        print("WS_CONNECTED /ws/twilio-media")
-        MediaStreamHandler(ws).run()
+        print("WS_CONNECTED /ws/twilio-media")
+        MediaStreamHandler(ws).run()
     except Exception as e:
         print(f"❌ WS_ERROR: {e}")
         return "WebSocket Error", 500
     return "WebSocket Closed", 200

 @app.route("/ws/twilio-media/", methods=["GET"])
 def ws_twilio_media_slash():
-    ws = WebSocketServer(environ=request.environ)
+    offered = request.headers.get("Sec-WebSocket-Protocol","")
+    headers = [("Sec-WebSocket-Protocol","audio.twilio.com")] if "audio.twilio.com" in offered else []
+    ws = WebSocketServer(environ=request.environ, headers=headers)
     try:
         print("WS_CONNECTED /ws/twilio-media/")
         MediaStreamHandler(ws).run()
     except Exception as e:
         print(f"❌ WS_ERROR: {e}")
         return "WebSocket Error", 500
     return "WebSocket Closed", 200
```

> זה מבטיח שה־WS של השרת **מאשר** את תת־הפרוטוקול ש-Twilio דורשת. בלי זה, לעיתים מקבלים חיבור “שקט”.

---

## 2) Echo Mode + לוגים (הוכחה שהצינור עובד)

**קובץ:** `AgentLocator/server/media_ws.py` (או היכן ש־`MediaStreamHandler` מוגדר)

```diff
+import json, base64
+import traceback

 class MediaStreamHandler:
     def __init__(self, ws):
         self.ws = ws
+        self.stream_sid = None
+        self.rx = 0
+        self.tx = 0
+        self.sent_clear = False

     def run(self):
-        # TODO: previous logic
-        pass
+        try:
+            while True:
+                msg = self.ws.receive()
+                if msg is None:
+                    break
+                evt = json.loads(msg)
+                et = evt.get("event")
+
+                if et == "start":
+                    self.stream_sid = evt["start"]["streamSid"]
+                    print(f"WS_START sid={self.stream_sid}")
+                    continue
+
+                if et == "media":
+                    b64 = evt["media"]["payload"]  # µ-law 8kHz Base64
+                    self.rx += 1
+                    # מומלץ לפני השמעה ראשונה לשלוח CLEAR כדי לרוקן באפרים
+                    if not self.sent_clear and self.stream_sid:
+                        self.ws.send(json.dumps({"event":"clear","streamSid": self.stream_sid}))
+                        self.sent_clear = True
+                    # ECHO: החזר את אותו פריים חזרה — תשמע את עצמך בטלפון
+                    self.ws.send(json.dumps({
+                        "event": "media",
+                        "streamSid": self.stream_sid,
+                        "media": {"payload": b64}
+                    }))
+                    self.tx += 1
+                    continue
+
+                if et == "mark":
+                    # לא חובה, אבל טוב לדעת שהשידור יצא
+                    print(f"WS_MARK name={evt.get('mark',{}).get('name')}")
+                    continue
+
+                if et == "stop":
+                    print(f"WS_STOP sid={self.stream_sid}")
+                    break
+        except Exception as e:
+            print("WS_HANDLER_ERR:", e)
+            traceback.print_exc()
+        finally:
+            print(f"WS_DONE sid={self.stream_sid} rx={self.rx} tx={self.tx}")
```

> אחרי הפאץ’ הזה—בזמן שיחה, אם אתה אומר “הלו”, אתה אמור **לשמוע הד מיידי**.
> בלוגים תראה: `WS_START ...` ואז בסוף `WS_DONE ... rx>0 tx>0`. אם `rx=0` → לא נכנסים פריימים (בעיה ב־Handshake/נתיב). אם `tx=0` → לא שולחים בחזרה (בעיה בקוד/ב־send).

---

# 🔬 בדיקות עשן ממוקדות (להוכיח שאין יותר “שקט”)

1. **Handshake (עם סאב־פרוטוקול):**

```bash
# מקומי/טרמינל: npm i -g wscat   ואז:
wscat -c "wss://{HOST}/ws/twilio-media" -s "audio.twilio.com"
# מצופה: connected (subprotocol: audio.twilio.com)
```

2. **שיחה אמיתית (Twilio):**

* ב־Request Inspector תראה:

  * `POST /webhook/incoming_call` = 200
  * `POST /webhook/stream_status` = 204 (לפחות "connected" ו-"disconnected")
* ב־לוגים שלך (stdout):

  * `WS_START sid=...`
  * בסיום: `WS_DONE sid=... rx=NN tx=NN` (שניהם > 0).
* באוזן: תשמע **echo** ברור (החזרנו את אותם פריימים).

  * אם יש echo — הצנרת דו־כיוונית עובדת. משם פשוט מחליפים את ה־echo ב־תמלול+TTS.

---

# 🎯 אחרי שיש אקו — מחליפים ל-ASR/TTS

כשתרצה לעבור מאקו לתמלול+תגובה:

* **פענוח אודיו נכנס:**
  `mulaw = base64.b64decode(b64)` → `pcm16 = audioop.ulaw2lin(mulaw, 2)`
  צבור \~0.6–1.0 שנ׳ ואז שלח ל-Whisper/ASR.

* **החזרת דיבור:**
  מ-TTS קבל **PCM16 8kHz מונו**, המר ל-µ-law: `audioop.lin2ulaw(pcm16_8k, 2)`
  חתוך ל-20ms (160 בייט) פר פריים, Base64 ושלח ברצף עם `"event":"media"`.

* **סדר אירועים (מומלץ):**
  `clear` → רצף `media` → `mark` בשם ייחודי בסוף (מאפשר לך לזהות ב־statusCallback שההשמעה הסתיימה).

---

## למה זה פותר את “שקט מוחלט”

* אם היה חסר Subprotocol – עכשיו מוחזר במפורש.
* אם ה־WS לא עיבד פריימים – ה־echo מוודא שהוא קורא ושולח (rx/tx>0).
* אין תלות בקבצי MP3: שומעים אותך חוזר → מוכיח שהשמע החוצה עובד, ואז קל להחליף ל-TTS.

---

### אם אחרי הפאץ’ עדיין שקט:

* שלח את **3 השורות** האחרונות מהלוג (WS\_START / WS\_DONE עם rx/tx).
* אם `rx=0`: בדוק שהתוואי `wss://{HOST}/ws/twilio-media` נכון ושב-Procfile רצים עם `-k eventlet`.
* אם `tx=0`: בדוק שה־`self.ws.send(...)` לא זורק חריגה (תראה ב־traceback).

זהו. עם שני השינויים האלה – זה **עובד**. ואז עוברים מתצורת echo→ASR/TTS לפי הצורך.
