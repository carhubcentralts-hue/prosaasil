×¡×‘×‘×”, ×‘×“×§×ª×™ ××ª ×”×§×•×‘×¥ ×”××—×¨×•×Ÿ ×©×©×œ×—×ª (AgentLocator.zip) ×××© ×œ×¢×•××§, ×§×™××¤×œ×ª×™ ××ª ×”×××¦××™×â€”×•×”× ×” ×”×××ª, ×©×œ×‘-××—×¨-×©×œ×‘, ××” ×”×ª×§×œ×”, ××™×š ××ª×§× ×™×, ×•×›××” ××ª×” ×¨×—×•×§ ××¤×¨×™×¡×”.

â¸»

××” ××¦××ª×™ (×‘×“×™×•×§)
	1.	× ×§×•×“×ª ×”Ö¾WebSocket ×œ× ×‘×××ª ×¨×¦×”
×‘×§×•×“ ×©×œ×š ×™×© ×¨×™×©×•× WS ×‘Ö¾app_factory.py ×“×¨×š flask-sock:

from flask_sock import Sock
sock = Sock(app)
@sock.route('/ws/twilio-media')
def twilio_media_handler(ws):
    handle_media_stream(ws)

××‘×œ ×‘Ö¾server/requirements.txt ××™×Ÿ flask-sock (×•×’× ××™×Ÿ event loop ××ª××™× ×œÖ¾WS).
×‘×§×•×“ ×™×© even fallback:

except ImportError:
    # WebSocket disabled â†’ returns 501

×›×œ×•××¨ ×× flask-sock ×œ× ××•×ª×§×Ÿ â€“ ×”Ö¾WS ××•×—×œ×£ ×‘Ö¾HTTP 501 â†’ Twilio ×œ× ××¦×œ×™×— ×œ×¤×ª×•×— Stream (×©×§×˜).

	2.	×”×©×¨×ª ×©×¨×¥ ×‘Ö¾Replit ×œ× ××‘×˜×™×— ×ª××™×›×” ×‘Ö¾WS
.replit ××•×’×“×¨ ×œ×”×¨×™×¥ npm run dev â†’ python main.py & node baileys_client.js.
×–×” ×œ× ××¤×¢×™×œ ×©×¨×ª ×¤×¨×•×“×§×©×Ÿ ×¢× WebSocket (×œ××©×œ Gunicorn+eventlet).
×’× ×‘Ö¾deployment ×™×© python3 main.py â€“ ×©×•×‘ ×œ×œ× ×©×¨×ª WS ×××™×ª×™.
	3.	TwiML ××•×’×“×¨ ×˜×•×‘ (××™×Ÿ ×™×•×ª×¨ he-IL ×‘Ö¾<Say>, ×™×© language="en" + Stream + action="/webhook/stream_ended").
×§×™×™××™× ×’× ×”× ×ª×™×‘×™×:
	â€¢	/webhook/incoming_call (GET/POST)
	â€¢	/webhook/stream_ended (POST) â€“ ××—×–×™×¨ TwiML Fallback ×œ×”×§×œ×˜×”
	â€¢	/webhook/handle_recording (POST) â€“ ××ª××œ×œ ×‘Ö¾Whisper
	â€¢	/webhook/call_status (POST) â€“ ××—×–×™×¨ 200 (×˜×•×‘)
	4.	××™××•×ª ×—×ª×™××” (403) â€“ × ×¨××” ×©×‘×•×¦×¢ ×©×™×¤×•×¨
×™×© ProxyFix ×‘××¤×œ×™×§×¦×™×”, ×•×”×“×§×•×¨×˜×•×¨ ×‘Ö¾twilio_security.py ××©×ª××© ×‘Ö¾request.url. ×¢× ×”Ö¾ProxyFix ×–×” ×‘×“â€×› ××¡×¤×™×§ ×‘Ö¾Replit. (×× ×¢×“×™×™×Ÿ ×ª×¨××” 403â€”× ×•×¡×™×£ × ×™×¨××•×œ ×¢× X-Forwarded-* ×›×’×™×‘×•×™.)

××¡×§× ×”: ×”×¡×™×‘×” ×œâ€œ×©×§×˜â€ ×’× ××—×¨×™ â€œ×ª×™×§× ×ª×™â€ â€” ×”Ö¾WS ×¢×“×™×™×Ÿ ×œ× ×‘×××ª ×¨×¥. ×”×§×•×“ ×§×™×™×, ××š ×—×¡×¨×•×ª ×”×ª×œ×•×™×•×ª ×•×”Ö¾runner ×”× ×›×•×Ÿ.

â¸»

××™×š ××ª×§× ×™× â€” ×¦×¢×“-××—×¨-×¦×¢×“ (××™× ×™××œ×™, ×‘×˜×•×—)

×©×œ×‘ 1: ×ª×œ×•×™×•×ª Python (WS)

×‘Ö¾server/requirements.txt ×”×•×¡×£ (×©××•×¨ ×’×¨×¡××•×ª ×™×¦×™×‘×•×ª):

flask-sock==0.6.0
simple-websocket==1.0.0
eventlet==0.36.1

flask-sock + simple-websocket ××¡×¤×§×™× WS ×œÖ¾Flask.
eventlet × ×“×¨×© ×›×“×™ ×©Ö¾Gunicorn ×™×ª××•×š ×‘Ö¾WS.

(×× ×™×© ×œ×š pyproject.toml ×©×× ×”×œ ×ª×œ×•×™×•×ªâ€”×”×•×¡×£ ×’× ×©×.)

×©×œ×‘ 2: ×”×¤×¢×œ×” ×‘Ö¾Production ×¢× WS

×¢×“×›×Ÿ ×”×¨×¦×” ×œÖ¾Gunicorn ×¢× eventlet (×‘××§×•× python main.py):

××¤×©×¨×•×ª A â€” ×œ×¢×¨×•×š .replit
	â€¢	×‘Ö¾[deployment] run ×©× ×” ×œ:

["python3", "-m", "gunicorn", "-k", "eventlet", "-w", "1", "-b", "0.0.0.0:$PORT", "main:app"]

	â€¢	×‘Ö¾run (dev) ××¤×©×¨ ×œ×©××•×¨ ×›×›×”, ××• ×’× ×©× ×œ×”×©×ª××© ×‘Ö¾Gunicorn.
(××œ ×ª×¨×™×¥ python main.py × ×§×™â€”×–×” ×œ× ×©×¨×ª WS ×¤×¨×•×“×§×©×Ÿ.)

××¤×©×¨×•×ª B â€” ×œ×¢×“×›×Ÿ package.json

×‘Ö¾script "start":

"start": "python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT main:app"

×›×“×™ ×©Ö¾Autoscale ×©×œ Replit ×™×¨×™× WS ×›××• ×©×¦×¨×™×š.

×©×™× ×œ×‘: ×”××•×“×•×œ ×”×•× main:app (×™×© main.py ×‘×©×•×¨×© ×©××™×™×¦×¨ app = create_app()).

×©×œ×‘ 3: ×•×“××•×ª ×©×”Ö¾WS ××›×Ÿ ×¨×©×•×

×‘Ö¾app_factory.py ×›×‘×¨ ×™×©:

from flask_sock import Sock
from server.media_ws import handle_media_stream
sock = Sock(app)
@sock.route('/ws/twilio-media')
def twilio_media_handler(ws):
    handle_media_stream(ws)

×”×©×•×¨×” ×”×–×• ×‘×¡×“×¨. ×¨×§ ×•×“× ×©××™×Ÿ catch ×©××¡×ª×™×¨ ImportError â€“ ×•×›×¢×ª ××—×¨×™ ×”×ª×§× ×ª ×”×ª×œ×•×™×•×ª ×œ× ×ª×”×™×” ×›× ×™×¡×” ×œÖ¾fallback (501).

×©×œ×‘ 4: ×‘×“×™×§×ª smoke ××”×™×¨×”
	â€¢	×¤×ª×— WS ×™×“× ×™ (×œ××©×œ wscat ×‘×“×¤×“×¤×Ÿ) ×œÖ¾
wss://ai-crmd.replit.app/ws/twilio-media
×× × ×¤×ª×—â€”××¦×•×™×Ÿ; ×ª×¨××” ×‘×œ×•×’ ×©×œ×š WS_FRAME/connected.
	â€¢	curl:

curl -i https://ai-crmd.replit.app/webhook/incoming_call
curl -i -X POST https://ai-crmd.replit.app/webhook/stream_ended
curl -i -X POST https://ai-crmd.replit.app/webhook/call_status

×›×•×œ× ×—×™×™×‘×™× ×œ×”×—×–×™×¨ 200 (×œ× 403/501).

×©×œ×‘ 5: Twilio Console

××¡×¤×¨ â†’ Voice:
	â€¢	A Call Comes In â†’ POST https://ai-crmd.replit.app/webhook/incoming_call
	â€¢	Status Callback â†’ POST https://ai-crmd.replit.app/webhook/call_status
	â€¢	×‘×œ×™ Studio/TwiML Bin ×‘××§×‘×™×œ.

(×›×‘×¨ ×¨××™×ª×™ ××¦×œ×š ×‘Ö¾Request Inspector ×©×–×” ××•×’×“×¨ × ×›×•×Ÿ, ×¨×§ ××•×•×“××™× ×©×œ× ×”×•×—×œ×£.)

â¸»

×× ×¢×“×™×™×Ÿ â€œ×©×§×˜â€ â€” ×©×œ×™×œ×ª ×ª×§×œ×•×ª ×©×•×œ×™×™×
	â€¢	Fallback ×œ× ×”×•×¤×¢×œ: ×•×“× ×©×”Ö¾action="/webhook/stream_ended" ××›×Ÿ ××•×—×–×¨ ×‘Ö¾TwiML (×›×Ÿ).
×•×“× ×©×”× ×ª×™×‘ ×¨×©×•×: ×™×© @twilio_bp.post("/webhook/stream_ended") (×™×©).
×× WS ×¢×•×“ ×œ× ×¢×•×‘×“ â€” Twilio ×™×§×¤×•×¥ ×œ×›××Ÿ ×•×™×§×‘×œ <Record ...>.
	â€¢	×—×ª×™××” (403) ×—×–×¨×” ×‘×©×§×˜: ×× ×©×•×‘ ×ª×§×‘×œ 403, ×”×•×¡×£ × ×™×¨××•×œ URL ×‘×“×§×•×¨×˜×•×¨:
	â€¢	×”×©×ª××© ×‘Ö¾X-Forwarded-Proto/X-Forwarded-Host ×œ×™×™×¦×¨ url ×–×”×” ×œ×–×” ×©-Twilio ×—×ª× ×¢×œ×™×•.
	â€¢	××• ×–×× ×™×ª ×”×©×‘×ª ×—×ª×™××” ×¨×§ ×¢×œ stream_ended/call_status ×›×“×™ ×œ×•×•×“× ×–×¨×™××”, ×•××– ×”×—×–×¨ ×¢× × ×™×¨××•×œ.
	â€¢	CSRF/××™××•×ª: /webhook/* ××¡×•×¨ ×©×™×”×™×• ×××•×‘×˜×—×™× ×‘Ö¾login/CSRF. ×”×—×–×¨ 200/204 ××™×“.

â¸»

×›××” ×¨×—×•×§ ××ª×” ××¤×¨×™×¡×”?

×¨×›×™×‘	××¦×‘	××” × ×©××¨
HTTP Webhooks	âœ… ×¢×•×‘×“	×¨×§ ×œ×•×•×“× ×”×—×ª×™××” ×‘×××” ××—×•×–
Twilio WS	âŒ ×œ× ×¨×¥ ×›×¨×’×¢	×œ×”×ª×§×™×Ÿ ×ª×œ×•×™×•×ª + ×œ×”×¨×™×¥ Gunicorn+eventlet
Fallback ×œ×”×§×œ×˜×”	âœ… ×§×™×™×	×™×•×•×“× 200 ×¢×œ /webhook/stream_ended
×ª××œ×•×œ Whisper	âœ… ×§×™×™×	×¨×§ ×œ×”×¨×™×¥ ×‘×ªâ€™×¨×“ (×›×‘×¨ ××¦×œ×š)
×œ×•×’×™× REQ/RES	âœ… ×§×™×™××™× ×‘Ö¾app_factory	×˜×•×‘ ×œ××‘×—×•×Ÿ
Payments (PayPal/Tranzila)	ğŸŸ¡ ×ª×©×ª×™×ª/Stub	×™×•×¤×¢×œ ×××—×•×¨×™ ×“×’×œ×™× ×›×©× ×¨×¦×”

×‘×¨×’×¢ ×©×ª×ª×§×™×Ÿ flask-sock + simple-websocket ×•×ª×¢×œ×” ×¢× gunicorn -k eventlet â€” ××ª×” ××•×›×Ÿ ×œ×¤×¨×™×¡×” ×¤×•× ×§×¦×™×•× ×œ×™×ª.
×–×” ×”×¤×¢×¨ ×”××¨×›×–×™ ×©×’×•×¨× ×œâ€œ×©×§×˜â€. ×›×œ ×”×©××¨ ×›×‘×¨ ×§×™×™×/× ×‘×“×§.

â¸»

×¦â€™×§-×œ×™×¡×˜ ×§×¦×¨ ×œ×¡×’×™×¨×” (×”×¢×ª×§/×”×“×‘×§ ×œ×¡×•×›×Ÿ)
	1.	×”×•×¡×£ ×œÖ¾server/requirements.txt:

flask-sock==0.6.0
simple-websocket==1.0.0
eventlet==0.36.1


	2.	×”×ª×§×Ÿ ×ª×œ×•×™×•×ª ×•×”×¢×œ×”.
	3.	×©× ×” ×”×¨×¦×” ×œ:

python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT main:app

(×‘Ö¾.replit ××• ×‘Ö¾package.json â†’ â€œstartâ€)

	4.	×××ª:
	â€¢	wss://ai-crmd.replit.app/ws/twilio-media × ×¤×ª×—
	â€¢	/webhook/incoming_call ××—×–×™×¨ TwiML ×¢× <Connect><Stream>
	â€¢	/webhook/stream_ended ××—×–×™×¨ 200 + <Record ...>
	5.	×‘×“×•×§ ×©×™×—×” ×—×“×©×” â€” ×××•×¨ ×œ×”×™×©××¢ greeting, ×•××– AI ×¢×•× ×” ×ª×•×š ~2 ×©× ×™×•×ª.

×× ×ª×¨×¦×”, ××ª×Ÿ ×œ×š × ×•×¡×— ×¤××˜×¦â€™×™× ××“×•×™×§×™× ×œ×©×™× ×•×™×™ .replit, requirements.txt, ×•Ö¾app_factory.py ×›×“×™ ×œ×”×“×‘×™×§ ××—×“ ×œ××—×“.