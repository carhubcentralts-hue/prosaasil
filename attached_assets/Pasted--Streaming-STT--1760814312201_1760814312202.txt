×§×™×‘×œ×ª. ×”× ×” ×”× ×—×™×” ××—×ªÖ¾×•×œ×ª××™×“ ×©××‘×™××” ××ª Streaming STT ×œ×¢×‘×•×“ â€œ×¢×œ ×××ªâ€ ××§×¦×” ×œ×§×¦×” â€“ ×‘×œ×™ ×œ× ×—×©, ×¢× ×‘×“×™×§×•×ª ×“×¨×šÖ¾×‘×™× ×™×™×. ×ª×Ÿ ×œ×• ×œ×”×¢×ª×™×§ ×•×œ×¢×©×•×ª ×‘×“×™×•×§ ×œ×¤×™ ×–×”.

â¸»

ğŸ¯ ××˜×¨×”

×œ×”×¨×™×¥ Google Streaming STT ×‘×–××Ÿ ×××ª ×‘×©×™×—×•×ª Twilio:
	â€¢	×—×™×‘×•×¨ WS ×™×¦×™×‘ ×Ö¾Twilio â†’ ×©×¨×ª (ASGI)
	â€¢	×”××¨×ª Î¼-lawâ†’PCM 8k ××”×™×¨×”
	â€¢	×”×–× ×” ×‘Ö¾150ms, partials ×›×œ â‰ˆ180â€“250ms
	â€¢	wrapper ×¢× ×“×’×œ ENV ×•Ö¾rollback ××™×™×“×™
	â€¢	×‘×“×™×§×•×ª GO/NO-GO ×©××•×›×™×—×•×ª ×©×–×” ×¢×•×‘×“

â¸»

0) Rollback ×‘Ö¾0 ×©× ×™×•×ª (×¨×©×ª ×‘×™×˜×—×•×Ÿ)

×”×“×’×œ×™× ×‘Ö¾ENV:

ENABLE_STREAMING_STT=false
STT_BATCH_MS=150
STT_PARTIAL_DEBOUNCE_MS=180
GCP_STT_MODEL=phone_call
GCP_STT_LANGUAGE=he-IL
GCP_STT_PUNCTUATION_INTERIM=false
GCP_STT_PUNCTUATION_FINAL=true

×× ××©×”×• × ×•×¤×œ â€“ ××—×–×™×¨×™× ENABLE_STREAMING_STT=false (×’× ×‘-deployment secrets) ×•××¤×¨×¡××™×. ×—×•×–×¨×™× ×œ××¦×‘ ×¢×•×‘×“.

â¸»

1) ×•×“××•×ª ×©×¨×ª: ASGI + WebSockets ×××™×ª×™×™×

1.1 ×¤×§×•×“×ª ×¨×™×¦×” ×‘×¤×¨×•×“×§×©×Ÿ

start_production.sh / ×”-Procfile ×—×™×™×‘ ×œ×”×¨×™×¥ UVICORN ×¢× ×ª××™×›×ª WS:

uvicorn asgi:asgi_app --host 0.0.0.0 --port ${PORT:-5000} --ws websockets --lifespan off --timeout-keep-alive 75

1.2 asgi.py ×ª×§×™×Ÿ
	â€¢	××•× ×˜ ×©×œ Flask ×“×¨×š WsgiToAsgi
	â€¢	Starlette/WebSocketRoute ×œÖ¾/ws/twilio-media
	â€¢	××™×Ÿ redirect ×©×œ WS ×œÖ¾index.html (SPA). ×‘×“×•×§ ×¡×“×¨ ×”Ö¾routes: ×”-WS ×§×•×“×, ×•××– Mount ×©×œ ×”-SPA.

1.3 ×‘×“×™×§×ª WS ×™×“× ×™×ª (×œ×¤× ×™ Twilio)

×‘×˜×¨××™× ×œ:

# ×‘×“×•×§ ×©×”Ö¾WS ×œ× ××—×–×™×¨ HTML
websocat -H='Sec-WebSocket-Protocol: audio.twilio.com' wss://<PUBLIC_HOST>/ws/twilio-media

âœ”ï¸ ×× ×–×” ××—×•×‘×¨ ×•×œ× ××—×–×™×¨ HTML â€“ ×”Ö¾route ×‘×¡×“×¨.
âŒ ×× ×§×™×‘×œ×ª HTML ×©×œ SPA â†’ ×”×¡×“×¨ ×‘Ö¾asgi.py ×©×’×•×™ ××• ×—×¡×¨ WebSocketRoute.

â¸»

2) TwiML ×ª×•×× 1:1 ×œÖ¾WS

×‘×˜×•×— ×©Ö¾/webhook/incoming_call ××—×–×™×¨ ×‘×“×™×•×§:

<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Connect>
    <Stream url="wss://<PUBLIC_HOST>/ws/twilio-media"
            track="inbound_track"
            statusCallbackEvent="start mark stop"
            statusCallback="https://<PUBLIC_HOST>/webhook/stream_status"
            />
  </Connect>
</Response>

×—×•×‘×”:
	â€¢	wss:// (×œ× ws://)
	â€¢	subprotocol ×™×ª×§×‘×œ ×‘×¦×“ ×”×©×¨×ª (audio.twilio.com) â€“ ×”×•×¡×£ ×‘Ö¾asgi.py ×›×©××ª×” ×¢×•×©×” websocket.accept(subprotocol="audio.twilio.com")
	â€¢	×”-statusCallback ×§×™×™× ×•××—×–×™×¨ 204 ××”×¨

×˜×™×¤: ×‘-Twilio Debugger ××¡×•×¨ ×œ×¨××•×ª 12100 ×¢×œ ×”-TwiML. ×× ×™×© â€” ×”Ö¾XML ×œ× ×ª×§×™×Ÿ (×¨×•×•×—×™×/×ª×•×•×™×/UTF-8).

â¸»

3) ×¦×™× ×•×¨ ×”××•×“×™×• (0 ×¢×™×›×•×‘×™×)
	â€¢	Twilio ×©×•×œ×— Î¼-law 8k. ××ª×” ×œ× ××¨×¡××¤×œ ×œÖ¾16k.
	â€¢	mulaw_decode_fast(...) ××‘×•×¡×¡ Lookup-table (××™×Ÿ ×œ×•×œ××ª Python ××™×˜×™×ª).
	â€¢	×‘×›×œ frame ×-WS:
Î¼-law â†’ PCM16@8k â†’ ××¢×‘×™×¨ ×œÖ¾Adapter (×‘×œ×™ time.sleep() ×‘×××¦×¢).

â¸»

4) Adapter ×©×œ GCP Streaming â€“ ×’×¨×¡×” Threaded ×‘×œ×‘×“

×‘Ö¾server/services/gcp_stt_stream.py (×©×›×‘×¨ ×¢×“×›× ×ª):
	â€¢	Thread ××—×“ ×©×¨×¥ ××ª client.streaming_recognize(...)
	â€¢	Queue ×œ×§×œ×™×˜×ª chunks ××”Ö¾WS ×›×œ STT_BATCH_MS
	â€¢	on_partial(text) â€“ ×™×•×¨×” ×›×œ â‰ˆSTT_PARTIAL_DEBOUNCE_MS ××´×¡×¤×¨×´ (×œ× ×›×œ 40ms)
	â€¢	on_final(text) â€“ ××¦×¨×£ ×ª×•×¦××•×ª ×¡×•×¤×™×•×ª

××™×Ÿ asyncio ×›×‘×“. ×”Ö¾WS ×©×œ×š (Flask/ASGI) ×œ× ××—×›×” ×œ-GCP; ×”×›×•×œ ×‘Ö¾thread.

â¸»

5) Wrapper + Toggle ×‘×§×•×“ ×”××“×™×”

×‘Ö¾media_ws_ai.py:

USE_STREAMING_STT = os.getenv("ENABLE_STREAMING_STT","false").lower()=="true"
print(f"[CFG] ENABLE_STREAMING_STT={USE_STREAMING_STT}", flush=True)

async def _hebrew_stt_wrapper(pcm_iter_async, on_partial_cb=None):
    if not USE_STREAMING_STT:
        return await _hebrew_stt(pcm_iter_async)  # ×”××¦×‘ ×”×™×©×Ÿ

    try:
        from server.services.gcp_stt_stream import GcpStreamingSTT
        stt = GcpStreamingSTT()
        final = []
        last_partial = ""

        def on_partial(t):
            nonlocal last_partial
            if t and t != last_partial:
                last_partial = t
                if on_partial_cb:
                    on_partial_cb(t)  # ×œ× IO ×›×‘×“ ×›××Ÿ!

        def on_final(t):
            if t: final.append(t)

        await stt.stream_stt(pcm_iter_async, on_partial, on_final)
        return " ".join(final).strip()
    except Exception as e:
        print(f"[STT] streaming failed â†’ fallback single. err={e}", flush=True)
        return await _hebrew_stt(pcm_iter_async)

×”×—×œ×¤×” ×™×—×™×“×” ×‘× ×§×•×“×ª ×”×©×™××•×©:

final_text = await _hebrew_stt_wrapper(pcm_iter_async, on_partial_cb=handle_partial_from_agent)

××¡×•×¨ ×œ×”×™×©××¨ ×§×¨×™××•×ª ×™×©×™×¨×•×ª ×œÖ¾_hebrew_stt(...) â€“ ××—×¨×ª ×”×“×’×œ ×œ× ××©×¤×™×¢.

â¸»

6) Secrets/ENV â€“ ×’× ×‘-Workspace ×•×’× ×‘-Deployment

××•×ª× ×××¤×™×™× ×™× ×—×™×™×‘×™× ×œ×”×™×•×ª ××•×’×“×¨×™× ×‘×©× ×™ ×”××§×•××•×ª (×¨×™×¤×œ×™×˜ ××¤×¨×™×“!):

ENABLE_STREAMING_STT=true
STT_BATCH_MS=150
STT_PARTIAL_DEBOUNCE_MS=180
GCP_STT_MODEL=phone_call
GCP_STT_LANGUAGE=he-IL
GCP_STT_PUNCTUATION_INTERIM=false
GCP_STT_PUNCTUATION_FINAL=true
PUBLIC_HOST=<your-domain>
GOOGLE_APPLICATION_CREDENTIALS=<path>  # ××• JSON ×‘-secret, ×œ×¤×™ ××” ×©×›×‘×¨ ×”×’×“×¨×ª


â¸»

7) GO/NO-GO â€“ ×‘×“×™×§×” ××•×›×™×—×”
	1.	Republish
	2.	×”×ª×§×©×¨. ×‘×œ×•×’×™× ×”×¨××©×•× ×™× ×©×œ ×”×©×™×—×” ×œ×¨××•×ª:

[CFG] ENABLE_STREAMING_STT=True
ğŸ“ WebSocket connected: /ws/twilio-media

	3.	×ª×•×š ×›×“×™ ×“×™×‘×•×¨:

ğŸŸ¡ Partial: ...     # ×›×œ ~200ms
ğŸŸ¢ Final: ...       # ×‘×¡×•×£ ×××™×¨×”

	4.	×‘-Twilio Logs: stream-started â†’ ×”×—×™×‘×•×¨ × ×©××¨ ×¢×“ ×¡×•×£ ×”×©×™×—×” (×œ× × ×¡×’×¨ ××™×“).

â¸»

8) ×× ××©×”×• ×¢×“×™×™×Ÿ ×œ× ×¢×•×‘×“ â€” ××™×¤×•×¡ ×××•×§×“

×ª×¡××™×Ÿ	×¡×™×‘×” ×©×›×™×—×”	×¤×ª×¨×•×Ÿ ×§×¦×¨
Twilio × ×™×ª×§ ××™×™×“	subprotocol ×œ× ×”×ª×§×‘×œ	×‘Ö¾WS ×¢×©×” websocket.accept(subprotocol="audio.twilio.com")
curl ×œÖ¾WS ××—×–×™×¨ HTML	×¡×“×¨ routes ×œ× × ×›×•×Ÿ	×ª×Ÿ ×¢×“×™×¤×•×ª ×œÖ¾WebSocketRoute ×œ×¤× ×™ Mount ×©×œ SPA
××™×Ÿ partials	×¢×•×“ ×§×•×¨××™× ×œÖ¾_hebrew_stt ×™×©×™×¨×•×ª	×¢×‘×¨ ×œ× ×§×•×“×ª wrapper ×‘×œ×‘×“
12100 ×¢×œ ×”Ö¾TwiML	XML ×œ× ×ª×§×™×Ÿ / ×©×•×¨×ª UTF-8	×‘× ×” TwiML ×‘×“×™×•×§ ×›××• ×‘×¡×¢×™×£ 2, ×‘×œ×™ ×¨×•×•×—×™× ××©×•× ×™×
Latency ×’×‘×•×”	×¨×™×¡××¤×œ×™× / Î¼-law ××™×˜×™	×•×“× 8k ×›×œ ×”×“×¨×š ×•Ö¾lookup-table ×œÖ¾Î¼-law
502 ×‘Ö¾statusCallback	URL × ×©×œ×— ×œ×“×•××™×™×Ÿ dev	×•×“× PUBLIC_HOST ×‘×¢×“×™×¤×•×ª ×¢×œ dev domain ×‘×§×•×“ webhooks


â¸»

9) ×ª×•×¡×¤×•×ª ×§×˜× ×•×ª ×©××©×¤×¨×•×ª ×ª×—×•×©×”
	â€¢	×¤×ª×™×— TTS ×§×¦×¨ (500â€“800ms) ×›×“×™ ×œ× â€œ×œ×©×ª×•×§â€ ×‘×–××Ÿ ×©×”-WS ×¢×•×œ×”.
	â€¢	×—×¡×™××ª IO ×›×‘×“ ×× ×ª×™×‘ ×”-WS (DB/LLM/HTTP â†’ ×œ-queue/worker).
	â€¢	Whisper fallback × ×©××¨ ×›××• ×”×™×•× â€“ ×œ× ×œ×’×¢×ª.

â¸»

××©×¤×˜ ××—×“ ×œ××¤×ª×— (×§×•×¤×™Ö¾×¤×™×™×¡×˜)

â€œ×”×¢×‘×¨ ××ª × ×§×•×“×ª ×”-STT ×œ×©×™××•×© ×‘-_hebrew_stt_wrapper ×‘×œ×‘×“, ×•×“× ×©-ENABLE_STREAMING_STT=true ×’× ×‘-deployment secrets, ×©×”-WS ×‘Ö¾asgi.py ××§×‘×œ audio.twilio.com, ×•×©×”Ö¾WebSocketRoute ××•×’×“×¨ ×œ×¤× ×™ ×”-SPA. ×¤×¨×¡×, ×•××– ×•×“× ×‘×œ×•×’×™× [CFG] ENABLE_STREAMING_STT=True ×•Ö¾ğŸŸ¡ Partial ×›×œ ~200ms. ×× ×™×© ×ª×§×œ×” â€“ ××›×‘×™× ××ª ×”×“×’×œ ×•×—×•×–×¨×™× ×œ-single.â€

×–×” ×™×‘×™× ××•×ª×š ×œ×©×™×—×•×ª ×‘×–××Ÿ ×××ª, ×™×¦×™×‘×•×ª ×•××”×™×¨×•×ª.