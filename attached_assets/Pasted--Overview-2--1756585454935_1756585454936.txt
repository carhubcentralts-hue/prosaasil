מעולה. הנה “ספר-הנחיות” סופר-מדויק לבניית **דף סקירה כללית (Overview)** – ב־2 וריאציות: **מנהל מערכת** ו־**עסק**. בלי קוד, רק משימות ברורות, הרשאות, ניתובים, נתונים, UX, ומדדי קבלה.

---

# 0) עקרונות–על

* **Mobile-first אמיתי**: כל העמוד בנוי לרוחב צר (420–640px). גם בדסקטופ מוצג כ־Container צר, כדי לשמור “מראה אפליקציה”.
* **הרשאות דו-שכבתיות**: Guard בצד לקוח + אכיפה בשרת (כל API מסונן לפי `business_id`/`role`).
* **שפה ויזואלית אחידה**: Glass-Cards, Heebo, גרדיאנטים עדינים, אנימציות Motion קצרות (150–250ms), RTL מלא.
* **רענון חי**: WA/Calls מתעדכנים ב־SSE (או Polling 10–15s). כל Tile/רשימה יודעת להתעדכן.

---

# 1) ניתובים ו־Guards

* `/app/admin/overview` – למנהלים בלבד: `superadmin|admin`.
* `/app/biz/overview` – למשתמשי עסק: `business_owner|business_agent|read_only`.
* Guard בצד לקוח: הטענה של המסך רק אחרי `GET /api/auth/me`. אם role לא מתאים → הפניה ל־`/auth/login`.
* Guard בשרת: כל קריאת API מקבלת `business_id` (כשמדובר בצד העסק) ומסוננת ב־DAO/SQL.
* Impersonate (Admin בלבד): כשפעיל, מוצגת **Banner** עליון ברור: “מצב התחזות לעסק X” + “צא מהתחזות”.

---

# 2) מבנה העמוד (שכבות)

**Header קצר**

* שם העסק / “Admin”, אייקון חיפוש גלובלי, אייקון התראות, תפריט משתמש.
* אייקון המבורגר שפותח **Sidebar כשיט (Sheet)** – אותו ניווט גם במובייל וגם בדסקטופ.

**Hero Bar**

* כותרת: “סקירה כללית”.
* בורר טווח זמן: `היום | 7 ימים | 30 ימים | מותאם`. ברירת מחדל: 7 ימים.
* (Admin) בורר עסק – חיפוש/Autocomplete לכל העסקים; לחיצה קובעת Context לכל ה־tiles.

**Grid של Cards (טורים=1 תמיד)**

* 1. **KPIs** (ארבעה אריחים קטנים בשורה אנכית):

  * שיחות פעילות כרגע / חיבורי WS תקינים (% stream\_status 204).
  * הודעות WA ב־24ש’ / שיעור מסירה (delivered/read).
  * זמן תגובה ראשון ממוצע (שיחות/WA) – **p95**.
  * לידים חדשים / הזדמנויות שנוצרו.
* 2. **פעולות מהירות (Quick Actions)**

  * (Admin) יצירת עסק; Impersonate; הזמנת משתמש מערכת.
  * (Business) פתיחת ת׳רד WA חדש; שיחה יוצאת; יצירת ליד.
* 3. **מצב אינטגרציות**

  * WhatsApp: מחובר/שגיאה/לא הוגדר.
  * Voice: WS “מחובר”, Fallback ב־≤6ש’.
  * Payments: PayPal/Tranzila/Stripe—“מוכן” / “לא הוגדר” (אם לא הוגדר → טקסט הסבר, לא כפתור פעיל).
* 4. **פעילות אחרונה (Activity Feed)**

  * 8–10 פריטים אחרונים מכל הסוגים: WA/Calls/CRM/מסמכים/תשלומים, עם time-ago, תגי סטטוס, ולינק “לפתיחה”.
* 5. **קוביות ניהול**

  * **Admin – “ניהול עסקים”**: ספירה כוללת, פעילים/מוקפאים, הזמנה אחרונה, כפתור “יצירת עסק”, כפתור “Impersonate”.
  * **Admin – “ניהול משתמשים (מערכת)”**: גראף קטן לפי Roles, “משתמשים ממתינים להזמנה”, כפתור “הזמנת משתמש מערכת”.
  * **Business – “ניהול משתמשי העסק”** (owner בלבד): כמות משתמשים, breakdown לפי roles (agent/read\_only), רשימת הזמנות ממתינות, כפתור “הזמנת משתמש”.
* 6. **רשימות מהירות**

  * **WA – הת׳רדים האחרונים (5)**: שם/טלפון/Unread count/סטטוס אחרון (✓✓), “פתח”.
  * **Calls – אחרונות (5)**: שם/משך/סטטוס/“נגן+תמלול”.
  * **CRM – לידים פתוחים (5)**: שם/סטטוס/עדכון אחרון/“פתח”.
* 7. **התראות/אזהרות**

  * איבודי WS, כשל חתימה ב־WA, ספק תשלום לא מוגדר, חריגות SLA. כרטיסון אדום/צהוב עם לינק לפתרון.

**Footer / Bottom Bar (אופציונלי למובייל)**

* ניווט מהיר: WhatsApp / שיחות / CRM / סקירה / הגדרות.

---

# 3) תוכן לפי תפקיד (מה מראים למי)

**Admin – תוספות ייחודיות**

* **Business Selector** גלובלי.
* **ניהול עסקים** – אריח + קיצורי דרך: יצירה/הקפאה/Impersonate/חיפוש עסק.
* **ניהול משתמשים מערכתיים** – הזמנות/שינוי Roles/נעילה.
* **Panorama**: סיכומי WA/Calls חוצי עסקים (קישורים לעסק הרלוונטי).
* **אזהרות מערכתיות**: webhook כושל, Credentials חסרים.

**Business – תוספות ייחודיות**

* **Owner**: קוביית “ניהול משתמשי העסק” (הזמנה/שינוי תפקיד/מחיקה).
* **Agent/Read-Only**: אין קוביית ניהול; יש שימוש מלא ב־WA/Calls/CRM בלבד.
* **אינטגרציה עסקית**: מצב ספקי תשלום/WA/Voice של העסק בלבד.

---

# 4) מקורות נתונים (API) – שמות ותזמון

(הכול בלי קוד – רק מה צריך לקרוא ומה טווחי זמן)

**קריאות בסיס (עם cache עדין 15–30ש׳, ורענון ב־SSE/פולינג):**

* `GET /api/auth/me` – role + (לביזנס) business\_id.
* (Admin) `GET /api/admin/businesses?query=&status=&limit=` – לרשימות/ספירות.
* (Admin) `GET /api/admin/users?role=&business_id=&limit=` – “משתמשים מערכתיים”.
* (Business) `GET /api/biz/kpis?business_id=&range=` – החזר KPIs מרוכזים.
* (Both) `GET /api/whatsapp/threads?business_id=&limit=5&range=` – אחרונים.
* (Both) `GET /api/calls/recent?business_id=&limit=5&range=` – אחרונות.
* (Both) `GET /api/crm/leads?business_id=&status=open&limit=5` – פתוחים.
* (Both) `GET /api/integrations/status?business_id=` – WA/Voice/Payments.
* (Both) `GET /api/activity/recent?business_id=&limit=10&range=` – Activity Feed.
* (Both) SSE:

  * `/sse/whatsapp?business_id=` – שינויים בסטטוסים/הודעות.
  * `/sse/calls?business_id=` – התחלות/סיום/תמלולים.

**חישובי KPI (בשרת):**

* WA: `messages_total`, `delivered_rate`, `read_rate`, `median_first_response_sec`.
* Calls: `active_calls`, `avg_first_response_sec`, `stream_status_204_rate`, `fallback_count`.
* CRM: `leads_new`, `leads_open`, `deals_won/lose`.
* אינטגרציות: WA `connected/unconfigured`, Voice `ws_ok/fallback`, Payments `ready/not_configured`.

---

# 5) כפתורים וזרימות (Deep Links)

**כפתורי Quick Actions**

* Admin: “צור עסק” → `/app/admin/businesses/new`; “Impersonate” → דיאלוג בחירת עסק; “הזמנת משתמש מערכת” → `/app/admin/users/invite`.
* Business: “ת׳רד WA חדש” → `/app/biz/whatsapp/new`; “שיחה יוצאת” → `/app/biz/calls/new`; “צור ליד” → `/app/biz/crm/new`.

**קוביית ניהול משתמשים/עסקים**

* Admin:

  * “ניהול עסקים” → `/app/admin/businesses` (טבלה מלאה).
  * “ניהול משתמשים (מערכת)” → `/app/admin/users`.
  * לכל כפתור יש Tooltip הרשאות (למשל “זמין ל־superadmin בלבד”).
* Business (Owner בלבד):

  * “ניהול משתמשי העסק” → `/app/biz/users`.
  * פעולות: הזמנה, שינוי role, ביטול הזמנה, מחיקה, חיפוש.

**רשימות מהירות (לחיצות)**

* WA Item → `/app/biz/whatsapp/thread/:id` (או `/app/admin/businesses/:bid/wa/thread/:id` במצב אדמין).
* Call Item → `/app/biz/calls/:id` (נגן+תמלול).
* Lead Item → `/app/biz/crm/leads/:id`.

---

# 6) מצבי מערכת: Loading / Empty / Error

* **Loading**: Skeletons (פסים/כרטיסים ריקים) – לא ספינרים.
* **Empty**: הודעה ידידותית + CTA ברור (למשל “אין ת׳רדים – פתח ת׳רד חדש”).
* **Error**: Toast לא חוסם + הסבר “איך לתקן”; כרטיסי אינטגרציה: “לא הוגדר” ולא שגיאה.

---

# 7) התאמה מלאה למובייל (וגם בדסקטופ)

* Container עליון `max-w-[420–640px]`, שוליים מתאימים; בלי גלילה אופקית ב־320–375px.
* Sidebar תמיד כ־Sheet נפתח בצד ימין (RTL); אותו ניווט גם בדסקטופ.
* אזורי קליק ≥ 44px, spacing נדיב, טיפוגרפיה קריאה.
* כל טבלאות/רשימות – תצוגה אנכית (Labels מעל ערכים), לא טורים רבים.

---

# 8) אבטחה, תצפיתיות, ו־DoD

**אבטחה**

* איפוס/שכחתי סיסמה – אימות טוקן; Rate-limit לטפסים.
* WA Webhook – אימות חתימה; Idempotency לכל הודעה.
* Voice – `/webhook/stream_status` תמיד 204; אין אימות חתימה / אין `extra=` בלוגים.

**תצפיתיות (לוגים/מדדים)**

* לוגים: `OVERVIEW_LOAD {business_id, range}`, `SSE_CONNECTED`, `SSE_DROP`, `WA_RATE`, `CALLS_ACTIVE`, `FALLBACK_HIT`.
* מדדים: p95 לזמני טעינת Overview, ספירת אירועי SSE לדקה, שיעור שגיאות API.

**Definition of Done (לכל גרסה של Overview)**

* הרשאות נכונות (Admin רואה קוביות מערכתיות; Business Owner – קוביית משתמשים; Agent – בלי).
* כל קיצורי הדרך פועלים ומנתבים למסכים הנכונים.
* KPIs מתאימים לטווח זמן; מתעדכנים חיה ב־SSE/פולינג.
* אינטגרציות מציגות “לא הוגדר” במקום כפתור שבור.
* Lighthouse למסך ≥ 90 (Perf/Accessibility/Best Practices).
* בדיקת רספונסיביות: 320/375/768/1280 – בלי גלילה אופקית.
* קונסול נקי משגיאות.

---

# 9) Evidence Pack – מה לדרוש מהבוט בסוף

1. צילום **/app/admin/overview** ו־**/app/biz/overview** (מסך מלא).
2. צילום **Sidebar כ-Sheet** פתוח – מציג פריטים שונים לפי role.
3. וידאו קצר: WA Thread מגיע/נשלח → מתעדכן ב־Overview ≤ 3–5ש’.
4. צילום “מצב אינטגרציות” – כולל “לא הוגדר” בספק תשלום חסר.
5. צילום “קוביית ניהול משתמשים/עסקים” – מסכי Admin/Business עם פעולות זמינות.
6. צילום Lighthouse (≥90) ו־DevTools Network (CSS יחיד מה-build החדש).

---

עם ההנחיה הזו, הבוט יודע **בדיוק**: מה להציג לכל תפקיד, מה למשוך ומתי, איך מנווטים לכל פעולה, איך זה נראה ונבחן במובייל ובדסקטופ, ומה מוכיח שזה באמת עובד.
