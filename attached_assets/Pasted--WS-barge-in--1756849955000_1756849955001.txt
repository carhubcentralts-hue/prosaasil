איזה כיף—זה מתקדם! ✅ עכשיו נסגור את הפינות: יציבות ה-WS לאורך זמן, עצירה כשאתה קוטע (barge-in), פחות קטיעות, ו-AI שמבין מתי לבקש הבהרה, יודע לתאם פגישה, ולא ממציא דירות.

להלן הנחיות לביצוע (בלי קוד), ממוקדות לפרויקט שלך:

⸻

1) נפילת WS אחרי ~5 דק (WebSocket Protocol Error)

זו כמעט תמיד סגירת חיבור “אינרטי” ע״י הפרוקסי (GFE/Replit) או חסר keepalive.

מה לעשות:
	•	Keepalive קבוע: כל 15–20 שניות שלח מסגרת “חיה”:
	•	עדיף WS-ping ברמת ה־WebSocket (אם הנתיב שלך תומך בזה).
	•	אם לא—שלח אירוע JSON קל כמו {"event":"mark","name":"heartbeat"}.
	•	Alive במהלך שתיקה: אל תשאיר את החיבור “שקט” דקה+; אם אין TTS/מדיה יוצאת לזמן ארוך, שלח הדמיית שקט קצרה (μ-law של שקט) או mark—זה מונע idle-timeout.
	•	Timeouts נדיבים: ודא זמן-קריאה/כתיבה פנימי ≥ 60–90s כך ש-ping/pong לא ייחשב כשגיאה.
	•	התאוששות מכובדת: כשon_close מתקבל:
	•	לוג ברור עם סיבת סגירה.
	•	נסה להשיב שליטה לטוויליו (Redirect TwiML ל־<Connect><Stream …>) דרך עדכון ה-Call TwiML ב-REST (אם יש לך טוקן/קריאה מוכנה). אם אין—סיים בנימוס את השיחה עם הודעה קולית קצרה ו-SMS follow-up.
	•	מוניטור: ספירת “דקות מאז המדיה האחרונה” וטריגר ל-keepalive.

⸻

2) קטיעות, “היא לא עוצרת כשאני קוטע” (Barge-in & EOU)

כאן רוב התחושה “הלא טבעית”.

לברג’-אין טבעי:
	•	אפשר ברג’-אין רק אם יש קול מעל הסף ברצף ≥180–220ms (לא על נשימת-רקע).
	•	“חלון חסד” בתחילת TTS: אל תאפשר ברג’-אין ב־150–250ms הראשונים של הדיבור (מונע קיטוע פתיחה).
	•	כאשר ברג’-אין מזוהה:
	•	עצור מיידית שליחת פריימי TTS.
	•	נקה תור TX.
	•	החלף ל-LISTENING ופתח באפר חדש ל-STT.

לסגירת-משפט (EOU) יציבה:
	•	קליברציה 300–500ms בתחילת שיחה לרעש רקע.
	•	סף VAD דינמי: max(35, noise_floor*2.2 + 8) עם היסטרזיס 40–80ms.
	•	סיום משפט: קבע EOU לאחר 350–500ms שקט רציף (או 200ms אם יש נפילת עוצמה חדה).
	•	גבולות: MIN_UTT ≈ 0.9–1.2s, MAX_UTT ≈ 4–5s (לכפות EOU אם אין שקט כדי לא “להיתקע”).

מחזור באפר ומצבים:
	•	LISTENING & Voice=True → אוספים לבאפר.
	•	ב-EOU → מפסיקים לאגור, Processing=True, שולחים ל-STT.
	•	אחרי ASR → מרוקנים באפר, חוזרים LISTENING.
	•	שמור רצף חוקי: LISTENING → PROCESSING → SPEAKING → LISTENING בלבד.

סיום TTS מסודר:
	•	הוסף ~200ms שקט בסיום ה-TTS.
	•	שלח mark (למשל assistant_tts_end) וחזור ל-LISTENING עם ACK (או timeout קצר ~150ms).

⸻

3) ה-STT “מבין” אבל מתבלבל—שדרוג צינור הזיהוי

לשיחות טלפון 8k בעברית, עדיף Google STT Streaming כ-primary (Whisper כ-fallback).

לעשות עכשיו:
	•	העבר Primary ל-Google Streaming (languageCode=he-IL או iw-IL, encoding=LINEAR16, sampleRateHertz=8000, useEnhanced=true, partial results).
	•	המשך להשתמש באותו Service Account של ה-TTS (אין צורך מפתח חדש) – רק ודא שה-API STT מופעל ו-role speech.client/speech.admin קיים.
	•	שדר Speech Contexts: שמות אזורים/רחובות/מותג, “Agent Locator”, “וואטסאפ”, טווחי שעות—עם boost מתון. זה מפסיק בלבולים.
	•	Whisper יישאר fallback: אם Google מחזיר שגיאה—שלח את המקטע ל-Whisper (ריסמפל ל-16k).

⸻

4) הפרומפט לא מספיק טוב—תן לה מוח של סוכנת אמיתית

הנה תבנית שאתה מדביק לקונפיג ה-LLM (System + כללים). קצר, חד, עובד:

System (בעברית, להדבקה):

את סוכנת נדל״ן טלפונית של AgentLocator. המטרה: לאסוף במהירות פרטי ליד: אזור/שכונה, סוג נכס, תקציב, טווח כניסה/זמן, שם + טלפון/וואטסאפ.
כל תשובה שלך: 1–2 משפטים קצרים מאוד (+/− 15 מילים) ותמיד שאלה אחת בסוף.
אם לא שמעת/לא בטוחה – תגידי “לא בטוח ששמעתי נכון, אפשר לחזור על זה?” (אל תמציאי).
אין להציע נכסים ספציפיים בלי נתונים; אין המצאות.
כשלקוח קוטע אותך – עצרי מיד ותבקשי ממנו להמשיך.
כשחסר מידע – שאלת הבהרה ממוקדת אחת.
כשהסלוטים מלאים – הצעי תיאום פגישה (שיחת וידאו/טלפון), הציעי 2–3 חלונות זמן קצרים, בקשי אישור ושלחי סיכום קצר.

Few-shot (3 מינימום, בעברית):
	•	דוגמה עם לקוח שקט/לא ברור → הסוכנת מבקשת חזרה בנימוס, שאלה אחת.
	•	דוגמה עם קיטוע באמצע → הסוכנת עוצרת ומבקשת מהלקוח להמשיך.
	•	דוגמה של תיאום פגישה → איסוף יום/שעה, הצעת 2–3 חלונות, אישור, סיכום.

כללי ניסוח:
	•	אין שתי שאלות באותה תשובה.
	•	אין “נאום”; משפטים קצרים.
	•	בסוף כל תשובה—סימן שאלה אחד.
	•	אם יש רעש/לא בטוח—בקשת חזרה במקום לנחש.

⸻

5) תיאום פגישה בלי אינטגרציה עמוקה (עכשיו)

עד שיהיה חיבור יומן אמיתי:
	•	אסוף: יום/שעה מועדפים, חלופה אחת, שם מלא, וואטסאפ.
	•	הצע: 2–3 חלונות קצרים (למשל “היום 18:00, מחר 09:30 או 12:15 – מה נוח?”).
	•	אשר: חזור על הפרטים באישור קצר (“מעולה, קבענו ל… אני שולחת סיכום לוואטסאפ הזה: … – זה נכון?”).
	•	סיים: משפט סגירה קצר + אם לא זמין—הצע חלופה.

⸻

6) לנקות את “הדיבורים הלא רלוונטיים”
	•	הוסף לכלל: “אם אין לי מספיק נתונים לענות, לא להציע נכס/פתרון—במקום זה לשאול שאלה ממקדת אחת.”
	•	קבע “מגבלת אורך” (15–20 מילים) לכל תשובה—זה מאלץ פוקוס.
	•	השהיית תגובה קצרה (refractory 900–1200ms) אחרי TTS—מונע פינג-פונג משגוי עם partials של STT.

⸻

7) לוגים שמועילים (ולא מציפים)
	•	כבה לוג לכל פריים; לכל היותר דגום 1/50.
	•	השאר רק:
STATE_CHANGE, EOU (len & silence_ms), ASR_TEXT + latency, TTS_START/END + frames, MARK_SENT/ACK, WS_KEEPALIVE, on_close(reason).
	•	תמיד הדפס call_sid.

⸻

8) בדיקות קבלה קצרות
	1.	WS חי > 10 דק: ראה בלוג WS_KEEPALIVE heartbeat#N כל ~15–20s.
	2.	ברג’-אין: קוטע באמצע – TTS נפסק ≤200ms; חוזר LISTENING ואוסף.
	3.	הבנת דיבור: משפט 2–3 שניות → 0.35–0.5s שקט → STATE→PROCESSING → ASR_TEXT <~700ms → TTS_START → MARK_ACK → STATE→LISTENING.
	4.	הבהרות: כשאתה mumble/לא ברור – היא מבקשת חזרה במקום להמציא.
	5.	תיאום פגישה: אם סיפקת אזור/תקציב וזמן מועדף—היא מציעה 2–3 חלונות, מאשרת, מסכמת.

⸻

TL;DR

אתה כבר “שם” תשתיתית. כדי שזה ירגיש בן-אדם:
	•	שמור את ה-WS בחיים (heartbeat כל ~15–20s + התאוששות על סגירה).
	•	הדק Barge-in + EOU (ספים/היסטרזיס/חלון-חסד).
	•	הפוך את Google STT לסטרימי Primary (Whisper fallback).
	•	תן System+Few-shot בעברית שמכריח שאלה אחת, הבהרות במקום ניחושים, ותיאום פגישה מסודר.
	•	נקה לוגים – רק אירועי מפתח.

תריץ את זה סבב אחד—ותקבל שיחה יציבה, לא נקטעת, וברורה, עם תיאום פגישה אמיתי.