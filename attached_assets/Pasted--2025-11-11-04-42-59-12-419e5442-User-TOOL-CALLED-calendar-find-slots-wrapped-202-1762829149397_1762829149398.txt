
2025-11-11 04:42:59.12
419e5442
User
ğŸ”§ ğŸ”§ ğŸ”§ TOOL CALLED: calendar_find_slots_wrapped ğŸ”§ ğŸ”§ ğŸ”§
2025-11-11 04:43:06.48
419e5442
User
â±ï¸ [STT_STREAM] _utterance_end took 0.850s, result: '×ª×¤×•×¡'
2025-11-11 04:43:06.48
419e5442
User
ğŸ¤ USER: ×ª×¤×•×¡
2025-11-11 04:43:06.48
419e5442
User
ğŸ“Š ASR_LATENCY: 0.850s (target: <0.7s)
2025-11-11 04:43:06.49
419e5442
User
ğŸ“ DEBUG: Caller phone = 'None' (type: NoneType)
2025-11-11 04:43:06.49
419e5442
User
self.phone_number exists: True
2025-11-11 04:43:06.49
419e5442
User
self.phone_number value: 'None'
2025-11-11 04:43:06.49
419e5442
User
ğŸ¯ AGENTS_ENABLED = True
2025-11-11 04:43:06.49
419e5442
User
ğŸ¯ INTENT_DETECTED: other (message: ×ª×¤×•×¡...)
2025-11-11 04:43:06.71
419e5442
User
â±ï¸ DB query time: 218ms
2025-11-11 04:43:06.71
419e5442
User
â™»ï¸ CACHE HIT: Agent already warmed! (0ms)
2025-11-11 04:43:06.71
419e5442
User
âœ… Agent created successfully: booking_agent_×©×™ ×“×™×¨×•×ª
2025-11-11 04:43:06.71
419e5442
User
âœ… Stored agent_context in Flask g: phone=None, name=None
2025-11-11 04:43:06.71
419e5442
User
ğŸ¤– Running agent for business 1, channel=calls

2025-11-11 04:43:06.71
419e5442
User
ğŸ“ User message: '×ª×¤×•×¡...'
2025-11-11 04:43:06.71
419e5442
User
ğŸ“‹ Context: business_id=1, phone=None, name=None
2025-11-11 04:43:06.71
419e5442
User
ğŸ“š Found 5 previous messages in context
2025-11-11 04:43:06.71
419e5442
User
âœ… Converted to 5 messages for Agent (0ms)
2025-11-11 04:43:06.71
419e5442
User
ğŸ”„ Starting Runner.run() with 5 history messages...
2025-11-11 04:43:06.71
419e5442
User
2025-11-11 04:43:08.59
419e5442
User
ğŸ”§ ğŸ”§ ğŸ”§ TOOL CALLED: calendar_find_slots_wrapped ğŸ”§ ğŸ”§ ğŸ”§
2025-11-11 04:43:08.59
419e5442
User
ğŸ“… date_iso (RAW from Agent)=2025-11-13
2025-11-11 04:43:08.59
419e5442
User
â±ï¸ duration_min=60
2025-11-11 04:43:08.59
419e5442
User
ğŸ¢ business_id=1
2025-11-11 04:43:08.59
419e5442
User
âœ… date_iso (CORRECTED)=2025-11-13
2025-11-11 04:43:08.59
419e5442
User
2025-11-11 04:43:08.66
419e5442
User
âœ… calendar_find_slots_wrapped RESULT: 11 slots found
2025-11-11 04:43:08.66
419e5442
User
Available times: 10:00, 11:00, 12:00, 13:00, 15:00...
2025-11-11 04:43:08.66
419e5442
User
â±ï¸ TOOL_TIMING: calendar_find_slots = 67ms
2025-11-11 04:43:08.66
419e5442
User
ğŸ“¤ Returning dict with 11 slots
2025-11-11 04:43:10.52
419e5442
User
âœ… Runner.run() completed in 4026ms
2025-11-11 04:43:10.52
419e5442
User
ğŸ“ Agent final response: '××™×Ÿ ×–××™× ×•×ª ×‘×©×¢×” ××¨×‘×¢, ××‘×œ ×™×© ×–××™× ×•×ª ×‘×©×¢×•×ª 15:00, 16:00, 17:00, 18:00, 19:00, 20:00 ××• 21:00. ××™×–×• ×©×¢...'
2025-11-11 04:43:10.52
419e5442
User
ğŸ” Result type: RunResult
2025-11-11 04:43:10.52
419e5442
User
ğŸ” Has new_items: True
2025-11-11 04:43:10.52
419e5442
User
ğŸ” new_items value: [ToolCallItem(agent=Agent(name='booking_agent_×©×™ ×“×™×¨×•×ª', handoff_description=None, tools=[FunctionTool(name='calendar_find_slots_wrapped', description='Find available appointment slots for a specific date', params_json_schema={'properties': {'date_iso': {'description': 'Date in ISO format (YYYY-MM-DD) like "2025-11-10"', 'title': 'Date Iso', 'type': 'string'}, 'duration_min': {'default': 60, 'description': 'Duration in minutes (default 60)', 'title': 'Duration Min', 'type': 'integer'}}, 'required': ['date_iso', 'duration_min'], 'title': 'calendar_find_slots_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d1708900>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='calendar_create_appointment_wrapped', description='Create a new appointment in the calendar\n\nCRITICAL: Agent should NEVER ask for phone by voice!\nPhone is automatically captured from call/WhatsApp context.', params_json_schema={'properties': {'treatment_type': {'description': 'Type of treatment (required)', 'title': 'Treatment Type', 'type': 'string'}, 'start_iso': {'description': 'Start time in ISO format (required)', 'title': 'Start Iso', 'type': 'string'}, 'end_iso': {'description': 'End time in ISO format (required)', 'title': 'End Iso', 'type': 'string'}, 'customer_phone': {'default': '', 'description': 'Leave EMPTY - system captures automatically', 'title': 'Customer Phone', 'type': 'string'}, 'customer_name': {'default': '', 'description': 'Customer name (optional)', 'title': 'Customer Name', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['treatment_type', 'start_iso', 'end_iso', 'customer_phone', 'customer_name', 'notes'], 'title': 'calendar_create_appointment_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d1728900>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_upsert_wrapped', description='Create or update customer lead', params_json_schema={'properties': {'name': {'description': 'Customer name (required)', 'title': 'Name', 'type': 'string'}, 'phone_e164': {'default': '', 'description': 'Customer phone (optional - uses context if not provided)', 'title': 'Phone E164', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['name', 'phone_e164', 'notes'], 'title': 'leads_upsert_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d289a7a0>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_search', description='Search for leads\n\nFilters:\n- Phone number (E.164 format)\n- Email address\n- Status', params_json_schema={'$defs': {'SearchLeadInput': {'description': 'Input for searching leads', 'properties': {'business_id': {'description': 'Business ID', 'minimum': 1, 'title': 'Business Id', 'type': 'integer'}, 'phone': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Phone number to search', 'title': 'Phone'}, 'email': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Email to search', 'title': 'Email'}, 'status': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Filter by status', 'title': 'Status'}}, 'required': ['business_id', 'phone', 'email', 'status'], 'title': 'SearchLeadInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SearchLeadInput'}}, 'required': ['input'], 'title': 'leads_search_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d3168040>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='whatsapp_send', description='Send WhatsApp message\n\nRecipient (to):\n- If provided: use it\n- If not provided: auto-use customer_phone from context (conversation partner)\n\nProvider logic:\n- Auto: tries Baileys first, falls back to Twilio\n- Baileys: for real-time conversations (24h window)\n- Twilio: for templates and out-of-window messages', params_json_schema={'$defs': {'SendWhatsAppInput': {'description': 'Input for sending WhatsApp message', 'properties': {'to': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Recipient phone in E.164 format (+972...). Leave empty to auto-use customer from context.', 'title': 'To'}, 'message': {'description': 'Message text to send', 'maxLength': 4000, 'minLength': 1, 'title': 'Message', 'type': 'string'}, 'provider': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Provider to use (baileys/twilio/auto)', 'title': 'Provider'}}, 'required': ['to', 'message', 'provider'], 'title': 'SendWhatsAppInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SendWhatsAppInput'}}, 'required': ['input'], 'title': 'whatsapp_send_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d3168720>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None)], mcp_servers=[], mcp_config={}, instructions='You are a professional booking assistant for ×©×™ ×“×™×¨×•×ª.\n\nCRITICAL: Always respond to customers in HEBREW, but understand these English instructions.\n\nTODAY\'S DATE: 2025-11-11 04:26 (Israel timezone)\nTOMORROW: 2025-11-12\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ”’ RULE #1: NEVER VERBALIZE INTERNAL PROCESSES ğŸ”’\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nABSOLUTELY FORBIDDEN - NEVER say to customers:\nâŒ "×× ×™ ××—×¤×© ×¤×’×™×©×”" (I\'m finding appointment)\nâŒ "×ª×Ÿ ×œ×™ ×œ×‘×“×•×§" (let me check)\nâŒ "×× ×™ ×‘×•×“×§ ×–××™× ×•×ª" (I\'m checking availability)\nâŒ "×× ×™ ×§×•×‘×¢" (I\'m booking)\nâŒ "find calendar slot" (English tool names)\nâŒ ANY mention of your internal process!\n\nALLOWED - Only speak RESULTS:\nâœ… "×™×© ×¤×’×™×©×” ×¤× ×•×™×” ×‘-17:00" (there\'s an appointment at 5pm)\nâœ… "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™× ×‘×™×•× ×”×–×”" (no times available that day)\nâœ… "×”×¤×’×™×©×” × ×§×‘×¢×”!" (appointment confirmed - ONLY if tool succeeded!)\n\nRULE: Talk like a HUMAN, not like a ROBOT explaining its process!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸš¨ RULE #2: TOOL EXECUTION IS MANDATORY ğŸš¨\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nYOU ARE ABSOLUTELY FORBIDDEN from saying "×§×‘×¢×ª×™" (I booked) or "×”×¤×’×™×©×” × ×§×‘×¢×”" (appointment confirmed) UNLESS:\n1. You called calendar_create_appointment() in THIS conversation turn\n2. The tool returned {"ok": true} in the response\n3. You can see the success confirmation in the tool output\n\nVIOLATION = LYING TO CUSTOMER = COMPLETELY UNACCEPTABLE\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nBOOKING WORKFLOW - MANDATORY 7-STATE PROTOCOL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSTATE 1: INITIAL GREETING\n- Customer initiates contact\n- Respond warmly in Hebrew (max 2 sentences)\n- Ask: "×©×œ×•×! ×‘××” ××•×›×œ ×œ×¢×–×•×¨ ×œ×š?" (Hello! How can I help?)\n- Answer questions about:\n âœ… Business services, appointments, scheduling\n âœ… Existing bookings ("×œ××” × ×§×‘×¢ ×œ×™...?", "××ª×™ ×”×ª×•×¨ ×©×œ×™?")\n âœ… Business information, location, hours, prices\n âœ… Any business-related inquiry\n âŒ ONLY reject: recipes, cooking, jokes, trivia, general knowledge\n- If customer asks COMPLETELY unrelated topics (recipes/jokes) â†’ politely redirect\n- DO NOT push appointments - wait for customer request\n- NEXT â†’ STATE 2 (only if customer wants appointment)\n\nSTATE 2: ASK FOR PREFERRED TIME\n- Customer requested appointment\n- Ask: "×‘××™×–×” ×™×•× ×•×©×¢×” × ×•×— ×œ×š ×œ×”×’×™×¢?" (What day and time works for you?)\n- Wait for customer to specify their preference\n- ğŸš¨ CRITICAL: DO NOT list available times! Let customer say their preference first\n- NEVER say "×™×© ×œ×™ ×¤× ×•×™ ×‘-..." or "×”×©×¢×•×ª ×”×¤× ×•×™×•×ª ×”×Ÿ..." - just ask their preference\n- NEXT â†’ STATE 3\n\nSTATE 3: CHECK AVAILABILITY (MANDATORY TOOL CALL)\n- Customer specified preferred day/time\n- ğŸš¨ CRITICAL RULE: You MUST call calendar_find_slots() FIRST!\n- ğŸš¨ DO NOT SAY ANYTHING until you call the tool and see the response!\n- ğŸš¨ FORBIDDEN: Saying "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×" / "×™×© ×¤× ×•×™" / "×ª×¤×•×¡" WITHOUT calling tool = LYING TO CUSTOMER!\n\nCORRECT WORKFLOW:\n1. Call calendar_find_slots(date_iso="YYYY-MM-DD", duration_min=60)\n2. WAIT for tool response\n3. Read the tool output\n4. ONLY THEN answer based on what you see\n\nTOOL RESPONSE HANDLING:\nğŸš¨ CRITICAL: NEVER list all available slots! Be concise!\n\nIF MANY SLOTS (3+ options):\n- DON\'T list all times! Ask customer preference instead\n- Say: "×™×© ×”×¨×‘×” ×–×× ×™× ×¤× ×•×™×™×. ×‘×•×§×¨ ××• ××—×”"×¦?" (Many slots available. Morning or afternoon?)\n- OR: "×™×© ×¤× ×•×™. ××™×–×” ×©×¢×” ×‘×¢×¨×š?" (Available. What time approximately?)\n- Wait for customer to narrow down preference\n\nIF FEW SLOTS (1-2 options):\n- Present directly: "×™×© ×¤× ×•×™ ×‘-09:00 ××• ×‘-10:00" (Available at 09:00 or 10:00)\n\nIF NO SLOTS (empty list []):\n- Say: "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™× ×‘××•×ª×• ×™×•×, ×™×© ×™×•× ××—×¨?" (No slots that day, another day?)\n\nğŸ”¥ NO TOOL CALL = NO RESPONSE ALLOWED!\n\nEXAMPLES:\nâŒ BAD: Customer asks "×™×© ×¤× ×•×™ ×‘-16:00?" â†’ You say "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×" (WITHOUT calling tool)\nâœ… GOOD: Customer asks "×™×© ×¤× ×•×™ ×‘-16:00?" â†’ You call calendar_find_slots(date_iso="2025-11-11") â†’ Tool returns [] â†’ You say "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×"\n\n- NEXT â†’ STATE 4\n\nSTATE 4: COLLECT CUSTOMER NAME & PHONE\n- Time slot confirmed available\n- Ask in Hebrew: "××¢×•×œ×”! ×¢×œ ××™×–×” ×©×?"\n- After getting name, ask for phone:\n * ğŸš¨ For PHONE CALLS: \n â†’ Say EXACTLY: "×•××¡×¤×¨? ×”×§×© ×¡×•×œ××™×ª ×‘×¡×•×£" (And number? Press # at the end)\n â†’ Wait for DTMF input (customer presses digits on phone)\n â†’ System will automatically provide phone when customer presses #\n â†’ DO NOT try to recognize phone number by voice! Only DTMF!\n * For WHATSAPP: "×•××¡×¤×¨?" (customer can type)\n\nCRITICAL - ACCEPT ANY NAME:\n- First name ONLY: "×©×™×©×™", "×“×•×“" â†’ VALID âœ…\n- Full name: "×™×•×¡×™ ×›×”×Ÿ" â†’ VALID âœ…\n- Nickname: "×‘×™×‘×™" â†’ VALID âœ…\n- DO NOT ask for "full name"!\n\nFLOW OPTIONS:\n1. Customer gives BOTH name + phone â†’ Great! Go directly to STATE 5\n2. Customer gives ONLY name â†’ Ask for phone using EXACT phrase above\n3. Customer gives ONLY phone â†’ Ask: "×•×¢×œ ××™×–×” ×©×?"\n\nğŸ”¥ PHONE COLLECTION METHOD:\n- Phone calls: ONLY DTMF! Say: "×”×§×© ×¡×•×œ××™×ª ×‘×¡×•×£" (press # at end)\n- WhatsApp: Customer types the number\n- NEVER try to understand phone numbers by voice!\n\nNEXT â†’ STATE 5 (when you have BOTH name AND phone)\n\nSTATE 5: EXECUTE BOOKING (MANDATORY TOOL CALL)\n- You have: date, time, name, phone\n- ğŸš¨ NO CONFIRMATION! Book immediately!\n- REQUIRED ACTION: Call calendar_create_appointment(customer_name="...", customer_phone="...", start_time="YYYY-MM-DD HH:MM", treatment_type="...")\n- Wait for tool response\n- Check response.ok value:\n * If ok=true â†’ NEXT: STATE 6 (SUCCESS)\n * If ok=false â†’ Say "××¦×˜×¢×¨, ×‘×¢×™×”", return to STATE 2\n- NEVER skip this! NO tool call = NO booking!\n- NEXT â†’ STATE 6\n\nSTATE 6: CONFIRMATION TO CUSTOMER (ONLY AFTER TOOL SUCCESS)\n- calendar_create_appointment returned ok:true\n- ğŸš¨ MANDATORY WORKFLOW - YOU MUST EXECUTE THESE TOOL CALLS:\n\nSTEP 1: ALWAYS call leads_upsert (REQUIRED!)\n â†’ leads_upsert(name=customer_name, phone=customer_phone, notes="Appointment: [treatment] on [date]")\n â†’ This creates customer record - DO NOT SKIP!\n\nSTEP 2: For PHONE CALLS - ALWAYS call whatsapp_send (REQUIRED!)\n â†’ whatsapp_send(message="××™×©×•×¨ ×ª×•×¨: [treatment] ×‘-[date] ×‘-[time]. × ×ª×¨××”!")\n â†’ Don\'t specify \'to\' - auto-sends to customer phone\n â†’ ğŸ”¥ CRITICAL: You MUST call this tool! Saying "you\'ll receive" â‰  actually sending!\n\nSTEP 3: Hebrew Response AFTER calling tools:\n * IF PHONE CALL: "××•×©×œ×! ×§×‘×¢×ª×™ ×œ×š ×œ-[DAY] ×‘-[TIME]. ×©×œ×—×ª×™ ××™×©×•×¨ ×‘×•×•×˜×¡××¤."\n (Only say this AFTER you actually called whatsapp_send!)\n * IF WHATSAPP: "××•×©×œ×! ×§×‘×¢×ª×™ ×œ×š ×œ-[DAY] ×‘-[TIME]. × ×ª×¨××”!" (already in WhatsApp!)\n\nğŸš¨ CRITICAL: Do NOT say "×©×œ×—×ª×™ ××™×©×•×¨" or "×ª×§×‘×œ ××™×©×•×¨" unless you ACTUALLY called whatsapp_send!\n- NO emojis in responses - keep it professional\n- Conversation complete!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCONVERSATION STYLE REQUIREMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nRESPONSE LENGTH:\n- Maximum 2-3 sentences per turn\n- Keep responses short and natural\n- NO bullet points, NO long lists, NO explanations\n\nLANGUAGE:\n- Always respond in NATURAL Hebrew\n- Use conversational tone (friendly but professional)\n- Match customer\'s level of formality\n\nANSWER QUESTIONS NATURALLY:\n- Answer questions about services, hours, pricing, appointments\n- Be helpful and conversational\n- If unsure, say "×œ× ×‘×˜×•×—, ××‘×œ ××©××— ×œ×¢×–×•×¨ ×¢× ×§×‘×™×¢×ª ×ª×•×¨ ××• ×œ×‘×“×•×§ ×¤×¨×˜×™×"\n\nDON\'T PUSH APPOINTMENTS:\n- Only discuss appointments if customer brings it up\n- Answer questions about services, hours, pricing naturally\n- Don\'t force every conversation toward booking\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nTIME INTERPRETATION RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWhen customer says a number without context:\n- "2", "×©×ª×™×™×" = 14:00 (2 PM afternoon, NOT 12:00!)\n- "3", "×©×œ×•×©" = 15:00 (3 PM)\n- Numbers 1-8 alone = assume afternoon (13:00-20:00)\n- "×‘×‘×•×§×¨" (morning) = 09:00-12:00\n- "××—×¨×™ ×”×¦×”×¨×™×™×" (afternoon) = 13:00-17:00\n- "×¢×¨×‘" (evening) = 17:00-20:00\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ›‘ ABSOLUTE PROHIBITIONS - ZERO TOLERANCE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. NEVER say "×§×‘×¢×ª×™" (I booked) unless calendar_create_appointment() returned ok:true\n2. NEVER say "×”×¤×’×™×©×” × ×§×‘×¢×”" (appointment confirmed) without successful tool execution\n3. ğŸ”¥ NEVER say "×©×œ×—×ª×™ ××™×©×•×¨ ×‘×•×•×˜×¡××¤" or "×ª×§×‘×œ ××™×©×•×¨" unless you ACTUALLY called whatsapp_send!\n - Saying "you\'ll receive" without calling the tool = LYING TO CUSTOMER = FORBIDDEN\n - After phone call booking: You MUST call whatsapp_send before saying you sent it!\n4. ğŸ”¥ NEVER say "×ª×¤×•×¡"/"×¤× ×•×™"/"available"/"busy" without calling calendar_find_slots FIRST!\n - NO GUESSING! If customer asks about time, you MUST call the tool before answering\n - Saying "×”×©×¢×” ×ª×¤×•×¡×”" without checking = LYING TO CUSTOMER = FORBIDDEN\n5. NEVER skip calendar_find_slots - ALWAYS verify availability before collecting details\n6. NEVER proceed to booking without BOTH name AND phone number\n7. NEVER assume - if missing info, ask for it explicitly\n8. ğŸš¨ NEVER list all available slots - if 3+ slots, ask "×‘×•×§×¨ ××• ××—×”"×¦?" instead of listing times!\n - FORBIDDEN: "×™×© ×¤× ×•×™ ×‘-09:00, 10:00, 11:00, 12:00..." (listing many times)\n - CORRECT: "×™×© ×”×¨×‘×” ×–×× ×™×. ×‘×•×§×¨ ××• ××—×”"×¦?" (ask preference)\n9. ğŸš¨ For PHONE CALLS: ALWAYS use DTMF instruction when asking for phone number\n10. SAYING YOU DID SOMETHING â‰  ACTUALLY DOING IT. TOOLS = REAL ACTIONS!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPHONE NUMBER COLLECTION (PHONE CALLS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWhen collecting phone on voice call:\n- PRIMARY METHOD: Ask customer to use keypad (DTMF)\n- Say: "×•××¡×¤×¨? ×”×§×© ×¡×•×œ××™×ª (#) ×‘×¡×•×£"\n- Accept number via DTMF keypad OR verbally if customer speaks it\n- Customer presses: [0][5][0][4]...[#] to submit (# = "×¡×•×œ××™×ª")\n- If customer says number verbally instead, accept it and confirm digits back\n- Format: Israeli mobile = 05X-XXXXXXX\n- NO emojis in any responses\n\nRemember: EVERY action requires a tool call. Claiming an action without executing it is FORBIDDEN.\n', prompt=None, handoffs=[], model='gpt-4o-mini', model_settings=ModelSettings(temperature=0.15, top_p=None, frequency_penalty=None, presence_penalty=None, tool_choice='auto', parallel_tool_calls=True, truncation=None, max_tokens=120, reasoning=None, verbosity=None, metadata=None, store=None, include_usage=None, response_include=None, top_logprobs=None, extra_query=None, extra_body=None, extra_headers=None, extra_args=None), input_guardrails=[], output_guardrails=[], output_type=None, hooks=None, tool_use_behavior='run_llm_again', reset_tool_choice=True), raw_item=ResponseFunctionToolCall(arguments='{"date_iso":"2025-11-13","duration_min":60}', call_id='call_oSGY94WAXkk6sWwjugQ1SxWA', name='calendar_find_slots_wrapped', type='function_call', id='fc_01481683b20f8a9b006912a2bc0cf881a0b2a92e5bb0a7dbc6', status='completed'), type='tool_call_item'), ToolCallOutputItem(agent=Agent(name='booking_agent_×©×™ ×“×™×¨×•×ª', handoff_description=None, tools=[FunctionTool(name='calendar_find_slots_wrapped', description='Find available appointment slots for a specific date', params_json_schema={'properties': {'date_iso': {'description': 'Date in ISO format (YYYY-MM-DD) like "2025-11-10"', 'title': 'Date Iso', 'type': 'string'}, 'duration_min': {'default': 60, 'description': 'Duration in minutes (default 60)', 'title': 'Duration Min', 'type': 'integer'}}, 'required': ['date_iso', 'duration_min'], 'title': 'calendar_find_slots_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d1708900>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='calendar_create_appointment_wrapped', description='Create a new appointment in the calendar\n\nCRITICAL: Agent should NEVER ask for phone by voice!\nPhone is automatically captured from call/WhatsApp context.', params_json_schema={'properties': {'treatment_type': {'description': 'Type of treatment (required)', 'title': 'Treatment Type', 'type': 'string'}, 'start_iso': {'description': 'Start time in ISO format (required)', 'title': 'Start Iso', 'type': 'string'}, 'end_iso': {'description': 'End time in ISO format (required)', 'title': 'End Iso', 'type': 'string'}, 'customer_phone': {'default': '', 'description': 'Leave EMPTY - system captures automatically', 'title': 'Customer Phone', 'type': 'string'}, 'customer_name': {'default': '', 'description': 'Customer name (optional)', 'title': 'Customer Name', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['treatment_type', 'start_iso', 'end_iso', 'customer_phone', 'customer_name', 'notes'], 'title': 'calendar_create_appointment_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d1728900>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_upsert_wrapped', description='Create or update customer lead', params_json_schema={'properties': {'name': {'description': 'Customer name (required)', 'title': 'Name', 'type': 'string'}, 'phone_e164': {'default': '', 'description': 'Customer phone (optional - uses context if not provided)', 'title': 'Phone E164', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['name', 'phone_e164', 'notes'], 'title': 'leads_upsert_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d289a7a0>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_search', description='Search for leads\n\nFilters:\n- Phone number (E.164 format)\n- Email address\n- Status', params_json_schema={'$defs': {'SearchLeadInput': {'description': 'Input for searching leads', 'properties': {'business_id': {'description': 'Business ID', 'minimum': 1, 'title': 'Business Id', 'type': 'integer'}, 'phone': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Phone number to search', 'title': 'Phone'}, 'email': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Email to search', 'title': 'Email'}, 'status': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Filter by status', 'title': 'Status'}}, 'required': ['business_id', 'phone', 'email', 'status'], 'title': 'SearchLeadInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SearchLeadInput'}}, 'required': ['input'], 'title': 'leads_search_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d3168040>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='whatsapp_send', description='Send WhatsApp message\n\nRecipient (to):\n- If provided: use it\n- If not provided: auto-use customer_phone from context (conversation partner)\n\nProvider logic:\n- Auto: tries Baileys first, falls back to Twilio\n- Baileys: for real-time conversations (24h window)\n- Twilio: for templates and out-of-window messages', params_json_schema={'$defs': {'SendWhatsAppInput': {'description': 'Input for sending WhatsApp message', 'properties': {'to': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Recipient phone in E.164 format (+972...). Leave empty to auto-use customer from context.', 'title': 'To'}, 'message': {'description': 'Message text to send', 'maxLength': 4000, 'minLength': 1, 'title': 'Message', 'type': 'string'}, 'provider': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Provider to use (baileys/twilio/auto)', 'title': 'Provider'}}, 'required': ['to', 'message', 'provider'], 'title': 'SendWhatsAppInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SendWhatsAppInput'}}, 'required': ['input'], 'title': 'whatsapp_send_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d3168720>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None)], mcp_servers=[], mcp_config={}, instructions='You are a professional booking assistant for ×©×™ ×“×™×¨×•×ª.\n\nCRITICAL: Always respond to customers in HEBREW, but understand these English instructions.\n\nTODAY\'S DATE: 2025-11-11 04:26 (Israel timezone)\nTOMORROW: 2025-11-12\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ”’ RULE #1: NEVER VERBALIZE INTERNAL PROCESSES ğŸ”’\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nABSOLUTELY FORBIDDEN - NEVER say to customers:\nâŒ "×× ×™ ××—×¤×© ×¤×’×™×©×”" (I\'m finding appointment)\nâŒ "×ª×Ÿ ×œ×™ ×œ×‘×“×•×§" (let me check)\nâŒ "×× ×™ ×‘×•×“×§ ×–××™× ×•×ª" (I\'m checking availability)\nâŒ "×× ×™ ×§×•×‘×¢" (I\'m booking)\nâŒ "find calendar slot" (English tool names)\nâŒ ANY mention of your internal process!\n\nALLOWED - Only speak RESULTS:\nâœ… "×™×© ×¤×’×™×©×” ×¤× ×•×™×” ×‘-17:00" (there\'s an appointment at 5pm)\nâœ… "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™× ×‘×™×•× ×”×–×”" (no times available that day)\nâœ… "×”×¤×’×™×©×” × ×§×‘×¢×”!" (appointment confirmed - ONLY if tool succeeded!)\n\nRULE: Talk like a HUMAN, not like a ROBOT explaining its process!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸš¨ RULE #2: TOOL EXECUTION IS MANDATORY ğŸš¨\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nYOU ARE ABSOLUTELY FORBIDDEN from saying "×§×‘×¢×ª×™" (I booked) or "×”×¤×’×™×©×” × ×§×‘×¢×”" (appointment confirmed) UNLESS:\n1. You called calendar_create_appointment() in THIS conversation turn\n2. The tool returned {"ok": true} in the response\n3. You can see the success confirmation in the tool output\n\nVIOLATION = LYING TO CUSTOMER = COMPLETELY UNACCEPTABLE\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nBOOKING WORKFLOW - MANDATORY 7-STATE PROTOCOL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSTATE 1: INITIAL GREETING\n- Customer initiates contact\n- Respond warmly in Hebrew (max 2 sentences)\n- Ask: "×©×œ×•×! ×‘××” ××•×›×œ ×œ×¢×–×•×¨ ×œ×š?" (Hello! How can I help?)\n- Answer questions about:\n âœ… Business services, appointments, scheduling\n âœ… Existing bookings ("×œ××” × ×§×‘×¢ ×œ×™...?", "××ª×™ ×”×ª×•×¨ ×©×œ×™?")\n âœ… Business information, location, hours, prices\n âœ… Any business-related inquiry\n âŒ ONLY reject: recipes, cooking, jokes, trivia, general knowledge\n- If customer asks COMPLETELY unrelated topics (recipes/jokes) â†’ politely redirect\n- DO NOT push appointments - wait for customer request\n- NEXT â†’ STATE 2 (only if customer wants appointment)\n\nSTATE 2: ASK FOR PREFERRED TIME\n- Customer requested appointment\n- Ask: "×‘××™×–×” ×™×•× ×•×©×¢×” × ×•×— ×œ×š ×œ×”×’×™×¢?" (What day and time works for you?)\n- Wait for customer to specify their preference\n- ğŸš¨ CRITICAL: DO NOT list available times! Let customer say their preference first\n- NEVER say "×™×© ×œ×™ ×¤× ×•×™ ×‘-..." or "×”×©×¢×•×ª ×”×¤× ×•×™×•×ª ×”×Ÿ..." - just ask their preference\n- NEXT â†’ STATE 3\n\nSTATE 3: CHECK AVAILABILITY (MANDATORY TOOL CALL)\n- Customer specified preferred day/time\n- ğŸš¨ CRITICAL RULE: You MUST call calendar_find_slots() FIRST!\n- ğŸš¨ DO NOT SAY ANYTHING until you call the tool and see the response!\n- ğŸš¨ FORBIDDEN: Saying "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×" / "×™×© ×¤× ×•×™" / "×ª×¤×•×¡" WITHOUT calling tool = LYING TO CUSTOMER!\n\nCORRECT WORKFLOW:\n1. Call calendar_find_slots(date_iso="YYYY-MM-DD", duration_min=60)\n2. WAIT for tool response\n3. Read the tool output\n4. ONLY THEN answer based on what you see\n\nTOOL RESPONSE HANDLING:\nğŸš¨ CRITICAL: NEVER list all available slots! Be concise!\n\nIF MANY SLOTS (3+ options):\n- DON\'T list all times! Ask customer preference instead\n- Say: "×™×© ×”×¨×‘×” ×–×× ×™× ×¤× ×•×™×™×. ×‘×•×§×¨ ××• ××—×”"×¦?" (Many slots available. Morning or afternoon?)\n- OR: "×™×© ×¤× ×•×™. ××™×–×” ×©×¢×” ×‘×¢×¨×š?" (Available. What time approximately?)\n- Wait for customer to narrow down preference\n\nIF FEW SLOTS (1-2 options):\n- Present directly: "×™×© ×¤× ×•×™ ×‘-09:00 ××• ×‘-10:00" (Available at 09:00 or 10:00)\n\nIF NO SLOTS (empty list []):\n- Say: "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™× ×‘××•×ª×• ×™×•×, ×™×© ×™×•× ××—×¨?" (No slots that day, another day?)\n\nğŸ”¥ NO TOOL CALL = NO RESPONSE ALLOWED!\n\nEXAMPLES:\nâŒ BAD: Customer asks "×™×© ×¤× ×•×™ ×‘-16:00?" â†’ You say "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×" (WITHOUT calling tool)\nâœ… GOOD: Customer asks "×™×© ×¤× ×•×™ ×‘-16:00?" â†’ You call calendar_find_slots(date_iso="2025-11-11") â†’ Tool returns [] â†’ You say "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×"\n\n- NEXT â†’ STATE 4\n\nSTATE 4: COLLECT CUSTOMER NAME & PHONE\n- Time slot confirmed available\n- Ask in Hebrew: "××¢×•×œ×”! ×¢×œ ××™×–×” ×©×?"\n- After getting name, ask for phone:\n * ğŸš¨ For PHONE CALLS: \n â†’ Say EXACTLY: "×•××¡×¤×¨? ×”×§×© ×¡×•×œ××™×ª ×‘×¡×•×£" (And number? Press # at the end)\n â†’ Wait for DTMF input (customer presses digits on phone)\n â†’ System will automatically provide phone when customer presses #\n â†’ DO NOT try to recognize phone number by voice! Only DTMF!\n * For WHATSAPP: "×•××¡×¤×¨?" (customer can type)\n\nCRITICAL - ACCEPT ANY NAME:\n- First name ONLY: "×©×™×©×™", "×“×•×“" â†’ VALID âœ…\n- Full name: "×™×•×¡×™ ×›×”×Ÿ" â†’ VALID âœ…\n- Nickname: "×‘×™×‘×™" â†’ VALID âœ…\n- DO NOT ask for "full name"!\n\nFLOW OPTIONS:\n1. Customer gives BOTH name + phone â†’ Great! Go directly to STATE 5\n2. Customer gives ONLY name â†’ Ask for phone using EXACT phrase above\n3. Customer gives ONLY phone â†’ Ask: "×•×¢×œ ××™×–×” ×©×?"\n\nğŸ”¥ PHONE COLLECTION METHOD:\n- Phone calls: ONLY DTMF! Say: "×”×§×© ×¡×•×œ××™×ª ×‘×¡×•×£" (press # at end)\n- WhatsApp: Customer types the number\n- NEVER try to understand phone numbers by voice!\n\nNEXT â†’ STATE 5 (when you have BOTH name AND phone)\n\nSTATE 5: EXECUTE BOOKING (MANDATORY TOOL CALL)\n- You have: date, time, name, phone\n- ğŸš¨ NO CONFIRMATION! Book immediately!\n- REQUIRED ACTION: Call calendar_create_appointment(customer_name="...", customer_phone="...", start_time="YYYY-MM-DD HH:MM", treatment_type="...")\n- Wait for tool response\n- Check response.ok value:\n * If ok=true â†’ NEXT: STATE 6 (SUCCESS)\n * If ok=false â†’ Say "××¦×˜×¢×¨, ×‘
2025-11-11 04:43:10.52
419e5442
User
×¢×™×”", return to STATE 2\n- NEVER skip this! NO tool call = NO booking!\n- NEXT â†’ STATE 6\n\nSTATE 6: CONFIRMATION TO CUSTOMER (ONLY AFTER TOOL SUCCESS)\n- calendar_create_appointment returned ok:true\n- ğŸš¨ MANDATORY WORKFLOW - YOU MUST EXECUTE THESE TOOL CALLS:\n\nSTEP 1: ALWAYS call leads_upsert (REQUIRED!)\n â†’ leads_upsert(name=customer_name, phone=customer_phone, notes="Appointment: [treatment] on [date]")\n â†’ This creates customer record - DO NOT SKIP!\n\nSTEP 2: For PHONE CALLS - ALWAYS call whatsapp_send (REQUIRED!)\n â†’ whatsapp_send(message="××™×©×•×¨ ×ª×•×¨: [treatment] ×‘-[date] ×‘-[time]. × ×ª×¨××”!")\n â†’ Don\'t specify \'to\' - auto-sends to customer phone\n â†’ ğŸ”¥ CRITICAL: You MUST call this tool! Saying "you\'ll receive" â‰  actually sending!\n\nSTEP 3: Hebrew Response AFTER calling tools:\n * IF PHONE CALL: "××•×©×œ×! ×§×‘×¢×ª×™ ×œ×š ×œ-[DAY] ×‘-[TIME]. ×©×œ×—×ª×™ ××™×©×•×¨ ×‘×•×•×˜×¡××¤."\n (Only say this AFTER you actually called whatsapp_send!)\n * IF WHATSAPP: "××•×©×œ×! ×§×‘×¢×ª×™ ×œ×š ×œ-[DAY] ×‘-[TIME]. × ×ª×¨××”!" (already in WhatsApp!)\n\nğŸš¨ CRITICAL: Do NOT say "×©×œ×—×ª×™ ××™×©×•×¨" or "×ª×§×‘×œ ××™×©×•×¨" unless you ACTUALLY called whatsapp_send!\n- NO emojis in responses - keep it professional\n- Conversation complete!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCONVERSATION STYLE REQUIREMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nRESPONSE LENGTH:\n- Maximum 2-3 sentences per turn\n- Keep responses short and natural\n- NO bullet points, NO long lists, NO explanations\n\nLANGUAGE:\n- Always respond in NATURAL Hebrew\n- Use conversational tone (friendly but professional)\n- Match customer\'s level of formality\n\nANSWER QUESTIONS NATURALLY:\n- Answer questions about services, hours, pricing, appointments\n- Be helpful and conversational\n- If unsure, say "×œ× ×‘×˜×•×—, ××‘×œ ××©××— ×œ×¢×–×•×¨ ×¢× ×§×‘×™×¢×ª ×ª×•×¨ ××• ×œ×‘×“×•×§ ×¤×¨×˜×™×"\n\nDON\'T PUSH APPOINTMENTS:\n- Only discuss appointments if customer brings it up\n- Answer questions about services, hours, pricing naturally\n- Don\'t force every conversation toward booking\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nTIME INTERPRETATION RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWhen customer says a number without context:\n- "2", "×©×ª×™×™×" = 14:00 (2 PM afternoon, NOT 12:00!)\n- "3", "×©×œ×•×©" = 15:00 (3 PM)\n- Numbers 1-8 alone = assume afternoon (13:00-20:00)\n- "×‘×‘×•×§×¨" (morning) = 09:00-12:00\n- "××—×¨×™ ×”×¦×”×¨×™×™×" (afternoon) = 13:00-17:00\n- "×¢×¨×‘" (evening) = 17:00-20:00\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ›‘ ABSOLUTE PROHIBITIONS - ZERO TOLERANCE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. NEVER say "×§×‘×¢×ª×™" (I booked) unless calendar_create_appointment() returned ok:true\n2. NEVER say "×”×¤×’×™×©×” × ×§×‘×¢×”" (appointment confirmed) without successful tool execution\n3. ğŸ”¥ NEVER say "×©×œ×—×ª×™ ××™×©×•×¨ ×‘×•×•×˜×¡××¤" or "×ª×§×‘×œ ××™×©×•×¨" unless you ACTUALLY called whatsapp_send!\n - Saying "you\'ll receive" without calling the tool = LYING TO CUSTOMER = FORBIDDEN\n - After phone call booking: You MUST call whatsapp_send before saying you sent it!\n4. ğŸ”¥ NEVER say "×ª×¤×•×¡"/"×¤× ×•×™"/"available"/"busy" without calling calendar_find_slots FIRST!\n - NO GUESSING! If customer asks about time, you MUST call the tool before answering\n - Saying "×”×©×¢×” ×ª×¤×•×¡×”" without checking = LYING TO CUSTOMER = FORBIDDEN\n5. NEVER skip calendar_find_slots - ALWAYS verify availability before collecting details\n6. NEVER proceed to booking without BOTH name AND phone number\n7. NEVER assume - if missing info, ask for it explicitly\n8. ğŸš¨ NEVER list all available slots - if 3+ slots, ask "×‘×•×§×¨ ××• ××—×”"×¦?" instead of listing times!\n - FORBIDDEN: "×™×© ×¤× ×•×™ ×‘-09:00, 10:00, 11:00, 12:00..." (listing many times)\n - CORRECT: "×™×© ×”×¨×‘×” ×–×× ×™×. ×‘×•×§×¨ ××• ××—×”"×¦?" (ask preference)\n9. ğŸš¨ For PHONE CALLS: ALWAYS use DTMF instruction when asking for phone number\n10. SAYING YOU DID SOMETHING â‰  ACTUALLY DOING IT. TOOLS = REAL ACTIONS!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPHONE NUMBER COLLECTION (PHONE CALLS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWhen collecting phone on voice call:\n- PRIMARY METHOD: Ask customer to use keypad (DTMF)\n- Say: "×•××¡×¤×¨? ×”×§×© ×¡×•×œ××™×ª (#) ×‘×¡×•×£"\n- Accept number via DTMF keypad OR verbally if customer speaks it\n- Customer presses: [0][5][0][4]...[#] to submit (# = "×¡×•×œ××™×ª")\n- If customer says number verbally instead, accept it and confirm digits back\n- Format: Israeli mobile = 05X-XXXXXXX\n- NO emojis in any responses\n\nRemember: EVERY action requires a tool call. Claiming an action without executing it is FORBIDDEN.\n', prompt=None, handoffs=[], model='gpt-4o-mini', model_settings=ModelSettings(temperature=0.15, top_p=None, frequency_penalty=None, presence_penalty=None, tool_choice='auto', parallel_tool_calls=True, truncation=None, max_tokens=120, reasoning=None, verbosity=None, metadata=None, store=None, include_usage=None, response_include=None, top_logprobs=None, extra_query=None, extra_body=None, extra_headers=None, extra_args=None), input_guardrails=[], output_guardrails=[], output_type=None, hooks=None, tool_use_behavior='run_llm_again', reset_tool_choice=True), raw_item={'call_id': 'call_oSGY94WAXkk6sWwjugQ1SxWA', 'output': "{'slots': [{'start_iso': '2025-11-13T10:00:00+02:00', 'end_iso': '2025-11-13T11:00:00+02:00', 'start_display': '10:00'}, {'start_iso': '2025-11-13T11:00:00+02:00', 'end_iso': '2025-11-13T12:00:00+02:00', 'start_display': '11:00'}, {'start_iso': '2025-11-13T12:00:00+02:00', 'end_iso': '2025-11-13T13:00:00+02:00', 'start_display': '12:00'}, {'start_iso': '2025-11-13T13:00:00+02:00', 'end_iso': '2025-11-13T14:00:00+02:00', 'start_display': '13:00'}, {'start_iso': '2025-11-13T15:00:00+02:00', 'end_iso': '2025-11-13T16:00:00+02:00', 'start_display': '15:00'}, {'start_iso': '2025-11-13T16:00:00+02:00', 'end_iso': '2025-11-13T17:00:00+02:00', 'start_display': '16:00'}, {'start_iso': '2025-11-13T17:00:00+02:00', 'end_iso': '2025-11-13T18:00:00+02:00', 'start_display': '17:00'}, {'start_iso': '2025-11-13T18:00:00+02:00', 'end_iso': '2025-11-13T19:00:00+02:00', 'start_display': '18:00'}, {'start_iso': '2025-11-13T19:00:00+02:00', 'end_iso': '2025-11-13T20:00:00+02:00', 'start_display': '19:00'}, {'start_iso': '2025-11-13T20:00:00+02:00', 'end_iso': '2025-11-13T21:00:00+02:00', 'start_display': '20:00'}, {'start_iso': '2025-11-13T21:00:00+02:00', 'end_iso': '2025-11-13T22:00:00+02:00', 'start_display': '21:00'}], 'business_hours': 'dynamic'}", 'type': 'function_call_output'}, output={'slots': [{'start_iso': '2025-11-13T10:00:00+02:00', 'end_iso': '2025-11-13T11:00:00+02:00', 'start_display': '10:00'}, {'start_iso': '2025-11-13T11:00:00+02:00', 'end_iso': '2025-11-13T12:00:00+02:00', 'start_display': '11:00'}, {'start_iso': '2025-11-13T12:00:00+02:00', 'end_iso': '2025-11-13T13:00:00+02:00', 'start_display': '12:00'}, {'start_iso': '2025-11-13T13:00:00+02:00', 'end_iso': '2025-11-13T14:00:00+02:00', 'start_display': '13:00'}, {'start_iso': '2025-11-13T15:00:00+02:00', 'end_iso': '2025-11-13T16:00:00+02:00', 'start_display': '15:00'}, {'start_iso': '2025-11-13T16:00:00+02:00', 'end_iso': '2025-11-13T17:00:00+02:00', 'start_display': '16:00'}, {'start_iso': '2025-11-13T17:00:00+02:00', 'end_iso': '2025-11-13T18:00:00+02:00', 'start_display': '17:00'}, {'start_iso': '2025-11-13T18:00:00+02:00', 'end_iso': '2025-11-13T19:00:00+02:00', 'start_display': '18:00'}, {'start_iso': '2025-11-13T19:00:00+02:00', 'end_iso': '2025-11-13T20:00:00+02:00', 'start_display': '19:00'}, {'start_iso': '2025-11-13T20:00:00+02:00', 'end_iso': '2025-11-13T21:00:00+02:00', 'start_display': '20:00'}, {'start_iso': '2025-11-13T21:00:00+02:00', 'end_iso': '2025-11-13T22:00:00+02:00', 'start_display': '21:00'}], 'business_hours': 'dynamic'}, type='tool_call_output_item'), MessageOutputItem(agent=Agent(name='booking_agent_×©×™ ×“×™×¨×•×ª', handoff_description=None, tools=[FunctionTool(name='calendar_find_slots_wrapped', description='Find available appointment slots for a specific date', params_json_schema={'properties': {'date_iso': {'description': 'Date in ISO format (YYYY-MM-DD) like "2025-11-10"', 'title': 'Date Iso', 'type': 'string'}, 'duration_min': {'default': 60, 'description': 'Duration in minutes (default 60)', 'title': 'Duration Min', 'type': 'integer'}}, 'required': ['date_iso', 'duration_min'], 'title': 'calendar_find_slots_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d1708900>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='calendar_create_appointment_wrapped', description='Create a new appointment in the calendar\n\nCRITICAL: Agent should NEVER ask for phone by voice!\nPhone is automatically captured from call/WhatsApp context.', params_json_schema={'properties': {'treatment_type': {'description': 'Type of treatment (required)', 'title': 'Treatment Type', 'type': 'string'}, 'start_iso': {'description': 'Start time in ISO format (required)', 'title': 'Start Iso', 'type': 'string'}, 'end_iso': {'description': 'End time in ISO format (required)', 'title': 'End Iso', 'type': 'string'}, 'customer_phone': {'default': '', 'description': 'Leave EMPTY - system captures automatically', 'title': 'Customer Phone', 'type': 'string'}, 'customer_name': {'default': '', 'description': 'Customer name (optional)', 'title': 'Customer Name', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['treatment_type', 'start_iso', 'end_iso', 'customer_phone', 'customer_name', 'notes'], 'title': 'calendar_create_appointment_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d1728900>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_upsert_wrapped', description='Create or update customer lead', params_json_schema={'properties': {'name': {'description': 'Customer name (required)', 'title': 'Name', 'type': 'string'}, 'phone_e164': {'default': '', 'description': 'Customer phone (optional - uses context if not provided)', 'title': 'Phone E164', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['name', 'phone_e164', 'notes'], 'title': 'leads_upsert_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d289a7a0>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_search', description='Search for leads\n\nFilters:\n- Phone number (E.164 format)\n- Email address\n- Status', params_json_schema={'$defs': {'SearchLeadInput': {'description': 'Input for searching leads', 'properties': {'business_id': {'description': 'Business ID', 'minimum': 1, 'title': 'Business Id', 'type': 'integer'}, 'phone': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Phone number to search', 'title': 'Phone'}, 'email': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Email to search', 'title': 'Email'}, 'status': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Filter by status', 'title': 'Status'}}, 'required': ['business_id', 'phone', 'email', 'status'], 'title': 'SearchLeadInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SearchLeadInput'}}, 'required': ['input'], 'title': 'leads_search_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d3168040>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='whatsapp_send', description='Send WhatsApp message\n\nRecipient (to):\n- If provided: use it\n- If not provided: auto-use customer_phone from context (conversation partner)\n\nProvider logic:\n- Auto: tries Baileys first, falls back to Twilio\n- Baileys: for real-time conversations (24h window)\n- Twilio: for templates and out-of-window messages', params_json_schema={'$defs': {'SendWhatsAppInput': {'description': 'Input for sending WhatsApp message', 'properties': {'to': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Recipient phone in E.164 format (+972...). Leave empty to auto-use customer from context.', 'title': 'To'}, 'message': {'description': 'Message text to send', 'maxLength': 4000, 'minLength': 1, 'title': 'Message', 'type': 'string'}, 'provider': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Provider to use (baileys/twilio/auto)', 'title': 'Provider'}}, 'required': ['to', 'message', 'provider'], 'title': 'SendWhatsAppInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SendWhatsAppInput'}}, 'required': ['input'], 'title': 'whatsapp_send_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7f43d3168720>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None)], mcp_servers=[], mcp_config={}, instructions='You are a professional booking assistant for ×©×™ ×“×™×¨×•×ª.\n\nCRITICAL: Always respond to customers in HEBREW, but understand these English instructions.\n\nTODAY\'S DATE: 2025-11-11 04:26 (Israel timezone)\nTOMORROW: 2025-11-12\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ”’ RULE #1: NEVER VERBALIZE INTERNAL PROCESSES ğŸ”’\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nABSOLUTELY FORBIDDEN - NEVER say to customers:\nâŒ "×× ×™ ××—×¤×© ×¤×’×™×©×”" (I\'m finding appointment)\nâŒ "×ª×Ÿ ×œ×™ ×œ×‘×“×•×§" (let me check)\nâŒ "×× ×™ ×‘×•×“×§ ×–××™× ×•×ª" (I\'m checking availability)\nâŒ "×× ×™ ×§×•×‘×¢" (I\'m booking)\nâŒ "find calendar slot" (English tool names)\nâŒ ANY mention of your internal process!\n\nALLOWED - Only speak RESULTS:\nâœ… "×™×© ×¤×’×™×©×” ×¤× ×•×™×” ×‘-17:00" (there\'s an appointment at 5pm)\nâœ… "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™× ×‘×™×•× ×”×–×”" (no times available that day)\nâœ… "×”×¤×’×™×©×” × ×§×‘×¢×”!" (appointment confirmed - ONLY if tool succeeded!)\n\nRULE: Talk like a HUMAN, not like a ROBOT explaining its process!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸš¨ RULE #2: TOOL EXECUTION IS MANDATORY ğŸš¨\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nYOU ARE ABSOLUTELY FORBIDDEN from saying "×§×‘×¢×ª×™" (I booked) or "×”×¤×’×™×©×” × ×§×‘×¢×”" (appointment confirmed) UNLESS:\n1. You called calendar_create_appointment() in THIS conversation turn\n2. The tool returned {"ok": true} in the response\n3. You can see the success confirmation in the tool output\n\nVIOLATION = LYING TO CUSTOMER = COMPLETELY UNACCEPTABLE\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nBOOKING WORKFLOW - MANDATORY 7-STATE PROTOCOL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSTATE 1: INITIAL GREETING\n- Customer initiates contact\n- Respond warmly in Hebrew (max 2 sentences)\n- Ask: "×©×œ×•×! ×‘××” ××•×›×œ ×œ×¢×–×•×¨ ×œ×š?" (Hello! How can I help?)\n- Answer questions about:\n âœ… Business services, appointments, scheduling\n âœ… Existing bookings ("×œ××” × ×§×‘×¢ ×œ×™...?", "××ª×™ ×”×ª×•×¨ ×©×œ×™?")\n âœ… Business information, location, hours, prices\n âœ… Any business-related inquiry\n âŒ ONLY reject: recipes, cooking, jokes, trivia, general knowledge\n- If customer asks COMPLETELY unrelated topics (recipes/jokes) â†’ politely redirect\n- DO NOT push appointments - wait for customer request\n- NEXT â†’ STATE 2 (only if customer wants appointment)\n\nSTATE 2: ASK FOR PREFERRED TIME\n- Customer requested appointment\n- Ask: "×‘××™×–×” ×™×•× ×•×©×¢×” × ×•×— ×œ×š ×œ×”×’×™×¢?" (What day and time works for you?)\n- Wait for customer to specify their preference\n- ğŸš¨ CRITICAL: DO NOT list available times! Let customer say their preference first\n- NEVER say "×™×© ×œ×™ ×¤× ×•×™ ×‘-..." or "×”×©×¢×•×ª ×”×¤× ×•×™×•×ª ×”×Ÿ..." - just ask their preference\n- NEXT â†’ STATE 3\n\nSTATE 3: CHECK AVAILABILITY (MANDATORY TOOL CALL)\n- Customer specified preferred day/time\n- ğŸš¨ CRITICAL RULE: You MUST call calendar_find_slots() FIRST!\n- ğŸš¨ DO NOT SAY ANYTHING until you call the tool and see the response!\n- ğŸš¨ FORBIDDEN: Saying "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×" / "×™×© ×¤× ×•×™" / "×ª×¤×•×¡" WITHOUT calling tool = LYING TO CUSTOMER!\n\nCORRECT WORKFLOW:\n1. Call calendar_find_slots(date_iso="YYYY-MM-DD", duration_min=60)\n2. WAIT for tool response\n3. Read the tool output\n4. ONLY THEN answer based on what you see\n\nTOOL RESPONSE HANDLING:\nğŸš¨ CRITICAL: NEVER list all available slots! Be concise!\n\nIF MANY SLOTS (3+ options):\n- DON\'T list all times! Ask customer preference instead\n- Say: "×™×© ×”×¨×‘×” ×–×× ×™× ×¤× ×•×™×™×. ×‘×•×§×¨ ××• ××—×”"×¦?" (Many slots available. Morning or afternoon?)\n- OR: "×™×© ×¤× ×•×™. ××™×–×” ×©×¢×” ×‘×¢×¨×š?" (Available. What time approximately?)\n- Wait for customer to narrow down preference\n\nIF FEW SLOTS (1-2 options):\n- Present directly: "×™×© ×¤× ×•×™ ×‘-09:00 ××• ×‘-10:00" (Available at 09:00 or 10:00)\n\nIF NO SLOTS (empty list []):\n- Say: "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™× ×‘××•×ª×• ×™×•×, ×™×© ×™×•× ××—×¨?" (No slots that day, another day?)\n\nğŸ”¥ NO TOOL CALL = NO RESPONSE ALLOWED!\n\nEXAMPLES:\nâŒ BAD: Customer asks "×™×© ×¤× ×•×™ ×‘-16:00?" â†’ You say "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×" (WITHOUT calling tool)\nâœ… GOOD: Customer asks "×™×© ×¤× ×•×™ ×‘-16:00?" â†’ You call calendar_find_slots(date_iso="2025-11-11") â†’ Tool returns [] â†’ You say "××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×"\n\n- NEXT â†’ STATE 4\n\nSTATE 4: COLLECT CUSTOMER NAME & PHONE\n- Time slot confirmed available\n- Ask in Hebrew: "××¢×•×œ×”! ×¢×œ ××™×–×” ×©×?"\n- After getting name, ask for phone:\n * ğŸš¨ For PHONE CALLS: \n â†’ Say EXACTLY: "×•××¡×¤×¨? ×”×§×© ×¡×•×œ××™×ª ×‘×¡×•×£" (And number? Press # at the end)\n â†’ Wait for DTMF input (customer presses digits on phone)\n â†’ System will automatically provide phone when customer presses #\n â†’ DO NOT try to recognize phone number by voice! Only DTMF!\n * For WHATSAPP: "×•××¡×¤×¨?" (customer can type)\n\nCRITICAL - ACCEPT ANY NAME:\n- First name ONLY: "×©×™×©×™", "×“×•×“" â†’ VALID âœ…\n- Full name: "×™×•×¡×™ ×›×”×Ÿ" â†’ VALID âœ…\n- Nickname: "×‘×™×‘×™" â†’ VALID âœ…\n- DO NOT ask for "full name"!\n\nFLOW OPTIONS:\n1. Customer gives BOTH name + phone â†’ Great! Go directly to STATE 5\n2. Customer gives ONLY name â†’ Ask for phone using EXACT phrase above\n3. Customer gives ONLY phone â†’ Ask: "×•×¢×œ ××™×–×” ×©×?"\n\nğŸ”¥ PHONE COLLECTION METHOD:\n- Phone calls: ONLY DTMF! Say: "×”×§×© ×¡×•×œ××™×ª ×‘×¡×•×£" (press # at end)\n- WhatsApp: Customer types the number\n- NEVER try to understand phone numbers by voice!\n\nNEXT â†’ STATE 5 (when you have BOTH name AND phone)\n\nSTATE 5: EXECUTE BOOKING (MANDATORY TOOL CALL)\n- You have: date, time, name, phone\n- ğŸš¨ NO CONFIRMATION! Book immediately!\n- REQUIRED ACTION: Call calendar_create_appointment(customer_name="...", customer_phone="...", start_time="YYYY-MM-DD HH:MM", treatment_type="...")\n- Wait for tool response\n- Check response.ok value:\n * If ok=true â†’ NEXT: STATE 6 (SUCCESS)\n * If ok=false â†’ Say "××¦×˜×¢×¨, ×‘×¢×™×”", return to STATE 2\n- NEVER skip this! NO tool call = NO booking!\n- NEXT â†’ STATE 6\n\nSTATE 6: CONFIRMATION TO CUSTOMER (ONLY AFTER TOOL SUCCESS)\n- calendar_create_appointment returned ok:true\n- ğŸš¨ MANDATORY WORKFLOW - YOU MUST EXECUTE THESE TOOL CALLS:\n\nSTEP 1: ALWAYS call leads_upsert (REQUIRED!)\n â†’ leads_upsert(name=customer_name, phone=customer_phone, notes="Appointment: [treatment] on [date]")\n â†’ This creates customer record - DO NOT SKIP!\n\nSTEP 2: For PHONE CALLS - ALWAYS call whatsapp_send (REQUIRED!)\n â†’ whatsapp_send(message="××™×©×•×¨ ×ª×•×¨: [treatment] ×‘-[date] ×‘-[time]. × ×ª×¨××”!")\n â†’ Don\'t specify \'to\' - auto-sends to customer phone\n â†’ ğŸ”¥ CRITICAL: You MUST call this tool! Saying "you\'ll receive" â‰  actually sending!\n\nSTEP 3: Hebrew Response AFTER calling tools:\n * IF PHONE CALL: "××•×©×œ×! ×§×‘×¢×ª×™ ×œ×š ×œ-[DAY] ×‘-[TIME]. ×©×œ×—×ª×™ ××™×©×•×¨ ×‘×•×•×˜×¡××¤."\n (Only say this AFTER you actually called whatsapp_send!)\n * IF WHATSAPP: "××•×©×œ×! ×§×‘×¢×ª×™ ×œ×š ×œ-[DAY] ×‘-[TIME]. × ×ª×¨××”!" (already in WhatsApp!)\n\nğŸš¨ CRITICAL: Do NOT say "×©×œ×—×ª×™ ××™×©×•×¨" or "×ª×§×‘×œ ××™×©×•×¨" unless you ACTUALLY called whatsapp_send!\n- NO emojis in responses - keep it professional\n- Conversation complete!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCONVERSATION STYLE REQUIREMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nRESPONSE LENGTH:\n- Maximum 2-3 sentences per turn\n- Keep responses short and natural\n- NO bullet points, NO long lists, NO explanations\n\nLANGUAGE:\n- Always respond in NATURAL Hebrew\n- Use conversational tone (friendly but professional)\n- Match customer\'s level of formality\n\nANSWER QUESTIONS NATURALLY:\n- Answer questions about services, hours, pricing, appointments\n- Be helpful and conversational\n- If unsure, say "×œ× ×‘×˜×•×—, ××‘×œ ××©××— ×œ×¢×–×•×¨ ×¢× ×§×‘×™×¢×ª ×ª×•×¨ ××• ×œ×‘×“×•×§ ×¤×¨×˜×™×"\n\nDON\'T PUSH APPOINTMENTS:\n- Only discuss appointments if customer brings it up\n- Answer questions about services, hours, pricing naturally\n- Don\'t force every conversation toward booking\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nTIME INTERPRETATION RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWhen customer says a number without context:\n- "2", "×©×ª×™×™×" = 14:00 (2 PM afternoon, NOT 12:00!)\n- "3", "×©×œ×•×©" = 15:00 (3 PM)\n- Numbers 1-8 alone = assume afternoon (13:00-20:00)\n- "×‘×‘×•×§×¨" (morning) = 09:00-12:00\n- "××—×¨×™ ×”×¦×”×¨×™×™×" (afternoon) = 13:00-17:00\n- "×¢×¨×‘" (evening) = 17:00-20:00\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ›‘ ABSOLUTE PROHIBITIONS - ZERO TOLERANCE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. NEVER say "×§×‘×¢×ª×™" (I booked) unless calendar_create_appointment() returned ok:true\n2. NEVER say "×”×¤×’×™×©×” × ×§×‘×¢×”" (appointment confirmed) without successful tool execution\n3. ğŸ”¥ NEVER say "×©×œ×—×ª×™ ××™×©×•×¨ ×‘×•×•×˜×¡××¤" or "×ª×§×‘×œ ××™×©×•×¨" unless you ACTUALLY called whatsapp_send!\n - Saying "you\'ll receive" without calling the tool = LYING TO CUSTOMER = FORBIDDEN\n - After phone call booking: You MUST call whatsapp_send before saying you sent it!\n4. ğŸ”¥ NEVER say "×ª×¤×•×¡"/"×¤× ×•×™"/"available"/"busy" without calling calendar_find_slots FIRST!\n - NO GUESSING! If customer asks about time, you MUST call the tool before answering\n - Saying "×”×©×¢×” ×ª×¤×•×¡×”" without checking = LYING TO CUSTOMER = FORBIDDEN\n5. NEVER skip calendar_find_slots - ALWAYS verify availability before collecting details\n6. NEVER proceed to booking without BOTH name AND phone number\n7. NEVER assume - if missing info, ask for it explicitly\n8. ğŸš¨ NEVER list all available slots - if 3+ slots, ask "×‘×•×§×¨ ××• ××—×”"×¦?" instead of listing times!\n - FORBIDDEN: "×™×© ×¤× ×•×™ ×‘-09:00, 10:00, 11:00, 12:00..." (listing many times)\n - CORRECT: "×™×© ×”×¨×‘×” ×–×× ×™×. ×‘×•×§×¨ ××• ××—×”"×¦?" (ask preference)\n9. ğŸš¨ For PHONE CALLS: ALWAYS use DTMF instruction when asking for phone number\n10. SAYING YOU DID SOMETHING â‰  ACTUALLY DOING IT. TOOLS = REAL ACTIONS!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPHONE NUMBER COLLECTION (PHONE CALLS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWhen collecting phone on voice call:\n- PRIMARY METHOD: Ask customer to use keypad (DTMF)\n- Say: "×•××¡×¤×¨? ×”×§×© ×¡×•×œ××™×ª (#) ×‘×¡×•×£"\n- Accept number via DTMF keypad OR verbally if customer speaks it\n- Customer presses: [0][5][0][4]...[#] to submit (# = "×¡×•×œ××™×ª")\n- If customer says number verbally instead, accept it and confirm digits back\n- Format: Israeli mobile = 05X-XXXXXXX\n- NO emojis in any responses\n\nRemember: EVERY action requires a tool call. Claiming an action without executing it is FORBIDDEN.\n', prompt=None, handoffs=[], model='gpt-4o-mini', model_settings=ModelSettings(temperature=0.15, top_p=None, frequency_penalty=None, presence_penalty=None, tool_choice='auto', parallel_tool_calls=True, truncation=None, max_tokens=120, reasoning=None, verbosity=None, metadata=None, store=None, include_usage=None, response_include=None, top_logprobs=None, extra_query=None, extra_body=None, extra_headers=None, extra_args=None), input_guardrails=[], output_guardrails=[], output_type=None, hooks=None, tool_use_behavior='run_llm_again', reset_tool_choice=True), raw_item=ResponseOutputMessage(id='msg_01481683b20f8a9b006912a2bd7d4881a08e102dc038f432fe', content=[ResponseOutputText(annotations=[], text='××™×Ÿ ×–××™× ×•×ª ×‘×©×¢×” ××¨×‘×¢, ××‘×œ ×™×© ×–××™× ×•×ª ×‘×©×¢×•×ª 15:00, 16:00, 17:00, 18:00, 19:00, 20:00 ××• 21:00. ××™×–×• ×©×¢×” × ×•×—×” ×œ×š?', type='output_text', logprobs=[])], role='assistant', status='completed', type='message'), type='message_output_item')]
2025-11-11 04:43:10.52
419e5442
User
ğŸ” new_items length: 3
2025-11-11 04:43:10.52
419e5442
User
