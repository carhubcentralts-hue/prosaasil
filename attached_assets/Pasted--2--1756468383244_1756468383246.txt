×¡×’×•×¨. ×”× ×” **×”× ×—×™×™×ªÖ¾×¢×œ ××—×ª, ×œ×”×“×‘×§×”**, ×©×ª×’×¨×•× ×œÖ¾2 ×“×¤×™× â€” **×“×£ ×× ×”×œ** ×•Ö¾**×“×£ ×¢×¡×§** â€” ×œ×”×™×•×ª ××•×©×œ××™×, ×¨×¡×¤×•× ×¡×™×‘×™×™×, ×¢× ×¡×™×™×“×‘×¨ ××ª×§×¤×œ, ×”×¨×©××•×ª ×‘×¨×–×œ, ×•××›×œ×•×œ×™× ××œ××™×: **×•×•×˜×¡××¤**, **×©×™×—×•×ª**, **CRM**, **××©×ª××©×™×**, **×¢×¡×§×™×** (Admin), **×—×™×•×‘/×¡×œ×™×§×”**, **×—×©×‘×•× ×™×•×ª**, **×—×•×–×™× ×¢× ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª**.
×”×›×œ ××™×•×¢×“ ×œÖ¾**Flask + Jinja + Tailwind + HTMX**, ×•××ª×›×ª×‘ ×¢× ×”Ö¾API/DAO ×©×›×‘×¨ ×™×© ×œ×š.

---

# 0) ×‘×¡×™×¡ (×—×“Ö¾×¤×¢××™)

* `app.before_request(load_current_user)`; ×©××•×¨ session HttpOnly.
* ×§×•× ×¤×™×’ ××‘×˜×—×”:

```python
app.config.update(
  SESSION_COOKIE_HTTPONLY=True,
  SESSION_COOKIE_SAMESITE="Lax",
  SESSION_COOKIE_SECURE=True,     # ×‘Ö¾HTTPS
)
```

* ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (×‘Ö¾`routes_auth.py`/helper ××—×¨):

```python
def require_roles(*roles):
    ...

def require_api_auth(roles=None):
    ...

def effective_business_id(arg="business_id"):
    bid = request.args.get(arg)
    if g.user["role"] not in ("admin","superadmin"):
        bid = g.user.get("business_id")
    return bid
```

* **×›×œ SELECT/UPSERT ×‘×¦×“ ×©×¨×ª**: ×× ×”××©×ª××© ××™× ×• Admin/Superadmin â€“ ××¡× × ×™× ×œ×¤×™ `business_id = g.user["business_id"]`.

---

# 1) ××¤×ª × ×™×ª×•×‘×™× (UI + API) â€” ×‘×œ×™ ×—×•×¨×™× ×•×œ×œ× 404

## UI (Jinja + HTMX) â€” `ui_bp`

* `/login`, `/forgot`, `/reset?token=...`, `/logout`
* `/` â†’ × ×™×ª×•×‘ ××•×˜×•××˜×™: `admin/superadmin` ×œÖ¾`/app/admin`, ××—×¨×ª ×œÖ¾`/app/biz`
* `/app/admin`  **(require\_roles: admin, superadmin)**
* `/app/biz`    **(require\_roles: admin, superadmin, manager, agent)**

### UI Partials (HTMX) â€” Admin

* `/ui/admin/overview` (KPIs, counters)
* `/ui/admin/tenants` (×˜×‘×œ×ª ×¢×¡×§×™×)
* `/ui/admin/tenants/new`, `/ui/admin/tenants/<id>/edit` (××•×“×œ×™×)
* `/ui/admin/users` (×˜×‘×œ×ª ××©×ª××©×™× ×›×œ×œÖ¾××¢×¨×›×ª)
* `/ui/admin/users/new`, `/ui/admin/users/<id>/edit` (××•×“×œ×™×)
* `/ui/admin/switch_business` (×‘×—×™×¨×ª ×¢×¡×§ ×¤×¢×™×œ ×œ××“××™×Ÿ, Redirect ×œÖ¾`/app/admin?business_id=...`)

### UI Partials (HTMX) â€” Business

* `/ui/whatsapp/threads`, `/ui/whatsapp/messages`, `/ui/whatsapp/send`
* `/ui/calls/active`, `/ui/calls/history`
* `/ui/biz/contacts`, `/ui/biz/contacts/new`, `/ui/biz/contacts/<id>/edit`
* `/ui/biz/users`, `/ui/biz/users/new`, `/ui/biz/users/<id>/edit`  *(Business Users)*

### UI Partials â€” Billing / Invoices / Contracts

* `/ui/billing/methods`, `/ui/billing/payments`
* `/ui/invoices/list`, `/ui/invoices/new`, `/ui/invoices/<id>/view`
* `/ui/contracts/list`, `/ui/contracts/new`, `/ui/contracts/<id>/sign`

> ×‘×›×œ Partial: ×”×—×–×¨ **HTML** ××•×›×Ÿ ×œ×¦×¨×™×‘×” (×˜×‘×œ×”/×›×¨×˜×™×¡×™×), ×œ× JSON â€” ×›×“×™ ×©Ö¾HTMX ×™×—×œ×™×£ ×¡×§×©×Ÿ ×‘×œ×™ ×¨×¢× ×•×Ÿ.

## API â€” Admin (`admin_bp`)

* **Tenants**:
  `GET /api/admin/tenants?q=&status=`
  `POST /api/admin/tenants` *(create)*
  `POST /api/admin/tenants/<id>/update`
  `POST /api/admin/tenants/<id>/toggle` *(pause/activate)*
* **Users (×›×œ×œ×™)**:
  `GET /api/admin/users?q=&business_id=&role=`
  `POST /api/admin/users` *(create)*
  `POST /api/admin/users/<id>/update` *(name/email/role/business/enabled)*

## API â€” Business (`biz_bp`)

* **Users (×œ×¢×¡×§)**:
  `GET /api/biz/users?business_id=`
  `POST /api/biz/users` *(manager/admin ×‘×œ×‘×“; role âˆˆ {agent,manager})*
  `POST /api/biz/users/<id>/update`
* **CRM**:
  `GET /api/crm/contacts?business_id=&q=`
  `POST /api/crm/contacts` Â· `POST /api/crm/contacts/<id>/update`
* **WhatsApp**:
  `GET /api/crm/threads?provider=twilio&channel=whatsapp&business_id=&q=`
  `GET /api/crm/messages?thread_id=`
  `POST /api/whatsapp/send {to,text,provider:'twilio'}` â†’ ×©×•××¨ CRM `out+sent`
* **Calls**:
  `GET /api/calls/active` Â· `GET /api/calls/history?q=`

## API â€” Billing / Invoices / Contracts (`billing_bp`)

* **Payments** (`/api/crm/payments/*`):

  * ×× PAYPAL\_\* ×—×¡×¨ â†’ **501/403** (×œ× 500)
  * ×× Tranzila ×œ× ××•×’×“×¨ â†’ **501**
  * Stripe ×”×™×©×Ÿ â†’ **410** ×‘×œ×‘×“ (×‘×œ×™ import stripe)
* **Invoices**:
  `GET /api/invoices?business_id=&q=`
  `POST /api/invoices` *(issue)*
  `GET /api/invoices/<id>` *(view)*
* **Contracts** (×—×ª×™××” ×“×™×’×™×˜×œ×™×ª):
  `GET /api/contracts?business_id=&q=`
  `POST /api/contracts` *(create: parties/items)*
  `POST /api/contracts/<id>/sign` *(××™×™×¦×¨ ×§×™×©×•×¨ ×—×ª×™××”/×©×•××¨ ×—×ª×™××”)*

> ×›×œ ×”Ö¾API ×¤×” ×™×—×–×™×¨ JSON; ×”Ö¾UI ×™×‘×§×© HTML ×“×¨×š `/ui/...` ×©××¨× ×“×¨ ×˜×‘×œ××•×ª/×›×¨×˜×™×¡×™× ××‘×•×¡×¡ JSON.

---

# 2) ×¡×™×™×“×‘×¨ ××ª×§×¤×œ (RTL) â€” ×¨×¡×¤×•× ×¡×™×‘×™, ×¢× ×¤×¢×•×œ×•×ª ×‘×¤× ×™×

×‘Ö¾`layout.html`:

* ×›×¤×ª×•×¨ â˜° ×‘××•×‘×™×™×œ ×¤×•×ª×— Drawer (×™××™×Ÿ). Overlay ×¡×•×’×¨. ×œ×—×™×¦×” ×¢×œ ×§×™×©×•×¨ â€” ×¡×•×’×¨×ª.
* ×¤×¨×™×˜×™× ×œ×¤×™ ×”×¨×©××•×ª:

  * **Admin/Superadmin**: â€œ×“×©×‘×•×¨×“â€, â€œ× ×™×”×•×œ ×¢×¡×§×™×â€, â€œ× ×™×”×•×œ ××©×ª××©×™×â€, â€œ×—×™×•×‘/×¡×œ×™×§×”â€, â€œ×—×©×‘×•× ×™×•×ªâ€, â€œ×—×•×–×™×â€.
  * **Business (Manager/Agent)**: â€œWhatsAppâ€, â€œ×©×™×—×•×ªâ€, â€œCRM ×œ×§×•×—×•×ªâ€, â€œ××©×ª××©×™× ×‘×¢×¡×§â€, â€œ×—×©×‘×•× ×™×•×ªâ€, â€œ×—×•×–×™×â€.
* **×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×‘×¡×™×™×“×‘×¨**:

  * Admin: `â• ×”×•×¡×£ ×¢×¡×§` â†’ `hx-get="/ui/admin/tenants/new"` â†’ ××•×“×œ
    `â• ××©×ª××©` â†’ `hx-get="/ui/admin/users/new"`
  * Business: `â• ××©×ª××©` â†’ `hx-get="/ui/biz/users/new?business_id={{ current_business_id }}"`
* **×‘×—×™×¨×ª ×¢×¡×§ ×œ××“××™×Ÿ** (Select): `hx-get="/ui/admin/switch_business"` â†’ redirect ×œÖ¾`/app/admin?business_id=...`
  â†’ ×›×œ ×”×˜×¢×™× ×•×ª/×§×™×©×•×¨×™× ×‘×¢××•×“ ××›×™×œ×™× ××ª ×”Ö¾`business_id` ×”× ×‘×—×¨.

**×—×•×‘×”**: ×›×œ ×“×£ ×©××¨×—×™×‘ `layout.html` ×©×•×œ×— ×œ×§×•× ×˜×§×¡×˜:

```python
role=g.user["role"]
current_user=g.user
active="biz_whatsapp"  # ××• admin_tenants ×•×›×•'
current_business_id=effective_business_id()
counters={"today_calls":0,"whatsapp_unread":0,"tenants_active":0,"users_pending":0,"biz_users_count":0}
```

---

# 3) ×“×£ ×× ×”×œ â€” ××‘× ×”, ×›×¤×ª×•×¨×™×, ×•××” ×‘×“×™×•×§ ×§×•×¨×”

## (A) Overview / KPIs

* ×‘×œ×•×§ ×¢×œ×™×•×Ÿ ×¢× ×§×œ×¤×™× (`today_calls`, `ws_errors`, `whatsapp_today`, `active_tenants`, ×¡×›×•××™ ×—×™×•×‘, ×—×•×–×™× ×××ª×™× ×™× ×—×ª×™××”).
* ×˜×¢×™× ×” ××•×˜×•â€™:
  `hx-get="/ui/admin/overview" hx-trigger="load, every 10s" hx-target="#kpis"`.
* ×›×¤×ª×•×¨ â€œğŸ”„ ×¨×¢× ×Ÿâ€ ×œ×™×“ ×”×›×•×ª×¨×ª: `hx-get` ×œ××•×ª×• ×™×¢×“.

## (B) × ×™×”×•×œ ×¢×¡×§×™× (Tenants)

* ×¢×œ×™×•×Ÿ: ×—×™×¤×•×© (`tq`), ×›×¤×ª×•×¨ `â• ×”×•×¡×£ ×¢×¡×§` (×’× ×‘×¡×™×™×“×‘×¨ ×•×’× ×‘×¨××© ×”××§×˜×¢).

* ×˜×‘×œ×” × ×˜×¢× ×ª:
  `hx-get="/ui/admin/tenants?q=&status=" hx-trigger="load, every 15s" hx-target="#tenantsTable"`.

* ×›×¤×ª×•×¨×™× ×‘×©×•×¨×”:

  * **×¢×¨×•×š** â†’ `hx-get="/ui/admin/tenants/<id>/edit"` (××•×“×œ)
  * **×”×©×”×”/×”×¤×¢×œ** â†’ `hx-post="/api/admin/tenants/<id>/toggle"` â†’ `hx-swap="none"` ×•××– JS `loadTenants()`
  * **×”×™×›× ×¡ ×›×¢×¡×§** (Impersonate/â€œ×”×©×ª×œ×˜×•×ªâ€) â†’ ×œ×™× ×§ `href="/app/biz?business_id=<id>"`

* ××•×“×œ×™×:
  **×—×“×©** â†’ `hx-post="/api/admin/tenants"` â†’ ××—×–×™×¨ ×˜×‘×œ×ª tenants ××œ××” â†’ `hx-target="#tenantsTable" hx-swap="outerHTML" hx-on::after-request="closeModal()"`
  **×¢×¨×•×š** â†’ `hx-post="/api/admin/tenants/<id>/update"` â†’ ××•×ª×• ×™×¢×“.

## (C) × ×™×”×•×œ ××©×ª××©×™× (×›×œ×œ×™)

* ×¢×œ×™×•×Ÿ: ×—×™×¤×•×© (`uq`), ×¡×œ×§×˜ `business_id` (×‘×”×ª×× ×œ×‘×—×™×¨×ª ×”××“××™×Ÿ), ×¡×œ×§×˜ ×ª×¤×§×™×“ (`role`).
* ×˜×‘×œ×”:
  `hx-get="/ui/admin/users?q=&business_id=&role=" hx-trigger="load, every 15s" hx-target="#usersTable"`.
* ×›×¤×ª×•×¨×™× ×‘×©×•×¨×”: **×¢×¨×•×š** â†’ `hx-get="/ui/admin/users/<id>/edit"`.
* ××•×“×œ â€œ××©×ª××© ×—×“×©â€: ×©×“×•×ª `name, email, role, business_id, enabled`.
  ×©××™×¨×”: `hx-post="/api/admin/users"` â†’ ×™×¢×“ `#usersTable` â†’ ×¡×’×™×¨×ª ××•×“×œ ××•×˜×•××˜×™×ª.

## (D) ×—×™×•×‘/×¡×œ×™×§×” + ×—×©×‘×•× ×™×•×ª + ×—×•×–×™×

* **×—×™×•×‘** (Payments): ×›×¨×˜×™×¡ ×©×™×˜×•×ª ×ª×©×œ×•× (PayPal/Tranzila/Stripe legacy).
  ××¦×‘ ××¤×ª×—×•×ª: ×× ×—×¡×¨â€”×”×¦×’ Badge â€œ×œ× ××•×’×“×¨â€ + ×¤×¢×•×œ×•×ª UI × ×—×¡××•×ª; ×”×§×¨×™××•×ª ×œÖ¾API ×™×—×–×™×¨×• ×‘×”×ª×× (501/403/410).
  ×¨×©×™××ª ×ª×©×œ×•××™× ××—×¨×•× ×™×: `hx-get="/ui/billing/payments?business_id="`.
* **×—×©×‘×•× ×™×•×ª**:
  ×›×¤×ª×•×¨ `â• ×—×©×‘×•× ×™×ª` â†’ ××•×“×œ `/ui/invoices/new` â†’ `POST /api/invoices` â†’ ××¦×™×’ ×‘×˜×‘×œ×ª ×—×©×‘×•× ×™×•×ª.
  ×›×¤×ª×•×¨ â€œ×¦×¤×™×™×”/PDFâ€ â†’ `/api/invoices/<id>` (××¤×©×¨ ×œ×¤×ª×•×— ×‘×—×œ×•×Ÿ).
* **×—×•×–×™× ×¢× ×—×ª×™××”**:
  `â• ×—×•×–×”` â†’ `/ui/contracts/new` â†’ `POST /api/contracts`.
  `×‘×§×© ×—×ª×™××”` â†’ `/api/contracts/<id>/sign` â†’ ×™×•×¦×¨ URL ×—×ª×™××” (××™×™×œ/SMS).
  ×”×¦×’ ××¦×‘ ×—×ª×™××” (Pending/Signed) + ×œ×™× ×§ ×¦×¤×™×™×”.

> ×›×œ ×”×¨×›×™×‘×™× ×”×œ×œ×• **××—×•×™×‘×™×** ×œ×”×©×ª××© ×‘Ö¾`business_id` ×”×¤×¢×™×œ (×¢×‘×•×¨ Admin) ××• ×©×œ ×”××©×ª××© (×¢×‘×•×¨ Business).

---

# 4) ×“×£ ×¢×¡×§ â€” ××‘× ×”, ×›×¤×ª×•×¨×™×, ×•××” ×§×•×¨×” ×‘×¤×•×¢×œ

## (A) WhatsApp

* **Threads**:
  `hx-get="/ui/whatsapp/threads?business_id={{ current_business_id }}&q=" hx-trigger="load, every 15s" hx-target="#threads"`.
* **Messages**: ×‘×œ×—×™×¦×” ×¢×œ thread â†’ `openThread(id,title,peer)`
  ×˜×•×¢×Ÿ: `hx-get="/ui/whatsapp/messages?thread_id=id" hx-target="#messages"`.
* **×©×œ×™×—×”**: ×˜×•×¤×¡ ×‘×ª×—×ª×™×ª: `POST /ui/whatsapp/send` â†’ ×‘×©×¨×ª: ×§×•×¨× `/api/whatsapp/send` ×•×©×•××¨ CRM `out+sent` â†’ ×¨×¢× ×•×Ÿ ×”×•×“×¢×•×ª.
* ×›×¤×ª×•×¨×™ ×¢×–×¨: â€œğŸ‘¤ ×¤×ª×— ×œ×§×•×—â€ (×§×™×©×•×¨ ×œÖ¾CRM ×¢× ×¤×™×œ×˜×¨ ×˜×œ×¤×•×Ÿ), â€œğŸ·ï¸ ×¡××Ÿ ×˜×•×¤×œâ€ (×ª×’ ×œÖ¾thread).

## (B) ×©×™×—×•×ª

* **×¤×¢×™×œ×•×ª**: `hx-get="/ui/calls/active" hx-trigger="load, every 5s" hx-target="#callsA"`.
* **×”×™×¡×˜×•×¨×™×”**: `hx-get="/ui/calls/history?q=" hx-trigger="load, every 10s" hx-target="#callsHB"`.
* ×›×¤×ª×•×¨ ×¨×¢× ×•×Ÿ ×‘×›×œ ××§×˜×¢.

## (C) CRM ×œ×§×•×—×•×ª

* ×˜×‘×œ×”: `GET /ui/biz/contacts?business_id=&q=` (Partial)
* â€œâ• ×œ×§×•×—â€ â†’ `/ui/biz/contacts/new` (××•×“×œ) â†’ `POST /api/crm/contacts` â†’ ×™×¢×“ ×”×˜×‘×œ×”.
* â€œ×¢×¨×•×šâ€ ×‘×©×•×¨×” â†’ `/ui/biz/contacts/<id>/edit` â†’ `POST /api/crm/contacts/<id>/update`.

## (D) ××©×ª××©×™× ×‘×¢×¡×§

* ×›×¨×˜×™×¡ Summary ×‘×¨××©: â€œ××©×ª××©×™× ×‘×¢×¡×§: Xâ€ + `â• ××©×ª××©`.
* ×˜×‘×œ×”: `GET /ui/biz/users?business_id=` (Partial).
* ×”×¨×©××•×ª:

  * **Manager** ×™×›×•×œ ×œ×™×¦×•×¨/×œ×¢×“×›×Ÿ `agent/manager` ×‘×œ×‘×“ (×œ× admin).
  * **Agent** â€” ×§×¨×™××” ×‘×œ×‘×“.
* ×©××™×¨×”: `POST /api/biz/users` / `POST /api/biz/users/<id>/update` â†’ ×™×¢×“ ×”×˜×‘×œ×”.

## (E) ×—×©×‘×•× ×™×•×ª ×•×—×•×–×™× (Business)

* ×›××• ×‘Ö¾Admin, ××š ××•×’×‘×œ×™× ×œÖ¾`business_id` ×©×œ ×”×¢×¡×§.
* ×× ××¤×ª×—×•×ª ×ª×©×œ×•× ×—×¡×¨×™× â€” UI ××¦×™×’ â€œ×œ× ××•×’×“×¨â€ ×•×”Ö¾API ××—×–×™×¨ 501/403 ×›××¦×•×¤×”.

---

# 5) ×¨×¡×¤×•× ×¡×™×‘×™×•×ª ×•×¡×™×™×“×‘×¨ ×‘××•×‘×™×™×œ

* **Drawer**: ×›×¤×ª×•×¨ â˜° ×¤×•×ª×—, overlay ×¡×•×’×¨, ×›×œ ×§×™×©×•×¨ ×¡×•×’×¨.
* **Safe-area**: `<meta name="viewport" content="..., viewport-fit=cover">` + `pb-[calc(env(safe-area-inset-bottom)+56px)]` ×œ×× ×™×¢×ª ×—×¤×™×¤×” ×¢× ×”××§×œ×“×ª.
* **× ×’×™×¢×•×ª UI**:

  * ×›×œ ×›×¤×ª×•×¨ `rounded-2xl`, `min-h-[44px]`.
  * ×˜×‘×œ××•×ª `text-sm`, `truncate` ××™×¤×” ×©×¦×¨×™×š.
  * Skeletons/Indicators: `hx-indicator` (××œ×× ×˜ ×¡×¤×™× ×¨ ×©××•×¤×™×¢ ××•×˜×•××˜×™×ª ×‘×–××Ÿ ×‘×§×©×”).

---

# 6) ×”×¨×©××•×ª â€” ×‘Ö¾UI ×•×‘Ö¾API

* UI: ×”×¡×ª×¨×ª ×¤×¨×™×˜×™×/×›×¤×ª×•×¨×™× ×œ×¤×™ `role`.
* API:

  * `@require_api_auth([...])` ×‘×›×œ endpoint.
  * **×›×¤×™×™×ª** `business_id` ×›×©×œ× ××“×•×‘×¨ ×‘Ö¾Admin/Superadmin:

    ```python
    bid = request.args.get("business_id") or request.form.get("business_id")
    if g.user["role"] not in ("admin","superadmin"):
        bid = g.user["business_id"]
    ```
* Business Users: ×× `g.user.role == "manager"` ××¡×•×¨ ×œ×”×¢×œ×•×ª ×ª×¤×§×™×“ ×œÖ¾`admin`.

---

# 7) ×˜×¢×™× ×” ××—×“×©, ×©×’×™××•×ª, ×•×¨×¢× ×•×Ÿ

* ×¨×©×™××•×ª (WA/Calls/Users/Contacts): `hx-trigger="load, every 10-15s"`.
* ×©×’×™××•×ª API (401/403/5xx): ×”×—×–×¨ HTML ×§×˜×Ÿ ×¢× ×”×•×“×¢×ª ×©×’×™××”; ××œ ×ª×—×–×™×¨ JSON ×œÖ¾UI partial.
* ××—×¨×™ POST ××•×¦×œ×— (×™×¦×™×¨×”/×¢×“×›×•×Ÿ): ×”×—×–×¨ **HTML ××œ× ×©×œ ×”×˜×‘×œ×”** â†’ `hx-target` + `hx-swap="outerHTML"` â†’ `hx-on::after-request="closeModal()"`.

---

# 8) ×—×™×•×‘/×¡×œ×™×§×” â€” ×›×œ×œ×™ ×‘×¨×–×œ (×œ× ×œ×©×‘×•×¨)

* `/api/crm/payments/*`:

  * PAYPAL\_\* ×—×¡×¨ â†’ **501/403** (××™× ×“×™×§×¦×™×” ×‘×¨×•×¨×” ×‘Ö¾UI: Badge â€œ×œ× ××•×’×“×¨â€)
  * Tranzila ×—×¡×¨ â†’ **501**
  * Stripe legacy â†’ **410** ×‘×œ×‘×“ (×”×¦×’ â€œ×œ× × ×ª××šâ€)
* ×‘×—×©×‘×•× ×™×•×ª/×—×•×–×™× â€” ×”×™×× ×¢ ×Ö¾500; ×ª× ×¢×œ ××™× ×¤×•×˜×™× ×× ××™× ×˜×’×¨×¦×™×” ×œ× ××•×’×“×¨×ª.

---

# 9) GO/NO-GO (×¦â€™×§Ö¾×œ×™×¡×˜ ×§×¦×¨)

* ×”×ª×—×‘×¨×•×ª ×•× ×™×ª×•×‘ ×œ×¤×™ Role ×¢×•×‘×“×™×.
* ×¡×™×™×“×‘×¨:

  * ×‘××•×‘×™×™×œ × ×¤×ª×—/× ×¡×’×¨; ×‘Ö¾Desktop ×§×‘×•×¢; ×¤×¨×™×˜×™× ×œ×¤×™ Role.
  * ×›×¤×ª×•×¨×™ â€œâ• ×”×•×¡×£ ×¢×¡×§/××©×ª××©â€ ×¤×•×ª×—×™× ××•×“×œ; ×©××™×¨×” ××¨×¢× × ×ª ×˜×‘×œ××•×ª.
* Admin:

  * Tenants: ×—×™×¤×•×©, new/edit/toggle, Impersonate.
  * Users: ×—×™×¤×•×©/×¡×™× ×•×Ÿ, new/edit (×›×•×œ×œ ×©×™× ×•×™ business/role).
  * Billing/Invoices/Contracts × ×˜×¢× ×™× ×•××¦×™×’×™× ×¡×˜×˜×•×¡ ××™× ×˜×’×¨×¦×™×•×ª × ×›×•×Ÿ.
* Business:

  * WhatsApp: threads/messages × ×˜×¢× ×™×; ×©×œ×™×—×” × ×¨×©××ª ×‘Ö¾CRM.
  * Calls: active/history × ×˜×¢× ×™×.
  * CRM: ×™×¦×™×¨×”/×¢×¨×™×›×” ×¢×•×‘×“×•×ª.
  * Users: Manager ×™×•×¦×¨/×¢×•×¨×š; Agent ×¨×•××” ×‘×œ×‘×“.
* ××™×Ÿ 404/405 ×‘×©×•× ×›×¤×ª×•×¨/partial; ××™×Ÿ 500 ×‘Ö¾payments ×›×©××™×Ÿ ××¤×ª×—×•×ª.

---

## ××™×§×¨×•Ö¾×“×•×’×××•×ª (×œ×”×‘×˜×™×— â€œ×›×œ ×›×¤×ª×•×¨ ×¢×•×‘×“â€)

**×›×¤×ª×•×¨ â€œâ• ××©×ª××© (Admin)â€ ×‘×¡×™×™×“×‘×¨/×›×•×ª×¨×ª:**

```html
<button class="btn-primary"
        hx-get="/ui/admin/users/new"
        hx-target="#modal" hx-swap="innerHTML">â• ××©×ª××©</button>
<div id="modal"></div>
```

**×˜×•×¤×¡ ××•×“×œ â€” ×©××™×¨×” ××—×œ×™×¤×” ×˜×‘×œ×” ×•×¡×•×’×¨×ª ××•×“×œ:**

```html
<form hx-post="/api/admin/users"
      hx-target="#usersTable"
      hx-swap="outerHTML"
      hx-on::after-request="closeModal()">
  <!-- fields... -->
  <button class="btn-primary">×©××•×¨</button>
</form>
```

**×˜×¢×™× ×ª ×˜×‘×œ×ª ××©×ª××©×™× ×¢× ×¡×™× ×•×Ÿ ×¢×¡×§ (Admin):**

```js
function loadUsersAdmin(){
  const q = document.getElementById('uq').value||'';
  const sel = document.getElementById('bizSelect');
  const u = new URL('/ui/admin/users', location.origin);
  u.searchParams.set('q', q);
  if(sel && sel.value) u.searchParams.set('business_id', sel.value);
  htmx.ajax('GET', u, { target:'#usersTable', swap:'innerHTML' });
}
```

---

×–×” ×”×›×œ. ×ª×Ÿ ×œ×‘×•×˜ ×œ×”×™×¦××“ **×‘×•×œ** ×œ××¤×¨×˜ ×”×–×”: ××•×ª× × ×™×ª×•×‘×™×, ××•×ª× partials/××•×“×œ×™× ×¢× HTMX, ××•×ª×” ×œ×•×’×™×§×ª ×”×¨×©××•×ª ×•××›×™×¤×ª `business_id`. ×›×›×” ×’× ×”×× ×”×œ ×™×§×‘×œ **×©×œ×™×˜×” ××œ××”** (×¢×¡×§×™×/××©×ª××©×™×/×—×™×•×‘/××¡××›×™×), ×•×’× ×”×¢×¡×§ ×™×§×‘×œ **×›×œ×™× × ×§×™×™×** (×•×•×˜×¡××¤/×©×™×—×•×ª/CRM/××©×ª××©×™ ×¢×¡×§), ×‘×××©×§ **××”×™×¨, ×¨×¡×¤×•× ×¡×™×‘×™ ×•× ×¨××” ××§×¦×•×¢×™**.
