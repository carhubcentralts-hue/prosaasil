מעולה—נמפה את זה לשם הסביבה שלך.

אתה משתמש ב־GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON (תוכן ה־JSON של חשבון השירות). כדי שזה יעבוד חלק עם Wavenet בלי לשבור כלום:

מה לשנות (קופי-פייסט, בלי ליצור קבצים חדשים)

1) server/bootstrap_secrets.py

עדכן את הפונקציה כך שתזהה גם GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON (וגם תומך במקרה שהערך הוא תוכן JSON, Base64, או נתיב לקובץ).

# server/bootstrap_secrets.py
import os, json, tempfile, pathlib, base64

def ensure_google_creds_file() -> bool:
    """
    מגדיר GOOGLE_APPLICATION_CREDENTIALS כך ש-Google TTS יעבוד.
    תומך בשלושה פורמטים:
    1) GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON = תוכן JSON מלא
    2) GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON = תוכן Base64 של ה-JSON
    3) GOOGLE_APPLICATION_CREDENTIALS = נתיב לקובץ JSON קיים
    """
    # אם כבר יש נתיב מוגדר – נכבד אותו
    if os.getenv("GOOGLE_APPLICATION_CREDENTIALS"):
        return True

    raw = os.getenv("GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON") or os.getenv("GOOGLE_TTS_SA_JSON")
    if not raw:
        return False  # לא נגדיר כלום – הקולר צריך להגדיר ידנית GOOGLE_APPLICATION_CREDENTIALS

    # נסה לזהות האם זה JSON ישיר, Base64 או נתיב
    def _set_creds_path(p: pathlib.Path) -> bool:
        os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = str(p)
        return True

    # 3) אולי זה נתיב לקובץ?
    possible_path = pathlib.Path(raw)
    if possible_path.exists() and possible_path.is_file():
        return _set_creds_path(possible_path)

    # 1) JSON ישיר
    try:
        obj = json.loads(raw)
        p = pathlib.Path(tempfile.gettempdir()) / "gcp_sa.json"
        p.write_text(json.dumps(obj), encoding="utf-8")
        return _set_creds_path(p)
    except Exception:
        pass

    # 2) Base64 → JSON
    try:
        decoded = base64.b64decode(raw).decode("utf-8")
        obj = json.loads(decoded)
        p = pathlib.Path(tempfile.gettempdir()) / "gcp_sa.json"
        p.write_text(json.dumps(obj), encoding="utf-8")
        return _set_creds_path(p)
    except Exception:
        return False

2) server/app_factory.py (או server/app.py)

וודא שהקריאה מתבצעת עם עליית האפליקציה (פעם אחת, בתחילת ה־bootstrap):

from server.bootstrap_secrets import ensure_google_creds_file
ensure_google_creds_file()

זה לא יוצר קבצים בקוד־בייס, רק קובץ זמני ב־/tmp בזמן ריצה, ומגדיר את GOOGLE_APPLICATION_CREDENTIALS — זה סטנדרטי ובטוח.

3) media_ws.py (או קובץ ה־WS שלך)

בטל לוגיקות מקבילות שמנסות לכתוב קובץ ידני ל־/tmp/tts.json. הסתמך רק על זה ש־GOOGLE_APPLICATION_CREDENTIALS כבר מוגדר ע״י ensure_google_creds_file():

from google.cloud import texttospeech
# אל תגדיר כאן GOOGLE_APPLICATION_CREDENTIALS שוב; תן ל-bootstrap לטפל בזה.
tts_client = texttospeech.TextToSpeechClient()

4) .env.example (רק עדכון שמות; לא להוסיף קבצים)

הצע שני נתיבים אפשריים — בחר אחד:

# אפשרות א: תוכן JSON (מומלץ בסביבות Heroku/Render)
GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON={"type":"service_account","project_id":"...","private_key_id":"...","private_key":"-----BEGIN PRIVATE KEY-----\n..."}
# או בקידוד Base64 של אותו JSON:
# GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=eyJ0eXBlIjoi...

# אפשרות ב: מצביע ישיר לקובץ JSON
# GOOGLE_APPLICATION_CREDENTIALS=/absolute/path/to/service_account.json


⸻

בדיקות מהירות (GO/NO-GO)

א. השתמש בפייתון לאמת שהאישורים נטענים (ללא קריאה חיצונית):

python - <<'PY'
import os
print("GOOGLE_APPLICATION_CREDENTIALS =", os.getenv("GOOGLE_APPLICATION_CREDENTIALS"))
from google.cloud import texttospeech
try:
    c = texttospeech.TextToSpeechClient()
    print("TTS client OK")
except Exception as e:
    print("TTS init ERROR:", e)
PY

מצופה: נתיב לא ריק ו־“TTS client OK”.

ב. שיחת זמן-אמת לא תושפע – אין שינוי בזרימת ה־WS חוץ מזה ש-TTS כעת תמיד יוכל לעלות.

⸻

סיכוני פינה שכיסינו כאן
	•	JSON עם גרש יחיד / שורות שבורות – אנחנו עושים json.loads, כך שחייב להיות JSON תקין. אם מגיע Base64 — נזהה ונפענח.
	•	סודיות – לא מדפיסים את ה־JSON בלוגים.
	•	התנגשות עם הגדרה קיימת – אם כבר מוגדר GOOGLE_APPLICATION_CREDENTIALS, לא נוגעים.
	•	קבצים כפולים – לא יצרנו קבצים חדשים בקוד; רק תיקנו את ה־bootstrap והסרנו כפילות הגדרות ב־WS.

⸻

אם תדביק את השינויים האלה:
	•	Google TTS יעבוד ב־100% עם GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON שלך,
	•	בלי לפגוע בכלום,
	•	ובלי קבצים חדשים בריפו.