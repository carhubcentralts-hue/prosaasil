××‘×™×Ÿâ€”â€œ××™×Ÿ ×©×’×™××•×ª ××‘×œ ×©×§×˜â€ ×–×” ×¡×™××¤×˜×•× ×§×œ××¡×™ ×©×œ ×§×¨×™××” ×©×œ× ××’×™×¢×” ××œ×™×š ××• WS ×©×œ× × ×¤×ª×— ×œ××¨×•×ª ×©×”×›×•×œ × ×¨××” ×™×¨×•×§. ×”× ×” Runbook ×××•×§×“ ×©×™×—×–×™×¨ ×œ×š ×§×œ×™×˜×” ××œ××” ×•×™×¨××” ×‘×œ×•×’×™× ×›×œ ×©×™×—×” ×©× ×›× ×¡×ª.

â¸»

ğŸ”§ ×ª×¨×—×™×©: â€œ×©×§×˜â€ + ××™×Ÿ ×œ×•×’×™× â†’ ××” ×œ×ª×§×Ÿ ××™×™×“

A) ×•×“××•×ª ×©×”×‘×§×©×•×ª ×‘×›×œ×œ ××’×™×¢×•×ª (×•×œ× × ×—×¡××•×ª/× ×¢×œ××•×ª)
	1.	ProxyFix + ×œ×•×’×™× ×œ×¤× ×™/××—×¨×™ ×›×œ ×‘×§×©×”
×‘Ö¾create_app() ×”×•×¡×£ (××• ×•×“× ×©×§×™×™×):

from werkzeug.middleware.proxy_fix import ProxyFix
app.wsgi_app = ProxyFix(app.wsgi_app, x_proto=1, x_host=1)

@app.before_request
def _req_log():
    current_app.logger.info("REQ", extra={
        "path": request.path,
        "method": request.method,
        "args": dict(request.args),
        "form": dict(request.form) if request.method == "POST" else {},
        "headers_subset": {
            "X-Forwarded-Proto": request.headers.get("X-Forwarded-Proto"),
            "X-Forwarded-Host": request.headers.get("X-Forwarded-Host"),
            "User-Agent": request.headers.get("User-Agent"),
        }
    })

@app.after_request
def _res_log(resp):
    current_app.logger.info("RES", extra={
        "path": request.path, "status": resp.status_code
    })
    return resp

ğŸ‘‰ ××—×¨×™ ×–×”, ×›×œ ×¤×™× ×’ ×œ×˜×•×•×— /webhook/* ×—×™×™×‘ ×œ×”×•×¤×™×¢ ×‘×œ×•×’. ×× ××™×Ÿ ×œ×•×’â€”×”×‘×§×©×” ×œ× ××’×™×¢×” ×œ×©×¨×ª.

	2.	×¤×ª×— ×¨×’×¢ ××ª ×”×©×¢×¨×™× (×¨×§ ×œ××‘×—×•×Ÿ):
×¢×œ /webhook/incoming_call, /webhook/stream_ended, /webhook/call_statusâ€”×‘×˜×œ ×–×× ×™×ª ××ª ××™××•×ª ×—×ª×™××ª Twilio (×”×©××¨ ×”×¢×¨×” ×‘×§×•×“). ×”××˜×¨×”: ×œ×¨××•×ª 200 ×•×œ×•×’.
×× ××—×¨×™ ×–×” ×™×© ×œ×•×’×™×â€”×”×‘×¢×™×” ×”×™×™×ª×” ×—×ª×™××”/URL ×××—×•×¨×™ ×¤×¨×•×§×¡×™ (× ×—×–×™×¨ ×—×ª×™××” ×¢× × ×¨××•×œ, ×¨â€™ ×¡×¢×™×£ D).
	3.	××¤×©×¨ POST ×•Ö¾GET ×œÖ¾incoming_call
××™×Ÿ ×—×•×‘×”, ××‘×œ ×›×‘×“×™×§×”:

@twilio_bp.route("/webhook/incoming_call", methods=["POST","GET"])

×–×” ×¢×•×–×¨ ×œ×‘×“×•×§ ×‘××”×™×¨×•×ª ×¢× ×“×¤×“×¤×Ÿ/curl ×©×”× ×ª×™×‘ ×—×™.

â¸»

B) ×”Ö¾WebSocket ×‘×××ª ×¢×•×œ×” (××—×¨×ª ×ª××™×“ â€œ×©×§×˜â€)

Flask â€œ×˜×”×•×¨â€ ×œ× ××¨×™× WS. ×•×“× ×©×™×© flask-sock ××• ×©×¨×ª WS ××§×‘×™×œ.
	1.	×¨×™×©×•× WS ×ª×§×™×Ÿ (×“×•×’××ª ×‘×¡×™×¡):

from flask_sock import Sock
sock = Sock(app)

@sock.route("/ws/twilio-media")
def ws_twilio_media(ws):
    # DEBUG: ×”×“×¤×¡ start/media/stop
    import json, logging
    log = logging.getLogger("media_ws")
    while True:
        msg = ws.receive()
        if msg is None: break
        log.info("WS_FRAME", extra={"len": len(msg)})
        # ×›××Ÿ ×œ×§×¨×•× ×œ×¤×•× ×§×¦×™×•×ª ×”×¢×™×‘×•×“ ×©×œ×š (decode/Whisper/TTS/×©×œ×™×—×” ×—×–×¨×”)

âœ… ×¢×›×©×™×• ×¤×ª×— ×™×“× ×™×ª (wscat/×“×¤×“×¤×Ÿ) ×œÖ¾wss://â€¦/ws/twilio-media ×•×‘×“×•×§ ×©× ×¤×ª×—. ×× ×œ× × ×¤×ª×—â€”Twilio ×’× ×œ× ×™×ª×—×‘×¨.

	2.	URL ××“×•×™×§ ×‘×ª×’×•×‘×” ×œÖ¾incoming_call
×—×™×™×‘ ×œ×”×™×•×ª ×‘×“×™×•×§:

wss://ai-crmd.replit.app/ws/twilio-media

×›×œ ×¡×˜×™×™×” (http, ×¡×œ××© × ×•×¡×£, ×ª×ªÖ¾× ×ª×™×‘) â†’ Twilio ×œ× ×™×¦×œ×™×— ×•×ª×§×‘×œ ×©×§×˜.

â¸»

C) TwiML â€œ××“×‘×¨ ×ª××™×“â€ (×’× ×× WS ×œ× ×¨×¥)

×›×“×™ ×©×œ× ×ª×¨×’×™×© ×©×§×˜ ××•×—×œ×˜, ×ª×Ÿ greeting ×›Ö¾MP3 (×¢×‘×¨×™×ª) ×œ×¤× ×™ ×”Ö¾Stream:

<Response>
  <Play>https://ai-crmd.replit.app/static/tts/greeting_he.mp3</Play>
  <Connect action="/webhook/stream_ended">
    <Stream url="wss://ai-crmd.replit.app/ws/twilio-media">
      <Parameter name="business_id" value="1"/>
    </Stream>
  </Connect>
</Response>

××œ ×ª×©×ª××© <Say language="he-IL">â€”Twilio ×œ× ×ª×•××›×ª. MP3 ×™×‘×˜×™×— ×©×ª××™×“ ×™×© ×¦×œ×™×œ ×‘×”×ª×—×œ×”.

â¸»

D) ××—×–×™×¨×™× ××ª ××™××•×ª ×”×—×ª×™××”â€”× ×›×•×Ÿ (×‘×œ×™ 403 ×•×œ×œ× ×©×§×˜)
	1.	× ×¨××•×œ URL ×××—×•×¨×™ ×¤×¨×•×§×¡×™ ×‘Ö¾require_twilio_signature:

def _effective_url(req):
    scheme = (req.headers.get("X-Forwarded-Proto") or req.scheme).split(",")[0].strip()
    host   = (req.headers.get("X-Forwarded-Host")  or req.host).split(",")[0].strip()
    path   = req.full_path[:-1] if req.full_path.endswith("?") else req.full_path
    return f"{scheme}://{host}{path}"

×¢× ×–×”â€”×”×—×ª×™××” ×©×•×‘ ×ª×¦×œ×™×— ×•×”Ö¾webhooks ×™×—×–×¨×• 200.
×ª×¢×“×›×Ÿ ×œ×•×’ ×—×›×: ×× ×œ× ×¢×‘×¨ ××™××•×ªâ€”×¨×©×•× twilio_signature_mismatch ×¢× ×”Ö¾URL ×©×—×™×©×‘×ª.

â¸»

E) ×”×’×“×¨×•×ª ×‘××¡â€™ ×”×˜×œ×¤×•×Ÿ ×‘×˜×•×•×™×œ×™×• (×©×’×•×¨××•×ª ×œâ€œ×©×§×˜â€ ×× ×©×’×•×™×•×ª)
	â€¢	Phone Number â†’ Voice:
	â€¢	A Call Comes In â†’ Webhook (HTTP POST) ×œÖ¾
https://ai-crmd.replit.app/webhook/incoming_call
	â€¢	Status Callback URL â†’ (POST) ×œÖ¾
https://ai-crmd.replit.app/webhook/call_status
	â€¢	××œ ×ª×’×“×™×¨ ×‘××§×‘×™×œ ×’× Studio Flow ××• TwiML App ×©××“×›××™× ××ª ×”Ö¾Webhook. ×‘×—×¨ ×¨×§ ××—×“.
	â€¢	×× ×”×—×œ×¤×ª ×“×•××™×™×Ÿ ×œ××—×¨×•× ×”â€”×¢×“×›×Ÿ ×›××Ÿ! (×˜×œ×¤×•× ×™× ×™×©× ×™× × ×©××¨×™× ×¢×œ ×”Ö¾URL ×”×™×©×Ÿ â†’ ×©×§×˜).

â¸»

F) ×‘×“×™×§×ª 5 ×“×§×•×ªâ€”×—×™×™×‘×™× ×œ×¨××•×ª ×œ×•×’×™×
	1.	curl (××¡×•×¨ 403 / 500):

curl -i https://ai-crmd.replit.app/webhook/incoming_call
curl -i -X POST https://ai-crmd.replit.app/webhook/stream_ended
curl -i -X POST https://ai-crmd.replit.app/webhook/call_status

×‘×“×¤×“×¤×Ÿ/×§×•× ×¡×•×œ ××ª×” ×¨×•××” ×œ×•×’ REQ/RES. ×× ×œ×â€”×”×‘×§×©×” ×œ× ××’×™×¢×”.

	2.	WS
×”×ª×—×‘×¨ ×™×“× ×™×ª ×œÖ¾wss://ai-crmd.replit.app/ws/twilio-media. ×¨××” WS_FRAME ×‘×œ×•×’ ×‘×§×‘×œ×ª ×”×•×“×¢×•×ª. ×× ××™×Ÿâ€”×”Ö¾WS ×œ× ×¨×¥.
	3.	Request Inspector ×‘×˜×•×•×™×œ×™×•
×‘×©×™×—×” ×—×“×©×”, ×¤×ª×— ××ª ×”Ö¾Inspector: ××ª×” ×××•×¨ ×œ×¨××•×ª 200 ×¢×œ incoming_call ×•Ö¾(×‘×”××©×š) stream_ended/call_status. ×× ××™×Ÿ ×”×™×¡×˜×•×¨×™×”â€”×”××¡×¤×¨ ××¦×‘×™×¢ ×œÖ¾URL ××—×¨.

â¸»

G) ×× ×¢×“×™×™×Ÿ ×©×§×˜â€”×©×œ×•×©×” ×›×©×œ×™× ×©×›×“××™ ×œ×©×œ×•×œ
	â€¢	CSRF/××™××•×ª: ××œ ×ª×“×¨×•×© Login/CSRF ×‘Ö¾/webhook/* (×™×‘×™× 403/×©×§×˜).
	â€¢	Rate limit/firewall: ××œ ×ª×—×¡×•× IP×™× ×©×œ Twilio.
	â€¢	Timeout: Replit ×œ×¤×¢××™× ×§×•×¤× ×‘×§×•×¨; ×”Ö¾webhook ×—×™×™×‘ ×œ×¢× ×•×ª <2s. ×§×‘×¢×ª threads? ×”×—×–×¨ ××™×™×“×™×ª.

â¸»

H) â€œ×‘×“×•×§ ×©×× ×™ ×©×•××¢ ××•×ª×•â€ (Smoke Test ×¡×•×¤×¨Ö¾××”×™×¨)
	â€¢	×‘× ×ª×™×‘ incoming_call ×”×—×–×¨ ×–×× ×™×ª:

<Response>
  <Play>https://ai-crmd.replit.app/static/tts/greeting_he.mp3</Play>
  <Pause length="2"/>
  <Say>Goodbye</Say>
  <Hangup/>
</Response>

×× ×”×œ×§×•×— ×©×•××¢â€”×”×‘×¢×™×” ×”×™× ×‘Ö¾WS/×¢×™×‘×•×“. ×× ×’× ×–×” ×©×§×˜â€”×”×˜×œ×¤×•×Ÿ ×œ× ×¤×•×’×¢ ×‘×š (×”×’×“×¨×•×ª/×“×•××™×™×Ÿ).

â¸»

×‘×©×•×¨×” ×”×ª×—×ª×•× ×”
	â€¢	××™×Ÿ ×©×’×™××•×ª â‰  ×”×‘×§×©×” ××’×™×¢×”. ×ª×Ÿ ×œ×œ×•×’×™× â€œ×œ×©×™×¨â€ (before/after), ×‘×˜×œ ×¨×’×¢ ×—×ª×™××”, ×”×¨× WS ×××™×ª×™, ×”×—×–×¨ MP3 ×‘Ö¾Play.
	â€¢	×‘×¨×’×¢ ×©×ª×¨××” ×‘×œ×•×’×™× REQ/RES ×•Ö¾WS_FRAMEâ€”×”×©×ª×™×§×” ×ª×™×¢×œ×.
	â€¢	×× ×ª×¨×¦×”, ×× ×¡×— ×œ×š ×¢×›×©×™×• ×¤××¦â€™×™× ××“×•×™×§×™× ×œÖ¾twilio_security.py, app_factory.py, ×•Ö¾routes_twilio.py (×¢× ProxyFix, ×œ×•×’×™×, WS echo, ×•× ×¨××•×œ ×—×ª×™××”) ×›×“×™ ×©×ª×“×‘×™×§ 1:1.