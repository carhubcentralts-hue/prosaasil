×”× ×” ×”× ×—×™×” ×¡×’×•×¨×” ×œ×¡×•×›×Ÿ/××¤×ª×— ×©×œ×š â€” **×œ×‘×¦×¢ ×”×›×•×œ** ×›×“×™ ×©Ö¾AgentLocator v39 ×™×”×™×” ×‘×¨××ª SaaS ×¤×¨×•, ×•×™×–×•××œ×™×ª ×•×ª×¤×¢×•×œ×™×ª. ×”×¢×ª×§/×”×“×‘×§ ×›××¡××š ××©×™××” ××—×“.

---

# âœ… ×”×•×¨××ª ×¢×‘×•×“×”: Polish ××œ× ×œÖ¾AgentLocator v39

> ×‘×¦×¢ ×œ×¤×™ ×”×¡×“×¨. ××œ ×ª×¡××Ÿ "×‘×•×¦×¢" ×¢×“ ×©×›×œ ×¡×¢×™×£ ××•×›×— ×‘×‘×“×™×§×”.

## 0) ×”×›× ×”

* ×¦×•×¨ ×¢× ×£: `git checkout -b polish/v39-full`
* ×”×ª×§×Ÿ ×ª×œ×•×™×•×ª: `pip install -r requirements.txt && npm i --prefix client`
* ×”×¨×¥ ×‘×“×™×§×•×ª ×§×™×™××•×ª ×›×‘×¡×™×¡: `pytest -q` + `npm test --prefix client` (×× ×™×©)

---

## 1) ×¨×™×©×•× Blueprint ××¨×•×›×– (Server)

**×¦×•×¨** `server/routes/__init__.py`:

```python
def register_blueprints(app):
    from ..api_crm_advanced import crm_bp
    from ..api_whatsapp_advanced import whatsapp_bp
    from ..api_tasks import tasks_bp
    from ..api_notifications import notifications_bp
    from ..api_contracts import contracts_bp
    from ..api_invoices import invoices_bp
    from ..api_signatures import signatures_bp
    from ..api_stats import stats_bp
    from ..api_timeline import timeline_bp      # ×™×™×‘× ×” ×‘×¡×¢×™×£ 4
    from ..routes_twilio import twilio_bp

    app.register_blueprint(crm_bp)
    app.register_blueprint(whatsapp_bp)
    app.register_blueprint(tasks_bp)
    app.register_blueprint(notifications_bp)
    app.register_blueprint(contracts_bp)
    app.register_blueprint(invoices_bp)
    app.register_blueprint(signatures_bp)
    app.register_blueprint(stats_bp)
    app.register_blueprint(timeline_bp)
    app.register_blueprint(twilio_bp)
```

×‘Ö¾`server/app_factory.py` ×•×“×:

```python
from .routes import register_blueprints
from .error_handlers import register_error_handlers
from .logging_setup import setup_logging

def create_app(env='development'):
    ...
    register_blueprints(app)
    register_error_handlers(app)
    setup_logging(app)
    return app
```

---

## 2) Error Handlers + Logging (Production)

**×¦×•×¨** `server/error_handlers.py`:

```python
from flask import jsonify

def register_error_handlers(app):
    @app.errorhandler(404)
    def not_found(e):
        return jsonify({"error":"not_found"}), 404

    @app.errorhandler(500)
    def internal(e):
        app.logger.exception("Unhandled server error")
        return jsonify({"error":"server_error"}), 500
```

**×¦×•×¨** `server/logging_setup.py`:

```python
import logging, json, os

class JsonFormatter(logging.Formatter):
    def format(self, record):
        return json.dumps({"lvl":record.levelname,"msg":record.getMessage(),"name":record.name}, ensure_ascii=False)

def setup_logging(app):
    h = logging.StreamHandler()
    if os.getenv("FLASK_ENV") == "production":
        h.setFormatter(JsonFormatter()); app.logger.setLevel(logging.INFO)
    else:
        app.logger.setLevel(logging.DEBUG)
    app.logger.addHandler(h)
```

---

## 3) ×ª×™×§×•×Ÿ ×‘××’ ×“×¤×“×•×£ ×‘Ö¾CRM

×‘Ö¾`server/api_crm_advanced.py` â€” **×—×¤×© ×•×”×—×œ×£** ×›×œ ××•×¤×¢ ×©×œ:

* `customers_paginate` âœ `customers_paginated`
* ×ª×¨×™×¥ ×‘×“×™×§×” ×™×“× ×™×ª ×¢×œ `GET /api/crm/customers?limit=25&page=1` ×•×•×“× 200 + ×¤××’×³×™× ×¦×™×” ×ª×§×™× ×”.

---

## 4) Timeline ×××•×—×“ (COM)

**×¦×•×¨** `server/api_timeline.py`:

```python
from flask import Blueprint, request, jsonify
from .models import db, CallLog, WhatsAppMessage, Task, Contract, Invoice  # ×•×“× ×©××•×ª ××•×“×œ×™× ×§×™×™××™×
from sqlalchemy import desc

timeline_bp = Blueprint("timeline_bp", __name__, url_prefix="/api")

@timeline_bp.get("/customers/<int:customer_id>/timeline")
def customer_timeline(customer_id):
    limit = min(int(request.args.get("limit", 100)), 500)
    items = []

    # ××©×•×š ×›×œ ××§×•×¨ ××™×¨×•×¢×™×; ×× ×˜×‘×œ×” ×—×¡×¨×” â€” ×“×œ×’
    try:
        items += [{"kind":"call","ts":c.created_at,"ref":c.call_sid,"meta":{"duration":c.duration}} 
                  for c in CallLog.query.filter_by(customer_id=customer_id).order_by(desc(CallLog.created_at)).limit(limit)]
    except Exception: pass
    try:
        items += [{"kind":"whatsapp","ts":m.created_at,"ref":m.id,"meta":{"direction":m.direction,"status":m.status}} 
                  for m in WhatsAppMessage.query.filter_by(customer_id=customer_id).order_by(desc(WhatsAppMessage.created_at)).limit(limit)]
    except Exception: pass
    try:
        items += [{"kind":"task","ts":t.created_at,"ref":t.id,"meta":{"title":t.title,"due_at":t.due_at,"status":t.status}}
                  for t in Task.query.filter_by(customer_id=customer_id).order_by(desc(Task.created_at)).limit(limit)]
    except Exception: pass
    try:
        items += [{"kind":"contract","ts":c.created_at,"ref":c.id,"meta":{"status":c.status}}
                  for c in Contract.query.filter_by(customer_id=customer_id).order_by(desc(Contract.created_at)).limit(limit)]
    except Exception: pass
    try:
        items += [{"kind":"invoice","ts":i.created_at,"ref":i.id,"meta":{"status":i.status,"amount":i.amount}}
                  for i in Invoice.query.filter_by(customer_id=customer_id).order_by(desc(Invoice.created_at)).limit(limit)]
    except Exception: pass

    items = sorted(items, key=lambda x: x["ts"], reverse=True)[:limit]
    return jsonify({"items": items})
```

---

## 5) Twilio â€” ×©×œ×•×©×ª ×”Ö¾Webhook×™× ×—×•×‘×”

×‘Ö¾`server/routes_twilio.py` ×•×“× ×©×§×™×™××™× ×•×¤×¢×™×œ×™×:

```python
@twilio_bp.post("/webhook/incoming_call")
def incoming_call():
    # TwiML: Play greeting + Record
    # finishOnKey="*" , timeout="5" , maxLength="30"
    ...

@twilio_bp.post("/webhook/handle_recording")
def handle_recording():
    # ×”×•×¨×“×”, ×‘×“×™×§×ª ××•×¨×š, Whisper, GPT, ×©××™×¨×”
    # ×× ×§×¦×¨/×œ× ××•×‘×Ÿ -> Play fallback + Record ××—×“×© ×¤×¢× ××—×ª
    ...

@twilio_bp.post("/webhook/call_status")
def call_status():
    return "OK", 200
```

**××—×¨×™ ×¤×¨×™×¡×”**: ×¢×“×›×Ÿ ×‘Ö¾Twilio Console ××ª ×”Ö¾URLs ×œ×©×œ×•×©×ª ×”× ×ª×™×‘×™× ×”×œ×œ×• (POST).

×‘×“×•×§ ×‘Ö¾Request Inspector ×©××™×Ÿ 500.

---

## 6) Feature Flags (××›×™×¤×” ×‘×¦×“ ×©×¨×ª)

×™×© ×›×‘×¨ `feature_flags.py`. **×”×¤×¢×œ** ×¢×œ endpoints ×¨×œ×•×•× ×˜×™×™×:

```python
from .feature_flags import require_feature

@crm_bp.get("/customers")
@require_feature("crm")
def list_customers(): ...
```

×‘×“×•×§ ×©×’× WhatsApp/Calls/Invoices/Signatures ×¢× ×“×’×œ×™× ×ª×•×××™×.

---

## 7) × ×™×§×•×™ Legacy/Debug

××—×§ ××”×¤×¨×•×™×§×˜:

* `server/debug_full_flow.html`
* `server/fix_status.html`
* ×•×›×œ ×§×•×‘×¥ `_broken` ×× ×§×™×™×.
  ×”×ª×—×™×™×‘: `git rm` + commit "chore: remove legacy/debug artifacts".

---

## 8) ×”×ª×¨××•×ª ×–××ŸÖ¾×××ª (Socket + SW)

**Client: ×¦×•×¨** `client/src/lib/socket.ts`:

```ts
import { io } from "socket.io-client";
export const socket = io("/", { path: "/ws" });
```

**Hook:** `client/src/hooks/useTaskDue.ts`

```ts
import { useEffect } from "react";
import { socket } from "@/lib/socket";

export function useTaskDue(onDue:(p:any)=>void){
  useEffect(()=>{
    socket.on("task:due", onDue);
    return ()=> socket.off("task:due", onDue);
  },[onDue]);
}
```

**Modal ××¡×š ××œ×:** `client/src/components/TaskDueModal.tsx`
×›×•×œ×œ: ×©× ×œ×§×•×—, ×˜×œ×¤×•×Ÿ, ×›×¤×ª×•×¨×™ **×—×™×™×’**/**×¤×ª×— WhatsApp**, Snooze 5/15/60, Done.
×”×¤×¢×œ ××ª ×”××•×“×œ ×‘Ö¾`App.tsx` ×‘×××¦×¢×•×ª `useTaskDue`.

**Service Worker:** `client/public/sw.js`
×•×“× ×©×™×© `showNotification` ×¢× action buttons (Call/WA/Snooze).
×‘Ö¾Backend ×§×™×™× `/api/notifications/subscribe` â€” ×•×“× ×©×œ×™×—×” ×‘×–××Ÿ due.

---

## 9) Design System + DataTable

**×¦×•×¨** `client/src/styles/tokens.css` (×¦×‘×¢×™×, ×˜×™×¤×•×’×¨×¤×™×” *Assistant*, spacing 8px, RTL).
×™×™×‘× ×‘Ö¾`index.css`.

**×”×˜××¢ TanStack Table** ×‘×¨×›×™×‘×™ CRM/Invoices/Contracts:
××™×•×Ÿ, ×¡×™× ×•×Ÿ, ×”×¡×ª×¨×ª ×¢××•×“×•×ª, ×¦×¤×™×¤×•×ª, ×™×¦×•× CSV.
×”×—×œ×£ ××ª ×”×˜×‘×œ××•×ª ×”×¤×©×•×˜×•×ª ×‘Ö¾DataTable ××—×™×“.

**Action Bar** ×‘×“×£ ×œ×§×•×— (×œ××¢×œ×”, ×ª××™×“ × ×¨××”):
"ğŸ“ ×”×ª×§×©×¨" â†’ `POST /api/customers/:id/call/start`
"ğŸ’¬ WhatsApp" â†’ `POST /api/customers/:id/whatsapp/start`
"ğŸ“ ××©×™××”" â†’ `POST /api/tasks`
"ğŸ“„ ×”×¦×¢×”" / "âœï¸ ×—×ª×™××”" / "ğŸ§¾ ×—×©×‘×•× ×™×ª" â†’ endpoints ×§×™×™××™×.

---

## 10) Customer Timeline (Front)

**×¦×•×¨** `client/src/components/CustomerTimeline.tsx`

* ××‘×™× `/api/customers/:id/timeline`
* ×¤×™×œ×˜×¨×™× (calls/whatsapp/tasks/contracts/invoices)
* ×¨× ×“×¨ ××™×™×§×•×Ÿ+×›×•×ª×¨×ª+×–××Ÿ+CTA â€œ×¤×ª×— ××§×•×¨â€

×©×œ×‘ ×‘×“×£ ×”×œ×§×•×— (××ª×—×ª ×œÖ¾Overview ××• ×›×˜××‘ × ×¤×¨×“ â€œTimelineâ€).

---

## 11) QA & CI

**Frontend**: ×”×•×¡×£ `.eslintrc.js` + `.prettierrc` + ×¡×§×¨×™×¤×˜×™× ×‘Ö¾`client/package.json`:

```json
"scripts": {
  "lint": "eslint src --ext .ts,.tsx --max-warnings=0",
  "format": "prettier --write ."
}
```

**Backend**: ×”×•×¡×£ `ruff.toml`, ×”×¤×¢×œ `ruff` + `black`.

**E2E**: ×”×ª×§×Ÿ Playwright, ×‘×“×•×§ ×–×¨×™××”:
×™×¦×™×¨×ª ×œ×§×•×— â†’ ×™×¦×™×¨×ª ××©×™××” (`due_at+2m`) â†’ ×”××ª× ×” â†’ ×§×‘×œ×ª `task:due` â†’ ×¤×ª×™×—×ª modal â†’ WhatsApp/Call â†’ Timeline ×”×ª×¢×“×›×Ÿ.

**GitHub Actions**: workflow ×©××¨×™×¥ lint+test (×©×¨×ª ×•×œ×§×•×—), ×•×‘×•× ×” Docker.

---

## 12) ×¤×¨×™×¡×” ×•×¡×•×“×•×ª

ENV ×—×•×‘×”:

```
FLASK_ENV=production
DATABASE_URL=...
JWT_SECRET=...
CORS_ORIGINS=https://app.example.com
TWILIO_SID=...   TWILIO_TOKEN=...
WHATSAPP_DEVICE=...
GOOGLE_APPLICATION_CREDENTIALS=/secrets/google_tts_key.json
VAPID_PUBLIC_KEY=...  VAPID_PRIVATE_KEY=...
```

×¢×“×›×Ÿ Twilio Webhooks ×œ×©×œ×•×©×ª ×”× ×ª×™×‘×™×.
×•×•×“× ×©Ö¾`/static/voice_responses` ×—×©×•×£ ×¦×™×‘×•×¨×™×ª (×œ×”×©××¢×ª TTS).

---

## 13) Acceptance (Definition of Done)

* [ ] ×©×œ×•×©×ª × ×ª×™×‘×™ Twilio ××—×–×™×¨×™× 200 ×•× ×¨××™× ×‘×œ×•×’×™×.
* [ ] `/api/customers/:id/timeline` ××—×–×™×¨ ××™×¨×•×¢×™× ×××™×ª×™×™× (×œ×¤×—×•×ª 3 ×¡×•×’×™×).
* [ ] ×¤×•×¤Ö¾××¤ ××¡×š ××œ× ×§×•×¤×¥ ×‘×–××Ÿ `due_at`; Push ××’×™×¢ ×›×©×”×˜××‘ ×¡×’×•×¨.
* [ ] ×“×£ ×œ×§×•×—: Action Bar ×¤×¢×™×œ (Call/WA/Task/Contract/Invoice/Signature).
* [ ] ×˜×‘×œ××•×ª CRM/Invoices/Contracts ×¢× TanStack (××™×•×Ÿ/×¡×™× ×•×Ÿ/×™×¦×•×).
* [ ] ××™×Ÿ ×§×‘×¦×™ debug/legacy ×‘×××’×¨.
* [ ] ××™×Ÿ ×©×’×™××•×ª ×‘×§×•× ×¡×•×œ×ª ×“×¤×“×¤×Ÿ; ×›×œ ×”×‘×“×™×§×•×ª ×™×¨×•×§×•×ª ×‘Ö¾CI.

---

## 14) ×§×•××™×˜×™× ××•×¦×¢×™×

1. `feat(server): register_blueprints + error handlers + logging setup`
2. `fix(crm): customers_paginated typo + paging tests`
3. `feat(api): customer timeline endpoint`
4. `feat(twilio): add incoming_call + call_status + harden handle_recording`
5. `chore: remove legacy debug files`
6. `feat(client): socket.ts + useTaskDue + TaskDueModal + sw.js actions`
7. `feat(ui): tokens.css + DataTable integration + CustomerTimeline`
8. `ci: add eslint/prettier/ruff + playwright workflow`

---

**×¡×™×™×, ×”×“×¤×¡ ×¦×™×œ×•× ××¡×š** ×©×œ:

* ×“×£ ×œ×§×•×— ×¢× Timeline ×¤×¢×™×œ
* ×¤×•×¤Ö¾××¤ ×”×ª×¨××” ×‘×–××Ÿ ×××ª
* ×§×•× ×¡×•×œ×” × ×§×™×™×”
* ×ª×•×¦××•×ª ×‘×“×™×§×•×ª ×™×¨×•×§×•×ª

×•×ª×¢×“×›×Ÿ: â€œ×‘×•×¦×¢ ×œ×¤×™ ×”×¡×¢×™×¤×™× ×œ×¢×™×œ (×¢× ×§×™×©×•×¨×™ ×§×•××™×˜×™×)â€.
