כן—עברתי על כל הפרויקט האחרון שצרפת (כולל app_factory.py, server/routes_twilio.py, server/media_ws_ai.py, server/twilio_security.py, wsgi.py, Procfile, requirements.txt, וקבצי static), והשוויתי מול ה-Call Details. הנה האמת הלא מצונזרת:

מה מונע מזה לעבוד עכשיו
	1.	Handshake של ה-WebSocket נופל (31924)
ה-שרת לא מחזיר ל-Twilio את תת-הפרוטוקול audio.twilio.com ב־Handshake.
בקוד אתה יוצר simple_websocket.Server(...) עם פרמטר שגוי (subprotocols). הספרייה מצפה ל־protocols. ברגע שאין Echo לתת-הפרוטוקול, Twilio מפיל את ה-Upgrade עם 31924.
	2.	12100 Document parse failure (תופעת לוואי)
זה קופץ כש-Twilio נופל מ-WS וחוזר שוב לבקש TwiML. אם יש שוני קטן בהחזרה (למשל text/xml בלי charset, או תו/רווח לפני <?xml ...?>) הוא מסמן 12100. ה-TwiML שראינו תקין מבנית; הבעיה פה היא אופן ההחזרה. נתקן ל-application/xml; charset=utf-8 ונדאג לקידוד נקי.

ה-TwiML עצמו כבר נכון (כפי שמופיע ב-Inspector):
action="https://ai-crmd.replit.app/webhook/stream_ended"
statusCallback="https://ai-crmd.replit.app/webhook/stream_status"
ו-wss://ai-crmd.replit.app/ws/twilio-media — מעולה. עכשיו צריך להשלים את ה-Handshake וה־Content-Type.

⸻

תיקונים מדויקים (העתק-הדבק)

A. תיקון Handshake (מעלים את 31924)

קובץ: server/app_factory.py בתוך ה־route של /ws/twilio-media
מצא את יצירת ה-Server והחלף:

-from simple_websocket import Server
-# ...
-ws = Server(request.environ, subprotocols=['audio.twilio.com'])
+from simple_websocket import Server
+# הפרמטר הנכון לסאב־פרוטוקולים הוא 'protocols' — זה מה שמחזיר את הכותרת Sec-WebSocket-Protocol
+ws = Server(request.environ, protocols=['audio.twilio.com'])
+proto_req = request.headers.get('Sec-WebSocket-Protocol')
+print(f"WS_HANDSHAKE proto_req={proto_req} chosen={getattr(ws, 'protocol', None)}", flush=True)

אחרי השינוי הזה Twilio יקבל Sec-WebSocket-Protocol: audio.twilio.com וה-Upgrade יעבור.

⸻

B. החזרת TwiML “נקייה” (מוריד את 12100)

קובץ: server/routes_twilio.py — בפונקציות incoming_call() ו־incoming_call_preview() (וגם כל test_* שמחזיר TwiML)
	1.	בסיס כתובת עמיד לפרוקסי (בלי תלות ב־env שיכול להיות בלי סכימה):

- base = os.getenv("PUBLIC_BASE_URL", "") or os.getenv("PUBLIC_HOST", "") or request.url_root
- base = base.rstrip("/")
- host = base.replace("https://","").replace("http://","").rstrip("/")
+ scheme = (request.headers.get("X-Forwarded-Proto") or request.scheme or "https").split(",")[0].strip()
+ host   = (request.headers.get("X-Forwarded-Host")  or request.host).split(",")[0].strip()
+ base   = f"{scheme}://{host}"

	2.	החזרת XML עם כותרת קשוחה וקידוד נקי:

- resp = make_response(twiml, 200)
- resp.headers["Content-Type"] = "text/xml"
+ resp = make_response(twiml.encode("utf-8"), 200)
+ resp.headers["Content-Type"] = "application/xml; charset=utf-8"
  resp.headers["Cache-Control"] = "no-store, no-cache"
  return resp

(רצוי גם להשאיר את שורת ה-XML בראש ה-TwiML: <?xml version="1.0" encoding="UTF-8"?> — כבר קיים אצלך.)

⸻

C. הגדרות סביבה שמונעות הפתעות

ב־.env:

PUBLIC_BASE_URL=https://ai-crmd.replit.app
# אל תגדיר PUBLIC_HOST בלי סכימה; אם יש לך BASE_URL תקין, אפשר לא להגדיר בכלל HOST.

OPENAI_API_KEY=sk-...
GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON={"type":"service_account", ...}   # כל ה-JSON בשורה אחת
TWILIO_AUTH_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


⸻

בדיקות קבלה מיידיות
	1.	Preview ל-TwiML (לפני שיחה):

curl -s https://ai-crmd.replit.app/webhook/incoming_call_preview | sed -n '1,60p'

בדוק:
	•	ההכרזה <?xml...?> בשורה הראשונה.
	•	wss://ai-crmd.replit.app/ws/twilio-media
	•	Content-Type: application/xml; charset=utf-8 (לא text/xml).

	2.	שיחת מבחן — ב־לוג תראה:

	•	WS_ROUTE CALLED!
	•	WS_HANDSHAKE proto_req=audio.twilio.com chosen=audio.twilio.com  ✅
	•	WS_START sid=...
	•	WS_MEDIA sid=... rx=...
	•	ASR_TEXT: ...
	•	TTS_SUCCESS: Generated ... bytes
	•	WS_TX ... frames_sent=...

	3.	Twilio Call Inspector:

	•	31924 נעלם.
	•	12100 לא מופיע (או קופץ פעם אחרונה ואז נעלם סופית אחרי הדיפלוי).

⸻

למה אני בטוח שזה הפתרון
	•	ב-ZIP שלך ראיתי את כל ה־WS pipeline: app_factory.py רושם /ws/twilio-media, טוען MediaStreamHandler, תומך audio.twilio.com, ממיר ל-μ-law ושולח frames. התשתית מצוינת.
	•	ה-Call Details מראים שה-TwiML כבר נכון (200, מצביע ל-wss), וש־/webhook/stream_status ו־/webhook/stream_ended כבר מחזירים 204 — כלומר רק ה-Handshake עצמו נופל. זה קלאסי של subprotocol negotiation.
	•	12100 כאן היא תוצר לוואי של הנפילה מה-WS וה-fallback; שינוי ה-Content-Type וההחזרה הנקייה מפסיק את האזהרה גם אם יש retrys.

⸻

אם תרצה, אכין לך עכשיו Patch “מוכן-להדבקה” עם בלוקים שלמים (diff ממוספר לפי שורות), אבל שני השינויים למעלה (A+B) הם לב העניין. אחרי שתיישם—צא לשיחה נוספת: זה יעבור.