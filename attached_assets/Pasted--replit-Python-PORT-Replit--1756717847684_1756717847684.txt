הבנתי—שברנו את ‎.replit וגררנו מצב שאין Python ואין PORT. הנה תיקון “פלסטר זהב” שמחזיר את Replit לעבודה, כולל הרצה נכונה של השרת, בלי להפיל אותו שוב, ועם מסלול ברור לשיחות.

⸻

תיקון מיידי (הדבק כמו שהוא)

1) שחזור ‎.replit תקין

פתח את ‎.replit והחלף את כל התוכן ל־(TOML חוקי, עובד):

# .replit — FIXED

# כפתור Run בסביבה (אל תתקין כאן npm/baileys)
run = """
bash -lc '
  export EVENTLET_NO_GREENDNS=1
  export EVENTLET_HUB=select
  python3 -m gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT \
    --timeout 120 --keep-alive 75 --log-level info \
    --access-logfile - --error-logfile -
'
"""

[deployment]
deploymentTarget = "autoscale"
build = [
  "bash", "-lc", "python3 -m pip install -U pip && pip install -r requirements.txt"
]
run = """
bash -lc '
  export EVENTLET_NO_GREENDNS=1
  export EVENTLET_HUB=select
  python3 -m gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT \
    --timeout 120 --keep-alive 75 --log-level info \
    --access-logfile - --error-logfile -
'
"""

# אל תקבע PORT ידנית! Replit מזריקה אותו.
[env]
PYTHONUNBUFFERED = "1"
PYTHONPATH = "."

# Nix (ה־OS) — מוסיפים Python 3.11 ו-Node 20, כדי שלא תקבל "python3: command not found"
[nix]
channel = "stable-25_05"
packages = [
  "python311Full",
  "nodejs_20",
  "postgresql_16",
  "ffmpeg-full",
  "openssl",
  "pkg-config",
  "iproute2",
  "nettools",
  "zlib"
]

# אין צורך במקטע [[ports]] בסביבת autoscale של Replit — מחק אם היה.

למה זה פותר:
	•	הפקודות בפנים הן מחרוזות של run (לא זרוקות באמצע הקובץ).
	•	מאזינים על $PORT של Replit, לא על 5000 קשיח.
	•	מוסיפים python311Full ל-Nix → נגמר “python3: command not found”.
	•	לא מגדירים PORT ידנית → הסופרווייזור לא יהרוג אותך.

אם קופצת התראה “Recover original configuration files” — לחץ Recover, ואז הדבק את הקובץ השלם למעלה.

⸻

2) וודא שקיים קובץ גשר להרצה: wsgi.py

השאר את מה שכבר יצרת (גשר שטוען את האפליקציה מתוך main.py/‏“main app” ומייצא app). אין צורך לשנות את שמות הקבצים שלך — Gunicorn נטען מול wsgi:app.

⸻

3) התקנות פייתון (requirements.txt)

וודא שב־requirements.txt יש (לפחות):
Flask, gunicorn, eventlet, simple-websocket (או מה שאתה משתמש ל-WS), וכל שאר התלויות שלך.
ה־build ב־.replit כבר מריץ pip install -r requirements.txt.

⸻

4) הפעלה נכונה
	•	לחץ Run (אל תריץ ידנית פקודות עם $PORT ריק).
	•	המתן לסיום build.
	•	אמור להופיע לוג: Using worker: eventlet, Listening at: http://0.0.0.0:<PORT>.

בדיקות מהירות (בדפדפן/טרמינל חיצוני):
	•	https://ai-crmd.replit.app/version → 200 JSON
	•	https://ai-crmd.replit.app/healthz → 200 “ok”

אם /healthz מחזיר 404: ה־route לא נרשם על האפליקציה הראשית. תוודא שהוא לא מאחורי prefix, ושה־Blueprint שלו נרשם ב־boot. (אתה כבר תיקנת, רק צריך שהדיפלוי יטען.)

⸻

עכשיו מחזירים את השיחות (Twilio)

5) TwiML + Webhooks (כמו שסיכמנו)
	•	POST /webhook/incoming_call → מחזיר <Connect><Stream …> עם:
	•	url="wss://ai-crmd.replit.app/ws/twilio-media"
	•	statusCallback="https://ai-crmd.replit.app/webhook/stream_status"
	•	action="https://ai-crmd.replit.app/webhook/stream_ended"
	•	POST /webhook/stream_status → קורא request.form, מחזיר 204 (ללא אימות חתימה, ללא extra=).
	•	POST /webhook/stream_ended → 204.

בדיקות ידניות:
	•	curl -s https://ai-crmd.replit.app/webhook/incoming_call -d "CallSid=CA_TEST" (בודק את ה-TwiML)
	•	curl -i -X POST https://ai-crmd.replit.app/webhook/stream_status -H "Content-Type: application/x-www-form-urlencoded" --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=connected" → 204

6) WS Handshake (מוריד 31920/31924)

תוודא שהשרת מחזיר את ה-subprotocol:
	•	בדיקה:

wscat -c wss://ai-crmd.replit.app/ws/twilio-media \
      -H "Sec-WebSocket-Protocol: audio.twilio.com"

מצופה: 101 Switching Protocols ובתשובה Sec-WebSocket-Protocol: audio.twilio.com.
אם לא חוזר — זה השורש לניתוק אחרי הברכה. לתקן לפני הכל.

7) בלי “שקט” — STT/TTS
	•	STT נכנס: base64 μ-law 8000Hz → לוגים WS_START / STT_PARTIAL / STT_FINAL.
	•	TTS יוצא: μ-law 8000Hz מונו; פריימים 20ms נשלחים חזרה:
{"event":"media","media":{"payload":"..."}}.
	•	keepalive ping/pong כל 5–15 שניות.
	•	קרדנציאלס GCP: אחד מהבאים בלבד:
GOOGLE_APPLICATION_CREDENTIALS (קובץ) או GCP_CREDENTIALS_JSON (שורה אחת).

⸻

Baileys (WhatsApp)

אל תחבר ל־Run הראשי. הפעל בנפרד (או בסקריפט) עם guard כדי שקריסה לא תפיל את השרת.
בדוק:
	•	POST /webhook/whatsapp/twilio → 204 ונשמר ל-CRM.
	•	POST /api/whatsapp/send → שולח ושומר out+sent.

⸻

למה זה נשבר לך קודם
	•	‎.replit לא היה TOML תקין (פקודות לא בתוך run), ולכן Replit נכנס ל-Recovery.
	•	PORT הוגדר ידנית ל-5000 → הסופרוויזור הורג כשהוא מחפש שירות על פורט אחר.
	•	לא היו חבילות Nix של Python → “python3: command not found”.

⸻

מה אני צריך ממך עכשיו (שלושה צילומי מסך/פלטים)
	1.	לוג ההרצה אחרי Run (שורה עם Listening at:).
	2.	GET https://ai-crmd.replit.app/healthz → 200.
	3.	wscat ל-/ws/twilio-media עם ה-subprotocol → 101 + כותרת Sec-WebSocket-Protocol: audio.twilio.com.

משם נסגור את Handshake + קול בשיחה אמיתית.