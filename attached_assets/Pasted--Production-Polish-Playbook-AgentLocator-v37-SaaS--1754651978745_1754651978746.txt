# ðŸ§­ Production Polish Playbook â€” AgentLocator v37

> ×ž×˜×¨×”: ×œ×”×‘×™× ××ª ×”×ž×¢×¨×›×ª ×œ×¨×ž×ª SaaS ×¤×¨×•×¤×¡×™×•× ×œ×™×ª â€” ×•×™×–×•××œ×™ + ×¤×•× ×§×¦×™×•× ×œ×™ + ××ž×™× ×•×ª + ×‘×“×™×§×•×ª + ×¤×¨×™×¡×”.
> ×§×”×œ ×™×¢×“: ×ž×¤×ª×—/×¡×•×›×Ÿ AI ×©×ž×‘×¦×¢ ××ª ×”×ª×™×§×•× ×™×. **×œ×”×™×¦×ž×“ ×œ×”×•×¨××•×ª ×›×œ×©×•× ×Ÿ.**

---

## 0) PRIORITY FIXES (×‘×œ×•×§×¨×™×)

1. **CRM paginate bug** â€” ×‘×§×•×‘×¥ `server/api_crm_advanced.py` ×”×—×œ×£ ×›×œ ×ž×•×¤×¢ ×©×œ `customers_paginate` ×œÖ¾`customers_paginated` (××• ×ž×™×ž×© ×“×¤×“×•×£ ×¢×§×‘×™).
2. **× ×™×§×•×™ ×§×‘×¦×™ Legacy/Debug** â€” ×ž×—×§/× ×˜×¨×œ: `routes_twilio_broken.py`, `debug_full_flow.html`, `fix_status.html`, ×•×›×œ ×§×•×‘×¥ "\_broken".
3. **×ž×™×–×•×’ ×œ×•×’×™× ×’ ×œ×¤×¨×•×“×§×©×Ÿ** â€” ×œ××¤×©×¨ DEBUG ×¨×§ ×‘Ö¾ENV=dev; ×‘×¤×¨×•×“×§×©×Ÿ JSON logs + INFO.
4. **Handlers ×œÖ¾404/500** â€” ×¢×ž×•×“×™×/JSON ××—×™×“×™×.

---

## 1) App Factory + Config

**×ž×˜×¨×”:** ×‘×“×™×§×•×ª ×¤×©×•×˜×•×ª, ××™× ×¡×˜× ×¡×™× × ×¤×¨×“×™× ×œÖ¾dev/test/prod, ×¨×ž×•×ª ×œ×•×’ × ×›×•× ×•×ª, ×¨×™×©×•× ×‘×œ×•×¤×¨×™× ×˜×™× ×‘×ž×§×•× ××—×“.

**×§×•×‘×¥:** `server/app_factory.py`

```python
from flask import Flask
from flask_cors import CORS
from .config import DevConfig, ProdConfig, TestConfig
from .routes import register_blueprints
from .models import db, migrate

CONFIG_MAP = {
  'development': DevConfig,
  'testing': TestConfig,
  'production': ProdConfig,
}

def create_app(env: str = 'development') -> Flask:
    app = Flask(__name__)
    app.config.from_object(CONFIG_MAP.get(env, DevConfig))

    # extensions
    db.init_app(app)
    migrate.init_app(app, db)
    CORS(app, origins=app.config.get('CORS_ORIGINS', '*'))

    # blueprints
    register_blueprints(app)

    # error handlers
    register_error_handlers(app)

    # logging
    setup_logging(app)
    return app
```

**×§×•×‘×¥:** `server/routes/__init__.py`

```python
def register_blueprints(app):
    from ..api_crm_advanced import crm_bp
    from ..api_whatsapp_advanced import whatsapp_bp
    from ..api_calls import calls_bp
    from ..api_contracts import contracts_bp
    from ..api_invoices import invoices_bp
    from ..api_signatures import signatures_bp
    from ..api_stats import stats_bp
    from ..routes_twilio import twilio_bp
    app.register_blueprint(crm_bp)
    app.register_blueprint(whatsapp_bp)
    app.register_blueprint(calls_bp)
    app.register_blueprint(contracts_bp)
    app.register_blueprint(invoices_bp)
    app.register_blueprint(signatures_bp)
    app.register_blueprint(stats_bp)
    app.register_blueprint(twilio_bp)
```

**×§×•×‘×¥:** `server/main.py`

```python
import os
from app_factory import create_app

if __name__ == '__main__':
    env = os.getenv('FLASK_ENV', 'development')
    app = create_app(env)
    app.run(host='0.0.0.0', port=int(os.getenv('PORT', 5000)), debug=(env=='development'))
```

---

## 2) Error Handlers + Logging

**×§×•×‘×¥:** `server/error_handlers.py`

```python
from flask import jsonify

def register_error_handlers(app):
    @app.errorhandler(404)
    def not_found(e):
        return jsonify({"error":"not_found","detail":"resource not found"}), 404

    @app.errorhandler(500)
    def internal(e):
        app.logger.exception("Unhandled server error")
        return jsonify({"error":"server_error"}), 500
```

**×§×•×‘×¥:** `server/logging_setup.py`

```python
import logging, json, os

class JsonFormatter(logging.Formatter):
    def format(self, record):
        base = {
          'lvl': record.levelname,
          'msg': record.getMessage(),
          'name': record.name,
        }
        return json.dumps(base, ensure_ascii=False)

def setup_logging(app):
    handler = logging.StreamHandler()
    if os.getenv('FLASK_ENV') == 'production':
        handler.setFormatter(JsonFormatter())
        app.logger.setLevel(logging.INFO)
    else:
        app.logger.setLevel(logging.DEBUG)
    app.logger.addHandler(handler)
```

---

## 3) Feature Flags (×”×¨×©××•×ª ×¢×¡×§)

**×§×•×‘×¥:** `server/feature_flags.py`

```python
from functools import wraps
from flask import jsonify, g

FEATURE_MAP = {
  'crm': 'crm_enabled',
  'whatsapp': 'whatsapp_enabled',
  'calls': 'calls_enabled',
  'signatures': 'signature_enabled',
  'invoices': 'invoice_enabled',
}

def require_feature(feature_key):
    def deco(fn):
        @wraps(fn)
        def wrapper(*args, **kwargs):
            biz = getattr(g, 'business', None)
            if not biz:
                return jsonify({'error':'no_business_context'}), 403
            flag = FEATURE_MAP.get(feature_key)
            if not getattr(biz, flag, False):
                return jsonify({'error':'feature_disabled', 'feature': feature_key}), 403
            return fn(*args, **kwargs)
        return wrapper
    return deco
```

> ×œ×©×œ×‘ ×‘×“×§×•×¨×¦×™×” ×‘×ž×¡×œ×•×œ×™× ×¨×œ×•×•× ×˜×™×™×.

---

## 4) DB: Tasks/Notifications/Timeline

**×ž×™×’×¨×¦×™×”:**

```sql
-- tasks
CREATE TABLE tasks (
  id BIGSERIAL PRIMARY KEY,
  business_id BIGINT NOT NULL,
  customer_id BIGINT NOT NULL,
  title TEXT NOT NULL,
  notes TEXT,
  channel VARCHAR(16) NOT NULL CHECK (channel IN ('call','whatsapp','meeting')),
  due_at TIMESTAMPTZ NOT NULL,
  assignee_user_id BIGINT,
  status VARCHAR(16) NOT NULL DEFAULT 'open',
  snooze_until TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE INDEX ix_tasks_due ON tasks(due_at);

-- notifications
CREATE TABLE notifications (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  task_id BIGINT,
  type VARCHAR(32) NOT NULL,
  delivered_at TIMESTAMPTZ,
  read_at TIMESTAMPTZ
);

-- web push
CREATE TABLE webpush_subscriptions (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  endpoint TEXT NOT NULL,
  p256dh TEXT NOT NULL,
  auth TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- timeline unified (×ž×¢×•×¨×‘×‘)
CREATE MATERIALIZED VIEW customer_timeline AS
  SELECT 'call' AS kind, business_id, customer_id, created_at AS ts, call_sid::text AS ref FROM call_logs
  UNION ALL
  SELECT 'whatsapp', business_id, customer_id, created_at, message_id::text FROM whatsapp_messages
  UNION ALL
  SELECT 'task', business_id, customer_id, created_at, id::text FROM tasks
  UNION ALL
  SELECT 'contract', business_id, customer_id, created_at, id::text FROM contracts
  UNION ALL
  SELECT 'invoice', business_id, customer_id, created_at, id::text FROM invoices;
CREATE INDEX ix_timeline ON customer_timeline (business_id, customer_id, ts);
```

> ×œ×¨×¢× ×Ÿ MV ×‘×˜×¨×™×’×¨/×§×¨×•×Ÿ ××• ×œ×¢×‘×•×¨ ×œÖ¾normalized table ×¢× writer.

---

## 5) API â€” ×”×’×“×¨×•×ª ×ž×“×•×™×§×•×ª

### Tasks/Notifications

```
POST   /api/tasks                      {customer_id,title,notes,channel,due_at}
PATCH  /api/tasks/:id                  {status|snooze_until|title|notes}
GET    /api/tasks?range=today|week     â†’ ×¨×©×™×ž×ª ×ž×©×™×ž×•×ª ×œ×ž×¡×š ×”×¤×¢×ž×•×Ÿ
POST   /api/notifications/subscribe    {endpoint,p256dh,auth}
```

### Timeline

```
GET /api/customers/:id/timeline?types=call,whatsapp,task,contract,invoice&from=&to=
```

### CRM Actions

```
POST /api/customers/:id/whatsapp/start  {template?, text?}
POST /api/customers/:id/call/start      {script_id?}
POST /api/customers/:id/contracts       {...}
POST /api/customers/:id/invoices        {...}
```

### Calls (Twilio)

```
POST /webhook/incoming_call
POST /webhook/handle_recording
POST /webhook/call_status
```

> ×”×§×¤×“ ×¢×œ **finishOnKey="\*"**, fallback ×œ×©×™×—×” ×§×¦×¨×”, ×•×©×’×™××•×ª 500 â†’ 200 ×¢× ×’×•×£ ×©×’×™××” ×ž×ª×•×¢×“.

---

## 6) Frontend â€” Design System & Layout

1. **Design tokens** ×‘Ö¾`client/src/styles/tokens.css`: ×¦×‘×¢×™×, ×˜×™×¤×•×’×¨×¤×™×” (Assistant), spacing (8px grid).
2. **Layout ××—×™×“**: `AppShell` ×¢× Sidebar + Header + Content (RTL).
3. **DataTable ×ž×§×¦×•×¢×™×ª** â€” TanStack Table (sorting, filters, column hide, density, CSV export).
4. **Empty/Skeleton** ×§×•×ž×¤×•× × ×˜×•×ª ××—×™×“×•×ª.
5. **Action Bar** ×‘×“×£ ×œ×§×•×—: ×—×™×™×’ / WhatsApp / ×ž×©×™×ž×” / ×”×¦×¢×” / ×—×ª×™×ž×” / ×—×©×‘×•× ×™×ª.

---

## 7) Frontend â€” Notifications & Fullâ€‘Screen Reminder

**Service Worker:** `client/public/sw.js`

```js
self.addEventListener('push', event => {
  const data = event.data?.json() || {};
  event.waitUntil(self.registration.showNotification(data.title || 'AgentLocator', {
    body: data.body,
    data,
    actions: [
      {action:'call', title:'×”×ª×§×©×¨'},
      {action:'wa',   title:'×¤×ª×— WhatsApp'},
      {action:'snooze_15', title:'× ×•×“× ×™×§ 15×“×³'}
    ]
  }));
});
```

**Socket init:** `client/src/lib/socket.ts`

```ts
import { io } from 'socket.io-client'
export const socket = io('/', { path: '/ws' })
```

**Hook:** `useTaskDue.ts`

```ts
useEffect(() => {
  socket.on('task:due', (p)=> openFullScreenModal(p))
  return () => socket.off('task:due')
},[])
```

**Fullâ€‘Screen Modal:** ×ž×—×™×™×‘ focus trap, ×›×¤×ª×•×¨×™ Snooze/Done, ×§×™×¦×•×¨×™ ×ž×§×©×™× (Enter=Call, W=WA, S=Snooze).

---

## 8) Customer Timeline (COM)

* ×§×•×ž×¤×•× × ×˜×”: `CustomerTimeline.tsx` ×ž×¦×™×’×” ×¨×¦×£ ×ž××•×—×“ ×¢× ×¤×™×œ×˜×¨×™×.
* ×›×œ ×¨×©×•×ž×” ×ž×§×•×©×¨×ª ×œÖ¾view ×”×ž×ª××™× (×”×§×œ×˜×” â†’ Calls; ×”×•×“×¢×” â†’ WhatsApp; ×ž×¡×ž×š â†’ Contracts/Invoices).

---

## 9) QA & CI

* **ESLint + Prettier** (frontend), **Ruff + Black** (backend).
* **Unit Tests**: pytest ×œÖ¾API; React Testing Library ×œ×¨×›×™×‘×™×.
* **E2E**: Playwright â€” ×–×¨×™×ž×•×ª: ×™×¦×™×¨×ª ×œ×§×•×— â†’ ×”×§×¦××ª ×ž×©×™×ž×” â†’ ×”×ª×¨××ª due â†’ ×”×ª×—×œ×ª ×©×™×—×”/WA â†’ ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡.
* **GitHub Actions**: ×”×ª×§× ×” + ×‘×“×™×§×•×ª + build.

---

## 10) Deployment & Secrets

**ENV ×—×•×‘×”:**

```
FLASK_ENV=production
DATABASE_URL=...
JWT_SECRET=...
CORS_ORIGINS=https://app.example.com
TWILIO_SID=...
TWILIO_TOKEN=...
WHATSAPP_DEVICE=...
GOOGLE_APPLICATION_CREDENTIALS=/secrets/google_tts_key.json
VAPID_PUBLIC_KEY=...
VAPID_PRIVATE_KEY=...
```

**Twilio Webhooks:** ×¢×“×›×Ÿ ×œÖ¾`/webhook/incoming_call` , `/webhook/handle_recording`, `/webhook/call_status`.

---

## 11) Acceptance Checklist (DoD)

* [ ] ××™×Ÿ WARNING/ERROR ×‘×§×•× ×¡×•×œ×ª ×”×“×¤×“×¤×Ÿ.
* [ ] ×›×œ ×”Ö¾endpoints ×ž×—×–×™×¨×™× 2xx ×•× ×‘×“×§×• ×¢× Postman.
* [ ] ×“×£ ×œ×§×•×—: ×›×œ ×”Ö¾Tabs ×ž×¦×™×’×™× × ×ª×•× ×™× ××ž×™×ª×™×™×.
* [ ] Action Bar ×¢×•×‘×“ (Call/WA/Task/Contract/Invoice/Signature).
* [ ] ×”×ª×¨××ª due ×¤×•×ª×—×ª modal ×ž×¡×š ×ž×œ× + Push ×›×©×”×˜××‘ ×¡×’×•×¨.
* [ ] Timeline ×ž××•×—×“ ×ž×¦×™×’ ××ª ×›×œ ×¡×•×’×™ ×”××™×¨×•×¢×™×.
* [ ] ESLint/Prettier/Ruff/Black/Playwright ×¨×¦×™× ×™×¨×•×§ ×‘Ö¾CI.
* [ ] Docker image × ×‘× ×™×ª ×•× ×¤×¨×¡×ª, LOGS ×‘×¤×•×¨×ž×˜ JSON.

---

## 12) × ×•×¡×— ×”× ×—×™×” ×œ×¡×•×›×Ÿ (×§×•×¤×™Ö¾×¤×™×™×¡×˜)

> ×‘×¦×¢ ×œ×¤×™ ×”×¡×“×¨:
>
> 1. App Factory + ×¨×™×©×•× Blueprints + Error handlers + Logging. ×”×¨××” diff ×©×œ `app_factory.py`, `routes/__init__.py`, `main.py`.
> 2. ×ª×§×Ÿ CRM paginate bug ×‘×›×œ ×”×ž×§×•×ž×•×ª.
> 3. × ×§×” ×§×‘×¦×™ legacy/debug ×•×”×¨××” ×¨×©×™×ž×” ××—×¨×™ ×ž×—×™×§×”.
> 4. ×”×•×¡×£ ×ž×™×’×¨×¦×™×•×ª ×œ×˜×‘×œ××•×ª Tasks/Notifications/WebPush ×•×œÖ¾Timeline.
> 5. ×ž×™×ž×•×© API: tasks, notifications subscribe, customer timeline, crm actions (start call/wa, contracts, invoices).
> 6. ×¤×¨×•× ×˜: tokens.css, AppShell, DataTable (TanStack), Fullâ€‘Screen Reminder, Socket + SW, CustomerTimeline.
> 7. ×‘×“×™×§×•×ª: pytest + RTL + Playwright; GitHub Actions.
> 8. ×¤×¨×™×¡×”: secrets, webhooks, ×‘×“×™×§×•×ª Postman; ×”×¦×’ ×¦×™×œ×•×ž×™ ×ž×¡×š ×©×œ ×“×£ ×œ×§×•×—+Modal due.

â€” ×¡×•×£ â€”
