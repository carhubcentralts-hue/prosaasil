קיבלתי. מעדכן את כל ההנחיות כך שיתאימו בדיוק למצב שלך: שם הקובץ הוא “main app” (עם רווח), ואתה צריך שהכול יעבוד — שרת, שיחות (Twilio WS), ו-Baileys — בלי לשבור כלום.

להלן פלייבוק סגור (צעד-אחר-צעד) שמביא אותך לשיחה עובדת. יש בו שני חלקים:
A) הרצה יציבה (Gunicorn+Eventlet) גם כששם הקובץ עם רווח
B) שיחות Twilio + Baileys + בדיקות מסירה

⸻

A) הרצה יציבה כששם הקובץ הוא “main app”

A1) צור Entry-point נקי ל-Gunicorn (לא נוגעים בקובץ המקורי)

למה: Gunicorn לא יודע לייבא מודול עם רווח בשם. לא נשנה שמות, אלא נוסיף קובץ קטן שמשמש “גשר”.

מה לבצע (אחת-אחת):
	1.	צור קובץ Python קטן בשם wsgi.py בשורש השרת (ליד “main app”).
התוכן שלו (במילים):
	•	טען את הסקריפט “main app” כמודול דינמי מהנתיב שלו.
	•	קח ממנו את המשתנה app (האובייקט של Flask) וחשוף אותו כ-app בקובץ הזה.
זה “שִׁמּוּש” בלבד: לא משנים את “main app”, רק עוטפים אותו עבור Gunicorn.
	2.	ודא ש-app אכן קיים ב-“main app” (כבר אמרת שכן).
	3.	מעכשיו מריצים Gunicorn על wsgi:app (לא main:app ולא AgentLocator.main:app).

הערה: לא צריך למחוק/לשנות את “main app”; ה-shim רק פותר את בעיית הרווח בשם.

⸻

A2) הרצת Gunicorn בפלטפורמה (Replit) — בלי להפיל את Gunicorn

קטע חשוב: ראית ש-Baileys (npm) נופל ומפיל את כל ההרצה. אנחנו מפרידים בין Gunicorn (חזית API) לבין Baileys (ברקע), כדי שקריסה שלו לא תהרוג את השרת.

מה לבצע:
	1.	בקובץ .replit עדכן run לשורה אחת שמריצה רק את ה-API (Eventlet), על ה-$PORT של הפלטפורמה:

python3 -m gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT --timeout 120 --keep-alive 75 --log-level info --access-logfile - --error-logfile -

	•	שים לב: wsgi:app (לא main:app).
	•	אל תקבע 5000 ידנית; תן לפלטפורמה את $PORT.

	2.	אל תחבר Baileys לפקודת ה-run הראשית.
אם אתה חייב להרים אותו על אותה מכונה: תנהל אותו ב־פקודה נפרדת או דרך סקריפט start_all.sh שמריץ Baileys ברקע עם guard כך שאם npm ci/node יפול — Gunicorn יישאר חי. (להרצה ידנית בלבד; לא בקובץ run הראשי.)
	3.	לפני ההרצה, הגדר שני משתני סביבה שמייצבים Eventlet בסביבות מוגבלות:

EVENTLET_NO_GREENDNS=1
EVENTLET_HUB=select

מה מצופה לראות:
	•	לוג: “Using worker: eventlet”, “Listening at: http://0.0.0.0:”.
	•	curl https://{PUBLIC_BASE_URL}/version → 200 JSON.
	•	אין SIGTERM אחרי כמה שניות (ה-runner מרוצה כי אתה מאזין על ה-$PORT הנכון).

⸻

A3) Endpoints בריאות — שיהיה מהיר ויציב
	1.	/healthz — GET פשוט שמחזיר 200 "ok".
	•	לא תחת Blueprint צדדי; ישירות על האפליקציה הראשית.
	•	בלי DB/רשת/חתימות — מיידי.
	2.	/readyz — GET מחזיר JSON: {"ws":"ok|pending","db":"ok|err","stt":"ok|pending","tts":"ok|pending"}.
	•	לא מפעיל INIT בזמן הקריאה; מדווח על מצב אחרון בזיכרון.
	3.	/version — מחזיר DEPLOY_ID/commit/time.

בדיקות (להריץ ולהדביק תוצאות):
	•	מקומי בסשן: curl -sS -m 3 http://127.0.0.1:$PORT/healthz -i → 200.
	•	חיצוני: curl -sS -m 5 https://{PUBLIC_BASE_URL}/healthz -i → 200.

⸻

B) שיחות Twilio + Baileys + בדיקות מסירה

B1) TwiML + webhooks (בדיוק לפי הדרישות שלך)
	1.	POST /webhook/incoming_call מחזיר מייד:

<Connect action="https://{BASE}/webhook/stream_ended">
  <Stream url="wss://{BASE}/ws/twilio-media" statusCallback="https://{BASE}/webhook/stream_status">
    <Parameter name="call_sid" value="{CallSid}"/>
  </Stream>
</Connect>

	•	אין // כפולים בשום URL.
	•	בזמן דיבוג, מומלץ לבטל <Play> (הברכה) כדי להגיע מהר ל-WS.

	2.	POST /webhook/stream_status
	•	קורא request.form (לא JSON) ומחזיר 204 ריק.
	•	אין אימות חתימה, אין extra= בלוגים.
	•	אם יש דקורטור חתימה — להסיר ממנו בלבד.
	3.	POST /webhook/stream_ended
	•	מחזיר 204 ריק.

בדיקות:

curl -s https://{BASE}/webhook/incoming_call -d "CallSid=CA_TEST"
curl -i -X POST https://{BASE}/webhook/stream_status \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=connected"

מצופה: TwiML תקין ו-HTTP/2 204.

⸻

B2) Handshake של WebSocket עם Twilio — פותר 31920/31924

חובה: בזמן ה-upgrade להחזיר כותרת:

Sec-WebSocket-Protocol: audio.twilio.com

אם הכותרת לא חוזרת — Twilio תנתק (31920/31924) אחרי הברכה.

בדיקה:

wscat -c wss://{BASE}/ws/twilio-media \
      -H "Sec-WebSocket-Protocol: audio.twilio.com"

מצופה: 101 Switching Protocols ובתשובה רואים Sec-WebSocket-Protocol: audio.twilio.com.

אם לא — תקן את מסלול ה-WS כך שהשרת “מהדהד” את ה-subprotocol. ב-Eventlet/WebSocket חייבים להחזיר אותו ידנית בעת המענה ל-upgrade.

⸻

B3) מדיה: STT/TTS (כדי שלא יהיה “שקט”)

STT (קלט):
	•	מקבלים start → זרם media (כל ~20ms) → stop.
	•	media.payload = base64 של μ-law (PCMU) 8000Hz, Mono.
	•	Creds: להבטיח אחד מהבאים בלבד, לא שניהם:
	•	GOOGLE_APPLICATION_CREDENTIALS מצביע לקובץ SA אמיתי או
	•	GCP_CREDENTIALS_JSON עם JSON מלא בשורה אחת.
	•	לוגים: WS_START, STT_PARTIAL, STT_FINAL.

TTS (פלט):
	•	מפיקים μ-law (PCMU) 8000Hz Mono.
	•	משדרים פריימים של 20ms ל-WS בתבנית:

{"event":"media","media":{"payload":"..."}}


	•	keepalive ping/pong כל 5–15 שניות.
	•	לוגים: TTS_LEN_ms, MEDIA_TX=<n>, PNG_PONG_TX/RX.

בדיקה בשיחה אמיתית:
	•	תשובה נשמעת ≤ 3–6 שניות.
	•	בלוגים: WS_START → STT_FINAL → TTS_LEN_ms → MEDIA_TX → PNG_PONG.

⸻

B4) Turn-Taking (בלי לופים, בלי “לדרוס” את הדובר)
	•	מכונת מצבים: LISTENING → THINKING → SPEAKING → LISTENING.
	•	EoU: סוף-מבע על שקט 300–600ms לפני הפקת תשובה.
	•	Barge-in: אם המשתמש מתחיל לדבר בזמן TTS → להפסיק מיידית מדיה ולחזור ל-LISTENING (תגובה אחת לכל utterance).
	•	אנטי-לופים: הצגה עצמית/פתיח רק פעם אחת; דה-דופליקציה לטקסטים חוזרים.

⸻

B5) Baileys (WhatsApp) — לא להפיל את השרת
	•	הפרד תהליך: אל תחבר npm ci && node baileys_client.js לפקודת ה-run הראשית.
	•	הרץ אותו ידנית או בסקריפט נפרד, ברקע עם guard (אם נפל — לוג בלבד, לא exit 1).
	•	בדוק:
	•	POST /webhook/whatsapp/twilio → 204 ולוג שמירת הודעה ל-CRM.
	•	POST /api/whatsapp/send שולח ושומר message=out+sent.

⸻

B6) Payments — “אלגנטי כשאין מפתחות”
	•	/api/crm/payments/*
	•	PayPal לא מוגדר → 501/403, לא 500.
	•	Tranzila לא מוגדר → 501.
	•	Stripe ישן → 410 בלבד (ללא import stripe).

⸻

B7) Evidence Pack (מסירה)
	•	צילום .replit שמראה wsgi:app על $PORT.
	•	curl /version חיצוני: 200 + DEPLOY_ID עדכני.
	•	curl /healthz חיצוני: 200 “ok”.
	•	wscat Handshake: 101 + Sec-WebSocket-Protocol: audio.twilio.com.
	•	Twilio Request Inspector לשיחה אחת:
	•	incoming_call=200, stream_status=204 (לפחות פעמיים), stream_ended=204, בלי 31920/31924.
	•	לוג שיחה:
WS_START → STT_FINAL → EoU_ms → TTS_LEN_ms → MEDIA_TX → PNG_PONG_TX/RX.
	•	WhatsApp: POST /api/whatsapp/send + Webhook קלט → שניהם 204 ונשמרים ב-CRM.
	•	/readyz מציג "ws":"ok","stt":"ok","tts":"ok","db":"ok" (אחרי warmup).

⸻

למה זה פותר בדיוק את המצב שלך
	•	שם קובץ עם רווח: ה-wsgi.py עוקף בעיית import בלי לשבור את העץ הקיים.
	•	Baileys הפיל את Gunicorn: הפרדה מוחלטת — גם אם NPM נופל, ה-API ממשיך.
	•	/healthz 404: מגדירים אותו במקום הנכון, ללא תלות בשום שירות.
	•	31920: הנדשייק עם ה-subprotocol מחזיר audio.twilio.com — Twilio מפסיקה לנתק אחרי הברכה.
	•	“שקט”: STT/TTS ב-μ-law 8k + פריימים 20ms + לוגים מחייבים.

⸻

מה אני צריך ממך עכשיו
	1.	לאשר שיצרת wsgi.py ושינית את .replit ל-wsgi:app.
	2.	לשלוח פלט של:
	•	curl -sS -m 5 https://{BASE}/healthz -i
	•	curl -sS -m 5 https://{BASE}/version -i
	•	wscat -c wss://{BASE}/ws/twilio-media -H "Sec-WebSocket-Protocol: audio.twilio.com"
	3.	צילום Twilio Inspector משיחה אחת (204ים, בלי 31920).

נריץ את זה end-to-end — וכשזה ירוק, נשלים כיוונוני דיאלוג (קצבי EoU/Barge-in) לפי איך שזה נשמע בפועל.