ברור. תן לאייג’נט הנחיה אחת, קצרה ומדויקת – כדי לסגור גם את ה-11205 וגם את ה-403/502 של החתימה בלי לעקור אבטחה.

⸻

מה להגיד לו (העתק-הדבק):

משימה: תקן סופית את Webhooks של Twilio: אין יותר timeouts, ואין כשל חתימה.
אל תבטל אבטחה – רק לתקן. בצע לפי הסדר:

1) השאר את העקיפה המיידית (204) ברמת WSGI

ב־wsgi.py שמור את הקוד שמחזיר 204 מיידית לנתיבים הבאים (לפני Flask):
	•	/webhook/stream_status, /webhook/stream_status/
	•	/webhook/stream_ended, /webhook/stream_ended/

אם זה עדיין לא קיים – הוסף את הבלוק שמחזיר:
start_response('204 No Content', ...) ו־return [b''].
זה פותר סופית 11205.

2) תיקון חישוב URL לחתימת Twilio (שורש ה-403/502)

ב־server/twilio_security.py החלף שימוש ב-request.full_path ל-URL בלי query (כך Twilio מחשב חתימה בפוסטים form-encoded).

- def _effective_url(req):
-     scheme = (req.headers.get("X-Forwarded-Proto") or req.scheme).split(",")[0].strip()
-     host = (req.headers.get("X-Forwarded-Host") or req.host).split(",")[0].strip()
-     path = req.full_path[:-1] if req.full_path.endswith("?") else req.full_path
-     return f"{scheme}://{host}{path}"
+ def _effective_url(req):
+     scheme = (req.headers.get("X-Forwarded-Proto") or req.scheme).split(",")[0].strip()
+     host   = (req.headers.get("X-Forwarded-Host")  or req.host).split(",")[0].strip()
+     # Twilio חתימה ל-POST form: URL בלי query string
+     return f"{scheme}://{host}{req.path}"

הערה: ל-JSON webhooks (אם יהיו) צריך אחרת, אבל כאן ה-Twilio שלנו שולח form-encoded.

3) השב את האבטחה – רק איפה שצריך

ב־server/routes_twilio.py:
	•	להשאיר @require_twilio_signature על:
	•	/webhook/incoming_call
	•	/webhook/handle_recording
	•	/webhook/call_status
	•	לא לשים חתימה (ולא צריך) על:
	•	/webhook/stream_status (ממילא עוקפים ב-WSGI)
	•	/webhook/stream_ended (גם עוקפים ב-WSGI)

4) ודא התאמה אחד־לאחד ל־URL בקונסול של Twilio

במספר הטלפון → Voice & Fax:
	•	Webhook (Primary handler): POST https://ai-crmd.replit.app/webhook/incoming_call
ללא / בסוף, בדיוק כמו בנתיב.
	•	אין פרמטרים ב-query (לא צריך).
	•	תצוגות statusCallback/action כבר מגיעות מטווילמל – לא לשנות.

5) לוג דיבאג לא מסוכן (אופציונלי)

ב־require_twilio_signature הוסף לוגים לא רגישים כשנכשל:
	•	effective_url שחושב,
	•	ערך X-Twilio-Signature שהתקבל (מותר),
	•	ה-request.path.
לא להדפיס את ה-Auth Token, ברור.

6) בדיקות מהירות
	•	curl -i -X POST https://ai-crmd.replit.app/webhook/stream_status ⇒ 204 תוך <100ms
	•	curl -i -X POST https://ai-crmd.replit.app/webhook/stream_ended ⇒ 204
	•	בצע שיחת מבחן:
	•	ב-Inspector אין 11205,
	•	אין 403/502,
	•	רואים WS_START, WS_MEDIA, ASR_TEXT, TTS_SUCCESS.

⸻

למה זה הפתרון הנכון
	•	11205 הגיע מעיכוב ב־Flask בזמן שה-WS עובד → עקיפת WSGI מחזירה 204 מיידי.
	•	403/502 הגיעו מסטרינג שגוי לחישוב חתימה (שימוש ב-full_path כולל query). Twilio לחתימת POST form משתמש ב-URL בלי query + פרמטרים מה-body; המעבר ל־req.path/base_url פותר בול את הפער.
	•	האבטחה נשארת על ה-endpoints הרגישים; ה־status/end לא רגישים ונענים מיידית.

אם תרצה, אנסח לך גם diff מלא משני הקבצים (עם מספרי שורות) — אבל הטקסט לעיל מספיק כדי שהאג’נט יבצע בדיוק.