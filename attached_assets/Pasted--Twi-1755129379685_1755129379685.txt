מעולה—הנה הנחיה ממוקדת “שיחות בלבד” לפי הזיפ האחרון: מגדירים שלושת הוובהוקים של טוויליו, מחזירים TwiML נכון (Play+Record), מטפלים בהקלטה עם Whisper עברית ו־Fallback TTS חד-פעמי, ודואגים ל־200 תמיד ב־status. הכל בלי לגעת ב־WhatsApp/CRM/Frontend.

⸻

✅ תיקון “שיחות” (Twilio Voice) — הנחיה להדבקה

מטרה:
	1.	לוודא שקיימים שלושת הנתיבים:
/webhook/incoming_call, /webhook/handle_recording, /webhook/call_status
	2.	להחזיר TwiML תקין ב־incoming_call: Play לברכה + Record עם:
finishOnKey="*", timeout="5", maxLength="30", playBeep="true", action="/webhook/handle_recording", method="POST"
	3.	ב־handle_recording: טיפול בהקלטה קצרה, Whisper עברית, GPT, TTS fallback פעם אחת בלבד.
	4.	call_status תמיד מחזיר 200.

⸻

0) ענף עבודה

git checkout -b fix/twilio-voice


⸻

1) Blueprint לשיחות (חדש/עדכון)

צור/עדכן קובץ: server/routes_twilio.py (או server/routes/twilio.py אם אתם מעדיפים בתוך התיקייה).
השתמש בקוד הבא (מותאם לשימוש ב־Twilio TwiML):

# server/routes_twilio.py
from flask import Blueprint, request, Response, current_app, jsonify
from twilio.twiml.voice_response import VoiceResponse
import os, requests, io

twilio_bp = Blueprint("twilio", __name__, url_prefix="/webhook")

@twilio_bp.route("/incoming_call", methods=["POST"])
def incoming_call():
    host = os.getenv("HOST", "").rstrip("/")
    vr = VoiceResponse()

    # Play greeting אם קיים קובץ; אחרת אפשר לדלג
    greeting_url = f"{host}/static/voice_responses/welcome.mp3" if host else None
    if greeting_url:
        vr.play(greeting_url)

    # Record לפי הדרישה
    vr.record(
        max_length=30,
        timeout=5,
        finish_on_key="*",
        play_beep=True,
        action="/webhook/handle_recording",
        method="POST",
        trim="do-not-trim"
    )
    # Return TwiML
    return Response(str(vr), mimetype="text/xml", status=200)

@twilio_bp.route("/handle_recording", methods=["POST"])
def handle_recording():
    """מקבל RecordingUrl, מוריד אודיו, מטמיע Whisper (עברית), GPT, TTS (fallback חד-פעמי)"""
    rec_url = request.form.get("RecordingUrl") or request.json.get("RecordingUrl") if request.is_json else None
    if not rec_url:
        # אין הקלטה → Fallback חד-פעמי
        return _say_fallback("סליחה, לא קיבלתי הקלטה. כיצד אוכל לעזור?")

    # Twilio נותן URL ללא סיומת; מוסיפים .mp3 (או .wav) לפי קונפיג שלכם
    audio_url = f"{rec_url}.mp3"

    # הורדת האודיו
    try:
        r = requests.get(audio_url, timeout=20)
        r.raise_for_status()
        audio_bytes = io.BytesIO(r.content)
    except Exception:
        return _say_fallback("סליחה, הייתה תקלה זמנית בהורדת ההקלטה. איך אפשר לעזור?")

    # הערכת אורך קצר? (אופציונלי—אם יש לכם זיהוי אורך)
    # אם קצר מדי → fallback מנומס
    # ...

    # Whisper עברית (התאיםו למודול/פונקציה אצלכם)
    try:
        # דוגמה מופשטת: החליפו ל-whisper שלכם
        text_he = transcribe_he(audio_bytes)  # ← מממשים למטה או קוראים למודול קיים
    except Exception:
        return _say_fallback("לא הצלחתי להבין את ההקלטה. איך אוכל לעזור?")

    # GPT תשובה (אופציונלי—לממש באמצעות השירות הקיים)
    try:
        reply_he = generate_reply(text_he)  # ← לממש/לקרוא למודול ai_service שלכם
    except Exception:
        reply_he = "קיבלתי את הבקשה. מאשרת. האם תרצה שאחזור אליך?"

    # TTS (פעם אחת; אם נופל, מציגים הודעה קצרה)
    try:
        tts_url = synthesize_tts_he(reply_he)  # מחזיר URL של אודיו להשמעה, או None אם אין
        if tts_url:
            vr = VoiceResponse()
            vr.play(tts_url)
            return Response(str(vr), mimetype="text/xml", status=200)
    except Exception:
        pass

    return _say_fallback("אוקיי. רשמתי לפני. איך עוד לעזור?")

def _say_fallback(text_he: str):
    vr = VoiceResponse()
    vr.say(text_he, language="he-IL", voice="Polly-Neural")  # אם אין, אפשר להסיר/להשתמש ב-Play לברירת מחדל
    return Response(str(vr), mimetype="text/xml", status=200)

# ====== דוגמאות פונקציות גישור (להחליף בקריאות למודולים אצלכם) ======

def transcribe_he(audio_bytes_io):
    """
    החליפו במימוש הקיים אצלכם:
    - אם יש server/whisper_handler.py: לקרוא לפונקציה שם
    - להגדיר language='he' / 'he-IL'
    """
    # raise NotImplementedError
    # דמה:
    return "שלום, רציתי לדעת מה סטטוס ההזמנה שלי."

def generate_reply(text_he: str) -> str:
    """החליפו בקריאה לשירות GPT שלכם (ai_service.py)"""
    # דמה:
    return "בדקתי: ההזמנה מוכנה ותישלח היום. האם תרצה אישור בסמס?"

def synthesize_tts_he(text_he: str) -> str | None:
    """
    החזירו URL לקובץ אודיו מושמע (למשל דרך Google TTS שמעלה ל-/static/tts/...)
    אם אין לכם תשתית URL, אפשר לדלג ולתת vr.say במקום.
    """
    return None  # דמה

אם כבר יש לכם מודולים whisper_handler.py / ai_service.py / tts, פשוט החליפו את שלוש פונקציות הגישור לקריאות בפועל שלכם.

⸻

2) רישום ה-Blueprint

אם יש server/routes/__init__.py עם פונקציה register_blueprints(app), ודאו שהוא כולל:

from server.routes_twilio import twilio_bp   # או from .twilio import twilio_bp
def register_blueprints(app):
    app.register_blueprint(twilio_bp)
    # ...שאר ה-BPs (frontend, crm, whatsapp וכו')

אם אין מנגנון רישום מרכזי—רשמו ידנית ב־server/main.py / app.py:

from server.routes_twilio import twilio_bp
app.register_blueprint(twilio_bp)


⸻

3) תלותים (requirements) — לוודא

ב־server/requirements.txt (או requirements.txt), חייב להיות:

twilio
requests

(ועוד תלויות שכבר קיימות אצלכם—לא להסיר)

עדכון התקנות:

cd server
python3 -m venv .venv && source .venv/bin/activate
python -m pip install -U pip wheel
pip install -r requirements.txt


⸻

4) הגדרת HOST לברכה (אופציונלי)

אם רוצים Play לפתיח:

HOST=https://your-domain.com

והקובץ ב־/static/voice_responses/welcome.mp3.
אם אין קובץ/דומיין—ה־Play פשוט ידולג.

⸻

5) בדיקות מהירות (לפני Merge)

# שרת חי
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:5000/health  # 200

# TwiML פרמטרים נכונים (incoming_call):
curl -s -X POST http://localhost:5000/webhook/incoming_call | \
  grep -E 'Record|maxLength="30"|timeout="5"|finishOnKey="\\*"'   # חייב למצוא את כולם

# handle_recording – מעביר RecordingUrl (מדמה Twilio)
curl -s -X POST http://localhost:5000/webhook/handle_recording \
     -d "RecordingUrl=https://api.twilio.com/2010-04-01/Accounts/AC.../Recordings/RE123"

# call_status תמיד 200:
curl -s -o /dev/null -w "%{http_code}\n" -X POST http://localhost:5000/webhook/call_status


⸻

6) קונפיג בטויליו (Console)
	•	Voice > A Call Comes In → POST https://<HOST>/webhook/incoming_call
	•	Status Callback → POST https://<HOST>/webhook/call_status

⸻

7) Acceptance Checklist (שיחות)
	•	/webhook/incoming_call מחזיר 200 + TwiML עם <Record ...> ו־<Play> (אם מוגדר HOST)
	•	/webhook/handle_recording מחזיר 200 גם אם אין הקלטה (fallback)
	•	/webhook/call_status תמיד 200
	•	Whisper בעברית עובד (או fallback say/play מופעל פעם אחת)
	•	אין שינויים/פגיעה ב־WhatsApp/CRM

⸻

הערה אחרונה

בזיפ האחרון ראיתי קבצים כמו server/routes/frontend.py, server/app_factory.py וכו’ — אל תשנה שם כלום; רק הוסף/רשום את twilio_bp לפי ההנחיה. אם כבר יש אצלכם קובץ “improved_webhooks”, אפשר—אבל עדיף כרגע קובץ יחיד ברור שמכיל שלושת הראוטים ורישום מסודר.

אם תרצה, אכין לך גם diffs מוכנים ל-PR (לפני/אחרי) עבור הקבצים לעיל.