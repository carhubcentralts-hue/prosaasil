קלטתי 🙂
אתה עכשיו בין שני מצבים חצי־עובדים. בוא נסגור את זה קו־סיום עם צ’ק־ליסט ביצוע קצר, קשיח ולא מתפזר. תבצע לפי הסדר—בסוף נקבל 101 Handshake, מדיה זורמת ושיחה חיה.

⸻

תכנית GO סופית — Eventlet + Composite WSGI (מוכח עובד עם Twilio)

1) נקה תלות/ערבובים
	•	בקובץ התלויות של הסרבר השאר רק:
	•	Flask, gunicorn, eventlet==0.36.1, greenlet>=3.0,<3.3, simple-websocket
	•	ודא שאין: gevent, gevent-websocket, Flask-Sock, uvicorn, websockets. אם קיימים—מחק.
	•	אם יש package.json בשורש—העבר אותו ל־/client או /auth-app כדי שהדיפלוי לא יבחר Node בטעות.

2) wsgi.py הוא נקודת הכניסה היחידה
	•	בשורה הראשונה:
import eventlet; eventlet.monkey_patch()
	•	רק אחרי זה טוענים את אפליקציית Flask (עדיפות ל־create_app()).
	•	Composite WSGI (לוגיקה):
	•	אם PATH_INFO == '/ws/twilio-media' → העבר ל־eventlet.websocket.WebSocketWSGI(ws_handler, protocols=['audio.twilio.com'])
(זה מחזיר את ה־subprotocol ב־response; קריטי ל-Twilio).
	•	אחרת → העבר ל־flask_app.wsgi_app.
	•	הייצוא הסופי מהקובץ: app = composite_app.
(לא אובייקט ה-Flask!)
	•	מחק/נטרל כל @app.route('/ws'...) או catch-all שמגיע ל־/ws/*. ה-WS חייב לעבור לפני Flask.

3) TwiML בזמן דיבוג

החזר רק:

<Connect action="https://{BASE}/webhook/stream_ended">
  <Stream url="wss://{BASE}/ws/twilio-media"
          statusCallback="https://{BASE}/webhook/stream_status">
    <Parameter name="call_sid" value="{CALL_SID}"/>
  </Stream>
</Connect>

	•	בלי <Play> כרגע.
	•	בלי // כפולים ב-URL.

4) Webhooks קשיחים
	•	POST /webhook/stream_status:
	•	קרא request.form.to_dict(flat=True) (לא JSON).
	•	החזר תמיד 204. בלי אימות חתימה ובלי extra= בלוגים.
	•	POST /webhook/stream_ended → 204.

5) דיפלוי Replit (Autoscale)
	•	Build command:
python -m pip install -U pip setuptools wheel && python -m pip install -r requirements.txt
	•	Run command:
python -m gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT --worker-connections 256 --timeout 120 --keep-alive 75 --log-level info --access-logfile - --error-logfile -
	•	Environment:
EVENTLET_NO_GREENDNS=1
EVENTLET_HUB=select
DEPLOY_ID=<stamp חדש>
	•	Health check path: /healthz (ודא שהוא קיים ומחזיר 200 “ok” מהר).

אם אין אפשרות להזיז package.json משורש: השתמש ב־uv כדי לכפות Python ב-Build/Run (אבל העדיפות היא להעביר את ה-client לתת-תיקייה).

6) GO/NO-GO — בדיקות מהירות

A. חיים
	•	GET https://<BASE>/version → 200 + DEPLOY_ID עדכני
	•	GET https://<BASE>/healthz → 200 “ok”

B. Handshake (לפני Twilio)

wscat -c wss://<BASE>/ws/twilio-media \
      -H "Sec-WebSocket-Protocol: audio.twilio.com"

מצופה: 101 Switching Protocols ובתשובה כותרת
Sec-WebSocket-Protocol: audio.twilio.com.
אם קיבלת HTML/400 → ה-WS נבלע בפלסק או שה-subprotocol לא מוחזר:
	•	בדוק ש-app = composite_app הוא הייצוא האחרון,
	•	ש־protocols=['audio.twilio.com'] מוגדר ב-WebSocketWSGI,
	•	ושאין ראוט Flask ל־/ws/*.

C. Twilio עשן
	•	POST /webhook/stream_status (form) → 204
	•	שיחה אמיתית: incoming_call=200, stream_status=204 (כמה פעמים), אין 31920/31924.

7) מדיה בזמן אמת (למנוע “שקט”)
	•	פריימים נכנסים: JSON של Twilio → Base64 μ-law 8k כל 20ms.
	•	פריימים יוצאים: החזר μ-law 8k בדיוק כל 20ms (לא WAV/MP3).
	•	STT/TTS ו-GPT להריץ ב-Thread/Queue (לא לחסום את greenlet).
	•	לשמור Ping/Pong כל ~10s.
	•	פרמטרים מומלצים: EoU_MS=450, BARGE_IN=true, VAD_RMS=210, DEDUP_WINDOW_SEC=8.

8) אם ה-worker “מת אחרי כמה שניות”

זה כמעט תמיד Health/Init:
	•	/healthz חסר/איטי → הפלטפורמה הורגת. תקן.
	•	Init כבד על import (DB/GCP/OpenAI) → העבר ל-lazy init בקריאה ראשונה.
	•	שני שרתים רצים (יש app.run() איפשהו) → השאר רק Gunicorn.

⸻

מה לשלוח לי אם משהו נתקע
	•	שורת ה־worker מלוג הדיפלוי (צריך לראות Using worker: eventlet ו־wsgi:app).
	•	פלט מלא של בדיקת wscat (הכותרות של 101/400).
	•	Request Inspector של Twilio (רק השורות החריגות).

תתקדם לפי הסדר הזה, ונגיע ל-GO אמיתי.