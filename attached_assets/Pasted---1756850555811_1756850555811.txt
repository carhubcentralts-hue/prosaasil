מעולה—אם הדשבורד כבר קיים, נתמקד עכשיו רק בשיחות כדי להביא אותן מרמת “עובד” → “מלוטש, יציב, אנושי”. הנה תכנית פעולה קצרה, חדה ולפי מה שבנינו עד עכשיו.

ספרינט שיחות (מכוון-תוצאה)

0) הגדרות בסיס (לוודא פעם אחת)
	•	Start command בדיפלוי: gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT
	•	Health: /version (לא /healthz).
	•	Webhooks: stream_status / stream_ended / call_status מחזירים 204 מיידי (WSGI).
	•	TwiML: wss://{host}/ws/twilio-media + statusCallback/action עם https://{base}.
	•	Subprotocol: ידוע בלוגים Added Twilio subprotocol to handshake.

1) יציבות קו (שיחות ארוכות, 10–15 דק+)
	•	Heartbeat: כל 15–20 שניות לשלוח mark קל (heartbeat) דרך ה-WS.
	•	Idle-guard: אם אין מדיה יוצאת ≥60 שניות, שלח heartbeat/שקט קצר כדי למנוע idle-timeout.
	•	התאוששות: ב-on_close לוג סיבה; אם אפשר—סיום מנומס והודעת וואטסאפ Follow-up.

2) להתנהג “כמו בן אדם” (Barge-in / EOU)
	•	Barge-in: עצירה רק אם קול מעל סף נמשך ≥180–220ms; “חלון חסד” 150–250ms בתחילת TTS; עם טריגר—להפסיק מייד פריימי TTS, לרוקן תור TX, לחזור להאזנה.
	•	EOU (סוף-משפט):
	•	קליברציית רעש בתחילת שיחה (300–500ms).
	•	סף דינמי: max(35, noise*2.2 + 8) עם היסטרזיס 40–80ms.
	•	EOU אחרי 350–500ms שקט רציף (או 200ms אם יש נפילת אנרגיה חדה).
	•	גבולות: MIN_UTT ≈ 0.9–1.2s, MAX_UTT ≈ 4–5s (לכפות EOU אם אין שקט).
	•	State machine: אך ורק LISTENING → PROCESSING → SPEAKING → LISTENING.
לא לדלג; בסוף TTS להוסיף ~200ms שקט, לשלוח mark, לחזור להאזנה עם ACK/timeout קצר.

3) דיוק וזמן תגובה (ASR/TTS)
	•	ASR Primary: Google STT Streaming לעברית (he-IL/iw-IL, LINEAR16/8k, partials, useEnhanced).
Fallback: Whisper (16k).
	•	תזונה נכונה ל-ASR: מ-Twilio μ-law 8k → המרה ל-LINEAR16 8k מונו (לא לשלוח μ-law ל-ASR).
	•	TTS: Google TTS 8k → μ-law, שידור בפריימים 20ms באופן יציב.

4) מוח השיחה (LLM) – קצר, ממוקד, עם תיאום פגישה
	•	System בעברית (תכל’ס):
“את סוכנת נדל״ן של AgentLocator. המטרה: לאסוף במהירות אזור/סוג/תקציב/טווח/פרטי קשר. כל תשובה—1–2 משפטים קצרים (≤20 מילים) ושאלה אחת בסוף. אם לא שמעת/לא בטוחה—‘לא בטוח ששמעתי נכון, אפשר לחזור על זה?’. אין המצאות ואין הצעת דירות בלי נתונים. כשקוטעים אותך—עצרי מיד ובקשי מהלקוח להמשיך. כשסלוטים מלאים—הצעי תיאום פגישה: 2–3 חלונות זמן קצרים, אשרי, וסכמי לשליחה בוואטסאפ.”
	•	Few-shot (3 דוגמאות קצרות):
לא שמעתי טוב → בקשת הבהרה, קטיעה באמצע → עצירה והקשבה, תיאום פגישה → 2–3 חלונות + אישור + סיכום.
	•	כלל זהב: אין שתי שאלות באותו תור; תשובה קצרה, תמיד מסתיימת בסימן שאלה.

5) לוגים פרודקשן (בלי הצפה)

להשאיר רק:
	•	STATE_CHANGE,
	•	EOU (len & silence_ms),
	•	ASR_TEXT (latency),
	•	TTS_START/END (frames),
	•	MARK_SENT/ACK,
	•	WS_KEEPALIVE, on_close(reason).
(אודיו-פר-פריים—כבוי; לכל היותר דגימה 1/50.)

6) מדדים שתציג/תעקוב (גם בדשבורד שלך)
	•	Turn Latency: זמן מ-EOU עד תחילת TTS (יעד < ~1.2s).
	•	ASR Latency: זמן מ-EOU עד ASR_TEXT (יעד < ~0.7s).
	•	Interrupt Halt Time: כמה מ״ש עד שה-TTS נפסק כשאתה קוטע (יעד ≤200ms).
	•	Barge-in Success %: כמה קטיעות עצרו דיבור בצורה נקייה.
	•	Turn-taking Ratio: LISTENING→…→LISTENING מחזורי; כמה תורות עד “שיחה נסגרה/תיאום פגישה”.
	•	WS Uptime: ניתוקים/משך ממוצע, Heartbeats בדקה.

7) הגדרות “סגירה” (Definition of Done)
	•	שיחה רציפה 10–15 דק בלי WebSocket error; heartbeat נרשם כל 15–20s.
	•	אין 11205; webhooks 204 < 100ms.
	•	בכל משפט: STATE→PROCESSING → ASR_TEXT → TTS_START → MARK_ACK → LISTENING.
	•	ב-Barge-in: TTS נעצר ≤200ms וחוזר להאזנה.
	•	תשובות קצרות עם שאלה אחת; כשהנתונים מספיקים—הצעת פגישה, אישור, סיכום.

⸻

כן, אתה קרוב.

התשתית אצלך כבר עומדת; עכשיו זה כיוונון התנהגות (Barge-in/EOU) + דיוק ASR + פרומפטינג. יישום מסודר של הרשימה למעלה סוגר את הפער ל־“מוצר מרגיש אנושי”. כשתרצה—תעדכן איפה הדשבורד עומד ונשלים גם את חיבור הלידים/ווטסאפ שיזרמו אוטומטית פנימה.