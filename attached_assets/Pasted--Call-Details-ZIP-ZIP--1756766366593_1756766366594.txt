מעולה שצרפת גם את ה-Call Details וגם את ה-ZIP האחרון. עברתי שוב על הקוד (מה-ZIP ששלחת) מול הלוגים של Twilio ואת ההודעה שקיבלת. יש פה שתי תקלות שונות שמתפוצצות ביחד:

⸻

מה נשבר בפועל

1) 31924 — WebSocket Protocol Error

Twilio מחייב שהשרת יחזיר ב-Handshake:
	•	101 Switching Protocols
	•	Sec-WebSocket-Protocol: audio.twilio.com (Echo של תת-הפרוטוקול)

בקוד הנוכחי אתה יוצר את ה-WebSocket עם simple_websocket.Server(...) אבל מעביר פרמטר בשם subprotocols. בספרייה הזאת הפרמטר הנכון הוא protocols. המשמעות: השרת לא מחזיר את הכותרת Sec-WebSocket-Protocol → Twilio דוחה את ה-Upgrade עם 31924.

ראיה עקיפה: ה-TwiML תקין (200 ומוצג לך בגוף התשובה), ה-/webhook/stream_status מחזיר 204, אבל ברגע ה-WS Twilio זורק 31924 פעמיים ומסיים.

2) 12100 — Document Parse Failure

זה מופיע כ”רעש רקע” כש-Twilio נופל מ-WS וחוזר ל-TwiML שוב. שתי סיבות אפשריות, שתיהן נפתרות בקלות:
	•	Content-Type מוחזר כ-text/xml עם יוניקוד/רווחים – Twilio אוהב יותר application/xml; charset=utf-8 וללא תווים לפני ההכרזה <?xml ...?>.
	•	לעיתים כשל WS גורם ל-fallback מהיר, ומתקבלת קריאה נוספת של ה-TwiML; אם באחת מהקריאות יצא Header/Body לא נקיים (לדוג’ תו לא מודפס בתחילת התגובה), תקבל 12100.

(ה-TwiML שהדבקת תקין סינטקטית, אז זה לא תוכן שבור אלא החזרה לא נקייה/כותרת לא מדויקת. נתקן בקוד.)

⸻

תיקונים מדויקים (Copy-Paste)

A. תיקון Handshake של ה-WebSocket (מונע 31924)

קובץ: server/app_factory.py → ב־route של /ws/twilio-media
חפש את השורה שיוצרת את השרת:

# ישן (לא מחזיר Sec-WebSocket-Protocol):
ws = Server(request.environ, subprotocols=['audio.twilio.com'])

החלף ל:

-from simple_websocket import Server
-# ...
-ws = Server(request.environ, subprotocols=['audio.twilio.com'])
+from simple_websocket import Server
+# הפרמטר הנכון הוא 'protocols' – זה מה שמחזיר את הכותרת Sec-WebSocket-Protocol
+ws = Server(request.environ, protocols=['audio.twilio.com'])
+proto_req = request.headers.get('Sec-WebSocket-Protocol')
+print(f"WS_HANDSHAKE proto_req={proto_req} chosen={getattr(ws, 'protocol', None)}", flush=True)

זהו. אחרי השינוי הזה השרת יחזיר ל-Twilio את Sec-WebSocket-Protocol: audio.twilio.com – וה-Handshake יעבור.

⸻

B. החזרת TwiML “נקייה” (מוריד 12100)

קובץ: server/routes_twilio.py – בשתי הפונקציות: incoming_call() וגם incoming_call_preview() (וגם ב-test_media_streams_* אם יש).
	1.	בניית בסיס כתובת עמידה לפרוקסי (שלא תלוי ב-env שבמקרה חסר סכימה):

- base = os.getenv("PUBLIC_BASE_URL", "") or os.getenv("PUBLIC_HOST", "") or request.url_root
- base = base.rstrip("/")
- host = base.replace("https://","").replace("http://","").rstrip("/")
+ scheme = (request.headers.get("X-Forwarded-Proto") or request.scheme or "https").split(",")[0].strip()
+ host   = (request.headers.get("X-Forwarded-Host")  or request.host).split(",")[0].strip()
+ base   = f"{scheme}://{host}"

	2.	החזרת ה-XML עם Content-Type קשוח וללא תווים “מיותרים”:

- resp = make_response(twiml, 200)
- resp.headers["Content-Type"] = "text/xml"
+ resp = make_response(twiml.encode("utf-8"), 200)
+ resp.headers["Content-Type"] = "application/xml; charset=utf-8"
  resp.headers["Cache-Control"] = "no-store, no-cache"
  return resp

אם תרצה – אפשר להשאיר גם <Play> לפני <Connect> (יש לך את הקובץ static/greeting_he.mp3 קיים), זה לא חובה, אבל טוב לבדיקות שמיעה.

⸻

C. ודאות סביבתית (שורה אחת בקובץ env פותרת הפתעות)

ב־.env:

PUBLIC_BASE_URL=https://ai-crmd.replit.app
# (אל תשאיר PUBLIC_HOST ללא סכימה; עדיף לא להגדיר בכלל אם יש PUBLIC_BASE_URL)

OpenAI / Google / Twilio (ל-STT/TTS/חתימה):

OPENAI_API_KEY=sk-...
GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON={"type":"service_account", ...}  # כל ה-JSON בשורה אחת
TWILIO_AUTH_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

(מספר הטלפון הנכנס לא רלוונטי ל-Inbound WS, אבל אם תשתמש בו לשליחה החוצה – שמור E.164: +97233763805 בלי רווחים.)

⸻

בדיקת קבלה (Acceptance)
	1.	Preview ל-TwiML (לפני שיחה):

curl -s https://ai-crmd.replit.app/webhook/incoming_call_preview | sed -n '1,50p'

תראה:
	•	<?xml version="1.0" encoding="UTF-8"?>
	•	<Connect ...>
	•	<Stream url="wss://ai-crmd.replit.app/ws/twilio-media" statusCallback="https://ai-crmd.replit.app/webhook/stream_status">
	•	ב-Headers של התשובה: Content-Type: application/xml; charset=utf-8

	2.	שיחה חיה:

	•	ב-Log אמור להופיע:
	•	WS_ROUTE CALLED!
	•	WS_HANDSHAKE proto_req=audio.twilio.com chosen=audio.twilio.com
	•	WS_START sid=...
	•	WS_MEDIA sid=... rx=...
	•	ASR_TEXT: ...
	•	TTS_SUCCESS: Generated ... bytes
	•	WS_TX ... frames_sent=...

	3.	ב-Twilio Console, ב-Call Inspector:

	•	נעלם 31924 (Protocol Error)
	•	נעלם 12100 (Document parse failure)

⸻

למה זה קרה דווקא עכשיו?
	•	תיקנת יפה את ה-TwiML ל-https:///wss://. זה פתר את 400 Handshake הקודם.
	•	אבל בגלל ש-simple_websocket לא קיבל את הפרמטר הנכון (צריך protocols), Twilio לא קיבל את ה-Sec-WebSocket-Protocol בחזרה → 31924.
	•	“12100” הגיע בריבאונדים/קריאות חוזרות, עם Content-Type/חזרה לא לגמרי “נקייה”. שינוי הכותרת ל-application/xml; charset=utf-8 וסגירה נקייה פותר.

⸻

אם תרצה, אנסח לך עכשיו Patch מלא בהפרשי diff מוכן-להדבקה עבור שני הקבצים (שאתה רואה איפה לשים כל בלוק), או אוסיף גם בדיקת בריאות קטנה לשורת לוגים של ה-Handshake כדי שתראה חד-משמעית שהפרוטוקול נאכל ונענה.