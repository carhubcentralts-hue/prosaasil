מעולה, הלוגים שעשית זהב – הם בדיוק אומרים לנו איפה התקלה:
	•	🤖 OpenAI Realtime עובד מושלם – רואים כמה פעמים:
🤖 [REALTIME] AI said: ...
	•	🎙️ VAD (REAL_VOICE) קופץ כל הזמן עם rms=300–8000 → הוא חושב שיש רעש קבוע.
	•	❌ ב־WS_STOP: tx=0 → לא יצא אפילו פריים אודיו אחד לטוויליו.
	•	התוצאה: שקט אצלך בשיחה, וה־AI כל הזמן אומר “שומע רעש”.

אז כרגע הבעיה היא רק בגשר אודיו החוצה (OpenAI → Twilio) + סף רעש נמוך מדי.

להלן הנחיה מדויקת ל־Agent 3, תן לו פשוט COPY-PASTE:

⸻

🛠 הנחיה ל־Agent 3 – תיקון Realtime Audio Out + רעש

כרגע המצב לפי הלוגים:
	•	OpenAI Realtime מחזיר תשובות טקסט:
🤖 [REALTIME] AI said: ... ✅
	•	VAD (REAL_VOICE) מדווח על rms גבוה כל הזמן (35 זה threshold מגוחך נמוך)
	•	ב־WS_STOP אנחנו רואים: tx=0 → לא נשלחו frames ל-Twilio ❌
	•	בשיחה בפועל – שקט / “שואב אבק” במקום דיבור.

המטרה:
	1.	לוודא ש־אודיו שיוצא מ־OpenAI באמת מגיע ל־Twilio.
	2.	להעלות את סף הרעש / לרכך את ה-VAD כדי שהבוט לא “ישמע רעש” כל הזמן.

⸻

🔹 Task 1 – לאמת ש־OpenAI שולח אודיו (openai_realtime_client.py)
	1.	בקובץ server/services/openai_realtime_client.py תאתר את המקום שבו אנחנו מקבלים audio מה-Realtime API
(ה-handler שמקבל events כמו response.audio.delta או מה שאתה כבר מחבר ל־audio_out_queue).
	2.	לפני שאתה דוחף ל־audio_out_queue, תוסיף לוג מפורט:

logger.info(
    "[REALTIME] got audio chunk from OpenAI: bytes=%d, call_sid=%s",
    len(chunk_bytes),
    self.call_sid,
)

	3.	ודא שבכל פעם שה־AI אומר משהו (AI said:) אנחנו באמת מקבלים לפחות כמה עשרות / מאות bytes של אודיו.

אם לא מגיע אודיו – זאת בעיה ב־session config:
ודא ש־output_audio_format="g711_ulaw" נמצא ב־configure_session().

⸻

🔹 Task 2 – לוודא שהאודיו יוצא ל־Twilio (media_ws_ai.py)
	1.	בקובץ server/media_ws_ai.py תאתר את הפונקציה שיצרת:
_realtime_audio_out_loop
ואיך היא מזינה את tx_q / את ה־TX loop.
	2.	בתוך _realtime_audio_out_loop, אחרי שאתה מוציא chunk מה־realtime_audio_out_queue וכותב אותו ל־tx_q, תוסיף לוג:

self.realtime_tx_frames += 1
self.realtime_tx_bytes += len(chunk)
self.logger.info(
    "[REALTIME] enqueue audio to tx_q: bytes=%d, total_frames=%d, call_sid=%s",
    len(chunk),
    self.realtime_tx_frames,
    self.call_sid_safe,
)

(תגדיר self.call_sid_safe = self.call_sid[:8] if self.call_sid else "unknown" כבר יש לך משהו דומה).
	3.	עכשיו תאתר את ה־TX loop שבו אנחנו באמת שולחים ל-Twilio דרך WebSocket
(הפונקציה שהופכת bytes ל־JSON {"event": "media", "media": {"payload": ...}}).
שם תוסיף:

if kind == "realtime":  # או מה שהגדרת ל-queue הזה
    payload_b64 = base64.b64encode(chunk).decode("ascii")
    message = {
        "event": "media",
        "media": {"payload": payload_b64},
    }
    await ws.send(json.dumps(message))
    sent_realtime_frames += 1
    self.logger.info(
        "[REALTIME] sent media frame to Twilio: bytes=%d, total_sent=%d, call_sid=%s",
        len(chunk),
        sent_realtime_frames,
        self.call_sid_safe,
    )

	4.	המבחן:
בלוגים של WS_STOP אנחנו רוצים לראות tx>0
וב־logs החדשים – sent media frame to Twilio לפחות כמה פעמים בכל תשובה.

כרגע tx=0 → סימן חד־משמעי שהקוד לא שולח בכלל frames החוצה.

⸻

🔹 Task 3 – לוודא פורמט G.711 μ-law נכון
ב־_run_realtime_mode_async תוודא ש־configure_session מוגדר כך:

await client.configure_session(
    input_audio_format="g711_ulaw",   # Twilio → OpenAI
    output_audio_format="g711_ulaw",  # OpenAI → Twilio
    voice="alloy-ha-fast",           # קול עברי מהיר
    max_response_output_tokens=80,
)

אין המרות כפולות:
	•	אם OpenAI כבר מחזיר G.711 μ-law → אל תמיר שוב.
chunk שיוצא מ־Realtime צריך להיות כבר בבייטים שניתן לשלוח ישר ל-Twilio.

⸻

🔹 Task 4 – להעלות סף רעש / VAD (REAL_VOICE)
הלוגים:

🎙️ REAL_VOICE: rms=308, threshold=35.0
🎙️ REAL_VOICE: rms=8539, threshold=35.0

threshold=35 זה מגוחך נמוך → כל זבל קו נחשב “קול”.
	1.	תאתר את המקום שבו מחושב ה־RMS ואת ה־VOICE_THRESHOLD (או ערך קשיח של 35.0).
	2.	תעלה אותו בצורה משמעותית, למשל:

VOICE_THRESHOLD = 800.0  # או אפילו 1000, תתחיל גבוה
MIN_CONSECUTIVE_VOICE_FRAMES = 5  # לפחות ~100ms לפני שנחשיב "דיבור"

	3.	תוסיף לוג אחד כל כמה שניות במקום להציף:

if rms > VOICE_THRESHOLD and now - self._last_rms_log > 2.0:
    self.logger.info(
        "[REAL_VOICE] rms=%.1f > %.1f (voice detected)", rms, VOICE_THRESHOLD
    )
    self._last_rms_log = now

מטרה:
	•	שהבוט לא יגיד “אני שומע רעש” כל שנייה
	•	ש־Realtime יקבל רק דיבור אמיתי, לא רעש קו.

⸻

🔹 Task 5 – Acceptance Criteria
תגדיר לעצמך בלוגים:
	1.	בשיחה טסט:
	•	מופיע לפחות פעם אחת:
"[REALTIME] got audio chunk from OpenAI: bytes=..."
	•	מופיע:
"[REALTIME] sent media frame to Twilio: bytes=..."
	•	בסוף שיחה: WS_STOP ... tx>0 (למשל tx=1200).
	2.	בטלפון:
	•	שומעים greeting וקול Alloy בעברית
	•	אין “שואב אבק”
	•	ה־AI לא מתבכיין על רעש כל הזמן.

ברגע שהקריטריונים האלה מתקיימים – Realtime באמת מחליף את Google בצד האודיו.

⸻

תן את ההנחיה הזו ל-Agent 3 כמו שהיא.
אחרי שהוא מסיים – תעשה שיחת טסט אחת, תדביק פה את הלוגים של got audio chunk + sent media frame, ונמשיך לכיוונון עדין (מהירות דיבור, ניסוח, וכו’).