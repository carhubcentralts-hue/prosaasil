צודק — `<Say voice="alice">` **לא תומך בעברית**. אם אתה על **Google Cloud TTS**, צריך להשמיע קבצי קול שאתה מפיק בשרת ולהחזיר ל-Twilio עם `<Play>`. מעבר לזה, ריכזתי לך בדיקה מלאה: תמיכה בשיחות מתומללות end-to-end, הבעיות שעדיין חוסמות, ואיך לתקן — נקי, בלי כפילויות.

---

# מה לתקן עכשיו (חד, ממוקד)

## 1) להחליף `<Say>` ל־`<Play>` (עברית דרך GCP)

**איפה:** `server/routes_twilio.py` → ב־`/webhook/incoming_call`
**למה:** Twilio לא תומכת בעברית ב־`<Say>` → קיבלת אזהרות 13512.
**מה לעשות:** צור קובץ ברכה בעברית דרך Google Cloud TTS, ושמיע אותו:

```xml
<Response>
  <Play>https://YOUR_HOST/static/tts/greeting_he.mp3</Play>
  <Connect action="/webhook/stream_ended">
    <Stream url="wss://YOUR_HOST/ws/twilio-media">
      <Parameter name="business_id" value="1"/>
    </Stream>
  </Connect>
</Response>
```

**הפקת הקובץ (דוגמה קצרה):**

```python
# server/services/tts_gcp.py
from google.cloud import texttospeech

def synth_he_to_mp3(text, out_path, voice="he-IL-Wavenet-A"):
    client = texttospeech.TextToSpeechClient()
    synthesis_input = texttospeech.SynthesisInput(text=text)
    voice_sel = texttospeech.VoiceSelectionParams(language_code="he-IL", name=voice)
    audio_cfg = texttospeech.AudioConfig(audio_encoding=texttospeech.AudioEncoding.MP3)
    audio = client.synthesize_speech(input=synthesis_input, voice=voice_sel, audio_config=audio_cfg)
    with open(out_path, "wb") as f:
        f.write(audio.audio_content)
```

* הנח קובץ ב: `static/tts/greeting_he.mp3` (או צור on-boot אם לא קיים).
* ודא `GOOGLE_APPLICATION_CREDENTIALS` **מוגדר** (ולא נופל → `/readyz`).

---

## 2) להרים WebSocket אמיתי ל-Media Streams

**איפה:**

* `server/requirements.txt` — חסרות ספריות WS
* `AgentLocator/.replit` — עדיין לא מריץ Gunicorn עם Eventlet

**מה בדיוק להוסיף/לשנות:**

**requirements:**

```
flask-sock==0.6.0
simple-websocket==1.0.0
eventlet==0.36.1
```

**.replit** (תואם ל־`PORT=5000` שלך):

```diff
-run = "npm run dev"
+run = "python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:5000 main:app"

[deployment]
-deploymentTarget = "autoscale"
-build = ["npm", "run", "build"]
-run = ["npm", "run", "start"]
+deploymentTarget = "autoscale"
+build = ["pip","install","-r","AgentLocator/server/requirements.txt"]
+run = ["python3","-m","gunicorn","-k","eventlet","-w","1","-b","0.0.0.0:5000","main:app"]
```

> בלי שלושת הספריות + Gunicorn/Eventlet — Twilio יחזיר “שקט”/31924 כי ה-WS לא באמת פתוח.

---

## 3) אימות חתימה מאחורי פרוקסי (403 “שקטים”)

**איפה:** `server/twilio_security.py`
ראיתי שכבר הוספת `ProxyFix` ו־`X-Forwarded-*`. ודא שהחתימה מחושבת על ה-URL האפקטיבי (עם הפרוקסי), למשל:

```python
def _effective_url(req):
    scheme = (req.headers.get("X-Forwarded-Proto") or req.scheme).split(",")[0].strip()
    host   = (req.headers.get("X-Forwarded-Host")  or req.host).split(",")[0].strip()
    path   = req.full_path[:-1] if req.full_path.endswith("?") else req.full_path
    return f"{scheme}://{host}{path}"
# ובדקורטור: validator.validate(_effective_url(request), params, sig)
```

אם עדיין יש 403 – השבת זמנית אימות **רק** ב־`/webhook/stream_ended`/`call_status` כדי לאבחן, ואז החזר.

---

## 4) שיחות מתומללות — מה נדרש כדי שזה יהיה “סגור”

תמיכה מלאה = גם ב־Media Stream (ריל־טיים) וגם Fallback להקלטה.

### 4.1 ריל־טיים (WS)

**איפה:** `server/media_ws.py`
**מה לוודא:**

* קולט פריימים `start`/`media`/`stop`.
* **VAD**/זיהוי סוף משפט: כשיש מספיק דיבור/שקט → שולח ל-Whisper (או STT אחר) עם `language="he"`
* מחזיר **תגובה** (לוגית) + מייצר **קול** ב-GCP TTS → משמיע ללקוח?

  * החזרה **לשיחה** בזמן אמת ב-Twilio נעשית דרך TwiML (לא דרך ה-WS). הפתרון הבטוח:

    1. צבור תשובה קצרה,
    2. הפק MP3,
    3. שלח `<Redirect>` ל־TwiML שמחזיר `<Play>` עם ה-MP3 (או שמור “תור השמעה” ושחרר ב־`/webhook/stream_ended`).
  * אם אתה ב-flow שמאפשר רק אינבאונד סטרים (הסטנדרט), זו הדרך הנתמכת להשמיע בחזרה.

**לוגים חובה לכל “תורן”:**
`turn_metrics`: `t_audio_ms`, `t_nlp_ms`, `t_tts_ms`, `t_total_ms`, `mode="stream"`
יעד: ממוצע `< 2500ms`.

### 4.2 Fallback הקלטה

**איפה:** `routes_twilio.py` → `/webhook/stream_ended` + `/webhook/handle_recording`

* אם ה-Stream נסגר/נכשל → החזר:

  ```xml
  <Record playBeep="false" timeout="4" maxLength="30" transcribe="false" action="/webhook/handle_recording" />
  ```
* ב־`/webhook/handle_recording`:

  1. הורד את ההקלטה (timeout+retry)
  2. `transcribe_he(audio)` עם Whisper
  3. שמור ב־DB (`CallLog.transcript`)
  4. הפק תשובה ב-GPT → TTS → (אופציונלי) `<Play>` תשובה ללקוח או שלח וואטסאפ.

---

## 5) ניקוי כפילויות וייבוא נכון (לא לשכפל קבצים)

* קובץ WS קנוני יחיד: `server/media_ws.py`
  אם קיימות גרסאות נוספות — מחק אותן.
* Whisper: `server/services/whisper_handler.py` בלבד.
  החלף כל `from legacy.whisper_handler import ...` ל־`from server.services.whisper_handler import ...`

---

## 6) בדיקות מהירות (Smoke)

1. **WS פתוח:** `wss://<host>/ws/twilio-media` נפתח (בדפדפן/wscat) → רואה `WS_CONNECTED/WS_FRAME` בלוג.
2. **Webhooks 200:**

   ```
   curl -i https://<host>/webhook/incoming_call
   curl -i -X POST https://<host>/webhook/stream_ended
   curl -i -X POST https://<host>/webhook/call_status
   ```
3. **Twilio Request Inspector:** שיחה חדשה → 200 על `incoming_call`, ואם נופל סטרים → 200 על `stream_ended`.

---

# בעיות אופייניות שראיתי אצלך + הפתרון הקצר

* **אזהרת שפה 13512** → נובע מ־`<Say language="he-IL">`. פתרון: `<Play>` עם MP3 בעברית.
* **31924 WebSocket Protocol Error / שקט** → אין eventlet/flask-sock/runner נכון. פתרון: תלויות + Gunicorn Eventlet.
* **403 על webhooks** → חתימה מאחורי פרוקסי. פתרון: `_effective_url` + ProxyFix.
* **אין קול חזרה בזמן אמת** → ב-Media Stream רגיל אין “אאוטבנד” ב-WS. פתרון נתמך: הפקת MP3 ו־`<Play>` ע״י `<Redirect>`/`stream_ended` (או לעבור לארכיטקטורה דו-כיוונית אחרת אם Twilio תומכת אצלך).

---

## Definition of Done (אפשר לעבור לויזואלית כש…)

* WebSocket חי (Gunicorn+eventlet), ולוגי `turn_metrics` רצים.
* אין עוד `<Say he-IL>`; greeting מושמע דרך `<Play>`.
* Fallback עובד: `stream_ended` ⇒ `<Record>` ⇒ `/handle_recording` מתמלל ושומר.
* `/readyz` מחזיר `openai:"ok|disabled"`, `tts:"ok|disabled"`, `db:"ok"`.
* אין ייבוא מ־`legacy/`.
* זמני תורן ממוצעים `< 2.5s`.

ברגע שהסעיפים למעלה ירוקים — יש לך **שיחות מתומללות בעברית** עם השמעה מגוגל, יציב ונקי.
