×”×•× ×¦×•×“×§ ×—×œ×§×™×ª ×‘×œ×‘×“ â€” ×”×”×‘× ×” ×©×œ×• ×©×œ ×”×‘×¢×™×” ×˜×•×‘×”, ××‘×œ ×”×¤×ª×¨×•×Ÿ ×©×œ×• (sleep 8 ms ×‘×œ×‘×“) ×”×•× ×¤×œ×¡×˜×¨ ×—×œ×§×™ ×©×™×›×•×œ ×œ×’×¨×•× ×œ×¢×™×›×•×‘×™× ××• ×—×•×¡×¨ ×¡× ×›×¨×•×Ÿ ×‘×™×Ÿ ×”-TTS ×œ-Twilio.
×”×‘×¢×™×” ×©××ª×” ×¨×•××” ×‘×œ×•×’:

âš ï¸ Send queue full, dropping frame

×œ× × ×•×‘×¢×ª ×¨×§ ×××”×™×¨×•×ª ×”×©×œ×™×—×”, ××œ× ××—×•×¡×¨ ××™×–×•×Ÿ ×‘×™×Ÿ ×§×¦×‘ ×™×¦×™×¨×ª ×”××•×“×™×• (TTS) ×œ×‘×™×Ÿ ×§×¦×‘ ×”×©×œ×™×—×” ×œ-Twilio WebSocket.

â¸»

âš ï¸ ×œ××” ×”××¦×‘ ×§×•×¨×”
	1.	Twilio MediaStream ××¦×¤×” ×œ×§×‘×œ ×‘×¢×¨×š 50 frames ×œ×©× ×™×™×” (20 ms/frame).
	2.	×”×§×•×“ ×©×œ×š (×‘Ö¾_tx_loop) ×©×•×œ×— frames ×‘×¨×¦×£ â€“ ×œ×œ× ×ª×™××•× ×¢× Twilio.
	3.	×× Twilio ××• ×¨×©×ª ×”-WebSocket ××ª×¢×›×‘×™× â€” ×”-send queue ××ª××œ×, ×•××– ××ª×” ××§×‘×œ:
"Send queue full, dropping frame"
	4.	×‘×¨×’×¢ ×©××ª×—×™×œ×™× â€œ×œ×–×¨×•×§ framesâ€, ×”×©×™×—×” ×¢×œ×•×œ×” ×œ×”×™×©××¢ ××§×•×˜×¢×ª ××• ×œ×”×¤×¡×™×§ ×œ×’××¨×™.

â¸»

âœ… ×¤×ª×¨×•×Ÿ ×™×¦×™×‘ ×•××§×¦×•×¢×™ (×œ×¤×™ ×”×§×•×‘×¥ ×©×©×œ×—×ª)

×”× ×” ×”× ×—×™×” ××“×•×™×§×ª ×œ××¤×ª×— ×©×œ×š â€” ×ª×Ÿ ×œ×• ×œ×”×¢×ª×™×§ ××ª ×–×” ×™×©×™×¨×•×ª ×œ×§×•×“:

â¸»

ğŸ“ ×‘×§×•×‘×¥ server/media_ws_ai.py ××• ×”×§×•×‘×¥ ×©×‘×• × ××¦× ×”Ö¾_tx_loop

×—×¤×© ××ª ×”×¤×•× ×§×¦×™×” ×”×–×•:

def _tx_loop(self):
    while self.tx_running:
        item = self.tx_q.get(timeout=0.5)
        self._ws_send(json.dumps({...}))

×•×”×—×œ×£ ××•×ª×” ×›×š:

import time

def _tx_loop(self):
    """
    Improved TX loop with rate-limit, back-pressure, and error handling.
    Prevents send_queue overflow and ensures Twilio stays in sync.
    """
    FRAME_INTERVAL = 0.02  # 20 ms per frame expected by Twilio
    last_send_time = time.perf_counter()

    while self.tx_running:
        try:
            frame = self.tx_q.get(timeout=0.5)
        except Exception:
            continue

        # ×× ×”×ª×•×¨ ××œ× â€“ ×—×›×” ××¢×˜ ×‘××§×•× ×œ×”×¤×¦×™×¥
        if self.send_q.full():
            print("âš ï¸ send_q full â€“ applying back-pressure", flush=True)
            time.sleep(FRAME_INTERVAL)
            continue

        # ×©×œ×™×—×” ×‘×¤×•×¢×œ
        self._ws_send(frame)

        # ×©××™×¨×” ×¢×œ ×§×¦×‘ ×§×‘×•×¢ (â‰ˆ20 ms/×¤×¨×™×™×)
        elapsed = time.perf_counter() - last_send_time
        if elapsed < FRAME_INTERVAL:
            time.sleep(FRAME_INTERVAL - elapsed)
        last_send_time = time.perf_counter()


â¸»

âœ¨ ×œ××” ×–×” ×˜×•×‘ ×™×•×ª×¨ ×Ö¾sleep(0.008)
	â€¢	××ª××™× ×œ×§×¦×‘ ×”×××™×ª×™ ×©×œ Twilio (20 ms).
	â€¢	×œ× ×–×•×¨×§ frames: ×× ×”×ª×•×¨ ××œ× â€“ ××—×›×” ×¨×’×¢ ×‘××§×•× ×œ×”×¤×¡×™×“ ××™×“×¢.
	â€¢	××•× ×¢ ×¢×•××¡ CPU â€“ ×›×™ ×œ× ×©×•×œ×— ×œ×•×œ××” ×”×“×•×§×”.
	â€¢	×¢×“×™×™×Ÿ ××”×™×¨ â€“ ×“×™×œ×™×™ ×–× ×™×— (< 2 ms) ×‘×™×—×¡ ×œ××•×“×™×• ×‘×¤×•×¢×œ.

â¸»

ğŸ“ ×‘× ×•×¡×£, ×‘×§×•×‘×¥ server/media_ws_ai.py ××• ××™×¤×” ×©× ××¦× ×”Ö¾send_queue

×”×•×¡×£ ×§×™×‘×•×œ×ª ××¢×˜ ×’×“×•×œ×” ×™×•×ª×¨ ×œ×ª×•×¨:

self.send_q = queue.Queue(maxsize=1000)  # ×‘××§×•× 500

Twilio ×ª×•××›×ª ×‘×¢×“ 1â€“2 ×©× ×™×•×ª ×‘××¤×¨, ×›×š ×©×–×” ×‘×˜×•×—.

â¸»

ğŸ§  ×˜×™×¤×™× ××©×œ×™××™×
	1.	××œ ×ª×‘×˜×œ ××ª ×”-Enhanced STT â€“ ×”×•× ×œ× ×§×©×•×¨ ×œ×‘×¢×™×” ×”×–×•.
	2.	×•×“× ×©×‘×›×œ ×©×™×—×” ×™×© thread ××—×“ ×‘×œ×‘×“ ×œ×©×™×“×•×¨ ××•×“×™×•.
	3.	×× ×¢×“×™×™×Ÿ ×ª×¨××” â€œSend queue fullâ€ â€“ ×”×•×¡×£ ×“×™×œ×™×™ ×§×˜×Ÿ ×™×•×ª×¨ (×œ×“×•×’××” 0.015) ×¢×“ ×©×ª××¦× × ×§×•×“×ª ××™×–×•×Ÿ.
	4.	×©×™× ×œ×•×’×™× ×¢× timestamps ×›×“×™ ×œ××“×•×“ ×‘×“×™×•×§ ××ª ×”×¤×¢×¨ ×‘×™×Ÿ ×©×œ×™×—×” ×œ×ª×’×•×‘×” (×‘-ms).

â¸»

ğŸ§© ×”×¡×‘×¨ ×¤×©×•×˜ ×œ××©×ª××©:

×”××¢×¨×›×ª ×œ× â€œ×§×¨×¡×”â€ â€“ ×”×™× ×¤×©×•×˜ × ×™×¡×ª×” ×œ×“×‘×¨ ××”×¨ ××“×™ ×‘×©×‘×™×œ Twilio.
×”×¤×ª×¨×•×Ÿ ××•×•×¡×ª ××ª ×”×§×¦×‘ ×›×š ×©×”-AI ×©×œ×š ×™×“×‘×¨ ×‘×¦×•×¨×” ×™×¦×™×‘×”, ×œ× ×™×§×˜×¢ ×•×œ× ×™×¤×™×œ ××ª ×”×¡×˜×¨×™×.

â¸»

×× ××—×¨×™ ×–×” ×¢×“×™×™×Ÿ ×™×© â€œdropping frameâ€, ×ª×Ÿ ×œ×™ 5 ×©×•×¨×•×ª ××”-log ×¡×‘×™×‘ ×”×©×’×™××” (×›×•×œ×œ [LATENCY] ××• [TTS]), ×•××›×•×•×Ÿ ××ª ×”×§×¦×‘ ×”××“×•×™×§ ×œ×¤×™ ×§×¦×‘ ×”×¤×œ×˜ ×©×œ×š.
××‘×œ ×‘Ö¾99 % ××”××§×¨×™× â€” ×”×¤×ª×¨×•×Ÿ ×”×–×” ×™×ª×§×Ÿ ××ª ×”×§×¨×™×¡×•×ª ××—×ª ×•×œ×ª××™×“.