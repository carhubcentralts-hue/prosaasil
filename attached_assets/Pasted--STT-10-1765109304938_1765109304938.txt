אתה צודק לגמרי – זה לא בעיית תמלול פה.
ה־STT נותן “עפולה.” יפה ונקי – ואז המודל ממציא “חולון”. זה 100% לוגיקה מעל ה-STT / פרומפט, לא האודיו.

למה זה קורה?

כרגע, לפי ה־logs, אחרי כל תשובה של המשתמש אתם:
	1.	שולחים את כל ההיסטוריה ל-GPT כדי שיבין city ו-service_type
	2.	נותנים לו גם חופש לנסח את משפט האישור

בלי חוק קשוח שאומר “העיר = בדיוק מה שהמשתמש אמר עכשיו”, המודל מרשה לעצמו “ליפות” ולזרוק עיר אחרת לגמרי (“חולון”).

⸻

הנחיה לסוכן (באנגלית, בלי מילונים / hardcode)

תן את הטקסט הבא ל-Agent בריפליט:

Goal:
Fix the “wrong city in confirmation” bug. When STT transcribes a city correctly (e.g. “עפולה.”) the assistant must never change it to a different city (“חולון”, “צפת”, etc.). No static dictionaries, no hard-coded city lists.

⸻

1. Treat the last city utterance as the source of truth
	1.	In the Realtime handler, right after STT_FINAL arrives, add logic:
	•	If we are currently expecting a city (lead_state.city is empty or city_needs_retry=True)
	•	And the final transcript is short (1–4 words) and Hebrew (e.g. "עפולה.")
→ Then:
	•	Clean it (strip punctuation, remove leading “בעיר”, “באזור”, “אני ב”, etc.).
	•	Set:
	•	lead_state.raw_city = cleaned_text
	•	lead_state.city = cleaned_text
	•	lead_state.city_source = "user_utterance"
	•	lead_state.city_locked = True
	•	lead_state.city_needs_retry = False
	2.	From this moment, the backend considers lead_state.city authoritative until the user explicitly corrects it (“לא, לא עפולה – חיפה”).

⸻

2. Generate confirmation from state, not from GPT’s imagination
	1.	When both city and service_type are available and we want to confirm, do not let GPT “choose” the city name.
	2.	Instead, build the confirmation sentence in code, with a fixed Hebrew template, for example:

city = lead_state.city
category = lead_state.service_type or "שירות מנעולן"
confirmation_text = f"רק מוודא — אתה צריך {category} בעיר {city}, נכון?"


	3.	Send this text to the Realtime API as an explicit assistant message (or response.create with input_text=confirmation_text), so GPT only has to speak it – not decide the city.
	4.	This guarantees that whatever the user said (“עפולה”, “בית שאן”, “קריית אתא”) is exactly what the caller hears back.

⸻

3. Safety check after AI responses (belt & suspenders)

Even with the template, add a small safety layer:
	1.	After receiving an AI response that includes a city name, parse the city from the text (e.g. the word after "בעיר ").
	2.	If the parsed city is different from lead_state.city while city_locked=True, treat the AI text as inconsistent:
	•	Ignore the city inside the AI text.
	•	Immediately regenerate and send a new confirmation using the template from step 2 with lead_state.city.
	3.	Only update lead_state.city when the user says a different city (“לא, לא עפולה – חיפה”), not when the AI says something else.

⸻

4. No dictionaries / no hard-coded cities
	•	Do not load or rely on any static list of Israeli cities.
	•	Work only with:
	•	The literal STT transcript from the last user utterance
	•	Simple string cleaning (“בעיר ”, “אני ב” prefixes)
	•	The conversation correction rule (“לא, לא X – Y” unlocks and replaces the city).

⸻

5. Tests to run

Implement and test with these scenarios:
	1.	User says: "עפולה." → System sets city="עפולה" → Confirmation:
"רק מוודא — אתה צריך שירות מנעולן בעיר עפולה, נכון?"
	2.	User says: "בית שאן." → Confirmation must say "בית שאן", never "צפת" / "טבריה".
	3.	User correction: "לא, לא עפולה – חיפה" →
	•	City unlock + update to "חיפה"
	•	New confirmation uses "חיפה" only.
	4.	Background noise / nonsense: system does not change existing city_locked unless there is a clear correction phrase.

When this is done, city hallucinations (“עפולה” → “חולון”) should completely disappear, while the good STT quality you already have stays exactly כמו שהוא.

אם תיתן לו את זה אחד לאחד – זה עוקף לגמרי את הנטייה של GPT “להמציא עיר” ומחייב אותו לעבוד רק עם מה שאתה שמעת מהלקוח.