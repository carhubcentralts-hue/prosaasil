מובן. כיון שאתה שומע את ה־Greeting אבל אחריו “שקט”, זה אומר: ה־TwiML חוזר תקין, אבל **החלק של ה־Connect→Stream לא נכנס לפעולה** (או נסגר מייד), וה־Fallback לא נתפס בזמן. להלן רשימת **כל** הבעיות האפשריות, סימני הזיהוי שלהן, והפתרון המדויק — לפי הקוד שב־AgentLocator (67):

---

# 0) קיצור דרך—מה לעשות עכשיו (5 צעדים בטוחים)

1. **וודא פריסה עם WS אמיתי**
   Build: `pip install -r AgentLocator/requirements.txt`
   Run:   `python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app`
2. **בדיקת TwiML**
   `curl -s https://<DEPLOY>.replit.app/webhook/incoming_call | sed -n '1,25p'` → חייב להכיל `<Connect><Stream url="wss://<DEPLOY>.replit.app/ws/twilio-media">`.
3. **בדיקת WS ידנית**
   פתח `wss://<DEPLOY>.replit.app/ws/twilio-media` (ב-WebSocket tester/wscat) → חייב לקבל 101 (להתחבר).
   אם לא — קרא סעיפים 1–4 למטה.
4. **הוסף/וודא Route כפול ל־WS**
   ב־`app_factory.py` שיהיו גם `/ws/twilio-media` **וגם** `/ws/twilio-media/`.
5. **הפעל Watchdog Fallback** (אם אין סטרים תוך 8 שניות, או אין frames) → בצע redirect ל־`<Record>` דרך Twilio REST (סעיף 7).

ככה תצא מהמצב של “ברכה ואז שקט” עוד לפני שמחפשים דקויות.

---

# 1) ה־Deployment מריץ קוד ישן / לא עם Eventlet

**סימפטום:** TwiML לפעמים `<Record>` במקום `<Connect><Stream>`, או WS 31920/31924; ב־curl ל־`/webhook/incoming_call` לא רואים `<Stream>`.
**פתרון:**

* עצור Deployment ישן.
* פרוס **דיפלוי חדש** מה־Workspace הנוכחי עם:

  * **Build** `pip install -r AgentLocator/requirements.txt`
  * **Run**  `python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app`
* ודא שה־ENV ב־Deployment מוגדר (ראה סעיף 6).
* בדוק `curl -s https://<DEPLOY>.replit.app/webhook/incoming_call | head` → יש `<Connect><Stream …>`.

> אם אתה חייב לעבוד מייד: העבר את ה־Webhooks של Twilio ל־Workspace (`*.repl.co`) עד שהדיפלוי החדש ירוק.

---

# 2) Handshake נכשל — 31920 / 101 לא חוזר

**סימפטום:** Request Inspector: 31920 (WebSocket Handshake Error), או חיבור ידני ל־`wss://…/ws/twilio-media` לא נפתח.
**גורמים & תיקון:**

* **Eventlet לא בשימוש** → רוץ רק עם `gunicorn -k eventlet` (כמו לעיל).
* **נתיב לא קיים/Redirect** → הוסף גם `/ws/twilio-media/` (עם הסלאש) בנוסף ל־`/ws/twilio-media`.

  ```python
  @sock.route('/ws/twilio-media')
  def ws_a(ws): MediaStreamHandler(ws).run()
  @sock.route('/ws/twilio-media/')
  def ws_b(ws): MediaStreamHandler(ws).run()
  ```
* **דומיין שגוי ב־TwiML** → אל תשתמש ב־host קשיח ישן. בנה מ־`request.host`/`PUBLIC_HOST`:

  ```python
  host = os.getenv("PUBLIC_HOST") or request.host
  wss_host = host.replace("https://","").replace("http://","")
  # wss://{wss_host}/ws/twilio-media
  ```
* **אבטחה/דקורטור על WS** → אל תעטוף WS ב־`@require_twilio_signature` (זה רק ל־HTTP webhooks).

---

# 3) 31951 / 31924 – שימוש שגוי ב־streamSid או פרוטוקול Frames

**סימפטום:** אחרי Start, מתקבלות שגיאות “Invalid stream sid” או “Protocol Error”.
**גורם:** שליחת `mark/clear` ל־Twilio עם `streamSid` “מומצא” (למשל “MZ” + CallSid), או שליחת אירועים אחרים חזרה.
**פתרון:**

* ב־`MediaStreamHandler` שמור `stream_sid` **רק** מאירוע `start`:

  ```python
  if ev == "start":
      self.stream_sid = data["start"]["streamSid"]
  ```
* אם שולחים `mark`/`clear`, שלח תמיד עם **אותו** `stream_sid` (ואל תשלח כלום לפני שקיבלת `start`).
* אל תשלח בחזרה “media/start/stop” – רק `mark/clear` (ואופציונלית `stop`).

---

# 4) Stream לא נפתח… כי TwiML לא באמת מחזיר `<Stream>`

**סימפטום:** Greeting מתנגן, ואז כלום; `incoming_call` מחזיר `<Record>` (לפעמים בגלל דגל/ענף קוד).
**גורמים & פתרון:**

* **Feature flag מכובה** (`enable_calls_stream=false`) → ודא דגלים/לוגיקה ב־incoming\_call לא עוקפת את ה־Stream.
* **ענף “Fallback קבוע” בקוד** → ודא שה־return של `<Connect><Stream>` הוא הענף הפעיל.
* בדוק ידנית עם curl שה־TwiML אכן `<Connect><Stream …>` (ולא `<Record>`).

---

# 5) Stream נפתח, אבל אין Frames (שקט)

**סימפטום:** אין שגיאה, `stream_ended` מגיע מאוחר, WS “נפתח” אבל לא מתקבל `media`.
**גורמים & פתרון:**

* **Route נכון אבל Handler לא רץ** (חריגה בהתחלה) → הוסף לוגים: `WS_CONNECTED`, `WS_START {streamSid}`, `WS_FRAME {len}`; עטוף `run()` ב־try/except עם `logger.exception`.
* **שינוי נתיב אחרי Proxy** → שמור גם `/ws/twilio-media/` (כמו סעיף 2).
* **חסימה ע״י Middleware** → אין החתמה/ולידציה מעל WS.

---

# 6) ENV חסרים בדיפלוי (Deployment ≠ Workspace)

**סימפטום:** ב־Workspace הכל טוב; בדיפלוי — Greeting עובד, אבל אין WS/DB/תמלול.
**פתרון:** הזן **בדיפלוי** את אותם ENV:

* `DATABASE_URL` (Postgres מנוהל; לא SQLite)
* `OPENAI_API_KEY`
* `GOOGLE_APPLICATION_CREDENTIALS` (נתיב או JSON inline שנכתב לקובץ באתחול)
* `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN` (בשביל Redirect בזמן שיחה — סעיף 7)
* אופציונלי: `PUBLIC_HOST` (למשל `ai-crmd.replit.app`)

בדוק `/readyz` על דומיין הדיפלוי → `{"db":"ok", "openai":"ok|disabled", "tts":"ok|disabled"}`.

---

# 7) Fallback לא קורה בזמן (הבעיה שלך בפועל)

**סימפטום:** `stream_ended` מגיע **בסוף** השיחה → מאוחר מדי להפעיל `<Record>` ולכן אין תמלול.
**פתרון חובה:** **Watchdog** שמבצע Redirect ל־`<Record>` **בתוך השיחה**, אם WS לא התחיל/אין Frames.

**צעדים קצרים:**

1. **Registry** (מצב סטרים פר־CallSid) – שמירת `started`/`last_media_at`.
2. ב־WS (`media_ws.py`): ב־`start` → `mark_start(call_sid)`; ב־`media` → `touch_media(call_sid)`.
3. ב־`incoming_call()` → Thread `watchdog(call_sid)`:

   * אם **לא התחיל סטרים** תוך 8 שנ׳ → Twilio REST `calls.update(twiml=<Record…>)`.
   * אם **אין Frames** 6 שנ׳ אחרי start → אותו דבר.
     (דורש `TWILIO_ACCOUNT_SID/AUTH_TOKEN` ב־ENV דיפלוי)

> זה מוודא שתמיד תקבל תמלול—או בסטרים, או דרך הקלטה—ולא תישאר “שקט”.

---

# 8) DB לא נרשם (CallLog ריק)

**סימפטום:** אין רשומות שיחה למרות שהברכה מושמעת.
**פתרון:**

* ב־`/webhook/incoming_call` בצע **INSERT מיידי** עם `call_sid, from, to, status='ringing', source='stream'` (וכמובן commit).
* ב־`/webhook/call_status` בצע **UPDATE** לסטטוס (commit).
* ב־`/webhook/stream_ended` → `status='stream_closed'`.
* ב־`/webhook/handle_recording` → `transcript` (או בטבלת תמלולים נפרדת).
* אל תיפול ל־500 ב־webhooks; תמיד 200/204 ולוג שגיאה.

---

# 9) הקלטה נקלטת אבל התמלול לא נכתב

**סימפטום:** `/webhook/handle_recording` נקרא, אבל אין טקסט ב־DB.
**פתרון:**

* הורד הקלטה עם timeout+retries; שלח ל־Whisper `language="he"`; שמור ל־DB; commit.
* לוג INFO: `recording_transcribed chars=NNN` / ERROR עם stacktrace.

---

# 10) תלויות/הרצה (Replit) מפריעות

**סימפטום:** “App is in recovery” / build מפוצל (fla==…), או נופל על ניקס.
**פתרון:**

* קובץ אחד `AgentLocator/requirements.txt` (לא שרידות של server/requirements כפול).
* Build: `pip install -r AgentLocator/requirements.txt` (לא מחרוזת ארוכה שמתפצלת).
* Run: `gunicorn -k eventlet … AgentLocator.main:app`.
* אל תפעיל במקביל NPM על אותו פורט. אם יש Node (וואטסאפ) — פורט 8000 בנפרד.

---

# 11) לוגים — כדי לדעת *איפה* זה נתקע

* HTTP:

  ```python
  @app.before_request
  def _req_log(): current_app.logger.info("REQ", extra={"path":request.path,"method":request.method})
  @app.after_request
  def _res_log(r): current_app.logger.info("RES", extra={"path":request.path,"status":r.status_code}); return r
  ```
* WS: `WS_CONNECTED`, `WS_START {streamSid}`, `WS_FRAME {len}`, `WS_STOP`, `WS_HANDLER_ERROR`.

בדקה: אם אין `WS_START` → WS לא נפתח (חזור לסעיפים 1–4). אם יש `WS_START` אבל אין `WS_FRAME` → מדיה לא זורם/נדחה → Watchdog יפעיל `<Record>`.

---

## בדיקת מסלול מלא (Golden Path)

1. `GET /readyz` → “ok”.
2. `POST /webhook/incoming_call` (curl) → `<Connect><Stream …>`.
3. `wss://…/ws/twilio-media` נפתח (101).
4. שיחה אמיתית:

   * רואים `WS_START`, ואז `WS_FRAME` — תמלול רץ.
   * אם אין `WS_START`/`WS_FRAME` → Watchdog מצית `<Record>`; רואים ב־Inspector `handle_recording`, וב־DB `transcript`.

---

אם תרצה, אנסח לך **פאטצ’ים מדויקים** (קוד להדבקה) ל־`stream_state.py`, לוגיקת ה־WS, ו־`incoming_call()` עם ה־Watchdog—כדי שתריץ וזה פשוט יעבוד גם כשיש “ברכה ואז שקט”.
