ברור. אתה צודק — מה שצריך כאן זה פתרון על, לא “רשימה מפגרת של ערים”.
אתה צריך מערכת חכמה, יציבה, מאוד מדויקת, שלא תתבלבל בין בית שאן / בית שמש / בת ים / בית דגן / ביתר / בית אל / בני עי”ש / בני ברק וכו’.

ולכן הנה ההנחיה האמיתית, כמו שסגן ארכיטקט היה מגדיר — שתעביר לסוכן שלך as-is.

⸻

🚀 Super-Instructions: Hebrew City Recognition Engine (Production Grade)

פתרון על לרשימת ערים, נרמול, מניעת טעויות, ושיפור תמלול.

⸻

🔥 מטרה

להוסיף מערכת אמיתית, ברמת פרודקשן, שמזהה, מנרמלת ומאמתת כל עיר בישראל בדיוק מקסימלי —
בלי להעמיס על ה-AI ובלי לגרום לבלבול.

המערכת חייבת:
	1.	לזהות נכון גם כש־STT טועה (“בית שאן” → “בית שמש”).
	2.	לא לנחש כשיש ספק — לבקש מהלקוח שוב.
	3.	לתמוך באלפי שמות בלי להכניס הכל לפרומפט (אסור!!!).
	4.	להעביר ל-Webhooks נתונים מנורמלים, עקביים ואמינים.

⸻

✅ הפתרון האמיתי: City Normalization Engine + Confidence Model

⸻

1. אל תכניס רשימת ערים ל-NLP prompt

זה גורם לבלגן, עומס קוגניטיבי, וקשיים במודלים.

במקום זה —
ה-AI לא צריך לדעת שום רשימה.
ה-AI רק צריך לאסוף טקסט מהלקוח —
ואתה בצד השרת מעבד ומתקן.

⸻

2. בצד השרת: יצירת “City Recognition Engine”

תן לו לבנות קובץ:

server/services/city_engine.py

שמכיל שלושה חלקים:

⸻

🔹 2.1 רשימת כל הערים בישראל (מקורית, מלאה, עדכנית)

ולא “כמה ערים”.

הוא יביא רשימה מלאה מתוך:
	•	קובץ JSON מוכן שמכיל את כל ישובי ישראל
	•	כולל: ערים, מועצות מקומיות, מועצות אזוריות, יישובים קטנים

זה ~ 1,200–1,400 שמות.

דוגמה לאופן שמירה (לא להכניס לפרומפט):

with open("data/israel_cities.json", "r", encoding="utf-8") as f:
    ALL_CITIES = json.load(f)


⸻

🔹 2.2 City Normalizer – מנוע נרמול חכם

הוא צריך לבנות פונקציה:

def normalize_city(raw_city: str) -> dict:

שמחזירה:

{
  "canonical": "בית שאן",
  "raw": "בית שמש",
  "confidence": 0.42,
  "needs_confirmation": true
}

איך זה עובד?
	1.	ניקוי טקסט: lowercase, הסרת ניקוד, פיסוק, הטיות.
	2.	בדיקה מדויקת — התאמה מלאה.
	3.	בדיקת “aliases”:
	•	“ירושליים”, “י-ם”, “י’ם”, “ירושלים עיר הקודש” → “ירושלים”
	4.	fuzzy matching באמצעות RapidFuzz:

score = fuzz.WRatio(cleaned, city)

	5.	לוגיקה חכמה:

דמיון	פעולה
≥ 92%	בטוח — קבלה
85–92%	ייתכן — דרוש אישור לקוח
< 85%	לא בטוח — בקשה לחזרה על העיר

	6.	טיפול מיוחד לערים דומות בצליל:

	•	בית שאן / בית שמש / בית דגן
	•	בת ים / בית ים (?)
	•	לוד / רמלה
	•	חולון / חורון
	•	נתניה / נתנאל

נבדוק:
	•	מרחק פונולוגי
	•	מספר מילים (“בית” + “משהו”)
	•	בדיעבד, אם יש שתי ערים קרובות, נכריח אישור.

⸻

🔹 2.3 City Confirmation Manager

אם השרת מזהה שהעיר לא חד-משמעית:

if needs_confirmation:
    ai.mustAskAgain("אני לא בטוחה בשם העיר, תוכל לחזור עליו בבירור?")

ה-AI לא מנחש.
הוא לא אומר “אתה צריך שירות בבת ים?”
הוא פשוט מבקש חזרה.

⸻

🔥 3. אינטגרציה עם ה-AI: הנחיה קצרה ולא מעמיסה

בפרומפט עצמו (מאוד חשוב!):

אסור להכניס רשימת ערים.
אסור להכניס יותר מדי טקסט.

מוסיפים רק משפט אחד:

“כשלקוח אומר עיר, אם יש ספק או שמדובר בשם דומה לעיר אחרת — אל תנחשי. בקשי מהלקוח לחזור שוב על שם העיר בצורה ברורה.”

זהו.
ה-AI לא מבצע בחירה.
השרת כן.

⸻

🔥 4. השרת מנהל הכל — AI נקי

ה-AI רק:
	•	מקשיב
	•	מדבר
	•	מחזיר raw_city

השרת:
	•	מנרמל
	•	בודק דמיון
	•	מזהה טעויות
	•	מסמן אם צריך אישור
	•	שומר את canonical_city

⸻

🔥 5. Webhook מקבל נתונים ברמה הכי גבוהה:

{
  "city": "בית שאן",
  "city_raw": "בית שמש",
  "city_confidence": 0.42,
  "city_needs_confirmation": true
}


⸻

⚡ עכשיו — זה פרודקשן אמיתי.

אין ניחושים.
אין טעויות.
אין “בית שאן → בית שמש”.
אין בלבולים.
הכל אמין ובטוח.

⸻

📎 הנחיית על להעביר לסוכן שלך (ככה, אחד לאחד):

Super Instruction — Build the Hebrew City Recognition Engine
	1.	Add a new module: server/services/city_engine.py
	2.	Load a full official list of ALL Israeli cities/settlements from JSON (1,200+ names)
	3.	Implement a normalize_city engine with:
	•	text cleaning
	•	alias detection
	•	phonetic corrections
	•	fuzzy matching with RapidFuzz
	•	disambiguation logic for similar-sounding cities
	•	confidence scoring
	•	needs_confirmation output
	4.	Modify the call flow so the AI NEVER decides the city.
It always sends raw text → and the server determines canonical city.
	5.	If needs_confirmation == True
→ instruct the AI to re-ask the caller politely.
	6.	Store both raw_city & canonical_city in DB + Webhook.
	7.	Add logging for debugging.
	8.	Keep the AI prompt short — only include:
“אם שם העיר לא ברור — אל תנחשי, בקשי שוב.”

זה ייתן:
✔ דיוק מקסימלי
✔ מניעת טעויות קריטיות
✔ ניהול פרודקשן אמיתי
✔ יציבות לאורך זמן

⸻

אם אתה רוצה — אני גם יכול לכתוב לך את הקוד כולו, כולל JSON של כל הערים בארץ.