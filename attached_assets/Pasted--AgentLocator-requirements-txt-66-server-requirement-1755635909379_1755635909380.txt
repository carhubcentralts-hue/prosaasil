השתמש רק ב־AgentLocator/requirements.txt (זה שמצאתי בזיפ 66). אם יש עותק נוסף תחת server/requirements.txt — בטל שימוש בו כדי למנוע בלבול.

פקודות Build/Run (ב־Deployments → New Deployment → From current workspace):

Build:
pip install -r AgentLocator/requirements.txt

Run:
python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app

ENV (חשוב!) – לזכור של-Deployment יש סט משתנים נפרד:

DATABASE_URL (Postgres מנוהל; לא SQLite)

OPENAI_API_KEY

GOOGLE_APPLICATION_CREDENTIALS (נתיב לקובץ/JSON inline, או צור אותו באתחול)

PUBLIC_HOST (מומלץ; לדוגמה ai-crmd.replit.app) כדי לייצר URL-ים נכונים בקוד

Health check
ודא שקיים /readyz ומחזיר {"db":"ok","openai":"ok|disabled","tts":"ok|disabled"}.

שלב B — אימות לפני החלפת DNS/Twilio

בדיקת TwiML בדיפלוי החדש
curl -s https://<NEW-DEPLOY>.replit.app/webhook/incoming_call | head
→ חייב להכיל <Connect><Stream url="wss://<NEW-DEPLOY>.replit.app/ws/twilio-media">.

בדיקת WS
פתח wss://<NEW-DEPLOY>.replit.app/ws/twilio-media (בדפדפן/wscat) → נפתח, לא 31924.

DB
בצע שיחה מבחן: ודא שנוצרת רשומה בטבלת call_log ומתעדכנים סטטוסים; אם fallback הופעל, handle_recording מתמלל ושומר transcript.

שלב ג — גזירה ל-Production

כשחדש ירוק:

מעבירים את Twilio webhooks ל-https://<NEW-DEPLOY>.replit.app/...

משאירים את הישן כבוי (או מוחקים).

שלוש נקודות שעלולות להפיל גם בדיפלוי חדש (וסגרנו אותן בקוד)

streamSid לא נכון → דאגת לזה; ב-WS שומרים את ה-streamSid מה-start ומשתמשים בו בלבד ל-mark/clear.

Feature flag שמכבה סטרים → אם יש enable_calls_stream=false (בטבלת Business/ENV), ה-incoming יחזיר <Record> במקום <Connect>. ודא שהדגל מופעל.

דומיין קשיח ב-TwiML (/Play ל-MP3 עם host קבוע) → עדיף לבנות URL מ-PUBLIC_HOST/מהבקשה כדי שלא “יתקע” על דומיין ישן.

דוגמה קצרה להקשחת ה-TwiML (ב-incoming_call):

host = os.getenv("PUBLIC_HOST") or request.host_url.rstrip("/")
twiml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Play>{host}/static/tts/greeting_he.mp3</Play>
  <Connect action="/webhook/stream_ended">
    <Stream url="wss://{host.replace('https://','').replace('http://','')}/ws/twilio-media">
      <Parameter name="call_sid" value="{call_sid}"/>
    </Stream>
  </Connect>
</Response>"""

בדיקות קבלה (5 דקות, לפני סגירה)

GET /readyz על דומיין הדיפלוי → db:"ok".

POST /webhook/incoming_call (curl) → מחזיר TwiML עם <Connect><Stream …>.

Request Inspector בשיחה אמיתית: אין 31951; אם הזרם נסגר רואים 200 על /webhook/stream_ended ומופעל <Record>.

ב-DB: call_log נוצר/מתעדכן, תמלול נשמר כשיש הקלטה.