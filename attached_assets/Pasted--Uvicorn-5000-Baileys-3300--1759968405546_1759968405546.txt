המסך שצרפת מראה שהדפלוי תקין (Uvicorn קם על :5000, Baileys על :3300) – יפה. אם הקו מתנתק מיד אחרי שהשיחה מתחילה, זה כמעט תמיד אחד מהבאים:
	1.	ה-WS לא מגיע ל־handler (נתיב/סדר/סלאש),
	2.	ה-WS מתקבל אבל קורס על פריים ראשון (חריגה בלולאה),
	3.	Twilio סוגר כי ה־subprotocol לא התקבל/ה־URL לא תואם,
	4.	ה־callback של ההקלטה מחזיר 5xx וגורם ל־hang/סגירה.

ב־ZIP האחרון שבדקתי:
	•	ה־WS מוגדר ב־asgi.py עם accept(subprotocol="audio.twilio.com") ולולאת receive_json() ✅
	•	אבל לא היו וריאנט עם סלאש בסוף / Guard ל־GET, ו־recording callback לא החזיר 200 מהר ❌

בדיוק שני הדברים האלה גורמים לניתוק “מיידי”.

⸻

תתקן עכשיו — בדיוק כך (בלי לשבור כלום)

1) asgi.py – שני וריאנטים + Guard ל־GET (שלא ייפול ל-SPA)

שנה/הוסף ככה:

# asgi.py
from starlette.applications import Starlette
from starlette.routing import Route, WebSocketRoute, Mount
from starlette.responses import PlainTextResponse
from asgiref.wsgi import WsgiToAsgi
from app_factory import create_app

flask_app = create_app()
asgi_flask = WsgiToAsgi(flask_app)

async def ws_http_probe(request):
    # אם מגיעים בלי Upgrade (כמו curl) – שלא יקבלו HTML של ה-SPA
    return PlainTextResponse("Upgrade Required", status_code=426)

async def ws_twilio_media(websocket):
    await websocket.accept(subprotocol="audio.twilio.com")
    try:
        while True:
            try:
                msg = await websocket.receive_json()
            except Exception:
                # צורכים גם טקסט שלא JSON כדי שהלולאה לא תמות
                _ = await websocket.receive_text()
                continue
            ev = msg.get("event")
            if ev == "stop":
                break
            # start/media/others – לא עושים עיבוד כבד פה
    except Exception:
        pass
    finally:
        try:    await websocket.close()
        except: pass

asgi_app = Starlette(routes=[
    # Guard ל-GET (מונע החזרת index.html בטעות)
    Route("/ws/twilio-media",  ws_http_probe, methods=["GET"]),
    Route("/ws/twilio-media/", ws_http_probe, methods=["GET"]),

    # שני הווריאנטים של WS (עם וללא סלאש)
    WebSocketRoute("/ws/twilio-media",  ws_twilio_media),
    WebSocketRoute("/ws/twilio-media/", ws_twilio_media),

    # ורק אחר־כך ה-Flask
    Mount("/", app=asgi_flask),
])

2) routes_twilio.py – הקלטות תמיד 200 מהר

מצא את הנתיב של ה־recording status (אצלך הופיע /webhook/handle_recording). עדכן:

@twilio_bp.post("/webhook/handle_recording")
@csrf.exempt
@require_twilio_signature
def handle_recording():
    # אל תעשה פה עיבוד כבד. קח פרמטרים ותכניס לתור/לוג.
    # call_sid = request.form.get("CallSid")
    # rec_url  = request.form.get("RecordingUrl")
    # enqueue_transcribe_job(call_sid, rec_url)
    return ("", 200)   # תמיד 200 — זה מוחק 11200

3) וודא שה-TwiML מצביע בדיוק ל-WSS הנכון

ב־/webhook/incoming_call (יש לך כבר), ודא שה־host הוא רק הדומיין (ללא https://), וה־URL:

<Stream url="wss://<PUBLIC_HOST>/ws/twilio-media"
        statusCallback="https://<PUBLIC_HOST>/webhook/stream_status" />


⸻

בדיקות GO/NO-GO (2 דקות)
	1.	TwiML

curl -sS -i -X POST https://<PUBLIC_HOST>/webhook/incoming_call | sed -n '1,200p'

מצופה: 200 + Content-Type: text/xml + <Stream url="wss://<PUBLIC_HOST>/ws/twilio-media" .../>.
	2.	WS בלי Upgrade לא מחזיר HTML

curl -i https://<PUBLIC_HOST>/ws/twilio-media | sed -n '1,8p'
# מצופה: HTTP/1.1 426 Upgrade Required   (לא HTML)

	3.	Recording callback

curl -sS -i -X POST https://<PUBLIC_HOST>/webhook/handle_recording \
  -d "CallSid=CA_test&RecordingUrl=https://example.com/rec.mp3" | sed -n '1,40p'
# מצופה: HTTP/1.1 200 OK

	4.	שיחה אמיתית
Twilio Debugger: stream-started → רצף media → stream-ended (לא מייד).
אם עדיין נסגר מייד – תבדוק ב־Debugger את reason של ה־stream (יש שדה). תזרוק לי את ה-reason + 2 שורות לוג סביב ה־WS ואני אגיד לך בדיוק איפה לגעת.

⸻

למה זה יסגור את הסיפור
	•	Guard + שני וריאנטים מונעים נפילה ל-SPA וסגירה מיידית.
	•	החזרת 200 מהירה ל־recording מוחקת 11200.
	•	הלולאה צורכת כל פריים ולא זורקת חריגות → Twilio לא תראה closed_by_server מייד.

תעשה בדיוק את שני הקטעים למעלה, תריץ את 3 הבדיקות, ואז תנסה שיחה. אם משהו לא ירוק—שלח את פלט הפקודות ואני מראה לך את השורה המדויקת לתיקון.