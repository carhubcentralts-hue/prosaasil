×œ×”×œ×Ÿ ×”× ×—×™×” **××§×™×¤×” ××—×ª, ×¡×’×•×¨×” ×•×‘×¨×•×¨×”** â€” ××•×ª×××ª ×œÖ¾React ×‘×¦×“ ×”×œ×§×•×— ×•×œ×’×¨×¡×” ×”××—×¨×•× ×” ×©×©×œ×—×ª â€” ×©×ª×’×¨×•× ×œ×¡×•×›×Ÿ/××¤×ª×— ×©×œ×š ×œ×ª×§×Ÿ *×‘×××ª* ××ª ×›×œ ××” ×©×¦×¨×™×š: ×©×™×—×•×ª Twilio, CRM (×•×™×–×•××œ×™ + ×¤×•× ×§×¦×™×•× ×œ×™), WhatsApp, ××‘×˜×—×” ×•×¤×¨×™×¡×”. ×”×”× ×—×™×” ×›×•×œ×œ×ª ×§×˜×¢×™ ×§×•×“ ×œ×”×“×‘×§×”, ×‘×“×™×§×•×ª ×‘×™× ×™×™× ×•Ö¾Definition of Done ×—×“Ö¾××©××¢×™. ×ª×Ÿ ×œ×• ××ª ×–×” ×›××• ×©×”×•×.

---

# ğŸ”’ ×¤×¨×”Ö¾×¨×™×§×•×•×™×–×™×˜ (×œ×¤× ×™ ×©×•×¨×” ×©×œ ×§×•×“)

1. ×œ×¢×‘×•×“ ×¢×œ ×¢× ×£ ×—×“×©:
   `git checkout -b fix/full-prod-v54`
2. ×§×•×‘×¥ ENV ×œ×¤×¨×•×“ (×œ×¤×™ ×”×“×•××™×™×Ÿ ×©×œ×š):

   ```
   FLASK_ENV=production
   PUBLIC_HOST=https://YOUR_DOMAIN
   PORT=5000
   CORS_ORIGINS=https://YOUR_DOMAIN
   TWILIO_ACCOUNT_SID=...
   TWILIO_AUTH_TOKEN=...
   DATABASE_URL=...
   JWT_SECRET=...
   GOOGLE_APPLICATION_CREDENTIALS=/secrets/google_tts_sa.json
   VAPID_PUBLIC_KEY=...
   VAPID_PRIVATE_KEY=...
   ```
3. **××™×Ÿ Fallback** ×œ×©×•× ×“×•××™×™×Ÿ ×™×©×Ÿ ×‘×§×•×“. ×× ××™×Ÿ `PUBLIC_HOST` â†’ × ×›×©×œ (Fail Fast), ×œ× â€œ× ×•×¤×œ×™×â€ ×œÖ¾replit ×™×©×Ÿ.

---

# A) ××•×§×“ ×©×™×—×•×ª â€” ×ª×™×§×•×Ÿ ××œ×, ×§×‘×•×¢ ×•×™×¦×™×‘

## A1. Webhooks ××—×–×™×¨×™× Contentâ€‘Type × ×›×•×Ÿ ×•×ª×©×•×‘×” ××”×™×¨×”

**`server/routes_twilio.py`** â€” ×”×—×œ×£/×¢×“×›×Ÿ ×›×š:

```python
from flask import Blueprint, Response, request, current_app
from urllib.parse import urljoin
import os, logging

twilio_bp = Blueprint("twilio_bp", __name__, url_prefix="")

def abs_url(path: str) -> str:
    host = (current_app.config.get("PUBLIC_HOST") or os.getenv("PUBLIC_HOST") or "").rstrip("/")
    if not host:  # ×œ× × ×•×¤×œ×™× ×œ×“×•××™×™×Ÿ ×™×©×Ÿ
        raise RuntimeError("PUBLIC_HOST not set. Set PUBLIC_HOST=https://your-domain")
    return urljoin(host + "/", path.lstrip("/"))

@twilio_bp.post("/webhook/incoming_call")
def incoming_call():
    greeting = abs_url("/server/static/voice_responses/welcome.mp3")  # ××• ×œ×¤×™ ×¢×¡×§
    xml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Play>{greeting}</Play>
  <Pause length="1"/>
  <Record action="/webhook/handle_recording"
          method="POST"
          maxLength="30" timeout="5" finishOnKey="*"
          transcribe="false" />
</Response>"""
    return Response(xml, mimetype="text/xml", status=200)

@twilio_bp.post("/webhook/handle_recording")
def handle_recording():
    # ××œ ×ª×¢×©×” ×›××Ÿ ×ª××œ×•×œ ×›×‘×“; ×¨×§ ×œ×•×’×™×§×” ×§×œ×” + ×ª×•×¨/Thread
    form = request.form.to_dict()
    current_app.logger.info("handle_recording form=%s", form)
    # enqueue_recording(form["RecordingUrl"], form.get("CallSid"), ...)

    xml = """<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say language="he-IL">×ª×•×“×”, ×§×™×‘×œ× ×• ××ª ×”×”×•×“×¢×”.</Say>
  <Hangup/>
</Response>"""
    return Response(xml, mimetype="text/xml", status=200)

@twilio_bp.post("/webhook/call_status")
def call_status():
    return ("OK", 200, {"Content-Type": "text/plain"})
```

## A2. ××™××•×ª ×—×ª×™××ª Twilio (××‘×˜×—×” + ×“×™×‘××’)

**`server/twilio_verify.py`**:

```python
import os
from flask import request, abort
from twilio.request_validator import RequestValidator

def require_twilio_signature(fn):
    def wrapper(*args, **kwargs):
        token = os.getenv("TWILIO_AUTH_TOKEN")
        if not token:  # ×‘×¤×™×ª×•×— ××¤×©×¨ ×œ×“×œ×’
            return fn(*args, **kwargs)
        validator = RequestValidator(token)
        url = (os.getenv("PUBLIC_HOST","").rstrip("/") + request.full_path).rstrip("?")
        sig = request.headers.get("X-Twilio-Signature","")
        if not validator.validate(url, request.form, sig):
            abort(403)
        return fn(*args, **kwargs)
    return wrapper
```

×”×•×¡×£ ×”×“×§×•×¨×˜×•×¨ ×œ×©×œ×•×©×ª ×”× ×ª×™×‘×™×.

## A3. ×‘×¨×›×” ××•×ª×××ª ×¢×¡×§

×‘Ö¾`incoming_call` ×©×œ×•×£ `business_id` ×œ×¤×™ ×”Ö¾`To`/××¡×¤×¨, ×•×‘× ×” × ×ª×™×‘:

```
/server/static/voice_responses/{business_id}/greeting.mp3
```

×× ××™×Ÿ â€” `welcome.mp3`.

## A4. MP3 â€” × ×’×™×©×•×ª ×•×¡×•×’Ö¾×ª×•×›×Ÿ

×•×“× ×©×”×§×•×‘×¥ ×§×™×™× ×•× ×’×™×©:

```bash
curl -I https://YOUR_DOMAIN/server/static/voice_responses/welcome.mp3
# ×—×™×™×‘: 200 + Content-Type: audio/mpeg
```

×× Nginx ×œ× ××—×–×™×¨ `audio/mpeg`, ×”×•×¡×£:

```
types { audio/mpeg mp3; }
```

## A5. ×‘×“×™×§×•×ª ×‘×™× ×™×™× ×—×•×‘×” (×œ×¤× ×™ × ×™×¡×™×•×Ÿ ×©×™×—×”)

```bash
curl -sS -X POST https://YOUR_DOMAIN/webhook/incoming_call -H "Accept: text/xml" | head
curl -sS -X POST https://YOUR_DOMAIN/webhook/call_status -o /dev/null -w "%{http_code}\n"
curl -I https://YOUR_DOMAIN/server/static/voice_responses/welcome.mp3
```

## A6. Twilio Console (××¡×¤×¨ â†’ Voice)

* **A CALL COMES IN** â†’ Webhook (POST) â†’ `https://YOUR_DOMAIN/webhook/incoming_call`
* **Call Status Changes** â†’ Webhook (POST) â†’ `https://YOUR_DOMAIN/webhook/call_status`
* **×œ××—×•×§** ×›×œ Fallback URL ×™×©×Ÿ.

---

# B) Backend CRM â€” API ×™×¦×™×‘, ××—×™×“ ×•××•×›×Ÿ ×œÖ¾UI

## B1. ×¤××’â€™×™× ×¦×™×” ××—×™×“×”

×‘×›×œ ××§×•× ×‘×§×•×“ **××™×Ÿ** `customers_paginate`. ×™×© ×¨×§ ×¤×•× ×§×¦×™×” ××—×ª, ×œ×“×•×’××”:

```python
def customers_paginated(query, page:int, limit:int):
    # ×”×—×–×¨ ×ª××™×“: results, page, pages, total
    ...
```

×›×œ Endpoint ×©××—×–×™×¨ ×¨×©×™××•×ª (×œ×§×•×—×•×ª/×—×©×‘×•× ×™×•×ª/×—×•×–×™×/×—×ª×™××•×ª/×©×™×—×•×ª) ××—×–×™×¨ ××‘× ×”:

```json
{ "results": [...], "page": 1, "pages": 4, "total": 100 }
```

×‘×“×™×§×”:

```bash
curl -sS "https://YOUR_DOMAIN/api/crm/customers?page=1&limit=25"
```

## B2. Timeline ×××•×—×“ ×œ×œ×§×•×—

**`server/api_timeline.py`**:

```python
@timeline_bp.get("/customers/<int:customer_id>/timeline")
def timeline(customer_id):
    # ××™×¡×•×£ ××™×¨×•×¢×™× ×××™×ª×™×™×: calls/wa/tasks/contracts/invoices
    # ×××•×™×Ÿ ×‘×™×¨×™×“×ª ×ª××¨×™×š
    return jsonify({"items": items})
```

## B3. ×‘×¨×™××•×ª + ×’×¨×¡×” + ×œ×•×’ ×©×™×˜×ª×™

×‘Ö¾`app_factory.create_app`:

```python
@app.get("/api/health")
def health(): return {"ok": True}

@app.after_request
def add_rev(resp):
    resp.headers["X-Revision"] = os.getenv("APP_REV","dev")
    return resp
```

××•××œ×¥ ×œ×”×•×¡×™×£ request/response logger (×œ×¨××•×ª ×¡×˜×˜×•×¡ ×•Ö¾Contentâ€‘Type ×œ×›×œ ×‘×§×©×”).

---

# C) Frontend (React) â€” CRM ×•×™×–×•××œ×™ ×¢×•×‘×“ (××™× ×™××•× ××§×¦×•×¢×™)

## C1. API Client ××—×™×“

**`client/src/lib/api.ts`**:

```ts
const base = import.meta.env.VITE_API_URL || window.location.origin;
export async function api(path: string, init?: RequestInit) {
  const res = await fetch(base + path, {
    credentials: "include",
    headers: { "Content-Type": "application/json", ...(init?.headers||{}) },
    ...init,
  });
  if (!res.ok) throw new Error(await res.text());
  return res.headers.get("content-type")?.includes("application/json")
    ? res.json()
    : res.text();
}
```

## C2. ×˜×‘×œ××•×ª TanStack â€” ×œ×¤×—×•×ª ×‘×˜×‘×œ×ª ×œ×§×•×—×•×ª

* ×”×•×¡×£ ×ª×œ×•×ª: `@tanstack/react-table`
* ×§×•××¤×•× × ×˜×” ×›×œ×œ×™×ª `DataTable` ×¢×: ××™×•×Ÿ, ×¡×™× ×•×Ÿ, Toggle Columns, ×¦×¤×™×¤×•×ª, Export CSV, NoData, Skeleton.
* ×”×—×œ×£ ××ª ×˜×‘×œ×ª ×œ×§×•×—×•×ª ×œ×©×™××•×© ×‘Ö¾DataTable.

## C3. ×›×¨×˜×™×¡ ×œ×§×•×— (Tabs ×—×™×™×)

× ×ª×™×‘×™×:

* `/crm/customers` â€” ×˜×‘×œ×”
* `/crm/customers/:id` â€” ×›×¨×˜×™×¡ ×¢× Tabs:

  * Overview (×¤×¨×˜×™ ×œ×§×•×— + ×¤×¢×•×œ×•×ª ××”×™×¨×•×ª)
  * Timeline (×§×•×¨× `/api/customers/:id/timeline`)
  * Calls (××¦×™×’ ×”×§×œ×˜×•×ª + ×ª××œ×•×œ; ×›×¤×ª×•×¨ Play ×××™×ª×™)
  * WhatsApp (×¦â€™××˜ ×××™×ª×™ ×œ×œ×§×•×—)
  * Invoices (PDF Link, ×¡×˜×˜×•×¡)
  * Contracts/Signatures (×¡×˜×˜×•×¡ + ×¦×¤×™×™×”)
  * Tasks (×™×¦×™×¨×”/×¡×’×™×¨×”)

NoData/Skeleton ×‘×›×œ ×˜××‘.

## C4. RTL ×•Ö¾Theme ××—×™×“

* `html dir="rtl"`
* ×¤×•× ×˜ â€œAssistantâ€
* tokens.css (×¦×‘×¢×™×, spacing) ×˜×¢×•×Ÿ ×‘×›×œ ×”××¤×œ×™×§×¦×™×”.

---

# D) ×”×ª×¨××•×ª ×•××©×™××•×ª (Realtime + Push, ×œ×œ× ×™×™×¨×•×˜ webhooks)

## D1. Socket.IO ×œ×œ×§×•×—

**`client/src/lib/socket.ts`**:

```ts
import { io } from "socket.io-client";
export const socket = io("/", { path: "/ws" });
```

**`client/src/hooks/useTaskDue.ts`**:

```ts
import { useEffect } from "react";
import { socket } from "@/lib/socket";
export function useTaskDue(onDue:(p:any)=>void){
  useEffect(()=>{ socket.on("task:due", onDue); return ()=>socket.off("task:due", onDue); },[onDue]);
}
```

`TaskDueModal.tsx` â€” ××¡×š ××œ× ×¢× Call/WA/Snooze/Done.

## D2. Service Worker â€” Push ×‘×œ×‘×“

**`client/public/sw.js`**:

```js
self.addEventListener('install', e=>self.skipWaiting());
self.addEventListener('activate', e=>self.clients.claim());
self.addEventListener('push', e=>{
  const data = e.data?.json()||{};
  e.waitUntil(self.registration.showNotification(data.title||'AgentLocator',{ body:data.body, data }));
});
```

> **××™×Ÿ** fetchâ€‘handler (×›×“×™ ×œ× ×œ×©×‘×•×¨ `/webhook/*` ××• ×§×‘×¦×™ `.mp3`). ×× ×‘×›×œ ×–××ª ××•×¡×™×¤×™× ×‘×¢×ª×™×“â€”×œ×”×—×¨×™×’ ××•×ª×.

---

# E) ××‘×˜×—×” (Baseline ××•×¦×¨, ×œ× â€œ×—××¤×¨â€)

1. **Twilio Signature** ××•×¤×¢×œ (×¡×¢×™×£ A2).
2. **CORS** â€” ×¨×§ ×”×“×•××™×™×Ÿ ×©×œ×š:
   `CORS(app, origins=[os.getenv("CORS_ORIGINS")], supports_credentials=True)`
3. **Cookies**:
   `SESSION_COOKIE_SECURE=True`, `SESSION_COOKIE_HTTPONLY=True`, `SESSION_COOKIE_SAMESITE="Lax"`
4. **JWT** ×§×¦×¨ + Refresh Rotation (×× ×™×© Login).
5. **Rate Limiting** ×œÖ¾`/webhook/*` ×•Ö¾`/auth/*` (flask-limiter).
6. **×¡×•×“×•×ª** â€” ×‘Ö¾ENV ×‘×œ×‘×“. ×›×œ ××¤×ª×— ×©× ×—×©×£ ×‘×¢×‘×¨ â€” **×œ×”×—×œ×™×£**.
7. **Nginx/Proxy** â€” ×—×•×‘×” HTTPS ×ª×§×™×Ÿ (Letâ€™s Encrypt), ××™×Ÿ Redirect ×œ×§×•× ×¤×™×’ ×™×©×Ÿ.

---

# F) ×¤×¨×™×¡×” × ×›×•× ×” (×¨×§ ××”Ö¾root)

## F1. × ×§×•×“×ª ×¨×™×¦×”

* Dev: `python -m server.main`
* Prod (Socket.IO):
  `gunicorn --worker-class eventlet -w 1 -b 0.0.0.0:$PORT server.main:app`

## F2. Nginx (×“×•×’××”)

```nginx
location = /index.html { add_header Cache-Control "no-store, must-revalidate"; }
location /static/ { add_header Cache-Control "public, max-age=31536000, immutable"; try_files $uri =404; }
location /ws { proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade"; }
```

## F3. ×©×‘×™×¨×ª Service Worker ×‘×§×¦×” ×”×œ×§×•×—

×‘×¨×™×©×•×: `navigator.serviceWorker.register('/sw.js?v=2')`

---

# G) ×‘×“×™×§×•×ª ×§×‘×œ×” (×—×•×‘×” ×œ×¦×¨×£ ×”×•×›×—×•×ª)

1. **Twilio**

   ```bash
   curl -sS -X POST https://YOUR_DOMAIN/webhook/incoming_call -H "Accept: text/xml" | head
   curl -sS -X POST https://YOUR_DOMAIN/webhook/call_status -o /dev/null -w "%{http_code}\n"
   curl -I https://YOUR_DOMAIN/server/static/voice_responses/welcome.mp3
   ```

   ×•×‘Ö¾Request Inspector ×œ×©×™×—×” ×˜×¨×™×™×” â€” ×©×œ×•×©×ª ×”×‘×§×©×•×ª **200**.

2. **CRM**

   * `GET /api/crm/customers?page=1&limit=25` â†’ 200 + `results/page/pages/total`.
   * ×‘×˜×‘×œ×”: ××™×•×Ÿ/×¡×™× ×•×Ÿ/Export CSV ×¢×•×‘×“×™× (×¦×™×œ×•× ××¡×š).
   * ×›×¨×˜×™×¡ ×œ×§×•×—: Timeline ×—×™; Calls ××¦×™×’ × ×’×Ÿ + ×ª××œ×•×œ.

3. **×”×ª×¨××•×ª**

   * ×™×¦×™×¨×ª Task `due_at` ×œ×¢×•×“ 2 ×“×§â€™ â†’ `TaskDueModal` ×¢×•×œ×” ×‘×–××Ÿ ×××ª; ×‘×˜××‘ ×¡×’×•×¨ ××ª×§×‘×œ×ª Push.

4. **××‘×˜×—×”**

   * `curl -sSI https://YOUR_DOMAIN/ | grep -i x-revision` â†’ ××—×–×™×¨ ×’×¨×¡×”.
   * ×‘×§×©×ª webhook ×œ×œ× ×—×ª×™××ª Twilio (×‘Ö¾staging) â†’ 403.

5. **×¤×¨×™×¡×”**

   * ×¨×¢× ×•×Ÿ ×§×©×™×— ××¨××” build ×¢×“×›× ×™; ××™×Ÿ ×—×–×¨×•×ª ××™×•×©× ×•×ª ×©×œ SW.

---

# H) ××” ××’×™×©×™× ×‘×¡×•×£ (×‘×œ×™ ×–×” â€” ×œ× â€œ×ª×•×§×Ÿâ€)

* PR ××—×“ ××¨×•×›×– ×¢× ×›×œ ×”×©×™× ×•×™×™×.
* â€œ×“×•×´×— ×”×•×›×—×•×ªâ€ ×§×¦×¨: ×¤×œ×˜ ×©×œ 3 ×¤×§×•×“×•×ª `curl`, ×¦×™×œ×•× Request Inspector, 2 ×¦×™×œ×•××™ ××¡×š (×˜×‘×œ×ª ×œ×§×•×—×•×ª + ×›×¨×˜×™×¡ ×œ×§×•×—).
* READMEâ€‘DEPLOY.md ××¢×•×“×›×Ÿ (ENV, ×¤×§×•×“×•×ª ×¨×™×¦×”, ×‘×“×™×§×•×ª smoke).

---

## ×œ××” ×–×” ×¡×•×’×¨ ××ª ×”×¤×¢×¨ ×‘×¤×•×¢×œ

* ××•× ×¢×™× ×Ö¾Twilio ×©×’×™××•×ª 11200/12300 (TwiML + Contentâ€‘Type × ×›×•×Ÿ, ×ª×©×•×‘×” ××”×™×¨×”, MP3 ×ª×§×™×Ÿ).
* ××•× ×¢×™× ×—×–×¨×” ×œ×“×•××™×™× ×™× ×™×©× ×™× (Fail Fast ×¢×œ `PUBLIC_HOST`).
* ×”Ö¾CRM ×‘× ×•×™ ××¢×œ API ×¢×§×‘×™ (×¤××’â€™×™× ×¦×™×”/Timeline) ×¢× ×˜×‘×œ××•×ª ××§×¦×•×¢×™×•×ª.
* ×”×ª×¨××•×ª ×¤×•×¢×œ×•×ª ×‘×–××Ÿ ×××ª ×‘×œ×™ ×œ×©×‘×•×¨ webhooks.
* ××‘×˜×—×” ×•×¤×¨×™×¡×” ×‘×¡×˜× ×“×¨×˜ ××•×¦×¨, ×¢× health/version ×œ×–×™×”×•×™ ××™×™×“×™.

×× ×”×•× ×™×ª×§×“× **×‘×“×™×•×§** ×œ×¤×™ ×”×”× ×—×™×”, ×¢× ×”×•×›×—×•×ª ×‘×›×œ ×©×œ×‘ (×¤×œ×˜/×¦×™×œ×•××™×), ×œ× ×ª×”×™×” ×œ×• ×“×¨×š â€œ×œ×”×’×™×“ ×©×¢×©×”â€ ×‘×œ×™ ×©××¢×¨×›×•×ª ×™×¢×‘×“×• ×‘×¤×•×¢×œ.
