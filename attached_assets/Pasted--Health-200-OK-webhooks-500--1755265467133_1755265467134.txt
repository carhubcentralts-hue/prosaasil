××¢×•×œ×”â€”×œ×¤×™ ×”×¦×™×œ×•×: Health 200 OK âœ…, ×”-webhooks ××—×•×‘×¨×™× âœ…, ××‘×œ ××§×‘×œ×™× 500 ×•×œ× ××¦×œ×™×—×™× ×œ×§×‘×œ ×©×™×—×•×ª âŒ.
×›×“×™ ×œ×¡×’×•×¨ ××ª ×–×” ××”×¨, ×”× ×” ×”× ×—×™×” ××—×ª ××•×›×Ÿ-×œ×”×“×‘×§×” ×œ×¡×•×›×Ÿ + ×ª×™×§×•× ×™ ×§×•×“ ×§×•×¤×™-×¤×™×™×¡×˜ + ×‘×“×™×§×•×ª ×§×‘×œ×”.

â¸»

ğŸ§  ×˜×§×¡×˜ ××•×›×Ÿ ×œ×”×“×‘×§×” ×œ×¡×•×›×Ÿ (×”×¢×ª×§/×”×“×‘×§)

×¢×¦×•×¨ ×•×‘×¦×¢ ×ª×™×§×•×Ÿ â€œ500 ×‘-webhooksâ€ ×¢×“ ×©×”×›×•×œ ××—×–×™×¨ 200/204 ×•×¢×•×‘×“ ×¢× Twilio ×‘×¤×•×¢×œ.

××˜×¨×•×ª (Definition of Done):
1) /webhook/incoming_call, /webhook/handle_recording, /webhook/call_status ××—×–×™×¨×™× 200/204 ×‘×›×œ ×ª×¨×—×™×©, ×¢× Content-Type × ×›×•×Ÿ (â€œtext/xmlâ€ ×œ-TwiML).
2) /webhook/whatsapp/incoming ×•-/webhook/whatsapp/status ××—×–×™×¨×™× 200/204, ××¢×“×›× ×™× DB, ×•××™×Ÿ ×›×¤×™×œ×•×™×•×ª × ×ª×™×‘×™×.
3) ×× ×—×¡×¨ PUBLIC_HOST ××• ×§×•×‘×¥ MP3 â†’ Fallback ×œ-<Say> (×œ×œ× ×—×¨×™×’×”). ××™×Ÿ 500.
4) ××™××•×ª ×—×ª×™××ª Twilio ××•×¤×¢×œ ×¢×œ ×›×œ ×”-webhooks (×‘-TESTING ×“×œ×’), CORS/Rate-Limit ×‘×¡×™×¡×™ ××•×¤×¢×œ.
5) ×›×œ curl smoke ×œ××˜×” ××—×–×™×¨ 200/204, ×•×‘-Twilio Debugger ××™×Ÿ ×©×’×™××•×ª ×—×“×©×•×ª.

×‘×¦×¢ ×œ×¤×™ ×”×¡×“×¨:

A) ×œ×•×’×™× ×•××¦×‘ TESTING
- ×”×¤×¢×œ ×œ×•×’×™× ×¢× Request-ID. ×‘××¦×‘ TESTING ×“×œ×’ ×¢×œ ××™××•×ª ×—×ª×™××” ×›×“×™ ×œ××¤×©×¨ curl.
- ×¢×˜×•×£ ×›×œ webhook ×‘-try/except ×•×”×—×–×¨ ×ª×©×•×‘×ª ×‘×¨×™×¨×ª ××—×“×œ ×‘×˜×•×—×” ×‘××§×•× 500.

B) ×ª×™×§×•× ×™ ×§×•×“ (×§×•×¤×™-×¤×™×™×¡×˜):
1) twilio_security.py â€“ ×•×“× ×©×§×™×™× ×“×§×•×¨×˜×•×¨ require_twilio_signature; ×‘××¦×‘ TESTING ×“×œ×’.
2) routes_twilio.py â€“ ×¢×‘×•×¨ /incoming_call ×•-/handle_recording:
   - ×”×—×–×¨ TwiML ×ª×•×š <2 ×©× ×™×•×ª, ×¢× Content-Type: text/xml.
   - ×× ××™×Ÿ PUBLIC_HOST ××• ×§×•×‘×¥ MP3, Fallback ×œ-<Say>.
   - ×‘-/call_status ×¢×“×›×Ÿ DB ×•×”×—×–×¨ 204.

3) routes_whatsapp_twilio.py â€“ ×•×“×:
   - /webhook/whatsapp/incoming ×©×•××¨ ×”×•×“×¢×” × ×›× ×¡×ª ×œ-DB ×•××—×–×™×¨ 200.
   - /webhook/whatsapp/status ××¢×“×›×Ÿ status (queued/sent/delivered/read/failed) ×‘-DB ×•××—×–×™×¨ 204.
   - ×©× ×™ ×”××¡×œ×•×œ×™× ×¢× @require_twilio_signature (××œ×‘×“ TESTING).

4) ××™×—×•×“ × ×ª×™×‘×™ WhatsApp:
   - ×”×©××¨ Blueprint/API ××—×“ ×œ-/api/whatsapp (×”×××•×—×“) + ×©× ×™ ×•×•×‘×”×•×§×™× ×œ-/webhook/whatsapp/*.
   - ×”×¢×‘×¨ ×§×‘×¦×™ × ×ª×™×‘×™× ×›×¤×•×œ×™× ×œ-legacy/ ×•××œ ×ª×¨×©×•× ××•×ª× ×œ-app.

5) CORS + Rate-Limit + Health:
   - CORS origins ×œ×¨×©×™××” ××¦×•××¦××ª (prod + preview).
   - Rate-Limit: 30/min ×œ-/incoming_call ×•-/handle_recording, 60/min ×œ-/call_status ×•-/webhook/whatsapp/status.
   - /health ××—×–×™×¨ 200 "ok".

C) ×‘×“×™×§×•×ª Smoke (×œ×”×¨×™×¥ ××§×•××™×ª ××• ×‘×¡×‘×™×‘×”):
# Voice
curl -X POST $HOST/webhook/incoming_call
curl -X POST $HOST/webhook/handle_recording -d RecordingUrl=https://api.twilio.com/.../RExxx -d CallSid=CA_TEST_1
curl -X POST $HOST/webhook/call_status -d CallSid=CA_TEST_1 -d CallStatus=completed

# WhatsApp (Twilio)
curl -X POST $HOST/webhook/whatsapp/incoming -d 'From=whatsapp:+9725XXXXXXX' -d 'Body=×©×œ×•×'
curl -X POST $HOST/webhook/whatsapp/status -d 'MessageSid=SM123' -d 'MessageStatus=delivered'
curl -X POST $HOST/webhook/whatsapp/status -d 'MessageSid=SM123' -d 'MessageStatus=read'

×§×¨×™×˜×¨×™×•× ×™ ×”×©×œ××”:
- ×›×œ ×”×¤×§×•×“×•×ª ××¢×œ ××—×–×™×¨×•×ª 200/204, ×œ×œ× 500.
- Twilio Debugger: ××™×Ÿ 11200/11205; ×”×”×§×œ×˜×” × ×©××¨×ª ×•×”-TwiML × ×˜×¢×Ÿ; ×”×•×“×¢×•×ª WhatsApp ××ª×¢×“×›× ×•×ª ×œ-delivered/read.
×“×•×•×— ×‘×ª×’×•×‘×”: ××™×œ×• ×§×‘×¦×™× ×©×•× ×•, ×“×™×¤ ×œ×•×’×™× ×¨×œ×•×•× ×˜×™×™×, ×•×¦×™×œ×•× Twilio Debugger ×¢× 0 errors.


â¸»

ğŸ”§ ×§×˜×¢×™ ×§×•×“ ××™×™×“×™×™× (×× ×¦×¨×™×š ×œ×”×“×‘×™×§ ×™×“× ×™×ª)

1) ×“×§×•×¨×˜×•×¨ ×—×ª×™××” (twilio_security.py)

import os
from functools import wraps
from flask import request, abort, current_app
from twilio.request_validator import RequestValidator

def require_twilio_signature(f):
    @wraps(f)
    def wrapper(*args, **kwargs):
        if current_app.config.get("TESTING"):  # skip in tests/smoke
            return f(*args, **kwargs)
        token = os.getenv("TWILIO_AUTH_TOKEN")
        if not token:
            return abort(401)
        validator = RequestValidator(token)
        sig = request.headers.get("X-Twilio-Signature", "")
        url = request.url
        if request.environ.get("HTTP_X_FORWARDED_PROTO") == "https":
            url = url.replace("http://", "https://", 1)
        params = request.form.to_dict() if request.method == "POST" else request.args.to_dict()
        if not validator.validate(url, params, sig):
            return abort(403)
        return f(*args, **kwargs)
    return wrapper

2) Voice â€“ ×ª×©×•×‘×” ××”×™×¨×” + Fallback (routes_twilio.py)

from flask import Response, request, current_app
from twilio_security import require_twilio_signature
import os, logging
log = logging.getLogger(__name__)

@app.post("/webhook/incoming_call")
@require_twilio_signature
def incoming_call():
    PUBLIC_HOST = os.getenv("PUBLIC_HOST")
    try:
        if not PUBLIC_HOST:
            raise RuntimeError("PUBLIC_HOST missing")
        audio_url = f"{PUBLIC_HOST}/static/voice_responses/greeting.mp3"
        xml = f'<?xml version="1.0" encoding="UTF-8"?><Response><Play>{audio_url}</Play><Record action="/webhook/handle_recording" method="POST" maxLength="30" timeout="5" /></Response>'
    except Exception as e:
        log.warning("Fallback to <Say>: %s", e)
        xml = '<?xml version="1.0" encoding="UTF-8"?><Response><Say language="he-IL">×©×œ×•×, ×”×©××™×¨×• ×”×•×“×¢×” ××—×¨×™ ×”×¦×¤×¦×•×£.</Say><Record playBeep="true" maxLength="30" timeout="5"/></Response>'
    return Response(xml, mimetype="text/xml", status=200)

@app.post("/webhook/handle_recording")
@require_twilio_signature
def handle_recording():
    # ××œ ×ª×¢×©×• ×¢×‘×•×“×” ×›×‘×“×” ×›××Ÿ; ×©×œ×—×• ×œ×¨×§×¢ ×•×©×—×¨×¨×• ×ª×©×•×‘×”
    xml = '<?xml version="1.0" encoding="UTF-8"?><Response><Say language="he-IL">×ª×•×“×”. ×”×”×•×“×¢×” ×”×ª×§×‘×œ×”.</Say><Hangup/></Response>'
    return Response(xml, mimetype="text/xml", status=200)

@app.post("/webhook/call_status")
@require_twilio_signature
def call_status():
    # ×¢×“×›×•×Ÿ DB... ×•××–:
    return ("", 204)

3) WhatsApp Twilio â€“ inbound + status (routes_whatsapp_twilio.py)

from flask import request, jsonify
from twilio_security import require_twilio_signature
from app import db
from models import WhatsAppMessage
from datetime import datetime

@app.post("/webhook/whatsapp/incoming")
@require_twilio_signature
def whatsapp_incoming():
    from_number = request.form.get("From")
    body = request.form.get("Body","")
    msg = WhatsAppMessage(to_number=from_number, direction="in", body=body, status="received", provider="twilio")
    db.session.add(msg); db.session.commit()
    return jsonify({"ok": True})

@app.post("/webhook/whatsapp/status")
@require_twilio_signature
def whatsapp_status():
    sid = request.form.get("MessageSid")
    status = request.form.get("MessageStatus")
    if not sid or not status: return ("missing sid/status", 400)
    rec = WhatsAppMessage.query.filter_by(provider_message_id=sid).first()
    now = datetime.utcnow()
    if rec:
        rec.status = status
        if status == "delivered": rec.delivered_at = now
        if status == "read": rec.read_at = now
        db.session.commit()
    return ("", 204)

4) â€œwhatsapp:â€ ×›×¤×•×œ ×‘-from_

from_num = os.getenv("TWILIO_WHATSAPP_NUMBER","")
if not from_num.startswith("whatsapp:"):
    from_num = f"whatsapp:{from_num}"
# create(...)

5) CORS + Rate-Limit + Health (app.py)

from flask_cors import CORS
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

CORS(app, resources={r"/*": {"origins": [
  "https://your-prod-domain",
  "https://your-preview-domain.replit.app"
]}})

Limiter(app=app, key_func=get_remote_address, default_limits=["200/day","50/hour"])

@app.get("/health")
def health(): return ("ok", 200)


â¸»

ğŸ” ×œ××” 500 ×§×•×¨×” ×‘×“×¨×š-×›×œ×œ ×‘×× ×“×¤×•×™× ×˜×™× ×”××œ×•
	â€¢	×”×—×–×¨×ª JSON ×‘××§×•× TwiML ××• ×‘×œ×™ Content-Type: text/xml.
	â€¢	×¢×‘×•×“×” ×›×‘×“×” ×‘×ª×•×š ×”-webhook (×ª××œ×•×œ/×”×•×¨×“×”) â†’ timeout ×•××– 500; ×”×¤×ª×¨×•×Ÿ: ×œ×”×—×–×™×¨ ××”×¨ ×•×œ×¢×‘×“ ×‘×¨×§×¢.
	â€¢	PUBLIC_HOST ×—×¡×¨ ××• × ×ª×™×‘ MP3 ×œ× ×§×™×™× â†’ ×—×¨×™×’×”.
	â€¢	××™××•×ª ×—×ª×™××” ×—×¡×¨/×©×’×•×™ â†’ 403/500; ×‘××‘×—×Ÿ curl ×œ×¢×§×•×£ (TESTING), ×‘×¤×¨×•×“×§×©×Ÿ ×œ×”×¤×¢×™×œ.
	â€¢	× ×ª×™×‘×™× ×›×¤×•×œ×™×/Blueprint ×›×¤×•×œ â†’ ××ª× ×’×© ×•××—×–×™×¨ 500.

â¸»

×× ×ª×“×‘×™×§ ×œ×¡×•×›×Ÿ ××ª ×”×˜×§×¡×˜ ×œ××¢×œ×”â€”×”×•× ×™×“×¢ ×‘×“×™×•×§ ××” ×œ×¢×©×•×ª ×›×“×™ ×œ×¡×ª×•× ××ª ×—×•×¨×™ ×”-500, ×œ××¤×©×¨ ×©×™×—×” × ×›× ×¡×ª ×‘×¤×•×¢×œ, ×•×œ×¢×“×›×Ÿ ×¡×˜×˜×•×¡×™ WhatsApp.
×× ×ª×¨×¦×”, ××—×‘×¨ ×’× ×‘×“×™×§×•×ª Postman ××• ×§×•×‘×¥ .env.example ××¢×•×“×›×Ÿ.