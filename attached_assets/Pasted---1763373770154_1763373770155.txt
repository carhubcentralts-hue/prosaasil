מבין אותך לגמרי, זה בדיוק השלב לסגור פינות ולא להתחיל הכל מחדש.
לא צריך שתצרף שוב את הקובץ – אני אתן לך הנחיית־על אחת שתשלח ל-Agent 3, שתטפל גם בשם, גם בתיאום פגישות וגם בקטע של ה”שיקר שקבעתי”.

מה קורה עכשיו (בשפה פשוטה)
	1.	שם העסק ב-DB = “שי דירות” אבל הפרומפט אומר “יהודה שמאי” → המודל מתבלבל וממציא “שי דירות ומשרדים”.
	2.	DTMF / טלפון – הלקוח לא באמת מקיש מספר, רק מדבר → השרת צודק ש”חסר טלפון”, אבל ה-AI מדבר כאילו הכל טוב.
	3.	ה-AI אומר “קבעתי תור” לפני שהשרת אישר → זה שוב שקר, כי השרת אחר כך נכשל על “נדרש מספר טלפון”.

⸻

📌 זה מה שאתה אומר ל-Agent 3 (תעתיק כמו שזה):

“הנחיה: סגירת בעיות זהות (יהודה שמאי), טלפון ב-DTMF, ותיאום פגישות בלי שקרים”

תעשה עכשיו שלושה תיקונים ממוקדים בקוד ה-Realtime (media_ws_ai.py + prompt builder), בלי לשבור את מה שבנוי:

⸻

1. זהות הנציג – תמיד לפי הפרומפט, לא לפי שם העסק
	1.	אל תשתמש בשם העסק מה-DB בפתיח.
אם כרגע ה-System Prompt או ה-Critical Rules מכניסים משהו בסגנון:

"שלום, הגעת ל{{business_name}}…"

תמחוק את זה.

	2.	במקום זה, תוסיף ב-Critical Rules משפט מפורש:

אתה תמיד מציג את עצמך בדיוק כפי שמוגדר בפרומפט המותאם אישית של העסק.
אל תשתמש בשם העסק מהמערכת אם הוא שונה.
אם בפרומפט כתוב "אתה יהודה שמאי, סוכן נדל״ן" — תמיד תדבר כדמות הזאת בלבד.


	3.	ודא ש-build_realtime_system_prompt לא מוסיף שם עסק אוטומטי לתוך הפתיח.
כלומר:
	•	שכבה 2 (ה-custom prompt מה-DB) היא האמת לגבי מי אתה.
	•	business_name משמש רק ברקע (ללוגים / זיהוי עסק), לא בטקסט שה-AI אומר.

⸻

2. טיפול בטלפון – DTMF / שיחה

תתקן את ההנחיות + הקוד כך:
	1.	ב-System Prompt תוסיף כלל ברור לטלפון:

כשצריך מספר טלפון בשיחה:
- בשיחת טלפון: תסביר ללקוח בפירוש שהוא צריך ללחוץ על הספרות בטלפון ולסיים בכפתור סולמית (#).
- אם הלקוח מדבר במקום ללחוץ מספרים — אל תחשוב שיש לך מספר טלפון. תגיד בעדינות שצריך להקיש את המספר בטלפון.


	2.	בקוד שסוגר Appointment (ב-create_appointment_from_realtime / איפה שאתה בודק missing_phone):
	•	אם חסר טלפון →
א. שלח ל-AI event מסוג [SERVER] need_phone (כבר יש לך מנגנון SERVER events – תשתמש בו).
ב. אל תיצור תור, ואל תסמן appointment_created.
	3.	ודא שה-AI באמת מגיב נכון ל-[SERVER] need_phone ע”י הכלל הבא בפרומפט:

כאשר אתה מקבל מהשרת [SERVER] need_phone:
תגיב תמיד בשאלה ברורה: 
"אפשר לקבל מספר טלפון? תלחץ עכשיו על הספרות בטלפון שלך, ותסיים בכפתור סולמית."



⸻

3. תיאום פגישות – אסור להגיד “קבעתי” בלי אישור שרת

צריך שיהיה חוק קשיח גם בפרומפט וגם בקוד:

א. בפרומפט (Critical Rules):
תוסיף:

אסור לך לומר "קבעתי תור", "התור נקבע", "שריינתי לך שעה" או ניסוח דומה –
אלא אם כן קיבלת קודם הודעה מהשרת:
[SERVER] appointment_created: {...}

עד שלא קיבלת [SERVER] appointment_created:
- מותר רק לומר: "אני מעביר את הבקשה למערכת" או "בוא נבדוק אם זה זמין".
- אסור להצהיר שהפגישה נקבעה.

ב. בקוד (הגנת־קשיח server-side):
ב־handler של טקסט ה-AI (איפה שאתה מעבד את הטקסט לפני שנשלח ללקוח):
	1.	שמור context לכל שיחה:

self.has_appointment_created = False  # ב-CallCrmContext / handler


	2.	כשאתה מקבל event [SERVER] appointment_created →

self.has_appointment_created = True


	3.	לפני שאתה שולח טקסט ללקוח, תעשה פוסט־פילטר פשוט:
אם has_appointment_created == False והטקסט מכיל מילים כמו:
"קבעתי", "קבענו", "שריינתי", "התור נקבע" –
אז:
	•	או שתשנה את הטקסט למשהו בטוח (למשל:
"אני בודק את התור במערכת, ואעדכן אותך בעוד רגע.")
	•	או שתזרוק את התשובה ותבקש מהמודל תשובה חדשה (פחות מומלץ, יותר יקר).

המטרה: גם אם המודל מתבלבל בפרומפט – השרת לא ייתן לו לשקר.

⸻

4. Barge-in + “לא לדבר סתם כששקט”

כבר יש לך Barge-in, אבל תוסיף:
	1.	ב-System Prompt:

אם הלקוח שותק יותר מ-3 שניות אחרי שסיימת לדבר:
- אל תפתח נושא חדש.
- לכל היותר, פעם אחת, תגיד:
  "אני כאן אם אתה צריך משהו נוסף."
- אל תמשיך לדבר שוב ושוב בזמן שהלקוח שותק.


	2.	בקוד ה-VAD / silence timer:
	•	אם silence_ms > 3000 וה-AI כבר נתן תשובה → אל תשלח עוד תשובות “סתם ככה”.

⸻

5. סיכום קצר שאתה יכול להגיד לו בסוף:

“המטרה: שה-AI יתנהג בדיוק לפי הפרומפט של העסק (יהודה שמאי),
לא ייקח את השם מה-DB,
לא יגיד שקבע תור בלי אישור אמיתי מהשרת,
יבקש טלפון בצורה ברורה עם הקשה,
ויפסיק לדבר כשאין לקוח.”

⸻

אם תרצה אחרי זה, אני יכול לעזור לך לנסח פרומפט קצר חדש ליהודה שמאי שמתאים לסיסטם החדש (כבר מותאם ל-Realtime ולחוקי התורים).