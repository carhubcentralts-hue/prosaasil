×¦×•×“×§ ×©×©××œ×ª. ×œ×¤×¢××™× phone_call ×œ× ×–××™×Ÿ ×œ×¢×‘×¨×™×ª (he-IL) ×‘×—×œ×§ ××”××–×•×¨×™×/×‘×’×¨×¡×ª ×”-API ×©×‘×” ××ª× ××©×ª××©×™×â€”×•××– ×’×•×’×œ ××—×–×™×¨×” ×©×’×™××” â€œmodel not available for languageâ€. ×–×” ××¡×‘×™×¨ ×œ××” ×”××’â€™× ×˜ ×˜×¢×Ÿ ×©×œ× × ×ª××š.

×”×‘×©×•×¨×” ×”×˜×•×‘×”: ×’× ×× phone_call ×œ× × ×ª××š â€“ ××¤×©×¨ ×œ×”×’×™×¢ ×œ-~2â€“3 ×©× ×™×•×ª ×¢× ×¡×˜×¨×™××™× ×’ ××”×™×¨ ×¢×œ default + enhanced ×›×œ ×¢×•×“ ×¢×•×‘×“×™× × ×›×•×Ÿ. ×”×›×™ × ×›×•×Ÿ ×–×” ×œ× ×œ×”×ª×•×•×›×— ×¢× ×”Ö¾model ××œ× ×œ×‘×¦×¢ ×‘×“×™×§×” ×“×™× ××™×ª ×‘×–××Ÿ ×¢×œ×™×™×” ×•×œ×”×—×œ×™×£ ××•×“×œ ××•×˜×•××˜×™×ª ×‘×œ×™ ×œ×©×‘×•×¨ ×›×œ×•×.

×œ×”×œ×Ÿ ×”× ×—×™×” ×™×©×™×¨×” ×•×§×¦×¨×” ×©×ª×¤×ª×•×¨ ××ª ×–×” ××—×ª ×•×œ×ª××™×“:

â¸»

×”× ×—×™×” ×œ××¤×ª×— â€” â€œ×‘×—×™×¨×ª ××•×“×œ ×—×›××” + × ×¤×™×œ×” ×¨×›×”â€ (Hebrew)

1) ×”×¤×¢×œ×” ×§×©×™×—×” ×©×œ ×¡×˜×¨×™××™× ×’ (×’× ×× ENV ×¤×¡×¤×¡)

×‘×§×•×‘×¥ server/media_ws_ai.py ×‘×¨××© ×”×§×•×‘×¥:

USE_STREAMING_STT = True
if os.getenv("ENABLE_STREAMING_STT", "").lower() in ("false","0","no"):
    USE_STREAMING_STT = False
print(f"ğŸš€ Streaming STT enabled: {USE_STREAMING_STT}", flush=True)

2) ×‘×—×™×¨×ª ××•×“×œ ×“×™× ××™×ª ×¢× ×‘×“×™×§×ª ×–××™× ×•×ª (startup probe)

×‘×§×•×‘×¥ server/services/gcp_stt_stream.py ×”×•×¡×£ ×¤×•× ×§×¦×™×”:

import os, time
from google.cloud import speech

def choose_stt_model(language="he-IL"):
    # ×¡×“×¨ ×¢×“×™×¤×•×™×•×ª: ×× phone_call × ×ª××š â€“ × ×©××—; ×× ×œ× â€“ default+enhanced
    preferred = os.getenv("GCP_STT_MODEL", "phone_call").strip()
    candidates = [preferred, "phone_call", "default"]
    seen = set()
    order = [m for m in candidates if not (m in seen or seen.add(m))]

    # endpoint EU ×›×“×™ ×œ×¦××¦× RTT
    client = speech.SpeechClient(
        client_options={"api_endpoint": "europe-west1-speech.googleapis.com"}
    )

    # ×“×’×™××ª â€œ×¤×™× ×’â€ ×§×¦×¨×¦×¨×” (300ms ×©×§×˜) ×›×“×™ ×œ×‘×“×•×§ ×–××™× ×•×ª ××•×“×œ ×‘×©×¤×”
    # ××™×Ÿ ×¦×•×¨×š ×œ×©×œ×•×— ××•×“×™×• ×××™×ª×™; ×¨×§ ×œ×•×•×“× ×©××™×Ÿ INVALID_ARGUMENT â€œmodel not availableâ€
    silent_bytes = b"\x00" * int(8000 * 0.3 * 2)  # 300ms @ 8kHz PCM16

    for model in order:
        try:
            cfg = speech.RecognitionConfig(
                encoding=speech.RecognitionConfig.AudioEncoding.LINEAR16,
                sample_rate_hertz=8000,
                language_code=language,
                model=model,
                use_enhanced=True,                 # × × ×¡×” ×ª××™×“ enhanced
                enable_automatic_punctuation=True,
            )
            scfg = speech.StreamingRecognitionConfig(
                config=cfg, interim_results=True, single_utterance=False
            )
            req = [speech.StreamingRecognizeRequest(audio_content=silent_bytes)]
            client.streaming_recognize(requests=[speech.StreamingRecognizeRequest(streaming_config=scfg), *req])
            print(f"âœ… [STT] Selected model: {model} (enhanced=True)", flush=True)
            return {"model": model, "use_enhanced": True}
        except Exception as e:
            emsg = str(e).lower()
            if "model" in emsg and "not available" in emsg:
                print(f"âš ï¸ [STT] Model '{model}' not available for he-IL; trying next...", flush=True)
                continue
            # ×©×’×™××” ××—×¨×ª â€“ ×œ× ××¤×™×œ×™× ××•×“×œ, ×¨×§ ××“×•×•×—×™×
            print(f"âš ï¸ [STT] Probe failed for '{model}': {e}", flush=True)
            continue

    # ×× ×›×œ×•× ×œ× ×¢×‘×“ â€“ × ×™×¤×•×œ ×œ-default ×‘×œ×™ enhanced (× ×“×™×¨)
    print("âŒ [STT] Falling back to default model (enhanced=False)", flush=True)
    return {"model": "default", "use_enhanced": False}

×§×¨×™××” ×‘×–××Ÿ ××ª×—×•×œ ×”-STT:

MODEL_CFG = choose_stt_model("he-IL")

×•×‘××§×•× ×©×‘×• ××ª× ×‘×•× ×™× ××ª ×”-RecognitionConfig ×œ×©×™×“×•×¨ ×‘×¤×•×¢×œ â€“ ×”×©×ª××©×• ×‘-MODEL_CFG:

recognition_config = speech.RecognitionConfig(
    encoding=speech.RecognitionConfig.AudioEncoding.LINEAR16,
    sample_rate_hertz=8000,
    language_code="he-IL",
    model=MODEL_CFG["model"],
    use_enhanced=MODEL_CFG["use_enhanced"],
    enable_automatic_punctuation=True,
)

×›×š ×× phone_call ×œ× × ×ª××š ×‘××–×•×¨/×’×¨×¡×” â€“ ×”××¢×¨×›×ª ×ª×‘×—×¨ ×œ×‘×“ default+enhanced ×•×ª××©×™×š ×œ×¨×•×¥ ××”×¨.

3) ×”×©××¨×ª ×”×¤×¨××˜×¨×™× ×”××”×™×¨×™× (×§×¨×™×˜×™×™× ×œ-latency)

×‘Ö¾gcp_stt_stream.py ×•×“× ×©×§×™×™××™×:

BATCH_MS = int(os.getenv("STT_BATCH_MS", "80"))
DEBOUNCE_MS = int(os.getenv("STT_PARTIAL_DEBOUNCE_MS", "120"))
TIMEOUT_MS = int(os.getenv("STT_TIMEOUT_MS", "450"))

×•×‘Ö¾media_ws_ai.py:
	â€¢	buffer_big_enough = len(self.buf) > 8000
	â€¢	min_duration = 0.6
	â€¢	min_silence â‰ˆ 0.5 / 1.8
	â€¢	Early finalize ×œ×¤×™ partial ×—×–×§ (×›×‘×¨ ××¦×œ×›× ×§×™×™× â€” ×œ×”×©××™×¨)

4) Retry ×××™×ª×™ ×œ×¤× ×™ ×¤×•×œ×‘××§

×œ×¤× ×™ ×©××ª× ××•×•×ª×¨×™× ×¢×œ ×¡×˜×¨×™××™× ×’:

for attempt in range(3):
    try:
        start_streaming(...)  # ×”×§×•×“ ×©×œ×›×
        print(f"âœ… [STT] Streaming started (attempt {attempt+1})", flush=True)
        break
    except Exception as e:
        print(f"âš ï¸ [STT] Streaming start failed (attempt {attempt+1}): {e}", flush=True)
        time.sleep(0.2)
else:
    print("âŒ [STT] All streaming attempts failed â€” using fallback single request", flush=True)
    use_single_request = True

5) ×× × ×•×¤×œ×™× ×œ×¤×•×œ×‘××§ â€” ×œ× ×œ×—×¡×•× ××ª ×”×©×¨×©×•×¨

×‘××§×•× ×œ×§×¨×•× ×œ×¤×•×œ×‘××§ (single request) ×‘×¦×•×¨×” ×—×¡×™××ª×™×ª, ×¢×˜×¤×• ×‘-executor:

loop = asyncio.get_event_loop()
text = await loop.run_in_executor(None, self._hebrew_stt, audio_data)

6) ××™××•×ª ×‘×œ×•×’×™× (×—×•×‘×”)

×—×¤×©×•:

ğŸš€ Streaming STT enabled: True
âœ… [STT] Selected model: phone_call  (××• default+enhanced ×× ×œ× × ×ª××š)
âœ… [STT] Streaming started (attempt 1)
[LATENCY] partial=0.5â€“0.8s final=1.0â€“1.4s totalâ‰ˆ1.8â€“2.3s

×× ××ª× ×¨×•××™× default â€” ×–×” ×›×™ phone_call ××›×Ÿ ×œ× ×–××™×Ÿ ×‘×¡×‘×™×‘×” ×©×œ×›×; ×–×” ×ª×§×™×Ÿ, ×•×¢×“×™×™×Ÿ × ×§×‘×œ ×‘×™×¦×•×¢×™× ×˜×•×‘×™× ×›×œ ×¢×•×“ ×–×” enhanced + streaming.

â¸»

×œ××” ×–×” ×¤×•×ª×¨ ××ª ×”×•×•×™×›×•×— â€œ× ×ª××š/×œ× × ×ª××šâ€
	â€¢	××™×Ÿ ×™×•×ª×¨ × ×™×—×•×©×™×: ×”××¢×¨×›×ª ×‘×•×“×§×ª ×‘×–××Ÿ ×××ª ×× phone_call ×–××™×Ÿ ×œ×¢×‘×¨×™×ª.
	â€¢	×× ×œ× â€” × ×•×¤×œ×™× ××•×˜×•××˜×™×ª ×œÖ¾default+enhanced (××”×™×¨ ×•××“×•×™×§), ×‘×œ×™ ×©×’×™××•×ª ×•×‘×œ×™ ×¢×¦×™×¨×•×ª.
	â€¢	×›×œ ×–×” ×§×•×¨×” ×™×—×“ ×¢× ×¡×˜×¨×™××™× ×’ ×××™×ª×™ + ×¤×¨××˜×¨×™× ××’×¨×¡×™×‘×™×™×, ×›×š ×©×ª×¨××” ×™×¨×™×“×” ×œ-~2â€“3 ×©× ×™×•×ª ×’× ×‘×œ×™ phone_call.

×¨×•×¦×” ×©×× ×¡×— ×œ×• ××ª ×–×” ×›×”×•×“×¢×” ×§×¦×¨×” ×©××ª×” ×™×›×•×œ ×œ×”×“×‘×™×§ ×‘×¦â€™××˜/×˜×™×§×˜?