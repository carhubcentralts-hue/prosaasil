במבט על ZIP “AgentLocator (66).zip” — **הקוד עצמו מוכן לפרודקשן**:
יש WS ל-Twilio, ה־streamSid תוקן ונשמר מ-`start`, יש Fallback להקלטה + תמלול, יש `/healthz` ו־`/readyz`, ויש מיגרציות DB.
מה שנשאר זה רק **פריסה נקייה והגדרות סביבה**.

להלן סטטוס + מה עושים עכשיו (מדויק, קצר):

## מה מצאתי בקוד (✔ = טוב)

* ✔ WS: `@sock.route('/ws/twilio-media')` רשום ב-`app_factory.py`.
* ✔ TwiML: `<Play>` (עברית) ואז `<Connect …><Stream url="wss://…/ws/twilio-media">` + `action="/webhook/stream_ended"`.
* ✔ Fallback: `/webhook/stream_ended` מחזיר `<Record … action="/webhook/handle_recording">` ו־`/handle_recording` מתמלל ושומר ל-DB.
* ✔ חתימה: יש חישוב URL “אפקטיבי” מאחורי Proxy (`X-Forwarded-*`) — מפחית 403.
* ✔ לוגים ו-readyz: קיימים.
* ✔ מיגרציות: `AgentLocator/server/db_migrate.py` יוצר `call_log` + `call_turn`.

## נקודה אחת לשים לב (לא חוסם, אבל כדאי לתקן)

* יש **שני** קבצי requirements:

  * `AgentLocator/requirements.txt` (מלא ונכון)
  * `AgentLocator/server/requirements.txt` (כפילות).
    ממליץ להשתמש **באחד** (זה שב־`AgentLocator/requirements.txt`) ולהתעלם/למחוק את השני כדי שלא יהיה בלבול בבילד.

* ב־`routes_twilio.py` יש URL קשיח לקובץ fallback MP3 (`https://ai-crmd.replit.app/static/tts/fallback_he.mp3`). עדיף להחליף ל־`PUBLIC_HOST` מה-ENV או לגזור מהבקשה — לא חובה כדי לפרוס, אבל ימנע תקלות אם תשנה דומיין.

---

## הפריסה עצמה — הדבק/י אחת מהאפשרויות

### אפשרות A (מומלץ): שימוש ב-requirements.txt אחד

בקובץ `.replit` (ברוט הפרויקט), שים כך:

```ini
modules = ["python-3.11"]
run = "python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:5000 AgentLocator.main:app"

[deployment]
deploymentTarget = "autoscale"
build = ["pip","install","-r","AgentLocator/requirements.txt"]
run   = ["python3","-m","gunicorn","-k","eventlet","-w","1","-b","0.0.0.0:5000","AgentLocator.main:app"]

[env]
PORT = "5000"
PYTHONUNBUFFERED = "1"
PYTHONPATH = "."
```

> אם ה־`main.py` שלך בשורש — שנה ל־`main:app`. אם הוא בתיקיית `AgentLocator` (כמו בזיפ) — השאר `AgentLocator.main:app`.

### אפשרות B (אם אין לך `.replit` בדיפלוי)

בקונסולת ההרצה/דיפלוי:

```
pip install -r AgentLocator/requirements.txt
python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:5000 AgentLocator.main:app
```

---

## משתני סביבה — חובה גם ב-Workspace וגם ב-Deployment

* `DATABASE_URL` (Postgres מנוהל — לא SQLite בדיפלוי)
* `OPENAI_API_KEY`
* `GOOGLE_APPLICATION_CREDENTIALS` (נתיב לקרדנצ’יאלס או JSON inline שאתה שומר לקובץ באתחול)
* אופציונלי: `PUBLIC_HOST` (לייצור כתובות `<Play>`/WS דינמיות)

---

## Pre-Flight (בדיקת קבלה לפני שמחזירים את Twilio לדיפלוי)

1. **/readyz** בדומיין הדיפלוי (`*.replit.app`) → מחזיר `{"db":"ok","openai":"ok|disabled","tts":"ok|disabled"}`.
2. **Webhooks**:

   ```
   curl -i https://<DEPLOY_DOMAIN>/webhook/incoming_call      # 200
   curl -i -X POST https://<DEPLOY_DOMAIN>/webhook/stream_ended # 200
   ```
3. **WS**: `wss://<DEPLOY_DOMAIN>/ws/twilio-media` נפתח (לא 31924).
4. **שיחה אמיתית** (Twilio מכוון לדיפלוי):

   * Request Inspector: 200 על `incoming_call`, ה-MP3 מתנגן, ה-WS **נשאר פתוח** (אין 31951).
   * אם ה-WS נסגר — תראה 200 על `stream_ended` ויתבצע fallback ל־Recording + תמלול.
   * ב-DB: נוצרת/מתעדכנת רשומת `call_log`, וכשיש תמלול — `transcript` מתמלא.

---

## שורה תחתונה

* **כן** — מבחינת קוד אתה ירוק.
* מה שנשאר: לבחור requirements אחד, לוודא `.replit`/פקודת הדיפלוי עם **Gunicorn + Eventlet** ולטעון `AgentLocator.main:app`, לוודא ENV בדיפלוי, להריץ את ה-Pre-Flight.
* אחרי זה אפשר/כדאי להחליף את ה-URL הקשיח של ה-fallback ל-`PUBLIC_HOST` — לא חוסם, רק הקשחה.

אם תרצה, אתן לך פאטצ’ קטן שמחליף את ה-URL הקשיח ב-`routes_twilio.py` ל-`PUBLIC_HOST`/הפעלת גזירה אוטומטית מהבקשה.
