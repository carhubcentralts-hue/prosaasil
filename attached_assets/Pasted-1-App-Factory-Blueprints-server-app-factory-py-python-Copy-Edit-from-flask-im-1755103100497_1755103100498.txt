1) להחזיר/ליצור App Factory + רישום Blueprints
server/app_factory.py

python
Copy
Edit
from flask import Flask
from flask_cors import CORS
from .error_handlers import register_error_handlers
from .logging_setup import setup_logging
from .routes import register_blueprints

def create_app(env: str = 'production') -> Flask:
    app = Flask(__name__)
    app.config.from_mapping(
        PUBLIC_HOST = app.config.get("PUBLIC_HOST", ""),  # אפשר לדרוס דרך ENV
        CORS_ORIGINS = "*",
    )
    CORS(app, origins=app.config["CORS_ORIGINS"])
    register_blueprints(app)
    register_error_handlers(app)
    setup_logging(app)
    return app
server/routes/__init__.py

python
Copy
Edit
def register_blueprints(app):
    from ..routes_twilio import twilio_bp
    from ..api_crm_advanced import crm_bp
    # קיימים? הוסף: whatsapp_bp, contracts_bp, invoices_bp, signatures_bp, stats_bp
    from ..api_timeline import timeline_bp  # ייווצר בסעיף 3
    app.register_blueprint(twilio_bp)
    app.register_blueprint(crm_bp)
    app.register_blueprint(timeline_bp)
2) Error Handlers + Logging (לפרודקשן)
server/error_handlers.py

python
Copy
Edit
from flask import jsonify

def register_error_handlers(app):
    @app.errorhandler(404)
    def not_found(e): return jsonify({"error":"not_found"}), 404

    @app.errorhandler(500)
    def internal(e):
        app.logger.exception("Unhandled server error")
        return jsonify({"error":"server_error"}), 500
server/logging_setup.py

python
Copy
Edit
import logging, json, os
class JsonFormatter(logging.Formatter):
    def format(self, rec):
        return json.dumps({"lvl":rec.levelname,"msg":rec.getMessage(),"name":rec.name}, ensure_ascii=False)

def setup_logging(app):
    h = logging.StreamHandler()
    if os.getenv("FLASK_ENV") == "production":
        h.setFormatter(JsonFormatter()); app.logger.setLevel(logging.INFO)
    else:
        app.logger.setLevel(logging.DEBUG)
    app.logger.addHandler(h)
3) Timeline API (דרוש ל־CRM)
server/api_timeline.py

python
Copy
Edit
from flask import Blueprint, jsonify, request
timeline_bp = Blueprint("timeline_bp", __name__, url_prefix="/api")

@timeline_bp.get("/customers/<int:customer_id>/timeline")
def customer_timeline(customer_id):
    # בהמשך: למשוך אמיתי מה-DB. כרגע החזר מבנה תקין.
    return jsonify({"items": []})
4) CRM – לחסל הטיפו בדפדוף
ב־server/api_crm_advanced.py:

חפש והחלף כל customers_paginate לשם הפונקציה התקני שלך (למשל customers_paginated).

בדיקה: GET /api/crm/customers?page=1&limit=25 → 200 + רשימה + מטא־דפדוף.

פקודת עזרה:

bash
Copy
Edit
grep -R "customers_paginate" AgentLocator/server
5) Frontend התראות/Real-Time
client/src/lib/socket.ts

ts
Copy
Edit
import { io } from "socket.io-client";
export const socket = io("/", { path: "/ws" });
client/src/hooks/useTaskDue.ts

ts
Copy
Edit
import { useEffect } from "react";
import { socket } from "@/lib/socket";
export function useTaskDue(onDue:(p:any)=>void){
  useEffect(()=>{ socket.on("task:due", onDue); return ()=>socket.off("task:due", onDue); },[onDue]);
}
client/src/components/TaskDueModal.tsx

מסך מלא, RTL, מציג: שם לקוח, טלפון, כפתורי Call/WhatsApp/Snooze/Done.

קריאה לפעולות דרך ה־API.

client/public/sw.js

js
Copy
Edit
self.addEventListener('push', e=>{
  const data = e.data?.json()||{};
  e.waitUntil(self.registration.showNotification(data.title||'AgentLocator',{
    body: data.body, data,
    actions:[
      {action:'call', title:'התקשר'},
      {action:'wa', title:'פתח WhatsApp'},
      {action:'snooze_15', title:'נודניק 15ד׳'}
    ]
  }));
});
6) Design System בסיסי (נמשיך ללטש אחר כך)
client/src/styles/tokens.css

css
Copy
Edit
:root{
  --font-ui:"Assistant",system-ui,sans-serif;
  --spacing-1:8px; --spacing-2:16px; --spacing-3:24px;
  --color-bg:#0b1020; --color-card:#121933;
  --color-text:#e9edf5; --color-accent:#6ea8fe;
}
html[dir="rtl"] body{font-family:var(--font-ui);}
ייבוא ב־index.css.

טבלאות TanStack

הוסף תלות @tanstack/react-table

ודא שטבלת לקוחות משתמשת ב־DataTable עם מיון/סינון/Export.

7) Twilio – נשמע טוב, להשלים תצורה
כיוון שכבר יש שלושת הנתיבים: ודא ש־PUBLIC_HOST מוגדר (כדי ש־Play יגיש קבצים).

ב־Twilio Console: עדכן ל־POST שלושת הנתיבים. ודא Request Inspector בלי 500/404.

8) פריסה — שלא ייפול (Socket.IO)
שרת Flask עם eventlet או gevent.

Gunicorn דוגמה:

bash
Copy
Edit
pip install gunicorn eventlet
gunicorn --worker-class eventlet -w 1 -b 0.0.0.0:5000 "server.main:app"
או הרצה דרך socketio.run(app) אם אתה עם Flask-SocketIO בתצורת dev.

Nginx: לזכור Upgrade/Connection ל־WebSocket (/ws).

9) משתני סביבה (ייצוב)
ini
Copy
Edit
FLASK_ENV=production
PUBLIC_HOST=https://YOUR_HOST
CORS_ORIGINS=https://YOUR_HOST
DATABASE_URL=...
JWT_SECRET=...
TWILIO_SID=...
TWILIO_TOKEN=...
GOOGLE_APPLICATION_CREDENTIALS=/secrets/google_tts_key.json
VAPID_PUBLIC_KEY=...
VAPID_PRIVATE_KEY=...
בדיקות “סגירה” — אל תדלג
POST /webhook/incoming_call → 200 מחזיר TwiML תקין.

POST /webhook/call_status → 200 OK.

GET /api/crm/customers?page=1&limit=25 → 200 עם דפדוף תקין (בלי הטיפו).

GET /api/customers/:id/timeline → 200 (גם אם ריק לעכשיו).

הקליינט: Service Worker רשום (Application → Service Workers); Socket מתחבר; useTaskDue מציג TaskDueModal בעת task:due.

אין ERROR בקונסולת הדפדפן.

ה־CI (.github/workflows/ci.yml) רץ ירוק.

