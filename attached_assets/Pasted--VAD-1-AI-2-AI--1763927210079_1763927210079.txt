תיקון מקיף – שפות + VAD + רעש + הלוסינציות

המטרה:
1. כל שפה שהלקוח מדבר → ה-AI מבין.
2. ה-AI תמיד עונה בעברית בלבד.
3. אין "הלוסינציות" של דיבור כשיש שקט או רעש חלש.
4. ה-AI לא מדבר סתם כשאין דיבור ברור מהלקוח.

=====================
1. שפות / System Prompt
=====================

א. תעדכן את ה-system prompt / critical rules כך:

- תבטל לגמרי כל כלל בנוסח:
  - "אם אתה שומע אנגלית – אל תענה"
  - "אם השפה לא עברית – תישאר בשקט"
  - כל פילטר שמפיל תמלול כי הוא אנגלית בלבד.

- במקום זה תוסיף כלל ברור אחד:

  "אתה מבין לקוחות בכל שפה, אבל תמיד עונה בעברית בלבד.
   אם לקוח מדבר באנגלית או כל שפה אחרת, תבין את הבקשה ותענה בעברית.
   אל תתעלם מדיבור רק בגלל השפה."

- כלומר:
  • Whisper ממשיך לזהות שפות כרגיל.
  • לא עושים reject לתמלולים באנגלית.
  • ההגבלה היחידה: ה-output (הקול של ה-AI) יהיה תמיד בעברית.

========================
2. Audio Gate לפני OpenAI
========================

כרגע יש אצלנו Audio Gate יחסית אגרסיבי (RMS>180) וסינונים נוספים.  
המטרה: 
- לא לשלוח ל-OpenAI רעש חלש / קו / נשימות.
- כן לשלוח דיבור אמיתי (גם אם שקט יחסית).

תיישם gate כזה בקוד שמכין אודיו אל OpenAI (ב־media_ws_ai / realtime handler):

1. **קליברציה בתחילת שיחה**:
   - במשך ~2 שניות ראשונות (למשל 100 פריימים של 20ms):
     - מודדים RMS לכל פריים.
     - שומרים רק פריימים שקטים (RMS < 120) כחלק מ־noise_samples.
   - בסוף 2 השניות:
     - noise_floor = ממוצע RMS של noise_samples (אם אין מספיק, ברירת מחדל 70–90).
     - audio_gate_threshold = noise_floor + 80
     - אם audio_gate_threshold > 200 → חותכים ל-200 (cap).

   לדוגמה:
   - אם noise_floor = 80 → threshold = 160
   - אם noise_floor = 100 → threshold = 180
   - אם noise_floor = 130 → threshold = min(210, 200) = 200

2. **Gate בזמן אמת** לפני שליחת אודיו ל-OpenAI:
   - עבור כל פריים אודיו מהלקוח:
     - מחשבים RMS.
     - אם RMS < audio_gate_threshold → לא שולחים את הפריים הזה ל-OpenAI.
     - אם RMS ≥ audio_gate_threshold:
       - נספור consecutive_frames_above.
       - נשלח ל-OpenAI רק אם יש לפחות 3–4 פריימים ברצף מעל threshold
         (כלומר לפחות ~60–80ms של דיבור אמיתי).
       - אם יש פריים אחד או שניים שעוברים threshold ואז יורדים – מתעלמים.

   המטרה: 
   - רעש קל / קליקים / נשימות → לא נשלחים.
   - דיבור אמיתי (רצף) → כן נשלח.

3. **לא לשנות gain / לא לנרמל**:
   - לא לשחק עם ההגברה (gain) של האודיו.
   - רק gate לפי RMS כמו שמתואר.
   - Twilio כבר שולח μ-law ב-8kHz, אנחנו רק מחליטים מה כן/לא עובר הלאה.

=========================
3. הגדרות VAD ב-OpenAI
=========================

את VAD של OpenAI אל תעשה אגרסיבי מדי כדי שלא יחתוך דיבור אמיתי:

ב-configure_session של ה-Realtime client:

- תשאיר input_audio_transcription עם whisper-1 (בלי language).
- עבור vad / turn_detection (אם בשימוש):

  - vad_threshold אל תעלה ל-0.7. 
    • תשתמש ב-0.5–0.6 מקסימום, כדי שלא יהיו חיתוכים מוקדמים.
  - silence_duration_ms אפשר להשאיר 600–800ms.
  - smoothing_duration_ms ~200ms בסדר.

הרעיון:  
אנחנו כבר עושים **Gate בצד שלנו**. ה-VAD של OpenAI צריך להיות "נורמלי", לא אולטרה-קשוח, כדי שכשכבר מגיע דיבור – הוא יוכר כדיבור.

==============================
4. סינון תמלולים אחרי Whisper
==============================

תשאיר רק שכבת סינון בסיסית, בלי לפסול אנגלית:

א. תשאיר:
   - אם התמלול ריק או קצר מאוד (פחות מ-3 תווים בנטו) → להתעלם.
   - אם זה נראה ג׳יבריש / רעש מובהק (לדוגמה תווים לא קריאים / full noise) → להתעלם.

ב. תבטל לגמרי:
   - כל פילטר בסגנון "אם אין אותיות עבריות → reject".
   - כל לוגיקות שמפילות תמלול רק כי הוא באנגלית.

ג. תעדכן את ה-prompt כך שה-AI תמיד:
   - מבין את הטקסט כפי שהוא (שפה כלשהי).
   - מנסח תשובה בעברית.

======================
5. לוגים לאבחון מהיר
======================

תוסיף כמה לוגים כדי שאוכל להבין מה קורה:

1. כשאתה מחליט לשלוח chunk ל-OpenAI:
   - הדפס:
     "[AUDIO_GATE] rms={rms:.1f}, threshold={audio_gate_threshold:.1f}, send_to_openai=True"

2. כשאתה חוסם chunk:
   - "[AUDIO_GATE] rms={rms:.1f}, threshold={audio_gate_threshold:.1f}, send_to_openai=False"

3. כשמתקבל תמלול:
   - "[WHISPER] transcript='{text}', len={len(text)}"

כך נוכל לראות:
- אם בשקט מוחלט עדיין אתה שולח ל-OpenAI (ואז הבעיה בגייט).
- או שאולי ה-gate תקין אבל Whisper והמנוע עדיין עושים הלוסינציות.

חשוב:
- אל תחזיר את הפילטרים שמפילים אנגלית.
- אל תיגע עכשיו במודל / tokens / appointment logic – רק:
  • שפה (תמיד לענות בעברית)
  • AUDIO GATE לפי RMS + noise_floor
  • הגדרות VAD מתונות
  • ביטול הפילטר שמפיל אנגלית.