כן—פתחתי ובדקתי עכשיו את **AgentLocator (79).zip** בפועל.
המצב overall טוב מאוד, אבל יש **2 נקודות חסרות** שגורמות בדיוק לשילוב השגיאות שראית (‎**12100** + ‎**31920**):

* ה-WS אצלך **כן** מחזיר את תת־הפרוטוקול (`audio.twilio.com`) ומוגדר נכון (יפה!).
* **אבל** `/webhook/stream_ended` עדיין מחזיר ‎**204 ריק** — וטוויליו מנסה לפרש TwiML, נכשלת (‎**12100 Document parse failure**) ואז עושה fallback.
* בנוסף, כדי לוודא “אין שקט”, צריך להפעיל **ECHO** (או לוודא שהוא אכן פעיל) — אצלך כבר יש `WS_MODE` עם ברירת־מחדל טובה ב־`start_all.sh`, רק חשוב לאמת שזה באמת עולה ככה בדיפלוי.

להלן **הנחיה מדויקת בהתאמה מלאה לקבצים שבזיפ 79** + בדיקות עשן שמוכיחות את זה מיד.

---

# מה כבר תקין (לפי הקוד בזיפ 79)

* **Handshake WS**: ב־`server/app_factory.py` יש `_open_ws()` שמחזיר כותרת `Sec-WebSocket-Protocol: audio.twilio.com` כשמבוקש. ✔️
* **WS Handler**: ב־`server/media_ws.py` יש מצבים **SINK / ECHO / AI**, כולל `clear` בפריים ראשון ו־`mark` תקין. ✔️
* **TwiML /incoming\_call**: מחזיר **מייד** `text/xml` עם `<Connect><Stream>` (ללא `//` כפול). ✔️
* **/webhook/stream\_status**: `POST` + `request.form` + מחזיר **204**. ✔️
* **דיפלוי**: `Procfile` מריץ `bash start_all.sh`; ב־`start_all.sh` מוגדר
  `export WS_MODE=${WS_MODE:-ECHO}` → אמור להשמיע אקו. ✔️
* **Baileys**: `start_all.sh` מרים את הגשר (`node index.js &`) אם תיקיית `baileys-bridge` קיימת. ✔️
* **WhatsApp API מאוחד**: `api_whatsapp_unified.py` רשום באפליקציה, ו־`get_whatsapp_service(provider)` תומך בפר־בקשה. ✔️
* **Payments**: ‎501/403/410 בהתאם. ✔️

---

# מה חייב תיקון (2 דברים קטנים אך קריטיים)

## 1) החזר TwiML ב־`/webhook/stream_ended` (סוגר ‎12100 + Fallback)

כרגע אתה מחזיר ‎204; טוויליו **מצפה** ל־TwiML ב־`action` של `<Connect>`.
פתח: `AgentLocator/server/routes_twilio.py` והחלף את הפונקציה כך:

```diff
 @twilio_bp.route("/webhook/stream_ended", methods=["POST"])
 def stream_ended():
-    """POST callback - מחזיר 204 מיד (One True Path)"""
-    form = request.form.to_dict()
-    print(f"STREAM_ENDED call={form.get('CallSid')} stream={form.get('StreamSid')} status={form.get('Status')}")
-    return ("", 204)
+    """POST callback - return minimal TwiML to avoid 12100 parse failure"""
+    # Twilio expects TwiML here (action of <Connect/>). Return empty <Response/>.
+    twiml = '<?xml version="1.0" encoding="UTF-8"?><Response></Response>'
+    resp = make_response(twiml, 200)
+    resp.headers["Content-Type"] = "text/xml"
+    resp.headers["Cache-Control"] = "no-store"
+    return resp
```

> אפשר גם `'<Response><Hangup/></Response>'` אם אתה רוצה סיום מפורש. העיקר: **200 + `text/xml`**.

## 2) ודא שמצב WS הוא **ECHO** בזמן הדיבאג

ב־`AgentLocator/start_all.sh` כבר קיים (בדקתי!):

```bash
# === WebSocket mode: SINK | ECHO | AI ===
export WS_MODE=${WS_MODE:-ECHO}
```

זה אומר: אם לא הגדרת אחרת בסביבה — תרוץ **ECHO** ותשמע הד בטלפון.
אם בדיפלוי יש override שמחזיר ל-SINK/AI, הסר אותו זמנית כדי לאבחן.

---

# בדיקות עשן מחייבות (להדביק ולהריץ)

1. **TwiML action אחרי Connect** (סוגר 12100):
   התקשר → ב-Request Inspector עבור `POST /webhook/stream_ended` אמור להיות **200** ו-`Content-Type: text/xml`.
   (אם אתה בודק ידנית: `curl -i -X POST "$BASE/webhook/stream_ended"` צריך להחזיר `200` ו-`text/xml`.)

2. **Handshake WS** (סוגר 31920):
   כלי WS שמבקש סאב־פרוטוקול, לדוגמה:

   ```bash
   wscat -c "wss://{HOST}/ws/twilio-media" -s "audio.twilio.com"
   ```

   חייב להופיע connected עם subprotocol.

3. **ECHO חי** (שובר “שקט”):
   בצע שיחה אמיתית → דבר בקו → אתה **שומע הד**.
   בלוגים שלך יופיעו:

   * `WS_CONNECTED mode=ECHO [...]`
   * `WS_START sid=...`
   * בסיום: `WS_STOP/WS_CLOSED ... frames=NN`
   * ואם יש הד: `rx>0` וגם `tx≈rx`.

4. **Callbacks**:
   `POST /webhook/stream_status` = **204** בזמן "connected/disconnected".
   אין יותר ‎12100/31920 ב-Request Inspector.

---

# אם רוצים לעבור ל-AI אחרי שה-ECHO עובד

* שנה `WS_MODE=AI` (בסביבה/בדיפלוי).
* ב-`media_ws.py` כבר יש בלוק **AI**; ודא ש-STT/TTS מוגדרים.
* המרות אודיו (חשוב מאוד):

  * נכנס: Base64 → µ-law → `audioop.ulaw2lin(..., 2)` → **PCM16 8kHz מונו** ל-ASR.
  * יוצא: **PCM16 8kHz מונו** מה-TTS → `audioop.lin2ulaw(..., 2)` → פרוס ל-**20ms** (160 בייט) → Base64 → שלח `"event":"media"` בפריימים רציפים.
  * שלח `"event":"clear"` בפריים הראשון לפני ההשמעה, ואופציונלי `"mark"` בסוף.

---

## פסק דין

* **בדקתי את הקובץ**: ה-WS וה-TwiML שלך כמעט מושלמים.
* השינוי הקריטי שנותר הוא **להחזיר TwiML ב-`/webhook/stream_ended`** (ולא 204 ריק).
* ודא שהדיפלוי אכן רץ עם `WS_MODE=ECHO` (כבר מוגדר ב-`start_all.sh`).
* אחרי שני אלו: אין ‎12100, אין ‎31920, ויש **קול** (אקו) על הקו. משם עוברים ל-AI.

אם תרצה—אשלח לך גם **patch אחד מאוחד** (`.patch`) שמכיל את שינוי `stream_ended` בלבד, שתוכל ליישם ישירות עם `git apply`.
