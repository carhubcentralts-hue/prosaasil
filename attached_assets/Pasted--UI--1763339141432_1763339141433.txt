סגור, בוא נעשה הנחיית־על אחת שתחפה על הכול בבת-אחת:
פתיח קצר, תיאום פגישות אמיתי, שעות פתיחה מה-UI, בלי שקרים על שליחת פרטים, בַּארג’־אין נורמלי, ושלא תדבר סתם כששקט.

תעתיק אחד-לאחד ל-Agent 3:

⸻

🧠 הנחיית־על – ייצוב שיחות Realtime + תיאום פגישות

המטרה:
	1.	פתיח קצר וברור מה-AI בלבד, בלי טקסטים ארוכים.
	2.	תיאום פגישות אמיתי לפי הגדרות התורים ב-DB, בלי להמציא שעות ובלי “שלחתי פרטים”.
	3.	אין Realtime tools – תיאום פגישות רק דרך ה-NLP הצד-שרת שכבר בנית (appointment_nlp + create_appointment_from_realtime).
	4.	Barge-in חכם – אם הלקוח מדבר, ה-AI נחתך מיד; אם הלקוח שותק – ה-AI לא ממציא דיבור חדש.
	5.	כל השינויים נקודתיים: בקבצים media_ws_ai.py, realtime_prompt_builder.py, appointment_nlp.py וכל מה שכבר קיים – בלי לשבור את מה שעובד.

⸻

1. פתיח קצר וברור מה-AI

א. ב־realtime_prompt_builder.py
בעיצוב ה-system prompt של Realtime תוסיף בלוק חוקים ברור:
	•	“בפתיחת השיחה תאמר רק משפט פתיחה אחד קצר (עד 2 משפטים) שמציג מי אתה ומה אתה עושה, ואז תשאל שאלה פתוחה קצרה (‘איך אפשר לעזור?’).
	•	אל תתני מונולוג ארוך.
	•	אחרי הפתיח – תעני רק כשהלקוח מדבר שוב.
	•	אם יש שקט מעל 15 שניות – פעם אחת בלבד מותר לשאול ‘אתה עדיין על הקו?’. אם עדיין שקט – לסיים בנימוס.”

ודא שה-temperature של המודל בשיחות טלפון הוא נמוך (0.15–0.2).

ב. אין Greeting נפרד מגוגל
ב־media_ws_ai.py ודא:
	•	כל פתיח מוקלט/Google TTS כבוי כש־USE_REALTIME_API=True.
	•	מי שמדבר ראשון זו ה-AI של OpenAI בהתאם לפרומפט, לא TTS חיצוני.

⸻

2. Realtime – בלי TOOLS בכלל

ה-Realtime כרגע הסתבך עם “tools שלא רשומים”.
לשיחות טלפון אנחנו מוותרים לגמרי על Realtime Tools.

ב־openai_realtime_client.py / media_ws_ai.py:
	1.	בקריאה ל־session.create / configure_session תשאיר:
	•	model: gpt-4o-realtime-preview (או mini אם כבר הוספת)
	•	voice: shimmer (או מה שהגדרת)
	•	input_audio_format: "g711_ulaw"
	•	output_audio_format: "g711_ulaw"
	•	input_audio_transcription: {"model": "whisper-1"} ← חובה
	•	ללא שדה tools וללא tool_choice.
	2.	מחק/נטרל כל קוד שמנסה:
	•	לרשום tools ל-Realtime
	•	לטפל ב-response.function_call / response.tool_call
	•	להמיר Pydantic ל-tools ל-Realtime
זה רק לשיחות טלפון, AgentKit של WhatsApp נשאר עם tools כרגיל.

⸻

3. תיאום פגישות – רק דרך ה-NLP בצד השרת

אנחנו נשארים עם הארכיטקטורה שנבנתה:
	•	appointment_nlp.py עם GPT-4o-mini
	•	CallSession בטבלה
	•	create_appointment_from_realtime / ensure_lead / update_lead_on_call בשרת

א. ודא זרימה מלאה:

ב־media_ws_ai.py:
	1.	אחרי כל conversation.item.input_audio_transcription.completed של הלקוח
→ קח את conversation_history העדכני
→ קרא ל־appointment_nlp.extract_action(…) (או איך שקראת לפונקציה).
	2.	אם ה-NLP מחזיר action = "create_appointment" עם תאריך/שעה/שם:
	•	בדוק זמינות מול BusinessSettings / AppointmentSettings:
	•	opening_hours_json (אם ריק – fallback ל-working_hours)
	•	slot_size_min
	•	min_notice_min
	•	אם הזמן לא חוקי/לא בשעות → אל תיצור פגישה. תעדכן flag שה-AI צריך להגיד:
“השעה שבחרת מחוץ לשעות הפעילות, בוא נבחר שעה אחרת.”
	•	אם הזמן חוקי → קרא ל־create_appointment_from_realtime(...)
(שאתה כבר כתבת) ושמור את ה־appointment_id ב־CallCrmContext.
	3.	אחרי יצירת פגישה מוצלחת, עדכן state בשיחה (למשל self.appointment_confirmed=True)
כדי שלא תיצור תור כפול.
	4.	ב-system prompt תוסיף חוק:
	•	“מותר לך להגיד שהפגישה נקבעה רק אם השרת יצר אותה באמת.
לעולם אל תגידי ‘קבעתי לך פגישה’ או ‘שלחתי פרטים’ אם הכלי לא דיווח על הצלחה.”
(הכלי = צד השרת; אתה כבר מוסיף למסרים הפנימיים תגית / טקסט בסגנון [SERVER] appointment_created – היעזר בזה.)

ב. בלי שקרים על שליחת פרטים

באותו prompt:
	•	“אל תגידי ‘שלחתי לך הודעת וואטסאפ/SMS עם הפרטים’ – שירות זה כרגע לא פעיל בשיחות טלפון.
אם שואלים על פרטים – תגידי: ‘אעביר את הפרטים לנציג והוא יחזור אליך בהמשך.’”

⸻

4. Barge-in אמיתי – אם הלקוח מדבר, ה-AI נחתכת

ב־media_ws_ai.py:
	1.	הוסף שדות למצב השיחה במחלקת MediaStreamHandler:

self.is_ai_speaking = False
self.has_pending_ai_response = False
self.last_user_turn_id = None
self.last_ai_turn_id = None

	2.	בעת קבלת אירועים מ-Realtime:

	•	כשמגיע response.audio.delta / response.output_item.added
→ self.is_ai_speaking = True.
	•	כשמגיע response.audio.done או response.output_item.done
→ self.is_ai_speaking = False
→ self.has_pending_ai_response = False.
	•	כשאתה יוצר conversation.item.create עבור המשתמש
→ עדכן self.last_user_turn_id ושים has_pending_ai_response = True.

	3.	בלוגיקת ה-VAD (שאתה כבר קורא לה כשיש REAL_VOICE rms=...):

	•	אם self.is_ai_speaking היא True וה-RMS מעל הסף (כלומר הלקוח התחיל לדבר):
	•	שלח ל-Realtime פקודת ביטול (אם כבר יש לך helper כזה; אחרת:
response.cancel / input_audio_buffer.clear לפי מה שהטמעת).
	•	הגדר self.is_ai_speaking = False.
	•	התחל utterance חדש של המשתמש (state → PROCESSING) בלי לחכות לסוף המשפט של ה-AI.

⸻

5. לא לדבר כששקט – סינון רעשים & Guard

א. חיזוק VAD

במחלקה:
	•	העלה קצת את ה־threshold:

self.vad_threshold = 260.0   # במקום ~200
self.barge_in_rms_threshold = 260.0


	•	הגדל משך דיבור מינימלי לפני שאתה מכריז על utterance:
אם יש לך משתנה בסגנון min_voice_ms – קבע ל־800–1000
(כל מה שפחות מזה -> noise / clearing throat).

במקום שבו אתה עושה:

STATE -> PROCESSING | len=..., silence_ms=...

ודא שמחשבים גם משך כולל במילישניות, ואם קצר מהסף – אל תשלח ל-Realtime ול-appointment_nlp, רק:

print(f"[TURN] Ignoring short/noisy segment: duration={ms}, rms={rms}")

ב. Guard ליצירת תגובה

לפני שאתה שולח user-item חדש ל-Realtime:
	•	אם has_pending_ai_response עדיין True → אל תיצור response נוסף; רק לוג:
[GUARD] Skipping AI response – previous response still pending.

כך לא יהיו סיטואציות שהיא “מקשקשת” עוד תשובה בלי שהייתה באמת אמירה חדשה שלך.

ג. Prompt

ב-system prompt:
	•	“אם יש שקט מלא אחרי שענית – אל תתחילי נושא חדש לבד.
תמתיני שהלקוח יגיד משהו.
רק אם יש שקט ארוך מאוד (יותר מ-15 שניות) מותר פעם אחת לשאול אם הוא עדיין על הקו.”

⸻

6. בדיקות חובה אחרי השינויים
	1.	שיחת טסט בלי לדבר בכלל:
	•	ה-AI נותנת פתיח קצר אחד, שואלת איך אפשר לעזור → אם שקט מוחלט → אחרי 15 שניות:
“אתה עדיין על הקו?” → עוד שקט → ניתוק מנומס.
	•	אין עוד “קשקושים” באמצע.
	2.	שיחת טסט עם תיאום פגישה:
	•	“אני רוצה פגישה מחר בשש בערב”
	•	בלוגים:
	•	Transcription completed
	•	[NLP] appointment action detected
	•	create_appointment_from_realtime(...)
	•	appointment_created
	•	ה-AI אומרת: “קבעתי לך פגישה ל-…”.
	•	אם מבקשים שעה מחוץ לשעות → לא נוצרת פגישה, וה-AI אומרת שבשעה הזו העסק סגור ומציע חלופות.
	3.	לדבר מעל הקול שלה:
	•	ברגע שאתה מתחיל לדבר, ה-AI נחתכת ומפסיקה את האודיו, ואתה נכנס ל-PROCESSING חדש.

⸻

זהו. ההנחיה הזאת מכסה:
	•	פתיח
	•	תיאום פגישות אמיתי לפי הגדרות תורים
	•	בלי tools ב-Realtime
	•	בלי שקרים על “שלחתי פרטים”
	•	Barge-in אמיתי
	•	פחות חפירות, אפס “המצאות” בשקט.

תדביק לו את זה כמו שהוא, ואם אחרי זה משהו עדיין מרגיש מוזר – תשלח לי לוג ספציפי ונכוון עד הסוף.