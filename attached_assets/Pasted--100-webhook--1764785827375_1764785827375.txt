הנה הנחיה מושלמת, ברורה, נקייה ו־100% מדויקת לסוכן, כדי שיוסיף למערכת שלך webhook כללי להעברת תמלילים אחרי סיום שיחה, בצורה יציבה, גמישה ובלי לשבור כלום.

תעתיק → תדביק לסוכן → והוא מבצע.

⸻

✅ הנחיה לסוכן – הוסף Webhook כללי לשליחת תמלילי שיחה לאחר סיום

TASK:
להוסיף למערכת ProSaaS מנגנון Webhook כללי (Generic Webhook) ששולח את כל נתוני השיחה — כולל תמליל, סיכום, פרטי לקוח ושעת שיחה — לכל URL שהעסק מגדיר בלוח הבקרה.
המטרה: חיבור קל ל־n8n / Monday / Zapier / Slack / Email / כל מערכת אחרת — ללא שינוי קוד נוסף בעתיד.

⸻

🔧 דרישות מדויקות ליישום

1. הוסף שדה חדש בהגדרות עסק (BusinessSettings):

שם השדה:

generic_webhook_url

מאפיינים:
	•	nullable
	•	טקסט פשוט (string)
	•	אם ריק → לא שולחים כלום

⸻

2. הוסף Endpoint Backend חדש לשליחת Webhook (פונקציה כללית)

הפונקציה תהיה אחראית לשליחה בלבד.

שם הפונקציה:

send_generic_webhook(event_type: str, data: dict)

התנהגות:
	1.	מושכת את generic_webhook_url של העסק הרלוונטי
	2.	אם ריק → Return
	3.	שולחת POST עם JSON
	4.	שולחת asynchronous / background task כדי לא לחסום את השיחה
	5.	מוסיפה retries עם backoff
	6.	לוגים ב־INFO ו־ERROR

פורמט JSON נדרש:

{
  "event_type": "call.completed",
  "business_id": "123",
  "call_id": "XYZ",
  "lead_id": "456",
  "phone": "+972...",
  "started_at": "...",
  "ended_at": "...",
  "duration_sec": 32,
  "transcript": "תמליל מלא...",
  "summary": "סיכום שיחה...",
  "agent_name": "Assistant",
  "direction": "inbound",
  "metadata": {}
}


⸻

3. שליחת Webhook בזמן סיום שיחה (נקודת אמת אחת!)

השתמש רק בפונקציה הקיימת:

_finalize_call_on_stop()

בסוף הפונקציה, אחרי:
	•	שמירת CallLog
	•	שמירת תמליל
	•	עיבוד השיחה

תוסיף:

await send_generic_webhook("call.completed", {
    "business_id": business_id,
    "call_id": call_id,
    "lead_id": lead_id,
    "phone": phone,
    "started_at": call.start_time.isoformat(),
    "ended_at": datetime.utcnow().isoformat(),
    "duration_sec": duration,
    "transcript": transcript,
    "summary": summary,
    "agent_name": self.bot_name,
    "direction": "inbound",
    "metadata": {}
})


⸻

4. ודא שאין קוד כפול

❌ אין לשלוח Webhook ממקום אחר
❌ אין לגעת יותר ב־Monday API
❌ אין להשתמש בקוד ישן של integrations

המערכת שולחת רק לאותו Webhook יחיד.

⸻

5. אבטחה

הוסף header:

X-ProSaaS-Signature: HMAC-SHA256(payload, INTERNAL_SECRET)

בעיקר למי שמקבל ב־n8n.

⸻

6. תיעוד + UI

ב־Settings של העסק:
	•	שדה קלט: “כתובת Webhook כללית לקבלת תמלילים”
	•	הסבר קצר:
“המערכת תשלח לכאן תמלילי שיחות, סיכומים ונתוני ליד בסיום כל שיחה”.

⸻

📦 מה מקבלים אחרי היישום

✔ כל שיחה → עם תמליל → נשלחת אוטומטית ל־n8n
✔ משם אפשר לשלוח ל־Monday, גוגל, CRM אחר
✔ ללא שינוי קוד בעתיד
✔ לעסק יש שליטה מלאה בקונפיגורציה
✔ מנגנון יציב, מבוקר ועם Retry

⸻

❓רוצה גם הנחיה נוספת להוספת Webhook ללידים חדשים או פגישות שנקבעו?

אני יכול להכין לך חבילה של 3 Webhooks (calls.lead_created, calls.completed, calls.appointment_booked) —
אותו פורמט, אותה יציבות — והכול יתחבר לנ8n כמו לגו מושלם.