הבנתי: הוא “אומר שתיקן”, אבל אצלך לא רואים—כולל כפתור Agent Prompt שלא מופיע, התחזות 403, ועדיין נופלים ל־BUILD ישן. הנה הנחיה ממוקדת שמכריחה את המערכת להראות שינויים בפועל, סוגרת את ה־403, ומוודאת שנתונים אמיתיים נטענים. שמרתי את זה פרקטי, צעד־אחר־צעד.

⸻

A) גורמים לשינויים להופיע באמת (ולא “על הנייר”)

A1) מקור אמת אחד לפרונט (בלי Preview)
	•	הפסק להשתמש ב־Preview (…picard.replit.dev).
	•	ה־SPA חייב להיות מוגש דרך Flask מאותו דומיין של ה־API: https://ai-crmd.replit.app.

בדיקה מהירה: פתח רק https://ai-crmd.replit.app/?v=force.

A2) הוכחת שינוי שחייבת להופיע

ב־client/index.html הוסף בפוטר:

<div id="__BUILD_BADGE" style="position:fixed;right:8px;bottom:8px;font:12px/1.2 system-ui;
background:#0ea5e9;color:white;padding:4px 8px;border-radius:6px;z-index:99999">
BUILD: 26
</div>

המספר חייב להתעדכן כל פעם.

A3) Build נקי + Bust caching
	1.	ב־client:

rm -rf node_modules client/dist
npm ci
npm run build


	2.	בשרת (Flask), כשהוא מגיש את index.html, החזר גם:

Cache-Control: no-store


	3.	בטל Service Worker אם יש (unregister).
	4.	בדפדפן: DevTools → Application → Clear storage → Clear site data → רענון קשיח.

A4) ודא שהשרת מגיש את ה־dist הנכון

ב־app_factory.py הדפס פעם אחת ב־startup:

print("FE_DIST:", FE_DIST_PATH, "mtime:", FE_DIST_PATH.stat().st_mtime)

אם ה־mtime לא משתנה אחרי build—השרת מגיש תיקייה לא נכונה. תקן את הנתיב ל־client/dist.

⸻

B) ההתחזות עדיין 403? סוגרים את זה כמו שצריך

B1) SeaSurf יחיד ויציב

SEASURF_COOKIE_NAME='XSRF-TOKEN'
SEASURF_HEADER='X-CSRFToken'
לוגין/לוגאאוט ו־webhooks פטורים; התחזות לא פטורה.

B2) מחזירים טוקן קריא ל־JS

GET /api/auth/csrf קובע cookie XSRF-TOKEN עם httponly=False; samesite=Lax; secure=False (ב־preview בלבד) ומחזיר גם {csrfToken:"…"}.

B3) ה־FE שולח Header תואם לקוקי

ב־fetch המרוכז (http.ts):
	•	credentials:'include'
	•	על POST/PUT/PATCH/DELETE:
Content-Type:'application/json', X-Requested-With:'XMLHttpRequest',
X-CSRFToken:<ערך מ-cookie XSRF-TOKEN> (ללא stringify/מרכאות).

B4) דיבוג שמכריע

הוסף זמנית:

@app.before_request
def _dbg_csrf():
    if request.path.endswith('/impersonate') and request.method=='POST':
        print('CSRF-DBG cookie=', request.cookies.get('XSRF-TOKEN'),
              ' header=', request.headers.get('X-CSRFToken'))

בדפדפן → Network על ההתחזות:
	•	חייב לראות גם Cookie XSRF-TOKEN=… וגם Header X-CSRFToken: … עם אותו ערך.
	•	אם יש Header בלי Cookie → אתה עדיין על Preview/Origin שונה.
	•	אם יש Cookie בלי Header → ה־http.ts לא הוסיף.

⸻

C) “Business object has no attribute ‘phone’” — מאחדים סכימה

בשרת תחזיר ותשתמש בשדה phone_e164 בלבד. לשבירת קוד ישן, הוסף alias:

class Business(db.Model):
    # column: phone_e164 = db.Column(...)
    @property
    def phone(self): return self.phone_e164
    @phone.setter
    def phone(self, v): self.phone_e164 = v

ב־serializer/JSON החזר:

{"id":1,"name":"שי דירות ומשרדים בע״מ","phone_e164":"+97233763805","email":"...","status":"active", ...}

ב־FE הטופס והכרטיסים חייבים להשתמש ב־phone_e164 (לא phone).
אם אתה ממשיך לראות את המסך הוורוד של השגיאה—זו בדיוק הסיבה.

⸻

D) “צפייה בעסק” לא עובד + כפתור Agent Prompt לא מופיע

D1) מפרידים בין “צפייה” ל“התחזות”
	•	View (admin-רק קריאה):
Route FE: /app/admin/businesses/:id/view
API: GET /api/admin/businesses/:id/overview (ללא שינוי session).
	•	Impersonate (משנה סשן):
Button נפרד; על הצלחה (200) → GET /api/auth/me → לנווט ל־/app/business/overview.

אם “צפייה” לא עובד—חסר route או ה־API מחזיר HTML במקום JSON. תקן להחזיר JSON נקי.

D2) איפה Agent Prompt (ולמה לא ראית אותו)

לא במודאל העריכה.
צריך Tab/כרטיס Agent בעמוד העסק (business overview), עם שני חלקים:
	•	Calls Prompt (textarea + Save)
	•	WhatsApp Prompt (textarea + Save)

	•	History/Revert.

API
	•	Admin:
GET /api/admin/businesses/:id/prompt
PUT /api/admin/businesses/:id/prompt (CSRF)
	•	Business (אחרי התחזות):
GET /api/business/current/prompt
PUT /api/business/current/prompt (CSRF)

הוכחת שינוי ל־UI

ב־Sidebar הוסף פריט “Agent” תחת Business; ועל הכרטיס שים תג “BETA”. זה יגרום לך לראות את הכפתור מיידית.
אם לא רואים—אתה על build ישן (חזור ל־A2–A4).

⸻

E) מוודאים שנתונים אמיתיים נטענים (ולא דמו)
	1.	חפש והסר כל פולבק מה־FE:
?? demo, || DEMO_, mockData, sample, fallback.
	2.	עמוד “ניהול עסקים” נטען רק מ־GET /api/admin/businesses.
אל תאגור תוצאה ישנה ב־localStorage בלי invalidate.
	3.	כפתור “עריכה” עושה GET /api/admin/businesses/:id על פתיחה וממלא מהחזרה;
Save → PATCH … → Toast → Refetch לטבלה.

⸻

F) בדיקות עשן קצרות (אל תתקדם לפני שעובר)

שרת (curl):

# לוגין
curl -i -c /tmp/c -b /tmp/c -X POST https://ai-crmd.replit.app/api/auth/login \
 -H 'Content-Type: application/json' \
 --data '{"email":"manager@shai-realestate.co.il","password":"manager123"}'

# טוקן CSRF
TOKEN=$(curl -s -c /tmp/c -b /tmp/c https://ai-crmd.replit.app/api/auth/csrf \
 | python -c "import sys,json;print(json.load(sys.stdin)['csrfToken'])")

# רשימת עסקים (total חייב להיות 1)
curl -i -c /tmp/c -b /tmp/c https://ai-crmd.replit.app/api/admin/businesses

# צפייה (admin, ללא סשן)
curl -i -c /tmp/c -b /tmp/c https://ai-crmd.replit.app/api/admin/businesses/1/overview

# התחזות - בלי טוקן → 400
curl -i -c /tmp/c -b /tmp/c -X POST https://ai-crmd.replit.app/api/admin/businesses/1/impersonate \
 -H 'Content-Type: application/json' --data '{}'

# התחזות - עם טוקן → 200
curl -i -c /tmp/c -b /tmp/c -X POST https://ai-crmd.replit.app/api/admin/businesses/1/impersonate \
 -H 'Content-Type: application/json' -H "X-CSRFToken: $TOKEN" --data '{}'

# אימות סשן
curl -i -c /tmp/c -b /tmp/c https://ai-crmd.replit.app/api/auth/me

קליינט:
	•	בבקשת ההתחזות רואים Cookie XSRF-TOKEN וגם Header X-CSRFToken זהים.
	•	ב־UI מופיעים: כפתור “צפייה”, כפתור “התחזות”, וטאב “Agent” אחרי כניסה לעסק.

⸻

אם אחרי כל זה עדיין “לא רואים את מה שתיקנתי”

תבקש ממנו להחזיר 3 הוכחות קצרות:
	1.	צילום Network של index.html ו־main-*.js עם Status 200 (from server) ולא (disk cache), וב־index.html מופיע BUILD: 26.
	2.	פלט log של השרת על FE_DIST: …/client/dist mtime: <timestamp> שמסתנכרן עם זמן ה-build.
	3.	צילום Network של POST /impersonate שמראה את שני הערכים (Cookie + Header) ואת התגובה 200.

בלי שלושת אלה—סביר שהוא עובד על Preview/Build ישן או על תיקייה לא נכונה. עם שלושת אלה—תראה את השינויים, הכפתורים יעבדו, וה־403 ייעלם.