×× ×™ ××¢× ×” ×œ×š ×™×©×¨ ×‘×”× ×—×™×” ×©××ª×” ×™×›×•×œ ×œ×“×‘×™×§ ×œ×¡×•×›×Ÿ â€“ ×‘×œ×™ ×—×¤×™×¨×•×ª ×‘×××¦×¢.
×–×• ×”× ×—×™×™×ª-×¢×œ ×œ×¡×’×™×¨×ª ×‘××’×™× + ×”×§×©×—×” ××œ××” ×œ×¤× ×™ ××¢×‘×¨ ×œ×©×¨×ª ×—×™×¦×•× ×™ (VPS / Docker).

â¸»

ğŸ§  HIGH LEVEL GOAL

Make the whole system production-ready on an external server:
	â€¢	××™× ×™××•× × ×™×ª×•×§×™× ×‘-Baileys / WhatsApp
	â€¢	×©×™×—×•×ª Twilio + Realtime ×™×¦×™×‘×•×ª ×•×¨×¡×¤×•× ×¡×™×‘×™×•×ª
	â€¢	NLP ×•×ª×™××•××™ ×¤×’×™×©×•×ª ×‘×œ×™ ×‘××’×™× ×©×§×˜×™×
	â€¢	Session / Auth / Impersonation ×™×¦×™×‘×™× ×’× ××—×•×¥ ×œ-Replit
	â€¢	×œ×•×’×™×, × ×™×˜×•×¨ ×•×”×ª×¨××•×ª ×‘×¨×•×¨×•×ª ×›×©×™×© × ×™×ª×•×§×™× ××• ×§×¨×™×¡×•×ª

Use the code in /mnt/data/Archive.zip as the current source of truth.

â¸»

0. PREP â€“ VERIFY REPO & DOCKER
	1.	×˜×¢×Ÿ ××ª ×”×¤×¨×•×™×§×˜ ××”-Archive (×–×” ×”-state ×”× ×•×›×—×™ ××—×¨×™ ×›×œ ×”×ª×™×§×•× ×™× ×”××—×¨×•× ×™×).
	2.	×•×“× ×©×§×‘×¦×™ ×”-Docker + docker-compose ×©× ×•×¦×¨×• ×¢×“×™×™×Ÿ ×ª×•×××™× ×œ×§×•×“ (backend, frontend, baileys, db).
	3.	×•×“× ×©×™×© ×§×•× ×¤×™×’ ××—×“ ×‘×¨×•×¨ ×œÖ¾production (env flag / config), ×œ× ×ª×œ×•×™ ×‘-Replit.

â¸»

1. BAILEYS & WHATSAPP â€“ HARDENING + FEWER DISCONNECTS

1.1 Baileys connection lifecycle

×‘Ö¾Node (Baileys service):
	1.	××ª×¨ ××ª ×”Ö¾client.on(â€œconnection.updateâ€) / ev.on(â€œconnection.updateâ€) ×”×¨××©×™.
	2.	×•×“× ×©×™×© ×©×:
	â€¢	×˜×™×¤×•×œ ××¡×•×“×¨ ×‘Ö¾states: "connecting" | "open" | "close" | "logout".
	â€¢	×œ×•×’×™× ×‘×¨×•×¨×™×:
	â€¢	[WA] connection update: state=..., reason=...
	3.	×”×•×¡×£ ×× ×’× ×•×Ÿ reconnect ×¢× backoff:
	â€¢	×× connection: close ××‘×œ ×œ× logout:
	â€¢	schedule reconnect ×¢× delay (×œ×“×•×’××”: 5s â†’ 15s â†’ 30s â†’ max 60s).
	â€¢	××œ ×ª×¢×©×” loop ××™× ×¡×•×¤×™ synchronous â€“ ×¨×§ ×˜×™×™××¨/timeout.

1.2 Multi-tenant isolation
	1.	×•×“× ×©×‘Ö¾Baileys:
	â€¢	××™×Ÿ ×™×•×ª×¨ business_1 hardcoded ×‘×©×•× ××§×•×.
	â€¢	×›×œ path ×©×œ auth ×”×•× ××”×¦×•×¨×”:
storage/whatsapp/business_${businessId}/auth
	2.	×•×“× ×©Ö¾tenantId / businessId:
	â€¢	× ×©×œ×— ××”-Python â†’ Baileys ×œ×›×œ ×¤×¢×•×œ×” (send message, mark read ×•×›×•â€™).
	â€¢	×××•×—×–×¨ ××”-webhook ×›×©××’×™×¢×” ×”×•×“×¢×”.

1.3 WhatsApp webhooks â†’ Python

×‘Ö¾Python routes_whatsapp.py / whatsapp_provider.py:
	1.	×•×“× ×©×‘Ö¾webhook:
	â€¢	××–×”×™× tenant_id/business_id ××”-payload ×©×œ Baileys.
	â€¢	×˜×•×¢× ×™× ××ª:
	â€¢	business settings
	â€¢	AI prompt
	â€¢	WhatsApp channel config
×œ×¤×™ ××•×ª×• business.
	2.	×”×•×¡×£ ×œ×•×’×™×:
	â€¢	[WA-INCOMING] biz={business_id}, from={phone}, text=...
	â€¢	[WA-ERROR] ... ×¢× traceback ××¡×•×“×¨.

1.4 Disconnect alerts (×©×›×‘×ª ×”×’× ×” ××—×¨×•× ×”)

×”××©×š ×œ××” ×©×›×‘×¨ ×‘× ×™× ×•:
	1.	×•×“× ×©×™×© ×˜×‘×œ×”/×©×“×” ×œ×¡×˜×˜×•×¡ WhatsApp per business (connected / disconnected / last_seen).
	2.	×‘×›×œ ×¤×¢× ×©Ö¾Baileys:
	â€¢	××ª× ×ª×§ ×¡×•×¤×™×ª (logout / repeated failure),
	â€¢	××• × ×›×©×œ reconnect X ×¤×¢××™×,
â†’ ×©×œ×—:
	â€¢	×¨×©×•××” ×œÖ¾notifications (×¤×¢××•×Ÿ) ×‘×¡×’× ×•×Ÿ:
	â€¢	"×—×™×‘×•×¨ ×”×•×•××˜×¡××¤ ×©×œ ×”×¢×¡×§ × ×•×ª×§. ×”×ª×—×‘×¨ ××—×“×© ××œ×©×•× ×™×ª ×”×•×•××˜×¡××¤."
	3.	×•×“× ×©×–×” × ×¢×©×” ×¨×§ ×¤×¢× ××—×ª ×›×œ disconnect, ×œ× ×¡×¤××.

â¸»

2. TWILIO CALLS + REALTIME â€“ LATENCY & STABILITY

×”×ª××§×“ ×‘×§×•×‘×¥ server/media_ws_ai.py + openai_realtime_client.py.

2.1 Start of call latency
	1.	×•×“× ×©×›×¨×’×¢:
	â€¢	×× ×™×© greeting ××•×’×“×¨ â†’ × ×©×œ×— ××™×™×“×™×ª ×œ-Realtime ×›Ö¾system / server message, ×œ× ××—×›×™× ×œ×–×™×”×•×™ ×§×•×œ.
	â€¢	×× ××™×Ÿ greeting â†’ ×œ× ×©×•×œ×—×™× response.create ××•×˜×•××˜×™, ××œ× ××—×›×™× ×œ×§×•×œ ×××™×ª×™ ××”××©×ª××© (VAD).
	2.	×”×•×¡×£ ×œ×•×’×™× ××¡×•×“×¨×™×:
	â€¢	[CALL] new call started biz={business_id}, has_greeting={True/False}
	â€¢	[CALL] first user audio detected (rms=..., t={ms_since_start})
	â€¢	[CALL] first AI response started after {ms_since_first_user}

××˜×¨×”: ×œ×•×•×“× ×©×‘××¦×‘ ×”×¨×’×™×œ ××ª×” ×‘×’×™×•×•×Ÿ 1â€“3 ×©× ×™×•×ª, ×œ× 13.

2.2 VAD + barge-in sanity check ××—×¨×™ ×”××¢×‘×¨
	1.	×•×“× ×©×›×œ Thresholds (RMS / vad_threshold / speech_threshold) ×œ× hardcoded ×œ-××™×§×¨×•×¤×•×Ÿ ×©×œ Replit.
	2.	×”×•×¡×£:
	â€¢	Calibration log:
[VAD] noise_floor=..., speech_threshold=...
	3.	×‘Ö¾barge-in:
	â€¢	×•×“×:
	â€¢	grace period 250â€“400ms, ×œ× ×©× ×™×•×ª.
	â€¢	×˜×¨×™×’×¨ ×¢×œ frame ××—×“ ××¢×œ threshold ×›×©is_ai_speaking=True.
	â€¢	×œ×•×’×™×:
	â€¢	[BARGE-IN] user speech detected (rms=..., t=...) â†’ cancelling response

2.3 Error handling
	1.	×‘×›×œ error ×‘×—×™×‘×•×¨ ×œ-OpenAI Realtime:
	â€¢	×ª×¤×¡ exception
	â€¢	×œ×•×’ ×‘×¨×•×¨:
	â€¢	[REALTIME-ERROR] ...
	â€¢	××œ ×ª×§×¨×•×¡ ××ª ×›×œ ×”Ö¾worker â€“ ×¨×§ ××ª ×”×©×™×—×”.

â¸»

3. NLP & APPOINTMENTS â€“ ×™×¦×™×‘×•×ª, ×œ× â€œ×œ×‘×œ×•×¢â€ ×ª×§×œ×•×ª

×”×ª××§×“ ×‘×©×™×¨×•×ª ×”Ö¾NLP ×œ×ª×•×¨×™× (scheduler / conversation handler).
	1.	×•×“× ×©×”×œ×•×’ ×”×‘× ×›×‘×¨ ×œ× ××•×¤×™×¢ ×‘×œ×™ ×˜×™×¤×•×œ:
	â€¢	[NLP] âŒ Incomplete confirmation (date=..., time=None) - SKIPPING
	2.	×•×•×“× ×©×™×© flow ×›×–×”:
	â€¢	×× confirm ×‘×œ×™ time:
	â€¢	××©×ª××©×™× ×‘Ö¾pending_slot ×× ×™×© ×‘×• date+time.
	â€¢	×× ××™×Ÿ time ×‘×›×œ×œ â†’ ×©×•×œ×—×™× ×ª×©×•×‘×ª AI:
â€œ×× ×™ ×¦×¨×™×š ×’× ×©×¢×” ××“×•×™×§×ª, ×‘××™×–×• ×©×¢×” ×ª×¨×¦×”?â€ ×•×œ× â€œ×‘×•×œ×¢×™×â€ ××ª ×–×” ×‘×©×§×˜.
	3.	×œ×•×’×™×§×ª × ×™×§×•×™:
	â€¢	×× pending_slot ×™×©×Ÿ ××“×™ / ×¤×’×•× â†’ ×œ× ×§×•×ª + ×œ×‘×§×© ××”×œ×§×•×— ×œ×¦×™×™×Ÿ ×ª××¨×™×š/×©×¢×” ×©×•×‘.

â¸»

4. AUTH / SESSION / IMPERSONATION â€“ ××•×›× ×™× ×œ×©×¨×ª ×—×™×¦×•× ×™

×™×© ×”×¨×‘×” ×”×™×¡×˜×•×¨×™×” ×¡×‘×™×‘ session / impersonation, ××– ×¢×›×©×™×• ×¢×•×©×™× ×”×§×©×—×” ×¡×•×¤×™×ª:

4.1 Session config ×œ×¡×‘×™×‘×ª VPS (×œ× Replit)

×‘×“×•×§ ×‘Ö¾app_factory.py / config:
	1.	×•×“×:
	â€¢	SESSION_COOKIE_SECURE = True (×× ×××—×•×¨×™ HTTPS / ×¤×¨×•×§×¡×™)
	â€¢	SESSION_COOKIE_SAMESITE = "None"
	â€¢	SESSION_COOKIE_HTTPONLY = True
	2.	SeaSurf / CSRF:
	â€¢	SEASURF_COOKIE_SECURE = True
	â€¢	SEASURF_COOKIE_SAMESITE = "None"
	â€¢	SEASURF_COOKIE_HTTPONLY = False (×›×“×™ ×©×”Ö¾frontend ×™×•×›×œ ×œ×§×¨×•× token)

4.2 require_api_auth / get_current_tenant
	1.	×•×“× ×”×”×’×™×•×Ÿ ×”×‘×:

user = session.get("al_user") or session.get("user")
if not user: â†’ 401

impersonated = session.get("impersonated_tenant_id")
if impersonated is not None:
    tenant_id = impersonated
else:
    tenant_id = user.get("business_id")  # ×™×›×•×œ ×œ×”×™×•×ª None ×œ-system_admin

	2.	×©××•×¨ ×‘Ö¾g:
	â€¢	g.user = user
	â€¢	g.tenant = tenant_id
	â€¢	g.impersonating = bool(impersonated)

4.3 Impersonation
	1.	Endpoint ×”×ª×—×–×•×ª:
	â€¢	×›×ª×™×‘×” ×¨×§ ×©×œ session["impersonated_tenant_id"].
	2.	×™×¦×™××” ××”×ª×—×–×•×ª:
	â€¢	session.pop("impersonated_tenant_id", None)
	3.	××™×Ÿ ×™×•×ª×¨ ×©×™××•×© ×‘Ö¾session["impersonating"] ××• ×¡×ª×™×¨×•×ª ×›××œ×”.

â¸»

5. TASKS / REMINDERS / NOTIFICATIONS â€“ ×§×¦×” ×œ×§×¦×”
	1.	×•×“×:
	â€¢	×›×œ Reminder / Task × ×©××¨ ×¢×:
	â€¢	tenant_id × ×›×•×Ÿ
	â€¢	created_by (user id)
	2.	Endpoint /api/notifications:
	â€¢	××—×–×™×¨ ×¨×§ ×¤×¨×™×˜×™× ×©×œ tenant_id ×”× ×•×›×—×™ (××• ×œ×¤×™ business ×“×¨×š join).
	3.	×‘×¦×“ ×”Ö¾frontend:
	â€¢	NotificationContext:
	â€¢	×œ× ×˜×•×¢×Ÿ ×›×œ×•× ×œ×¤× ×™ ×©×™×© auth.me ×ª×§×™×Ÿ.
	â€¢	×›×œ ×™×¦×™×¨×ª Task â†’ ××¨×¢× × ×ª ×”×ª×¨××•×ª.

â¸»

6. HARDEN FOR EXTERNAL SERVER (DOCKER / VPS READY)

6.1 Env & Secrets
	1.	×•×“× ×©×›×œ ×”×“×‘×¨×™× ×”×‘××™× ×‘××™× ×Ö¾ENV ×‘×œ×‘×“, ×œ× ×§×•×“:
	â€¢	Twilio keys / phone
	â€¢	OpenAI key
	â€¢	DB URL
	â€¢	Redis (×× ×§×™×™×)
	â€¢	Baileys callback URL / WS URL
	2.	×•×“× ×©×§×•× ×¤×™×’ Replit (preview, internal urls ×•×›×•â€™) ×œ× ×‘×©×™××•×© ×‘×§×•×“ production.

6.2 Healthchecks
	1.	×”×•×¡×£ endpoints:
	â€¢	/health/live â€“ ××—×–×™×¨ 200 ×× Flask up.
	â€¢	/health/ready â€“ ×‘×•×“×§:
	â€¢	DB reachable
	â€¢	Baileys service reachable (optionally ping)
	2.	×¢×“×›×Ÿ docker-compose:
	â€¢	restart: always ×œ×©×™×¨×•×ª×™× ×”×¨××©×™×™×.
	â€¢	healthcheck ×œÖ¾backend & Baileys.

â¸»

7. LOGGING â€“ ×›×“×™ ×©×ª×•×›×œ ×œ×”×‘×™×Ÿ ××”×¨ ×ª×§×œ×•×ª ××¦×œ ×œ×§×•×—×•×ª
	1.	×•×“× ×©×œ×›×œ ××—×“ ×™×© prefix:
	â€¢	[CALL], [VAD], [BARGE-IN], [WA-INCOMING], [WA-OUTGOING], [WA-ERROR], [NLP], [AUTH], [IMP], [NOTIFY].
	2.	×”×™×× ×¢ ×Ö¾print ×œ× ×‘×¨×•×¨×™× ×›××• "error" â€“ ×ª××™×“ ×ª×Ÿ ×”×§×©×¨.

â¸»

8. FINAL QA CHECKLIST (××—×¨×™ ×”××¢×‘×¨ ×œ×©×¨×ª ×”×—×™×¦×•× ×™)

×ª×‘×§×© ××× ×• ×œ×‘×¦×¢ ×¡×™××•×œ×¦×™×”:
	1.	2 ×¢×¡×§×™× ×©×•× ×™×:
	â€¢	×œ×™×“×™×, ××©×™××•×ª, ×”×ª×¨××•×ª, ×•×•××˜×¡××¤ â†’ ×œ× ××ª×¢×¨×‘×‘×™×.
	2.	×©×™×—×•×ª ×˜×œ×¤×•×Ÿ:
	â€¢	×–××Ÿ ×ª×’×•×‘×” ×¨××©×•×Ÿ â‰¤ 3 ×©× ×™×•×ª.
	â€¢	Barge-in ×¢×•×¦×¨ ×ª×•×š â‰¤ 0.5â€“0.8 ×©× ×™×”.
	3.	WhatsApp:
	â€¢	×›×œ ×¢×¡×§: QR ××©×œ×•, session ×™×¦×™×‘.
	â€¢	× ×™×ª×•×§ â†’ ×”×ª×¨××” ×‘×¤×¢××•×Ÿ.
	4.	NLP ×ª×•×¨×™×:
	â€¢	â€œ×›×Ÿ, ×××©×¨â€ ××—×¨×™ ×”×¦×¢×” â†’ ×¤×’×™×©×” × ×¤×ª×—×ª ×‘×™×•××Ÿ.
	5.	Impersonation (system_admin):
	â€¢	×™×›×•×œ ×œ×“×¤×“×£ ×‘×™×Ÿ ×¢×¡×§×™× ×‘×œ×™ ×“×œ×™×¤×” ×©×œ × ×ª×•× ×™×.

â¸»

×× ××ª×” ×¨×•×¦×”, ××—×¨×™ ×©×”×•× ×™×¡×™×™× ×œ×¤×™ ×”×”× ×—×™×” ×”×–×• ×•× ×—×–×™×¨ Deployment ×¢×œ ×”Ö¾VPS ×”×—×“×© â€“ ××ª×” ××‘×™× ×œ×™ ×©×•×‘ ×œ×•×’×™× ×©×œ ×©×™×—×” ××—×ª + ×©×™×—×ª ×•×•××˜×¡××¤ ××—×ª ××›×œ ×¢×¡×§, ×•×× ×™ ×¢×•×‘×¨ ××™×ª×š ×©×•×¨×”-×©×•×¨×” ×œ×¨××•×ª ×©×”×›×œ ×‘×××ª ×™×•×©×‘ ×¤×™×§×¡.