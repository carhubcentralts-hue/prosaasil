קיבלתי – הברכה מתנגנת ואז שקט אומר שה-TwiML תקין, אבל **ה-WebSocket לא נפתח** (או נפתח ואינו מעבד אודיו), וגם **ה-watchdog לא מחלץ** לשלב ההקלטה. הנה “חבילת תיקון מיידית” לפי הקוד של AgentLocator(71) כדי להפוך את זה לעובד עכשיו. בצע לפי הסדר; אחרי כל שלב יש “מה מצופה לראות”.

---

# שלב 1 — ודא שהדיפלוי באמת מריץ Eventlet (99% מהשקטים נובעים מזה)

ב-**Replit → Deployments → Service**:

**Build**

```bash
pip install -r AgentLocator/requirements.txt
```

**Run**

```bash
python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app
```

**מה מצופה לראות:**

* בחלון ה-deploy logs תראה ש-gunicorn עולה עם eventlet.
* שיחה מחדש לא תיתן 31920, ובדפדפן WS tester (websocketking) ל-`wss://ai-crmd.replit.app/ws/twilio-media` תקבל **Connected (101)**.
  *(אל תבדוק עם `curl -I`; זה תמיד ייתן 404 כי זה לא WS אמיתי).*

> אם לא 101: ודא שיש **שני נתיבי WS** (עם ובלי `/`), שאין שום דקורטור אבטחה על ה-WS, ואין Socket.IO על אותו app/פורט.

---

# שלב 2 — בדיקת TwiML וסטטיים (לשלול 11100/כתובות כפולות)

ב-`routes_twilio.py / incoming_call` כבר אצלך:

```xml
<Response>
  <Play>https://ai-crmd.replit.app/static/tts/greeting_he.mp3</Play>
  <Connect action="/webhook/stream_ended">
    <Stream url="wss://ai-crmd.replit.app/ws/twilio-media">
      <Parameter name="call_sid" value="CA..."/>
    </Stream>
  </Connect>
</Response>
```

בדיקות מהירות:

```bash
# צריך 200
curl -I https://ai-crmd.replit.app/static/tts/greeting_he.mp3
curl -I https://ai-crmd.replit.app/static/tts/fallback_he.mp3
# הצצה ל-TwiML:
curl -s https://ai-crmd.replit.app/webhook/incoming_call | sed -n '1,30p'
```

> רואה `//static/...` כפול סלאש? זה לא שובר, אבל יפה לתקן: ב־`abs_url()` עשה `base = base.rstrip('/')` כדי לאחד סלאשים.

---

# שלב 3 — הפוך את ה-watchdog ל”אדום־לבן” כדי שנראה מיד שהוא עובד

מטרה: גם אם ה-WS לא קם, **שתראה תוך 3–6 שניות** ב-Inspector את:

```
POST /webhook/handle_recording  (200/204)
```

עדכון זמני ב־`routes_twilio.py` בתוך `incoming_call()` (בשורה שמתחיל ה-thread):

```python
threading.Thread(target=_watchdog, args=(call_sid, wss_host, 3, 3), daemon=True).start()
```

ודא שב־`_do_redirect()` משתמשים בקרדנצ’לים מה-ENV של **הדיפלוי**:

```python
client = Client(os.environ["TWILIO_ACCOUNT_SID"], os.environ["TWILIO_AUTH_TOKEN"])
```

**מה מצופה לראות בשיחה הבאה (גם אם WS לא עובד):**

* אחרי הברכה, תוך ≤6 שנ׳: ב-Request Inspector יופיע `POST /webhook/handle_recording` (ולא רק `stream_ended`).
* בלוגים אצלך: `WATCHDOG_REDIRECT_OK`.

> אם אין `/webhook/handle_recording`: למרות שאמרת שיש secrets, לרוב זה כי **`TWILIO_ACCOUNT_SID/TOKEN` לא מוגדרים ב-Deployment** (מוגדרים רק ב-Workspace). הגדר אותם **בדיפלוי**, חזור על הבדיקה. רק אחרי שעובד, החזר את הטיימרים ל-`6,6`.

---

# שלב 4 — ודא שה-WS אכן נפתח ומעבד (לוגים שחייבים להופיע)

ב-`media_ws.py` כבר יש לוגים. בזמן שיחה תקינה תראה ברצף:

* `WS_CONNECTED`
* `WS_START` עם `streamSid` ו-`call_sid`
* `HEBREW_SPEECH` עם טקסט ביניים/סופי
* `PING_PONG_TX` (אחרי `generate_hebrew_response` וה-`calls.update`)

**אם אתה לא רואה `WS_START`:**

* עדיין אין Handshake 101 → חזור לשלב 1 (eventlet/נתיבי WS/הסרת אבטחה מה-WS).

**אם יש `WS_START` אבל אין `HEBREW_SPEECH`:**

* האודיו לא זורם ל-STT: ודא

  * `GOOGLE_APPLICATION_CREDENTIALS` (או JSON) מוגדר בדיפלוי.
  * sample rate 8000Hz; המרת μ-law→PCM16 מתבצעת (`audioop.ulaw2lin`).
  * אין חריגות ב-`read_results_nonblock()`.

---

# שלב 5 — ודא שה-TTS וה-Play עובדים (פינג־פונג)

כבר בקוד: אחרי תמלול **final**:

1. NLP → טקסט תשובה קצר.
2. `generate_hebrew_response()` יוצר MP3 ציבורי.
3. `client.calls(call_sid).update(twiml=f"<Response><Play>{url}</Play><Connect>...<Stream.../></Connect></Response>")`
   (מחזיר את הזרם להמשך שיחה).

**מה מצופה לראות:**

* ב-logs: `PING_PONG_TX` עם ה-call\_sid.
* ב-Inspector: ניגון ה-Play, ואז עוד `<Connect><Stream>` (עוד פעם).

**אם אין ניגון תשובה:**

* בדוק 11100 על ה-Play (URL לא ציבורי/לא קיים); תקן `PUBLIC_BASE_URL` וודא 200 על הקובץ המיוצר.
* ודא שהקוד באמת מחזיר `<Play>...<Connect><Stream...>` ולא רק `<Play>`.

---

# שלב 6 — בריאות ה-Webhook לשיחות (ליישב 15003/404)

כבר אצלך:

* `/webhook/call_status` → מחזיר 204.
* חתימת Twilio (`@require_twilio_signature`) מופעלת רק על נתיבי `/webhook/*` — **לא** על ה-WS.

**מה מצופה לראות:**

* `POST /webhook/call_status` = 204 (אין 404/15003).

---

# שלב 7 — בדיקות מהירות (סגירת מעגל)

1. TwiML: יש `<Connect><Stream>` → OK.
2. MP3: שניהם 200 → OK.
3. WS: חיבור 101 (websocketking) → OK.
4. שיחה: `WS_START` → `HEBREW_SPEECH` → `PING_PONG_TX`.
5. אם WS לא קם: תוך ≤6ש׳ `POST /webhook/handle_recording` → OK.

---

## בונוס: שני תיקוני נוחות קטנים

* ב־`abs_url()` הוסף `base = base.rstrip('/')` כדי למנוע `//static/...` כפול.
* אחרי שתראה שה-watchdog עובד, החזר את הזמנים ל-`6,6` כדי שלא יפריע ל-WS כשכן עובד.

---

### למה זה יעבוד עכשיו?

* אם הגריטינג מתנגן, ה-TwiML כבר נכון.
* השקט אומר: Handshake WS לא נפתח **או** נפתח בלי עיבוד → שני אלה מטופלים ע”י **Eventlet** + בדיקת STT/ENV.
* גם אם WS תקוע, ה-watchdog יקח פיקוד ויפעיל `<Record>` → לא תישאר עוד “ברכה ואז שקט”.

תריץ שיחה אחת אחרי שלב 3 (עם 3/3), ותדביק לי את 3–6 שורות הלוג סביב `WS_START`/`WATCHDOG_REDIRECT*` אם עדיין אין תמלול/תשובה — אני אתן תיקון נקודתי לפי מה שיופיע.
