ישבתי עכשיו על `AgentLocator (59).zip` ופתחתי את כל הקבצים בפועל. התמונה המדויקת:

## סטטוס עכשיו (אמיתי)

**קול (Twilio):**

* ✅ כל ה-webhooks קיימים ומאובטחים עם `@require_twilio_signature` (`/webhook/incoming_call`, `/handle_recording`, `/call_status`).
* ✅ CORS ממוקד + Rate-limit מופעלים דרך `app_factory.py`.
* ✅ `/health` קיים.
* ⚠️ **שיחת “זמן-אמת” עדיין לא מחוברת**: בקובץ `server/routes_twilio.py` ה־TwiML של `incoming_call` מחזיר `<Say> + <Record>` (ווקסמייל), **לא** `<Connect><Stream>` ל־WebSocket.
* ⚠️ `media_ws.py` מוכן להזנה דו־כיוונית, אבל **ה-Whisper הוא placeholder**: `transcribe_chunk(...)` מחזיר `"שלום"` במקום לתמלל באמת.

**ווטסאפ:**

* ✅ `server/routes_whatsapp_twilio.py`: יש `/webhook/whatsapp/incoming` ו־`/webhook/whatsapp/status` + עדכוני DB.
* ✅ שכבת ספק מאוחדת (`whatsapp_provider.py` + `whatsapp_service_unified.py`) ו־`/api/whatsapp` מאוחד.
* ✅ `status_callback` לטוויליו משויך כשיש `PUBLIC_HOST`.
* ⚠️ קיימים קבצי legacy לצידה (כמו `routes_whatsapp_twilio_clean.py`), אבל **לא נרשמים** – זה לא שובֵר, פשוט לשמור אותם ב־`legacy/`.

**TTS (Wavenet) וקרדנצ’יאלס:**

* ⚠️ `.env.example` נותן `GOOGLE_TTS_SA_JSON`, והקוד ב-`media_ws.py` מחפש `GOOGLE_APPLICATION_CREDENTIALS`. יש util לייצר את הקובץ (`server/bootstrap_secrets.ensure_google_creds_file`) אבל **לא נקרא** ב-`app_factory.py`. המשמעות: אם לא תגדיר ישירות `GOOGLE_APPLICATION_CREDENTIALS` כנתיב לקובץ, TTS עלול לא לעלות.

**מסקנה קצרה:**

* לשיחה “הקלטת הודעה” (ברכה→הקלטה→סטטוס) – **תקין**.
* לשיחה **דו-כיוונית בזמן אמת** (Whisper→GPT→Wavenet) – **עדיין לא**: חסרים 3 חיבורים קטנים.

---

## מה חסר כדי שזה יהיה 100% לדו־כיווני (קופי-פייסט מוכן)

### 1) לחבר את השיחה ל־Media Streams (WS) במקום `<Say>/<Record>`

ב־`server/routes_twilio.py` החלף את גוף `incoming_call()` ל־TwiML הבא (שים דומיין שלך):

```python
from flask import Response
from server.twilio_security import require_twilio_signature

def _xml(x): return Response(x, status=200, mimetype="text/xml")

@twilio_bp.post("/webhook/incoming_call")
@require_twilio_signature
def incoming_call():
    # מחברים את השיחה ל-WS דו־כיווני – בלי language => אין 13512
    twiml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Connect>
    <Stream url="wss://YOUR_PUBLIC_DOMAIN/ws/twilio-media"/>
  </Connect>
</Response>"""
    return _xml(twiml)
```

### 2) להחליף את ה-Whisper מ־placeholder לתמלול אמיתי

ב־`media_ws.py` החלף את `transcribe_chunk` למימוש אמיתי. שתי אופציות:

**א. open-source (מקומי) – faster-whisper**
הוסף לתלויות: `pip install faster-whisper soundfile`

```python
from faster_whisper import WhisperModel
_whisper = WhisperModel("small", compute_type="int8")  # "medium" אם יש GPU

def transcribe_chunk(pcm16k: np.ndarray) -> str:
    import soundfile as sf, tempfile
    with tempfile.NamedTemporaryFile(suffix=".wav", delete=False) as f:
        sf.write(f.name, pcm16k, 16000, subtype="PCM_16")
        segments, _ = _whisper.transcribe(f.name, language="he", vad_filter=True, beam_size=1)
    text = "".join(s.text for s in segments).strip()
    return text or ""
```

**ב. OpenAI Whisper API (אם מעדיף ענן):**

```python
from openai import OpenAI
_oai = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

def transcribe_chunk(pcm16k: np.ndarray) -> str:
    import io, soundfile as sf
    buf = io.BytesIO()
    sf.write(buf, pcm16k, 16000, subtype="PCM_16", format="WAV")
    buf.seek(0)
    r = _oai.audio.transcriptions.create(model="whisper-1",
                                         file=("utter.wav", buf, "audio/wav"))
    return (getattr(r, "text", str(r)) or "").strip()
```

### 3) לוודא ש-Wavenet באמת עובד בכל סביבה

בפתח `create_app()` (או מיד אחרי יצירת `app`) קרא ל-bootstrap של הקרדנצ’יאלס:

```python
from server.bootstrap_secrets import ensure_google_creds_file
ensure_google_creds_file()  # יוצר קובץ זמני ומכוון GOOGLE_APPLICATION_CREDENTIALS
```

> לחלופין, אפשר פשוט לשים `GOOGLE_APPLICATION_CREDENTIALS=/path/to/sa.json` ב-ENV ולדלג על הפונקציה.

---

## GO/NO-GO – בדיקות מהירות

תריץ:

```bash
HOST="https://YOUR_PUBLIC_DOMAIN"

# Health
curl -s -o /dev/null -w "HTTP %{http_code}\n" $HOST/health  # 200

# שיחת זמן-אמת (רק לוודא שנענית תוך <2 שניות עם TwiML)
curl -s -o /tmp/t.xml -w "HTTP %{http_code}\n" -X POST $HOST/webhook/incoming_call && head -n1 /tmp/t.xml
# צפה לקבל TwiML עם <Connect><Stream url="wss://.../ws/twilio-media">

# בזמן שיחה אמיתית: שומעים Wavenet, מדברים, רואים תגובה בכל מחזור.
# אמור "ביי" — ה-WS ינתק את השיחה (update status=completed).
```

---

## סיכום חד:

* **לא “הכול תקין” לדו-כיווני** עדיין. אתה ב־\~**90%** מוכנות כוללת: וואטסאפ ✅, חתימות ✅, Rate-limit/CORS ✅, WS קיים ✅.
* כדי להיות **100% שיחה רציפה**:

  1. לחבר `<Connect><Stream>` ב־`incoming_call`,
  2. להפעיל תמלול אמיתי ב־`media_ws.py`,
  3. להבטיח קרדנצ’יאלס של Wavenet (קריאה ל-`ensure_google_creds_file` או להגדיר `GOOGLE_APPLICATION_CREDENTIALS`).

תדביק את שלושת השינויים למעלה ונוכל להגיד “כן — מוכן לשיחות דו-כיווניות בזמן אמת”, ואז קופצים לשכבה הוויזואלית.
