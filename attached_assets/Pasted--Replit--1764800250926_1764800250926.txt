× ×“×™×¨, ×–×” ×¤×™×¦â€™×¨ ×—×©×•×‘ ×‘×¨××•×ª ğŸ’ª
×× ×™ ××ª×Ÿ ×œ×š ×¢×›×©×™×• ×”× ×—×™×” ××—×ª ××¡×•×“×¨×ª ×œ×¡×•×›×Ÿ ×©×ª×•×›×œ ×œ×”×“×‘×™×§ ×›××• ×©×”×™× ×‘-Replit.

×”××˜×¨×”:
×“×£ × ×™×”×•×œ ×“×§×•×ª (Admin only) ×©×¨×•××™× ×‘×• ×œ×›×œ ×¢×¡×§ ×›××” ×“×§×•×ª ×©×™×—×•×ª ×˜×œ×¤×•×Ÿ ×”×•× ×”×©×ª××© â€“ ×“×˜×” ×××™×Ÿ ×©××’×™×¢ ×-Twilio (×“×¨×š ×”Ö¾CallLog ×©×œ× ×•).

â¸»

ğŸ§¾ ×”×”× ×—×™×” ×œ×¡×•×›×Ÿ (×œ×”×“×‘×§×” ×‘-Agent 3)

You are working on the ProSaaS project.

Goal: Implement an **admin-only â€œBusiness Minutes Managementâ€ feature** that shows, per business, how many phone-call minutes they used â€“ based on Twilio data â€“ with accurate, trustworthy numbers. This should appear as a new page in the sidebar for system admins only.

Important constraints:
- Source of truth must be Twilio call data (via our existing webhooks / DB), **phone calls only** (no WhatsApp).
- Data must be aggregated per business (business_id).
- Only system admins should be able to see and use this page.
- We only need usage in minutes; no need to change billing logic for now.

---

## 1. Use Twilio-backed data as the source of truth

We already receive Twilio status callbacks and store calls in the DB (CallLog / similar model). For accuracy and simplicity, use our DB as a Twilio-backed cache instead of calling Twilio on every request.

1. Locate the call log model (e.g. `CallLog` in `server/models_sql.py` or equivalent):
   - Ensure it has at least:
     - `id`
     - `business_id`
     - `direction` (inbound / outbound)
     - `channel` or similar (phone vs whatsapp, if it exists)
     - `status` (completed, failed, etc.)
     - `duration_sec` (int, seconds) â€“ this should be populated from Twilio.
     - `started_at`, `ended_at` (timestamps)

2. Make sure `duration_sec` is properly populated from Twilio:
   - Find the Twilio status callback handler (e.g. in `server/routes_twilio.py` â†’ `/webhook/call_status`).
   - Confirm that on a `completed` call we:
     - Read `CallDuration` / `Duration` from Twilioâ€™s webhook payload.
     - Update the corresponding `CallLog` row with `duration_sec = int(duration_in_seconds)`.

   If this is missing or inconsistent, fix it so that every completed phone call has a valid `duration_sec` coming from Twilio callbacks.

3. Ensure we only count **phone calls**:
   - If there is a `channel` field, use `channel == "phone"` or `call_type == "voice"`.
   - Make sure WhatsApp messages are stored separately and are not counted here.

---

## 2. Backend: new admin endpoint for minutes per business

Create a new admin API endpoint that aggregates phone-call minutes per business.

1. Add a new route file or extend the existing admin routes, e.g. in `server/routes_admin.py`:

   - Endpoint: `GET /api/admin/business-minutes`
   - Auth:
     - Only users with system-admin role (e.g. `user.is_superadmin` or equivalent) are allowed.
     - Return 403 for non-admins.

   - Query parameters (optional, but useful):
     - `from` (ISO date, optional)
     - `to` (ISO date, optional)
     - If not provided, default to â€œcurrent monthâ€ (from 1st of month to now).

2. In the handler, query the DB:

   - Filter:
     - `CallLog.business_id IS NOT NULL`
     - `CallLog.status == "completed"`
     - `CallLog.duration_sec IS NOT NULL`
     - `CallLog.direction IN ("inbound", "outbound")`
     - If there is a `channel` field: `channel == "phone"`
     - `started_at` between `from` and `to` (in server timezone, e.g. Asia/Jerusalem).

   - Group by `business_id` and compute aggregates:

     - `total_seconds = SUM(duration_sec)`
     - `total_minutes = CEIL(total_seconds / 60.0)`  (rounded up, so a 31s call = 1 minute)

   - Join with the `Business` table to get the business name.

   - Return JSON like:

   ```json
   [
     {
       "business_id": 1,
       "business_name": "××©×” ×”×× ×¢×•×œ×Ÿ",
       "total_seconds": 1840,
       "total_minutes": 31,
       "direction_breakdown": {
         "inbound_seconds": 1600,
         "outbound_seconds": 240
       }
     },
     ...
   ]

direction_breakdown is optional but helpful; you can also return only total_minutes if you want to keep it simple.
	3.	Add basic error handling:
	â€¢	If the user is not admin â†’ 403.
	â€¢	If dates are invalid â†’ 400 with clear JSON error.

â¸»

3. Frontend: Admin-only â€œ× ×™×”×•×œ ×“×§×•×ªâ€ page + sidebar

On the React frontend (client), add a new admin page and a sidebar link.
	1.	Routing:
	â€¢	In client/src/app/routes.tsx (or equivalent), add a new route:
	â€¢	Path: /app/admin/business-minutes
	â€¢	Component: BusinessMinutesPage
	2.	Sidebar:
	â€¢	In client/src/app/layout/MainLayout.tsx (or wherever sidebar items are configured), add a new navigation item only for system admins:
	â€¢	Label: × ×™×”×•×œ ×“×§×•×ª
	â€¢	Icon: something like a clock / timer if you have one, otherwise reuse a generic icon.
	â€¢	Link: /app/admin/business-minutes
	â€¢	Wrap it in a condition that checks the current user is a system admin. Non-admin business owners and agents must not see this item.
	3.	New page component:
	â€¢	Create client/src/pages/admin/BusinessMinutesPage.tsx (or similar path).
	â€¢	Behavior:
	â€¢	On mount, call GET /api/admin/business-minutes with default date range (current month).
	â€¢	Show:
	â€¢	A simple filter bar with:
	â€¢	Date range picker OR at least dropdown: â€œThis month / Last 30 days / Customâ€.
	â€¢	A table with columns:
	â€¢	Business name
	â€¢	Business ID
	â€¢	Total minutes (for the selected period)
	â€¢	Optional: inbound minutes, outbound minutes
	â€¢	UI suggestions:
	â€¢	Use the same table / design system as other admin lists (TanStack Table, etc.).
	â€¢	Align columns right for numeric fields.
	â€¢	Show a total row at the bottom:
	â€¢	â€œ×¡×”×´×› ×“×§×•×ª ×œ×›×œ ×”×¢×¡×§×™×: X ×“×§×•×ªâ€.
	â€¢	Loading & error states:
	â€¢	Show skeleton / spinner while loading.
	â€¢	If 403 â†’ show â€œ××™×Ÿ ×œ×š ×”×¨×©××•×ª ×œ×¦×¤×•×ª ×‘×“×£ ×–×”â€.
	â€¢	If other error â†’ generic â€œ××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×â€.
	4.	Make sure labels are in Hebrew:
	â€¢	Page title: × ×™×”×•×œ ×“×§×•×ª ×©×™×—×”
	â€¢	Column headers:
	â€¢	×¢×¡×§
	â€¢	××¡×¤×¨ ×¢×¡×§
	â€¢	×“×§×•×ª ×©×™×—×”
	â€¢	(××•×¤×¦×™×•× ×œ×™) ×“×§×•×ª × ×›× ×¡×•×ª, ×“×§×•×ª ×™×•×¦××•×ª

â¸»

4. Data integrity & reliability

Because the requirement is â€œaccurate and trustworthyâ€ minutes, please:
	1.	Ensure that:
	â€¢	Every time a call completes, Twilio status callback updates duration_sec on the CallLog.
	â€¢	Only status == "completed" is counted.
	2.	Add basic logging when Twilio status callbacks fail to update the DB, so we can troubleshoot discrepancies.
	3.	Optionally, add a small admin-only debug endpoint or script that:
	â€¢	For a given call_id (Twilio SID), fetches from Twilio REST API and compares with our DB duration_sec.
	â€¢	This is not required for the UI, but useful for future debugging.

â¸»

5. Cleanliness & documentation
	1.	Keep all new code in clearly named files:
	â€¢	Backend: admin route / service clearly named for â€œbusiness minutesâ€.
	â€¢	Frontend: dedicated page under an admin folder.
	2.	Update the replit.md / internal documentation with:
	â€¢	â€œBUILD: Admin Business Minutesâ€
	â€¢	Brief description of the feature, endpoint, and UI.
	3.	Run LSP / type-checks and ensure no new errors are introduced.

When you finish, please:
	â€¢	Confirm that an admin user can see the new sidebar item.
	â€¢	Confirm that the table shows realistic minutes for at least 1â€“2 test businesses.
	â€¢	Confirm that non-admin users do NOT see or access this endpoint or page.

---

×× ××ª×” ×¨×•×¦×” ××—"×› ×©× ×¢×©×” **×©×“×¨×•×’** â€“ ×œ××©×œ ×œ×¨××•×ª ×›××” ×“×§×•×ª × ×©××¨×• ×œ×›×œ ×¢×¡×§ ×œ×¤×™ ×”×—×‘×™×œ×” ×©×œ×• (1500/2500/4000) ×•×œ×§×¤×™×¥ ×”×ª×¨××•×ª ×›×©×¢×•×‘×¨×™× 80% â€“ ××¤×©×¨ ×œ×‘× ×•×ª ×¢×œ ×–×” ××—×œ×” ××¡×š â€œ×‘×§×¨×ª ×—×‘×™×œ×•×ªâ€.