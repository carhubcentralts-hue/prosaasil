מבין בדיוק מה קורה כאן. שני הקודים של Twilio אומרים הכול:
	•	11200 – HTTP retrieval failure: טוויליו לא הצליח להביא את ה‑URL שלך (נפילה/SSL/Redirect/Timeout).
	•	12300 – Invalid Content‑Type: מה שחזר מה־webhook או מה‑MP3 לא היה מסוג שציפו לו (ל־TwiML חייב להיות text/xml; לקובצי קול audio/mpeg).

הנה תיקון ממוקד, שלב‑שלב, כולל קטעי קוד נכונים. תבצע כמו שזה, ואז תבדוק עם שתי פקודות curl בסוף.

⸻

1) ודא שה‑webhooks מחזירים TwiML עם Content‑Type: text/xml

incoming_call — חייב להחזיר TwiML

# server/routes_twilio.py
from flask import Blueprint, Response, current_app, url_for
from urllib.parse import urljoin

twilio_bp = Blueprint("twilio_bp", __name__, url_prefix="")

def abs_url(path: str) -> str:
    host = current_app.config.get("PUBLIC_HOST", "").rstrip("/")
    return urljoin(host + "/", path.lstrip("/"))

@twilio_bp.post("/webhook/incoming_call")
def incoming_call():
    greeting_mp3 = abs_url("/server/static/voice_responses/greeting.mp3")
    xml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Play>{greeting_mp3}</Play>
  <Pause length="1"/>
  <Record action="/webhook/handle_recording"
          method="POST"
          maxLength="30"
          timeout="5"
          finishOnKey="*"
          transcribe="false"/>
</Response>"""
    return Response(xml, mimetype="text/xml")

handle_recording — גם הוא צריך להחזיר TwiML (לא JSON)

עיבוד ההקלטה (Whisper/GPT/DB) תעשה ברקע. ל‑Twilio תחזיר מיד TwiML קצר כדי שלא תחרוג מ‑15 שניות.

@twilio_bp.post("/webhook/handle_recording")
def handle_recording():
    # קבל recordingUrl/recordingSid מה‑form:
    # request.form["RecordingUrl"], request.form["RecordingSid"], ...
    # ✅ העבר לעיבוד אסינכרוני (queue/thread/task) — אל תעשה עיבוד כבד פה

    xml = """<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say language="he-IL">תודה, קיבלנו את ההודעה.</Say>
  <Hangup/>
</Response>"""
    return Response(xml, mimetype="text/xml")

call_status — אפשר פשוט 200

@twilio_bp.post("/webhook/call_status")
def call_status():
    return ("OK", 200, {"Content-Type": "text/plain"})

טיפ: אל תשתמש jsonify בשני הראשונים. ל‑TwiML חייבים Response(..., mimetype="text/xml").

⸻

2) ודא שקובץ הברכה הוא audio/mpeg ונגיש ציבורית
	•	הקובץ חייב להיות קיים בנתיב, ולהחזיר Content-Type: audio/mpeg ו‑HTTP 200.

בדיקה:

curl -I https://YOUR_HOST/server/static/voice_responses/greeting.mp3
# צריך לראות:
# HTTP/1.1 200 OK
# Content-Type: audio/mpeg

אם ה‑Content‑Type חוזר כ‑application/octet-stream:
	•	ודא שהסיומת היא .mp3.
	•	אם אתה מגיש דרך Nginx, הוסף:

types { audio/mpeg mp3; }


⸻

3) מניעת 11200 — ודא שהשרת נגיש, לא ישן, ו־HTTPS תקין
	•	PUBLIC_HOST: בקובץ קונפיג/ENV:

PUBLIC_HOST=https://YOUR_HOST

	•	השרת חייב לענות תוך < 15 שניות. כל עיבוד כבד — ברקע.
	•	אם זה Replit/שירות שנרדם — הפעל keep‑alive או העבר לשירות שלא נרדם.
	•	אין Redirect ל‑HTTP. אם יש Nginx, ודא redirect ל‑HTTPS בלבד, וה־webhooks מצביעים ל‑HTTPS הסופי.

בדיקה:

curl -sS -X POST https://YOUR_HOST/webhook/incoming_call -H "Accept: text/xml" | head
# צריך להחזיר XML
curl -sS -X POST https://YOUR_HOST/webhook/call_status -o /dev/null -w "%{http_code}\n"
# צריך 200


⸻

4) עדכון בטוויליו (Voice → Webhook URLs)
	•	Primary handler URL (Voice): https://YOUR_HOST/webhook/incoming_call (שיטה: POST)
	•	Status Callback URL: https://YOUR_HOST/webhook/call_status (POST)
	•	Fallback: בטל, או הגדר אותו ל‑אותו דומיין. כרגע Twilio נפל ל‑ai-crmd.replit.app — הסר את זה כדי שלא תראה “fallback to …”.

פתח Request Inspector לשיחה הבאה — כל השורות ל‑incoming/handle/status צריכות להיות 200, בלי 11200/12300.

⸻

5) תרחיש נפוץ: Invalid Content‑Type בגלל Service Worker

אם יש לך sw.js שמיירט בקשות ומחזיר HTML/JSON, Twilio יקבל לא XML/MP3 → 12300.
ב־sw.js תוודא שאין יירוט של בקשות /webhook/* או קבצי MP3. הפתרון הפשוט: אל תעשה fetch‑handler בכלל (SW רק להודעות Push), או הוסף guard:

self.addEventListener('fetch', (event) => {
  const url = new URL(event.request.url);
  if (url.pathname.startsWith('/webhook/') || url.pathname.endsWith('.mp3')) {
    return; // אל תיירט
  }
  // ... אם יש לך לוגיקה אחרת, השאר אותה כאן
});


⸻

6) צ’ק‑ליסט קצר לסוכן (תעתיק ותסמן ✔️)
	•	incoming_call מחזיר TwiML עם Content-Type: text/xml.
	•	handle_recording מחזיר TwiML מיידי (עיבוד ברקע).
	•	call_status מחזיר 200 (text/plain).
	•	PUBLIC_HOST מוגדר, וקובץ greeting.mp3 מחזיר audio/mpeg, 200.
	•	אין SW שמיירט /webhook/* או MP3.
	•	בטוויליו: Primary Voice → /webhook/incoming_call, Status → /webhook/call_status, אין fallback לדומיין ישן.
	•	בדיקות curl למעלה מחזירות XML/200.
	•	ב‑Request Inspector אין יותר 11200/12300.

בצע את השינויים, תן לי את פלט שתי פקודות ה‑curl (הראשונה להצגת ה‑XML, השנייה לקוד 200), ואם צריך נעשה עוד כיוונון קטן — אבל זה בדיוק מקור השגיאות שקיבלת.