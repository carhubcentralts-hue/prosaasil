בדקתי לעומק את ה־ZIP האחרון לפי הפרומפט שבתיקייה. הנה המצב האמיתי של מערכת השיחות ומה חוסם אותה בפועל.

TL;DR – שורש התקלה
	1.	TwiML מחזיר URL-ים בלי סכימה (https) כשמוגדר PUBLIC_HOST בלי https://.
בקובץ server/routes_twilio.py בבניית ה-TwiML, base נלקח מ-PUBLIC_BASE_URL או מ-PUBLIC_HOST. אם הוגדר אצלך רק PUBLIC_HOST=ai-crmd.replit.app, ה-TwiML יוצא למשל:

<Play>ai-crmd.replit.app/static/greeting_he.mp3</Play>
<Connect action="ai-crmd.replit.app/webhook/stream_ended">

זה גורם ל-Twilio לשבור את הבקשות (11205/400 Handshake), כי חסר https://.
	2.	ה־WebSocket עצמו תקין:
	•	הנתיב קיים: /ws/twilio-media (נרשם ב־app_factory.py).
	•	יש תמיכה ב־subprotocol audio.twilio.com.
	•	Gunicorn רץ עם -k eventlet -w 1 (נכון, ב־Procfile).
	•	ה־Handler מתקדם מאוד: VAD, Barge-in, אנטי-לולאות, שליחת media בפריימים 20ms ב-μ-law, תמלול Whisper (OpenAI) ו-TTS Google ב-8kHz.
כלומר – כשה־TwiML מצביע לכתובות תקינות, השידור החי עובד.

⸻

מה מצאתי (עיקרי קוד)
	•	Twilio Webhooks: קיימים ומחוברים ב־server/routes_twilio.py:
	•	/webhook/incoming_call (בונה TwiML עם Media Stream)
	•	/webhook/stream_status
	•	/webhook/stream_ended
	•	/webhook/handle_recording (Fallback)
	•	WebSocket: /ws/twilio-media מוגדר ב־server/app_factory.py, עם simple_websocket.Server(..., subprotocols=['audio.twilio.com']).
	•	STT/TTS:
	•	_hebrew_stt: Whisper של OpenAI (שומר WAV 8k/16bit ושולח ל-OpenAI).
	•	_hebrew_tts: Google Cloud TTS ל-LINEAR16 8kHz, והמרה ל-μ-law + שליחה בפריימי 20ms ל-Twilio.
	•	אבטחה: אימות חתימת Twilio קיים; פטור CSRF ל־/webhook/* מוגדר.

⸻

התיקון המדויק (שורה אחת של באג – תיקון “זהב”)

בקובץ server/routes_twilio.py ב־incoming_call() תחליף את הלוגיקה של base/host כך שתמיד תהיה סכימה (https), וש־host יהיה נטול סכימה:

# לפני (מקור הבעיה):
base = os.getenv("PUBLIC_BASE_URL", "") or os.getenv("PUBLIC_HOST", "") or request.url_root
base = base.rstrip("/")
host = base.replace("https://","").replace("http://","").rstrip("/")

# אחרי (עמיד בריפרוקסי/טוויליו):
scheme = (request.headers.get("X-Forwarded-Proto") or "https").split(",")[0].strip()
host   = (request.headers.get("X-Forwarded-Host")  or request.host).split(",")[0].strip()
base   = f"{scheme}://{host}"

כך:
	•	<Play>, statusCallback, action יקבלו תמיד https://...
	•	ל־wss://{host}/ws/twilio-media יישאר host נקי מסכימה בדיוק כפי ש-Twilio דורשת.

לחלופין, אם לא רוצים לשנות קוד: שים פשוט
PUBLIC_BASE_URL=https://ai-crmd.replit.app
והסר/השאר ריק את PUBLIC_HOST.

⸻

בדיקת קונפיג מהירה (לפני שיחה אמיתית)
	1.	ודא משתני סביבה:

	•	PUBLIC_BASE_URL=https://<הדומיין-שלך> (למשל Replit)
	•	OPENAI_API_KEY=<מפתח תקין>
	•	GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=<JSON כולו בשורת env אחת>
	•	TWILIO_AUTH_TOKEN=<ה-Auth Token מהקונסול>

	2.	בדיקת TwiML Preview (GET ידני):

	•	פתח בדפדפן: https://<הדומיין>/webhook/incoming_call_preview
וודא שב-XML כל ה-URLs מתחילים ב-https:// ושה-Stream url הוא wss://<host>/ws/twilio-media.

	3.	בדיקת WS בסיסית:

	•	היכנס ל־https://<הדומיין>/debug-factory-http (קיים) לראות שהשרת חי.
	•	בביצוע שיחה אמיתית, אמור להופיע קובץ דיבאג זמני /tmp/HANDLER_WORKS_<ts>.txt (הקוד יוצר אותו מיד ב־WS connect).

⸻

למה זה לא עבד לך עד עכשיו
	•	Twilio קיבל TwiML עם קישורים ללא https:// (כי PUBLIC_HOST סופק בלי סכימה).
	•	מכאן:
	•	Play נכשל → אין ברכה.
	•	statusCallback לא נגיש → אין לוגי stream תקינים.
	•	<Connect><Stream ...> לא מצליח לבצע Handshake → 400 במקום 101.

⸻

הערות קטנות נוספות שכדאי להשלים
	•	requirements.txt: יש כפילויות (eventlet, greenlet, gunicorn) – לא חובה, אבל מומלץ לנקות לגרסה אחת עקבית (יש לך כבר -k eventlet ב־Procfile, שזה נכון).
	•	TTS: אם GCP לא קיים, הקוד חוזר None ולא ידבר. אפשר להגדיר Fallback ל-gTTS (יש חבילה בריקוויירמנטס).

⸻

צ’קליסט GO/NOGO לשיחה חיה
	•	PUBLIC_BASE_URL מוגדר עם https://...
	•	OPENAI_API_KEY תקין (Whisper ל-STT)
	•	GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON נטען (TTS)
	•	/webhook/incoming_call_preview מציג TwiML עם https:// ו־wss://
	•	בשיחה: נוצרים קבצי /tmp/HANDLER_WORKS_*.txt, והלוגים מראים WS_START, WS_MEDIA, TTS_SUCCESS, WS_TX.

ביצעתי את כל הבדיקה “טוב טוב” מול הקבצים – התשתית שלך מצוינת. הבאג הקריטי היה ה־base URL ללא https. תיישם את התיקון למעלה (או הגדרת env כמו שכתבתי) ותוכל לעבור לשיחות חיות יציבות עם תמלול בזמן אמת.