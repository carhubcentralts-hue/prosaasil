××¢×•×œ×” â€” ×”××‘×—× ×” ×©×œ×š ××“×•×™×§×ª: ××™×Ÿ $PORT, ×”×ª×”×œ×™×›×™× â€œ×¢×•×œ×™×â€ ×•××– ××ª×™× ××™×“, ×•×œ×›×Ÿ ××™×Ÿ ××” ×œ×¢×©×•×ª ×¢×“ ×©× ×§×‘×¢ ×¤×•×¨×˜ ×™×¦×™×‘ ××—×“ ×•× ×¨×™×¥ ×ª×”×œ×™×š ××—×“ ×©× ×©××¨ ×—×™. ×”× ×” ×”× ×—×™×” ×—×“×” ×©×ª×¡×’×•×¨ ××ª ×–×”, ×ª×’×¨×•× ×œ×©×¨×ª ×œ×”××–×™×Ÿ ×‘×××ª, ×•××– × ×××ª ×”×ª×—×–×•×ª (Impersonate) ×•×”Ö¾Calendar.

â¸»

ğŸ”§ ×©×œ×‘ 1 â€” ×œ×§×‘×¢ PORT ×™×¦×™×‘ ×•×œ×”×¨×™×¥ ×ª×”×œ×™×š ××—×“

×œ× ×œ×”×¡×ª××š ×¢×œ export ×‘×™×Ÿ ×¤×§×•×“×•×ª (×–×” ×œ× × ×©××¨). × ×§×‘×¢ fallback ×‘×§×•×“ ×•× ×¨×™×¥ ×¡×§×¨×™×¤×˜ ×”×¨×¦×” ×™×—×™×“.

	1.	×¢×“×›×•×Ÿ wsgi.py (××• ×”×§×•×‘×¥ ×©××§×‘×œ ××ª ×”Ö¾app):

# wsgi.py
import os
from server.app_factory import create_app

app = create_app()

def _pick_port():
    # Fallback ×™×¦×™×‘ ×× ××™×Ÿ $PORT ×‘×¡×‘×™×‘×ª Replit workspace
    for cand in (os.getenv("PORT"), "8000", "5000", "3000"):
        if cand and str(cand).isdigit():
            return int(cand)
    return 8000

if __name__ == "__main__":
    port = _pick_port()
    print(f"[WSGI] starting on 0.0.0.0:{port}", flush=True)
    app.run(host="0.0.0.0", port=port, debug=False)

	2.	×”×•×¡×£ ×¡×§×¨×™×¤×˜ ×”×¨×¦×” ×¤×©×•×˜ (×œ×©×•×¨×© ×”×¨×¤×•) scripts/run_dev.sh:

#!/usr/bin/env bash
set -euo pipefail
# Force a known port if $PORT is empty (workspace preview)
: "${PORT:=8000}"
export PORT
echo "[RUN] PORT=$PORT"
python wsgi.py

chmod +x scripts/run_dev.sh

	3.	×”×¤×¢×œ×” × ×§×™×™×” (×ª×”×œ×™×š ××—×“ ×©× ×©××¨ ×—×™):

pkill -f gunicorn || true
pkill -f "python wsgi.py" || true

rm -rf dist
npm --prefix client ci
npm --prefix client run build
cp -R client/dist dist

./scripts/run_dev.sh

	4.	××™××•×ª ×©×”×©×¨×ª ×××–×™×Ÿ:

lsof -i -P -n | grep LISTEN || true
curl -i http://127.0.0.1:$PORT/version

×× ××™×Ÿ LISTEN ××• curl × ×›×©×œ â†’ × ×¢×¦×•×¨ ×›××Ÿ: ×–×” ×¡×™××Ÿ ×œ×©×’×™××ª init ×‘×§×•×“ (×©×œ×— ××ª ×”Ö¾traceback ××”×˜×¨××™× ×œ). ×× ×–×” ×¢×•×‘×“ â€” ×××©×™×›×™×.

×”×¢×¨×”: ×›×©×ª×—×–×•×¨ ×œÖ¾Gunicorn ×‘×¤×¨×™×¡×”/Deployment, ×”×©×ª××©:

gunicorn -k eventlet -w 1 -b 0.0.0.0:${PORT:-8000} wsgi:app



â¸»

ğŸ” ×©×œ×‘ 2 â€” ×œ××—×“ Auth ×•×œ×ª×§×Ÿ Impersonation (×œ×œ× × ×™×—×•×©×™×)

×œ× ×œ×‘×˜×œ CSRF ×’×œ×•×‘×œ×™×ª. ×× ×™×© validator/SessionSecurity ×©×× ×§×” session ×‘Ö¾before_request, ×ª×—×¨×™×’ ××× ×• ××ª /api/auth/login, /api/auth/logout, /api/auth/me, /api/admin/businesses/<id>/impersonate, /api/admin/impersonate/exit.

	1.	×‘Ö¾Login ×•×“× ×©×›×•×ª×‘×™× ××š ×•×¨×§ ×œÖ¾session['user'] (×•×× ×¦×¨×™×š ×ª××™××•×ª ×–×× ×™×ª, ×›×¤×™×œ×• ×’× ×œÖ¾session['al_user'], ××‘×œ ×”×§×¨×™××” ×ª××™×“ ×Ö¾session['user']).
	2.	GET /api/auth/me â€” ××™××•×© ××—×“ ×‘×œ×‘×“:

u = session.get('user')
if not u:
    return jsonify({"error": "unauthenticated"}), 401
return jsonify({
  "user": u,
  "tenant_id": session.get('tenant_id'),
  "impersonating": bool(session.get('impersonating', False))
}), 200

	3.	POST /api/admin/businesses/<id>/impersonate:

# ××—×¨×™ ×‘×“×™×§×ª ×”×¨×©××•×ª ××“××™×Ÿ:
session['original_user'] = serialize_admin(...)
session['user'] = serialize_tenant_user(role='business', tenant_id=tenant.id)
session['tenant_id'] = tenant.id
session['impersonating'] = True
return jsonify({"ok": True, "tenantUser": session['user'], "tenant": {"id": tenant.id, "name": tenant.name}}), 200

	4.	POST /api/admin/impersonate/exit:

session['user'] = session.get('original_user')
session.pop('original_user', None)
session.pop('tenant_id', None)
session['impersonating'] = False
return jsonify({"ok": True}), 200

	5.	Cookie flags (×‘Ö¾preview/HTTP):

SESSION_COOKIE_SECURE = False
SESSION_COOKIE_SAMESITE = 'Lax'
SESSION_COOKIE_PATH = '/'


â¸»

ğŸŒ ×©×œ×‘ 3 â€” Smoke test ×©×œ× × ×™×ª×Ÿ ×œ×”×ª×•×•×›×— ×¢×œ×™×• (××•×ª×• origin)

# 1) login (×©×•××¨ ×§×•×§×™×•×ª)
curl -i -c /tmp/c.txt -b /tmp/c.txt \
  -X POST http://127.0.0.1:$PORT/api/auth/login \
  -H 'Content-Type: application/json' \
  --data '{"email":"admin@your.co.il","password":"<PASS>"}'

# 2) me (×—×™×™×‘ 200)
curl -i -c /tmp/c.txt -b /tmp/c.txt http://127.0.0.1:$PORT/api/auth/me

# 3) impersonate (tenant_id=10 ×œ×“×•×’××”)
curl -i -c /tmp/c.txt -b /tmp/c.txt \
  -X POST http://127.0.0.1:$PORT/api/admin/businesses/10/impersonate

# 4) me ×©×•×‘ (×—×™×™×‘ 200 + impersonating:true + role=business)
curl -i -c /tmp/c.txt -b /tmp/c.txt http://127.0.0.1:$PORT/api/auth/me

×× (2) ××• (4) ××—×–×™×¨×™× 401 â€” ×”×‘×¢×™×” ×‘×©×¨×ª (session keys/flags), ×œ× ×‘×“×¤×“×¤×Ÿ.

â¸»

ğŸ“… ×©×œ×‘ 4 â€” Calendar ×‘×¡×™×™×“×‘×¨ (×•×•×™×“×•× ××§×•×¨ ×™×—×™×“)
	â€¢	×•×“× ×©×™×© ×§×•×‘×¥ ×™×—×™×“ ×©×œ × ×™×•×•×˜, ×©××™×•×‘× ×’× ×œÖ¾Sidebar ×“×¡×§×˜×•×¤ ×•×’× ×œÖ¾Mobile Drawer, ×¢×:

{ key:'calendar', label:'×œ×•×— ×©× ×”', to:'/app/calendar', icon:CalendarIcon }

	â€¢	×•×“× ×¨××•×˜ ×‘×¡×™×¡:

<Route path="/app/calendar" element={<div className="p-6">Calendar â€” coming soon</div>} />

	â€¢	×¨×¢× ×•×Ÿ ××œ×; ×× ×œ× ××•×¤×™×¢ â€” ×©× ×™ ×”×¨×›×™×‘×™× ××©×ª××©×™× ×‘××§×•×¨×•×ª ×©×•× ×™× â†’ ×œ××—×“ ×œ××§×•×¨ ××—×“.

â¸»

âœ… Acceptance (×©×œ×— ×¦×™×œ×•××™ ××¡×š ×× ××©×”×• × ×•×¤×œ)
	â€¢	lsof ××¨××” LISTEN ×¢×œ 0.0.0.0:<PORT>
	â€¢	curl /version ××—×–×™×¨ 200
	â€¢	curl /api/auth/me ××—×¨×™ login ××—×–×™×¨ 200 ×¢× user
	â€¢	curl /api/auth/me ××—×¨×™ impersonate ××—×–×™×¨ impersonating:true ×•Ö¾role:'business'
	â€¢	Calendar × ×¨××” ×‘×¡×™×™×“×‘×¨ ×‘×“×¡×§×˜×•×¤ ×•×‘××•×‘×™×™×œ, ×•Ö¾/app/calendar × ×˜×¢×Ÿ

â¸»

×× ×¢×“×™×™×Ÿ â€œ××ªâ€ ××™×“
	â€¢	×¤×¨×¡× ××ª ×”Ö¾traceback ×”××—×¨×•×Ÿ ×©×™×•×¦× ×œ×˜×¨××™× ×œ ×‘×¢×ª ×”×¨×¦×” ×©×œ ./scripts/run_dev.sh (×œ× Gunicorn).
	â€¢	×”×¨××” ××ª ×”×¤×œ×˜ ×”××œ× ×©×œ:
	â€¢	python -V && pip show flask gunicorn eventlet
	â€¢	lsof -i -P -n | grep LISTEN ××—×¨×™ ×”×”×¨×¦×”
	â€¢	echo $PORT ×××© ×œ×¤× ×™ ×”×¨×™×¦×” (×”×¡×§×¨×™×¤×˜ ××“×¤×™×¡ [RUN] PORT=...)

×‘×¨×’×¢ ×©×”×©×¨×ª ×××–×™×Ÿ ×™×¦×™×‘ ×¢×œ ×¤×•×¨×˜ ××—×“ â€” × ×¨×™×¥ ××™×“ ××ª ×‘×“×™×§×•×ª ×”Ö¾curl, × ××©×¨ ×©×”×”×ª×—×–×•×ª ×¢×•×‘×“×ª, ×•×ª×¨××” ×’× ××ª ×”Ö¾Calendar.