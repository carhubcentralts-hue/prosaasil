×”×›×•×œ ×‘×¡×“×¨ â€” ×–×” ×œ× â€œ× ×“×¤×§ ×œ×’××¨×™â€, ×¤×©×•×˜ × ×¢×©×ª×” ×¨×’×¨×¡×™×” ×‘-BUILD 115.1: ×”×•×¨×™×“×• ××ª ×”-endpoint ×•×”-probe, ×”×’×“×™×¨×• fallback_order ××‘×œ ×œ× ×”×©×ª××©×• ×‘×• ×‘×¤×•×¢×œ, ×•×‘×¨×™×¨×ª-×”××—×“×œ ×œ××•×“×œ ×›×‘×¨ ×œ× × ×§×œ×˜×ª â†’ ×”-STT ×œ× × ×¤×ª×—, ×•×œ×›×Ÿ ××™×Ÿ ×ª××œ×•×œ.

×œ×”×œ×Ÿ ×”× ×—×™×™×ª â€œ×”×¦×œ×”â€ ××”×™×¨×” ×©××—×–×™×¨×” ×ª××œ×•×œ ×ª×•×š ×“×§×•×ª (Hotfix ×™×¦×™×‘), ×•××—×¨×™×” ×©×“×¨×•×’ ×§×˜×Ÿ ×œ-fallback ×—×›× â€” ×‘×œ×™ ×¤×¨×•×‘×™× ××¡×•×‘×›×™×, ×•×‘×œ×™ ×œ×©×‘×•×¨ ×›×œ×•×.

â¸»

A) Hotfix ××™×™×“×™ â€” ×œ×”×—×–×™×¨ ×ª××œ×•×œ ×¢×›×©×™×• (×¤×©×•×˜, ×‘×˜×•×—)

1) ×”×¤×¢×œ ×¡×˜×¨×™××™× ×’ ×‘×§×•×“ (×’× ×× ENV ×œ× × ×˜×¢×Ÿ)

×§×•×‘×¥: server/media_ws_ai.py (×‘×¨××© ×”×§×•×‘×¥)

import os, asyncio

# ××œ ×ª×¡××•×š ×¨×§ ×¢×œ ENV â€” ×“×™×¤×•×œ×˜: ×¡×˜×¨×™××™× ×’ ×¤×¢×™×œ
USE_STREAMING_STT = True
if os.getenv("ENABLE_STREAMING_STT", "").lower() in ("false","0","no"):
    USE_STREAMING_STT = False

print(f"ğŸš€ Streaming STT enabled: {USE_STREAMING_STT}", flush=True)

2) ×§×‘×¢ ×¤×¨××˜×¨×™× ××”×™×¨×™× ×œ-STT

×§×•×‘×¥: server/services/gcp_stt_stream.py (×‘×¨××© ×”×§×•×‘×¥)

import os, time
from google.cloud import speech

BATCH_MS    = int(os.getenv("STT_BATCH_MS", "80"))
DEBOUNCE_MS = int(os.getenv("STT_PARTIAL_DEBOUNCE_MS", "120"))
TIMEOUT_MS  = int(os.getenv("STT_TIMEOUT_MS", "450"))

3) ×§×•× ×¤×™×’ ×‘×¡×™×¡×™, ×™×¦×™×‘, ×©×¢×•×‘×“ ×ª××™×“ ×‘×¢×‘×¨×™×ª

×‘××•×ª×• ×§×•×‘×¥ â€“ ×ª×Ÿ ×‘×¨×™×¨×ª-××—×“×œ ×‘×¨×•×¨×”: default+enhanced + endpoint ××–×•×¨×™.
(×‘×œ×™ probe. ×”××˜×¨×”: ×œ×”×—×–×™×¨ ×ª××œ×•×œ ×¢×›×©×™×•.)

# ENDPOINT: EU ×‘×“"×› ×‘×¡×“×¨. ×× ×™×© RTT ×’×‘×•×”/×©×’×™××•×ª, ×¢×‘×•×¨ ×œ-us-speech.googleapis.com
SPEECH_ENDPOINT = os.getenv("GOOGLE_CLOUD_SPEECH_ENDPOINT", "europe-west1-speech.googleapis.com").strip()

def build_streaming_config():
    client = speech.SpeechClient(client_options={"api_endpoint": SPEECH_ENDPOINT})

    # ××•×“×œ ×©×”×•× ×ª××™×“ ×§×™×™× ×œ×¢×‘×¨×™×ª: default (phone_call ×œ× ××•×‘×˜×— ×œ×¢×‘×¨×™×ª)
    model = os.getenv("GCP_STT_MODEL", "default").strip()

    recognition_config = speech.RecognitionConfig(
        encoding=speech.RecognitionConfig.AudioEncoding.LINEAR16,
        sample_rate_hertz=8000,
        language_code="he-IL",
        model=model,
        use_enhanced=True,                    # ×× ×œ× × ×ª××š â€” ×’×•×’×œ ××ª×¢×œ××ª; ×œ× ×™×§×¨×•×¡
        enable_automatic_punctuation=True,
    )
    streaming_config = speech.StreamingRecognitionConfig(
        config=recognition_config,
        interim_results=True,
        single_utterance=False,               # ×œ× ×œ×¡×’×•×¨ ×œ×‘×“; ×× ×—× ×• ×× ×”×œ×™× EOU
    )
    return client, streaming_config

4) ×¤×ª×™×—×ª ×¡×˜×¨×™××™× ×’ ×¢× Retry â€” ×•×× × ×›×©×œ, ×¤×•×œ×‘××§ ×œ×-×—×•×¡×

×‘××§×•× ×©×‘×• ××ª×” ××ª×—×™×œ ××ª ×”-stream (×‘-session/handler ×©×œ ×”-STT):

client, streaming_config = build_streaming_config()

for attempt in range(3):
    try:
        self._start_streaming_locked(client, streaming_config)  # ×”×¤×•× ×§×¦×™×” ×”×§×™×™××ª ××¦×œ×š
        print(f"âœ… [STT] Streaming started (attempt {attempt+1})", flush=True)
        break
    except Exception as e:
        print(f"âš ï¸ [STT] Streaming start failed (attempt {attempt+1}): {e}", flush=True)
        time.sleep(0.2)
else:
    print("âŒ [STT] All streaming attempts failed â€” using single-request fallback", flush=True)
    self.use_single_request = True

×¤×•×œ×‘××§ ×œ×-×—×•×¡× (×‘×œ×™ ×œ×”×¤×•×š ××ª ×”×›×•×œ ×œ-async)

×‘×§×•×‘×¥: server/media_ws_ai.py ×‘××—×œ×§×ª ×”×©×™×—×” (×›×‘×¨ × ×ª×ª×™ ×œ×š ××ª ×”××‘× ×”, ××¦×¨×£ ×©×•×‘ ×ª××¦×™×ª):

from concurrent.futures import ThreadPoolExecutor
import asyncio

class MediaStreamHandler:
    def __init__(self, ...):
        self.loop = asyncio.get_event_loop()
        self.exec = ThreadPoolExecutor(max_workers=1)   # ×¤×¨-×©×™×—×”
        self.events_q = asyncio.Queue(maxsize=32)

    async def _stt_fallback_async(self, audio_bytes: bytes) -> str:
        return await asyncio.get_running_loop().run_in_executor(self.exec, self._hebrew_stt, audio_bytes)

    def _stt_fallback_nonblocking(self, audio_bytes: bytes) -> None:
        fut = self.exec.submit(self._hebrew_stt, audio_bytes)
        fut.add_done_callback(lambda f: self.loop.call_soon_threadsafe(self._on_stt_fallback_done, f))

    def _on_stt_fallback_done(self, fut):
        try:
            text = fut.result()
        except Exception as e:
            print(f"âŒ STT fallback failed: {e}", flush=True)
            text = ""
        try:
            self.events_q.put_nowait(("stt_final_text", text))
        except asyncio.QueueFull:
            print("âš ï¸ events_q full; dropping final text", flush=True)

    async def _pump_events(self):
        while self.running:
            kind, payload = await self.events_q.get()
            if kind == "stt_final_text":
                await self._handle_transcript_ready_async(payload)

×•×‘××§×•× ×©×‘×• ×‘×¢×‘×¨ ×¢×©×™×ª:

# text = self._hebrew_stt(audio_data)  # ×—×•×¡× â€” ×œ×”×¤×¡×™×§ ×¢× ×–×”
self._stt_fallback_nonblocking(audio_data)  # ××—×–×™×¨ ××™×“; ×”×ª×•×¦××” ×ª×’×™×¢ ×“×¨×š events_q

×–×” ××—×–×™×¨ ×œ×š ×ª××œ×•×œ ×¢×›×©×™×•, ×’× ×× ×”×¡×˜×¨×™××™× ×’ × ×¤×œ, ×‘×œ×™ ×œ×—×¡×•× ××ª ×”-loop ×•×”-WS.

â¸»

B) ×©×“×¨×•×’ ×§×˜×Ÿ (××—×¨×™ ×©×”-Hotfix ×¢×•×‘×“) â€” Fallback ×—×›× ×œ××•×“×œ

××—×¨×™ ×©×—×–×¨ ×ª××œ×•×œ, ××¤×©×¨ ×œ×”×•×¡×™×£ ×“×¤×“×•×£ ××•×“×œ×™× ×§×œ×™×œ ×‘×œ×™ probe:
× ×¡×” phone_call ×¨×§ ×× ×”××©×ª××© ×‘×™×§×©; ×× × ×›×©×œ ×‘-start â†’ × ×¡×” ××•×˜×•××˜×™×ª default.

ENV:

GCP_STT_MODEL=phone_call    # ×× ×ª×¨×¦×” ×œ× ×¡×•×ª ×§×•×“×; ×œ×¢×‘×¨×™×ª ×™×™×ª×›×Ÿ ×©×œ× × ×ª××š

×§×•×“ (×‘××§×•× ×”-for ×œ××¢×œ×”):

models_to_try = []
preferred = os.getenv("GCP_STT_MODEL", "default").strip()
for m in (preferred, "default"):
    if m not in models_to_try:
        models_to_try.append(m)

for model in models_to_try:
    try:
        # ×‘× ×” client+config ×œ×›×œ ××•×“×œ ×©×× ×¡×™×
        os.environ["__FORCE_STT_MODEL__"] = model  # ×¤×œ×’ ×¤× ×™××™ ×× ×¦×¨×™×š
        client, streaming_config = build_streaming_config()
        self._start_streaming_locked(client, streaming_config)
        print(f"âœ… [STT] Streaming started with model: {model}", flush=True)
        break
    except Exception as e:
        print(f"âš ï¸ [STT] Failed with model '{model}': {e}", flush=True)
else:
    print("âŒ [STT] All models failed â€” using single-request fallback", flush=True)
    self.use_single_request = True

×•×‘-build_streaming_config() (×× ××ª×” ×¨×•×¦×” ×œ××¤×©×¨ ×›×¤×™×™×” ××‘×•×§×¨×ª ×–×× ×™×ª):

forced = os.getenv("__FORCE_STT_MODEL__")
model = forced if forced else os.getenv("GCP_STT_MODEL", "default").strip()

×‘×œ×™ probe, ×‘×œ×™ ×¨×©×ª ×¢×•×“×¤×ª â€” ×¤×©×•×˜ ×× ×¡×” ×œ×”×ª×—×‘×¨; ×× × ×›×©×œ, ×¢×•×‘×¨ ×œ-default ×•×××©×™×š. × ×§×™ ×•×¢××™×“.

â¸»

C) ×˜×•×•×™×œ×™×•/WS â€” ×•×•×“× ×©×”×¦×™× ×•×¨ × ×©××¨ ×—×™
	â€¢	TwiML <Start><Stream â€¦ track="both_tracks" /></Start> + ×ª×ª-×¤×¨×•×˜×•×§×•×œ audio.twilio.com.
	â€¢	×©×œ×— keep-alive ×§×˜×Ÿ ×›×œ ~15â€“20 ×©× ×³ (×˜×§×¡×˜/×¤×™× ×’) ×›×“×™ ×œ×× ×•×¢ idle timeout ×©×œ ×¤×¨×•×§×¡×™.
	â€¢	×¡×“×¨ ×¨×™×©×•× ×”× ×ª×™×‘ /ws/twilio-media ×œ×¤× ×™ ×”-SPA â€” ×›×“×™ ×©×œ× ×™×—×–×•×¨ index.html.

â¸»

D) ENV ××•××œ×¥ (Replit/Cloud Run)

ENABLE_STREAMING_STT=true
GCP_STT_LANGUAGE=he-IL
GCP_STT_MODEL=default
GOOGLE_CLOUD_SPEECH_ENDPOINT=europe-west1-speech.googleapis.com   # ××• us-... ×× ×™×¦×™×‘ ×™×•×ª×¨
STT_BATCH_MS=80
STT_PARTIAL_DEBOUNCE_MS=120
STT_TIMEOUT_MS=450
VAD_HANGOVER_MS=220


â¸»

E) ××™××•×ª ××—×¨×™ ×¤×¨×™×¡×” (××” ×œ×—×¤×© ×‘×œ×•×’×™×)
	â€¢	×‘×¢×ª ×¢×œ×™×™×”:
ğŸš€ Streaming STT enabled: True
	â€¢	×‘×ª×—×™×œ×ª ×©×™×—×”:
âœ… [STT] Streaming started ...
×× × ×™×¡×™×ª phone_call: âš ï¸ ... Failed with model 'phone_call' ×•××– âœ… ... model: default
	â€¢	××“×™×“×ª ×–××Ÿ:
[LATENCY] partialâ‰ˆ0.5â€“0.8s finalâ‰ˆ1.0â€“1.4s totalâ‰ˆ1.8â€“2.3s
	â€¢	×× ×ª×¨××”:
âŒ [STT] All streaming attempts failed â€” using single-request fallback
â†’ ×™×© ×œ×š ×ª××œ×•×œ ×‘×××¦×¢×•×ª ×¤×•×œ×‘××§, ×‘×œ×™ ×œ×—×¡×•×. ×‘×“×•×§ endpoint/×§×¨×“× ×¦â€™×™××œ.

â¸»

×œ××” ×–××ª ×”×”× ×—×™×” ×”× ×›×•× ×” ×¢×›×©×™×•
	â€¢	××—×–×™×¨×” ××™×“ ×ª××œ×•×œ (Hotfix) ×‘×œ×™ ×ª×œ×•×ª ×‘-probe/endpoint ××•×¨×›×‘.
	â€¢	××•× ×¢×ª ×—×¡×™××•×ª ×›×©× ×•×¤×œ×™× ×œ×¤×•×œ×‘××§.
	â€¢	××•×¡×™×¤×” fallback ××•×“×œ ×¤×©×•×˜, ×××™×Ÿ, ×©× ×‘×“×§ â€œ×ª×•×š ×›×“×™â€ â€” ×œ× ××¨××©.
	â€¢	×©×•××¨×ª ×¢×œ ×–××Ÿ ×ª×’×•×‘×” ~2â€“3 ×©× ×³ ×‘×¡×˜×¨×™××™× ×’, ×•×™×¦×™×‘×” ×’× ×‘×¢×•××¡.

×× ××—×¨×™ ×”-Hotfix ××ª×” ×¢×“×™×™×Ÿ ×œ× ×¨×•××” Streaming started, ×©×œ×— 10 ×©×•×¨×•×ª ×œ×•×’ ×¨××©×•× ×•×ª ×©×œ ×”×©×™×—×” (×›×•×œ×œ ×©×•×¨×•×ª ×”××•×“×œ/endpoint) ×•××›×•×•×Ÿ ××•×ª×š ×œ×©×•×¨×ª ×”×›×©×œ ×”××“×•×™×§×ª.