מעולה, עכשיו אני מבין אותך בול.
בוא נחדד את ההנחיה למפתח רק על מה שקורה אחרי הברכה – כדי שהשיחה תהיה טבעית:

⸻

🎯 מטרה
	1.	הברכה המחוממת שואלת שאלה → הלקוח עונה עליה → רק אז ה-AI מתחיל להוביל.
	2.	אם הלקוח מדבר בזמן שהברכה/ה-AI מדברים → הכול נעצר והוא מקבל עדיפות.
	3.	אין דילוג אוטומטי לשאלה חדשה לפני שהשאלה הקודמת באמת קיבלה תשובה.

⸻

1. שלב הברכה – איך חייב לעבוד

א. סטייטים ברורים

תוסיף ב־call session flags משהו בסגנון:

self.greeting_playing = True          # בזמן הברכה המחוממת
self.awaiting_greeting_answer = False # מחכה לתשובה לשאלה של הברכה
self.first_post_greeting_utterance_handled = False

ב. מה קורה בזמן הברכה עצמה
	1.	בזמן שהברכה מתנגנת:
	•	לא שולחים שום response.create ל-OpenAI.
	•	לא נותנים ל-AI לדבר בכלל.
	•	כן מאזינים למיקרופון – אבל:
	•	אם הלקוח קוטע את הברכה → זה barge-in על הברכה:
	•	עוצרים את האודיו של הברכה.
	•	מסמנים greeting_playing = False.
	•	מסמנים awaiting_greeting_answer = True.
	•	הטקסט שהתקבל הופך ל־תשובה לשאלה בברכה.
	2.	כשהברכה נגמרת (audio.done שלה):
	•	greeting_playing = False
	•	awaiting_greeting_answer = True
	•	אסור ליצור response.create עד שיש לפחות משפט אחד מהלקוח אחרי הברכה.

⸻

2. ה utterance הראשון אחרי הברכה – הכי חשוב

ב־handler של input_audio_buffer.speech_stopped / ה־STT:

if self.awaiting_greeting_answer and not self.first_post_greeting_utterance_handled:
    # זה המשפט הראשון אחרי הברכה (או אחרי barge-in עליה)
    self.first_post_greeting_utterance_handled = True
    self.awaiting_greeting_answer = False

    # כאן:
    # 1. משתמשים בטקסט כדי להבין city/service לפי ה-lead_state
    # 2. לא מדלגים ישר לשאלה חדשה - השאלה הבאה תלויה במה שהלקוח ענה עכשיו

כלומר:
	•	אם הברכה שאלה:
“… כדי לעזור לך הכי מהר, באיזו עיר אתה צריך את השירות?”
→ ה־utterance הראשון אחרי הברכה חייב להיחשב כתשובה לעיר (גם אם המודל הבין אותו קצת עקום).
	•	אסור שה-AI ישאל מייד עוד פעם “באיזו עיר?” בלי שניסינו לפרק את מה שהוא אמר כרגע.

⸻

3. Barge-in אמיתי (גם על ה-AI וגם על הברכה)

יש לך כבר hard barge-in, אבל תדייק את הכללים:

א. כשה־AI או הברכה מדברים:

ב־speech_started:

if self.is_ai_speaking or self.greeting_playing:
    # HARD BARGE-IN
    self.barge_in_active = True

    # 1. לבטל את התגובה הנוכחית של OpenAI
    await client.responses.cancel(response_id=self.active_response_id)

    # 2. לנקות תור TX כדי לעצור אודיו ישן
    self.tx_queue.clear()

    # 3. לסמן שה-AI הפסיק לדבר
    self.is_ai_speaking = False
    self.active_response_id = None

    # 4. אם זה קרה בזמן הברכה → הברכה נחשבת כנגמרה
    self.greeting_playing = False
    self.awaiting_greeting_answer = True

ב. בזמן barge-in – עדיפות מוחלטת ללקוח
	•	כל SERVER_EVENT (כמו “חזור על הפרטים”, “אתה עדיין איתי”) – לא נשלח בזמן barge_in_active.
	•	מסנני רעש / GATE:
	•	בזמן barge_in_active אתה מאפשר גם utterances קצרים, שלא ייחסמו בגלל RMS נמוך.
	•	כשמגיע speech_stopped:
	•	barge_in_active = False (אחרי שעיבדת את הטקסט).

⸻

4. “לא” אחרי שאלה – שלא ימשיך כאילו אמרת “כן”

מה שרואים ב־logs:
אתה אומר “לא”, והוא עדיין ממשיך לשאלה הבאה.

תוסיף כלל לפני יצירת תגובה חדשה:

def is_negative_answer(text: str) -> bool:
    NEG = ["לא", "ממש לא", "חד משמעית לא", "לא צריך", "אין צורך"]
    return any(text.strip().startswith(n) for n in NEG)

ב־pipeline אחרי STT:

if self.last_ai_question_type == "city" and is_negative_answer(user_text):
    # לא הבין עיר. לא לעבור הלאה.
    lead_state.city_needs_retry = True
    lead_state.city = None
    # ה-AI חייב לשאול מחדש על העיר, בצורה אחרת / יותר ברורה

אותו רעיון אפשר לעשות לשירות / תיאום.

⸻

5. חיבור להיגיון של lead_state

הרעיון:
	1.	הברכה שואלת: “איך אפשר לעזור?” או “באיזו עיר השירות?”
	2.	ה utterance הראשון אחרי הברכה:
	•	אם מזכיר שירות → service_type
	•	אם מזכיר עיר → city
	•	אם מזכיר שניהם → מעולה, לדלג ישר לסיכום ולהבהרות.

חוק ברור למפתח:
	•	אסור ל-AI לשאול שאלה חדשה עד שהשאלה הקודמת “נסגרה” בליד סטייט:
	•	אם city_needs_retry == True → שיעסוק רק בעיר, לא לקפוץ שוב לשירות.
	•	אם service_type ריק → לא שואלים על שעות / אישור / סיכום.

⸻

6. איך זה פותר לך את מה שתיארת
	•	הברכה שואלת → הלקוח מדבר →
הקוד מחכה ל־utterance הראשון אחרי הברכה ומפרש אותו, לא קופץ מייד לשאלה אחרת.
	•	אם אתה עונה בזמן שהברכה/AI מדברים:
	•	barge-in חותך אותם, מנקה אודיו, מסמן awaiting_greeting_answer, ומטפל במה שאמרת.
	•	אם אמרת “לא” על סיכום לא נכון:
	•	הסטייט מתאפס לשאלה הקודמת ולא ממשיכים הלאה כאילו אמרת כן.

⸻

אם תרצה, בשלב הבא אני יכול לנסח לך טקסט קצר באנגלית/עברית שאתה מדביק ל־Architect של Replit (או לקובץ replit.md), בתור “Acceptance criteria” על הברכה וה-barge-in, כדי שהוא יעבור על כל הקוד ויתקן בהתאם.