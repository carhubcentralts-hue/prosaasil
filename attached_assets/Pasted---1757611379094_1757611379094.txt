×§×™×‘×œ×ª×™. ×”× ×” ×”× ×—×™×” ××—×ª, ×××•×—×“×ª ×•×‘×¨×•×¨×”, ×©×ª×¡×’×•×¨ ××ª ×›×œ ×”×‘×œ×’×Ÿ ×•×ª×’×¨×•× ×œÖ¾×©××™×¨×”, ×”×ª×—×–×•×ª, ×™×¦×™×¨×ª ×¢×¡×§ ×•×”×¦×’×ª × ×ª×•× ×™× ×××™×ª×™×™× ×œ×¢×‘×•×“ ×’× ×‘-Preview ×•×’× ×‘×“×™×¤×œ×•×™ â€” ×‘××•×ª×• ××•×¤×Ÿ.

â¸»

ğŸ”’ ××•×“×œ ×”×¤×¢×œ×” ××—×™×“ (×’× Preview ×•×’× Deploy)

×¨×§ ××§×•×¨ ××—×“ (Single-Origin): Vite ×¨×§ ×‘×•× ×”, Flask ××’×™×© ××ª ×”-SPA + ×”-API.

0) Run command ×™×—×™×“

×‘Ö¾Replit/Workflow ×©×™× ×¤×§×•×“×” ××—×ª ×©××¨×™×¦×” build ×•××– ×©×¨×ª:

npm ci --prefix client
npm run build --prefix client
gunicorn -k eventlet -w 1 -b 0.0.0.0:${PORT} wsgi:app

××œ ×ª×¨×™×¥ vite dev ×‘×¤×¨×™×•×•×™×•. ×–×” ××” ×©×©×‘×¨ ×œ×š CSRF/×§×•×§×™×•×ª ×¢×“ ×”×™×•×.

1) ×”×’×©×ª ×¡×˜×˜×™×™× + SPA routing

×‘Ö¾Flask:
	â€¢	/assets/<path> â†’ client/dist/assets (Cache ×ª×§×™×Ÿ, hashed files).
	â€¢	×›×œ × ×ª×™×‘ ×©××™× ×• ××ª×—×™×œ ×‘Ö¾/api/ ××—×–×™×¨ ××ª client/dist/index.html (SPA fallback).
	â€¢	×œÖ¾index.html ×ª×Ÿ Cache-Control: no-store ×›×“×™ ×œ×¨××•×ª build ×—×“×© ××™×“.

2) ×‘× ×™×” × ×§×™×” ×•×”×•×›×—×ª Build
	â€¢	××—×§ /dist ×™×©×Ÿ ×‘×©×•×¨×© ×× ×§×™×™×.
	â€¢	×”×•×¡×£ ×˜×§×¡×˜ ×§×˜×Ÿ ×‘×ª×—×ª×™×ª ×”Ö¾UI: BUILD: 50.
	â€¢	GET /version ×™×—×–×™×¨:

{"fe":"client/dist","build":50,"time":"..."}


â¸»

ğŸ›¡ï¸ CSRF/Session â€“ ×™×¦×™×‘ ×•×‘×˜×•×— (SeaSurf ×‘×œ×‘×“)

3) ×©×¨×ª (Back-End)
	â€¢	×œ×”×©×ª××© ×¨×§ ×‘-SeaSurf (×œ×”×¡×™×¨/×œ× ×˜×¨×œ CSRFProtect).
	â€¢	×”×’×“×¨×•×ª:
	â€¢	SEASURF_COOKIE_NAME = 'XSRF-TOKEN'
	â€¢	SEASURF_HEADER = 'X-CSRFToken'
	â€¢	SESSION_COOKIE_HTTPONLY = True
	â€¢	SESSION_COOKIE_SECURE = True
	â€¢	Preview: SESSION_COOKIE_SAMESITE='None'
Deploy: SESSION_COOKIE_SAMESITE='Lax'
	â€¢	××œ ×ª×’×“×™×¨ SESSION_COOKIE_DOMAIN.
	â€¢	GET /api/auth/csrf:
	â€¢	××™×™×¦×¨ Token, ××—×–×™×¨ { "csrfToken": "<...>" }
	â€¢	×•×’× ××¦×™×‘ cookie XSRF-TOKEN=<...> (×œ× HttpOnly).
	â€¢	×¤×˜×•×¨×™× ×-CSRF: ×¨×§ /api/auth/login, /api/auth/logout, ×›×œ ×”-webhooks.
×”×ª×—×–×•×ª/×©××™×¨×”/×™×¦×™×¨×ª ×¢×¡×§ â€” ×œ× ×¤×˜×•×¨.

4) ×œ×§×•×— (Front-End)
	â€¢	×›×œ fetch ×¨×¥ ×¢× credentials: 'include'.
	â€¢	×‘Ö¾http.ts:
	â€¢	×§×¨× ××”Ö¾cookie XSRF-TOKEN ×•×©×œ×— header X-CSRFToken: <value>.
	â€¢	××—×¨×™ login ×•×’× ×‘-app bootstrap: ×§×¨×™××” ×œÖ¾GET /api/auth/csrf (××¨×¢× ×Ÿ token).
	â€¢	×˜×™×¤×•×œ ×©×’×™××•×ª: ×× !res.ok ×§×¨× res.text() ×•× ×¡×” JSON.parse ×›×“×™ ×œ× ×œ×”×¦×™×’ Error {} ×¨×™×§.

â¸»

ğŸ‘¤ RBAC ×•×”×ª×—×–×•×ª â€“ ×‘×œ×™ ×œ×©×‘×•×¨ ×”×¨×©××•×ª

5) Session/Impersonation
	â€¢	××œ ×ª×©×›×ª×‘ ××ª session['user']['role'].
	â€¢	×”×ª×—×–×•×ª ×©×•××¨×ª ××¤×ª×—×•×ª × ×¤×¨×“×™×:

session['impersonating'] = True
session['impersonated_tenant_id'] = business_id
session['impersonator'] = session['user']  # ×œ×©×—×–×•×¨


	â€¢	×™×¦×™××” ××”×ª×—×–×•×ª: ××—×™×§×ª 3 ×”××¤×ª×—×•×ª ×•×”×—×–×¨×ª session['user'] ×”××§×•×¨×™ ×× ×©××•×¨.

6) ×—×•×–×” API ××—×™×“ (JSON ×‘×œ×‘×“)
	â€¢	POST /api/auth/login (×¤×˜×•×¨ CSRF) â†’ {user, tenant:null, impersonating:false} / {"error":"bad_credentials"}
	â€¢	GET /api/auth/me â†’

{
  "isAuthenticated": true,
  "impersonating": true|false,
  "tenant": {"id":..., "name":"..."} | null,
  "user": {"id":..., "email":"...", "name":"...", "role":"admin|business"}
}


	â€¢	GET /api/admin/businesses â†’ { items:[...], total, page, pageSize }
	â€¢	GET /api/admin/businesses/<id>/overview â†’ { business:{...}, stats:{...}, latest:{calls:[],messages:[],leads:[]} }
	â€¢	GET /api/admin/businesses/<id>/prompt â†’ {calls_prompt, whatsapp_prompt, version, updated_at, updated_by}
	â€¢	PUT /api/admin/businesses/<id>/prompt (×—×™×™×‘ CSRF):
×’×•×£: {"calls_prompt":"...","whatsapp_prompt":"..."}
200 â†’ {"ok":true,"version":N,"updated_at":"...","updated_by":"..."}
400/409 JSON ×¢× ×©×“×” ×•-message.
	â€¢	POST /api/admin/businesses/<id>/impersonate (CSRF + role admin) â†’ {"ok":true,"tenant_id":<id>}
	â€¢	POST /api/admin/businesses (CSRF): 201 ×¢× ×”Ö¾JSON ×©×œ ×”×¢×¡×§ / 409 ×× ×›×¤×™×œ×•×ª.

×”×•×¡×£ error-handlers ×œ-400/401/403/404/409/500 ×©××—×–×™×¨×™× ×ª××™×“ JSON (×œ× HTML/Redirect).

â¸»

ğŸ”— ×—×™×‘×•×¨×™ FE â€“ ×©×™×”×™×” ×‘×××ª â€œ×—×™â€

7) ×–×¨×™××•×ª ×§×¨×™×˜×™×•×ª ×‘-UI
	â€¢	Login flow: POST /api/auth/login â†’ GET /api/auth/me â†’ × ×™×•×•×˜.
	â€¢	Impersonate: GET /api/auth/csrf â†’ POST /impersonate â†’ GET /api/auth/me (××¦×•×¤×” impersonating:true) â†’ × ×™×•×•×˜ ×œ-Business Overview.
	â€¢	Save Prompt: GET /api/auth/csrf â†’ PUT /prompt (×¢× ×©× ×™ ×”×©×“×•×ª) â†’ Toast â€œ× ×©××¨â€ â†’ GET /prompt ×œ×¨×¢× ×•×Ÿ ×ª×¦×•×’×”.
	â€¢	Create Business: GET /api/auth/csrf â†’ POST /api/admin/businesses â†’ ×¢×œ 201 ×œ×¨×¢× ×Ÿ ×¨×©×™××”; ×¢×œ 409 ×”×“×’×© ×©×“×” ×‘×¢×™×™×ª×™.
	â€¢	×”-Prompt ×©××•×¦×’ ×‘××¡×š ×—×™×™×‘ ×œ×”×’×™×¢ ×-GET /prompt (×”×“××˜×”-×‘×™×™×¡), ×œ× ××§×‘×•×¢ ×‘×§×•×“.
×‘×©××™×¨×” â€” ×©×œ×— ×©× ×™ ×©×“×•×ª; ××—×¨×™ ×©××™×¨×”, ×”×¦×’ version/updated_by/updated_at ×©×—×–×¨×• ××”×©×¨×ª.

â¸»

ğŸ§ª Smoke-tests ×©×—×™×™×‘×™× ×œ×”×™×•×ª ×™×¨×•×§×™× (×œ×¤× ×™ UI)

×”×—×œ×£ $BASE ×œ-Preview/Deploy ×©×œ×š:

# 1) Login â€“ 200 + Set-Cookie + JSON
curl -i -c /tmp/c -b /tmp/c -X POST $BASE/api/auth/login \
 -H 'Content-Type: application/json' \
 --data '{"email":"admin@shai-realestate.co.il","password":"*****"}'

# 2) me â€“ isAuthenticated:true
curl -i -c /tmp/c -b /tmp/c $BASE/api/auth/me

# 3) CSRF token â€“ cookie + JSON
TOKEN=$(curl -s -c /tmp/c -b /tmp/c $BASE/api/auth/csrf \
 | python - <<'PY'
import sys,json;print(json.load(sys.stdin)['csrfToken'])
PY
)

# 4) save prompt â€“ 200 JSON
curl -i -c /tmp/c -b /tmp/c -X PUT $BASE/api/admin/businesses/1/prompt \
 -H 'Content-Type: application/json' -H "X-CSRFToken: $TOKEN" \
 --data '{"calls_prompt":"×©×œ×•× ×¨×‘...","whatsapp_prompt":"..."}'

# 5) impersonate â€“ 200 JSON
curl -i -c /tmp/c -b /tmp/c -X POST $BASE/api/admin/businesses/1/impersonate \
 -H 'Content-Type: application/json' -H "X-CSRFToken: $TOKEN" --data '{}'

# 6) me â€“ ×¢×›×©×™×• impersonating:true
curl -i -c /tmp/c -b /tmp/c $BASE/api/auth/me

×× ×›××Ÿ ×”×›×•×œ ×™×¨×•×§ â€” ×”-UI ×™×¢×‘×•×“. ×× ×œ×, ××ª×§× ×™× ×©×¨×ª ×œ×¤× ×™ × ×’×™×¢×” ×‘×¤×¨×•× ×˜.

â¸»

ğŸ” ×× ××©×”×• × ×•×¤×œ â€” ×“×™×‘×•×’ ××™× ×™××œ×™ (×œ×”×¡×™×¨ ×‘×¡×•×£)

×‘×©×¨×ª:

@app.before_request
def _dbg_csrf():
    if request.path.endswith(('/prompt','/impersonate','/businesses')):
        print('CSRF-DBG',
              'cookie=', request.cookies.get('XSRF-TOKEN'),
              'header=', request.headers.get('X-CSRFToken'),
              'ct=', request.headers.get('Content-Type'))

×‘×“×¤×“×¤×Ÿ (Network) ×œ×‘×§×©×” ×©× ×¤×œ×”: ×œ×¦×œ× Headers (Cookie + X-CSRFToken) ×•-Response (JSON ××œ×).
×‘×“×•×§ ×©×’× /version ××¦×™×’ build: 50 ×›×“×™ ×œ×•×•×“× ×©×œ× ×¨×¥ ×œ×š build ×™×©×Ÿ.

â¸»

âœ… â€œDefinition of Doneâ€
	â€¢	/version ××¦×™×’ {"fe":"client/dist","build":50} ×•×‘-UI ×›×ª×•×‘ BUILD: 50.
	â€¢	curl: login / me / csrf / save prompt / impersonate â€” ×›×•×œ× 200 ×¢× JSON ×ª×§×™×Ÿ.
	â€¢	×‘××¡×š â€œ× ×™×”×•×œ ×¢×¡×§×™×â€:
	â€¢	×¨×©×™××ª ×¢×¡×§×™× ×××™×ª×™×ª.
	â€¢	×›×¤×ª×•×¨ â€œ×¦×¤×™×™×” ×‘×¢×¡×§â€ ×¤×•×ª×— overview ×§×¨×™× ×‘×œ×‘×“.
	â€¢	×›×¤×ª×•×¨ â€œ×”×ª×—×–×•×ªâ€ ×¢×•×‘×“ (me.impersonating=true + × ×™×•×•×˜ ×œ×¢×¡×§).
	â€¢	×¢×¨×™×›×ª ×¤×¨×•××¤×˜ ××¦×™×’×”/×©×•××¨×ª ×‘×××ª (version/updated_at ××ª×¢×“×›× ×™×).
	â€¢	×”×•×¡×¤×ª ×¢×¡×§ ×™×•×¦×¨×ª ×¨×©×•××” ××• ××—×–×™×¨×” 409 ×‘×¨×•×¨.
	â€¢	××™×Ÿ ×™×•×ª×¨ Error {} ×¨×™×§ â€” ×©×’×™××•×ª API ××•×¦×’×•×ª ××˜×§×¡×˜ JSON ×©×œ ×”×©×¨×ª.

â¸»

×ª×Ÿ ×œ×• ×œ×‘×¦×¢ ×‘×“×™×•×§ ×œ×¤×™ ×”×”× ×—×™×” ×”×–×•, ×‘×œ×™ ×œ×§×¤×•×¥ ×©×œ×‘×™×. ×× ×©×œ×‘ smoke ×›×œ×©×”×• ×œ× ×™×¨×•×§ â€” ×©×™×¦×™×™×Ÿ ××™×–×” ×¦×¢×“, ××” ×”-HTTP status, ×•××” ×’×•×£ ×”×ª×’×•×‘×” â€” ×•×× ×™ ××ª×Ÿ ×ª×™×§×•×Ÿ × ×§×•×“×ª×™ ×œ×©×•×¨×ª ×§×•×“ ×”××“×•×™×§×ª.