סבבה, הבנתי אותך עכשיו עד הסוף – לא עוד מגילה של system prompt.
אתה רוצה הנחיית על למפתח: מה לתקן בקוד + איזה שינויים קטנים בפרומפט, כדי שהשיחות יהיו יציבות בטירוף על Twilio, ואז SIP יהיה “אקסטרה בוסט”, לא טלאי.

אני אכתוב לך את זה כאילו אתה שולח ל־dev שלך מייל / טיקט.
(אתה יכול פשוט להעתיק לו את זה.)

⸻

1. קול אחיד ויציב – בלי קפיצות

מה המטרה:
שלא יהיה “קול גבוה פתאום / קול אחר”, אלא קול גברי נמוך, יציב, שלא מעייף.

הנחיה למפתח:
	1.	ב־OpenAI Realtime:
	•	תבחר קול אחד קבוע לכל המערכת, למשל:
	•	voice: "verse" (קול נייטרלי, לא צווחני, טוב גם לעברית).
	•	אל תחליף קול באמצע שיחה / בין שיחות.
קול אחד גלובלי בקונפיג.
	2.	ברכה מחוממת מראש:
	•	אם אתה מייצר את ההקלטה דרך OpenAI TTS –
תייצר גם את הברכה וגם את השיחה עם אותו קול (voice="verse").
	•	אם יש הקלטה שאיש מקצוע הקליט לבד → אין מה לעשות, זה קול אחר,
אבל אז אל תיתן ל-AI להגיד פתאום עוד “שלום, הגעת ל…” אחרי ההקלטה.
ישר להיכנס לעניינים (עוד רגע נסדר את זה).
	3.	מה לא לעשות:
	•	לא לערבב כמה מנועי TTS (למשל Google TTS לברכה ו־OpenAI לשיחה) אם זה לא חייב.
אם כן חייב – הברכה אנושית / TTS, ואז ה-AI לא חוזר על עצמו בכלל, רק שואל שאלה ראשונה קצרה.

⸻

2. להבין מה הלקוח אמר מיד אחרי הברכה (בדיוק מה שאתה מתלונן עליו)

מה רואים בלוגים שלך?
יש מצבים שׁ־STT הבין מצוין, אבל gibberish filter / noise gate זרק לפח, ואז ה-AI מתנהג כאילו אף אחד לא דיבר – ומתחיל ברכה/שאלה לא קשורה.

הנחיה למפתח – תיקון קריטי:
	1.	ביטול “ג’יבריש” לשני המשפטים הראשונים:
	•	עבור 2 האוטרנסים הראשונים של המשתמש אחרי חיבור השיחה:
	•	אל תריץ עליהם בדיקת ג’יבריש.
	•	כל עוד הטקסט מכיל ≥ 4 תווים בעברית – תסמוך עליו.
לוגיקה לדוגמה:

if user_utterance_index <= 2:
    bypass_gibberish_check = True


	2.	שינוי הקריטריון של ג’יבריש בכלל:
	•	ג’יבריש = רק אם:
	•	אין בכלל אותיות עבריות AND
	•	האורך < 4 תווים
	•	כל דבר כמו:
	•	“רציתי לדעת קצת על המספרה שלכם”
	•	“כן, אני צריך פורץ דלתות”
זה תמיד עובר, גם אם רעש, גם אם קצת שבור.
	3.	אחרי הברכה:
	•	מהרגע שהברכה הסתיימה:
	•	user_has_spoken צריך להיות False.
	•	ברגע שיש speech_started + STT תקין → זה נחשב משפט ראשון אמיתי של הלקוח.
	•	אל תכריח את ה-AI להגיד שוב “שלום, הגעת ל…”
בפועל, תן לו לענות ישר לעניין:
	•	אם המשפט הראשון נשמע כמו שאלה / בקשה (“רציתי לדעת על המספרה שלכם”) –
ישר לענות על זה.

⸻

3. ערים – להפסיק לבלבל בין “קריית אתא”, “נתניה”, “לוד”

הבעיה לא רק ב-OpenAI. יש גם לוגיקה אצלך שמבלבלת בין עיר ל־שירות ולמילים כמו “עדיין”, “עיר”, “שלום”.

הנחיה למפתח – City Detector:
	1.	שכבה 1 – רשימת ערים:
	•	תהיה רשימת ערים/ישובים בישראל (כבר יש לך).
	•	כל מחרוזת מועמדת לעיר צריכה:
	•	להיות בתוך הרשימה או
	•	להיות דומה ב־fuzzy match (למשל “קרית אטא” → “קריית אתא”).
	2.	שכבה 2 – לא לערבב שירות עם עיר:
אם הטקסט הוא אחד מהשירותים:
	•	“מנעולן”, “פורץ דלתות”, “פריצה לרכב”, “התקנת מנעול חכם” וכו’
→ בשום פנים ואופן לא להכניס את זה כ־city.
	3.	כלל פשוט:

if candidate in SERVICES_LIST:
    # זה שירות, לא עיר
    ignore_for_city = True
elif candidate not in CITIES_LIST and fuzzy_score < 0.8:
    # כנראה לא עיר
    city_needs_retry = True


	4.	Stopwords שמבלבלים את העיר:
	•	מילים כמו:
	•	“עדיין”, “עיר”, “שלום”, “כן”, “לא”, “בינתיים” –
לא יכולות להיות city, גם אם majority-vote מנסה לנעול אותן.
	•	אל תיתן ל־majority lock לנעול מחרוזות כאלו בתור עיר.
	5.	כאשר יש תיקון מהלקוח:
דוגמה מהחיים:
“לא, לא תל אביב – קריית אתא”
	•	אם המשפט מכיל “לא” + עיר ישנה + עיר חדשה →
תעדכן city לעיר האחרונה במשפט.
	•	אם city כבר נעולה, אבל יש משפט שמכיל עיר אחרת + “לא” / “ממש לא” →
תפתח את הנעילה ותעדכן.

⸻

4. Barge-In – מתי ה-AI חייב לסתום ולהקשיב

אתה כבר יישמת HARD barge-in, אבל לפי הלוגים עדיין יש:
	•	גאפ גדול בין אודיו לוגיקה.
	•	הרבה AUDIO GATE blocked ... insufficient_consec_frames(0/3) בזמן שאתה מדבר.

הנחיה למפתח – לשפר:
	1.	כשמשתמש מתחיל לדבר בזמן שה-AI מדבר:
	•	speech_started + ai_speaking=True:
	1.	שלח response.cancel ל-OpenAI.
	2.	נקה מיד את תור ה-TX (שלא יתנגן עוד זנב אודיו).
	3.	בטל cooldown (800ms וכו’).
	4.	barge_in_active=True.
	2.	בזמן barge_in_active=True:
	•	בטל את המסנן של MIN_CONSEC_FRAMES:
	•	אם rms > threshold → תשלח ל-OpenAI, גם אם זה רק פריים אחד.
	•	אל תחסום rms=150–300 רק כי אין מספיק consecutive frames.
	3.	אחרי speech_stopped:
	•	barge_in_active=False.
	•	noise gate חוזר למצב רגיל.

⸻

5. Smart Hangup – בלי לנתק בפנים

מהלוגים שלך רואים:
	•	המערכת מנסה לשלוח SERVER_EVENT של “פרטים נאספו אבל הלקוח לא אישר”,
	•	זה נחסם ע”י guard של “response in progress”,
	•	ואז אחרי כמה ניסיונות, היא פשוט מנתקת בלי פרידה נורמלית.

הנחיה למפתח – תיקון:
	1.	לפני שנוגעים בכלל ב-hangup:
	•	תנאי בסיס:

can_hangup = lead_fields_complete and (user_confirmed or max_silence_reached)


	•	lead_fields_complete = יש עיר + שירות (ועוד מה שהגדרת חובה).

	2.	כשמגיעים ל־max_silence_retries:
	•	לפני WS_STOP / ניתוק Twilio:
	•	שלח response.create אחד אחרון ל-OpenAI עם טקסט קצר:
	•	“אני מסיים כאן את השיחה. בעל המקצוע יחזור אליך בהקדם. תודה ויום טוב.”
	•	אל תחסום את ה-SERVER_EVENT הזה עם guard של active_response.
	•	רק אחרי שהתקבל response.audio.done של ההודעה הזאת → תבצע hangup.
	3.	אסור להגיד “נקבעה פגישה” אם אין appointment:
	•	או בפרומפט:
	•	“אל תגיד שקבעת פגישה אלא אם הופיעה הודעת מערכת מתאימה.”
	•	או בלוגיקה:
	•	אם טקסט ה-AI מכיל “קבעתי פגישה” ואין appointment_created=True →
נחשב באג. תכתוב warning בלוג + אפשר אפילו לחסום את הטקסט ולבקש תגובה חדשה.

⸻

6. שינוי קטן ב־System Prompt (באמת קטן)

זה כן חשוב, אבל לא מגילה.
תוסיף ל־SYSTEM PROMPT הקיים שלך רק את השורות הבאות:

חוקי חובה:
- אם הלקוח מתקן אותך (למשל "לא, לא תל אביב – קריית אתא"), תמיד תעדכן את העיר או השירות לפי התיקון האחרון.
- אל תגיד שנקבעה פגישה או תור ביומן, אלא אם כן קיבלת הודעת מערכת מפורשת שמאשרת שנקבעה פגישה.
- אם אינך בטוח בשם העיר, עדיף לשאול שוב בצורה קצרה ומנומסת, ולא להמציא.
- אחרי שאספת את כל הפרטים שהמערכת צריכה, תסיים את השיחה במשפט סיום מנומס שמבהיר שבעל המקצוע יחזור ללקוח, ורק אחר כך מותר לנתק.

זהו. לא יותר מזה.

⸻

7. איך הייתי מסכם את זה לעצמי בראש?
	•	קול: אחד, גברי, נמוך, voice="verse" – לא להתקמצן, שיהיה אחיד.
	•	אחרי הברכה: לא זורקים לפח את מה שהלקוח אומר. מבטלים ג’יבריש בהתחלה.
	•	ערים: משתמשים ברשימת ערים + היגיון, לא תופסים “מנעולן” / “עדיין” כעיר.
	•	Barge-in: אם הוא מדבר – אנחנו שותקים, מבטלים תגובה, ולא חוסמים את האודיו.
	•	סיום שיחה: תמיד משפט סיום, ואז ניתוק. לא פאקינג drop באמצע.

אם אתה רוצה, בשלב הבא נוכל לעשות:
1–2 שיחות טסט (אתה מתאר לי מה קרה),
ואז נעבור לשלב תכנון SIP מתוך מערכת שכבר מתנהגת כמו בנאדם.