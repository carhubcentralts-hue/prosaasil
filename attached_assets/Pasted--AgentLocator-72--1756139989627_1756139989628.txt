להלן **הנחיה אחת, מלאה ומדויקת** לסוכן/בוט שלך — מותאמת **לקוד שב־AgentLocator (72)** — כדי להגיע ל־**מערכת אחת מושלמת**: שיחות טלפון בזמן־אמת (Twilio Media Streams) + Fallback, WhatsApp דרך **Twilio** וגם **Baileys**, ו־**CRM פנימי** אחוד — בלי לשבור קבצים קיימים ובלי ליצור כפילויות.

> עקרונות ביצוע:
> • **Idempotent** – כל שינוי “מוסיף אם חסר”; אין מחיקות/דריסות אגרסיביות.
> • **ללא כפילויות** – לא ליצור קבצים עם שמות שכבר קיימים; אם קיים, לעדכן במקום.
> • **לא נוגעים ב־WS ושיחות שכבר עובדים** (מסלולים, watchdog, TwiML) – רק חיזוקים/השלמות.

---

# 0) הכנה בטוחה

1. יצירת ענף git חדש: `feat/wa-crm-unified`.
2. סריקה שיש **אין ראנר ישן** פעיל ב־Replit (“Run”) בזמן Deployment.
3. שמירת ENV הקיימים.

---

# 1) Health & Version (נדרש לדיפלוי יציב)

**קובץ:** `AgentLocator/server/app_factory.py` בתוך `create_app()`; אם קיים — אשר/עדכן; אם חסר — הוסף.

```python
@app.get("/")
def root(): return "ok", 200

@app.get("/healthz")
def healthz(): return "ok", 200

@app.get("/readyz")
def readyz():
    # אל תקרוס; החזר disabled כשחסר מפתח/שירות
    from flask import jsonify
    checks = {"db":"ok","openai":"ok","tts":"ok","twilio_secrets":"ok"}
    return jsonify(checks), 200

@app.get("/version")
def version():
    import os, time
    return {
        "app":"AgentLocator",
        "commit":os.getenv("GIT_COMMIT","dev"),
        "build_time":os.getenv("BUILD_TIME","dev"),
        "deploy_id":os.getenv("DEPLOY_ID","dev"),
        "ts": int(time.time())
    }, 200
```

---

# 2) תיקון טלמטריה של סטרים (לא יוחזר 500)

**קובץ:** `AgentLocator/server/routes_twilio.py` – בתוך ה־Blueprint של `/webhook`
(אם הפונקציה קיימת — עדכן; אם לא — הוסף).

```python
@twilio_bp.route("/stream_status", methods=["POST"])
def stream_status():
    from flask import request, current_app, make_response
    try:
        payload = request.form.to_dict(flat=True)  # Twilio שולחת form-encoded
        current_app.logger.info("STREAM_STATUS %s", payload)  # בלי extra
    except Exception:
        current_app.logger.exception("STREAM_STATUS_HANDLER_FAILED")
    resp = make_response("", 204)
    resp.headers["Cache-Control"] = "no-store, no-cache, must-revalidate, max-age=0"
    resp.headers["Pragma"] = "no-cache"
    return resp
```

> בשלב ראשון **בלי** `@require_twilio_signature`. אחרי שזה יציב אפשר להחזיר חתימה (יחזיר 403 במקום 500 אם חתימה לא תואמת).

ודא שב־TwiML של `incoming_call` כבר מוגדר:

```xml
<Stream url="wss://YOUR_HOST/ws/twilio-media" statusCallback="/webhook/stream_status">
```

---

# 3) CRM פנימי אחיד (ללא שבירה; “הוסף אם חסר”)

**קובץ:** `AgentLocator/server/db_migrate.py` – הרחב מיגרציות “add if missing” (אין DROP):

טבלאות חדשות אם חסר:

* `threads(id SERIAL PK, business_id INT, type VARCHAR(16), provider VARCHAR(16), peer_number VARCHAR(32), title VARCHAR(120), last_message_at TIMESTAMP, created_at TIMESTAMP DEFAULT now())`
* `messages(id SERIAL PK, thread_id INT FK, direction VARCHAR(4), message_type VARCHAR(16), content_text TEXT, media_url TEXT, provider_msg_id VARCHAR(64), status VARCHAR(16), created_at TIMESTAMP DEFAULT now())`

כבר יש `calls`/`call_turns` אצלך – אשר שקיימים.
אינדקסים:

* `CREATE INDEX IF NOT EXISTS idx_threads_biz_last ON threads(business_id, last_message_at DESC);`
* `CREATE INDEX IF NOT EXISTS idx_msgs_thread_time ON messages(thread_id, created_at);`

> אל תיגע בקיים; רק הוסף אם חסר. הדפס `Applied migration: <name>`.

---

# 4) Webhooks ל־WhatsApp (שני ספקים) → כתיבה ל־CRM

**קובץ:** `AgentLocator/server/routes_whatsapp.py` (קיים אצלך; עדכן/הוסף פונקציות)

### 4.1 Twilio WhatsApp (עם חתימה)

```python
@whatsapp_bp.post("/webhook/whatsapp/twilio")
@require_twilio_signature
def wa_in_twilio():
    from flask import request, current_app
    form = request.form
    from_number = form.get("From","")
    to_number   = form.get("To","")
    body        = form.get("Body","")
    num_media   = int(form.get("NumMedia","0"))
    media_url   = form.get("MediaUrl0") if num_media>0 else None

    # מצא/צור thread אחיד
    thread_id = upsert_thread(business_id=1, type_="whatsapp", provider="twilio", peer_number=from_number)

    # רשום הודעה נכנסת
    insert_message(thread_id=thread_id, direction="in", message_type="text" if not media_url else "media",
                   content_text=body, media_url=media_url, provider_msg_id=form.get("MessageSid"), status="received")
    return "", 204
```

### 4.2 Baileys → Python (HMAC)

```python
@whatsapp_bp.post("/webhook/whatsapp/baileys")
def wa_in_baileys():
    from flask import request, current_app
    import hmac, hashlib, os, json
    secret = os.getenv("WA_SHARED_SECRET","")
    raw = request.get_data() or b""
    sig = request.headers.get("X-BAILEYS-SIGNATURE","")
    good = hmac.new(secret.encode(), raw, hashlib.sha256).hexdigest()
    if not secret or sig != good:
        current_app.logger.warning("WA_BAILEYS_BAD_SIG")
        return "", 403

    ev = request.get_json(force=True, silent=True) or {}
    from_number = ev.get("from","")
    text = ev.get("text","")
    media_url = ev.get("media_url")
    provider_msg_id = ev.get("provider_msg_id")

    thread_id = upsert_thread(business_id=1, type_="whatsapp", provider="baileys", peer_number=from_number)
    insert_message(thread_id=thread_id, direction="in", message_type="text" if not media_url else "media",
                   content_text=text, media_url=media_url, provider_msg_id=provider_msg_id, status="received")
    return "", 204
```

> `upsert_thread`/`insert_message` – מימושים קטנים אצלך לאינטראקציה עם DB (שמור בקובץ עזר `server/dao_crm.py` אם חסר).

---

# 5) API אחיד ל־UI

**קובץ חדש (אם חסר):** `AgentLocator/server/api_crm_unified.py` – Blueprint `/api`.
(אם קיים אצלך קובץ דומה – עדכן בו; אל תיצור כפילות)

```python
@api_bp.get("/threads")
def list_threads():
    # תמיכה בפרמטרים: type=whatsapp|call , business_id=...
    ...

@api_bp.get("/threads/<int:thread_id>/messages")
def get_thread_messages(thread_id: int):
    ...

@api_bp.post("/whatsapp/send")
def wa_send():
    data = request.get_json(force=True)
    to = data.get("to"); text=data.get("text"); media_url=data.get("media_url")
    provider = (data.get("provider") or "auto").lower()
    # resolve provider לפי ENV ENABLE_WA_TWILIO/ENABLE_WA_BAILEYS ו-WA_PROVIDER_PRIORITY
    if provider in ("auto","baileys","twilio"): ...
    # שליחה (ראה סעיף 6) + רישום ב-DB
    ...
    return {"ok": True}, 200
```

ב־`app_factory.py` ודא רישום ה־Blueprint:

```python
from server.api_crm_unified import api_bp
app.register_blueprint(api_bp, url_prefix="/api")
```

---

# 6) שליחה החוצה – Twilio & Baileys (ללא כפילויות)

**Twilio:** (חבילות כבר קיימות)

```python
from twilio.rest import Client
client = Client(os.getenv("TWILIO_ACCOUNT_SID"), os.getenv("TWILIO_AUTH_TOKEN"))
msg = client.messages.create(
    from_=os.getenv("TWILIO_WA_FROM"),
    to=to, body=text or None,
    media_url=[media_url] if media_url else None
)
```

**Baileys (גשר לוקאלי):** קריאה HTTP ל־bridge (סעיף 7)

```python
import requests, os
port = int(os.getenv("WA_BAILEYS_PORT", "8000"))
requests.post(f"http://127.0.0.1:{port}/send",
              json={"to": to.replace("whatsapp:",""), "text": text, "media_url": media_url},
              timeout=6)
```

> עדכני סטטוס ב־DB (`queued/sent/failed`) בהתאם לתשובה.

---

# 7) Baileys bridge (Node) – באותו דיפלוי, בלי לשבור WS

**תיקייה חדשה:** `baileys-bridge/`

* `package.json` (אל תיצור אם קיים; אם חסר – צור לפי זה):

```json
{
  "name":"baileys-bridge","private":true,"type":"module",
  "dependencies":{"@adiwajshing/baileys":"^6.6.0","express":"^4.19.2","pino":"^9.0.0","pino-pretty":"^11.0.0","node-fetch":"^3.3.2"},
  "scripts":{"start":"node index.js"}
}
```

* `index.js` – לפי השלד שנתתי לך קודם (עם healthz, `/send`, upsert ל־Python דרך `/webhook/whatsapp/baileys` עם HMAC).
* **מאזין רק על `127.0.0.1:${WA_BAILEYS_PORT}`** – אין חשיפה חיצונית.
* **שומר סשן** ב־`WA_SESSION_DIR` (ENV) – אין כפילויות.

---

# 8) לוגים ואבטחה (קלים, בלי לשבור)

* אל תחיל חתימה על `/ws/twilio-media`.
* כן חתימה על `/webhook/whatsapp/twilio` ו־`/webhook/*` של טלפון.
* HMAC על `/webhook/whatsapp/baileys`.
* לוגים אחידים (JSON) כבר קיימים; הוסף:

  * `WA_IN_TWILIO`, `WA_IN_BAILEYS`
  * `WA_OUT_TWILIO`, `WA_OUT_BAILEYS`
  * `WS_START`, `HEBREW_SPEECH`, `PING_PONG_TX`, `WATCHDOG_REDIRECT_*`
* החזרות תמיד **200/204** ב-webhooks – לא 500.

---

# 9) Deployment אחד שמריץ הכול (API+Bridge)

**קובץ חדש:** `start_all.sh` (הרשאות `chmod +x`), ללא דריסת קיים:

```bash
#!/usr/bin/env bash
set -euo pipefail

# התקנות
pip install -r AgentLocator/requirements.txt
( cd baileys-bridge && npm ci )

# Bridge בלוקאל
node baileys-bridge/index.js &

# API עם Eventlet (WS של Twilio)
exec python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app
```

**Replit → Deployments**

* **Build:**
  `bash -lc 'pip install -r AgentLocator/requirements.txt && cd baileys-bridge && npm ci'`
* **Run:**
  `bash -lc './start_all.sh'`
* **Health Check Path:** `/healthz` (ואם לא ניתן לשנות – שורש `/` מחזיר "ok").

**ENV ב־Deployment (לא רק ב־Workspace):**

```
PUBLIC_BASE_URL=...
TWILIO_ACCOUNT_SID=...   TWILIO_AUTH_TOKEN=...  TWILIO_WA_FROM=whatsapp:+1...
OPENAI_API_KEY=...
GOOGLE_APPLICATION_CREDENTIALS=/path/to/gcp.json  # או GCP_CREDENTIALS_JSON
DATABASE_URL=...
ENABLE_WA_TWILIO=true
ENABLE_WA_BAILEYS=true
WA_BAILEYS_PORT=8000
WA_SHARED_SECRET=<random>
WA_SESSION_DIR=./baileys-bridge/session
WA_PROVIDER_PRIORITY=baileys,twilio
# לזיהוי גרסה:
GIT_COMMIT, BUILD_TIME, DEPLOY_ID
```

---

# 10) GO/NO-GO (בדיקות סגירת מעגל)

1. **בריאות** – `GET /`, `/healthz`, `/readyz`, `/version` → 200/JSON.
2. **TwiML** – `GET /webhook/incoming_call` → `<Play>...` ואז `<Connect><Stream ... statusCallback="/webhook/stream_status">`.
3. **סטטיים** – `HEAD /static/tts/greeting_he.mp3` + `fallback_he.mp3` → 200.
4. **WS אמיתי** – כלי WS ל־`wss://<PUBLIC_BASE_URL>/ws/twilio-media` → 101 (לא `curl -I`).
5. **שיחה חיה** – לוגים: `WS_START` → `HEBREW_SPEECH (final)` → `PING_PONG_TX`; אם לא קם WS: ≤6 שנ׳ `POST /webhook/handle_recording`.
6. **Twilio WA inbound** – `POST /webhook/whatsapp/twilio` = 204; נוצר thread+message ב־DB.
7. **Baileys** – סרוק QR פעם אחת בלוג bridge; `GET 127.0.0.1:8000/healthz` (מתוך הקונטיינר) → `connected:true`; שלח הודעת בדיקה → `POST /webhook/whatsapp/baileys` = 204; message ב־DB.
8. **שליחה אחידה** – `POST /api/whatsapp/send {"to":"whatsapp:+9725...","text":"בדיקה","provider":"auto"}` → נשמר ב־DB, מתקבל בצד השני.

---

# 11) Definition of Done

* ✅ שיחות טלפון: דו־כיווני בזמן אמת בעברית + Fallback, בלי 500, עם מדדים ולוגים.
* ✅ WhatsApp: שני ספקים פעילים (Twilio+Baileys), inbound/outbound נשמרים ל־CRM אחד.
* ✅ CRM: endpoints לאיסוף שיחות/שרשורים/הודעות עובדים; DB מסונכרן.
* ✅ דיפלוי אחד מריץ API+Bridge; healthchecks ירוקים; `/version` מציג Commit/Deploy.
* ✅ לא נוצרו כפילויות קבצים/נתיבים; כל שינוי “נוסף אם חסר”.

---

אם תרצה, אשלח **שלדי פונקציות `upsert_thread`/`insert_message`** ו־**דוגמאות SQL “add-if-missing”** מדויקות לפוסטגרס, כדי שתוכל להדביק ישירות—מבלי לשנות את מבנה הקוד הקיים.
