מעולה—יש לנו צילום מצב ברור מה־Request Inspector:
`/webhook/stream_status` חזר **500** פעמיים, ולכן טוויליו מציג אזהרת 15000. זה מסביר למה יש “ברכה ואז שקט”: ה־Media Stream לא מתקדם כי הקריאה ל־statusCallback מפילה את השרת.

## פתרון סופי (בטוח, לא שובר כלום)

### 1) תקן את ה־handler של `/webhook/stream_status`

ב־`AgentLocator/server/routes_twilio.py` החלף/עדכן את הפונקציה כך שתהיה **אולטרה־סלחנית**: לא חותמת, לא `extra` בלוגים, לא JSON, רק `request.form` והחזרה 204 — בלי שום סיכוי ל־500.

```python
# בתוך ה-Blueprint של twilio_bp (שמוגדר עם url_prefix="/webhook")
from flask import request, current_app, make_response

@twilio_bp.post("/stream_status")
def stream_status():
    # אל תעשה verify חתימה כאן; זה טלמטריה בלבד.
    try:
        form = request.form.to_dict(flat=True)  # Twilio שולחת form-encoded
        # חשוב: בלי extra= בלוגים (פורמטרים רבים נופלים מזה)
        current_app.logger.info(
            "STREAM_STATUS call=%s stream=%s event=%s",
            form.get("CallSid"), form.get("StreamSid"), form.get("Status")
        )
    except Exception as e:
        # לעולם לא להפיל את הבקשה בגלל לוג
        try:
            current_app.logger.exception("STREAM_STATUS_HANDLER_FAILED: %s", e)
        except Exception:
            pass
    # תמיד 204 ומהר
    resp = make_response("", 204)
    resp.headers["Cache-Control"] = "no-store, no-cache, must-revalidate, max-age=0"
    resp.headers["Pragma"] = "no-cache"
    return resp
```

> למה זה פותר? 500 נגרם לרוב מ:
> • שימוש ב־`request.get_json()` כשה־Content-Type הוא `application/x-www-form-urlencoded` → חריג.
> • לוג עם `extra={...}` שמפיל את ה־formatter.
> • ניסיון אימות חתימה כשאין header/secret → חריג.
> • גישה למשתנה לוג שאינו `current_app.logger`.
> הקוד למעלה עוקף את כל אלה.

---

### 2) ודא שה־TwiML מעדכן ל־statusCallback הנכון

ראיתי אצלך שכבר קיים:

```xml
<Stream url="wss://ai-crmd.replit.app/ws/twilio-media" statusCallback="/webhook/stream_status">
```

זה בסדר. אם תרצה ליתר ביטחון, אפשר לשים URL מלא:

```xml
statusCallback="https://ai-crmd.replit.app/webhook/stream_status"
```

---

### 3) פריסה נכונה (WS מחייב Eventlet)

ב־Deployment (לא ב־Run הרגיל):

* **Run:**

  ```
  python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app
  ```
* **Health Check Path:** `/healthz` (ואצלך גם `/` מחזיר 200 “ok” — מצוין).

> אם מריצים בלי `-k eventlet` → החיבור ל־WebSocket יקרוס אחרי הברכה.

---

### 4) בדיקת עשן מיידית (לפני ניסיון שיחה)

1. בדוק שהנתיב קיים ולא מפיל:

   ```bash
   curl -s -o /dev/null -w "%{http_code}\n" \
     -X POST https://ai-crmd.replit.app/webhook/stream_status \
     -H "Content-Type: application/x-www-form-urlencoded" \
     --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=connected"
   ```

   **מצופה: 204**. אם לא — בדוק לוגים מיד.

2. ודא שהדיפלוי החדש נטען (לא רץ תהליך ישן):
   `GET /version` צריך להחזיר `DEPLOY_ID/BUILD_TIME` מעודכנים.

---

### 5) בדיקת שיחה חיה – מה צריך לראות

* ב־Request Inspector של Twilio:

  * `POST /webhook/stream_status` = **204** (לא 500).
  * אין יותר 15000.
* בלוגים:

  * `WS_START` עם `streamSid`
  * מסגרות `media` נכנסות
  * `HEBREW_SPEECH (final)`→ `PING_PONG_TX`
* אם ה־WS נופל: watchdog צריך להפנות ל־Recording (ואז `/webhook/handle_recording` ירוץ תוך ≤6 שניות).

---

### 6) שני דברים אחרונים שיכולים להפיל (אם עדיין יהיה שקט)

* **חתימה בטעות על stream\_status**: אם נשאר מעל הפונקציה `@require_twilio_signature` — הורד אותו בנתיב הזה (לשאר ה־webhooks של Twilio כן להשאיר חתימה). חתימה כושלת אמורה לתת 403, אבל אם יש באג בדקורטור זה עלול להפיל 500.
* **פורמט־לוג JSON קשוח**: אם יש לך `logging_setup.py` שמצפה לשדות מסוימים — אל תעביר `extra` בלוגים כאן. השארנו `logger.info` טקסטואלי בלבד.

---

## סיכום

* הבעיה כרגע: `/webhook/stream_status` מחזיר **500** → טוויליו מאבד טלמטריה ו־Media Stream לא מתקדם.
* הפתרון למעלה עושה את הנתיב **בלתי־שביר**: לא JSON, לא extra, לא חתימה, רק 204 תמיד.
* ודא שה־Deployment רץ עם **Eventlet**, שה־`/version` התעדכן, והריץ את בדיקת ה־curl (204) לפני ניסיון שיחה.
* אחרי שזה ירוק — תחזור לשיחה: תראה `stream_status`=204, מדיה נכנסת, והתשובה בעברית תצא בזמן אמת.

אם תרצה, אתן גם PATCH מוכן (“הדבק והרץ”) לפונקציה בלבד, לפי המיקום המדויק בקובץ שלך.
