כן—פתחתי ובדקתי בפועל את **AgentLocator (77).zip**. להלן ממצאי אמת לפי הקבצים שצירפת + תיקונים מדויקים (DIFF) שמחסלים את השגיאות שראית ב־Twilio: **11205 (timeout)**, **12300 (Invalid Content-Type)**, ו־**404 ל־/static/greeting\_he.mp3**, וגם מבטיחים Handshake תקין ל־WS.

---

## מה ירוק כבר

* `POST /webhook/stream_status` → מוגדר כ־POST, ללא חתימה, מחזיר **204** מהר. ✔️
* `POST /webhook/stream_ended` → מחזיר TwiML עם `text/xml`. ✔️
* TwiML נבנה עם URLs מוחלטים וללא `//`. ✔️
* WhatsApp Unified API קיים תחת `/api/whatsapp` (ה־blueprint עם `url_prefix="/api/whatsapp"` כבר רשום ב־`app_factory.py`). ✔️
* Baileys bridge + webhook (`/webhook/whatsapp/baileys`) קיימים; `Procfile` מריץ `start_all.sh` שמרים Node ואז Gunicorn. ✔️
* תשלומים: `create-intent` → **410** ל־Stripe; `create` מחזיר **501/403** כשאין קונפיגורציה/הרשאה. ✔️

---

## שני גורמים אמיתיים לתקלות מהלוג + עוד “פוליש חובה”

### (א) 12300 + 11205 + 404: **`incoming_call`**

* בקוד שלך **יש `<Play>`** ל־`/static/greeting_he.mp3`. בטוויליו ראינו 404 על הנתיב הזה.
* בנוסף, היה לך קודם 12300 (Content-Type) ו־11205 (timeout). בקובץ הנוכחי ה־header כבר `text/xml`—טוב. ה־timeout קורה כמעט תמיד כשיש **cold start** או IO לא נחוץ ב־route הראשון.

✅ הפתרון הבטוח:

1. אל תבצע כל IO/טיפול כבד בתוך `incoming_call` (כבר עומד בזה).
2. **כוון את `<Play>` לנתיב שמובטח אצלך באפליקציה**: יש לך ראוט מפורש ל־`/static/tts/<path>`, ולכן עדיף להפנות ל־`/static/tts/greeting_he.mp3` (ולא ל־`/static/greeting_he.mp3`).
3. אם לא חייבים ברכה—מומלץ **להסיר** את `<Play>` לגמרי (מבטל סיכון 404 וגורם ל־AI לדבר מיד).

### (ב) 31920 (Handshake) שעדיין יחזור אם לא נתקן: **WebSocket subprotocol**

ב־`app_factory.py` יצרת `Server(..., subprotocols=...)`. ב־`simple-websocket` זה **לא פרמטר תקני**. התוצאה: ה־Handshake לא בהכרח יחזיר את `Sec-WebSocket-Protocol: audio.twilio.com`, וטוויליו מפיל 31920.
✅ צריך להחזיר את הכותרת דרך **`headers=[("Sec-WebSocket-Protocol","audio.twilio.com")]`** כשהיא מוצעת בבקשה.

---

## DIFF מדויקים (להדביק)

### 1) `AgentLocator/server/routes_twilio.py` — לתקן `<Play>` או להסירו

**אופציה מומלצת (למנוע 404 ועדיין להשמיע ברכה):** הפניה ל־`/static/tts/greeting_he.mp3`

```diff
 @twilio_bp.route("/webhook/incoming_call", methods=["POST"])
 @require_twilio_signature
 def incoming_call():
@@
-    # החזרת ברכה לפני AI (לפי הבקשה החדשה)
-    twiml = f"""<?xml version="1.0" encoding="UTF-8"?>
-<Response>
-  <Play>{abs_url('/static/greeting_he.mp3')}</Play>
-  <Connect action="{stream_ended_url}">
+    # ברכה בטוחה (נשענת על ראוט /static/tts/* שקיים בוודאות)
+    twiml = f"""<?xml version="1.0" encoding="UTF-8"?>
+<Response>
+  <Play>{abs_url('/static/tts/greeting_he.mp3')}</Play>
+  <Connect action="{stream_ended_url}">
     <Stream url="wss://{wss_host}/ws/twilio-media" statusCallback="{stream_status_url}">
       <Parameter name="call_sid" value="{call_sid}"/>
     </Stream>
   </Connect>
 </Response>"""
@@
-    resp = make_response(twiml, 200)
-    resp.headers["Content-Type"] = "text/xml"
+    resp = make_response(twiml, 200)
+    resp.headers["Content-Type"] = "text/xml"  # חשוב למנוע 12300
     resp.headers["Cache-Control"] = "no-store, no-cache, must-revalidate, max-age=0"
     resp.headers["Pragma"] = "no-cache"
     return resp
```

**אופציה חלופית (AI מדבר מיד, ללא סיכון 404):** להסיר לגמרי את ה־`<Play>…</Play>` מה־TwiML.

> טיפ בדיקה:
> `curl -I https://{PUBLIC_BASE_URL}/static/tts/greeting_he.mp3` → מצופה `200 OK` ו־`Content-Type: audio/mpeg`.

---

### 2) `AgentLocator/server/app_factory.py` — Handshake תקין ל־WS (סוגר 31920)

החלף שימוש ב־`subprotocols=` בהחזרת כותרת פרוטוקול:

```diff
 from simple_websocket import Server as WebSocketServer
 from server.media_ws import MediaStreamHandler
 
 @app.route("/ws/twilio-media", methods=["GET"])
 def ws_twilio_media():
     """WebSocket handler for Twilio Media Streams - simple-websocket"""
     try:
-        offered = request.headers.get("Sec-WebSocket-Protocol", "")
-        subprotocols = ["audio.twilio.com"] if "audio.twilio.com" in offered else None
-        ws = WebSocketServer(environ=request.environ, subprotocols=subprotocols)
-        print("WS_CONNECTED /ws/twilio-media with audio.twilio.com subprotocol")
+        offered = request.headers.get("Sec-WebSocket-Protocol", "")
+        headers = [("Sec-WebSocket-Protocol","audio.twilio.com")] if "audio.twilio.com" in offered else []
+        ws = WebSocketServer(environ=request.environ, headers=headers)
+        print("WS_CONNECTED /ws/twilio-media (audio.twilio.com acknowledged)")
         MediaStreamHandler(ws).run()
     except Exception as e:
         print(f"❌ WS_ERROR: {e}")
         return "WebSocket Error", 500
     return "WebSocket Closed", 200
 
 @app.route("/ws/twilio-media/", methods=["GET"])
 def ws_twilio_media_slash():
     """WebSocket handler with slash - simple-websocket"""
     try:
-        offered = request.headers.get("Sec-WebSocket-Protocol", "")
-        subprotocols = ["audio.twilio.com"] if "audio.twilio.com" in offered else None
-        ws = WebSocketServer(environ=request.environ, subprotocols=subprotocols)
-        print("WS_CONNECTED /ws/twilio-media/ with audio.twilio.com subprotocol")
+        offered = request.headers.get("Sec-WebSocket-Protocol", "")
+        headers = [("Sec-WebSocket-Protocol","audio.twilio.com")] if "audio.twilio.com" in offered else []
+        ws = WebSocketServer(environ=request.environ, headers=headers)
+        print("WS_CONNECTED /ws/twilio-media/ (audio.twilio.com acknowledged)")
         MediaStreamHandler(ws).run()
     except Exception as e:
         print(f"❌ WS_ERROR: {e}")
         return "WebSocket Error", 500
     return "WebSocket Closed", 200
```

---

### 3) (רשות אבל מומלץ) לוגים בתוך Threads של WS

אם תראה חריגות `"Working outside of application context"` או קריסות על `extra=`:

* החלף ב־`print(...)` או `logging.getLogger(__name__).info(...)` **בלי** `extra=...` בתוך ה־threads שב־`media_ws.py`.

---

## בדיקות עשן (מוכיחות בשטח)

1. **incoming\_call מחזיר מהר וב־`text/xml`**

```bash
curl -i -X POST "$PUBLIC_BASE_URL/webhook/incoming_call" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "CallSid=CA_TEST" | sed -n '1,10p'
# מצופה: HTTP/1.1 200 OK + Content-Type: text/xml
```

2. **ברכה (אם נשארה)**

```bash
curl -I "$PUBLIC_BASE_URL/static/tts/greeting_he.mp3"
# מצופה: 200 OK + Content-Type: audio/mpeg
```

3. **Callbacks**

```bash
curl -i -X POST "$PUBLIC_BASE_URL/webhook/stream_status" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=connected"

curl -i -X POST "$PUBLIC_BASE_URL/webhook/stream_ended" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=completed"
# מצופה: 204 ו-204
```

4. **WS Handshake (קריטי)**
   בכלי WS שמבקש סאב־פרוטוקול:

```bash
wscat -c "wss://${HOST}/ws/twilio-media" -s "audio.twilio.com"
# מצופה: connected (subprotocol: audio.twilio.com)
```

5. **שיחה חיה (Twilio Request Inspector)** – השיחה הבאה צריכה להראות:

* `POST /webhook/incoming_call` = **200 מהיר** (אין 11205)
* `GET /static/tts/greeting_he.mp3` = **200** (או אין GET בכלל אם הסרת את ה־Play)
* `POST /webhook/stream_status` = **204** (אין 15003/405)
* **אין** 31920 (Handshake Error)

---

## סיכום חד

* בדקתי את הקוד שאתה צירפת (77) — רובו ירוק.
* שני תיקונים קטנים ונקודת “פוליש” אחת סוגרים את כל מה שראית בלוגים:

  1. `<Play>` → לנתיב `/static/tts/greeting_he.mp3` (או להסיר לגמרי).
  2. WS: להחזיר `Sec-WebSocket-Protocol` דרך `headers=[(...)]` (לא `subprotocols=`).
  3. (מומלץ) לוגים ב־threads בלי `extra=`.

ביצוע ה־diffים וה־smoke למעלה ייתן לך **GO ודאי**. אם אחת מהבדיקות לא ירוקה—שלח לי את ה־status/headers/response המדויקים, ואחזיר פאטצ’ ממוקד של כמה שורות באותו רגע.
