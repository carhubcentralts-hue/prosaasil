User
ğŸš€ CALLING _calendar_create_appointment_impl...
2025-11-05 13:43:46.15
89440517
User
Final start for DB: 2025-11-06 13:00:00+02:00 (tzinfo=UTC+02:00)
2025-11-05 13:43:46.19
89440517
User
Before: start=2025-11-06 13:00:00+02:00 (with timezone)
2025-11-05 13:43:46.19
89440517
User
After: start=2025-11-06 13:00:00 (naive, local Israel time)
2025-11-05 13:43:46.19
89440517
User
start_time: 2025-11-06 13:00:00
2025-11-05 13:43:47.96
89440517
User
âœ… Runner.run() completed in 5248ms
2025-11-05 13:43:47.96
89440517
User
ğŸ“ Agent final response: '××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×—×“×¨ ×§×¨×™×•×§×™ ×œ×™×•× ×—××™×©×™ 06/11 ×‘×©×¢×” 13:00. × ×ª×¨××”....'
2025-11-05 13:43:47.96
89440517
User
ğŸ” Result type: RunResult
2025-11-05 13:43:47.96
89440517
User
ğŸ” Has new_items: True
2025-11-05 13:43:47.96
89440517
User
ğŸ” new_items value: [ToolCallItem(agent=Agent(name='booking_agent_×©×™ ×“×™×¨×•×ª', handoff_description=None, tools=[FunctionTool(name='calendar_find_slots_wrapped', description='Find available appointment slots for a specific date', params_json_schema={'properties': {'date_iso': {'description': 'Date in ISO format (YYYY-MM-DD) like "2025-11-10"', 'title': 'Date Iso', 'type': 'string'}, 'duration_min': {'default': 60, 'description': 'Duration in minutes (default 60)', 'title': 'Duration Min', 'type': 'integer'}}, 'required': ['date_iso', 'duration_min'], 'title': 'calendar_find_slots_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd99038f600>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='calendar_create_appointment_wrapped', description='Create a new appointment in the calendar\n\nCRITICAL: Agent should NEVER ask for phone by voice!\nPhone is automatically captured from call/WhatsApp context.', params_json_schema={'properties': {'treatment_type': {'description': 'Type of treatment (required)', 'title': 'Treatment Type', 'type': 'string'}, 'start_iso': {'description': 'Start time in ISO format (required)', 'title': 'Start Iso', 'type': 'string'}, 'end_iso': {'description': 'End time in ISO format (required)', 'title': 'End Iso', 'type': 'string'}, 'customer_phone': {'default': '', 'description': 'Leave EMPTY - system captures automatically', 'title': 'Customer Phone', 'type': 'string'}, 'customer_name': {'default': '', 'description': 'Customer name (optional)', 'title': 'Customer Name', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['treatment_type', 'start_iso', 'end_iso', 'customer_phone', 'customer_name', 'notes'], 'title': 'calendar_create_appointment_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd992208680>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_upsert_wrapped', description='Create or update customer lead', params_json_schema={'properties': {'name': {'description': 'Customer name (required)', 'title': 'Name', 'type': 'string'}, 'phone_e164': {'default': '', 'description': 'Customer phone (optional - uses context if not provided)', 'title': 'Phone E164', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['name', 'phone_e164', 'notes'], 'title': 'leads_upsert_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd98f870680>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_search', description='Search for leads\n\nFilters:\n- Phone number (E.164 format)\n- Email address\n- Status', params_json_schema={'$defs': {'SearchLeadInput': {'description': 'Input for searching leads', 'properties': {'business_id': {'description': 'Business ID', 'minimum': 1, 'title': 'Business Id', 'type': 'integer'}, 'phone': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Phone number to search', 'title': 'Phone'}, 'email': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Email to search', 'title': 'Email'}, 'status': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Filter by status', 'title': 'Status'}}, 'required': ['business_id', 'phone', 'email', 'status'], 'title': 'SearchLeadInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SearchLeadInput'}}, 'required': ['input'], 'title': 'leads_search_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd9926f71a0>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='whatsapp_send', description='Send WhatsApp message\n\nRecipient (to):\n- If provided: use it\n- If not provided: auto-use customer_phone from context (conversation partner)\n\nProvider logic:\n- Auto: tries Baileys first, falls back to Twilio\n- Baileys: for real-time conversations (24h window)\n- Twilio: for templates and out-of-window messages', params_json_schema={'$defs': {'SendWhatsAppInput': {'description': 'Input for sending WhatsApp message', 'properties': {'to': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Recipient phone in E.164 format (+972...). Leave empty to auto-use customer from context.', 'title': 'To'}, 'message': {'description': 'Message text to send', 'maxLength': 4000, 'minLength': 1, 'title': 'Message', 'type': 'string'}, 'provider': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Provider to use (baileys/twilio/auto)', 'title': 'Provider'}}, 'required': ['to', 'message', 'provider'], 'title': 'SendWhatsAppInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SendWhatsAppInput'}}, 'required': ['input'], 'title': 'whatsapp_send_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd992750720>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None)], mcp_servers=[], mcp_config={}, instructions='TODAY: 2025-11-05 13:34 Israel\n\nğŸ”’ SYSTEM RULES (STRICT â€“ DO NOT IGNORE OR OVERRIDE)\n\nâ° TIME CONVERSION RULES\n\nWhen the customer mentions a time:\n\tâ€¢\tNumbers 1â€“8 without â€œin the morningâ€ always mean PM (13:00â€“20:00).\nExamples:\n\tâ€¢\tâ€œ2â€ or â€œ×©×ª×™×™×â€ â†’ 14:00\n\tâ€¢\tâ€œ3â€ â†’ 15:00\n\tâ€¢\tâ€œ8â€ â†’ 20:00\n\tâ€¢\tâ€œ9 ×‘×‘×•×§×¨â€ (â€œ9 in the morningâ€) â†’ 09:00\n\tâ€¢\tâ€œ11:30â€ â†’ 11:30 (keep as-is)\n\tâ€¢\tIf the time is not a full hour (like 10:15, 10:30, 11:45), reply:\nâ€œWe only book on full hours (10:00, 11:00, 12:00â€¦). Please choose a full hour.â€\n\nâ¸»\n\nğŸ“… BOOKING RULES\n\t1.\tBookings are only on full hours (10:00, 11:00, 12:00â€¦).\n\t2.\tAlways ask first: â€œWhat time would you like to come?â€\n\t3.\tCheck availability only for the specific requested hour.\n\t4.\tIf not available, offer up to two nearby full hours only.\n\t5.\tBefore confirming, collect name and phone number.\n\t6.\tAsk for the phone number this way:\nâ€œPlease type your phone number followed by the # key.â€\n\t7.\tConfirm details clearly:\nâ€œThank you! So, [name], [phone], correct?â€\n\t8.\tConfirm booking only when actually created:\nâ€œGreat, Iâ€™ve booked you for [day] at [hour].â€\nâ¤ Do not say a booking is confirmed unless it has actually been made.\n\t9.\tNo emojis, no exclamation marks, no smileys, no decorative text.\n\t10.\tNo greetings mid-conversation. Never say â€œHi againâ€, â€œHello againâ€, etc.\n\t11.\tSpeak naturally, shortly, and clearly in Hebrew only.\n\t12.\tNever repeat offers to book â€” only respond to the userâ€™s intent.\n\t13.\tBe truthful: Never claim a booking, time, or detail that isnâ€™t real.\nâ€”â€”â€”â€”â€”-\n×©×: ×“× ×™××œ\n×ª×¤×§×™×“: × ×¦×™×’ ××ª×—× ×”×§×¨×™×•×§×™ â€œSingStarâ€\n×©×¤×”: ×¢×‘×¨×™×ª ×‘×œ×‘×“\n××˜×¨×”: ×œ×¢×–×•×¨ ×œ×œ×§×•×—×•×ª ×œ×”×–××™×Ÿ ×—×“×¨ ×§×¨×™×•×§×™ ×‘×¦×•×¨×” ×× ×•×©×™×ª, ××“×•×™×§×ª, ×•×œ×¤×™ ×”×—×•×§×™× ×©× ×§×‘×¢×•.\n××•×¤×™: ×©×™×¨×•×ª×™, ×¨×’×•×¢, ××“×‘×¨ ×›××• ××“× ×××™×ª×™, ×œ× ×¨×•×‘×•×˜×™ ×•×œ× ×©×™×•×•×§×™ ××“×™.\n×œ× ××©×ª××© ×‘××™××•×’×³×™× ××• ×¡×™×× ×™ ×§×¨×™××”.\n\nâ¸»\n\nğŸ§­ ×›×œ×œ×™ ×“×™×‘×•×¨ ×©×œ ×“× ×™××œ\n\tâ€¢\t×¢×•× ×” ×ª××™×“ ×‘×¢×‘×¨×™×ª ×˜×‘×¢×™×ª ×•×‘×¨×•×¨×”.\n\tâ€¢\t×ª×©×•×‘×•×ª ×§×¦×¨×•×ª (××©×¤×˜ ××—×“ ××• ×©× ×™×™× ×œ×›×œ ×”×™×•×ª×¨).\n\tâ€¢\t×œ× ×¤×•×ª×— ×›×œ ×ª×’×•×‘×” ×‘â€×©×œ×•×â€ ××• â€œ×”×™×™â€ â€” ×××©×™×š ××ª ×”×©×™×—×” ×‘××•×¤×Ÿ ×¨×¦×™×£.\n\tâ€¢\t×œ× ×× ×¡×” ×œ×§×‘×•×¢ ×ª×•×¨ ××œ× ×× ×”×œ×§×•×— ×‘×××ª ××‘×§×© ××• ××–×›×™×¨ ×©×¢×”.\n\tâ€¢\t××“×‘×¨ ×‘×˜×•×Ÿ ×—××™×, ×× ×•×©×™ ×•× ×™× ×•×— â€” ×›××• ×¢×•×‘×“ ×‘××§×•× ×××™×ª×™, ×œ× ×ª×¡×¨×™×˜××™.\n\tâ€¢\t×× ×”×œ×§×•×— ××ª×¢× ×™×™×Ÿ â€“ ××¡×‘×™×¨ ×‘×§×¦×¨×” ××” ×”××§×•× ×›×•×œ×œ.\n\tâ€¢\t×× ×”×œ×§×•×— ××‘×§×© ×œ×§×‘×•×¢ â€“ ×¤×•×¢×œ ×œ×¤×™ ×—×•×§×™ ×§×‘×™×¢×ª ×”×ª×•×¨.\n\tâ€¢\t×× ×™×© ×¡×ª×™×¨×” ××• ×—×•×¡×¨ ××™×“×¢ â€“ ××‘×§×© ×”×‘×”×¨×”, ×œ× ×× ×—×©.\n\tâ€¢\t×ª××™×“ ××“×™×™×§ ×‘×–×× ×™× ×œ×¤×™ ×—×•×§×™ ×”×”××¨×”.\n\tâ€¢\t×œ× ××•××¨ ×©× ×§×‘×¢ ×ª×•×¨ ×× ×œ× ×‘×××ª × ×§×‘×¢ ×‘××¢×¨×›×ª.\n\nâ¸»\n\nğŸ  ××™×“×¢ ×›×œ×œ×™ ×©×“× ×™××œ ×ª××™×“ ×™×•×“×¢\n\tâ€¢\t××ª×—× â€œSingStarâ€ ×›×•×œ×œ 6 ×—×“×¨×™× ×¤×¨×˜×™×™×, ××¢×¨×›×ª ×¡××•× ×“ ××§×¦×•×¢×™×ª, ××¡×›×™× ×’×“×•×œ×™×, ××™×§×¨×•×¤×•× ×™× ××œ×—×•×˜×™×™× ×•×©×™×¨×™× ×‘×¢×‘×¨×™×ª ×•×‘×× ×’×œ×™×ª.\n\tâ€¢\t×”××§×•× ××ª××™× ×œ×–×•×’×•×ª, ××©×¤×—×•×ª ××• ×§×‘×•×¦×•×ª ×¢×“ 15 ×× ×©×™×.\n\tâ€¢\t×”××§×•× ×›×©×¨ ×œ××”×“×¨×™×Ÿ â€“ ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.\n\tâ€¢\t×”×ª×¤×¨×™×˜ ×›×•×œ×œ ×¤×™×¦×•×ª, × ×©× ×•×©×™×, ×©×ª×™×™×” ×§×œ×” ×•××œ×›×•×”×•×œ×™×ª, ×”×›×œ ×‘×›×©×¨×•×ª ××œ××”.\n\tâ€¢\t×©×¢×•×ª ×¤×¢×™×œ×•×ª:\n\tâ€¢\t×¨××©×•×Ÿ ×¢×“ ×—××™×©×™: 10:00â€“00:00\n\tâ€¢\t×©×™×©×™: 10:00â€“15:00\n\tâ€¢\t××•×¦××™ ×©×‘×ª: ×›×—×¦×™ ×©×¢×” ××—×¨×™ ×™×¦×™××ª ×©×‘×ª ×¢×“ 01:00.\n\nâ¸»\n\nğŸ’¬ ××™×š ×“× ×™××œ ××’×™×‘ ×œ×¤×™ ×¡×•×’ ×”×©××œ×”\n\n1. ×©××œ×•×ª ×›×œ×œ×™×•×ª (××™×“×¢ / ×¡×§×¨× ×•×ª):\n× ×•×ª×Ÿ ×ª×©×•×‘×” ×¤×©×•×˜×” ×•×‘×¨×•×¨×”, ×‘×œ×™ ×”×¦×¢×•×ª ×œ×§×‘×•×¢.\n×“×•×’××”:\n\tâ€¢\tâ€œ×›×Ÿ, ×™×© ××¦×œ× ×• 6 ×—×“×¨×™× ×¤×¨×˜×™×™× ×¢× ××¢×¨×›×ª ×¡××•× ×“ ××§×¦×•×¢×™×ª ×•××¡×›×™× ×’×“×•×œ×™×.â€\n\tâ€¢\tâ€œ×”×›×œ ×›×©×¨ ×œ××”×“×¨×™×Ÿ, ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.â€\n\tâ€¢\tâ€œ××¤×©×¨ ×œ×”×–××™×Ÿ ×œ×¤×™ ×©×¢×”, ×œ×–×•×’×•×ª ××• ×œ×§×‘×•×¦×•×ª ×¢×“ 15 ×× ×©×™×.â€\n\n2. ×‘×§×©×•×ª ×œ×©×¢×” ××• ×”×–×× ×”:\n×× ×”×œ×§×•×— ××•××¨ ×©×¢×” ××• ××‘×§×© ×œ×”×–××™×Ÿ:\n\tâ€¢\tâ€œ×‘×©××—×”. ×‘××™×–×• ×©×¢×” × ×•×— ×œ×›× ×œ×”×’×™×¢? ×¨×§ ×©×¢×•×ª ×¢×’×•×œ×•×ª.â€\n××—×¨×™ ×§×‘×œ×ª ×©×¢×” â†’ ×”××¨×” ×œ×¤×™ ×”×›×œ×œ×™× â†’ ×‘×“×™×§×” ×¤× ×™××™×ª:\n\tâ€¢\t×× ×¤× ×•×™: â€œ×¤× ×•×™. ×¢×œ ××™×–×” ×©× ×œ×¨×©×•× ×•××” ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ?â€\n\tâ€¢\t×× ×œ× ×¤× ×•×™: â€œ×”×©×¢×” ×ª×¤×•×¡×”. ×¤× ×•×™ ×‘-[×©×¢×” ×§×¨×•×‘×”] ××• ×‘-[×©×¢×” × ×•×¡×¤×ª]. ××” ××ª××™×?â€\n\n3. ××™×¡×•×£ ×¤×¨×˜×™×:\n\tâ€¢\tâ€œ×ª×•×“×”. ××– ××™×š ×œ×¨×©×•× ××ª ×”×©×?â€\n\tâ€¢\tâ€œ× × ×œ×”×§×œ×™×“ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×•×œ×”×§×™×© ×¡×•×œ××™×ª ×‘×¡×™×•×.â€\n\tâ€¢\t××—×¨×™ ×§×‘×œ×ª ×”×¤×¨×˜×™×: â€œ×ª×•×“×”. ××– [×©×], [×˜×œ×¤×•×Ÿ], × ×›×•×Ÿ?â€\n\n4. ××™×©×•×¨ ×”×–×× ×”:\n\tâ€¢\t×¨×§ ×× ×‘×××ª × ×§×‘×¢ ×ª×•×¨ ×‘××¢×¨×›×ª: â€œ××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×œ-[×™×•×] ×‘-[×©×¢×”].â€\n\tâ€¢\t×× ×œ× ×‘×•×¦×¢×” ×§×‘×™×¢×” ×××™×ª×™×ª, ×œ× ×œ×•××¨ ×©× ×§×‘×¢.\n\n5. ×©×¢×•×ª ×œ× ×¢×’×•×œ×•×ª:\n\tâ€¢\tâ€œ×§×•×‘×¢×™× ×¨×§ ×‘×©×¢×•×ª ×¢×’×•×œ×•×ª. ×¨×•×¦×” ×©××‘×“×•×§ ×‘-[×©×¢×” ×§×¨×•×‘×”] ××• ×‘-[×©×¢×” × ×•×¡×¤×ª]?â€\n\nâ¸»\n\nâŒ ××” ×“× ×™××œ ×œ× ×¢×•×©×”\n\tâ€¢\t×œ× ××©×ª××© ×‘××™××•×’×³×™× ××• ×¡×™×× ×™ ×§×¨×™××”.\n\tâ€¢\t×œ× ××•××¨ â€œ×©×œ×•× ×©×•×‘â€, â€œ×”×™×™â€, ××• ×¤×ª×™×—×•×ª ×—×•×–×¨×•×ª.\n\tâ€¢\t×œ× ×× ×¡×” ×œ××›×•×¨ ××• ×œ×©×›× ×¢.\n\tâ€¢\t×œ× ××§×¨×™× ×¨×©×™××•×ª ×©×¢×•×ª.\n\tâ€¢\t×œ× ××©×§×¨ ×œ×’×‘×™ ×–××™× ×•×ª ××• ×ª×•×¨×™×.\n\tâ€¢\t×œ× ×—×•×–×¨ ×¢×œ ×¢×¦××•.\n\tâ€¢\t×œ× ×××©×¨ ×ª×•×¨ ×× ×œ× ×‘×•×¦×¢ ×‘×¤×•×¢×œ.\n\nâ¸»\n\nğŸ§  ×“×•×’×××•×ª ×§×¦×¨×•×ª (×œ×”××—×©×”)\n\n×œ×§×•×—: ×™×© ××•×›×œ ×›×©×¨ ×‘××§×•×?\n×“× ×™××œ: ×›×Ÿ, ×”×›×œ ×›×©×¨ ×œ××”×“×¨×™×Ÿ â€“ ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.\n\n×œ×§×•×—: ××¤×©×¨ ×œ×”×–××™×Ÿ ×œ×©×¢×” ×©×ª×™×™×?\n×“× ×™××œ: ×‘×¡×“×¨, 14:00. ×¨×’×¢ ×‘×•×“×§ ×× ×¤× ×•×™.\n×“× ×™××œ (×× ×¤× ×•×™): ×¤× ×•×™. ×¢×œ ××™×–×” ×©× ×œ×¨×©×•× ×•××” ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ?\n×œ×§×•×—: ×¢×“×™, 0541234567#\n×“× ×™××œ: ×ª×•×“×”, ×¢×“×™, 0541234567, × ×›×•×Ÿ?\n×œ×§×•×—: × ×›×•×Ÿ.\n×“× ×™××œ: ××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×œ××—×¨ ×‘-14:00.\n\n×œ×§×•×—: 11:30 ×¤× ×•×™?\n×“× ×™××œ: ×× ×—× ×• ×§×•×‘×¢×™× ×¨×§ ×‘×©×¢×•×ª ×¢×’×•×œ×•×ª. ×¢×“×™×£ 11:00 ××• 12:00?\n', prompt=None, handoffs=[], model='gpt-4o-mini', model_settings=ModelSettings(temperature=0.3, top_p=None, frequency_penalty=None, presence_penalty=None, tool_choice=None, parallel_tool_calls=None, truncation=None, max_tokens=200, reasoning=None, verbosity=None, metadata=None, store=None, include_usage=None, response_include=None, top_logprobs=None, extra_query=None, extra_body=None, extra_headers=None, extra_args=None), input_guardrails=[], output_guardrails=[], output_type=None, hooks=None, tool_use_behavior='run_llm_again', reset_tool_choice=True), raw_item=ResponseFunctionToolCall(arguments='{"treatment_type":"×—×“×¨ ×§×¨×™×•×§×™","start_iso":"2025-11-06T13:00:00+02:00","end_iso":"2025-11-06T14:00:00+02:00","customer_phone":"","customer_name":"×¡×™×™×“ ×× ×’","notes":""}', call_id='call_QKWdNBelg4FR45cFwaqw7JKC', name='calendar_create_appointment_wrapped', type='function_call', id='fc_023b8b781b36f74a00690b386fdccc81a3a3074c605f697875', status='completed'), type='tool_call_item'), ToolCallOutputItem(agent=Agent(name='booking_agent_×©×™ ×“×™×¨×•×ª', handoff_description=None, tools=[FunctionTool(name='calendar_find_slots_wrapped', description='Find available appointment slots for a specific date', params_json_schema={'properties': {'date_iso': {'description': 'Date in ISO format (YYYY-MM-DD) like "2025-11-10"', 'title': 'Date Iso', 'type': 'string'}, 'duration_min': {'default': 60, 'description': 'Duration in minutes (default 60)', 'title': 'Duration Min', 'type': 'integer'}}, 'required': ['date_iso', 'duration_min'], 'title': 'calendar_find_slots_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd99038f600>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='calendar_create_appointment_wrapped', description='Create a new appointment in the calendar\n\nCRITICAL: Agent should NEVER ask for phone by voice!\nPhone is automatically captured from call/WhatsApp context.', params_json_schema={'properties': {'treatment_type': {'description': 'Type of treatment (required)', 'title': 'Treatment Type', 'type': 'string'}, 'start_iso': {'description': 'Start time in ISO format (required)', 'title': 'Start Iso', 'type': 'string'}, 'end_iso': {'description': 'End time in ISO format (required)', 'title': 'End Iso', 'type': 'string'}, 'customer_phone': {'default': '', 'description': 'Leave EMPTY - system captures automatically', 'title': 'Customer Phone', 'type': 'string'}, 'customer_name': {'default': '', 'description': 'Customer name (optional)', 'title': 'Customer Name', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['treatment_type', 'start_iso', 'end_iso', 'customer_phone', 'customer_name', 'notes'], 'title': 'calendar_create_appointment_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd992208680>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_upsert_wrapped', description='Create or update customer lead', params_json_schema={'properties': {'name': {'description': 'Customer name (required)', 'title': 'Name', 'type': 'string'}, 'phone_e164': {'default': '', 'description': 'Customer phone (optional - uses context if not provided)', 'title': 'Phone E164', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['name', 'phone_e164', 'notes'], 'title': 'leads_upsert_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd98f870680>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_search', description='Search for leads\n\nFilters:\n- Phone number (E.164 format)\n- Email address\n- Status', params_json_schema={'$defs': {'SearchLeadInput': {'description': 'Input for searching leads', 'properties': {'business_id': {'description': 'Business ID', 'minimum': 1, 'title': 'Business Id', 'type': 'integer'}, 'phone': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Phone number to search', 'title': 'Phone'}, 'email': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Email to search', 'title': 'Email'}, 'status': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Filter by status', 'title': 'Status'}}, 'required': ['business_id', 'phone', 'email', 'status'], 'title': 'SearchLeadInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SearchLeadInput'}}, 'required': ['input'], 'title': 'leads_search_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd9926f71a0>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='whatsapp_send', description='Send WhatsApp message\n\nRecipient (to):\n- If provided: use it\n- If not provided: auto-use customer_phone from context (conversation partner)\n\nProvider logic:\n- Auto: tries Baileys first, falls back to Twilio\n- Baileys: for real-time conversations (24h window)\n- Twilio: for templates and out-of-window messages', params_json_schema={'$defs': {'SendWhatsAppInput': {'description': 'Input for sending WhatsApp message', 'properties': {'to': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Recipient phone in E.164 format (+972...). Leave empty to auto-use customer from context.', 'title': 'To'}, 'message': {'description': 'Message text to send', 'maxLength': 4000, 'minLength': 1, 'title': 'Message', 'type': 'string'}, 'provider': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Provider to use (baileys/twilio/auto)', 'title': 'Provider'}}, 'required': ['to', 'message', 'provider'], 'title': 'SendWhatsAppInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SendWhatsAppInput'}}, 'required': ['input'], 'title': 'whatsapp_send_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd992750720>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None)], mcp_servers=[], mcp_config={}, instructions='TODAY: 2025-11-05 13:34 Israel\n\nğŸ”’ SYSTEM RULES (STRICT â€“ DO NOT IGNORE OR OVERRIDE)\n\nâ° TIME CONVERSION RULES\n\nWhen the customer mentions a time:\n\tâ€¢\tNumbers 1â€“8 without â€œin the morningâ€ always mean PM (13:00â€“20:00).\nExamples:\n\tâ€¢\tâ€œ2â€ or â€œ×©×ª×™×™×â€ â†’ 14:00\n\tâ€¢\tâ€œ3â€ â†’ 15:00\n\tâ€¢\tâ€œ8â€ â†’ 20:00\n\tâ€¢\tâ€œ9 ×‘×‘×•×§×¨â€ (â€œ9 in the morningâ€) â†’ 09:00\n\tâ€¢\tâ€œ11:30â€ â†’ 11:30 (keep as-is)\n\tâ€¢\tIf the time is not a full hour (like 10:15, 10:30, 11:45), reply:\nâ€œWe only book on full hours (10:00, 11:00, 12:00â€¦). Please choose a full hour.â€\n\nâ¸»\n\nğŸ“… BOOKING RULES\n\t1.\tBookings are only on full hours (10:00, 11:00, 12:00â€¦).\n\t2.\tAlways ask first: â€œWhat time would you like to come?â€\n\t3.\tCheck availability only for the specific requested hour.\n\t4.\tIf not available, offer up to two nearby full hours only.\n\t5.\tBefore confirming, collect name and phone number.\n\t6.\tAsk for the phone number this way:\nâ€œPlease type your phone number followed by the # key.â€\n\t7.\tConfirm details clearly:\nâ€œThank you! So, [name], [phone], correct?â€\n\t8.\tConfirm booking only when actually created:\nâ€œGreat, Iâ€™ve booked you for [day] at [hour].â€\nâ¤ Do not say a booking is confirmed unless it has actually been made.\n\t9.\tNo emojis, no exclamation marks, no smileys, no decorative text.\n\t10.\tNo greetings mid-conversation. Never say â€œHi againâ€, â€œHello againâ€, etc.\n\t11.\tSpeak naturally, shortly, and clearly in Hebrew only.\n\t12.\tNever repeat offers to book â€” only respond to the userâ€™s intent.\n\t13.\tBe truthful: Never claim a booking, time, or detail that isnâ€™t real.\nâ€”â€”â€”â€”â€”-\n×©×: ×“× ×™××œ\n×ª×¤×§×™×“: × ×¦×™×’ ××ª×—× ×”×§×¨×™×•×§×™ â€œSingStarâ€\n×©×¤×”: ×¢×‘×¨×™×ª ×‘×œ×‘×“\n××˜×¨×”: ×œ×¢×–×•×¨ ×œ×œ×§×•×—×•×ª ×œ×”×–××™×Ÿ ×—×“×¨ ×§×¨×™×•×§×™ ×‘×¦×•×¨×” ×× ×•×©×™×ª, ××“×•×™×§×ª, ×•×œ×¤×™ ×”×—×•×§×™× ×©× ×§×‘×¢×•.\n××•×¤×™: ×©×™×¨×•×ª×™, ×¨×’×•×¢, ××“×‘×¨ ×›××• ××“× ×××™×ª×™, ×œ× ×¨×•×‘×•×˜×™ ×•×œ× ×©×™×•×•×§×™ ××“×™.\n×œ× ××©×ª××© ×‘××™××•×’×³×™× ××• ×¡×™×× ×™ ×§×¨×™××”.\n\nâ¸»\n\nğŸ§­ ×›×œ×œ×™ ×“×™×‘×•×¨ ×©×œ ×“× ×™××œ\n\tâ€¢\t×¢×•× ×” ×ª××™×“ ×‘×¢×‘×¨×™×ª ×˜×‘×¢×™×ª ×•×‘×¨×•×¨×”.\n\tâ€¢\t×ª×©×•×‘×•×ª ×§×¦×¨×•×ª (××©×¤×˜ ××—×“ ××• ×©× ×™×™× ×œ×›×œ ×”×™×•×ª×¨).\n\tâ€¢\t×œ× ×¤×•×ª×— ×›×œ ×ª×’×•×‘×” ×‘â€×©×œ×•×â€ ××• â€œ×”×™×™â€ â€” ×××©×™×š ××ª ×”×©×™×—×” ×‘××•×¤×Ÿ ×¨×¦×™×£.\n\tâ€¢\t×œ× ×× ×¡×” ×œ×§×‘×•×¢ ×ª×•×¨ ××œ× ×× ×”×œ×§×•×— ×‘×××ª ××‘×§×© ××• ××–×›×™×¨ ×©×¢×”.\n\tâ€¢\t××“×‘×¨ ×‘×˜×•×Ÿ ×—××™×, ×× ×•×©×™ ×•× ×™× ×•×— â€” ×›××• ×¢×•×‘×“ ×‘××§×•× ×××™×ª×™, ×œ× ×ª×¡×¨×™×˜××™.\n\tâ€¢\t×× ×”×œ×§×•×— ××ª×¢× ×™×™×Ÿ â€“ ××¡×‘×™×¨ ×‘×§×¦×¨×” ××” ×”××§×•× ×›×•×œ×œ.\n\tâ€¢\t×× ×”×œ×§×•×— ××‘×§×© ×œ×§×‘×•×¢ â€“ ×¤×•×¢×œ ×œ×¤×™ ×—×•×§×™ ×§×‘×™×¢×ª ×”×ª×•×¨.\n\tâ€¢\t×× ×™×© ×¡×ª×™×¨×” ××• ×—×•×¡×¨ ××™×“×¢ â€“ ××‘×§×© ×”×‘×”×¨×”, ×œ× ×× ×—×©.\n\tâ€¢\t×ª××™×“ ××“×™×™×§ ×‘×–×× ×™× ×œ×¤×™ ×—×•×§×™ ×”×”××¨×”.\n\tâ€¢\t×œ× ××•××¨ ×©× ×§×‘×¢ ×ª×•×¨ ×× ×œ× ×‘×××ª × ×§×‘×¢ ×‘××¢×¨×›×ª.\n\nâ¸»\n\nğŸ  ××™×“×¢ ×›×œ×œ×™ ×©×“× ×™××œ ×ª××™×“ ×™×•×“×¢\n\tâ€¢\t××ª×—× â€œSingStarâ€ ×›×•×œ×œ 6 ×—×“×¨×™× ×¤×¨×˜×™×™×, ××¢×¨×›×ª ×¡××•× ×“ ××§×¦×•×¢×™×ª, ××¡×›×™× ×’×“×•×œ×™×, ××™×§×¨×•×¤×•× ×™× ××œ×—×•×˜×™×™× ×•×©×™×¨×™× ×‘×¢×‘×¨×™×ª ×•×‘×× ×’×œ×™×ª.\n\tâ€¢\t×”××§×•× ××ª××™× ×œ×–×•×’×•×ª, ××©×¤×—×•×ª ××• ×§×‘×•×¦×•×ª ×¢×“ 15 ×× ×©×™×.\n\tâ€¢\t×”××§×•× ×›×©×¨ ×œ××”×“×¨×™×Ÿ â€“ ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.\n\tâ€¢\t×”×ª×¤×¨×™×˜ ×›×•×œ×œ ×¤×™×¦×•×ª, × ×©× ×•×©×™×, ×©×ª×™×™×” ×§×œ×” ×•××œ×›×•×”×•×œ×™×ª, ×”×›×œ ×‘×›×©×¨×•×ª ××œ××”.\n\tâ€¢\t×©×¢×•×ª ×¤×¢×™×œ×•×ª:\n\tâ€¢\t×¨××©×•×Ÿ ×¢×“ ×—××™×©×™: 10:00â€“00:00\n\tâ€¢\t×©×™×©×™: 10:00â€“15:00\n\tâ€¢\t××•×¦××™ ×©×‘×ª: ×›×—×¦×™ ×©×¢×” ××—×¨×™ ×™×¦×™××ª ×©×‘×ª ×¢×“ 01:00.\n\nâ¸»\n\nğŸ’¬ ××™×š ×“× ×™××œ ××’×™×‘ ×œ×¤×™ ×¡×•×’ ×”×©××œ×”\n\n1. ×©××œ×•×ª ×›×œ×œ×™×•×ª (××™×“×¢ / ×¡×§×¨× ×•×ª):\n× ×•×ª×Ÿ ×ª×©×•×‘×” ×¤×©×•×˜×” ×•×‘×¨×•×¨×”, ×‘×œ×™ ×”×¦×¢×•×ª ×œ×§×‘×•×¢.\n×“×•×’××”:\n\tâ€¢\tâ€œ×›×Ÿ, ×™×© ××¦×œ× ×• 6 ×—×“×¨×™× ×¤×¨×˜×™×™× ×¢× ××¢×¨×›×ª ×¡××•× ×“ ××§×¦×•×¢×™×ª ×•××¡×›×™× ×’×“×•×œ×™×.â€\n\tâ€¢\tâ€œ×”×›×œ ×›×©×¨ ×œ××”×“×¨×™×Ÿ, ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.â€\n\tâ€¢\tâ€œ××¤×©×¨ ×œ×”×–××™×Ÿ ×œ×¤×™ ×©×¢×”, ×œ×–×•×’×•×ª ××• ×œ×§×‘×•×¦×•×ª ×¢×“ 15 ×× ×©×™×.â€\n\n2. ×‘×§×©×•×ª ×œ×©×¢×” ××• ×”×–×× ×”:\n×× ×”×œ×§×•×— ××•××¨ ×©×¢×” ××• ××‘×§×© ×œ×”×–××™×Ÿ:\n\tâ€¢\tâ€œ×‘×©××—×”. ×‘××™×–×• ×©×¢×” × ×•×— ×œ×›× ×œ×”×’×™×¢? ×¨×§ ×©×¢×•×ª ×¢×’×•×œ×•×ª.â€\n××—×¨×™ ×§×‘×œ×ª ×©×¢×” â†’ ×”××¨×” ×œ×¤×™ ×”×›×œ×œ×™× â†’ ×‘×“×™×§×” ×¤× ×™××™×ª:\n\tâ€¢\t×× ×¤× ×•×™: â€œ×¤× ×•×™. ×¢×œ ××™×–×” ×©× ×œ×¨×©×•× ×•××” ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ?â€\n\tâ€¢\t×× ×œ× ×¤× ×•×™: â€œ×”×©×¢×” ×ª×¤×•×¡×”. ×¤× ×•×™ ×‘-[×©×¢×” ×§×¨×•×‘×”] ××• ×‘-[×©×¢×” × ×•×¡×¤×ª]. ××” ××ª××™×?â€\n\n3. ××™×¡×•×£ ×¤×¨×˜×™×:\n\tâ€¢\tâ€œ×ª×•×“×”. ××– ××™×š ×œ×¨×©×•× ××ª ×”×©×?â€\n\tâ€¢\tâ€œ× × ×œ×”×§×œ×™×“ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×•×œ×”×§×™×© ×¡×•×œ××™×ª ×‘×¡×™×•×.â€\n\tâ€¢\t××—×¨×™ ×§×‘×œ×ª ×”×¤×¨×˜×™×: â€œ×ª×•×“×”. ××– [×©×], [×˜×œ×¤×•×Ÿ], × ×›×•×Ÿ?â€\n\n4. ××™×©×•×¨ ×”×–×× ×”:\n\tâ€¢\t×¨×§ ×× ×‘×××ª × ×§×‘×¢ ×ª×•×¨ ×‘××¢×¨×›×ª: â€œ××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×œ-[×™×•×] ×‘-[×©×¢×”].â€\n\tâ€¢\t×× ×œ× ×‘×•×¦×¢×” ×§×‘×™×¢×” ×××™×ª×™×ª, ×œ× ×œ×•××¨ ×©× ×§×‘×¢.\n\n5. ×©×¢×•×ª ×œ× ×¢×’×•×œ×•×ª:\n\tâ€¢\tâ€œ×§×•×‘×¢×™× ×¨×§ ×‘×©×¢×•×ª ×¢×’×•×œ×•×ª. ×¨×•×¦×” ×©××‘×“×•×§ ×‘-[×©×¢×” ×§×¨×•×‘×”] ××• ×‘-[×©×¢×” × ×•×¡×¤×ª]?â€\n\nâ¸»\n\nâŒ ××” ×“× ×™××œ ×œ× ×¢×•×©×”\n\tâ€¢\t×œ× ××©×ª××© ×‘××™××•×’×³×™× ××• ×¡×™×× ×™ ×§×¨×™××”.\n\tâ€¢\t×œ× ××•××¨ â€œ×©×œ×•× ×©×•×‘â€, â€œ×”×™×™â€, ××• ×¤×ª×™×—×•×ª ×—×•×–×¨×•×ª.\n\tâ€¢\t×œ× ×× ×¡×” ×œ××›×•×¨ ××• ×œ×©×›× ×¢.\n\tâ€¢\t×œ× ××§×¨×™× ×¨×©×™××•×ª ×©×¢×•×ª.\n\tâ€¢\t×œ× ××©×§×¨ ×œ×’×‘×™ ×–××™× ×•×ª ××• ×ª×•×¨×™×.\n\tâ€¢\t×œ× ×—×•×–×¨ ×¢×œ ×¢×¦××•.\n\tâ€¢\t×œ× ×××©×¨ ×ª×•×¨ ×× ×œ× ×‘×•×¦×¢ ×‘×¤×•×¢×œ.\n\nâ¸»\n\nğŸ§  ×“×•×’×××•×ª ×§×¦×¨×•×ª (×œ×”××—×©×”)\n\n×œ×§×•×—: ×™×© ××•×›×œ ×›×©×¨ ×‘××§×•×?\n×“× ×™××œ: ×›×Ÿ, ×”×›×œ ×›×©×¨ ×œ××”×“×¨×™×Ÿ â€“ ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.\n\n×œ×§×•×—: ××¤×©×¨ ×œ×”×–××™×Ÿ ×œ×©×¢×” ×©×ª×™×™×?\n×“× ×™××œ: ×‘×¡×“×¨, 14:00. ×¨×’×¢ ×‘×•×“×§ ×× ×¤× ×•×™.\n×“× ×™××œ (×× ×¤× ×•×™): ×¤× ×•×™. ×¢×œ ××™×–×” ×©× ×œ×¨×©×•× ×•××” ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ?\n×œ×§×•×—: ×¢×“×™, 0541234567#\n×“× ×™××œ: ×ª×•×“×”, ×¢×“×™, 0541234567, × ×›×•×Ÿ?\n×œ×§×•×—: × ×›×•×Ÿ.\n×“× ×™××œ: ××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×œ××—×¨ ×‘-14:00.\n\n×œ×§×•×—: 11:30 ×¤× ×•×™?\n×“× ×™××œ: ×× ×—× ×• ×§×•×‘×¢×™× ×¨×§ ×‘×©×¢×•×ª ×¢×’×•×œ×•×ª. ×¢×“×™×£ 11:00 ××• 12:00?\n', prompt=None, handoffs=[], model='gpt-4o-mini', model_settings=ModelSettings(temperature=0.3, top_p=None, frequency_penalty=None, presence_penalty=None, tool_choice=None, parallel_tool_calls=None, truncation=None, max_tokens=200, reasoning=None, verbosity=None, metadata=None, store=None, include_usage=None, response_include=None, top_logprobs=None, extra_query=None, extra_body=None, extra_headers=None, extra_args=None), input_guardrails=[], output_guardrails=[], output_type=None, hooks=None, tool_use_behavior='run_llm_again', reset_tool_choice=True), raw_item={'call_id': 'call_QKWdNBelg4FR45cFwaqw7JKC', 'output': "{'ok': True, 'appointment_id': 52, 'status': 'confirmed', 'confirmation_message': '××¢×•×œ×”! ×§×‘×¢×ª×™ ×œ×š ×—×“×¨ ×§×¨×™×•×§×™ ×œ×™×•× ×—××™×©×™ 06/11 ×‘×©×¢×” 13:00. × ×ª×¨××”! ğŸ˜Š'}", 'type': 'function_call_output'}, output={'ok': True, 'appointment_id': 52, 'status': 'confirmed', 'confirmation_message': '××¢×•×œ×”! ×§×‘×¢×ª×™ ×œ×š ×—×“×¨ ×§×¨×™×•×§×™ ×œ×™×•× ×—××™×©×™ 06/11 ×‘×©×¢×” 13:00. × ×ª×¨××”! ğŸ˜Š'}, type='tool_call_output_item'), MessageOutputItem(agent=Agent(name='booking_agent_×©×™ ×“×™×¨×•×ª', handoff_description=None, tools=[FunctionTool(name='calendar_find_slots_wrapped', description='Find available appointment slots for a specific date', params_json_schema={'properties': {'date_iso': {'description': 'Date in ISO format (YYYY-MM-DD) like "2025-11-10"', 'title': 'Date Iso', 'type': 'string'}, 'duration_min': {'default': 60, 'description': 'Duration in minutes (default 60)', 'title': 'Duration Min', 'type': 'integer'}}, 'required': ['date_iso', 'duration_min'], 'title': 'calendar_find_slots_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd99038f600>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='calendar_create_appointment_wrapped', description='Create a new appointment in the calendar\n\nCRITICAL: Agent should NEVER ask for phone by voice!\nPhone is automatically captured from call/WhatsApp context.', params_json_schema={'properties': {'treatment_type': {'description': 'Type of treatment (required)', 'title': 'Treatment Type', 'type': 'string'}, 'start_iso': {'description': 'Start time in ISO format (required)', 'title': 'Start Iso', 'type': 'string'}, 'end_iso': {'description': 'End time in ISO format (required)', 'title': 'End Iso', 'type': 'string'}, 'customer_phone': {'default': '', 'description': 'Leave EMPTY - system captures automatically', 'title': 'Customer Phone', 'type': 'string'}, 'customer_name': {'default': '', 'description': 'Customer name (optional)', 'title': 'Customer Name', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['treatment_type', 'start_iso', 'end_iso', 'customer_phone', 'customer_name', 'notes'], 'title': 'calendar_create_appointment_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd992208680>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_upsert_wrapped', description='Create or update customer lead', params_json_schema={'properties': {'name': {'description': 'Customer name (required)', 'title': 'Name', 'type': 'string'}, 'phone_e164': {'default': '', 'description': 'Customer phone (optional - uses context if not provided)', 'title': 'Phone E164', 'type': 'string'}, 'notes': {'description': 'Additional notes (optional)', 'title': 'Notes', 'type': 'string'}}, 'required': ['name', 'phone_e164', 'notes'], 'title': 'leads_upsert_wrapped_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd98f870680>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='leads_search', description='Search for leads\n\nFilters:\n- Phone number (E.164 format)\n- Email address\n- Status', params_json_schema={'$defs': {'SearchLeadInput': {'description': 'Input for searching leads', 'properties': {'business_id': {'description': 'Business ID', 'minimum': 1, 'title': 'Business Id', 'type': 'integer'}, 'phone': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Phone number to search', 'title': 'Phone'}, 'email': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Email to search', 'title': 'Email'}, 'status': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Filter by status', 'title': 'Status'}}, 'required': ['business_id', 'phone', 'email', 'status'], 'title': 'SearchLeadInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SearchLeadInput'}}, 'required': ['input'], 'title': 'leads_search_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd9926f71a0>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_guardrails=None), FunctionTool(name='whatsapp_send', description='Send WhatsApp message\n\nRecipient (to):\n- If provided: use it\n- If not provided: auto-use customer_phone from context (conversation partner)\n\nProvider logic:\n- Auto: tries Baileys first, falls back to Twilio\n- Baileys: for real-time conversations (24h window)\n- Twilio: for templates and out-of-window messages', params_json_schema={'$defs': {'SendWhatsAppInput': {'description': 'Input for sending WhatsApp message', 'properties': {'to': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Recipient phone in E.164 format (+972...). Leave empty to auto-use customer from context.', 'title': 'To'}, 'message': {'description': 'Message text to send', 'maxLength': 4000, 'minLength': 1, 'title': 'Message', 'type': 'string'}, 'provider': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'description': 'Provider to use (baileys/twilio/auto)', 'title': 'Provider'}}, 'required': ['to', 'message', 'provider'], 'title': 'SendWhatsAppInput', 'type': 'object', 'additionalProperties': False}}, 'properties': {'input': {'$ref': '#/$defs/SendWhatsAppInput'}}, 'required': ['input'], 'title': 'whatsapp_send_args', 'type': 'object', 'additionalProperties': False}, on_invoke_tool=<function function_tool.<locals>._create_function_tool.<locals>._on_invoke_tool at 0x7fd992750720>, strict_json_schema=True, is_enabled=True, tool_input_guardrails=None, tool_output_
2025-11-05 13:43:47.96
89440517
User
guardrails=None)], mcp_servers=[], mcp_config={}, instructions='TODAY: 2025-11-05 13:34 Israel\n\nğŸ”’ SYSTEM RULES (STRICT â€“ DO NOT IGNORE OR OVERRIDE)\n\nâ° TIME CONVERSION RULES\n\nWhen the customer mentions a time:\n\tâ€¢\tNumbers 1â€“8 without â€œin the morningâ€ always mean PM (13:00â€“20:00).\nExamples:\n\tâ€¢\tâ€œ2â€ or â€œ×©×ª×™×™×â€ â†’ 14:00\n\tâ€¢\tâ€œ3â€ â†’ 15:00\n\tâ€¢\tâ€œ8â€ â†’ 20:00\n\tâ€¢\tâ€œ9 ×‘×‘×•×§×¨â€ (â€œ9 in the morningâ€) â†’ 09:00\n\tâ€¢\tâ€œ11:30â€ â†’ 11:30 (keep as-is)\n\tâ€¢\tIf the time is not a full hour (like 10:15, 10:30, 11:45), reply:\nâ€œWe only book on full hours (10:00, 11:00, 12:00â€¦). Please choose a full hour.â€\n\nâ¸»\n\nğŸ“… BOOKING RULES\n\t1.\tBookings are only on full hours (10:00, 11:00, 12:00â€¦).\n\t2.\tAlways ask first: â€œWhat time would you like to come?â€\n\t3.\tCheck availability only for the specific requested hour.\n\t4.\tIf not available, offer up to two nearby full hours only.\n\t5.\tBefore confirming, collect name and phone number.\n\t6.\tAsk for the phone number this way:\nâ€œPlease type your phone number followed by the # key.â€\n\t7.\tConfirm details clearly:\nâ€œThank you! So, [name], [phone], correct?â€\n\t8.\tConfirm booking only when actually created:\nâ€œGreat, Iâ€™ve booked you for [day] at [hour].â€\nâ¤ Do not say a booking is confirmed unless it has actually been made.\n\t9.\tNo emojis, no exclamation marks, no smileys, no decorative text.\n\t10.\tNo greetings mid-conversation. Never say â€œHi againâ€, â€œHello againâ€, etc.\n\t11.\tSpeak naturally, shortly, and clearly in Hebrew only.\n\t12.\tNever repeat offers to book â€” only respond to the userâ€™s intent.\n\t13.\tBe truthful: Never claim a booking, time, or detail that isnâ€™t real.\nâ€”â€”â€”â€”â€”-\n×©×: ×“× ×™××œ\n×ª×¤×§×™×“: × ×¦×™×’ ××ª×—× ×”×§×¨×™×•×§×™ â€œSingStarâ€\n×©×¤×”: ×¢×‘×¨×™×ª ×‘×œ×‘×“\n××˜×¨×”: ×œ×¢×–×•×¨ ×œ×œ×§×•×—×•×ª ×œ×”×–××™×Ÿ ×—×“×¨ ×§×¨×™×•×§×™ ×‘×¦×•×¨×” ×× ×•×©×™×ª, ××“×•×™×§×ª, ×•×œ×¤×™ ×”×—×•×§×™× ×©× ×§×‘×¢×•.\n××•×¤×™: ×©×™×¨×•×ª×™, ×¨×’×•×¢, ××“×‘×¨ ×›××• ××“× ×××™×ª×™, ×œ× ×¨×•×‘×•×˜×™ ×•×œ× ×©×™×•×•×§×™ ××“×™.\n×œ× ××©×ª××© ×‘××™××•×’×³×™× ××• ×¡×™×× ×™ ×§×¨×™××”.\n\nâ¸»\n\nğŸ§­ ×›×œ×œ×™ ×“×™×‘×•×¨ ×©×œ ×“× ×™××œ\n\tâ€¢\t×¢×•× ×” ×ª××™×“ ×‘×¢×‘×¨×™×ª ×˜×‘×¢×™×ª ×•×‘×¨×•×¨×”.\n\tâ€¢\t×ª×©×•×‘×•×ª ×§×¦×¨×•×ª (××©×¤×˜ ××—×“ ××• ×©× ×™×™× ×œ×›×œ ×”×™×•×ª×¨).\n\tâ€¢\t×œ× ×¤×•×ª×— ×›×œ ×ª×’×•×‘×” ×‘â€×©×œ×•×â€ ××• â€œ×”×™×™â€ â€” ×××©×™×š ××ª ×”×©×™×—×” ×‘××•×¤×Ÿ ×¨×¦×™×£.\n\tâ€¢\t×œ× ×× ×¡×” ×œ×§×‘×•×¢ ×ª×•×¨ ××œ× ×× ×”×œ×§×•×— ×‘×××ª ××‘×§×© ××• ××–×›×™×¨ ×©×¢×”.\n\tâ€¢\t××“×‘×¨ ×‘×˜×•×Ÿ ×—××™×, ×× ×•×©×™ ×•× ×™× ×•×— â€” ×›××• ×¢×•×‘×“ ×‘××§×•× ×××™×ª×™, ×œ× ×ª×¡×¨×™×˜××™.\n\tâ€¢\t×× ×”×œ×§×•×— ××ª×¢× ×™×™×Ÿ â€“ ××¡×‘×™×¨ ×‘×§×¦×¨×” ××” ×”××§×•× ×›×•×œ×œ.\n\tâ€¢\t×× ×”×œ×§×•×— ××‘×§×© ×œ×§×‘×•×¢ â€“ ×¤×•×¢×œ ×œ×¤×™ ×—×•×§×™ ×§×‘×™×¢×ª ×”×ª×•×¨.\n\tâ€¢\t×× ×™×© ×¡×ª×™×¨×” ××• ×—×•×¡×¨ ××™×“×¢ â€“ ××‘×§×© ×”×‘×”×¨×”, ×œ× ×× ×—×©.\n\tâ€¢\t×ª××™×“ ××“×™×™×§ ×‘×–×× ×™× ×œ×¤×™ ×—×•×§×™ ×”×”××¨×”.\n\tâ€¢\t×œ× ××•××¨ ×©× ×§×‘×¢ ×ª×•×¨ ×× ×œ× ×‘×××ª × ×§×‘×¢ ×‘××¢×¨×›×ª.\n\nâ¸»\n\nğŸ  ××™×“×¢ ×›×œ×œ×™ ×©×“× ×™××œ ×ª××™×“ ×™×•×“×¢\n\tâ€¢\t××ª×—× â€œSingStarâ€ ×›×•×œ×œ 6 ×—×“×¨×™× ×¤×¨×˜×™×™×, ××¢×¨×›×ª ×¡××•× ×“ ××§×¦×•×¢×™×ª, ××¡×›×™× ×’×“×•×œ×™×, ××™×§×¨×•×¤×•× ×™× ××œ×—×•×˜×™×™× ×•×©×™×¨×™× ×‘×¢×‘×¨×™×ª ×•×‘×× ×’×œ×™×ª.\n\tâ€¢\t×”××§×•× ××ª××™× ×œ×–×•×’×•×ª, ××©×¤×—×•×ª ××• ×§×‘×•×¦×•×ª ×¢×“ 15 ×× ×©×™×.\n\tâ€¢\t×”××§×•× ×›×©×¨ ×œ××”×“×¨×™×Ÿ â€“ ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.\n\tâ€¢\t×”×ª×¤×¨×™×˜ ×›×•×œ×œ ×¤×™×¦×•×ª, × ×©× ×•×©×™×, ×©×ª×™×™×” ×§×œ×” ×•××œ×›×•×”×•×œ×™×ª, ×”×›×œ ×‘×›×©×¨×•×ª ××œ××”.\n\tâ€¢\t×©×¢×•×ª ×¤×¢×™×œ×•×ª:\n\tâ€¢\t×¨××©×•×Ÿ ×¢×“ ×—××™×©×™: 10:00â€“00:00\n\tâ€¢\t×©×™×©×™: 10:00â€“15:00\n\tâ€¢\t××•×¦××™ ×©×‘×ª: ×›×—×¦×™ ×©×¢×” ××—×¨×™ ×™×¦×™××ª ×©×‘×ª ×¢×“ 01:00.\n\nâ¸»\n\nğŸ’¬ ××™×š ×“× ×™××œ ××’×™×‘ ×œ×¤×™ ×¡×•×’ ×”×©××œ×”\n\n1. ×©××œ×•×ª ×›×œ×œ×™×•×ª (××™×“×¢ / ×¡×§×¨× ×•×ª):\n× ×•×ª×Ÿ ×ª×©×•×‘×” ×¤×©×•×˜×” ×•×‘×¨×•×¨×”, ×‘×œ×™ ×”×¦×¢×•×ª ×œ×§×‘×•×¢.\n×“×•×’××”:\n\tâ€¢\tâ€œ×›×Ÿ, ×™×© ××¦×œ× ×• 6 ×—×“×¨×™× ×¤×¨×˜×™×™× ×¢× ××¢×¨×›×ª ×¡××•× ×“ ××§×¦×•×¢×™×ª ×•××¡×›×™× ×’×“×•×œ×™×.â€\n\tâ€¢\tâ€œ×”×›×œ ×›×©×¨ ×œ××”×“×¨×™×Ÿ, ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.â€\n\tâ€¢\tâ€œ××¤×©×¨ ×œ×”×–××™×Ÿ ×œ×¤×™ ×©×¢×”, ×œ×–×•×’×•×ª ××• ×œ×§×‘×•×¦×•×ª ×¢×“ 15 ×× ×©×™×.â€\n\n2. ×‘×§×©×•×ª ×œ×©×¢×” ××• ×”×–×× ×”:\n×× ×”×œ×§×•×— ××•××¨ ×©×¢×” ××• ××‘×§×© ×œ×”×–××™×Ÿ:\n\tâ€¢\tâ€œ×‘×©××—×”. ×‘××™×–×• ×©×¢×” × ×•×— ×œ×›× ×œ×”×’×™×¢? ×¨×§ ×©×¢×•×ª ×¢×’×•×œ×•×ª.â€\n××—×¨×™ ×§×‘×œ×ª ×©×¢×” â†’ ×”××¨×” ×œ×¤×™ ×”×›×œ×œ×™× â†’ ×‘×“×™×§×” ×¤× ×™××™×ª:\n\tâ€¢\t×× ×¤× ×•×™: â€œ×¤× ×•×™. ×¢×œ ××™×–×” ×©× ×œ×¨×©×•× ×•××” ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ?â€\n\tâ€¢\t×× ×œ× ×¤× ×•×™: â€œ×”×©×¢×” ×ª×¤×•×¡×”. ×¤× ×•×™ ×‘-[×©×¢×” ×§×¨×•×‘×”] ××• ×‘-[×©×¢×” × ×•×¡×¤×ª]. ××” ××ª××™×?â€\n\n3. ××™×¡×•×£ ×¤×¨×˜×™×:\n\tâ€¢\tâ€œ×ª×•×“×”. ××– ××™×š ×œ×¨×©×•× ××ª ×”×©×?â€\n\tâ€¢\tâ€œ× × ×œ×”×§×œ×™×“ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×•×œ×”×§×™×© ×¡×•×œ××™×ª ×‘×¡×™×•×.â€\n\tâ€¢\t××—×¨×™ ×§×‘×œ×ª ×”×¤×¨×˜×™×: â€œ×ª×•×“×”. ××– [×©×], [×˜×œ×¤×•×Ÿ], × ×›×•×Ÿ?â€\n\n4. ××™×©×•×¨ ×”×–×× ×”:\n\tâ€¢\t×¨×§ ×× ×‘×××ª × ×§×‘×¢ ×ª×•×¨ ×‘××¢×¨×›×ª: â€œ××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×œ-[×™×•×] ×‘-[×©×¢×”].â€\n\tâ€¢\t×× ×œ× ×‘×•×¦×¢×” ×§×‘×™×¢×” ×××™×ª×™×ª, ×œ× ×œ×•××¨ ×©× ×§×‘×¢.\n\n5. ×©×¢×•×ª ×œ× ×¢×’×•×œ×•×ª:\n\tâ€¢\tâ€œ×§×•×‘×¢×™× ×¨×§ ×‘×©×¢×•×ª ×¢×’×•×œ×•×ª. ×¨×•×¦×” ×©××‘×“×•×§ ×‘-[×©×¢×” ×§×¨×•×‘×”] ××• ×‘-[×©×¢×” × ×•×¡×¤×ª]?â€\n\nâ¸»\n\nâŒ ××” ×“× ×™××œ ×œ× ×¢×•×©×”\n\tâ€¢\t×œ× ××©×ª××© ×‘××™××•×’×³×™× ××• ×¡×™×× ×™ ×§×¨×™××”.\n\tâ€¢\t×œ× ××•××¨ â€œ×©×œ×•× ×©×•×‘â€, â€œ×”×™×™â€, ××• ×¤×ª×™×—×•×ª ×—×•×–×¨×•×ª.\n\tâ€¢\t×œ× ×× ×¡×” ×œ××›×•×¨ ××• ×œ×©×›× ×¢.\n\tâ€¢\t×œ× ××§×¨×™× ×¨×©×™××•×ª ×©×¢×•×ª.\n\tâ€¢\t×œ× ××©×§×¨ ×œ×’×‘×™ ×–××™× ×•×ª ××• ×ª×•×¨×™×.\n\tâ€¢\t×œ× ×—×•×–×¨ ×¢×œ ×¢×¦××•.\n\tâ€¢\t×œ× ×××©×¨ ×ª×•×¨ ×× ×œ× ×‘×•×¦×¢ ×‘×¤×•×¢×œ.\n\nâ¸»\n\nğŸ§  ×“×•×’×××•×ª ×§×¦×¨×•×ª (×œ×”××—×©×”)\n\n×œ×§×•×—: ×™×© ××•×›×œ ×›×©×¨ ×‘××§×•×?\n×“× ×™××œ: ×›×Ÿ, ×”×›×œ ×›×©×¨ ×œ××”×“×¨×™×Ÿ â€“ ×’× ×”××•×›×œ ×•×’× ×”×©×ª×™×™×”.\n\n×œ×§×•×—: ××¤×©×¨ ×œ×”×–××™×Ÿ ×œ×©×¢×” ×©×ª×™×™×?\n×“× ×™××œ: ×‘×¡×“×¨, 14:00. ×¨×’×¢ ×‘×•×“×§ ×× ×¤× ×•×™.\n×“× ×™××œ (×× ×¤× ×•×™): ×¤× ×•×™. ×¢×œ ××™×–×” ×©× ×œ×¨×©×•× ×•××” ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ?\n×œ×§×•×—: ×¢×“×™, 0541234567#\n×“× ×™××œ: ×ª×•×“×”, ×¢×“×™, 0541234567, × ×›×•×Ÿ?\n×œ×§×•×—: × ×›×•×Ÿ.\n×“× ×™××œ: ××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×œ××—×¨ ×‘-14:00.\n\n×œ×§×•×—: 11:30 ×¤× ×•×™?\n×“× ×™××œ: ×× ×—× ×• ×§×•×‘×¢×™× ×¨×§ ×‘×©×¢×•×ª ×¢×’×•×œ×•×ª. ×¢×“×™×£ 11:00 ××• 12:00?\n', prompt=None, handoffs=[], model='gpt-4o-mini', model_settings=ModelSettings(temperature=0.3, top_p=None, frequency_penalty=None, presence_penalty=None, tool_choice=None, parallel_tool_calls=None, truncation=None, max_tokens=200, reasoning=None, verbosity=None, metadata=None, store=None, include_usage=None, response_include=None, top_logprobs=None, extra_query=None, extra_body=None, extra_headers=None, extra_args=None), input_guardrails=[], output_guardrails=[], output_type=None, hooks=None, tool_use_behavior='run_llm_again', reset_tool_choice=True), raw_item=ResponseOutputMessage(id='msg_023b8b781b36f74a00690b38730ff481a3977e0edd07ba2b63', content=[ResponseOutputText(annotations=[], text='××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×—×“×¨ ×§×¨×™×•×§×™ ×œ×™×•× ×—××™×©×™ 06/11 ×‘×©×¢×” 13:00. × ×ª×¨××”.', type='output_text', logprobs=[])], role='assistant', status='completed', type='message'), type='message_output_item')]
2025-11-05 13:43:47.96
89440517
User
ğŸ” new_items length: 3
2025-11-05 13:43:47.96
89440517
User
ğŸ“Š Agent returned 3 items
2025-11-05 13:43:47.96
89440517
User
- Item #0: ToolCallItem
2025-11-05 13:43:47.96
89440517
User
ğŸ”§ Tool call #1: unknown
2025-11-05 13:43:47.96
89440517
User
ğŸ“‹ Item attributes: ['__abstractmethods__', '__annotations__', '__class__', '__class_getitem__', '__dataclass_fields__', '__dataclass_params__', '__delattr__', '__dict__', '__dir__', '__doc__']...
2025-11-05 13:43:47.96
89440517
User
- Item #1: ToolCallOutputItem
2025-11-05 13:43:47.96
89440517
User
ğŸ“¤ Tool output: {'ok': True, 'appointment_id': 52, 'status': 'confirmed', 'confirmation_message': '××¢×•×œ×”! ×§×‘×¢×ª×™ ×œ×š ×—×“×¨ ×§×¨×™×•×§×™ ×œ×™×•× ×—××™×©×™ 06/11 ×‘×©×¢×” 13:00. × ×ª×¨××”! ğŸ˜Š'}...
2025-11-05 13:43:47.96
89440517
User
- Item #2: MessageOutputItem
2025-11-05 13:43:47.96
89440517
User
âœ… Agent executed 1 tool actions
2025-11-05 13:43:47.96
89440517
User
ğŸš¨ BLOCKED HALLUCINATED BOOKING!
2025-11-05 13:43:47.96
89440517
User
Agent claimed: '××¢×•×œ×”. ×§×‘×¢×ª×™ ×œ×š ×—×“×¨ ×§×¨×™×•×§×™ ×œ×™×•× ×—××™×©×™ 06/11 ×‘×©×¢×” 13:00. × ×ª×¨××”....'
2025-11-05 13:43:47.96
89440517
User
But NO calendar_create_appointment was called!
2025-11-05 13:43:47.96
89440517
User
âœ… Replaced with: '×× ×™ ×¢×“×™×™×Ÿ ×¦×¨×™×š ×œ×‘×“×•×§ ×–××™× ×•×ª. ××™×–×” ×™×•× ×•×©×¢×” ×”×™×™×ª ×¨×•×¦×”?'
2025-11-05 13:43:48.03
89440517
User
ğŸ¤– AGENT_RESPONSE: Generated 53 chars in 5.324s (business 1)
2025-11-05 13:43:48.03
89440517
User
ğŸ“Š AI_LATENCY: 5.324s (target: <1.5s)
2025-11-05 13:43:48.03
89440517
User
ğŸ¤– BOT: ×× ×™ ×¢×“×™×™×Ÿ ×¦×¨×™×š ×œ×‘×“×•×§ ×–××™× ×•×ª. ××™×–×” ×™×•× ×•×©×¢×” ×”×™×™×ª ×¨×•×¦×”?
2025-11-05 13:43:48.03
89440517
User
ğŸ“Š AI_PROCESSING: 5.324s
2025-11-05 13:43:48.03
89440517
User
âš ï¸ Missing phone_n