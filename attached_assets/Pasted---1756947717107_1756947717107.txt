סבבה—הנה הנחיה אחת־ל־אחד שתגרום לשיחות לעבוד “כמו בן-אדם”: מה לתקן, מה להגדיר, ומה לבדוק. זה מותאם ספציפית לקוד האחרון שבדקתי (WSGI, TwiML, media_ws_ai, heartbeat, אימות חתימות, וכו’).

0) לפני שמתחילים – עקרונות עבודה
	•	אין שינויי קוד גדולים: רוב השיפור מגיע מכיוונון, סדר פעולות נכון, וסודות/ENV.
	•	ב־Deployments בלבד: כל ה-ENV (Secrets) נכנסים למסך ה-Deployment ולא רק ל-Workspace.
	•	מדדים בלוג: לפני דיפלוי, ודא שיש לוג Turn Latency, Barge-in halt, Heartbeat, Mark ACK.

⸻

1) יציבות ולטנסי (הכי חשוב קודם)

1.1 Barge-in (קטיעה טבעית)
	•	קבע ב-Secrets (או ב-Deployments → Environment Variables):
	•	BARGE_IN = true
	•	BARGE_IN_VOICE_FRAMES = 10  (≈200ms קול רציף)
	•	“חלון חסד” בתחילת TTS: 0.18–0.25 שנ׳ (לא יותר). מונע עצירה מנשימות, כן עוצר כשקוטעים באמת.
	•	אימות: כשהבוט מדבר—תגיד “רגע”—הדיבור צריך להיעצר ≤ ~200ms ולחזור להאזנה.

1.2 תיקון סדר פעולות ב-interrupt
	•	בקיטוע, כרגע מכבים speaking לפני שמבצעים עצירה, ואז פונקציית ה-interrupt מדלגת (early-return) ולא שולחת clear/ניקוי תורים.
	•	הנחיה: קודם להפעיל פעולת interrupt (שתשלח clear, תנקה תורי TTS/אודיו, ותעדכן מצב), ורק אחרי זה להפוך speaking=False.
(אם יש לך early-return בתוך interrupt – להסיר אותו. המטרה: תמיד, בכל קריאה ל-interrupt, מתבצע clear.)

1.3 End-of-Utterance (סוף משפט) יציב
	•	הגדר ב-Secrets:
	•	MIN_UTT_SEC = 1.0  (תופס “כן/לא” אבל לא חותך נשימות)
	•	MAX_UTT_SEC = 4.5  (חותך מונולוגים; שומר קצב)
	•	REPLY_REFRACTORY_MS = 1000  (“קירור” אחרי תשובה—מונע פינג-פונג)
	•	VAD_HANGOVER_MS = 200       (“זנב” כדי לא לחתוך הברה אחרונה)
	•	אימות: אמור “כן/לא” קצר—נקלט ומקבל תשובה מהירה; דבר מעל 5 שנ׳—המערכת חותכת ומחזירה תשובה.

1.4 VAD (רגישות דיבור) – לא עדין מדי, לא אגרסיבי
	•	כללי: בסיס RMS סביב 35–60; כיול רעש 30 פריימים בתחילת שיחה; סף דינמי מתון (לא להכפיל רעש ב-4–6).
	•	אימות: כשהקו שקט—לא “שומעת” רוח רפאים; כשאתה מדבר חלש—כן קולטת ומתקדמת.

1.5 Heartbeat / Mark ACK
	•	השאר Heartbeat כל ~15–20 שנ׳ (יש בקוד).
	•	מעבר ל-LISTENING רק אחרי Mark-ACK של סוף ה-TTS (יש אצלך סימון—ודא שהמסלול שמקבל ACK תמיד נקרא).
	•	אימות: שיחה >10 דק’, רואה בלוג 💓 WS_KEEPALIVE אחת לכ-~18 שנ׳ ואין ניתוק WS.

⸻

2) קול ותמלול (איכות “בן-אדם”)

2.1 TTS לטלפון 8k
	•	ב-Secrets:
	•	(אופציונלי) TTS_SPEAKING_RATE = 0.95
	•	כלל: הוסף ~200ms שקט בסוף כל תשובה (בקוד כבר יש mark—וודא שלא חוזרים להאזנה לפני ה-ACK).
	•	אימות: לא נשמע “דחוס/עצבני”; אין חיתוך מילים בסוף משפט.

2.2 STT מהיר
	•	לטווח קצר: נשארים על recognize()—אבל בגלל הכיוונון החדש (MIN_UTT/REFRACTORY) תקבל יציבות.
	•	לטווח בינוני: מעבר ל-Google Streaming (partials, LINEAR16/8k, useEnhanced=true).
	•	דגשים: סטרים אחד לכל שיחה, partials מופעלים, ומחזורי EOU מסונכרנים עם החזרה להאזנה.
	•	Speech Contexts: שמות שכונות/רחובות/מותג (“שי דירות ומשרדים”, “Agent Locator”), מספרים, אזורי ביקוש—לשפר דיוק.
	•	אימות: רואים partials ב-log (כשנפעיל סטרימינג), תשובות יוצאות מהר יותר אחרי EOU.

⸻

3) פרומפט/התנהגות (זו הקפיצה באיכות)
	•	תשובה ≤ 15–20 מילים + שאלה אחת בלבד בסוף.
	•	לא הבנתי? במקום להמציא, להגיד: “לא שמעתי טוב, אפשר לחזור על…?”
	•	תיאום פגישה: אחרי שאספת אזור/סוג/תקציב/זמן—להציע 2–3 חלונות ספציפיים, ואז לאשר במילים קצרות.
	•	לא לשאול שתי שאלות ברצף; כשנקטעים—עצור מיד (הודות ל-Barge-in) והמשך משם.
	•	אימות: שיחה אמיתית מרגישה “שאל-ענה”; אין נאומים; קצב טוב; יש סיכום ברור לקראת פגישה.

⸻

4) דיפלוי/בריאות (כדי שלא “יפול” אחרי 5 דק’)
	•	Start command: Gunicorn+Eventlet (מה שאתה כבר עושה).
	•	Health check: להשתמש ב-/version בדיפלוי (לא /healthz).
	•	Autoscale: מינימום מכונה אחת; ≥1GB RAM.
	•	Secrets בפרודקשן: ודא שכל ה-ENV למעלה יושבים גם ב-Deployments → Environment Variables (לא רק ב-Secrets של ה-Workspace).
	•	Google credentials: ה-JSON ב-GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON חייב להיטען בפועל ל-Speech/TTS (אם הלקוח נוצרת בלי credentials—לתקן טעינה מה-ENV).
	•	Webhooks: stream_status/stream_ended/call_status מחזירים 204 תוך <100ms (כבר אצלך).
	•	TwiML Preview: מחזיר <Connect><Stream …> עם wss://…/ws/twilio-media.

⸻

5) בדיקות קבלה (Checklist קצר אחרי הדיפלוי)
	1.	Barge-in: תן ללאה להתחיל—קוטע במילה “רגע” → עוצרת ≤200ms וחוזרת להאזנה.
	2.	כן/לא: “כן…” → נתפס כמשפט קצר ולא נחתך מדי; מקבלים תשובה קצרה עם שאלה אחת.
	3.	מונולוג: דבר ברצף 6–7 שנ׳ → המערכת חותכת סביב 4.5–5.0 שנ׳ ומחזירה תשובה (אחרי REFRACTORY).
	4.	Turn Latency: מה-EOU עד תחילת TTS: <~1.2 שנ׳ (ב־log).
	5.	שיחה ארוכה: 10–15 דק’ → אין ניתוק WS; רואים Heartbeat כל ~18 שנ׳.
	6.	דיוק עברית: שמות רחובות/אזורים נתפסים (Speech Contexts); כשלא בטוחים—מבקשים חזרה, לא ממציאים.

⸻

6) סדר עבודה מומלץ (בלי “להחליף חצי מערכת”)
	1.	ENV (Secrets/Deployments) לפי הסעיפים למעלה + דיפלוי.
	2.	תיקון interrupt (סדר פעולות) + אימות קטיעה.
	3.	כיוונון VAD (כיול 30 פריימים; סף מתון).
	4.	פרומפט (קצר, שאלה אחת, הבהרות, 2–3 חלונות פגישה).
	5.	בדיקות קבלה.
	6.	שלב שני: Google Streaming STT (כשמתפנים), כדי להוריד עוד קצת לטנסי.

⸻

הגדרת “מושלם” (Definition of Done)
	•	עצירת TTS בקטיעה ≤ 200ms, חזרה להאזנה חלקה.
	•	Turn latency (EOU→TTS) <~1.2s בעקביות.
	•	10–15 דק’ שיחה בלי ניתוק WS (Heartbeat קבוע).
	•	דיוק תמלול גבוה; כשאין ביטחון—בקשת חזרה במקום המצאה.
	•	תשובות קצרות, שאלה אחת, והצעת פגישה עם 2–3 חלונות; אחוז השלמת סלוטים גבוה.

אם תעבוד לפי זה אחד-לא-חד—תקבל שיחה זורמת כחלק, נשמעת אנושית, ויציבה לאורך זמן.