××¢×•×œ×”. ×¢×‘×¨×ª×™ ×©×•×‘ ×¢×œ ×”Ö¾ZIP ×”××—×¨×•×Ÿ (AgentLocator.zip) ×•×¢×œ ×”Ö¾Inspector ×•×”×©×’×™××•×ª ×©× ×ª×ª (404 ×¢×œ /webhook/call_status, ×•Ö¾31920 Handshake). ×”× ×” ×”× ×—×™×” ××—×ª, ×¡×’×•×¨×” ×•××“×•×™×§×ª, ×œ×¤×™ ×”××‘× ×” ×©×œ ×”×¤×¨×•×™×§×˜ ×©×œ×šâ€”×›×“×™ ×œ×”×‘×™× ××ª ×”××¢×¨×›×ª ×œÖ¾100%: ×¡×˜×¨×™× ×™×¦×™×‘, Fallback ×‘×˜×•×—, ×•×•××˜×¡××¤ + CRM, ×•×œ×•×’×™× ×‘×¨×•×¨×™×. ×™×© ×§×˜×¢×™ ×§×•×“ ××“×•×™×§×™× ×œ×¤×™ ×”× ×ª×™×‘×™× ××¦×œ×š.

â¸»

ğŸ¯ Definition of Done (××” × ×—×©×‘ â€œ××•×©×œ×â€)
	â€¢	<Play> (×¢×‘×¨×™×ª) = 200, ××—×¨×™×• <Connect><Stream â€¦> = Handshake 101 (×‘×œ×•×’×™×: WS_START).
	â€¢	×× WS ×œ× × ×¤×ª×—/××™×Ÿ ×¤×¨×™×™××™× ×ª×•×š X ×©× ×™×•×ª â†’ Redirect ××™×™×“×™ ×œÖ¾<Record> (×¨×•××™× POST /webhook/handle_recording ×‘-Inspector).
	â€¢	×ª××œ×•×œ × ×©××¨ ×‘Ö¾DB; ×•×•××˜×¡××¤ ×¢×•×‘×“; call status × ×¨×©×; ××™×Ÿ 11100/13512/31920/31924/403/426.
	â€¢	×”×“×™×¤×œ×•×™ ××¨×™×¥ Eventlet (×œ× ×§×•×“ ×™×©×Ÿ), ×•×›×œ ENV ×§×™×™××™× ×‘×“×™×¤×œ×•×™ (×œ× ×¨×§ ×‘Ö¾Workspace).

â¸»

1) ×¤×¨×™×¡×” × ×›×•× ×” (Replit Deployments) â€” ×—×•×‘×” ×œÖ¾WS

×‘Ö¾Deployments (×”Ö¾Service), ×”×’×“×¨:
Build

pip install -r AgentLocator/requirements.txt

Run

python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app

×‘×œ×™ -k eventlet â†’ 31920 (Handshake Error) ×›××¢×˜ ×‘×˜×•×—.

ENV (×‘Ö¾Deployment ×¢×¦××•):
	â€¢	DATABASE_URL
	â€¢	OPENAI_API_KEY
	â€¢	GOOGLE_APPLICATION_CREDENTIALS (× ×ª×™×‘/JSON)
	â€¢	TWILIO_ACCOUNT_SID
	â€¢	TWILIO_AUTH_TOKEN
	â€¢	PUBLIC_BASE_URL = https://ai-crmd.replit.app  (××• ×”×“×•××™×™×Ÿ ×©×œ×š)

â¸»

2) ×ª×§×Ÿ 404 ×¢×œ /webhook/call_status

×‘Ö¾AgentLocator/server/routes_twilio.py (×™×© ××¦×œ×š Blueprint ×‘×©× twilio_bp). ×”×•×¡×£/××©×¨×¨:

@twilio_bp.route("/webhook/call_status", methods=["POST"])
def call_status():
    call_sid = request.form.get("CallSid")
    call_status = request.form.get("CallStatus")  # queued|ringing|in-progress|completed...
    try:
        current_app.logger.info("CALL_STATUS", extra={"call_sid": call_sid, "status": call_status})
        # TODO: update DB status if needed
    except Exception:
        current_app.logger.exception("CALL_STATUS_HANDLER_ERROR")
    return "", 204

×‘×˜×•×•×™×œ×™×• ×•×“× ×©×”Ö¾Status Callback URL ××¦×‘×™×¢ ×œ×©× (×‘××¡×¤×¨/×‘×–×¨×™××” ×©×œ×š).

â¸»

3) TwiML ×“×™× ××™ 100% (××™×Ÿ ×›×ª×•×‘×•×ª ×§×©×™×—×•×ª, ××™×Ÿ )

×‘Ö¾incoming_call ×›×‘×¨ ×™×© ×œ×š abs_url() â€“ ×˜×•×‘. ×ª×•×•×“× ×©×›×š × ×‘× ×” ×”×›×œ:

def abs_url(path: str) -> str:
    base = os.getenv("PUBLIC_BASE_URL") or request.url_root.rstrip("/")
    return f"{base}{path}"

@twilio_bp.route("/webhook/incoming_call", methods=["POST"])
def incoming_call():
    call_sid = request.form.get("CallSid")
    greeting_url = abs_url("/static/tts/greeting_he.mp3")
    wss_host = (os.getenv("PUBLIC_BASE_URL") or request.url_root) \
                .replace("https://","").replace("http://","").strip("/")

    twiml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Play>{greeting_url}</Play>
  <Connect action="/webhook/stream_ended">
    <Stream url="wss://{wss_host}/ws/twilio-media">
      <Parameter name="call_sid" value="{call_sid}"/>
    </Stream>
  </Connect>
</Response>"""
    threading.Thread(target=_watchdog, args=(call_sid, wss_host, 6, 6), daemon=True).start()
    return twiml, 200, {"Content-Type": "text/xml"}

×‘×“×•×§ ×©×”×§×‘×¦×™× ×§×™×™××™× ×‘×“×™×¤×œ×•×™:

/static/tts/greeting_he.mp3
/static/tts/fallback_he.mp3

×‘×“×™×§×•×ª:

curl -I https://<DEPLOY>/static/tts/greeting_he.mp3
curl -I https://<DEPLOY>/static/tts/fallback_he.mp3
# ×©× ×™×”× 200 + Content-Type: audio/mpeg

××™×Ÿ <Say language="he-IL"> ×‘×©×•× ××§×•× (×–×” ×’×•×¨× 13512). ×¢×‘×¨×™×ª = <Play> ×‘×œ×‘×“.

â¸»

4) Flask-Sock & × ×ª×™×‘×™ WS (××•× ×¢ 426/Redirect)

×‘Ö¾AgentLocator/server/app_factory.py ×™×© ×œ×š ×¨×™×©×•× ×ª×§×™×Ÿ. ×•×“×:
	â€¢	sock.init_app(app) ××—×¨×™ ×™×¦×™×¨×ª app.
	â€¢	ProxyFix ××•×¤×¢×œ.
	â€¢	×™×© ×©× ×™ × ×ª×™×‘×™× (×¢× ×•×‘×œ×™ /)â€”××•× ×¢ 301/302 ×‘×”× ×“×©×™×™×§:

from werkzeug.middleware.proxy_fix import ProxyFix
from flask_sock import Sock
sock = Sock()

def create_app():
    app = Flask(__name__, static_url_path="/static",
                static_folder=os.path.join(os.path.dirname(__file__), "..", "static"))
    app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1)

    sock.init_app(app)
    assert "sock" in app.extensions, "Flask-Sock not registered"

    from .media_ws import MediaStreamHandler
    @sock.route("/ws/twilio-media")
    def ws_a(ws): MediaStreamHandler(ws).run()
    @sock.route("/ws/twilio-media/")
    def ws_b(ws): MediaStreamHandler(ws).run()

    from .routes_twilio import twilio_bp
    app.register_blueprint(twilio_bp)

    from .routes_whatsapp import register_whatsapp_routes
    register_whatsapp_routes(app)  # ×¤×¢× ××—×ª ×‘×œ×‘×“

    return app

××™×Ÿ ×©×•× ×“×§×•×¨×˜×•×¨ ××‘×˜×—×”/×—×ª×™××” ×¢×œ × ×ª×™×‘ ×”Ö¾WS.
××™×Ÿ Socket.IO/engineio ×¢×œ ××•×ª×• app/×¤×•×¨×˜.

â¸»

5) Watchdog ×©××¦×™×œ ×©×™×—×” ×‘×–××Ÿ ×××ª (×’× ×× WS ×œ× ×§×)

×‘Ö¾routes_twilio.py (×™×© ×œ×š ×¤×•× ×§×¦×™×•×ª _watchdog ×•Ö¾_do_redirect). ×•×“× ×©×”×Ÿ:
	â€¢	××©×ª××©×•×ª ×‘×§×¨×“× ×¦â€™×œ×™× ×Ö¾ENV (×‘×“×™×¤×œ×•×™!)
	â€¢	××“×•×•×—×•×ª ×œ×•×’×™× ×‘×¨×•×¨×™×

def _watchdog(call_sid, wss_host, start_timeout=6, no_media_timeout=6):
    time.sleep(start_timeout)
    st = stream_registry.get(call_sid)
    if not st.get("started"):
        _do_redirect(call_sid, wss_host, reason="no_stream_start"); return
    if time.time() - st.get("last_media_at", 0) > no_media_timeout:
        _do_redirect(call_sid, wss_host, reason="no_media")

def _do_redirect(call_sid, wss_host, reason):
    current_app.logger.warning("WATCHDOG_REDIRECT", extra={"call_sid": call_sid, "reason": reason})
    twiml = f"""<Response>
  <Record playBeep="false" timeout="4" maxLength="30" transcribe="false"
          action="/webhook/handle_recording" />
  <Play>https://{wss_host}/static/tts/fallback_he.mp3</Play>
</Response>"""
    try:
        client = Client(os.environ["TWILIO_ACCOUNT_SID"], os.environ["TWILIO_AUTH_TOKEN"])
        client.calls(call_sid).update(twiml=twiml)
        current_app.logger.info("WATCHDOG_REDIRECT_OK", extra={"call_sid": call_sid})
    except Exception:
        current_app.logger.exception("WATCHDOG_REDIRECT_FAIL")

×× ×‘Ö¾Inspector ××™×Ÿ /webhook/handle_recording ×‘×©×™×—×” ×©×§×˜×”â€”×‘×“â€×› ×—×¡×¨×™× TWILIO_ACCOUNT_SID/TOKEN ×‘Ö¾Deployment.

â¸»

6) Media WS â€“ ×§×œ×™×˜×ª call_sid ×•Ö¾streamSid (××•× ×¢ 31924/31951)

×‘Ö¾AgentLocator/server/media_ws.py ×•×“× ×©×”Ö¾call_sid × ×©×œ×£ ×Ö¾customParameters ×•×©×”Ö¾streamSid × ×©××¨ ×Ö¾start:

if ev == "start":
    start = data.get("start", {})
    cp = start.get("customParameters") or {}
    if isinstance(cp, str):
        try: cp = json.loads(cp)
        except: cp = {}
    self.call_sid = cp.get("call_sid") or cp.get("CallSid") or cp.get("CALL_SID")
    self.stream_sid = start.get("streamSid")
    current_app.logger.info("WS_START", extra={"streamSid": self.stream_sid, "call_sid": self.call_sid})
    if self.call_sid: stream_registry.mark_start(self.call_sid)

elif ev == "media":
    if self.call_sid: stream_registry.touch_media(self.call_sid)

×œ× ×××¦×™××™× streamSid. ××©×ª××©×™× ×¨×§ ×‘××” ×©×‘× ×Ö¾start.

â¸»

7) ×—×ª×™××ª Twilio (Production ×‘×œ×‘×“)
	â€¢	×œ×”×¤×¢×™×œ @require_twilio_signature ×¢×œ ×”Ö¾HTTP ×‘×œ×‘×“:
/webhook/incoming_call, /webhook/stream_ended, /webhook/handle_recording, /webhook/call_status.
	â€¢	×œ× ×¢×œ /ws/twilio-media.

â¸»

8) ×•×•××˜×¡××¤ + CRM
	â€¢	routes_whatsapp.py ×¨×©×•× ×¤×¢× ××—×ª ×‘Ö¾app_factory.py (××¦×œ×šâ€”×ª×§×™×Ÿ).
	â€¢	×›×œ webhook (voice/whatsapp) ×¢×•×©×” INSERT/UPDATE ×¢× commit.
	â€¢	×‘Ö¾DB ×™×© call_log, call_turn, interactionsâ€”××™×’×¨×¦×™×” ××“×¤×˜×™×‘×™×ª ×›×‘×¨ ×§×™×™××ª.

â¸»

9) ×œ×•×’×™× ×©×—×™×™×‘×™× ×œ×”×•×¤×™×¢ (×“×™×‘×•×’ ××”×™×¨)
	â€¢	HTTP: REQ path=... / RES status=...
	â€¢	WS: WS_CONNECTED â†’ WS_START(streamSid,call_sid) â†’ (WS_FRAME ××•×¤×¦×™×•× ×œ×™) â†’ WS_STOP
	â€¢	Watchdog: WATCHDOG_REDIRECT / WATCHDOG_REDIRECT_OK / WATCHDOG_REDIRECT_FAIL
	â€¢	Recording: recording_transcribed ××• recording_transcribe_fail
	â€¢	Call status: CALL_STATUS(status=...)

â¸»

10) ×‘×“×™×§×•×ª ×¡×’×™×¨×” (5 ×“×§×•×ª)
	1.	TwiML

curl -s https://<DEPLOY>/webhook/incoming_call | sed -n '1,30p'

×¨×•××” <Play>https://.../greeting_he.mp3</Play> ×•××– <Connect><Stream wss://.../ws/twilio-media>.

	2.	MP3

curl -I https://<DEPLOY>/static/tts/greeting_he.mp3
curl -I https://<DEPLOY>/static/tts/fallback_he.mp3
# ×©× ×™×”× 200


	3.	WS ×××™×ª×™
×”×ª×—×‘×¨ ×¢× websocketking/wscat ×œÖ¾
wss://<DEPLOY>/ws/twilio-media â†’ â€œConnected (101)â€.
	4.	×©×™×—×”
	â€¢	××™×Ÿ 31920/426/31924.
	â€¢	×× ××™×Ÿ WS_START/×¤×¨×™×™××™× â†’ ×ª×•×š â‰¤6×©×³ ××•×¤×™×¢ ×‘Ö¾Inspector: POST /webhook/handle_recording (Redirect ×”×¦×œ×™×—).
	â€¢	×‘×¡×™×•×: POST /webhook/call_status = 204 (×œ× 404).

â¸»

11) ××™×¤×•×™ ×©×’×™××” â†’ ×ª×™×§×•×Ÿ (×ª×–×›×•×¨×ª ×§×¦×¨×”)
	â€¢	15003 / 404 call_status â†’ ×”×•×¡×£ route+×¨×™×©×•×; ×•×“× Status Callback ××¦×‘×™×¢ ××œ×™×•.
	â€¢	31920 Handshake â†’ Eventlet ×—×•×‘×”; ×©× ×™ × ×ª×™×‘×™ WS; ××™×Ÿ ××‘×˜×—×”/Socket.IO ×¢×œ WS; host × ×›×•×Ÿ.
	â€¢	11100 Play URL â†’ URLs ××•×—×œ×˜×™× ×“×¨×š abs_url(); ×§×‘×¦×™× ×§×™×™××™×.
	â€¢	13512 â†’ ××œ ×ª×©×ª××© ×‘Ö¾<Say he-IL> ×‘×©×•× ××¦×‘.
	â€¢	31924/31951 â†’ ××œ ×ª×™×™×¦×¨ streamSidâ€”×§×— ×Ö¾start.
	â€¢	Fallback ×œ× ×§×•×¨×” â†’ ×—×¡×¨×™× TWILIO_* ×‘Ö¾Deployment / thread ×œ× ×”×•×¤×¢×œ.

â¸»

TL;DR

×”×§×•×“ ××¦×œ×š ×›×‘×¨ â€œ×›××¢×˜ ×©×â€. ××” ×©××¤×™×œ ×‘×¤×•×¢×œ ×›×¨×’×¢ ×œ×¤×™ ×”×“×™×•×•×— ×©×œ×š:
	â€¢	/webhook/call_status ×œ× ×§×™×™× â†’ ×ª×•×¡×™×£ ×›×¤×™ ×©××¢×œ (×™×’×™×¢ 204 ×‘××§×•× 404).
	â€¢	31920 â†’ ××• ×©×”Ö¾Deployment ×œ× ×¨×¥ ×¢× -k eventlet, ××• ×‘×¢×™×™×ª × ×ª×™×‘/Redirect (×¡×¢×™×£ 4), ××• ×“×•××™×™×Ÿ WSS ×œ× ×ª×•××.

×‘×¦×¢ ××ª ×”×¡×¢×™×¤×™× ×œ××¢×œ×”, ×ª×¨×™×¥ ×©×™×—×” ××—×ª, ×•×ª×‘×“×•×§ ×‘-Inspector:
	â€¢	×©×ª×”×™×” ×§×¨×™××” ×œÖ¾/webhook/call_status = 204,
	â€¢	×•×× ××™×Ÿ WSâ€”×©×ª×¨××” POST /webhook/handle_recording ×ª×•×š â‰¤6×©×³.
×× ××©×”×• ×¢×“×™×™×Ÿ ××“×•×, ×”×“×‘×§ ×œ×™ ××ª 5â€“6 ×©×•×¨×•×ª ×”×œ×•×’ ×¡×‘×™×‘ WS_START/WATCHDOG_â€¦ ×•××ª ×’×•×£ ×”Ö¾TwiML ×©×—×–×¨â€”×•××¡×’×•×¨ ××ª ×–×” ×œ×š ×‘× ×§×•×“×”.