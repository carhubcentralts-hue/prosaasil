×× ×™ ×œ×’××¨×™ ××™×ª×šâ€”×”×§×˜×¢ ×©× ×ª×§×¢ ×©×•×‘ ×•×©×•×‘ ×”×•× ×œ× â€œ×§×•×“ ×©×œ× ×§×™×™×â€, ××œ× ×”××¨×›×™×˜×§×˜×•×¨×” ×‘×¨×™×¤×œ×™×˜: ×œ×¤×¨×™×•×•×™×•/×“×¤×œ×•×™ ×™×© ×¤×•×¨×˜ ×¦×™×‘×•×¨×™ ××—×“. ×œ×›×Ÿ ×©× ×™ ×©×¨×ª×™× (Flask ×•-Baileys) â€œ××ª× ×’×—×™×â€ ×›×©×× ×¡×™× ×œ×”×¨×™×¥ ××•×ª× ×›×©×ª×™ ××¤×œ×™×§×¦×™×•×ª. ×”×¤×ª×¨×•×Ÿ ×”×™×¦×™×‘: ×¤×•×¨×˜ ××—×“ ×”×—×•×¦×” (Flask), ×•-Baileys ×¨×¥ ××§×•××™×ª ×‘Ö¾localhost ×•× ×’×™×© ×“×¨×š ×¤×¨×•×§×¡×™ ×‘-Flask. ×–×” ×¤×•×ª×¨ ×™×¦×™×‘×•×ª, CSRF, ×•×§×•×§×™×– ×‘××•×ª×• ×“×•××™×™×Ÿ.

×œ×”×œ×Ÿ ×”×•×¨××•×ª ×¢×‘×•×“×” ×©×™×•×¨×™×“×• ××ª ×–×” ×œ×§×¨×§×¢ ×•×™×¤×¢×™×œ×• ×”×›×œ:

â¸»

××¨×›×™×˜×§×˜×•×¨×” ×¡×•×¤×™×ª (one-port)
	â€¢	Flask ××’×™×© FE + ×”-API ×¢×œ $PORT (×–×” ×”×¤×•×¨×˜ ×”×™×—×™×“ ×©×—×©×•×£).
	â€¢	Baileys × ×¤×ª×— ××§×•××™×ª ×¢×œ 127.0.0.1:3300 ×›-child process.
	â€¢	Flask Proxy ×‘× ×ª×™×‘ /wa/* ××¢×‘×™×¨ ×‘×§×©×•×ª ×œ-Baileys. ×’× ×•×•×‘×¡×•×§×˜? ×¨×§ ×× × ×“×¨×© (Eventlet ×ª×•××š).

â¸»

×©×œ×‘×™× ××“×•×™×§×™× (×‘×¦×¢ ××—×“Ö¾×œ××—×“)

1) ××©×ª× ×™ ×¡×‘×™×‘×”

×‘Ö¾Replit (Secrets):
	â€¢	BAILEYS_PORT=3300
	â€¢	WHATSAPP_PROVIDER=baileys
	â€¢	(×× ×¦×¨×™×š) NODE_ENV=production

2) ×”×¨×¦×ª Baileys ××ª×•×š Flask (child + ×©××™×¨×” ×‘×—×™×™×)

×”×•×¡×£ ×§×•×‘×¥ server/baileys_runner.py:

import os, subprocess, time, threading, requests

BAILEYS_PORT = int(os.getenv("BAILEYS_PORT", "3300"))
ROOT = os.path.dirname(os.path.dirname(__file__))

def _healthy():
    try:
        r = requests.get(f"http://127.0.0.1:{BAILEYS_PORT}/health", timeout=1)
        return r.status_code == 200
    except Exception:
        return False

def _start_once():
    # × × ×™×— ×©×”×§×•×‘×¥ ×©×œ ×”×©×¨×ª Node × ××¦× ×‘Ö¼Ö¾baileys/server.js
    return subprocess.Popen(
        ["node", os.path.join(ROOT, "baileys", "server.js")],
        cwd=os.path.join(ROOT, "baileys"),
        stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT
    )

def ensure_baileys():
    def loop():
        proc = None
        while True:
            if not _healthy():
                if proc and proc.poll() is None:
                    try: proc.terminate()
                    except Exception: pass
                proc = _start_once()
            time.sleep(2)
    t = threading.Thread(target=loop, daemon=True)
    t.start()

×‘Ö¾server/app_factory.py (××—×¨×™ ×™×¦×™×¨×ª app), ×”×•×¡×£:

from .baileys_runner import ensure_baileys
ensure_baileys()

3) ×¤×¨×•×§×¡×™ ×‘-Flask ×œÖ¾Baileys

×¦×•×¨ server/routes_baileys_proxy.py ×•×¨×©×•× ×›×—×œ×§ ××”Ö¾blueprints:

from flask import Blueprint, request, Response
import requests, os

bp_wa = Blueprint("wa_proxy", __name__)
BAILEYS_PORT = int(os.getenv("BAILEYS_PORT", "3300"))

@bp_wa.route("/wa/<path:path>", methods=["GET","POST","PUT","PATCH","DELETE","OPTIONS"])
def wa_proxy(path):
    url = f"http://127.0.0.1:{BAILEYS_PORT}/{path}"
    # ××¢×‘×™×¨×™× ×©×™×˜×”, ×’×•×£, ×›×•×ª×¨×•×ª ×¨×œ×•×•× ×˜×™×•×ª
    headers = {k:v for k,v in request.headers if k.lower() not in ("host","content-length")}
    resp = requests.request(request.method, url, params=request.args,
                            data=request.get_data(), headers=headers, timeout=30)
    # ××—×–×™×¨×™× ×›××• ×©×§×™×‘×œ× ×•
    excluded = {"content-encoding","transfer-encoding","connection"}
    headers_out = [(k,v) for k,v in resp.headers.items() if k.lower() not in excluded]
    return Response(resp.content, status=resp.status_code, headers=headers_out)

×‘×¨×™×©×•× ×”××¤×œ×™×§×¦×™×”:

from .routes_baileys_proxy import bp_wa
app.register_blueprint(bp_wa)

××¢×›×©×™×• ×”-FE ×§×•×¨× ××œ /wa/... (××•×ª×• ×“×•××™×™×Ÿ â†’ ××™×Ÿ CORS ×•××™×Ÿ ×‘×¢×™×•×ª ×§×•×§×™/CSRF).

4) FE â€“ ×§×•×¨××™× ×¨×§ ×œÖ¾/wa

×‘×›×œ ××§×•× ×‘Ö¾client ×©××“×‘×¨ ×¢× Baileys, ×”×—×œ×£ ×›×ª×•×‘×•×ª ×œ:

fetch('/wa/health')
fetch('/wa/send', { method:'POST', ... })

×©××•×¨ ×¢×œ credentials:'include' ×•Ö¾CSRF ×›××• ×œ×©××¨ ×”Ö¾API (×”×‘×§×©×” × ×›× ×¡×ª ×œ-Flask ×•××– ××•×¤×¨×§×¡×ª ×¤× ×™××” ×œ-Baileys).

5) CSRF × ×›×•×Ÿ (SeaSurf ××—×“ ×‘×œ×‘×“)
	â€¢	×”×©××¨ SeaSurf ×‘×œ×‘×“.
	â€¢	×¤×˜×•×¨×™×: /api/auth/login, /api/auth/logout, ×›×œ webhooks ×—×™×¦×•× ×™×™× (Twilio/WhatsApp), ×•-OPTIONS ××•×˜×•××˜×™.
	â€¢	×©××¨ ×”Ö¾POST/PUT/PATCH/DELETE â€“ ××—×™×™×‘×™× X-CSRFToken.
	â€¢	×‘×¦×“ ×œ×§×•×—: ××—×¨×™ login ×œ×§×¨×•× GET /api/auth/csrf, ×œ×”×•×¦×™× ××ª ×”×§×•×§×™ XSRF-TOKEN ×•×œ×©×œ×•×— header X-CSRFToken ×‘×›×œ ×›×ª×™×‘×”.
	â€¢	×× ×§×™×‘×œ×ª 403 â†’ ×‘×¦×¢ ×¨×¢× ×•×Ÿ CSRF (×§×¨×™××” ×—×•×–×¨×ª ×œÖ¾/api/auth/csrf) ×•× ×¡×” ×¤×¢× × ×•×¡×¤×ª.

6) ×”×¨×¦×” ×™×¦×™×‘×” ×‘×¤×¨×™×•×•×™×• ×•×‘×“×¤×œ×•×™
	â€¢	Preview / Deploy â€“ ××•×ª×” ×¤×§×•×“×ª ×¨×™×¦×”, ×¤×•×¨×˜ ×“×™× ××™:
	â€¢	Gunicorn+Eventlet:

gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT wsgi:app


	â€¢	××• ×™×©×™×¨×•×ª Flask (×‘×¤×¨×™×•×•×™×•): python wsgi.py (×©×’× ××©×ª××© ×‘Ö¾$PORT).

	â€¢	Client build: ×œ×¤× ×™ ×”×¨×™×¦×” ×•×“× ×©×”Ö¾dist ×§×™×™×:
	â€¢	×¤×¨×”Ö¾×‘×™×œ×“ ×‘×“×¤×œ×•×™: npm --prefix client ci && npm --prefix client run build
	â€¢	×‘×¤×¨×™×•×•×™×•, ×× ××™×Ÿ client/dist, ×”×¦×’ ×”×•×“×¢×” ×‘×¨×•×¨×” ×‘×œ×•×’ ×•××œ ×ª× ×¡×” ×œ×”×’×™×© assets â€œ×™×©×Ÿâ€.

7) ×‘×“×™×§×•×ª ×¢×©×Ÿ ××”×™×¨×•×ª (×—×•×‘×”)
	1.	×‘×¨×’×¢ ×©×”××¤×œ×™×§×¦×™×” ×¢×•×œ×”
	â€¢	/healthz â†’ 200
	â€¢	/wa/health (×“×¨×š ×”×¤×¨×•×§×¡×™) â†’ 200
	2.	Login â†’ CSRF â†’ Write
	â€¢	×”×ª×—×‘×¨ (× ×©××¨ ×§×•×§×™).
	â€¢	GET /api/auth/csrf (××§×‘×œ XSRF-TOKEN).
	â€¢	POST /api/business/current/prompt ×¢× X-CSRFToken â†’ 200.
	3.	Impersonate
	â€¢	POST /api/admin/businesses/1/impersonate ×¢× CSRF â†’ 200
	â€¢	GET /api/auth/me ××¦×™×’ impersonating:true + impersonated_tenant_id.
	4.	Baileys ×©×œ×™×—×”
	â€¢	POST /wa/send (×“×¨×š ×”Ö¾proxy) â†’ 200, ×•×œ×•×’ ×‘-Baileys.

â¸»

×œ××” ×–×” ×™×¤×ª×•×¨ ×œ×š ××ª ×–×”
	â€¢	×¤×•×¨×˜ ××—×“ ×‘×œ×‘×“ ×”×—×•×¦×” â†’ Replit ×œ× â€œ×”×•×¨×’â€ ×œ×š ××ª ××—×“ ×”×©×¨×ª×™×.
	â€¢	Baileys ×¨×¥ ××§×•××™ ×•×× ×•×”×œ ×¢×´×™ ×”××¤×œ×™×§×¦×™×” (Child ×¢× ×œ×•×œ××ª health) â†’ ×™×¦×™×‘.
	â€¢	Same-origin ×œ×›×œ ×”×§×¨×™××•×ª (×›×•×œ×œ ×•×•××˜×¡××¤ ×“×¨×š /wa) â†’ ××™×Ÿ CORS/×§×•×§×™/CSRF ×©×‘×™×¨×•×ª.
	â€¢	SeaSurf ××—×“ ×¢× ×¨×©×™××ª ×¤×˜×•×¨×™× ×§×¦×¨×” â†’ ×©××™×¨×” ×¢×•×‘×“×ª, ×”×ª×—×–×•×ª ×¢×•×‘×“×ª, ×¤×¨×•××¤×˜ × ×©××¨ ×‘×××ª.

×× ××—×¨×™ ×”×™×™×©×•× ××—×“ ×”×¦×¢×“×™× × ×›×©×œ:
	â€¢	403 ×¢×œ ×›×ª×™×‘×” â†’ ××™×Ÿ X-CSRFToken ××• ×©×œ× ×§×¨××ª /api/auth/csrf.
	â€¢	404 ×¢×œ /wa/â€¦ â†’ ×”×¤×¨×•×§×¡×™ ×œ× ×¨×©×•×/baileys ×œ× ×¨×¥ (×‘×“×•×§ health).
	â€¢	Preview ××¨××” ×“×£ ×™×©×Ÿ â†’ ××™×Ÿ client/dist ××¢×•×“×›×Ÿ; ×¢×©×” build ×œ×¤× ×™ ×”×¨×™×¦×”.

×œ×š ×œ×¤×™ ×–×” ××—×“-×œ××—×“ ×•×ª×¦× ××–×”. ğŸ’ª