## 📞 הנחיה סופית לתיקון תמלול שיחות קצרות במערכת AgentLocator

> גרסה: 33
> מטרה: לוודא שכל שיחה מוקלטת מתומללת או מקבלת תגובה מתאימה אם קצרה מדי

---

## ✅ בעיה עיקרית:

Twilio מקליט, אבל ההקלטה קצרה מדי → Whisper לא מצליח להבין כלום → GPT לא מופעל → אין תגובה למשתמש.

---

## ✅ פתרון מלא – שלב אחר שלב:

### 1. 📥 ב־`whisper_handler.py` → ב־`download_audio()` הוסף בדיקה אם האודיו קצר מדי:

```python
if len(response.content) < 3000:
    logger.warning("⚠️ Audio too short, skipping transcription.")
    return {"text": "", "reason": "too_short"}
```

> (זה בערך שווה ל־1.5 שניות PCM)

### 2. 🧠 אחרי התמלול → אם ריק או ג'יבריש:

```python
if not text or is_gibberish(text):
    logger.info("⚠️ Empty or gibberish transcription")
    return {"text": "", "reason": "unrecognized"}
```

### 3. 🗣️ ב־`routes_twilio.py` → אם `reason == 'too_short'` או `'unrecognized'`, שלח למשתמש הודעה קולית:

```python
if transcription.get("reason") in ["too_short", "unrecognized"]:
    fallback = "לא הצלחתי להבין את מה שנאמר. נסה שוב לאחר הצליל."
    filepath = hebrew_tts(fallback, "fallback_retry.mp3")

    # צור TwiML חדש שישמיע שוב את ההודעה ויתחיל הקלטה נוספת
    response = f"""
    <Response>
        <Play>{filepath}</Play>
        <Pause length='1'/>
        <Record action='/webhook/handle_recording' maxLength='30' timeout='5' finishOnKey='*'/>
    </Response>
    """
    return Response(response, mimetype="text/xml")
```

---

## 🧪 בדיקות חובה:

| בדיקה                     | תוצאה נדרשת ✅                            |
| ------------------------- | ---------------------------------------- |
| שיחה עם 0.5 שניות דיבור   | ❌ לא תעבור תמלול, תחזור הודעה "לא הבנתי" |
| שיחה עם שקט גמור          | ❌ תוחזר הודעה קולית + הקלטה מחדש         |
| שיחה רגילה מעל 2 שניות    | ✅ תתמלל ותנותח בג'י־פי־טי                |
| תוצאה מוצגת בלוג או ב־CRM | ✅ נשמרת במערכת                           |

---

## 🛡️ הערות אבטחה / יציבות

* הימנע מלולאות אין־סופיות – נסה רק פעם אחת לשלוח fallback
* תתעד כל ניסיון תמלול בקובץ לוג
* שמור את התוצאה במסד גם אם נכשל (עם `status = failed`)

---

✅ ברגע שכל אלו מוטמעים בפועל – מערכת השיחות שלך תהיה חסינה לבעיות של שיחות קצרות, שקטות או לא מובנות.
