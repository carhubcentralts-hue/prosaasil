×œ×”×œ×Ÿ ×”× ×—×™×” ××§×™×¤×” (×§×•×¤×™-×¤×™×™×¡×˜) ×œ×¡×’×•×¨ ×¡×•×¤×™×ª ×§×‘×¦×™× ××™×•×ª×¨×™×/×›×¤×•×œ×™×, ×œ××—×“ ××¨×›×™×˜×§×˜×•×¨×”, ×•×œ×× ×•×¢ ×”×ª× ×’×©×•×ª ×¨××•×˜×™×. ×”×™× ×›×•×œ×œ×ª: ×¡×“×¨ ×¤×¢×•×œ×•×ª, ×¤×§×•×“×•×ª ×‘×“×™×§×”, ×¡×§×¨×™×¤×˜ ×œ×–×™×”×•×™ ×›×¤×™×œ×•×™×•×ª, ××‘× ×” ×¤×¨×•×™×§×˜ ×§× ×•× ×™, ×•×›×œ×œ×™ â€œ××§×•×¨ ×××ª ×™×—×™×“â€.
×©×œ×—/×”×“×‘×§ ×œ×¡×•×›×Ÿ ×”×¤×™×ª×•×— ×›××• ×©×”×™×:

â¸»

ğŸ“£ ××©×™××”: ××™×—×•×“ ×•× ×™×§×•×™ ×”×¤×¨×•×™×§×˜ ×¢×“ 100% (×œ×œ× ×›×¤×™×œ×•×™×•×ª ×•×œ×œ× × ×ª×™×‘×™× ×—×•×¤×¤×™×)

ğŸ¯ Definition of Done
	â€¢	××™×Ÿ ×©×•× ×§×•×‘×¥ â€œ××§×‘×™×œ/×™×©×Ÿ/clean/backupâ€ ×‘×ª×™×§×™×•×ª ×”×¤×¢×™×œ×•×ª.
	â€¢	×œ×›×œ ×ª×—×•× ×™×© ×§×•×‘×¥/××•×“×•×œ ×™×—×™×“ ×¨×©××™ (Twilio Voice, WhatsApp API, WhatsApp Webhooks, WS ×©×œ Media Streams).
	â€¢	app_factory.py/app.py ×¨×•×©× ×¨×§ ××ª ×”-Blueprints / ×¨××•×˜×™× ×”×§× ×•× ×™×™×.
	â€¢	××™×Ÿ ×©× ×™ ×¨××•×˜×™× ×œ××•×ª×” ×“×¨×š/×©×™×˜×”; flask url_map × ×§×™ ××§×•× ×¤×œ×™×§×˜×™×.
	â€¢	.env.example ××¡×•× ×›×¨×Ÿ ×¢× ×”×§×•×“; ××™×Ÿ ××©×ª× ×™ ENV ×©×œ× ×‘×©×™××•×©.
	â€¢	CI × ×›×©×œ ×× ×—×•×–×¨×ª ×›×¤×™×œ×•×ª (×‘×“×™×§×ª hash, ×‘×“×™×§×ª ×¨××•×˜×™×, Vulture â€œdead codeâ€).

â¸»

1) ×™×¦×™×¨×ª ×¢× ×£ ×¢×‘×•×“×” ×•×©×›×‘×ª Legacy
	1.	git checkout -b chore/cleanup-unification
	2.	×¦×•×¨ ×ª×™×§×™×”: legacy/ ×‘×©×•×¨×© ×”×¨×™×¤×•.
	3.	×›×œ ×§×•×‘×¥ ××™×•×ª×¨/×™×©×Ÿ/×›×¤×•×œ â€” ×”×¢×‘×¨ ×œÖ¾legacy/ (××œ ×ª××—×§ ×¢×“×™×™×Ÿ), ×•×”×¡×¨ ×¨×™×©×•×/×™×™×‘×•× ×©×œ×• ××”××¤×œ×™×§×¦×™×”.

â¸»

2) ××‘× ×” ×§× ×•× ×™ (×™×¢×“ ×¡×•×¤×™)

×¡×“×¨ ××ª ×”×§×•×“ ×›×š (×”×ª×× ×œ×©××•×ª×™×š ×‘×¤×•×¢×œ, ××‘×œ ×©××•×¨ ×¢×œ ×¢×™×§×¨×•×Ÿ â€œ××§×•×¨ ×™×—×™×“â€):

server/
  app_factory.py            # ×™×¦×™×¨×ª ×”××¤×œ×™×§×¦×™×” ×•×¨×™×©×•× blueprints
  config.py                 # ×§×¨×™××ª ENV ×‘××§×•× ××¤×•×–×¨
  db.py
  models/                   # ××•×“×œ×™× ×‘×œ×‘×“
    __init__.py
    models.py
  routes/                   # ×¨××•×˜×™×/Blueprints ×‘×œ×‘×“
    twilio_voice.py         # /webhook/incoming_call|handle_recording|call_status
    whatsapp_twilio.py      # /webhook/whatsapp/incoming|status
    api_whatsapp.py         # /api/whatsapp/* (×××•×—×“: ×©×œ×™×—×”/××“×™×”/×ª×‘× ×™×ª/×¡×˜×˜×•×¡)
    ws_media.py             # /ws/twilio-media (Media Streams ×“×•-×›×™×•×•× ×™)
    health.py               # /health
  services/                 # ×œ×•×’×™×§×” ×¢×¡×§×™×ª
    whatsapp/
      provider.py           # ××ª×’ ×¡×¤×§: baileys|twilio
      baileys/
        index.js
    tts.py                  # Wavenet + fallback
    stt.py                  # Whisper (faster-whisper/OpenAI)
    crm.py                  # CRM ×•×¨×¤×¨×•×–
    twilio_security.py      # @require_twilio_signature
    logging_setup.py        # Request-ID, slow SQL logging
  utils/
    audio_utils.py          # ×¢×–×¨×™ Î¼-law/PCM/Resample
client/                     # FE ×™×—×™×“ (×× ×™×©)
legacy/                     # ×›×œ ××” ×©×œ× ×¤×¢×™×œ (×œ× × ×¨×©×/×œ× ××™×•×‘×)

×›×œ ×§×•×‘×¥/×ª×™×§×™×™×” ×“×•××™× ×‘×©× (×œ××©×œ whatsapp_routes.py, whatsapp_bp.py, routes_whatsapp_twilio_clean.py) â†’ ×œÖ¾legacy/.

â¸»

3) ×©××•×ª ×§× ×•× ×™×™× (××§×•×¨ ×××ª ×™×—×™×“)
	â€¢	WhatsApp API: ×§×•×‘×¥ ×™×—×™×“ server/routes/api_whatsapp.py ×¢× prefix ×§×‘×•×¢: url_prefix="/api/whatsapp".
	â€¢	WhatsApp Webhooks Twilio: ×§×•×‘×¥ ×™×—×™×“ server/routes/whatsapp_twilio.py ×¢× prefix: url_prefix="/webhook/whatsapp".
	â€¢	Twilio Voice: server/routes/twilio_voice.py ×¢× prefix: url_prefix="/webhook".
	â€¢	Media Streams (×“×•-×›×™×•×•× ×™): server/routes/ws_media.py, × ×ª×™×‘: /ws/twilio-media.
	â€¢	Provider ×××•×—×“: server/services/whatsapp/provider.py â€“ ×œ× ×§×™×™××™× whatsapp_providers.py/whatsapp_service_unified.py ×›×¤×•×œ×™×.

â¸»

4) ×¨×™×©×•× Blueprints â€“ ××—×“ ×•×™×—×™×“ ××›×œ ×¡×•×’

×‘Ö¾app_factory.py ×”×©××¨ ×¨×§ ××ª ××œ×” (×”×ª×× ×œ-imports ×©×œ×š):

from server.routes.twilio_voice import twilio_bp
from server.routes.whatsapp_twilio import wa_twilio_bp
from server.routes.api_whatsapp import whatsapp_api_bp
from server.routes.ws_media import ws_bp
from server.routes.health import health_bp

app.register_blueprint(twilio_bp)
app.register_blueprint(wa_twilio_bp)
app.register_blueprint(whatsapp_api_bp)
app.register_blueprint(ws_bp)
app.register_blueprint(health_bp)

×•×“× ×©××™×Ÿ ×™×™×‘×•×/×¨×™×©×•× ×›×¤×•×œ ×©×œ ×’×¨×¡××•×ª ×™×©× ×•×ª (×”×¢×‘×¨ ××•×ª×Ÿ ×œÖ¾legacy/ ×•×”×¡×¨ import).

â¸»

5) ×¡×§×¨×™×¤×˜ ×œ×–×™×”×•×™ ×›×¤×™×œ×•×™×•×ª ×§×‘×¦×™×/×ª×•×›×Ÿ (×”×“×‘×§ ×›Ö¾tools/find_dupes.py)

import hashlib, os, sys, collections, re

ROOT = sys.argv[1] if len(sys.argv) > 1 else "."
EXCLUDE_DIRS = {"legacy", ".git", "__pycache__", "node_modules", "client/dist"}
EXCLUDE_EXT = {".png",".jpg",".jpeg",".gif",".map",".lock",".log",".ico"}

def file_iter():
    for d,_,files in os.walk(ROOT):
        parts = set(d.replace("\\","/").split("/"))
        if parts & EXCLUDE_DIRS: continue
        for f in files:
            ext = os.path.splitext(f)[1].lower()
            if ext in EXCLUDE_EXT: continue
            p = os.path.join(d,f)
            try:
                if os.path.getsize(p) == 0: continue
                yield p
            except: pass

def md5(p):
    h = hashlib.md5()
    with open(p,"rb") as fh:
        for chunk in iter(lambda: fh.read(1<<20), b""):
            h.update(chunk)
    return h.hexdigest()

by_hash = collections.defaultdict(list)
for p in file_iter():
    try:
        by_hash[md5(p)].append(p)
    except Exception as e:
        print("ERR", p, e)

print("\n# Duplicate content groups:")
for h, plist in by_hash.items():
    if len(plist) > 1:
        print(f"\nMD5={h}")
        for p in plist: print("  ", p)

# ×©××•×ª ×—×©×•×“×™× ("copy","clean","old","backup","bak","new","(1)")
PAT = re.compile(r"(copy|clean|old|backup|bak|new|\(\d+\)|_old|_bak)", re.I)
print("\n# Suspicious filenames:")
for p in file_iter():
    if PAT.search(os.path.basename(p)):
        print("  ", p)

×”×¨×¦×”:

python tools/find_dupes.py .

×›×œ ×§×‘×•×¦×” ×©×ª×•×¤×™×¢ â€“ ×”×¢×‘×¨ ××ª ×”×›×¤×™×œ×•×™×•×ª ×œÖ¾legacy/ ×•×”×©××¨ ×¨×§ ××ª ×”×’×¨×¡×” ×”×§× ×•× ×™×ª.

â¸»

6) ×–×™×”×•×™ ×¨××•×˜×™× ×›×¤×•×œ×™×/××ª× ×’×©×™×

×”×•×¡×£ route check ×œÖ¾dev command ×§×¦×¨. ×‘Ö¾app_factory.py:

def print_routes(app):
    seen = {}
    for r in sorted(app.url_map.iter_rules(), key=lambda x: (x.rule, ",".join(sorted(x.methods)))):
        if r.endpoint.startswith("static"): continue
        sig = (r.rule, tuple(sorted([m for m in r.methods if m in {"GET","POST","PUT","DELETE","PATCH"}])))
        if sig in seen:
            print("DUPLICATE ROUTE:", sig, "=>", seen[sig], "and", r.endpoint)
        else:
            seen[sig] = r.endpoint

×”×¨×¦×” ×™×“× ×™×ª (×‘Ö¾shell/REPL) ××—×¨×™ create_app():

from server.app_factory import create_app, print_routes
app = create_app()
print_routes(app)

×× ×™×© DUPLICATE ROUTE â€” ××—×“ ××”× ×—×™×™×‘ ×œ×¢×‘×•×¨ ×œÖ¾legacy/ ××• ×œ×”×—×œ×¤×ª prefix.

â¸»

7) ×›×œ×œ×™ ENV ××—×™×“×™× (××§×•×¨ ×××ª ×™×—×™×“)

×¢×“×›×Ÿ .env.example â€” ×•×©××•×¨ ×¨×§ ×©××•×ª ××œ×” (×“×•×’××”):

FLASK_ENV=production
PUBLIC_HOST=https://YOUR_DOMAIN
CORS_ORIGINS=https://YOUR_DOMAIN

DATABASE_URL=sqlite:///./agentlocator.db

TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=xxxxxxxxxxxxxxxxxxx
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886

WHATSAPP_PROVIDER=baileys   # ××• twilio

OPENAI_API_KEY=sk-xxxx
GOOGLE_TTS_SA_JSON={"type":"service_account",...}   # ××• GOOGLE_APPLICATION_CREDENTIALS=/path/to/sa.json

	â€¢	××œ ×ª×©×ª××©×• ×‘××©×ª× ×™× ×—×œ×•×¤×™×™×/×©×•× ×™× (×œ××©×œ TWILIO_SID ×•Ö¾TWILIO_ACCOUNT_SID ×™×—×“).
	â€¢	×‘×§×•×“, ×˜×¢×™× ×ª ×§×•× ×¤×™×’ ×-server/config.py ×‘×œ×‘×“; ××™×Ÿ os.getenv ××¤×•×–×¨.

â¸»

8) × ×™×§×•×™ ×™×™×‘×•× ×•â€×§×•×“ ××ªâ€
	â€¢	×”×ª×§×Ÿ: pip install vulture
	â€¢	×”×¨×¥: vulture server | tee vulture.txt
	â€¢	×›×œ ××” ×©××•×¤×™×¢ ×›-unused â€” ×”×¡×¨/×”×¢×‘×¨ ×œÖ¾legacy/.
	â€¢	×‘×§×•×“ JS/TS (client): npm i -D eslint, ×”×¨×¥ eslint . ×•×”×¡×¨ ×§×‘×¦×™× ×œ× ×‘×©×™××•×©.

â¸»

9) Pre-commit (×©×•××¨ ×¢×œ ×”×¡×“×¨)

×¦×•×¨ .pre-commit-config.yaml:

repos:
- repo: https://github.com/psf/black
  rev: 24.3.0
  hooks: [{id: black}]
- repo: https://github.com/pycqa/isort
  rev: 5.13.2
  hooks: [{id: isort}]
- repo: https://github.com/PyCQA/flake8
  rev: 7.0.0
  hooks: [{id: flake8}]
- repo: https://github.com/jendrikseipp/vulture
  rev: 2.11
  hooks: [{id: vulture, args: ["server"]}]

pip install pre-commit && pre-commit install


â¸»

10) CI ×©×—×•×¡× ×›×¤×™×œ×•×™×•×ª/×§×•× ×¤×œ×™×§×˜×™× (GitHub Actions)

.github/workflows/quality.yml:

name: Quality
on: [push, pull_request]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with: { python-version: "3.11" }
    - run: pip install -r requirements.txt vulture
    - run: python tools/find_dupes.py . | tee dupes.txt
    - run: |
        if grep -q "MD5=" dupes.txt; then
          echo "Duplicate files detected"; cat dupes.txt; exit 1; fi
    - name: Flask route map
      run: |
        python - <<'PY'
        from server.app_factory import create_app, print_routes
        app = create_app(); print_routes(app)
        PY


â¸»

11) ××™×¤×•×™ ×§×•× ×§×¨×˜×™ (×œ×¤×™ ××” ×©×¨××™× ×• ××¦×œ×š ×‘×¢×‘×¨)
	â€¢	WhatsApp: ×”×©××¨ ×¨×§ server/routes/api_whatsapp.py ×•Ö¾server/routes/whatsapp_twilio.py.
×”×¢×‘×¨ ×œÖ¾legacy/: whatsapp_routes.py, whatsapp_bp.py, routes_whatsapp_twilio_clean.py.
×”×©××¨ ×¨×§ server/services/whatsapp/provider.py (××—×§/××—×“ whatsapp_providers.py/whatsapp_service_unified.py).
	â€¢	Twilio Voice: ×”×©××¨ server/routes/twilio_voice.py. ×”×¢×‘×¨ ×›×œ â€œ×’×¨×¡××•×ª ×™×©× ×•×ªâ€ (×œ××©×œ routes_twilio_old.py) ×œÖ¾legacy/.
	â€¢	WS (Media Streams): ×”×©××¨ server/routes/ws_media.py. ×× ×™×© media_ws.py ×›×¤×•×œ â€“ ××—×“.
×•×“× ×©Ö¾incoming_call ××—×–×™×¨ <Connect><Stream> ×•×œ× <Say>/<Record>.
	â€¢	TTS/Whisper: ×©××•×¨ ×§×•×‘×¥ ×™×—×™×“ ×‘×›×œ ×ª×—×•×: server/services/tts.py, server/services/stt.py.

â¸»

12) ×‘×“×™×§×•×ª ×§×‘×œ×” (××™× ×™××•×)

×”×¨×¥ (××• ×¦×¨×£ ×‘×¡×§×¨×™×¤×˜ smoke):

# 1) Health
curl -s -o /dev/null -w "HTTP %{http_code}\n" $HOST/health  # 200

# 2) ×¨×©×™××ª ×¨××•×˜×™× (×‘×“×™×§×” ×™×“× ×™×ª ×©×œ× ××•×¤×™×¢ DUPLICATE ROUTE)
python - <<'PY'
from server.app_factory import create_app, print_routes
app = create_app(); print_routes(app)
PY

# 3) WhatsApp Twilio webhooks
curl -s -o /dev/null -w "HTTP %{http_code}\n" -X POST $HOST/webhook/whatsapp/incoming -d 'From=whatsapp:+9725...&Body=×”×™×™'  # 200
curl -s -o /dev/null -w "HTTP %{http_code}\n" -X POST $HOST/webhook/whatsapp/status -d 'MessageSid=SM123&MessageStatus=delivered' # 204

# 4) Voice â€“ Media Streams TwiML
curl -s -o /tmp/t.xml -w "HTTP %{http_code}\n" -X POST $HOST/webhook/incoming_call && head -n1 /tmp/t.xml  # 200 + <Connect><Stream>


â¸»

13) ×“×•×§×•×× ×˜×¦×™×” ×¡×•×¤×™×ª
	â€¢	×¢×“×›×Ÿ README.md: ×¢×¥ ×¤×¨×•×™×§×˜, ×¨××•×˜×™× ×§× ×•× ×™×™×, ENV, ××™×š ××¨×™××™×, ×•××™×š ××¨×™×¦×™× ××ª ×‘×“×™×§×•×ª ×”-smoke.
	â€¢	××—×§/×¢×“×›×Ÿ ×›×œ ××–×›×•×¨ ×œ×§×•×‘×¦×™ legacy (×¦×™×™×Ÿ ×©××™×Ÿ ×œ×™×™×‘× ××•×ª×).

â¸»

14) ×›×œ×œ×™× ×œ×¢×ª×™×“ (Guardrails)
	â€¢	×§×•×‘×¥/××•×“×•×œ ×—×“×© ×¢×•×‘×¨ ×“×¨×š server/services/* ××• server/routes/* ×‘×œ×‘×“ â€“ ×œ× ××¤×–×¨×™× ×©×™×›×¤×•×œ×™× ×‘×©×•×¨×©.
	â€¢	××™×Ÿ ×©××•×ª â€œclean/old/new/copy/bakâ€. ×‘××§×•× ×–×”: PR ×¢× refactor ×•×§×‘×¦×™× ×™×©× ×™× × ×¢×™× ×œ-legacy/ ×•××™× × ×¨×©×•××™×.
	â€¢	××™×Ÿ os.getenv ××¤×•×–×¨ â€” ×”×›×œ ×“×¨×š config.py.
	â€¢	×›×œ ×¨××•×˜ ×—×“×© × ×¨×©× ×ª×—×ª Blueprint ×¢× url_prefix ×‘×¨×•×¨ ×›×“×™ ×œ× ×œ×”×ª× ×’×©.

â¸»

×‘×¡×™×•×: ×¦×¨×£ ×¤×œ×˜ python tools/find_dupes.py ., ×¤×œ×˜ print_routes(app) ×‘×œ×™ DUPLICATE, ×•×œ×•×’ ×©×œ Git ×©××¨××” ××™×œ×• ×§×‘×¦×™× ×”×•×¢×‘×¨×• ×œ-legacy/.
×›×›×” × ×“×¢ ×¡×•×¤×™×ª ×©××™×Ÿ ×›×¤×™×œ×•×™×•×ª ×•××¤×©×¨ ×œ×”×©×œ×™× ××ª ×©×›×‘×ª ×”-UI ×‘×‘×™×˜×—×•×Ÿ.