××¢×•×œ×”. ×œ×§×—×ª×™ ××ª ×”×”× ×—×™×” ×”××œ××” ×©×œ×š ×•×”×¨×—×‘×ª×™ ××•×ª×” ×œÖ¾×’×¨×¡×ª PRO ×¡×•×¤×™×ª â€” ×”×›×™ ××¤×•×¨×˜×ª, ×—×“Ö¾××©××¢×™×ª ×•×œ×œ× Stripe (IL-ready). ×–×” × ×•×¡×— ×©××¤×©×¨ ×œ×”×“×‘×™×§ ×™×©×™×¨×•×ª ×œ×¡×•×›×Ÿ. ×”×•× ×›×•×œ×œ: ×§×•× ×¡×•×œ×™×“×¦×™×”, ××‘×˜×—×”, Realtime+Fallback, ×œ×•×’×™× ×•××“×™×“×•×ª, ×“×’×œ×™ ×¤×™×¦â€™×¨ ×œ×¤×™ ×¢×¡×§, ××™×’×¨×¦×™×•×ª DB, ×‘×“×™×§×•×ª ×¤×¨×™×¡×” ××•×˜×•××˜×™×•×ª, × ×™×§×•×™ ×›×¤×™×œ×•×™×•×ª â€” ×•×”×›×•×œ ×‘×œ×™ ×œ×©×‘×•×¨ ×›×œ×•×.

â¸»

âœ… ×”× ×—×™×” ×œ×¡×•×›×Ÿ â€” Production-Ready (×§×•×“ ×‘×œ×‘×“, ×œ×œ× UI)

ğŸ›‘ ××œ ×ª×™×’×¢ ×‘Ö¾UI ×‘×©×œ×‘ ×–×”. ××©×™××”: ×œ×™×™×¦×‘ ×§×•×“, ×œ××—×“ ×›×¤×™×œ×•×™×•×ª, ×œ××‘×˜×— Webhooks, ×œ×”×•×¡×™×£ Fallback ××•×˜×•××˜×™, ×œ×•×’×™× ×•××“×™×“×•×ª, ×“×’×œ×™× ×œ×¢×¡×§×™×, ××™×’×¨×¦×™×•×ª DB, ×•×‘×“×™×§×•×ª ×¤×¨×™×¡×” ××•×˜×•××˜×™×•×ª. ×œ×œ× Stripe (×™×©×¨××œ), ×¨×§ PayPal/Tranzila ×›Ö¾Stub × ×©×œ×˜×™× ×¢×´×™ ×“×’×œ×™×.

â¸»

0) ×•×™×“×•× ×˜×¢×™× ×” ×‘×¡×™×¡×™
	1.	×”××¤×œ×™×§×¦×™×” ×¨×¦×” ×Ö¾AgentLocator/main.py, ×™×•×¦×¨×ª ××¤×œ×™×§×¦×™×” ×“×¨×š server/app_factory.py:create_app().
	2.	×‘×¢×ª ××ª×—×•×œ, ×”×“×¤×¡ ×§×•× ×¡×•×œÖ¾×œ×•×’ ×¢×œ ×›×œ Blueprint ×©× ×¨×©× ×‘×¤×•×¢×œ:

âœ… <blueprint_name> registered

×× ×¨×™×©×•× × ×›×©×œ×” â€” ×ª×§×Ÿ ××™×™×“×™×ª ×•×”×©××¨ ×œ×•×’ âŒ <blueprint_name> failed: <err>.

â¸»

1) ×§×•× ×¡×•×œ×™×“×¦×™×” & × ×™×§×•×™ ×›×¤×™×œ×•×™×•×ª (×œ×œ× ×©×‘×™×¨×”)

××˜×¨×”: ×’×¨×¡×” ×§× ×•× ×™×ª ××—×ª ×œ×›×œ ×¨×›×™×‘; legacy/ × ×©××¨ ×›××¨×›×™×•×Ÿ ×‘×œ×‘×“ â€” ××™×Ÿ ××× ×• ×™×™×‘×•×.
	â€¢	×”×¢×‘×¨×•×ª (×•×œ×¢×“×›×Ÿ imports ×‘×›×œ ×”××§×•××•×ª):
	â€¢	media_ws.py â†’ server/media_ws.py
	â€¢	legacy/whisper_handler.py â†’ server/services/whisper_handler.py

from server.services.whisper_handler import transcribe_he


	â€¢	×—×¡×™××ª legacy:
	â€¢	×•×“× ×©×‘×§×•×“ ××™×Ÿ import ×Ö¾legacy/.
	â€¢	× ×™×§×•×™ ×¨×¢×©×™× (××œ ×ª××—×§ ×§×‘×¦×™× ×›×¨×’×¢, ×¨×§ ×”×©×ª×§×” ×‘Ö¾git):
	â€¢	×¢×“×›×Ÿ .gitignore:

*.pyc
.local/
node_modules/
dist/
.agent_state_*.bin
static/voice_responses/**
generated-icon.png
logs/*


	â€¢	×’×œ××™ ×›×¤×™×œ×•×™×•×ª (×œ×•×’ ×‘×œ×‘×“, ×œ× ×œ××—×•×§ ××•×˜×•××˜×™×ª): ×¦×¨×£ ×›×œ×™:
	â€¢	tools/find_duplicates.py â€” ×¡×¨×™×§×” ×œ×¤×™ hash, ×¤×œ×˜ ×¨×©×™××ª ×›×¤×•×œ×™× + â€œ××•××œ×¥ ×œ×©×™××•×¨â€.

# tools/find_duplicates.py
import hashlib, os, json
ROOT = os.path.dirname(os.path.dirname(__file__))
seen, dups = {}, []
for r,_,fs in os.walk(ROOT):
    if any(skip in r for skip in ('.git','node_modules','dist','.local','static/voice_responses','logs')): 
        continue
    for f in fs:
        p = os.path.join(r,f)
        try:
            h = hashlib.sha256(open(p,'rb').read()).hexdigest()
        except: 
            continue
        if h in seen: dups.append([seen[h], p])
        else: seen[h] = p
print(json.dumps({"duplicates": dups}, ensure_ascii=False, indent=2))



â¸»

2) ××‘×˜×—×ª Webhooks â€“ ×—×•×‘×” ×‘×›×œ ××¡×œ×•×œ
	â€¢	×¢×˜×•×£ ×›×œ × ×ª×™×‘ ×ª×—×ª /webhook/* ×‘×“×§×•×¨×˜×•×¨:

from server.twilio_security import require_twilio_signature

@twilio_bp.post("/webhook/handle_recording")
@require_twilio_signature
def handle_recording(): ...


	â€¢	×–××Ÿ ×ª×’×•×‘×” ×œÖ¾Twilio < 2s: ×ª××™×“ ×”×—×–×¨ 200/204 ××™×™×“×™×ª ×•×”×¢×‘×¨ ×¢×™×‘×•×“ ×œÖ¾Thread/Task.
	â€¢	×‘××§×¨×” ×©×’×™××”: ×œ× ××—×–×™×¨×™× 500; ×”×—×–×¨ 200/204 + ×œ×•×’ ERROR ×‘×¨×•×¨.

â¸»

3) Realtime ×§×•×“×, Fallback ××•×˜×•××˜×™ ××—×¨ ×›×š

××˜×¨×”: ×× Media Stream × ×•×¤×œ/××¡×ª×™×™× â€” ××¢×‘×¨ ××•×˜×•××˜×™ ×œ×”×§×œ×˜×” + ×ª××œ×•×œ, ×‘×œ×™ ×œ× ×ª×§.

3.1 TwiML ×œ×©×™×—×” × ×›× ×¡×ª

×‘Ö¾/webhook/incoming_call ×”×—×–×¨ TwiML ×¢× <Connect> ×©××’×“×™×¨ action="/webhook/stream_ended":

<Response>
  <Connect action="/webhook/stream_ended">
    <Stream url="wss://YOUR_PUBLIC_HOST/ws/twilio-media">
      <Parameter name="business_id" value="{BUSINESS_ID}"/>
    </Stream>
  </Connect>
</Response>

3.2 ×›××©×¨ ×”Ö¾Stream ××¡×ª×™×™× / × ×›×©×œ

×‘Ö¾/webhook/stream_ended ×”×—×–×¨ Fallback:

<Response>
  <Record playBeep="false" timeout="4" maxLength="30" transcribe="false"
          action="/webhook/handle_recording" />
  <Say language="he-IL">×ª×•×“×”. ××¢×‘×“ ××ª ×”×•×“×¢×ª×š ×•×—×•×–×¨ ××™×“.</Say>
</Response>

	â€¢	×œ×•×’: WARN stream_failover -> recording ×¢× call_sid, business_id.
	â€¢	×©××•×¨ ×’× mode="record" ×‘Ö¾DB (×¨××” ×¡×¢×™×£ 4/8).

3.3 WS Keepalive (×œ×•×’ ×‘×œ×‘×“)

×‘Ö¾server/media_ws.py: heartbeat ×›×œ ~15s (DEBUG ws_heartbeat).

â¸»

4) ×œ×•×’×™× ×•××“×™×“×•×ª â€” SLA ×œ×›×œ â€œ×ª×•×¨×Ÿâ€ (×¡×‘×‘ ×“×™×‘×•×¨â†’×ª×’×•×‘×”)

×‘Ö¾WS (Realtime), ×œ×›×œ ×ª×•×¨×Ÿ:
	â€¢	××“×•×“ ×•×”×“×¤×¡ JSON ×‘×œ×•×’:
	â€¢	t_audio_ms â€” Decode/Resample
	â€¢	t_nlp_ms â€” GPT
	â€¢	t_tts_ms â€” TTS
	â€¢	t_total_ms â€” ×¡×”×´×› ×¢×“ ×©×œ×™×—×” ×—×–×¨×”
	â€¢	×¤×•×¨××˜ ××•××œ×¥:

log.info("turn_metrics", extra={
    "call_sid": call_sid, "business_id": biz_id, "turn_id": turn_id,
    "t_audio_ms": X, "t_nlp_ms": Y, "t_tts_ms": Z, "t_total_ms": T,
    "mode": "stream"
})


	â€¢	×™×¢×“: t_total_ms ×××•×¦×¢ < 2500ms.
	â€¢	×˜×‘×œ×ª DB ×—×“×©×” CallTurn:
	â€¢	id, call_sid, business_id, started_at (UTC), mode (stream|record),
t_audio_ms, t_nlp_ms, t_tts_ms, t_total_ms, error_code (nullable).
	â€¢	××™× ×“×§×¡×™×: (call_sid), (business_id,started_at).

â¸»

5) ×¦×™× ×•×¨ ×ª××œ×•×œ ×œ××—×¨ ×”×§×œ×˜×” (Post-Call)

×‘Ö¾/webhook/handle_recording:
	â€¢	×”×•×¨×“×” ×‘×˜×•×—×” (timeout=10s, retryÃ—2), ×˜×™×¤×•×œ ×‘×©×’×™××•×ª.
	â€¢	transcribe_he(...) ×Ö¾server/services/whisper_handler.py (×¢×‘×¨×™×ª, ×¡×™× ×•×Ÿ ×’×³×™×‘×¨×™×©).
	â€¢	×©××™×¨×ª ×ª××œ×•×œ ×‘Ö¾CallLog.transcript (×¨××” ××™×’×¨×¦×™×” ×‘×¡×¢×™×£ 8).
	â€¢	×œ×•×’: INFO recording_transcribed chars=N.
	â€¢	×œ×¢×•×œ× ×œ× 500; ×‘××§×¨×” ×›×©×œ â€” 204 + ×œ×•×’ ERROR.

â¸»

6) ×“×’×œ×™ ×¤×™×¦â€™×¨×™× ×œ×¤×™ ×¢×¡×§ (Feature Flags)

×”×•×¡×£/××©×¨×¨ ×‘×˜×‘×œ×ª Business (××™×’×¨×¦×™×” ×‘×¡×¢×™×£ 8):
	â€¢	enable_calls_stream (bool, default=true)
	â€¢	enable_recording_fallback (bool, default=true)
	â€¢	enable_payments_paypal (bool, default=false)
	â€¢	enable_payments_tranzila (bool, default=false)

×‘×›×œ ×›× ×™×¡×” ×œÖ¾WS/Webhook/API:
	â€¢	×§×¨× business_id (××•×¢×‘×¨ ×›Ö¾<Parameter> ×‘Ö¾Stream).
	â€¢	×× enable_calls_stream=false â†’ ×“×œ×’ ×™×©×¨ ×œÖ¾<Record ...>.

â¸»

7) ×ª×©×œ×•××™× â€” ×œ×œ× Stripe (IL-Ready), Stub ×‘×œ×‘×“ ×¢×“ ××¤×ª×—×•×ª
	â€¢	×”×¡×¨ ×¡×¤×¨×™×™×ª Stripe ×•×ª×œ×•×™×•×ª×™×™×”. ××™×Ÿ ×œ×”×©×ª××© ×‘Ö¾Stripe ×›×œ×œ.
	â€¢	×× ×§×™×™××™× × ×ª×™×‘×™ Stripe ×”×™×¡×˜×•×¨×™×™× â€” ××•×¤×¦×™×•× ×œ×™×ª ×”×©××¨ â€œ×¤×§×§â€ ×©××—×–×™×¨ 410 GONE ×¢× ×”×•×“×¢×” "Stripe is not supported in IL. Use PayPal or Tranzila."; ××—×¨×ª ××—×§.
	â€¢	×‘Ö¾server/api_crm_unified.py:
	â€¢	PayPal: ×ª××™×›×ª Token/Order base ×§×™×™××ª. ××œ ×ª×’×‘×” ×‘×¤×•×¢×œ ×¢×“ ×©×”×•×–× ×• ××¤×ª×—×•×ª ×•×œ×‘×™×–× ×¡ ×”×•×¤×¢×œ ×”×“×’×œ.
	â€¢	×× ×—×¡×¨×™× PAYPAL_CLIENT_ID/SECRET ××• ×”×“×’×œ ×›×‘×•×™ â†’ ×”×—×–×¨ 501/403 (×œ× 500).
	â€¢	×× ×§×™×™× â€” ×”×—×–×¨ {"provider":"paypal","status":"stub_ready"} (200).
	â€¢	Tranzila: ×©××•×¨ Stub (URL ×‘×¡×™×¡ ×œ×¤×™ TRANZILA_ENV), ×œ×œ× ×—×™×•×‘ ×××™×ª×™ ×¢×“ ×©×™×•×’×“×¨×• ××¤×ª×—×•×ª.
	â€¢	×—×¡×¨ ×§×•× ×¤×™×’/×“×’×œ ×›×‘×•×™ â†’ 501/403; ×§×™×™× â†’ {"provider":"tranzila","status":"stub_ready"} (200).
	â€¢	××™×Ÿ ××¦×‘ ×©×œ 500 ×‘×ª×©×œ×•××™× â€” ×”×©×ª××© ×‘Ö¾400/403/409/501 ×œ×¤×™ ×”×”×§×©×¨.

â¸»

8) ××™×’×¨×¦×™×•×ª DB (××“×¤×˜×™×‘×™×•×ª, ×œ×œ× DROP)

×¦×•×¨ server/db_migrate.py ×©××•×¡×™×£ ×× ×—×¡×¨:
	â€¢	×¢××•×“×” CallLog.transcript (TEXT, nullable).
	â€¢	×˜×‘×œ×” CallTurn (×¢×´×¤ ×¡×¢×™×£ 4).
	â€¢	×¢××•×“×•×ª ×“×’×œ×™× ×‘×˜×‘×œ×ª Business (×¢×´×¤ ×¡×¢×™×£ 6).
	â€¢	×”×“×¤×¡ Applied migration: <name>; ×× ×§×™×™× â€” ×“×œ×’ (×œ×œ× DROP).

â¸»

9) Endpoints ×‘×¨×™××•×ª/××•×›× ×•×ª/×’×¨×¡×”

×‘Ö¾create_app():

@app.get("/healthz")
def healthz(): return "ok", 200

@app.get("/readyz")
def readyz():
    # ×‘×“×™×§×ª DB, ×§×™×•× OPENAI_API_KEY, ×§×•×‘×¥ Google TTS (×× × ×“×¨×©),
    # ×”×—×–×¨ JSON { db:"ok|fail", openai:"ok|disabled", tts:"ok|disabled", payments:{paypal:"enabled|disabled", tranzila:"enabled|disabled"} }
    ...

@app.get("/version")
def version():
    return {"app":"AgentLocator","commit":os.getenv("GIT_COMMIT","dev"),"build_time":os.getenv("BUILD_TIME","dev")}

	â€¢	××™×Ÿ 500 â€” ×’× ×× ××©×”×• ×—×¡×¨, ×”×—×–×¨ ×¡×˜×˜×•×¡ JSON â€œdisabledâ€/â€œfailâ€ ×•×”××©×š 200.

â¸»

10) ×œ×•×’ ××¨×›×–×™ ×‘×¤×•×¨××˜ JSON + Rotating Files

×‘Ö¾server/logging_setup.py:
	â€¢	Console: JSON formatter ×¢× ×©×“×•×ª: ts, level, module, path, call_sid, business_id, msg, extra.
	â€¢	×§×•×‘×¥ ××¡×ª×•×‘×‘: logs/app.log (RotatingFileHandler, 10MBÃ—5).
	â€¢	×”×ª×§×Ÿ hooks ×œ×¤× ×™/××—×¨×™ ×‘×§×©×” ×œ×©×™×•×š call_sid/business_id ×œÖ¾log context (×× ×–××™×Ÿ).

â¸»

11) ×§×•× ×¤×™×’ ×¡×•×“×•×ª (Bootstrap) â€” Graceful Degrade

×‘Ö¾server/bootstrap_secrets.py:
	â€¢	×× ×—×¡×¨ OPENAI_API_KEY â†’ NLP_DISABLED=true, ×”××¢×¨×›×ª ×œ× ×§×•×¨×¡×ª; ×ª×©×•×‘×ª ××¢×¨×›×ª ×“×™×¤×•×œ×˜×™×ª: â€œ×›×¨×’×¢ ××™× ×™ ×¤× ×•×™â€.
	â€¢	×× ×—×¡×¨ GOOGLE_APPLICATION_CREDENTIALS â†’ TTS_DISABLED=true; ×”×—×–×¨ ×©×§×˜ ×§×¦×¨ ×‘××§×•× TTS.
	â€¢	×”×“×¤×¡ WARN ×‘×¨×•×¨ ×¢×œ ×›×œ ××©×ª× ×” ×—×¡×¨.

â¸»

12) .replit / ×”×¨×¦×”

×•×“× .replit:

modules = ["nodejs-20","web","postgresql-16","python-3.11"]
run = "python3 AgentLocator/main.py"
hidden = [".config",".git","node_modules","dist",".local","static/voice_responses","logs"]

	â€¢	PORT ××”×¡×‘×™×‘×”; debug ×¨×§ ×× FLASK_ENV=development.

â¸»

13) ×‘×“×™×§×ª ×¤×¨×™×¡×” (â€œGolden Pathâ€) â€” ×¡×§×¨×™×¤×˜ ××•×˜×•××˜×™

×¦×•×¨ server/deploy_check.py â€” ××¨×™×¥ ×‘×“×™×§×•×ª ×•××“×¤×™×¡ ×“×•×— âœ…/âŒ:
	1.	GET /healthz == 200 "ok"
	2.	GET /readyz == 200; JSON ×›×•×œ×œ ×¡×˜×˜×•×¡×™× (db, openai, tts, payments)
	3.	POST /webhook/incoming_call (×¡×™××•×œ×¦×™×”) â†’ ××›×™×œ <Connect><Stream> ×•Ö¾action="/webhook/stream_ended"
	4.	POST /webhook/stream_ended â†’ ××—×–×™×¨ <Record ... action="/webhook/handle_recording">
	5.	POST /webhook/handle_recording ×¢× URL ×“××” â†’ 204/200 ××™×™×“×™; Thread × ×¨×©× ×‘×œ×•×’
	6.	POST /api/crm/payments/create:
	â€¢	enable_payments_paypal=false â†’ 403/501
	â€¢	enable_payments_paypal=true ×œ×œ× ××¤×ª×— â†’ 501 ×¢× ×”×•×“×¢×” ××¡×•×“×¨×ª (×œ× 500)
	â€¢	×›× ×´×œ ×œÖ¾Tranzila
	7.	×•×“× ×©××™×Ÿ import ××ª×•×š legacy/
	8.	×‘×¦×¢ ×”×“××™×™×ª turn WS (××• ×§×¨×™××ª Mock) â€” ×œ×•×’ turn_metrics × ×¨×©×, ×××•×¦×¢ < 2500ms
	9.	×”×“×¤×¡ ×¡×™×›×•×:

âœ… healthz
âœ… readyz
âœ… stream->action
âœ… fallback record
âœ… whisper pipeline
âœ… payments flags (PP/TZ)
âœ… no-legacy-imports
âœ… turn_metrics logged (< 2500ms avg)



â¸»

14) Definition of Done (Go / No-Go)

â€œ×™×¨×•×§â€ ×œ××¢×‘×¨ ×œÖ¾UI ×¨×§ ××:
	â€¢	×›×œ ×‘×“×™×§×•×ª ×¡×¢×™×£ 13 âœ…
	â€¢	turn_metrics ×××•×¦×¢ < 2500ms
	â€¢	stream_failover -> recording ×¤×•×¢×œ ×•××ª×•×¢×“ ×‘×œ×•×’
	â€¢	××™×Ÿ import ×Ö¾legacy/
	â€¢	/readyz ×•Ö¾/version ×¤×•×¢×œ×™×
	â€¢	×ª×©×œ×•××™×: ×œ×œ× Stripe; PayPal/Tranzila ××—×–×™×¨×™× 403/501/200 Stub ×œ×¤×™ ×“×’×œ×™× ×•××¤×ª×—×•×ª (×œ×¢×•×œ× ×œ× 500)
	â€¢	×“×•×´×— ×›×¤×™×œ×•×™×•×ª ×”×•×¤×§; ×œ× ×”×•×¡×¨ ×§×•×‘×¥ ×‘×œ×™ ×”×—×œ×¤×ª import

â¸»

×”×¢×¨×•×ª ×‘×˜×™×—×•×ª
	â€¢	××™×Ÿ ××—×™×§×•×ª ××•×˜×•××˜×™×•×ª. legacy/ × ×©××¨; ×¨×§ ××‘×•×˜×œ ×‘×™×™×‘×•×.
	â€¢	×›×œ ×©×™× ×•×™ ××©××¢×•×ª×™ ××¡×•××Ÿ ×‘×œ×•×’ CHANGED: <file> + commit ×§×˜×Ÿ ×××•×§×“.
	â€¢	Webhooks ×œ×¢×•×œ× ×œ× ××—×–×™×¨×™× 500: ×‘××§×¨×” ×›×©×œ â†’ 200/204 + ×œ×•×’ ERROR.

â¸»

×ª×•×¦××” ×¦×¤×•×™×”

××—×¨×™ ×™×™×©×•× ×”× ×´×œ:
	â€¢	×”××¢×¨×›×ª ×™×¦×™×‘×” ×œ×—×œ×•×˜×™×Ÿ, ×¢× ×œ×•×’×™× ××“×™×“×™× ×œ×›×œ â€œ×ª×•×¨×Ÿâ€.
	â€¢	Media Stream = ×‘×¨×™×¨×ª ××—×“×œ, ×¢× Fallback ××•×˜×•××˜×™ ×œÖ¾Recording.
	â€¢	×ª××œ×•×œ ×¢×‘×¨×™×ª, TTS ×¢×‘×¨×™×ª, ××‘×˜×—×” â€” ×××•××ª×™×.
	â€¢	××™×Ÿ Stripe, ×¨×§ PayPal/Tranzila ×›Ö¾Stub × ×©×œ×˜×™× ×‘×“×’×œ×™×.
	â€¢	××™×Ÿ ×›×¤×™×œ×•×™×•×ª ×¤×¢×™×œ×•×ª ×•××™×Ÿ ×™×™×‘×•× ×Ö¾legacy.
	â€¢	××•×›× ×™× ×œ×¢×‘×•×¨ ×œÖ¾UI ×‘×‘×™×˜×—×•×Ÿ.

×›×©×ª××©×¨ ×©×”×›×•×œ ×‘×•×¦×¢ ×•×¢×‘×¨ ×™×¨×•×§ â€” ×× ×™ ××•×›×Ÿ ×œ×ª×ª ××¤×™×•×Ÿ UI/UX ××¡×šÖ¾××¡×š (RTL ××œ×, Assistant font, ×”×™×¨×¨×›×™×”, ×¦×‘×¢×™×, ×˜×‘×œ××•×ª, ×•×”×¨×©××•×ª ×œ×¤×™ ×¢×¡×§ ×•×ª×¤×§×™×“).