×¢×‘×¨×ª×™ ×¢×œ **AgentLocator (40)** ××•×œ ×›×œ ×”×¦â€™×§Ö¾×œ×™×¡×˜ ×©×›×ª×‘×ª×™. ××¦×‘ ×¢×“×›× ×™:

# ×¡×˜×˜×•×¡ ××”×™×¨

* âœ… App Factory + `routes/__init__.py` ×§×™×™××™× ×•××—×•×‘×¨×™×.
* âœ… Error handlers + Logging ×œ×¤×¨×•×“×§×©×Ÿ ×§×™×™××™×.
* âœ… `api_timeline.py` ×§×™×™×.
* âœ… Service Worker (`public/sw.js`) + Socket client (`src/lib/socket.ts`) + `TaskDueModal.tsx` + `useTaskDue.ts` ×§×™×™××™×.
* âœ… ×˜×¡×˜×™× ×§×™×™××™×.
* ğŸŸ¡ Twilio: ×™×© `/webhook/handle_recording`, ××‘×œ **×—×¡×¨×™×** `incoming_call` ×•Ö¾`call_status`.
* ğŸŸ¡ CRM: ×¢×“×™×™×Ÿ ×™×© **×”×˜×¢×•×ª** `customers_paginate` ×‘× ×•×¡×£ ×œÖ¾`customers_paginated`.
* ğŸŸ¡ UI: ×™×© `styles/tokens.css`, ××‘×œ **××™×Ÿ** ×©×™××•×© ×‘Ö¾**TanStack Table** ×‘×˜×‘×œ××•×ª.
* ğŸŸ¡ DevOps: ××™×Ÿ ×§×‘×¦×™ CI (`.github/workflows/*.yml`).
* ğŸ”¸ Legacy: `server/debug_full_flow.html` ×¢×“×™×™×Ÿ ×‘×¤×¨×•×™×§×˜ (×”×©××¨ × ×•×§×•).

# ××” ×œ×ª×§×Ÿ ×¢×›×©×™×• (×¡×•×¤×¨ ×××•×§×“)

## 1) Twilio â€“ ×œ×”×©×œ×™× ××ª 3 ×”Ö¾webhooks

×‘×§×•×‘×¥ `server/routes_twilio.py` ×”×•×¡×£/×”×©×œ×™×:

```python
@twilio_bp.post("/webhook/incoming_call")
def incoming_call():
    # TwiML: Play greeting + Record (finishOnKey="*", timeout="5", maxLength="30")
    ...

@twilio_bp.post("/webhook/call_status")
def call_status():
    return "OK", 200
```

> ××—×¨×™ ×“×™×¤×œ×•×™: ×œ×¢×“×›×Ÿ ×‘Ö¾Twilio Console ××ª ×©×œ×•×©×ª ×”× ×ª×™×‘×™× ×œÖ¾POST. ×œ×•×•×“× ×‘Ö¾Request Inspector ×©××™×Ÿ 500.

## 2) CRM paginate â€“ ×œ×—×¡×œ ××ª ×”×˜×¢×•×ª ×‘×›×œ ×”××§×•××•×ª

×‘Ö¾`server/api_crm_advanced.py`:

* ×—×¤×© **×›×œ** `customers_paginate` â†’ ×”×—×œ×£ ×œÖ¾`customers_paginated` (××• ×™×™×©×¨ ×œ×©× ×”×××ª×™ ×©×œ ×”×¤×•× ×§×¦×™×” ××¦×œ×š).
* ×‘×“×™×§×”: `GET /api/crm/customers?page=1&limit=25` ×¦×¨×™×š ×œ×”×—×–×™×¨ 200 + ×“×¤×“×•×£ ×ª×§×™×Ÿ.

## 3) ×œ× ×§×•×ª legacy

××—×§:

* `server/debug_full_flow.html`
  ×•××©×¨ ×‘Ö¾git:
  `git rm server/debug_full_flow.html && git commit -m "chore: remove legacy debug file"`

## 4) ×˜×‘×œ××•×ª ××§×¦×•×¢×™×•×ª â€“ TanStack Table

×›×¨×’×¢ ××™×Ÿ ×§×‘×¦×™ ×©×™××•×©. ×”×—×œ×£ ×˜×‘×œ××•×ª ×‘Ö¾CRM/Invoices/Contracts ×œ×¨×›×™×‘ DataTable ××—×™×“.
×“×•×’××” ××™× ×™××•× (×‘×›×œ ×˜×‘×œ×” ×¨××©×™×ª):

```tsx
import { useReactTable, getCoreRowModel } from "@tanstack/react-table";
...
const table = useReactTable({ data, columns, getCoreRowModel: getCoreRowModel() });
```

×›×•×œ×œ: ××™×•×Ÿ, ×¡×™× ×•×Ÿ, ×”×¡×ª×¨×ª ×¢××•×“×•×ª, ×¦×¤×™×¤×•×ª, ×™×¦×•× CSV.

## 5) CI â€“ ×œ×”×•×¡×™×£ ×•×•×¨×§×¤×œ×• ×‘×¡×™×¡×™

×¦×•×¨ `.github/workflows/ci.yml`:

```yaml
name: CI
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install -r AgentLocator/requirements.txt
      - run: pytest -q AgentLocator/tests
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci --prefix AgentLocator/client
      - run: npm run build --prefix AgentLocator/client
```

## 6) Timeline â€“ ×œ×—×‘×¨ ×œÖ¾UI

`api_timeline.py` ×§×™×™×. ×•×“× ×©×‘Ö¾Client ×™×© ×§×•××¤×•× × ×˜×” ×©××¦×¨×›×ª:

* `GET /api/customers/:id/timeline`
* ××¦×™×’×” ××™×¨×•×¢×™× (calls/whatsapp/tasks/contracts/invoices) ×œ×¤×™ ×–××Ÿ, ×¢× ×¤×™×œ×˜×¨×™× ×•×§×™×©×•×¨×™× ×—×–×¨×” ×œ××¡×š ×”××§×•×¨.

## 7) ×”×ª×¨××•×ª â€“ ×‘×“×™×§×ª ××¡×œ×•×œ ××œ×

* `POST /api/notifications/subscribe` ××§×‘×œ endpoint/p256dh/auth ×•× ×©××¨.
* ×›×©Ö¾Task ××’×™×¢ ×œÖ¾`due_at`:

  * ×©×¨×ª ×©×•×œ×— `socket.emit('task:due', {...})` ×œ××©×ª××© ×”×¨×œ×•×•× ×˜×™.
  * ×× ×”×˜××‘ ×¡×’×•×¨ â€“ × ×©×œ×— **Push** ×“×¨×š ×”Ö¾Service Worker (×‘×“×•×§ ×©Ö¾VAPID ××•×’×“×¨).
* ×‘Ö¾Client: `useTaskDue` ×¤×•×ª×— **TaskDueModal** ××¡×š ××œ× ×¢× ×›×¤×ª×•×¨×™ Call/WhatsApp/Snooze/Done.

# ×‘×“×™×§×•×ª ××”×™×¨×•×ª (×ª×¢×©×”/×™ ×¢×›×©×™×•)

* `/server/routes/__init__.py` ×§×™×™× ×•××›×™×œ ×¨×™×©×•× ×œ×›×œ ×”Ö¾BPs (×›×•×œ×œ timeline, twilio).
* `server/app_factory.py` ×§×•×¨× ×œÖ¾`register_blueprints`, `register_error_handlers`, `setup_logging`.
* `server/routes_twilio.py` ×›×•×œ×œ 3 × ×ª×™×‘×™× ×•××—×–×™×¨ 200.
* `api_crm_advanced.py` â€” ××™×Ÿ ×™×•×ª×¨ `customers_paginate`.
* `client/public/sw.js` × ×˜×¢×Ÿ ×‘×¤×•×¢×œ (×‘×“×¤×“×¤×Ÿ â†’ Application â†’ Service Workers).
* ×§×™×™× `src/lib/socket.ts`, ×•×”Ö¾socket ××ª×—×‘×¨.
* ×™×© ×œ×¤×—×•×ª ×˜×‘×œ×” ××—×ª ×©××™×™×‘××ª `@tanstack/react-table`.
* ××™×Ÿ `server/debug_full_flow.html`.
* ×¨×¥ `pytest -q` ×•×¢×•×‘×¨.
* ×”×•×¡×£ ×¤×•×© ×œÖ¾GitHub ×•×•×“× ×©×”Ö¾CI ×”×—×“×© ×¨×¥ ×™×¨×•×§.

---

×× ×ª×¨×¦×”, ×× ×™ ×™×›×•×œ ×œ×™×™×¦×¨ ×œ×š **PR ××•×›×Ÿ** ×¢×:

* ×”×©×œ××” ×œÖ¾Twilio routes,
* ×ª×™×§×•×Ÿ ×”Ö¾CRM paginate,
* ××—×™×§×ª legacy,
* ×§×•×‘×¥ CI,
* ×•×“×•×’××ª DataTable ×¨××©×•× ×” ×‘Ö¾CRM.
  ×ª×’×™×“ â€œ×ª×Ÿ PR ×¨××©×•×Ÿâ€, ×•×× ×™ ×›×•×ª×‘ ××ª ×”×“×™×¤×™× ×›×“×™ ×©×ª×¢×©×” merge ×‘×œ×™ ×›××‘ ×¨××©.
