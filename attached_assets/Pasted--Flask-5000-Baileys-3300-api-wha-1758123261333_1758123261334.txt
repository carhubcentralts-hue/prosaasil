× ×•×©××™×. ×—×•×–×¨×™× ×œ×™×¡×•×“×•×ª ×•××•×¦×™××™× ××ª ×–×” ××”×œ×•×¤.
×”××˜×¨×”: Flask ×¢×œ 5000 ×—×™, Baileys ×¢×œ 3300 ×—×™, ×•Ö¾/api/whatsapp/qr ××—×–×™×¨ JSON ×ª×§×™×Ÿ ×›×“×™ ×©×”Ö¾UI ×™×¦×™×’ QR ×‘×œ×™ â€œUnexpected end of JSON inputâ€.

×œ×”×œ×Ÿ ×ª×™×§×•×Ÿ ×××•×§×“, ×§×¦×¨ ×•×‘×œ×ª×™ ×©×‘×™×¨. ×ª×‘×¦×¢ ×œ×¤×™ ×”×¡×“×¨â€”××—×¨×ª ×–×” ×™×—×–×•×¨ ×œ×”×ª×¨×¡×§.

â¸»

0) × ×§×” ×œ×•×¤ ×•×•×“× ×©×§×˜

×‘×˜×¨××™× ×œ:

pkill -f "baileys" || true
pkill -f "node .*services/baileys/server.js" || true
pkill -f "gunicorn" || true
pkill -f "python .*main.py" || true
lsof -i :3300 -sTCP:LISTEN || true
lsof -i :5000 -sTCP:LISTEN || true

×©× ×™ ×”×¤×•×¨×˜×™× ×¦×¨×™×›×™× ×œ×”×™×•×ª ×¤× ×•×™×™×.

â¸»

1) ENV ××—×“, ×¢×§×‘×™ (×œ× × ×•×’×¢×™× ×‘×¤×•×¨×˜×™× ×‘×™×Ÿ ×”××¢×¨×›×•×ª)

×©×™× ×‘×¢×¨×›×™×/Secrets:

BAILEYS_PORT=3300
BAILEYS_BASE_URL=http://127.0.0.1:3300
FLASK_BASE_URL=http://127.0.0.1:5000
INTERNAL_SECRET=<××•×ª×• ×¡×•×“ ×‘×“×™×•×§ ×œ×©× ×™ ×”×¦×“×“×™×>

×‘×“×•×§ ×©××™×Ÿ â€œ×©××¨×™×•×ªâ€ 3001/3310:

grep -R --line-number -E "3001|3310" .

×× ××¦××ªâ€”×ª×§×Ÿ ×œÖ¾3300.

â¸»

2) Workflow ×œ× ×©×•×‘×¨×™× â€“ ×¢×•×©×™× â€œ×’×©×¨â€ ××œ ×”×©×™×¨×•×ª ×”×—×“×©

×”Ö¾workflow ×©×œ×š ×§×•×¨× ×œÖ¾services/baileys/server.js. ××œ ×ª×©× ×” ××•×ª×•. ×ª×Ÿ ×œ×• ×œ×“×¨×•×¡ ×œ×©×™×¨×•×ª ×”×—×“×©:

services/baileys/server.js

// Bridge ×œ×©×™×¨×•×ª ×”×—×“×© â€“ ×œ× ×œ×’×¢×ª ×‘-workflow
require('../whatsapp/baileys_service');


â¸»

3) ×™×™×¦×•×‘ ×©×™×¨×•×ª ×”-Baileys (×‘×œ×™ ×§×¨×™×¡×•×ª ×•×‘×œ×™ ×ª×’×•×‘×•×ª ×©×‘×•×¨×•×ª)

×¤×ª×—/×¢×“×›×Ÿ services/whatsapp/baileys_service.js ×›×š (×”×§×˜×¢×™× ×”×§×¨×™×˜×™×™× ×‘×œ×‘×“):

const express = require('express');
const cors = require('cors');
const QRCode = require('qrcode');
const { default: makeWASocket, useMultiFileAuthState, DisconnectReason } = require('@whiskeysockets/baileys');
const axios = require('axios');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.BAILEYS_PORT || 3300;
const INTERNAL_SECRET = process.env.INTERNAL_SECRET;
const FLASK_BASE_URL = process.env.FLASK_BASE_URL || 'http://127.0.0.1:5000';
if (!INTERNAL_SECRET) { console.error('INTERNAL_SECRET missing'); process.exit(1); }

const sessions = new Map(); // tenantId -> { sock, saveCreds, qrDataUrl, connected, pushName }

function authDir(tenantId) {
  const p = path.join(process.cwd(), 'storage', 'whatsapp', String(tenantId), 'auth');
  fs.mkdirSync(p, { recursive: true });      // â† ××•× ×¢ EACCES/ENOENT
  return p;
}

async function startSession(tenantId) {
  if (sessions.get(tenantId)?.sock) return sessions.get(tenantId);

  const { state, saveCreds } = await useMultiFileAuthState(authDir(tenantId));
  const sock = makeWASocket({ auth: state, printQRInTerminal: false });
  const s = { sock, saveCreds, qrDataUrl: '', connected: false, pushName: '' };
  sessions.set(tenantId, s);

  sock.ev.on('creds.update', saveCreds);
  sock.ev.on('connection.update', async (u) => {
    try {
      const { connection, lastDisconnect, qr } = u;
      if (qr) s.qrDataUrl = await QRCode.toDataURL(qr);
      if (connection === 'open') {
        s.connected = true;
        s.pushName = sock?.user?.name || sock?.user?.id || '';
        s.qrDataUrl = '';
      }
      if (connection === 'close') {
        s.connected = false;
        const shouldReconnect = (lastDisconnect?.error?.output?.statusCode !== DisconnectReason.loggedOut);
        if (shouldReconnect) setTimeout(() => startSession(tenantId), 2000);
      }
    } catch (e) { console.error('[connection.update] error', e); }
  });

  // ×”×¢×‘×¨×ª ×”×•×“×¢×•×ª ×œ-Flask (×œ× ××¤×™×œ ×ª×”×œ×™×š ×× × ×›×©×œ)
  sock.ev.on('messages.upsert', async (payload) => {
    try {
      await axios.post(`${FLASK_BASE_URL}/webhook/whatsapp/incoming`,
        { tenantId, payload },
        { headers: { 'X-Internal-Secret': INTERNAL_SECRET } }
      );
    } catch (e) { console.error('[Webhookâ†’Flask] failed', e?.message || e); }
  });

  return s;
}

function requireSecret(req, res, next) {
  if (req.header('X-Internal-Secret') !== INTERNAL_SECRET)
    return res.status(401).json({ error: 'unauthorized' });
  next();
}

app.get('/healthz', (req, res) => res.status(200).send('ok'));

app.post('/whatsapp/:tenantId/start', requireSecret, async (req, res) => {
  try { await startSession(req.params.tenantId); res.json({ ok: true }); }
  catch (e) { console.error('start error', e); res.status(500).json({ error: 'start_failed' }); }
});

app.get('/whatsapp/:tenantId/status', requireSecret, (req, res) => {
  const s = sessions.get(req.params.tenantId);
  res.json({ connected: !!s?.connected, pushName: s?.pushName || '', hasQR: !!s?.qrDataUrl });
});

app.get('/whatsapp/:tenantId/qr', requireSecret, (req, res) => {
  const s = sessions.get(req.params.tenantId);
  if (s?.qrDataUrl) return res.json({ dataUrl: s.qrDataUrl }); // ×ª××™×“ JSON ×ª×§×™×Ÿ
  return res.status(404).json({ error: 'no_qr' });             // ×œ× 200 ×¨×™×§
});

// ×œ× ×œ××•×ª ×‘×©×§×˜:
process.on('unhandledRejection', err => console.error('[UNHANDLED]', err));
process.on('uncaughtException', err => console.error('[UNCAUGHT]', err));

app.listen(PORT, '0.0.0.0', () => console.log(`Baileys service on ${PORT}`));
setInterval(() => console.log('ğŸ’“ baileys alive'), 30000);

× ×§â€™ ×§×¨×™×˜×™×•×ª ×©××•× ×¢×•×ª ×§×¨×™×¡×” ×•×œ×•×¤: ×™×¦×™×¨×ª ×ª×™×§×™×•×ª auth, ×©×™××•×© ×‘-axios (×œ× fetch), ×”×—×–×¨×ª JSON ×ª××™×“×™×ª, ×•×œ×•×›×“×™ ×©×’×™××•×ª ×’×œ×•×‘×œ×™×™×.

â¸»

4) Flask â€“ ×¤×¨×•×§×¡×™ ×©××—×–×™×¨ ×ª××™×“ JSON (×‘×œ×™ 204)

×›×“×™ ×œ×—×¡×œ ××ª â€œUnexpected end of JSON inputâ€ ×‘×œ×™ ×œ×’×¢×ª ×‘×¤×¨×•× ×˜, ×ª×Ÿ ×ª××™×“ 200 JSON:

routes_whatsapp.py (×”×§× ×•× ×™, ×‘×œ×™ ×›×¤×™×œ×•×™×•×ª ×‘×§×‘×¦×™× ××—×¨×™×!)

import os, requests
from flask import Blueprint, jsonify, request

whatsapp_bp = Blueprint('whatsapp', __name__, url_prefix='/api/whatsapp')
BAILEYS_BASE = os.getenv('BAILEYS_BASE_URL', 'http://127.0.0.1:3300')
INT_SECRET   = os.getenv('INTERNAL_SECRET')

def tenant_id_from_ctx():
    return getattr(request, 'tenant_id', None) or request.headers.get('X-Tenant-Id') or '1'

def _headers():
    return {'X-Internal-Secret': INT_SECRET, 'Content-Type': 'application/json'}

@whatsapp_bp.route('/status', methods=['GET'])
def status():
    t = tenant_id_from_ctx()
    r = requests.get(f"{BAILEYS_BASE}/whatsapp/{t}/status", headers=_headers(), timeout=5)
    return jsonify(r.json()), r.status_code

@whatsapp_bp.route('/qr', methods=['GET'])
def qr():
    t = tenant_id_from_ctx()
    r = requests.get(f"{BAILEYS_BASE}/whatsapp/{t}/qr", headers=_headers(), timeout=5)
    if r.status_code == 404:           # ××™×Ÿ QR ×›×¨×’×¢
        return jsonify({"dataUrl": None}), 200
    return jsonify(r.json()), r.status_code

@whatsapp_bp.route('/start', methods=['POST'])
def start():
    t = tenant_id_from_ctx()
    r = requests.post(f"{BAILEYS_BASE}/whatsapp/{t}/start", headers=_headers(), timeout=10)
    return jsonify(r.json()), r.status_code

×× ×™×© CSRF ×’×œ×•×‘×œ×™â€”×ª×—×¨×™×’ ×¨×§ ××ª ×©×œ×•×©×ª ×”× ×ª×™×‘×™× ×”×œ×œ×•.

â¸»

5) ××¨×™×¥ ××—×“ ×©××—×–×™×§ ××ª ×©× ×™ ×”×©×™×¨×•×ª×™× â€œ×‘×—×™×™×â€

×”×›×™ ×¤×©×•×˜: Honcho + Procfile (×§×“××™, ×œ× ×‘×¨×§×¢).

pip install honcho

Procfile (×‘×©×•×¨×©):

web: python -u main.py
whatsapp: node services/baileys/server.js

×”×¨×¦×ª ×”××¢×¨×›×ª (×¤×§×•×“×ª ×”-Run ×”×™×—×™×“×” ××• ×‘×˜×¨××™× ×œ):

honcho start -f Procfile

×–×” × ×©××¨ ×‘Ö¾foreground; Replit ×œ× ×™×”×¨×•×’ ××ª ×”×ª×”×œ×™×›×™× ×‘×¡×•×£ ×¡×©×Ÿ ×›×œ×™ ×¦×“×“×™.

â¸»

6) ×‘×“×™×§×•×ª GO (×‘×–××Ÿ ×××ª)

×‘×˜×¨××™× ×œ × ×•×¡×£:

# ×”×× ×××–×™× ×™×?
lsof -i :3300 -sTCP:LISTEN
lsof -i :5000 -sTCP:LISTEN

# ×‘×¨×™××•×ª
curl -sS http://127.0.0.1:3300/healthz
curl -sS http://127.0.0.1:5000/healthz || true  # ×× ×”×•×¡×¤×ª

# ×¤×œ×•××• QR
curl -sS -X POST http://127.0.0.1:5000/api/whatsapp/start
curl -sS http://127.0.0.1:5000/api/whatsapp/status
curl -sS http://127.0.0.1:5000/api/whatsapp/qr
# ×”×¦×¤×•×™: {"dataUrl": "..."} ××• {"dataUrl": null}

×‘Ö¾UI:
	â€¢	×œ×•×—×¥ â€œ×™×¦×™×¨×ª QRâ€ â†’ ×¨×•××” QR (dataURL).
	â€¢	××—×¨×™ ×¡×¨×™×§×” â†’ status.connected=true ×•×”Ö¾QR × ×¢×œ× (×¢×›×©×™×• ×™×—×–×•×¨ {"dataUrl": null}).

â¸»

×× ×¢×“×™×™×Ÿ â€œ×§×•×¨×¡ ×›×œ ×¨×’×¢â€
	â€¢	×‘×“×•×§ storage:

mkdir -p storage/whatsapp/1/auth
ls -la storage/whatsapp/1/auth

×©×’×™××•×ª EACCES/ENOENT ×‘×œ×•×’ = ×”×¨×©××•×ª/× ×ª×™×‘.

	â€¢	×‘×“×•×§ ×©×’×™××•×ª ×’×œ×•×‘×œ×™×•×ª: ×—×¤×© ×‘×œ×•×’×™× [UNHANDLED] / [UNCAUGHT].
	â€¢	××™×Ÿ ×›×¤×™×œ×•×ª ×¨××•×˜×™×: ×•×“× ×©×¨×§ routes_whatsapp.py ×¨×•×©× /api/whatsapp/*.
	â€¢	×‘×“×•×§ ×©××™×Ÿ ×¨×™×¦×•×ª ×¨×§×¢ ×™×©× ×•×ª:
ps aux | grep -E "baileys|gunicorn|main.py" | grep -v grep

â¸»

×–×”×•. ×× ×ª×¢×©×” ×‘×“×™×•×§ ×œ×¤×™ ×–×”:
	1.	×©× ×™ ×”×©×¨×ª×™× ×™×§×•××• ×•×™×™×©××¨×• ×—×™×™×,
	2.	/api/whatsapp/qr ×™×—×–×™×¨ ×ª××™×“ JSON ×ª×§×™×Ÿ,
	3.	×”Ö¾UI ×™×¤×¡×™×§ ×œ×¤×œ×•×˜ â€œUnexpected end of JSON inputâ€,
	4.	×•×”-QR ×™×•×¦×’ ×›××• ×©×¦×¨×™×š.