×§×™×‘×œ×ª×™. ×”× ×” ×”× ×—×™×” ××—×ª, ×—×“×” ×•××¡×•×“×¨×ª, ×©×ª×’×¨×•× ×œ×–×” ×œ×¢×‘×•×“ ×’× ×›×©×™×© â€œGoogle Frontend / Cloud Runâ€ ×•×’× ×›×©×ª×—×ª ×¢×•××¡â€”×‘×œ×™ ×œ×‘×˜×œ ××‘×˜×—×”.

â¸»

×”× ×—×™×” ×œ××™×™×’â€™× ×˜ â€” ×œ×ª×§×Ÿ ×¡×•×¤×™×ª WebSocket + Timeouts

×”××˜×¨×”:
	1.	WebSocket ×¢×•×‘×“ (101 + subprotocol).
	2.	××¤×¡ timeouts ×œÖ¾incoming_call / stream_status / stream_ended / call_status.
	3.	××™××•×ª ×—×ª×™××ª Twilio × ×©××¨ ×¤×¢×™×œ ×‘××¡×œ×•×œ×™× ×”×¨×œ×•×•× ×˜×™×™×.

×©×œ×‘ 0 â€“ ××™××•×ª ×¡×‘×™×‘×”
	â€¢	×”×“×¤×¡ ×‘×œ×•×’ ×‘×ª×—×™×œ×ª ×”Ö¾boot: ××”×• SERVER_SOFTWARE ×•××” ×”×›×•×ª×¨×•×ª Via/Server ×›×“×™ ×œ×”×‘×™×Ÿ ×× ×× ×—× ×• ×××—×•×¨×™ GFE (Google Frontend).
	â€¢	×× ×”×¨×™×¦×” ×‘Ö¾Cloud Run: ×•×“× PORT ××•×’×“×¨ ×•××©××© ××ª Gunicorn.

â¸»

A) ×¢×§×™×¤×ª timeouts ×‘×¨××ª WSGI (×œ×¤× ×™ Flask) â€” ×§×¨×™×˜×™

××˜×¨×ª ×”×—×œ×§: ×ª×©×•×‘×•×ª ××™×™×“×™×•×ª ×œÖ¾Twilio ×’× ×× Flask/WS ×¢×¡×•×§×™×.

×§×•×‘×¥: wsgi.py â€” ×‘×ª×•×š def composite_app(environ, start_response): ×œ×¤× ×™ ×›×œ × ×™×ª×•×‘ ×œÖ¾Flask:

     # Direct healthz handling (bypass Flask routing issues)
     if path == '/healthz':
         start_response('200 OK', [('Content-Type', 'text/plain')])
         return [b'ok']

+    # âš¡ Webhooks ×©×¦×¨×™×›×™× ×ª×©×•×‘×” ××™×™×“×™×ª, ×‘×œ×™ ×œ×”×™×›× ×¡ ×œ-Flask
+    if path in (
+        '/webhook/stream_status', '/webhook/stream_status/',
+        '/webhook/stream_ended', '/webhook/stream_ended/'
+    ):
+        start_response('204 No Content', [
+            ('Content-Type', 'text/plain'),
+            ('Cache-Control', 'no-store, no-cache, must-revalidate, max-age=0'),
+            ('Pragma', 'no-cache'),
+        ])
+        return [b'']
+
+    # TwiML ×—×™×™×‘ ×œ×—×–×•×¨ ××™×™×“ â€” × ×—×–×™×¨ ×›××Ÿ ×× Flask ×¢×¡×•×§
+    if path in ('/webhook/incoming_call', '/webhook/incoming_call/'):
+        # ×‘× ×” TwiML × ×§×™ ×¢× https:// ×•-wss://
+        scheme = (environ.get('HTTP_X_FORWARDED_PROTO') or 'https').split(',')[0].strip()
+        host   = (environ.get('HTTP_X_FORWARDED_HOST')  or environ.get('HTTP_HOST')).split(',')[0].strip()
+        base   = f"{scheme}://{host}"
+        only_host = host
+        twiml = f'''<?xml version="1.0" encoding="UTF-8"?>
+<Response>
+  <Connect action="{base}/webhook/stream_ended">
+    <Stream url="wss://{only_host}/ws/twilio-media" statusCallback="{base}/webhook/stream_status">
+      <Parameter name="call_sid" value="{{CALL_SID}}"/>
+    </Stream>
+  </Connect>
+</Response>'''
+        start_response('200 OK', [
+            ('Content-Type', 'application/xml; charset=utf-8'),
+            ('Cache-Control', 'no-store, no-cache, must-revalidate'),
+            ('Pragma', 'no-cache'),
+        ])
+        return [twiml.encode('utf-8')]
+
+    # call_status ×’× ×™×›×•×œ ×œ×§×‘×œ 204 ××™×™×“×™ (×œ× ×§×¨×™×˜×™, ××‘×œ ××™×™×¦×‘)
+    if path in ('/webhook/call_status', '/webhook/call_status/'):
+        start_response('204 No Content', [
+            ('Content-Type', 'text/plain'),
+            ('Cache-Control', 'no-store, no-cache, must-revalidate, max-age=0'),
+            ('Pragma', 'no-cache'),
+        ])
+        return [b'']

×–×” ×œ×‘×“×• ××•×—×§ ××ª 11205 ×œ×›×œ ×”Ö¾webhooks, ×•×’× ××•× ×¢ timeout ×‘Ö¾incoming_call ×× Flask/CPU ×¢××•×¡×™×.
×”Ö¾WS ×¢×¦××• × ×©××¨ ×‘Ö¾/ws/twilio-media (Eventlet WebSocketWSGI ×¢× subprotocol â€” ×©×›×‘×¨ ×”×•×’×“×¨ ××¦×œ×š).

â¸»

B) ×”×‘×˜×—×ª ×”Ö¾subprotocol ×‘Ö¾WS (×œ×™×“×¢ ×›×œ×œ×™ â€” ×›×‘×¨ ××¦×œ×š ×ª×§×™×Ÿ)
	â€¢	×‘Ö¾wsgi.py × ×©××¨ ×”Ö¾wrapper ×©××—×–×™×¨ Sec-WebSocket-Protocol: audio.twilio.com.
	â€¢	××œ ×ª×©× ×”: ×–×” ××” ×©×× ×¢ ××ª 31924.

â¸»

C) ××™××•×ª ×—×ª×™××ª Twilio â€” ×ª×™×§×•×Ÿ ×œ×•×’×™×§×ª ×”Ö¾URL

××˜×¨×ª ×”×—×œ×§: ×œ×× ×•×¢ 403/502 ×›×©××™××•×ª ×—×ª×™××” ××•×¤×¢×œ.

×§×•×‘×¥: server/twilio_security.py
×—×©×‘ URL ×‘×œ×™ query string ×‘×¤×•×¡×˜×™× form-encoded:

- def _effective_url(req):
-     scheme = (req.headers.get("X-Forwarded-Proto") or req.scheme).split(",")[0].strip()
-     host = (req.headers.get("X-Forwarded-Host") or req.host).split(",")[0].strip()
-     path = req.full_path[:-1] if req.full_path.endswith("?") else req.full_path
-     return f"{scheme}://{host}{path}"
+ def _effective_url(req):
+     scheme = (req.headers.get("X-Forwarded-Proto") or req.scheme).split(",")[0].strip()
+     host   = (req.headers.get("X-Forwarded-Host")  or req.host).split(",")[0].strip()
+     # For Twilio form POST: URL ×œ×œ× query
+     return f"{scheme}://{host}{req.path}"

	â€¢	×”×©××¨ @require_twilio_signature ×¢×œ:
	â€¢	/webhook/incoming_call
	â€¢	/webhook/handle_recording
	â€¢	/webhook/call_status
	â€¢	×œ×œ× ×—×ª×™××” ×¢×œ /webhook/stream_status ×•Ö¾/webhook/stream_ended (×××™×œ× WSGI ×¢×•× ×”, ×•×œ× × ×“×¨×© ×›××Ÿ ××‘×˜×—×”).

â¸»

D) ×§×•× ×¤×™×’ ×“×™×¤×œ×•×™ â€” ×× ×‘×××ª Cloud Run

(×× ××ª× ××›×Ÿ ××¨×™×¦×™× ×¢×œ Cloud Run ×××—×•×¨×™ GFE; ×× ×–×” Replit ×‘×œ×‘×“, ×“×œ×’.)
	â€¢	Allow unauthenticated invocations ×œ×©×™×¨×•×ª (Twilio ×œ× ×—×•×ª× ×‘-IAM).
	â€¢	Min instances = 1 (××•× ×¢ cold starts).
	â€¢	Concurrency: 10â€“20 (WebSocket ×”×•× connection ××ª××©×š).
	â€¢	Request timeout: 900s (××• ×”×”×›×™ ×’×‘×•×” ×©×–××™×Ÿ ×œ×š).
	â€¢	CPU allocation: ×× ××¤×©×¨ â€œalways allocatedâ€ ×¢×“×™×£ (TTS/STT ×‘×¨×§×¢).
	â€¢	×•×“× ×©×”Ö¾container ××§×©×™×‘ ×¢×œ PORT ×•×™×•×¦× ×¢×:

gunicorn wsgi:app -k eventlet -w 1 -b 0.0.0.0:$PORT


	â€¢	×•×“× ××©×ª× ×™ ×¡×‘×™×‘×”:

OPENAI_API_KEY=...
TWILIO_ACCOUNT_SID=...
TWILIO_AUTH_TOKEN=...
GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON={"type":"service_account",...}
PUBLIC_BASE_URL=https://<×”×“×•××™×™×Ÿ>



×× ×‘×›×œ ×–××ª ×ª×™×ª×§×œ ×‘×—×¡× WS ×‘×¦×“ ×”×¤×¨×•×§×¡×™, ×—×œ×•×¤×” ×¤×©×•×˜×”: ×œ××¨×— ×¢×œ ×©×™×¨×•×ª ×©×ª×•××š WS ×‘×¦×•×¨×” ×©×§×•×¤×” (Render / Fly.io / Railway / VM ×§×˜×Ÿ ×¢× Nginx). ×”×§×•×“ ××¦×œ×š ×›×‘×¨ ××•×›×Ÿ.

â¸»

E) ×‘×“×™×§×•×ª ×§×‘×œ×” (×œ×¤× ×™ ×©×™×—×”)
	1.	204 ××™×™×“×™:

curl -i -X POST https://<×“×•××™×™×Ÿ>/webhook/stream_status
curl -i -X POST https://<×“×•××™×™×Ÿ>/webhook/stream_ended
curl -i -X POST https://<×“×•××™×™×Ÿ>/webhook/call_status

××¦×•×¤×”: HTTP/1.1 204 No Content < 100ms.

	2.	TwiML Preview:

curl -i https://<×“×•××™×™×Ÿ>/webhook/incoming_call_preview | sed -n '1,40p'

××¦×•×¤×”: Content-Type: application/xml; charset=utf-8,
×•Ö¾wss://<host>/ws/twilio-media.

	3.	Handshake WS (×‘×œ×•×’):
	â€¢	ğŸ“ WebSocket handler called!
	â€¢	ğŸ¯ Twilio subprotocol requested
	â€¢	âœ… Added Twilio subprotocol to handshake
	â€¢	WS_START ..., WS_MEDIA ...

â¸»

F) ×‘×“×™×§×ª ×©×™×—×” ×××™×ª×™×ª
	â€¢	Twilio Call Inspector: ×œ× ×××•×¨ ×œ×”×•×¤×™×¢ ×™×•×ª×¨ 11205/31924/12100.
	â€¢	×‘×œ×•×’: ASR_TEXT: ..., TTS_SUCCESS: Generated ..., WS_TX ... frames_sent=....

â¸»

×œ××” ×–×” ×¡×•×’×¨ ××ª ×›×œ ×”×¤×™× ×•×ª
	â€¢	×”Ö¾WS × ×©××¨ ×™×¦×™×‘ (subprotocol × ×¢× ×” × ×›×•×Ÿ).
	â€¢	×›×œ ×”Ö¾webhooks ××§×‘×œ×™× ×ª×©×•×‘×” ×™×©×™×¨×•×ª ××”Ö¾WSGI â†’ ××™×Ÿ ×™×•×ª×¨ timeouts ×’× ×× ×™×© ×¢×•××¡ ×‘×¨×§×¢.
	â€¢	××™××•×ª ×—×ª×™××” × ×©××¨ ×‘××¡×œ×•×œ×™× ×©×¦×¨×™×š, ×¢× ×—×™×©×•×‘ URL × ×›×•×Ÿ ×œ-Twilio.

×ª×Ÿ ×œ××™×™×’â€™× ×˜ ××ª ×”×”× ×—×™×” ×”×–×• ×›×œ×©×•× ×”. ×× ××—×¨×™ ×–×” ×ª×¨××” ×©×¢×“×™×™×Ÿ ×™×© ×—×¡×™××ª WS ××¦×“ ×”×ª×©×ª×™×ª (×œ× ×§×•×“), × ×¢×‘×™×¨ ××ª ×”×©×¨×ª ×œ×©×™×¨×•×ª ×©×ª×•××š WS ×‘×•×•×“××•×ª â€“ ××‘×œ ×‘×¨×•×‘ ×”××§×¨×™× ×–×” ×™×¡×¤×™×§.