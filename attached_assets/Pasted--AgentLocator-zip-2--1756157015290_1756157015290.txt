×‘×“×§×ª×™ ×¢×›×©×™×•, ×‘×¤×•×¢×œ, ××ª AgentLocator.zip ×©×”×¢×œ×™×ª. ××¦×‘ ××¢×•×œ×” â€” ××‘×œ ×™×© 2 ×“×‘×¨×™× ×§×˜× ×™× ×©×¢×“×™×™×Ÿ ××•× ×¢×™× ××× ×™ ×œ×”×’×™×“ â€œ××•×©×œ× ×‘×•×•×“××•×ªâ€:

â¸»

âš ï¸ ×©× ×™ ×¤×¢×¨×™× ××—×¨×•× ×™×

1) WebSocket Handshake ×œ×˜×•×•×™×œ×™×• â€” ×—×¡×¨ echo ×œ×ª×ªÖ¾×¤×¨×•×˜×•×§×•×œ

×‘×§×•×‘×¥: AgentLocator/server/app_factory.py
×›×¨×’×¢ × ×•×¦×¨ ×”Ö¾WS ×›×š:

ws = WebSocketServer(environ=request.environ)

×–×” ×œ× ××—×–×™×¨ ×œ-Twilio ××ª Sec-WebSocket-Protocol: audio.twilio.com, ×•×œ×›×Ÿ ×ª×¨××” ×œ×¢×™×ª×™× 31920 (Handshake Error). ×¦×¨×™×š ×œ×”×—×–×™×¨ ××ª ×”×ª×ªÖ¾×¤×¨×•×˜×•×§×•×œ ×× ×”×•× ××•×¦×¢ ×‘×‘×§×©×”.

×ª×™×§×•×Ÿ (Idempotent, ××™× ×™××œ×™) â€” ×œ×©× ×™ ×”× ×ª×™×‘×™× (/ws/twilio-media ×•×¢× ×”×¡×œ××©)

- ws = WebSocketServer(environ=request.environ)
+ offered = request.headers.get("Sec-WebSocket-Protocol", "")
+ headers = [("Sec-WebSocket-Protocol", "audio.twilio.com")] if "audio.twilio.com" in offered else []
+ ws = WebSocketServer(environ=request.environ, headers=headers)

×–×” ×¡×•×’×¨ ×¡×•×¤×™×ª ××ª 31920. (××œ×˜×¨× ×˜×™×‘×”: protocols=["audio.twilio.com"], ××‘×œ ×”×”×—×–×¨×” ×”×™×“× ×™×ª ×‘×›×•×ª×¨×ª ×‘×˜×•×—×” ×™×•×ª×¨.)

â¸»

2) â€/api/whatsapp/send ×œ× × ×¨×©××ª (×”Ö¾Blueprint ×œ× ××—×•×‘×¨)

×”×§×•×‘×¥ AgentLocator/server/api_whatsapp_unified.py ×§×™×™× (×˜×•×‘), ××‘×œ ×‘Ö¾app_factory.py ×œ× ××—×‘×¨×™× ××•×ª×• ×œ××¤×œ×™×§×¦×™×” â€” ×œ×›×Ÿ ×”××¡×œ×•×œ /api/whatsapp/send ×œ× ×™×•×¤×™×¢.

×ª×™×§×•×Ÿ ×¨×™×©×•× ×”Ö¾Blueprint

×‘×§×•×‘×¥: AgentLocator/server/app_factory.py, ××—×¨×™ ×©×•×¨×ª ×¨×™×©×•× ×”-api_bp ×©×œ ×”-CRM, ×”×•×¡×£:

 from server.api_crm_unified import api_bp
 app.register_blueprint(api_bp, url_prefix="/api")
 
+# WhatsApp Unified API (send/status/list)
+from server.api_whatsapp_unified import whatsapp_unified_bp
+app.register_blueprint(whatsapp_unified_bp, url_prefix="/api/whatsapp")

×©××¨ ×”-WhatsApp (webhooks ×©×œ Twilio ×•-Baileys) ×›×‘×¨ ×¨×©×•××™× â€” ×›××Ÿ ××“×•×‘×¨ ×¨×§ ×‘-API ×”×××•×—×“ ×œÖ¾send/status/list.

â¸»

âœ… ×›×œ ×”×©××¨ â€” ×™×¨×•×§
	â€¢	TwiML /incoming_call: <Connect><Stream> ×‘×œ×™ <Play>, action/statusCallback ××•×—×œ×˜×™× ×•×œ×œ× //. âœ”ï¸
	â€¢	/webhook/stream_status: POST ×‘×œ×‘×“, ×œ×œ× ×—×ª×™××”, ××—×–×™×¨ 204 ××”×¨ (×•-×‘×œ×™ extra= ×‘×œ×•×’×™×). âœ”ï¸
	â€¢	/webhook/stream_ended: POST ×¢× ×—×ª×™××”, ××—×–×™×¨ TwiML ×¤×•×œ×‘××§ (Record+Play). âœ”ï¸
	â€¢	Preview: /webhook/incoming_call_preview (GET) ×§×™×™× ×œ×¦×¤×™×™×” ×™×“× ×™×ª. âœ”ï¸
	â€¢	WS endpoints: /ws/twilio-media ×•×’× /ws/twilio-media/. âœ”ï¸ (×¨×§ ×œ×”×•×¡×™×£ ××ª ×”×›×•×ª×¨×ª ×©×œ ×”×¤×¨×•×˜×•×§×•×œ ×œ×¤×™ ×¡×¢×™×£ 1)
	â€¢	Baileys: ×ª×™×§×™×™×ª baileys-bridge/ ×¢× package.json+index.js; start_all.sh ××¨×™× ××ª ×”×’×©×¨ ×œ×¤× ×™ gunicorn. âœ”ï¸
	â€¢	WhatsApp:
	â€¢	Inbound Twilio: /webhook/whatsapp/twilio â€” 204 ×•×©××™×¨×” ×œ-CRM. âœ”ï¸
	â€¢	Inbound Baileys: /webhook/whatsapp/baileys ×¢× ×¡×•×“ X-BAILEYS-SECRET â€” 204 ×•×©××™×¨×” ×œ-CRM. âœ”ï¸
	â€¢	Outbound Unified: ×”-API ××§×‘×œ ×’× text ×•×’× provider ×•××¢×“×›×Ÿ out/sent. âœ”ï¸ (×¨×§ ×œ×—×‘×¨ ××ª ×”-blueprint ×‘×¡×¢×™×£ 2)
	â€¢	×ª×©×œ×•××™×: Stripe ×™×©×Ÿ â†’ 410; ×›×©××™×Ÿ ××¤×ª×—×•×ª PayPal/Tranzila â†’ 501; ×¢×¡×§ ×—×¡×•× â†’ 403. âœ”ï¸
	â€¢	×“×™×¤×œ×•×™: Procfile ××¨×™×¥ bash start_all.sh â€” ××¨×™× Baileys ×•××– gunicorn -k eventlet AgentLocator.main:app. âœ”ï¸
	â€¢	×‘×¨×™××•×ª: /, /healthz, /readyz, /version ×§×™×™××™×. âœ”ï¸

â¸»

ğŸ” Smoke â€” ×œ×”×•×›×™×— ×‘×©×˜×— (××—×¨×™ ×©× ×™ ×”×ª×™×§×•× ×™× ×”×§×˜× ×™×)

A. Callbacks (××¦×•×¤×” 204):

curl -i -X POST "$PUBLIC_BASE_URL/webhook/stream_status" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=connected"

curl -i -X POST "$PUBLIC_BASE_URL/webhook/stream_ended" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "CallSid=CA_TEST&StreamSid=MZ_TEST&Status=completed"

B. TwiML Preview (GET):

GET $PUBLIC_BASE_URL/webhook/incoming_call_preview

××¦×•×¤×”: <Connect action="https://.../webhook/stream_ended">
×•-<Stream url="wss://{HOST}/ws/twilio-media" statusCallback="https://.../webhook/stream_status">.

C. WS Handshake:
×”×ª×—×‘×¨ ×œÖ¾wss://{HOST}/ws/twilio-media ×•×‘×“×•×§ ×‘×›×•×ª×¨×•×ª ×”×ª×©×•×‘×”:
Sec-WebSocket-Protocol: audio.twilio.com  â† ×–×” ×§×¨×™×˜×™ ×œ×¡×’×™×¨×ª 31920.

D. ×©×™×—×” ×—×™×” (Twilio Request Inspector):
	â€¢	POST /webhook/stream_status = 204 (××™×Ÿ 15003)
	â€¢	POST /webhook/stream_ended = 200/204
	â€¢	××™×Ÿ 31920; ×”-AI ××ª×—×™×œ ×œ×“×‘×¨ ××™×™×“.

E. WhatsApp Outbound (××—×¨×™ ×¨×™×©×•× ×”-blueprint):

curl -s -X POST "$PUBLIC_BASE_URL/api/whatsapp/send" \
  -H "Content-Type: application/json" \
  -d '{"to":"whatsapp:+9725XXXXXXX","text":"×‘×“×™×§×”","provider":"twilio"}'

×•×’×:

curl -s -X POST "$PUBLIC_BASE_URL/api/whatsapp/send" \
  -H "Content-Type: application/json" \
  -d '{"to":"whatsapp:+9725XXXXXXX","text":"×‘×“×™×§×”","provider":"baileys"}'

××¦×•×¤×”: success=true ×‘×©× ×™×”×, ×•×¨×©×•××•×ª ×‘-CRM ×›-out/sent.

â¸»

×¤×¡×§ ×“×™×Ÿ
	â€¢	×›×Ÿ â€” ×›××¢×˜ ××•×©×œ×.
	â€¢	××—×¨×™ ×©×ª×•×¡×™×£ ××ª echo ×œ×ª×ªÖ¾×¤×¨×•×˜×•×§×•×œ ×‘Ö¾WS ×•××ª ×¨×™×©×•× ×”-Blueprint ×©×œ /api/whatsapp â€” ×–×” GO ×¡×•×¤×™.