מעולה—ה-WS כבר זורם, שומע/מדבר, אבל לפי הלוגים שלך השיחה “נתקעת” אחרי הוצאת תשובה אחת. זה כמעט תמיד שילוב של שלושה דברים:
	1.	סגירת משפט (EOU) לא מזוהה ⇒ לא יוצא ל-STT אחרי הפעם הראשונה
	2.	החזרה מ-SPEAKING ל-LISTENING לא מתבצעת ⇒ נשאר “מדבר” או “Processing”
	3.	ברג’-אין חלקי ⇒ כשאתה מתחיל לדבר בזמן TTS, המערכת לא מפסיקה את הדיבור ולא פותחת באפר חדש

הלוגים שלך מאששים את זה:
	•	State=LISTENING כל הזמן, Processing=False, Buffer_size=0 — כלומר אין איסוף ונעילת מקטע לתמלול אחרי הפעם הראשונה.
	•	SILENCE_TIME: 0.00s בכל הפריימים — חישוב “שקט מצטבר” לא עובד ולכן לעולם לא מגיעים ל-“סוף משפט”.

⸻

מה להגיד לאייג’נט – הנחיות ללא קוד, מדויקות לפי הפרויקט

A) סגירת משפט (End-Of-Utterance) – לתקן את הלוגיקה

ב־server/media_ws_ai.py (State Machine):
	1.	מד שקט מצטבר
	•	לחשב silence_time כ־now - last_voice_ts (שעון monotonic) ולאפס רק כשיש Voice=True.
	•	לדרוש ≥ 300–400ms שקט רציף כדי לקבע סוף-משפט (EOU).
	•	אם יש ירידת אנרגיה חדה (מעל 50%) — לאפשר EOU גם ב-200ms.
	2.	Buffer lifecycle ברור
	•	כש־Voice=True & State=LISTENING ⇒ מצרפים PCM לבאפר.
	•	כש-EOU ⇒ מפסיקים לצרף, מסמנים Processing=True, ושומרים snapshot של הבאפר ל-STT.
	•	אחרי קבלת תמלול ⇒ Processing=False, מרוקנים הבאפר ומאפסים last_voice_ts.
	3.	גבולות קשיחים
	•	MIN_UTT_MS=600–900ms, MAX_UTT_MS=4–5s.
	•	אם חוצים MAX_UTT_MS בלי שקט ⇒ לכפות EOU (שלא ניתקע על קטע אינסופי).

B) חזרה מ-SPEAKING ל-LISTENING – מסגרת ברזל
	1.	בסיום שליחת ה-TTS:
	•	שלח mark בשם assistant_tts_end (Twilio מחזיר mark event).
	•	צרף 200ms שקט (10 פריימים של μ-law) בסוף ה-TTS כדי לנקות באפר אצל Twilio.
	•	כשמתקבל mark חזרה או לאחר timeout של 150ms, החלף מצב ל-LISTENING, אתחל Buffer_size=0, last_voice_ts=now.
	2.	מנע “דיבור-על-דיבור”
	•	בזמן SPEAKING, אם יש Voice=True שנמשך ≥150ms, הפסק מיידית את ה-TTS (ברג’-אין), עבור ל-LISTENING, אפס מדדים ופתח באפר חדש.

C) ברג’-אין “אמיתי”
	1.	ברגע שקול נכנס בזמן TTS:
	•	עצור שליחה של פריימים החוצה (אל Twilio) מיידית.
	•	סמן SPEAKING=False, LISTENING=True, רוקן “תור פריימים ליציאה”.
	•	התחל לצבור באודיו נכנס (אל הבאפר של ה-STT) בלי דיליי.
	2.	הגנות רעש:
	•	ברג’-אין רק אם ה-RMS > noise_floor * 2.2 + 10 לאורך ≥150ms.

D) VAD דינמי – התאמה לרעש אמיתי
	1.	קליברציה בתחילת השיחה: 300–500ms ראשונים → מדוד noise_floor.
	2.	סף דינמי: VAD_threshold = max(35, noise_floor*2.2 + 8)
	3.	דיבאונס: הדלקה/כיבוי Voice עם היסטרזיס של 40–80ms כדי למנוע “ריצוד”.

E) רצף תורות – Guard Rails
	1.	סטייטים חוקיים: LISTENING → PROCESSING → SPEAKING → LISTENING.
אסור לעבור מ-LISTENING ישר ל-SPEAKING בלי PROCESSING (אחרת נדפק באפר).
	2.	Watchdogs:
	•	PROCESSING > 2.5s? שלח “רגע, חושב…” קצר (150–250ms), ואל תישאר שם.
	•	SPEAKING > 6s? חתוך, חזור ל-LISTENING.
	•	אין תגובה ≥7s מאז ה-EOU? אפס מצב וחזור ל-LISTENING.
	3.	MAX_TURNS: ודא שלא מוגדר 1 😉 (לפעמים נשאר מהגנה). קבע 30–60.

F) STT/TTS – ביצועים וזמן תגובה
	1.	STT
	•	אם כרגע Whisper לא-סטרימי: החזק מקטעים קצרים (≤3s) כדי לשמור עלLatency.
	•	אם אפשר, העבר ל-Google Streaming Speech לעברית (latency נמוך, סטרימי).
	•	בכל מצב: המנע מריצה כבדה ב־thread שחוסם את לולאת ה-WS — הרץ ב-green thread / pool והחזר תוצאה באסינכרון.
	2.	TTS
	•	שמור Cache למשפטי פתיחה קבועים (ברכה/“רגע, חושב”).
	•	אל תשלח גושים גדולים בבת אחת—פלח ל-20ms frames בדיוק (160 דגימות 8k μ-law), עם קצב קבוע.

G) Yielding ו-Eventlet
	•	כל לולאת עיבוד (VAD/שילוח פריימים) חייבת לבצע yield קצר (למשל sleep(0)) כדי שלא “תאטום” את greenlet של ה-WS.
	•	שני תורים נפרדים:
	•	RX: מקבל מדיה, עושה VAD ואוגר ל-STT.
	•	TX: משדר TTS; מתבטל מיידית ב-barge-in.

H) לוגים שמראים את האמת (Acceptance Logs)

ודא שמודפסים האירועים הבאים אחרי כל מעבר מצב:
	•	STATE -> PROCESSING | len=XXXX | silence_ms=YYY
	•	ASR_TEXT: ... | dur_ms=...
	•	TTS_START | frames=N
	•	MARK_SENT assistant_tts_end → MARK_ACK assistant_tts_end
	•	STATE -> LISTENING | buffer_reset

כיום רואים Buffer_size=0 ו-SILENCE_TIME=0. אחרי התיקון, תראה:
	•	בזמן דיבור: Buffer_size גדל, Voice=True.
	•	אחרי 300–400ms שקט: STATE -> PROCESSING, ואז ASR_TEXT.
	•	אחרי שליחה: MARK_ACK ואז STATE -> LISTENING וחזרה לסיבוב הבא.

I) בדיקות ידניות קצרות (QA)
	1.	שיחה אמיתית:
	•	אמור “שלום… [שקט 0.5s] מה השעות שלך?” → תקבל תשובה.
	•	דבר על הדיבור של המערכת → ה-TTS נפסק מיד והיא מקשיבה.
	2.	דציבל נמוך/גבוה: בדוק חדר שקט וסביבה רועשת; ודא שסף ה-VAD הדינמי עובד.
	3.	זמן תגובה: כוון < 1.2s בין סוף משפט לתחילת תשובה.

⸻

למה זה יפתור בדיוק את מה שאתה רואה
	•	כרגע אין “סוף משפט” → לא ננעל מקטע ל-STT → “מבינה רק פעם אחת”.
	•	כרגע אין מעבר מחייב מ-SPEAKING ל-LISTENING עם mark/timeout → תקיעה אחרי תשובה.
	•	ברג’-אין חלקי גורם לכך שאם דיברת בזמן TTS, היא לא באמת חזרה להקשבה.

לא צריך לשנות שירות או דיפלוי. צריך להדק את ניהול המצבים + VAD + מחזורי הבאפר + barge-in. תן לאייג’נט את ההנחיות מילה במילה – זה ממוקד לקבצים שלך וללוגים שהבאת. אחרי היישום, השיחה תהיה דו-כיוונית, עם מעבר חלק בין האזנה/חשיבה/דיבור ולייטנסי נמוך.