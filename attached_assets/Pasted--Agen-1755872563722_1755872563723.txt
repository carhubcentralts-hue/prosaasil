הנה הנחיה אחת, סופר-מדויקת, לבוט/סוכן שלך — לביצוע אוטומטי “בלי לפספס”: להפוך את הגרסה הנוכחית (AgentLocator 71) למערכת שפועלת באמת: שיחת מדיה-סטרים דו־כיוונית בעברית בזמן אמת, Fallback בטוח, לוגים, וואטסאפ ו-CRM — ושכל זה ירוץ בדיפלוי. תן לו את זה כלשונו.

⸻

✅ יעד: “עובד באמת”
	•	<Play> (עברית) → <Connect><Stream … action="/webhook/stream_ended">.
	•	Handshake WS = 101 (אין 31920/426).
	•	STT חי בעברית רץ (GCP), TTS חי בעברית רץ, “פינג-פונג” ממשיך.
	•	אם WS לא קם/נופל → Redirect אוטומטי ל־<Record ... action="/webhook/handle_recording"> ונשמר תמלול.
	•	/webhook/call_status מחזיר 204, אין 404/15003.
	•	כל זה בדיפלוי (לא רק בריצה הלוקלית).

⸻

0) עקרונות לביצוע (שהבוט יעמוד בהם)
	•	Idempotent: לא ליצור כפילויות; לעדכן אם קיים; לא למחוק בלי גיבוי.
	•	No-UI: לא לגעת ב־UI.
	•	לוגים: לא להחזיר 500 ב־webhooks; במקרה תקלה — 200/204 + לוג.
	•	Production first: כל הבדיקות דרך ה־Deployment, לא דרך ה־Run הרגיל.

⸻

1) בדיקת קוד ותיוג גרסה
	1.	אמת שהקבצים קיימים ונטענים:
	•	AgentLocator/server/app_factory.py — Sock.init_app(app), ProxyFix, שני מסלולי WS:
/ws/twilio-media וגם /ws/twilio-media/.
	•	AgentLocator/server/routes_twilio.py — incoming_call, stream_ended, handle_recording, call_status, _watchdog, _do_redirect.
	•	AgentLocator/server/media_ws.py — קורא streamSid מ־start, customParameters.call_sid, מפעיל STT/TTS.
	•	AgentLocator/server/services/gcp_stt_stream.py — streaming_recognize/המרת μ-law→PCM16.
	•	AgentLocator/server/services/gcp_tts_live.py — generate_hebrew_response (he-IL).
	•	סטטיק: AgentLocator/static/tts/greeting_he.mp3, fallback_he.mp3.
	2.	אם משהו חסר — ליצור/להשלים בדיוק לפי המבנה הזה; לא להחליף שמות קבצים.

⸻

2) קונפיג דיפלוי (Replit Deployments) — חובה ל-WS

Build

pip install -r AgentLocator/requirements.txt

Run

python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app

אסור להריץ בלי -k eventlet. אחרת 31920 (Handshake Error).

ENV (ב־Deployment עצמו!)
	•	PUBLIC_BASE_URL = הכתובת הציבורית (למשל https://ai-crmd.replit.app)
	•	TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN
	•	GOOGLE_APPLICATION_CREDENTIALS (נתיב לקובץ JSON) או GCP_CREDENTIALS_JSON (ראו §3.2)
	•	OPENAI_API_KEY
	•	DATABASE_URL

הקשחה
	•	נעל Deployment ל־commit הנוכחי.
	•	ודא שאין Runner אחר שמרים גרסאות ישנות.

⸻

3) סודות GCP (כדי שהעברית “תדבר”)

3.1 אם יש קובץ JSON
	•	ודא שהנתיב נשמר ב־GOOGLE_APPLICATION_CREDENTIALS בדיפלוי.

3.2 אם אין קובץ אלא מחרוזת JSON
	•	הבוט יוסיף באתחול (ב־AgentLocator/main.py לפני create_app()):

import os, json, tempfile
creds = os.getenv("GCP_CREDENTIALS_JSON")
if creds and not os.getenv("GOOGLE_APPLICATION_CREDENTIALS"):
    p = os.path.join(tempfile.gettempdir(), "gcp.json")
    with open(p, "w") as f: f.write(creds)
    os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = p


⸻

4) TwiML דטרמיניסטי (בלי <Start>, בלי <Say he-IL>)

ב־routes_twilio.py / incoming_call — ודא שזה הבלוק (במילים האלו):

greeting_url = abs_url("/static/tts/greeting_he.mp3")
wss_host = (os.getenv("PUBLIC_BASE_URL") or request.url_root).replace("https://","").replace("http://","").strip("/")
twiml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Play>{greeting_url}</Play>
  <Connect action="/webhook/stream_ended">
    <Stream url="wss://{wss_host}/ws/twilio-media">
      <Parameter name="call_sid" value="{call_sid}"/>
    </Stream>
  </Connect>
</Response>"""

	•	אין <Say language="he-IL"> כדי לא לחטוף 13512.
	•	abs_url() בונה URL מלא לכל קובץ MP3.

⸻

5) WebSocket “ננעל” ל־101
	•	ProxyFix ב־app_factory.py פעיל (x_for=1, x_proto=1, x_host=1).
	•	שני נתיבי WS (עם/בלי /) — מונע 301/302 בהנדשייק.
	•	אין חתימה/אבטחה/Session על /ws/twilio-media.
	•	אין Socket.IO/engineio על אותו app/פורט.

⸻

6) Watchdog מציל “ברכה ואז שקט”
	•	ודא ש־_watchdog נוצר ב־incoming_call:

threading.Thread(target=_watchdog, args=(call_sid, wss_host, 6, 6), daemon=True).start()


	•	_do_redirect משתמש ב־TWILIO_ACCOUNT_SID/TOKEN מה־ENV של ה־Deployment:

client = Client(os.environ["TWILIO_ACCOUNT_SID"], os.environ["TWILIO_AUTH_TOKEN"])
client.calls(call_sid).update(twiml=<Response>...<Record action="/webhook/handle_recording"/>...<Play>fallback</Play></Response>)


	•	בדיבוג: אפשר זמנית 3/3 שניות כדי לראות /webhook/handle_recording מהר, ואז להחזיר 6/6.

⸻

7) STT/TTS בזמן אמת (עברית)
	•	media_ws.py:
	•	באירוע start — קבל streamSid, customParameters.call_sid, כתוב WS_START.
	•	באירוע media — המרת μ-law→PCM16 → GcpHebrewStreamer.push_ulaw_base64() → read_results_nonblock().
	•	כשמתקבלת תוצאה final:
	1.	הפעל NLP שמחזיר תשובה קצרה (הפונקציה שלך קיימת).
	2.	generate_hebrew_response(text) → קובץ MP3 ציבורי.
	3.	client.calls(call_sid).update(twiml=f"<Response><Play>{url}</Play><Connect>...<Stream .../></Connect></Response>")
(שומר פינג-פונג מתמשך).
	•	ודא PUBLIC_BASE_URL תקין כדי שה־MP3 יהיה נגיש מבחוץ (200).

⸻

8) /webhook/call_status (מסיים 15003/404)
	•	הנתיב קיים ומחזיר 204:

@twilio_bp.route("/webhook/call_status", methods=["POST"])
def call_status(): ...


	•	במספר של Twilio (או ב־TwiML App) — Status Callback מצביע ל־/webhook/call_status.

⸻

9) לוגים/בריאות (שיהיה מה לראות כשיש תקלות)
	•	לפני/אחרי בקשה: REQ / RES.
	•	WS: WS_CONNECTED → WS_START(streamSid,call_sid) → HEBREW_SPEECH (interim/final) → PING_PONG_TX → WS_STOP.
	•	Watchdog: WATCHDOG_REDIRECT[_OK|_FAIL].
	•	Recording: recording_transcribed / recording_transcribe_fail.
	•	Health:
	•	GET /healthz → "ok".
	•	GET /readyz → JSON עם db, openai, tts, twilio_secrets.
	•	GET /version → {"app":"AgentLocator", "commit":..., "build_time":...}.

⸻

10) בדיקות “GO/NO-GO” שהבוט יריץ אוטומטית (דרך הדיפלוי)
	1.	TwiML

curl -s https://$PUBLIC_BASE_URL/webhook/incoming_call | sed -n '1,30p'
# מצופה לראות <Play>.../greeting_he.mp3</Play> ואז <Connect><Stream wss://.../ws/twilio-media ...>


	2.	MP3

curl -I https://$PUBLIC_BASE_URL/static/tts/greeting_he.mp3 | head -1
curl -I https://$PUBLIC_BASE_URL/static/tts/fallback_he.mp3 | head -1
# מצופה: HTTP/2 200


	3.	WS אמיתי (בדיקת 101)
(HEAD לא תקף ל־WS!)
אם יש wscat:

wscat -c wss://$PUBLIC_BASE_URL/ws/twilio-media || true
# מצופה: connected (101)

אחרת, בדיקה עקיפה: לוג WS_CONNECTED בריצה.

	4.	שיחה חיה (סימולציה חלקית)
	•	בדיקה שה־watchdog אכן מחזיר Redirect כשאין סטרים:
לצמצם זמנית ל־3/3 → לצפות ל־POST /webhook/handle_recording ב־Inspector.
	5.	Status Callback
	•	POST /webhook/call_status → 204 בלוג.

כל כשל — להדפיס מייד דיאגנוסטיקה וקישור למפתח התקלה מהרשימה למטה.

⸻

11) מיפוי תקלות → פעולה מיידית
	•	31920 Handshake Error
סיבות: ריצה בלי -k eventlet / רק נתיב WS אחד / אבטחה על WS / Socket.IO יושב יחד / Redirect בהנדשייק.
פעולה: להפעיל eventlet, לשמור שני נתיבי WS, להסיר חתימה/Socket.IO מה־WS, שלא יהיה 301/302.
	•	11100 Invalid Play URL
סיבות: URL קשיח/שגוי; קובץ לא קיים.
פעולה: לבנות עם abs_url(), לאמת 200 על MP3.
	•	13512 language
סיבה: <Say he-IL>.
פעולה: להסיר — עברית רק <Play>.
	•	31924/31951 streamSid שגוי
סיבה: שימוש ב־streamSid לא מה־start.
פעולה: להשתמש רק במה שמגיע ב־start.
	•	404/15003 ב־/webhook/call_status
סיבה: אין route/Callback לא מצביע.
פעולה: להוסיף route, להצביע אליו במספר/אפליקציה.
	•	ברכה ואז שקט, אין /webhook/handle_recording
סיבה: watchdog לא עובד (חסרים TWILIO_* בדיפלוי/ה־thread לא הופעל).
פעולה: להשלים ENV בדיפלוי; לקצר זמנית ל־3/3; לוודא WATCHDOG_REDIRECT_OK.

⸻

12) נקיון כפילויות/חסם רגרסיות
	•	להריץ גלאי כפילויות (hash) ולהדפיס לוג בלבד.
	•	לוודא שאין יבוא מתוך legacy/.
	•	לאחד מסלולים כפולים (אם יש), להשאיר “קנוני” ולתקן imports — בלי מחיקות מסוכנות.

⸻

13) סיכום ביצוע (שהבוט ידפיס)
	•	✅ Eventlet=ON, שני WS routes=OK, ProxyFix=OK.
	•	✅ TwiML תקין (Connect+Stream), MP3=200.
	•	✅ WS=101 (או לפחות WS_CONNECTED בלוג).
	•	✅ STT/TTS עברית רצים; PING_PONG_TX בלוג.
	•	✅ Watchdog Redirect עובד (בדיקת 3/3), /webhook/handle_recording מופיע ב-Inspector.
	•	✅ /webhook/call_status=204.
	•	✅ Ready for UI.

⸻

אם הבוט פוגש שגיאה באמצע — שידפיס במפורש איזו בדיקת GO/NO-GO נכשלה, עם 3–5 שורות לוג סביב WS_START/HEBREW_SPEECH/WATCHDOG_*, והפניה לסעיף “מיפוי תקלות” שמטפל בה.