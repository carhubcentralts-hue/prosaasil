להלן “ספר הנחיות” סופר-פרקטי לבניית **דף מנהל** ו**דף עסק**—עם הרשאות, ניתובים, פונקציות, וסידור מובייל-פרסט שנראה אותו דבר גם בדסקטופ. אין קוד, רק הוראות ביצוע ברורות שתדביק לבוט ותדרוש הוכחות.

---

# 0) עקרונות־על (כדי שלא תתפזרו)

* **Mobile-first אמיתי**: כל המסכים בנויים ברוחב צר (למשל 420–640px). גם בדסקטופ מוצג “סגנון מובייל” (Container צר במרכז).
* **Tailwind 4.1 “נקי”**: טעינה יחידה ב־CSS הראשי (`@import "tailwindcss"`), טוקנים ב־`@theme`, בלי Framework נוסף.
* **שפה ויזואלית אחידה**: Glass-Card, גרדיאנטים עדינים, Heebo, אנימציות Motion קצרות (150–250ms).
* **הרשאות דו־שכבתיות**: Guard בצד לקוח + אכיפה ברמת שרת/DB (RLS/סינון לפי `business_id`).
* **Evidence-Driven**: כל משימה מסתיימת בצילומי מסך/פלטים קצרים (לא “נראה טוב”).

---

# 1) רולים והרשאות (מטריצה קצרה)

**Roles**

* `superadmin` (מערכתי): רואה/מנהל הכול + Impersonate לכל עסק.
* `admin` (מערכתי): כמו superadmin אך בלי פעולות מסוכנות (למשל מחיקה סופית).
* `business_owner` (מנהל עסק): רואה רק את העסק שלו; יוצר/מעדכן משתמשים של העסק.
* `business_agent` (סוכן עסק): רואה/כותב שיחות ו-CRM של העסק שלו בלבד.
* `read_only` (צפייה): צפייה בלבד בתוך העסק שלו.

**מדיניות גישה (דוגמאות):**

* **ניהול עסקים** (יצירה/עריכה/הקפאה/Impersonate): רק `superadmin/admin`.
* **ניהול משתמשים של עסק**: `business_owner` (בעסק שלו), `superadmin/admin` (בכל עסק).
* **WhatsApp/שיחות/CRM/מסמכים**: כל תפקיד עסקי לפי הרשאה (agent=כתיבה; read\_only=צפייה).
* **תשלומים/חשבוניות**: business\_owner ומעלה. אם ספק תשלום לא מוגדר—להציג “לא הוגדר” (ללא שגיאה).

---

# 2) ניתובים (Router) – מבנה, שמות ו־Guards

**קבוצות מסלולים:**

* `/auth/*` – התחברות/שכחתי/איפוס. (כבר יש.)
* `/app/admin/*` – **מנהל מערכתי** בלבד.
* `/app/biz/*` – **משתמש עסק** (owner/agent/read\_only).

**מסכי־בן (Subroutes) – Admin:**

* `/app/admin/overview` – תקציר KPIs וכלים מהירים (Impersonate/חיפוש חוצה עסקים).
* `/app/admin/businesses` – רשימת עסקים (חיפוש/סינון/סטטוס).
* `/app/admin/businesses/:id` – פרטי עסק (כרטיסייה: WhatsApp, שיחות, CRM, תשלומים, משתמשים).
* `/app/admin/users` – משתמשים חוצי-מערכת (חיפוש/סינון לפי Role/Business).
* `/app/admin/whatsapp` – Panorama חוצה עסקים (למוניטור).
* `/app/admin/calls` – שיחות פעילות/היסטוריה חוצות.
* `/app/admin/finance` – ספקי תשלום, חשבוניות/חוזים חוצי מערכת.
* `/app/admin/settings` – הגדרות מערכתיות.

**מסכי־בן – Business:**

* `/app/biz/overview` – KPIs לעסק (שיחות/WA/לידים/מסמכים).
* `/app/biz/whatsapp` – ת׳רדים של העסק + מחבר הודעות + סטטוסי מסירה.
* `/app/biz/calls` – שיחות פעילות/היסטוריה + נגן ותמלול.
* `/app/biz/crm` – לידים/לקוחות/סטטוסים; חיפוש/סינון/מיון.
* `/app/biz/finance` – חשבוניות/חוזים; מצב אינטגרציה לתשלום.
* `/app/biz/users` – ניהול משתמשי העסק (owner בלבד).
* `/app/biz/settings` – הגדרות העסק (לוגו, אזורי זמן, תבניות).

**Route Guards (ללא קוד):**

* עלייה לכל route מתבצעת רק אחרי `GET /api/auth/me`.
* Guard בצד לקוח: אם `role ∉ allowedRoles` → ניתוב ל־`/auth/login`.
* Guard שרת/DB: כל קריאת API כוללת `business_id` ומסוננת ב-DAO/SQL (גם אם לקוח התבלבל).
* **Impersonate** (Admin בלבד): כאשר מופעל, כל הקריאות יוצאות עם `impersonated_business_id` ברור ונרשם Audit.

---

# 3) Shell ותבנית פריסה – מובייל אמיתי גם בדסקטופ

**Header (עליון):**

* לוגו קטן + טקסט (שם עסק/“Admin”).
* אייקון “תפריט” (Hamburger) שפותח **Sidebar כ-Sheet** (Radix).
* אייקוני פעולה קצרים: חיפוש גלובלי, התראות (Badge), פרופיל/יציאה.

**Sidebar (כ־Sheet מתקפל):**

* נפתח מהצד (Right-to-Left) בלחיצה על Hamburger.
* רשימת ניווט עם **אותם מסלולים** בדיוק גם במובייל וגם בדסקטופ.
* קבוצות לפי תפקיד (הצג/הסתר פריטים לפי role).
* Accents של מצב נוכחי (highlight) + counter קטן (למשל הודעות שלא נקראו).
* **ביזנס**: “משתמשים”, “תשלומים” רק ל-owner.
* **אדמין**: “עסקים”, “משתמשים”, “Impersonate”, “פיננסים”, “הגדרות מערכת”.

**Main Content (תמיד container צר):**

* `container mx-auto max-w-[420–640px]` כדי לשמר מראה מובייל גם בדסקטופ.
* כל כרטיס/טבלה/טופס בפורמט אנכי (טור אחד), עם כותרות משנה ברורות.

**Bottom Actions (אופציונלי):**

* בר תחתון עם 3–5 פעולות שכיחות (WhatsApp/CRM/Calls/Overview/Settings).
* Motion קטן ב־press/transition.

**נגישות:**

* Focus-ring ברור, aria-labels, קריאות מסך לטוסטים והתראות.

---

# 4) דף מנהל – תוכן, פונקציות ו-UX

### Overview

* **KPIs קלים**: #שיחות חיות, #WA/שעה, זמן תגובה ממוצע, עסקים פעילים.
* **Quick Actions**: יצירת עסק חדש, Impersonate, חיפוש משתמש/עסק גלובלי.
* **אירועים אחרונים**: רשימה קצרה עם time-ago ו-Badges (שגיאות webhook/אינטגרציה).

### Businesses

* **רשימה**: חיפוש לפי שם/דומיין, סינון לפי סטטוס (פעיל/מוקפא), מיון לפי פעילות.
* **כרטיס עסק**: שם, מזהה, אנשי קשר, אינטגרציות (WA/Payments) וסטטוס כל אחת.
* **פעולות**: עריכה, הקפאה/הפעלה, Impersonate.
* **יצירת עסק**: טופס רב-שלבי קצר (פרטי בסיס → מותג → אינטגרציות).
* **Evidence**: צילום רשימה, צילום יצירה, צילום Impersonate.

### Users (מערכתיים)

* **רשימה**: חיפוש לפי מייל/שם, סינון לפי Role/Business.
* **יצירה/הזמנה**: שליחת הזמנה במייל, שיוך לעסק (או מערכת).
* **עריכה**: שינוי role, נעילה/פתיחה, Reset סיסמה.
* **Evidence**: צילום שימוש בפילטרים, צילום יצירה/עריכה.

### WhatsApp / Calls Panorama

* **צפייה חוצת עסקים**: רק לאדמין; סיכומים/התראות/כשלים.
* **Drill-down**: קפיצה לעסק או לת’רד.
* **Evidence**: צילום לוח חוצי עסקים + קפיצה לעסק.

### Finance (מערכתי)

* **מצב ספקים**: Twilio/PayPal/Tranzila — “מוגדר/לא מוגדר”.
* **מדיניות**: הודגש—כשחסר מפתח מחזירים 501/403/410 (לא 500).
* **Evidence**: צילום “לא מוגדר” במקום כפתור פעיל.

### Settings (מערכתי)

* **נראות מותג**, SSO/Secrets, תצורת ברירות מחדל.
* **Evidence**: צילום עמוד הגדרות.

---

# 5) דף עסק – תוכן, פונקציות ו-UX

### Overview

* **KPIs**: ת׳רדים פעילים, שיחות חיות, לידים חדשים, מסמכים ממתינים.
* **כרטיסי מצב**: “WhatsApp מחובר”, “תשלומים: לא הוגדר/מוכן”, “שיחות: מחובר/שגיאה”.
* **Quick Actions**: פתיחת ת׳רד חדש, התקשרות יזומה, יצירת ליד.
* **Evidence**: צילום המסך עם KPI + סטטוס אינטגרציות.

### WhatsApp (לב העסק)

* **ת׳רד-ליסט**: חיפוש לפי שם/טלפון/תגיות; פאגינציה; Badge לקריאה/סטטוס.
* **צ’אט**: בועות RTL, תצוגת סטטוסים (sent/delivered/read), טיימסטמפס, קבצים (תצוגה מקדימה).
* **Composer**: טקסט+אמוג’י+קבצים; מנגנון חלון 24h—חיווי כשנחסם/נדרש Template.
* **רענון**: SSE או פולינג 10–15s.
* **Evidence**: וידאו 10–20ש’ של שליחה→סטטוס→הופעה ב-CRM.

### Calls

* **Live**: רשימת שיחות פעילות (state: LISTENING/THINKING/SPEAKING), כפתור ניתוב/סיום.
* **History**: הקלטות + תמלול; חיפוש לפי טקסט; סימון “חשוב”.
* **Evidence**: צילום נגן/תמלול עובד.

### CRM (Contacts/Leads/Deals)

* **טבלאות אנכיות** (Mobile-First), סינון חכם, סימון סטטוסים.
* **כרטיס לקוח**: פרטים, שיחות/WA/מסמכים משויכים.
* **Evidence**: צילום סינון/מיון/כרטיס לקוח.

### Finance (Payments/Invoices/Contracts)

* **מצבי אינטגרציה**: “לא הוגדר” עם הסבר; כפתור הגדרה.
* **רשימות**: חשבוניות/חוזים; סטטוס חתימה; הורדה/שליחה.
* **Evidence**: צילום “לא הוגדר” + פריט חתום/שולם לדוגמה.

### Users (בעל עסק בלבד)

* **רשימת משתמשים** של העסק; חיפוש; סינון לפי Role.
* **יצירה/עריכה**: הזמנה במייל; תפקיד (agent/owner/read\_only).
* **Evidence**: צילום יצירת משתמש ושינוי הרשאות.

### Settings (עסק)

* **מותג**, אזורי זמן/תבניות הודעה, כללי CRM.
* **Evidence**: צילום עדכון שמור.

---

# 6) Patterns מחייבים לכל המסכים (UI/UX)

* **Skeletons** בטעינה, **Empty-state** ברור, **Toast** אחיד (הצלחה/שגיאה).
* **טעינה/שגייה ניתנות לחזרה** (Retry).
* **נגישות**: Label לכל שדה; aria-live לטוסטים; פוקוס נראה; קונטרסט AA.
* **ביצועים**: SVG איקונים (lucide), אין תמונות ענק; Lighthouse ≥ 90 למסכי מפתח.
* **RTL מלא**; שדה אימייל `dir="ltr"`.

---

# 7) API & Data-flow (מינימום נדרש—שמות וקריטריונים)

* `GET /api/auth/me` – מזהה role ו-business\_ids (למשתמש עסק).
* **Admin-only**:

  * `GET/POST/PUT /api/businesses`
  * `GET/POST/PUT /api/users` (חוצה עסקים)
* **Business-scoped** (מחייב `business_id` בצד שרת!):

  * `GET/POST /api/whatsapp/threads?business_id=…`
  * `GET/POST /api/whatsapp/messages?thread_id=…`
  * `GET/POST /api/calls?business_id=…`
  * `GET/POST /api/crm/*?business_id=…`
  * `GET/POST /api/finance/*?business_id=…`
* **Webhook WA**: אימות חתימה; Idempotency מלא; עדכון סטטוסים.
* **Voice**: `/webhook/stream_status` → 204 תמיד; WS subprotocol תקין; FallBack ≤ 3–6s.

---

# 8) Evidence Pack (מה לבקש מהבוט בכל סיום שלב)

1. **צילום Sidebar כ-Sheet** פתוח/סגור + הדגמת הרשאות (פריטים שנעלמים לפי role).
2. **צילום Overview** (Admin/Biz) עם KPI ו-Quick Actions.
3. **וידאו קצר WhatsApp**: שליחה→סטטוס→UI מתעדכן ≤3s.
4. **צילום Calls**: live states + היסטוריה עם תמלול.
5. **צילום Users**: יצירה/עריכה (Admin ובעל-עסק).
6. **צילום Finance**: “לא הוגדר” במקום כפתור פעיל כשחסרים מפתחות.
7. **Lighthouse ≥ 90** למסך מרכזי (Overview Biz).
8. **חיפוש קבצים** שמוכיח Tailwind 4.1 “נקי” (אין `@tailwind base/...`, יש `@import "tailwindcss"` יחיד + `@theme`).

---

# 9) “הגדרת הצלחה” (DoD) לכל דף

* נראה **מובייל** גם בדסקטופ (container צר, קומפוננטים אנכיים).
* הרשאות נכונות (פריטים נסגרים/נפתחים לפי role).
* RLS בצד השרת: כל API מסונן לפי `business_id`.
* State שוטף (SSE/פולינג) למודולים חיים (WA/Calls).
* נגישות/ביצועים/סקלביליות: AA, Lighthouse ≥ 90, אינדקסים בדאטה.

---

אם תרצה, אכין לך עכשיו **“כרטיסי ביצוע” קצרים** (שניים להתחלה):

1. “דף מנהל – Overview + Businesses + Users (עם Sidebar כ-Sheet והרשאות)”,
2. “דף עסק – Overview + WhatsApp + Calls (עם SSE/פולינג ו-Users ל-owner)”,
   כולל בדיוק מה לבקש מהבוט להחזיר כהוכחות בכל שלב.
