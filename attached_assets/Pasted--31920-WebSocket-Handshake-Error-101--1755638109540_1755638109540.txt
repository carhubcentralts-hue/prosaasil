ברור. שגיאת **31920 – WebSocket Handshake Error** אומרת שטוויליו קיבלה מהשרת שלך תשובה **שאינה 101** בזמן ה־Upgrade (כלומר ה־WS לא “נפתח” בפועל). לרוב זה נובע מ־(1) שרת שלא תומך WS/לא רץ עם Eventlet, (2) נתיב/דומיין/פרוטוקול לא תואם, (3) רידיירקט/404 על ה־WS, או (4) פריסה ישנה שמחזירה TwiML שגוי. ([Twilio][1])

להלן הנחיה **סופר־מפורטת** שתואמת לקוד שב־ZIP ‎(67)‎ ופותרת את 31920 מהשורש:

---

# 1) וודאות: הפריסה הנכונה רצה עם WS אמיתי

## Build/Run בדיפלוי (Replit Deployments)

הגדר ב־Deployment (או ב־`.replit` של ה־Workspace אם אתה מריץ משם):

**Build**

```
pip install -r AgentLocator/requirements.txt
```

**Run**

```
python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:$PORT AgentLocator.main:app
```

למה?

* `-k eventlet` מפעיל תשתית **WebSocket** אמיתית. בלי זה, ה־WS ייכשל בהנדשייק (31920). ([Twilio][2])

בדוק לאחר Provison/Deploy:

```
curl -s https://<DEPLOY>.replit.app/readyz
```

חייב להחזיר `{"db":"ok"..."}` (או disabled איפה שחסר). אם `/readyz` לא עולה – הפריסה לא טעונה כמו שצריך.

---

# 2) ודא שה־TwiML מצביע לדומיין הנכון (ולא לדומיין ישן)

ב־`AgentLocator/server/routes_twilio.py` אצלך כבר יש `<Connect><Stream url="wss://ai-crmd.replit.app/ws/twilio-media">`.
אם פרסת דיפלוי חדש/שם הדומיין השתנה – **הקפד** לעדכן. מומלץ לשנות לקוד דינמי כך:

```python
# בתוך incoming_call()
from flask import request
host = os.getenv("PUBLIC_HOST") or request.host  # לדוגמה: ai-crmd.replit.app
wss_host = host.replace("https://","").replace("http://","")
twiml = f"""<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Play>https://{wss_host}/static/tts/greeting_he.mp3</Play>
  <Connect action="/webhook/stream_ended">
    <Stream url="wss://{wss_host}/ws/twilio-media">
      <Parameter name="call_sid" value="{call_sid}"/>
    </Stream>
  </Connect>
</Response>"""
```

> ככה לא “ננעלים” על דומיין ישן; תמיד יחזור דומיין הדיפלוי הנוכחי. (וידוא: `curl -s https://<DEPLOY>.replit.app/webhook/incoming_call | head` – חייב להכיל `<Connect><Stream wss://<DEPLOY>...>`)

---

# 3) הנתיב של ה־WS – למנוע 404/רידיירקט

ב־`AgentLocator/server/app_factory.py` ראיתי Route:

```python
@sock.route('/ws/twilio-media')
def twilio_media(ws): MediaStreamHandler(ws).run()
```

כדי למנוע תקלות סלאש/רידיירקט (שאצל WS גורמות ל־31920), הוסף גם את הגרסה עם הסלאש:

```python
@sock.route('/ws/twilio-media/')
def twilio_media_slash(ws): MediaStreamHandler(ws).run()
```

> 404/302 במקום 101 = Handshake Error. (Twilio מדווח 31920 כשהשרת לא מחזיר 101) ([Twilio][1])

---

# 4) ודא שלא חוסמים את ה־WS עם חתימות/אבטחה

* אל תעטוף את נתיב ה־WS בדקורטור אימות חתימה. זה **לא** webhook HTTP.
* הדקורטור `@require_twilio_signature` נכון ל־`/webhook/*` בלבד (incoming\_call / stream\_ended / call\_status / handle\_recording).

---

# 5) אימות שהשרת באמת מאזין ל־WS

בדוק חיצונית (לפני Twilio):

* פתח ב־WebSocket tester (למשל websocketking.com):
  `wss://<DEPLOY>.replit.app/ws/twilio-media`
  אם אתה מקבל 101/מתחבר – טוב. אם לא, יש עדיין בעיית ריצה/דומיין/נתיב.

* או בדיקה ידנית (אם יש לך `wscat` מקומי):

  ```
  wscat -c wss://<DEPLOY>.replit.app/ws/twilio-media
  ```

אם אין 101 → חזור לסעיפים 1–3 (Eventlet, דומיין נכון, נתיב כפול).

---

# 6) Twilio → הדיפלוי הנכון

ב־Twilio Console (Incoming Voice Webhook):
הצביעו ל־**דומיין הדיפלוי**:

```
https://<DEPLOY>.replit.app/webhook/incoming_call
```

(ושאר ה־webhooks לאותו דומיין).
**אל** תפנו ל־Workspace (`*.repl.co`) כשאתם בודקים דיפלוי – זה ידליק בלבול.

> תזכורת: כשחוזר TwiML – ודאו שהוא מכיל `<Connect><Stream ... wss://<DEPLOY>.replit.app/ws/twilio-media>`. אם חוזר `<Record>` – אתם עדיין על פריסה ישנה.

---

# 7) בדיקות עשן בסדר כרונולוגי

1. **TwiML**

   ```
   curl -s https://<DEPLOY>.replit.app/webhook/incoming_call | sed -n '1,20p'
   ```

   חייב להציג `<Connect><Stream ...>`. אם לא – זהו קוד ישן/דומיין אחר.

2. **WS**
   בדוק התחברות ידנית כמו בסעיף 5. Handshake 101 = תקין; כל דבר אחר → 31920.

3. **Twilio Call**
   ב־Request Inspector:

   * 200 על `incoming_call`
   * 200 על טעינת MP3 (`/static/tts/greeting_he.mp3`)
   * אין 31920/31924 (אם יש – חזור לסעיפים 1–4) ([Twilio][3])
   * אם הסטרים נסגר – 200 על `/webhook/stream_ended` ו־`<Record>` מופעל.

---

# 8) סיבות נפוצות ל־31920 ומה סוגר אותן (צ’ק־בוקס)

* [ ] **Eventlet לא בשימוש** → תקן Run ל־`gunicorn -k eventlet` (סעיף 1). ([Twilio][2])
* [ ] **דומיין/פרוטוקול שגוי** (ws\:// במקום wss\://, או דומיין ישן) → סעיף 2. ([Twilio][1])
* [ ] **נתיב WS לא תואם** (`/ws/twilio-media/` לעומת `/ws/twilio-media`) → הוסף שני נתיבים (סעיף 3).
* [ ] **רידיירקט/404** (Strict slash/Trailing slash) → סעיף 3.
* [ ] **Proxy/TLS** (נדיר ברפליט, אבל תקף) → חייב WSS בתוקף; רפליט מספק. ([Twilio][4])
* [ ] **פריסה ישנה** מגיבה → עצור/פרוס מחדש, וודא שה־TwiML מכיל `<Connect><Stream>` (סעיף 6).

---

# 9) תוספות קטנות שמומלץ לעשות (לא חובה ל-31920)

* שמירת `streamSid` בקלאס `MediaStreamHandler` (כבר קיים אצלך) ושימוש **רק בו** למסר־יוצא (`mark/clear`). זה מונע 31924 בהמשך. ([Twilio][3], [Jon Sully][5])
* בלוגים: הוסף `WS_CONNECTED`, `WS_START {streamSid}`, `WS_FRAME {len}` כדי לראות ב־Realtime שהכל חי.
* ב־`/stream_ended` – תמיד Fallback `<Record ... action="/webhook/handle_recording">` (כבר יש).

---

## אם אתה רוצה “מסלול ירוק” מיידי

* עצור Deployment ישן.
* כוון את Twilio ל־**Workspace** (כתובת `*.repl.co`) לרגע, הרץ מקומית:

  ```
  python3 -m gunicorn -k eventlet -w 1 -b 0.0.0.0:5000 AgentLocator.main:app
  ```

  ודא שה־TwiML מחזיר `<Connect><Stream>` וש־WS נפתח.
* לאחר שאימתת—פרוס מחדש Deployment נקי עם ההגדרות שבסעיף 1, וב־Twilio החזר ל־`*.replit.app`.

---

### תקציר חד:

* 31920 = השרת לא החזיר **101** בזמן Handshake. תקן **Eventlet + דומיין/נתיב/WS** לפי הסעיפים למעלה, ואמת עם curl ו־WebSocket tester לפני שאתה מחזיר את טוויליו לדיפלוי. אחרי זה ה־WS נפתח, וזרם המדיה יתחיל לזרום. ([Twilio][1])

אם תרצה, אתן לך **טקסטים להדבקה** למסכי ה-Deployment של Replit (Build/Run/Env) + פקודות אימות 1:1.

[1]: https://www.twilio.com/docs/api/errors/31920?utm_source=chatgpt.com "31920: Stream - WebSocket - Handshake Error - Twilio"
[2]: https://www.twilio.com/docs/voice/tutorials/consume-real-time-media-stream-using-websockets-python-and-flask?utm_source=chatgpt.com "Consume a real-time Media Stream using WebSockets, ..."
[3]: https://www.twilio.com/docs/api/errors/31924?utm_source=chatgpt.com "31924: Stream - Websocket - Protocol Error - Twilio"
[4]: https://www.twilio.com/docs/api/errors/31910?utm_source=chatgpt.com "31910: Stream - WebSocket - SSL Protocol Error - Twilio"
[5]: https://jonsully.net/blog/twilio-openai-realtime-rails?utm_source=chatgpt.com "Guide to Twilio + OpenAI Realtime on Rails (Without Anycable)"
