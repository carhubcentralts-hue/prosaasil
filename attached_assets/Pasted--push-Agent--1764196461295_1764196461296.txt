××¢×•×œ×”, ×–×” ×‘×“×™×•×§ ×”×©×œ×‘ ×œ×¢×¦×•×¨ ×•×œ×¡×’×•×¨ ×¤×™× ×•×ª ×œ×¤× ×™ ×¢×•×“ push.
×× ×™ ×œ× ×¨×•××” ××ª ×”×§×•×“ ×”××¢×•×“×›×Ÿ ××—×¨×™ ×”-Agent, ××‘×œ ×× ×™ ×›×Ÿ ×™×›×•×œ ×œ×ª×ª ×œ×š ×”× ×—×™×™×ª-×¢×œ ××¡×•×“×¨×ª ×œ×¡×•×›×Ÿ ×‘×¨×™×¤×œ×™×˜, ×©×ª×•×•×“× ×©×”×•×:
	â€¢	××©××¨ ××ª ×›×œ ××” ×©×›×‘×¨ ×ª×™×§× ×• ×™×“× ×™×ª ×‘×™×—×“
	â€¢	××©×œ×™× ××ª ××” ×©×”×•× ×›×ª×‘ ×‘-BUILD 152 (×•×œ× ×¡×™×™×)
	â€¢	××•×•×“× ×©×”×›×•×œ ×¢×•×‘×“ multi-tenant, ×¤×¨×•×“×§×©×Ÿ, ×©×¨×ª ×—×™×¦×•× ×™ â€“ ×‘×œ×™ ×§×™×¦×•×¨×™ ×“×¨×š

×× ×™ ××ª×Ÿ ×œ×š ×˜×§×¡×˜ ××•×›×Ÿ ×œ×”×“×‘×§×” ×œ×¡×•×›×Ÿ. ××ª×” ×¤×©×•×˜ ×¤×•×ª×— Agent ×—×“×©, ××“×‘×™×§ ××ª ×–×” ×›-prompt ×¨××©×•× ×™, ×•××¨×™×¥ ××•×ª×• ×¢×œ ×”×¤×¨×•×™×§×˜.

â¸»

ğŸ§  MASTER BRIEF ×œ×¡×•×›×Ÿ â€“ ProSaaS ×¢×œ Contabo, Multi-Tenant ××œ×, ×‘×œ×™ ×‘××’×™×

×ª×“×‘×™×§ ×œ×¡×•×›×Ÿ ×›××• ×©×–×”. ××œ ×ª×¢×¨×‘×‘ ×¢× ×“×‘×¨×™× ××—×¨×™×.

â¸»

You are working on the ProSaaS / AI CRM project that is already deployed on an external Contabo server with Docker + Nginx + Neon/Postgres.

Your goal in this task:
	1.	Align the codebase with the current working production state on Contabo
	2.	Guarantee full multi-tenant behavior (per business) in all critical flows
	3.	Fix and finalize everything that was only partially done in BUILD 152
	4.	Make sure Replit repo â†’ git push â†’ Contabo pull will work without manual hotfixes on the server

Do NOT reset or re-init the DB. All fixes must be backwards-compatible with existing Neon data.

â¸»

0. Sync & Context
	1.	Make sure the repo you see is the same codebase that was deployed to Contabo (the one using docker-compose.yml, Dockerfile.backend, Dockerfile.frontend, Dockerfile.baileys, docker/nginx.conf).
	2.	Confirm the project is using Neon DATABASE_URL and not local Postgres in code:
	â€¢	DATABASE_URL env should be used by SQLAlchemy/DB layer.
	3.	Open and read:
	â€¢	docker-compose.yml
	â€¢	docker/nginx.conf
	â€¢	server/routes_webhook.py (or equivalent Twilio routes file)
	â€¢	server/twilio_*.py (or similar)
	â€¢	server/media_ws_ai.py
	â€¢	server/models/*.py
	â€¢	Frontend auth / users / leads / WhatsApp pages

â¸»

1. Hardcoded phone numbers â€“ VERIFY & CLEAN

Even if you think itâ€™s done in BUILD 152 â€“ verify again:
	1.	Run (in the repo root):

grep -R "+97233763805" -n .
grep -R "33763805" -n .
grep -R "TWILIO_PHONE" -n server

	2.	The result MUST be:
	â€¢	No hardcoded phone numbers pointing to a single business.
	â€¢	All business identification MUST be based on a business phone field, for example:
	â€¢	Business.twilio_phone_number
or
	â€¢	Business.phone_e164 (if thatâ€™s the canonical field).
	3.	In the Twilio incoming call route:
	â€¢	Extract the dialed number from To (and normalize to E.164).
	â€¢	Find business by that field (Business.twilio_phone_number == to_e164).
	â€¢	If not found â€“ log clearly and use a safe fallback (or reject nicely).
	4.	Outgoing calls:
	â€¢	When calling client.calls.create, use:

from_ = business.twilio_phone_number or settings.TWILIO_PHONE_NUMBER

No per-business logic may rely on a hardcoded number.

â¸»

2. Twilio Webhooks â€“ 405 / 403 / Signature

You must fully fix the Twilio webhooks. Today the logs already show:
	â€¢	405 Method Not Allowed
	â€¢	403 Forbidden â€“ Missing / Invalid X-Twilio-Signature

Tasks:
	1.	Locate all Twilio routes (probably in something like routes_webhook.py / routes_twilio.py):
	â€¢	/webhook/incoming_call
	â€¢	/webhook/call_status
	â€¢	/webhook/handle_recording (if exists)
	â€¢	any WhatsApp/Twilio webhook endpoints
	2.	For each route:
	â€¢	Make sure HTTP methods are correct:
	â€¢	@bp.route("/webhook/incoming_call", methods=["POST"])
	â€¢	@bp.route("/webhook/call_status", methods=["POST"])
	â€¢	If you need OPTIONS for CORS â€“ add it explicitly but donâ€™t break Twilio.
	3.	Twilio signature validation:
	â€¢	There is an env VALIDATE_TWILIO_SIGNATURE according to BUILD 152.
	â€¢	Implement logic:

VALIDATE_TWILIO_SIGNATURE = os.getenv("VALIDATE_TWILIO_SIGNATURE", "true").lower() == "true"

	â€¢	If VALIDATE_TWILIO_SIGNATURE is false â†’ skip validation, always accept (for dev).
	â€¢	If true â†’ fully validate using Twilioâ€™s official helper, but:
	â€¢	Use the exact URL that Twilio calls, including https://prosaas.pro/webhook/...
	â€¢	Make sure Nginx forwards correct Host and X-Forwarded-Proto headers so you can reconstruct the full URL properly.

	4.	Check that:
	â€¢	A manual curl -X POST from the server to http://localhost/webhook/incoming_call returns 200, not 403 or 405.
	â€¢	A real Twilio call does not get HTTP 403/405 in the logs.

â¸»

3. Nginx Frontend Proxy â€“ backend, n8n, webhook

Confirm the Nginx config (docker/nginx.conf) is exactly this structure (or better):
	â€¢	server_name prosaas.pro www.prosaas.pro
	â€¢	root /usr/share/nginx/html;
	â€¢	SPA rule:

location / {
    try_files $uri /index.html;
}

	â€¢	Backend API:

location /api/ {
    proxy_pass http://backend:5000/api/;
    ...
}

	â€¢	Twilio webhooks:

location /webhook/ {
    proxy_pass http://backend:5000/webhook/;
    ...
}

	â€¢	n8n:

location /n8n/ {
    proxy_pass http://n8n:5678/;
    ...
}

Important:
	â€¢	The upstream host names backend and n8n must match service names in docker-compose.yml.
	â€¢	Run docker exec -it prosaas-frontend nginx -t and make sure config passes.

â¸»

4. Baileys / WhatsApp â€“ QR & Node 20+

We had previous issues with:
	â€¢	Node version mismatch (Node 18 vs Baileys requiring 20+)
	â€¢	Missing dependencies in package-lock
	â€¢	QR code not rendering in the CRM

You must:
	1.	Open Dockerfile.baileys:
	â€¢	Base image must be Node 20+ (e.g. node:20-slim).
	â€¢	npm ci --only=production must succeed with the existing package-lock.json.
If it doesnâ€™t â€” fix the lock file by running npm install in dev, then commit lock file.
	2.	Baileys service in docker-compose.yml:
	â€¢	Must reference this Dockerfile and expose health endpoint.
	â€¢	Verify /health returns 200.
	3.	In the frontend:
	â€¢	WhatsApp page & QR component (e.g. WhatsAppPage.tsx, WhatsAppChat.tsx):
	â€¢	Ensure QR code request calls your backend, not some old Replit URL.
	â€¢	Backend route should proxy or generate QR from Baileys service.
	4.	End result:
	â€¢	When you visit the WhatsApp page in the CRM on production:
	â€¢	QR appears.
	â€¢	Baileys logs show correct connection and scanning.

â¸»

5. CRM â€“ Delete Lead (Mobile) & Delete User

You must guarantee these are implemented in code and not ×¨×§ ×“×™×‘×•×¨×™× ×‘-BUILD 152.

5.1 Delete Lead on Mobile
	1.	Locate mobile lead cards component (e.g. LeadCard.tsx, or mobile layout of Leads page).
	2.	Verify:
	â€¢	There is a delete button/icon on the mobile view, not only in desktop table.
	â€¢	It calls the same delete API as desktop (e.g. DELETE /api/leads/:id).
	â€¢	It has proper data-testid attributes if the project uses them.

5.2 User Deletion with RBAC
	1.	Backend:
	â€¢	There must be an endpoint for deleting users (e.g. DELETE /api/users/:id).
	â€¢	RBAC rules:
	â€¢	system_admin can delete any user.
	â€¢	owner can delete only users in their own business.
	â€¢	No one can delete:
	â€¢	himself
	â€¢	the only owner of a business (must keep at least one owner).
	2.	Frontend:
	â€¢	Where system_admin manages users (Admin Users page), there must be:
	â€¢	A delete button that calls that endpoint.
	â€¢	Where business owner manages users of his business, there must be:
	â€¢	Delete option according to those rules.
	â€¢	Any â€œDelete userâ€ button should give clear success/error feedback.
	3.	Verify in code that these behaviors are actually wired and not just mentioned in BUILD 152 summary.

â¸»

6. Multi-Tenant Enforcement â€“ Across the Board

Do a focused multi-tenant audit:

For each of these areas, make sure every DB query is scoped by business_id (or equivalent):
	â€¢	Leads
	â€¢	Calls / Call logs
	â€¢	WhatsApp conversations / messages
	â€¢	Notifications (/api/notifications â€“ was 404/401)
	â€¢	Tasks
	â€¢	Invoices / Offers / Signatures
	â€¢	Users listing for non-system_admin

Rules:
	â€¢	system_admin may see cross-business if thatâ€™s the design.
	â€¢	owner / agent / representative must ONLY see their own business data.

Look for any query like:

Lead.query.all()
CallLog.query.order_by(...)

And refactor to:

Lead.query.filter_by(business_id=current_business_id)

Make sure this is done consistently, especially in:
	â€¢	API route handlers
	â€¢	Background jobs / workers
	â€¢	n8n integration (if any DB access is there)

â¸»

7. Production Build & CI Flow

The goal: one clean flow:

Replit â†’ git push â†’ Contabo â†’ git pull â†’ docker compose up -d --build

You must:
	1.	Ensure Dockerfile.frontend uses a Node 20+ base image compatible with the frontend stack (Vite 7, React Router 7, etc.).
	2.	Ensure npm ci (or npm install --omit=dev) in Dockerfile succeeds.
	3.	Ensure docker-compose.yml has no leftover Replit-specific URLs like ai-crmd.replit.app.
	4.	In .env.example / .env.production template:
	â€¢	Include all required envs:
	â€¢	DATABASE_URL
	â€¢	OPENAI_API_KEY
	â€¢	TWILIO_*
	â€¢	VALIDATE_TWILIO_SIGNATURE
	â€¢	PUBLIC_BASE_URL=https://prosaas.pro
	â€¢	n8n envs

Document final build procedure in a short DEPLOYMENT.md section:
	â€¢	How to build & run locally with Docker
	â€¢	How to deploy to Contabo

â¸»

8. Final Self-Test Checklist

After all changes:
	1.	Locally (or on staging) run:

docker compose up -d --build

	2.	Verify:

	â€¢	curl http://localhost/health â†’ 200
	â€¢	curl http://localhost/api/health (if exists) â†’ 200
	â€¢	curl http://localhost/webhook/incoming_call (POST without signature if validation disabled) â†’ 200

	3.	On production (Contabo):

	â€¢	Open https://prosaas.pro â€“ CRM loads.
	â€¢	You can log in with existing admin/business users from Neon.
	â€¢	Twilio:
	â€¢	Set webhook URLs to https://prosaas.pro/webhook/incoming_call etc.
	â€¢	Call the number:
	â€¢	Call arrives.
	â€¢	No 403 / 405 in backend logs.
	â€¢	WhatsApp:
	â€¢	QR displays.
	â€¢	Baileys logs correct behavior.
	â€¢	CRM:
	â€¢	On mobile â€“ you can delete lead.
	â€¢	As system_admin â€“ you can delete users respecting RBAC.

â¸»

âš ï¸ IMPORTANT:
Do not add any new â€œquick hacksâ€ on the server only. All changes must be in the repo so that a fresh git pull && docker compose up -d --build gives a fully working system.

â¸»

×× ××ª×” ×¨×•×¦×”, ××—×¨×™ ×©×”×¡×•×›×Ÿ ×™×¡×™×™× ××ª ×”-run ×¢× ×”×”× ×—×™×” ×”×–××ª â€“ ×ª×©×œ×— ×œ×™ ××ª ×”Ö¾summary ×©×”×•× ×›×ª×‘ (×›××• ×©×œ BUILD 152), ×•×× ×™ ××¢×‘×•×¨ ××™×ª×š × ×§×•×“×”-× ×§×•×“×” ××” ×¢×•×“ ×—×¡×¨ ××• ×× ××©×”×• ×¢×“×™×™×Ÿ ×œ× × ×©××¢ ×œ×™ ×¡×’×•×¨.