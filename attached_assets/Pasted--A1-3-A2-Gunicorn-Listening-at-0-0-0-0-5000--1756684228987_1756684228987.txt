הולכים לסגור את A1.3/A2 עכשיו. לפי הסימפטומים שלך:
	•	Gunicorn כותב “Listening at: 0.0.0.0:5000”
	•	curl 127.0.0.1:5000/healthz → Connection refused
	•	אחרי ~10 שניות: “Handling signal: term” וה־worker נסגר

זה כמעט תמיד אומר: אתה מאזין לפורט הלא-נכון ביחס למה שהפלטפורמה (למשל Replit) מצפה → הסופרוויזור רואה שאין שירות מקשיב על $PORT שהוא הקצה ומחסל את התהליך (SIGTERM). גם אם 5000 “נכון” אצלך בראש — למנהל הריצה יש מספר אחר, והוא זה שקובע.

מתקדמים כך, צעד-צעד:

⸻

1) מפסיקים “לנעול” 5000 — מאזינים על ה־$PORT האמיתי

בחלון ההרצה שבו אתה מפעיל את השרת:
	1.	נקה כל הגדרה ידנית של פורט:

	•	אם עשית export PORT=5000 → בטל: unset PORT
	•	אם אתה מזריק PORT בקובץ env/Procfile → הסר את הקיבוע הזה

	2.	בדוק מה ה־PORT שהפלטפורמה נותנת:

	•	הדפס: echo "PORT=$PORT"
	•	אם ריק → הפלטפורמה שלך לא מגדירה אוטומטית; קבע אחד ב־שני המקומות (גם להרצה וגם ל־healthcheck החיצוני). אם זו Replit — בדרך כלל יש $PORT לא ריק.

	3.	הרץ Gunicorn על $PORT בלבד (לא על 5000 קשיח):

python3 -m gunicorn AgentLocator.main:app \
  -k eventlet -w 1 -b 0.0.0.0:$PORT \
  --log-level debug --access-logfile '-' --error-logfile '-' \
  --timeout 120 --graceful-timeout 30 --keep-alive 75

צפוי בלוג: Listening at: http://0.0.0.0:<מספר_הפורט_מהסביבה>.

אם אתה חייב לבדוק מקומית בתוך אותו סשן — curl -sS -m 3 http://127.0.0.1:$PORT/healthz -i.
אם זה רץ בענן — בדוק את ה־PUBLIC_BASE_URL (לא 127.0.0.1 של המחשב שלך).

⸻

2) מאמתים שבאמת מקשיב לפני שהסופרוויזור הורג

מיד אחרי ההפעלה, בחלון נפרד:
	•	ss -ltnp | grep ":$PORT" (או netstat -ltnp | grep ":$PORT")
מצופה לראות LISTEN עם python/gunicorn.
	•	curl -sS -m 3 http://127.0.0.1:$PORT/healthz -i
מצופה: HTTP/1.1 200 OK.
	•	מבחוץ:
curl -sS -m 5 https://<PUBLIC_BASE_URL>/healthz -i
מצופה: HTTP/2 200 (או 200 רגיל אם אין פרוקסי TLS).

אם כאן אתה עדיין מקבל Connection refused → ה־worker מת לפני שהספקת לבדוק. ראה סעיף 3.

⸻

3) אם ה־worker מת מיד אחרי boot — מציפים את השגיאה הנסתרת

לפעמים השגיאה נבלעת ב־stdout/stderr. כך נכפה עליה להיחשף:
	•	הרץ עם preload (טוען את האפליקציה במאסטר ומראה שגיאות import/boot):

python3 -m gunicorn AgentLocator.main:app \
  -k eventlet -w 1 -b 0.0.0.0:$PORT \
  --preload --capture-output \
  --log-level debug --access-logfile '-' --error-logfile '-'

אם יש ImportError/Exception ב־create_app או ברישום Blueprints — תראה אותה מיד במסך.
	•	אם עדיין לא רואים — הרץ בדיקה יבשה:

python3 - <<'PY'
import AgentLocator.main as M
print("APP:", hasattr(M, "app"))
print("URLS:", getattr(M.app, "url_map", None))
PY

זה מאשר שה־module וה־app קיימים וה־url_map נטען.

אם אחת מהפקודות האלה קורסת — זו הסיבה שה־worker מת. תקן את ה־import/boot ואז חזור לסעיף 1.

⸻

4) וידוא שאין תהליך אחר “שודד” את הפורט
	•	ps aux | egrep "gunicorn|flask|python.*main" | grep -v grep
אם יש יותר מאחד — הרוג את הישנים.
	•	לפעמים Dev server נפתח ב־import (הדפסת “Running on all addresses …”). ודא שאין app.run() מחוץ ל־if __name__ == "__main__":.

⸻

5) מי הורג אחרי 10 שניות?

זה דפוס של סופרוויזור/פלטפורמה שמחפשים שירות על $PORT שלהם. אם האזנת על 5000 קשיח במקום $PORT — הם לא רואים אותו ומורידים אותך ב־SIGTERM. ברגע שתקשור ל־$PORT הנכון — ההרג ייעלם.

⸻

6) אחרי שהשרת יציב — ממשיכים ל־Voice

כשתקבל:
	•	ss/netstat מראה LISTEN על $PORT
	•	curl .../healthz → 200 מקומי וציבורי
	•	/version מחזיר DEPLOY_ID עדכני

נעבור מיד לשלב Handshake כדי להוריד את 31920:
	1.	בדוק TwiML/webhooks:

	•	POST /webhook/incoming_call מחזיר <Connect><Stream ...> (בלי // כפולים)
	•	POST /webhook/stream_status → 204 ריק
	•	POST /webhook/stream_ended → 204 ריק

	2.	בדוק WS Handshake עם subprotocol:

wscat -c wss://<PUBLIC_BASE_URL>/ws/twilio-media \
      -H "Sec-WebSocket-Protocol: audio.twilio.com"

מצופה: 101 Switching Protocols וחזרה של Sec-WebSocket-Protocol: audio.twilio.com.
אם לא — זה שורש 31920, לתקן לפני הכל.
	3.	דאג ל-STT/TTS (μ-law 8k) ולוגים: WS_START → STT_FINAL → TTS_LEN_ms → MEDIA_TX.

⸻

מה להביא לי כדי לוודא שסגרנו את A1.3
	1.	פלט echo PORT=$PORT.
	2.	פלט ss -ltnp | grep ":$PORT" (או netstat ...).
	3.	פלט:

curl -sS -m 3 http://127.0.0.1:$PORT/healthz -i
curl -sS -m 5 https://<PUBLIC_BASE_URL>/healthz -i
curl -sS -m 5 https://<PUBLIC_BASE_URL>/version -i

ברגע שזה ירוק — נתקדם ישר ל־WS Handshake ולשאר שלבי השיחות.