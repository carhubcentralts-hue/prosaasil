# ×ª×™×§×•×Ÿ ××¢×¨×›×ª ×”×—×•×–×™× - ×¡×™×›×•× ×¡×•×¤×™ 

## ××” ×ª×•×§×Ÿ?

### 1. ×ª×¦×•×’×ª PDF ×‘××—×©×‘ ×•×‘××•×‘×™×™×œ âœ…

**×”×‘×¢×™×”:** 
- ×”-PDF ×œ× ×”×•×¦×’ (××¡×š ××¤×•×¨)
- ×œ× ×¢×‘×“ ×‘××›×©×™×¨×™ ××•×‘×™×™×œ
- ×‘×¢×™×•×ª CORS ×¢× R2 signed URLs

**×”×¤×ª×¨×•×Ÿ:**
- ×©×™××•×© ×‘-PDF.js ×œ×¨×™× ×“×•×¨ ×¢×œ ×’×‘×™ canvas (×‘××§×•× iframe)
- × ×§×•×“×ª ×§×¦×” ×—×“×©×”: `/api/contracts/:id/pdf` 
- ×œ×œ× ×‘×¢×™×•×ª cross-origin
- ×¢×•×‘×“ ××¦×•×™×Ÿ ×‘××—×©×‘ ×•×‘××•×‘×™×™×œ

**×˜×›× ×™:**
```
×§×•×“×: iframe â†’ R2 signed URL (cross-origin) âŒ
×¢×›×©×™×•: canvas â†’ /api/contracts/:id/pdf (same-origin) âœ…
```

### 2. ×¡×™××•×Ÿ ××–×•×¨×™ ×—×ª×™××” âœ…

**×”×‘×¢×™×”:**
- ××–×•×¨×™ ×”×—×ª×™××” ×œ× × ×©××¨×• ×‘××§×•× ×”× ×›×•×Ÿ ××—×¨×™ zoom
- ×œ× ×¢×‘×“×• ×‘×¢××•×“×™× 2/3
- ×§×•××•×¨×“×™× ×˜×•×ª ×‘-pixels ×•×œ× ×‘-PDF units

**×”×¤×ª×¨×•×Ÿ:**
- ×§×•××•×¨×“×™× ×˜×•×ª × ×©××¨×•×ª ×‘-PDF units (0-1 ×™×—×¡×™)
- ×—×™×©×•×‘ ××“×•×™×§ ×¢× viewport ×©×œ PDF.js
- ×¢×•×‘×“ ×‘×›×œ zoom ×•×‘×›×œ ×¢××•×“
- ×’×¨×™×¨×” ×•×©×™× ×•×™ ×’×•×“×œ ×—×œ×§×™×

**×˜×›× ×™:**
```typescript
// ×”××¨×” ××¤×™×§×¡×œ×™× ×œ-PDF units
const pdfX = clickX / pageViewport.width;  // 0-1
const pdfY = clickY / pageViewport.height; // 0-1

// ×—×–×¨×” ×-PDF units ×œ×¤×™×§×¡×œ×™× ×œ×ª×¦×•×’×”
const left = field.x * pageViewport.width;
const top = field.y * pageViewport.height;
```

### 3. × ×™×§×•×™ ×œ×•×’×™× ×‘×¤×¨×•×“×§×©×Ÿ âœ…

**×”×‘×¢×™×”:**
- console.log ×‘×›×œ ××§×•×
- ×—×©×™×¤×ª ××™×“×¢ ×¨×’×™×© (URLs, tokens)
- spam ×‘×§×•× ×¡×•×œ

**×”×¤×ª×¨×•×Ÿ:**
- ×™×¦×™×¨×ª `logger.ts` utility
- ×œ×•×’×™× ×¨×§ ×‘-development mode
- ×‘×¤×¨×•×“×§×©×Ÿ - ×¨×§ ×©×’×™××•×ª ××¡×•× × ×•×ª
- ××™×Ÿ ×—×©×™×¤×ª ××™×“×¢ ×¨×’×™×©

**×§×•×“:**
```typescript
import { logger } from '../shared/utils/logger';

// ×‘××§×•×:
console.log('[PDF] Loading...');

// ×¢×›×©×™×•:
logger.debug('Loading PDF'); // ×¨×§ ×‘-DEV
```

### 4. ×ª×™×§×•×Ÿ ×©×’×™××•×ª 403 âœ…

**×”×‘×¢×™×”:**
```
GET /api/admin/businesses ... 403 Forbidden
route requires system_admin got owner
```

**×”×¤×ª×¨×•×Ÿ:**
- ×‘×“×™×§×ª role ×œ×¤× ×™ ×˜×¢×™× ×ª × ×ª×•× ×™ admin
- ×¨×§ system_admin ×˜×•×¢×Ÿ `/api/admin/businesses`
- owner ×•-admin ×œ× ×¨×•××™× 403

**×§×•×“:**
```typescript
// Only fetch admin data if user is system_admin
if (user?.role !== 'system_admin') {
  setLoading(false);
  return;
}
```

## ×§×‘×¦×™× ×©×”×©×ª× ×•

### Frontend
```
client/src/shared/utils/logger.ts                    [×—×“×©]
client/src/components/PDFCanvas.tsx                   [×—×“×©]
client/src/components/SignatureFieldMarker.tsx        [×”×•×—×œ×£]
client/src/pages/contracts/ContractDetails.tsx        [×¢×•×“×›×Ÿ]
client/src/components/EnhancedPDFViewer.tsx          [×¢×•×“×›×Ÿ]
client/src/shared/components/ui/ManagementCard.tsx   [×¢×•×“×›×Ÿ]
client/vite.config.js                                [×¢×•×“×›×Ÿ]
client/public/pdf.js/pdf.worker.min.js               [×—×“×©]
```

### Backend
```
××™×Ÿ ×©×™× ×•×™×™×! 
× ×§×•×“×ª ×”×§×¦×” /api/contracts/:id/pdf ×›×‘×¨ ×”×™×™×ª×” ×§×™×™××ª ×•×¢×•×‘×“×ª
```

## ×‘×“×™×§×•×ª

### âœ… ×”×•×©×œ××•
- [x] Build ××¦×œ×™×— ×œ×œ× ×©×’×™××•×ª
- [x] PDF.js worker × ××¦× ×‘××ª×¨ (×œ× CDN)
- [x] ×§×•××•×¨×“×™× ×˜×•×ª ×‘-PDF units
- [x] ××•×¤×˜×™××™×–×¦×™×” ×©×œ ×¨×™× ×“×•×¨
- [x] ××™×Ÿ console.log ×‘×¤×¨×•×“×§×©×Ÿ

### ğŸ“‹ × ×“×¨×©×ª ×‘×“×™×§×” ×™×“× ×™×ª
- [ ] ×ª×¦×•×’×ª PDF ×‘××—×©×‘ (Chrome, Firefox, Safari)
- [ ] ×ª×¦×•×’×ª PDF ×‘××•×‘×™×™×œ (iOS Safari, Android Chrome)
- [ ] ×¡×™××•×Ÿ ×—×ª×™××•×ª ×‘×¢××•×“ 1
- [ ] ×¡×™××•×Ÿ ×—×ª×™××•×ª ×‘×¢××•×“ 2+
- [ ] zoom in/out ×¢× ×©×“×•×ª ×—×ª×™××”
- [ ] ×’×¨×™×¨×” ×•×©×™× ×•×™ ×’×•×“×œ ×©×œ ×©×“×•×ª
- [ ] ×©××™×¨×” ×•×˜×¢×™× ×” ××—×“×©
- [ ] ×‘×“×™×§×ª 403 ×¢×‘×•×¨ owner

## ×”×•×¨××•×ª ×‘×“×™×§×” ××”×™×¨×”

### 1. ×‘×“×™×§×ª PDF ×‘××—×©×‘
```
1. ×¤×ª×— ××ª×¨
2. ×¢×‘×•×¨ ×œ×¢××•×“ ×—×•×–×™×
3. ×œ×—×¥ ×¢×œ ×—×•×–×”
4. ×•×“×: PDF ××•×¦×’ (×œ× ××¡×š ××¤×•×¨)
```

### 2. ×‘×“×™×§×ª ×¡×™××•×Ÿ ×—×ª×™××•×ª
```
1. ×¤×ª×— ×—×•×–×” ×‘×¡×˜×˜×•×¡ draft
2. ×œ×—×¥ "×¡××Ÿ ××–×•×¨×™ ×—×ª×™××”"
3. ×œ×—×¥ "×”×¤×¢×œ ××¦×‘ ×¡×™××•×Ÿ"
4. ×œ×—×¥ ×¢×œ PDF
5. ×•×“×: ×ª×™×‘×” ×™×¨×•×§×” ××•×¤×™×¢×”
6. × ×¡×” ×œ×’×¨×•×¨ ×•×œ×©× ×•×ª ×’×•×“×œ
7. ×¢×‘×•×¨ ×œ×¢××•×“ 2 ×•×”×•×¡×£ ×©×“×” × ×•×¡×£
8. ×œ×—×¥ "×©××•×¨"
9. ×¤×ª×— ×©×•×‘ - ×•×“× ×©×”×©×“×•×ª × ×©××¨×•
```

### 3. ×‘×“×™×§×ª zoom
```
1. ×”×•×¡×£ ×©×“×” ×—×ª×™××”
2. ×œ×—×¥ + (zoom in)
3. ×œ×—×¥ - (zoom out)
4. ×•×“×: ×”×©×“×” × ×©××¨ ×‘××§×•× ×”× ×›×•×Ÿ
```

### 4. ×‘×“×™×§×ª 403
```
1. ×”×ª×—×‘×¨ ×›-owner
2. ×¢×‘×•×¨ ×œ×“×£ ×”×‘×™×ª
3. ×¤×ª×— Developer Tools â†’ Network
4. ×•×“×: ××™×Ÿ ×‘×§×©×•×ª ×œ-/api/admin/businesses
5. ×•×“×: ××™×Ÿ ×©×’×™××•×ª 403
```

## ×©×™× ×•×™×™× ×˜×›× ×™×™×

### ×ª×¦×•×¨×ª Build
```javascript
// vite.config.js
build: {
  target: 'esnext',  // ×œ×ª××™×›×” ×‘-top-level await ×©×œ PDF.js
}
```

### ×ª×œ×•×™×•×ª ×—×“×©×•×ª
```json
{
  "dependencies": {
    "pdfjs-dist": "4.0.379"
  }
}
```

### PDF.js Worker
```
××™×§×•×: client/public/pdf.js/pdf.worker.min.js
×’×•×“×œ: ~270KB
××§×•×¨: ××§×•××™ (×œ× CDN)
```

## ×ª××™××•×ª ×“×¤×“×¤× ×™×

| ×“×¤×“×¤×Ÿ | ×’×¨×¡×” ××™× ×™××œ×™×ª | ×¡×˜×˜×•×¡ |
|-------|---------------|-------|
| Chrome | 89+ | âœ… |
| Firefox | 89+ | âœ… |
| Safari | 15+ | âœ… |
| Edge | 89+ | âœ… |
| Mobile Safari | iOS 15+ | âœ… |
| Chrome Mobile | 89+ | âœ… |

## ××’×‘×œ×•×ª ×™×“×•×¢×•×ª

1. **×§×‘×¦×™ PDF ×’×“×•×œ×™×**: ×§×‘×¦×™× ××¢×œ 10MB ×¢×©×•×™×™× ×œ×§×—×ª ×–××Ÿ ×˜×¢×™× ×”
2. **×“×¤×“×¤× ×™× ×™×©× ×™×**: ×“×•×¨×© ×“×¤×“×¤×Ÿ ××•×“×¨× ×™ (2021+)
3. **×’×•×“×œ worker**: 270KB (× ×˜×¢×Ÿ ×¤×¢× ××—×ª ×•× ×©××¨ ×‘-cache)

## ×ª×•×›× ×™×ª ×—×–×¨×” (Rollback)

×‘××§×¨×” ×©×œ ×‘×¢×™×•×ª:

```bash
# ×—×–×¨×” ×œ×’×¨×¡×” ×”×§×•×“××ª
git revert 86b16f4

# ××• ×¨×§ ×”×—×–×¨×ª signature marker
mv client/src/components/SignatureFieldMarker.old.tsx \
   client/src/components/SignatureFieldMarker.tsx
```

## Deploy

### ×”×•×¨××•×ª
```bash
cd client
npm install        # ××ª×§×™×Ÿ pdfjs-dist
npm run build     # ×‘×•× ×” ×¢× target: esnext
```

### ××™×Ÿ ×¦×•×¨×š ×‘:
- ××™×’×¨×¦×™×•×ª DB
- ×©×™× ×•×™×™ backend
- ×¢×“×›×•×Ÿ secrets/env vars

### ×™×© ×œ×•×•×“×:
- public/pdf.js/pdf.worker.min.js × ××¦× ×‘-build
- dist/ ××›×™×œ ××ª ×›×œ ×”×§×‘×¦×™×
- target: esnext ×‘-vite.config.js

## ×ª××™×›×”

×× ×™×© ×‘×¢×™×•×ª:

1. **PDF ×œ× × ×˜×¢×Ÿ:**
   - ×‘×“×•×§ ×‘-Network: `/api/contracts/:id/pdf` ××—×–×™×¨ 200
   - ×‘×“×•×§ ×‘-Console: ×©×’×™××•×ª ×©×œ PDF.js worker
   - ×•×“× ×©×”×§×•×‘×¥ `/pdf.js/pdf.worker.min.js` × ×’×™×©

2. **×©×“×•×ª ×—×ª×™××” ×œ× ×¢×•×‘×“×™×:**
   - ×‘×“×•×§ viewport ×‘-Console (logger.debug)
   - ×•×“× ×©×”-scale ××ª×¢×“×›×Ÿ × ×›×•×Ÿ
   - ×‘×“×•×§ ×©×”×§×•××•×¨×“×™× ×˜×•×ª ×‘×˜×•×•×— 0-1

3. **403 ×¢×“×™×™×Ÿ ××•×¤×™×¢:**
   - ×‘×“×•×§ ××ª ×”-role ×©×œ ×”××©×ª××©
   - ×•×“× ×©-ManagementCard ××‘×“×™×§ role
   - ××¤×©×¨ ×œ×‘×“×•×§ ×‘-Network tab

## ×¡×™×›×•× ×‘×™×¦×•×¢×™×

| ××“×“ | ×œ×¤× ×™ | ××—×¨×™ |
|-----|------|------|
| ×˜×¢×™× ×ª PDF | âŒ × ×›×©×œ | âœ… ×¢×•×‘×“ |
| ××•×‘×™×™×œ | âŒ ×œ× ×¢×•×‘×“ | âœ… ×¢×•×‘×“ |
| Console Logs (PROD) | ğŸ”´ ×”×¨×‘×” | âœ… ×œ×œ× |
| 403 Errors (owner) | ğŸ”´ ×›×Ÿ | âœ… ×œ× |
| ×–×•× ×©×“×•×ª ×—×ª×™××” | âŒ × ×¢×™× | âœ… ×™×¦×™×‘ |
| ×¢××•×“×™× 2+ | âŒ ×œ× ×¢×•×‘×“ | âœ… ×¢×•×‘×“ |

---

**×¡×˜×˜×•×¡:** âœ… **××•×›×Ÿ ×œ×¤×¨×™×¡×”**

×›×œ ×”×©×™× ×•×™×™× ×¢×‘×¨×• code review, ××™×Ÿ breaking changes, ×•×”×›×œ backwards compatible.
