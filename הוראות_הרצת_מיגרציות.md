# הוראות הרצת מיגרציות 115-117

## הבעיה
```
ERROR: column appointments.calendar_id does not exist
```
דף תזמון ההודעות לא מציג כלום.

## הסיבה
מיגרציות 115, 116, 117 לא התבצעו על בסיס הנתונים בפרודקשן.

## הפתרון

### שלב 1: הרץ את המיגרציות

**כל המיגרציות נמצאות ב-`server/db_migrate.py`**. אין מיגרציות standalone!

הרץ את הפקודה הזו:

```bash
cd /path/to/your/project
python -m server.db_migrate
```

או אם רץ ב-Docker:

```bash
docker exec -it YOUR_CONTAINER_NAME python -m server.db_migrate
```

### שלב 2: אמת שהמיגרציות רצו

בדוק בלוגים שרואים:
```
✅ Migration 115 complete: Business calendars and routing rules system added
✅ Migration 116 complete: Scheduled WhatsApp messages system added  
✅ Migration 117 complete: 'scheduled_messages' page enabled for WhatsApp businesses
```

### שלב 3: אתחל את השרת

אחרי המיגרציות, אתחל את השרת כדי שיטען את השינויים.

## בדיקה בבסיס הנתונים

התחבר ל-PostgreSQL ובדוק:

```sql
-- בדוק שהטבלאות קיימות
SELECT table_name FROM information_schema.tables 
WHERE table_name IN ('business_calendars', 'calendar_routing_rules');

-- בדוק שהעמודה קיימת
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'appointments' AND column_name = 'calendar_id';
```

## אם המיגרציות לא רצות

בדוק משתני סביבה:

```bash
# ודא שמוגדר:
export RUN_MIGRATIONS=1
export SERVICE_ROLE=api  # לא worker!
export DATABASE_URL=postgresql://...

# ואז הרץ שוב:
python -m server.db_migrate
```

## מה המיגרציות עושות

**מיגרציה 115**: מערכת לוחות שנה
- יוצרת טבלה `business_calendars`
- יוצרת טבלה `calendar_routing_rules`
- מוסיפה עמודה `calendar_id` ל-`appointments`

**מיגרציה 116**: מערכת הודעות מתוזמנות
- יוצרת טבלה `scheduled_message_rules`
- יוצרת טבלה `scheduled_rule_statuses`
- יוצרת טבלה `scheduled_messages_queue`

**מיגרציה 117**: הפעלת דף תזמון הודעות
- מוסיפה `scheduled_messages` ל-`enabled_pages`

---

**חשוב**: כל המיגרציות ב-`server/db_migrate.py` בלבד! אין standalone scripts!
