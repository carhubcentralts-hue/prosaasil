# ×ª×™×§×•×Ÿ ××¢×¨×›×ª ×”×§×œ×˜×•×ª - ×¡×™×›×•× ×•×™×–×•××œ×™

## ğŸ¯ 3 ×ª×™×§×•× ×™× ×©×‘×•×¦×¢×•

### 1ï¸âƒ£ ×ª×™×§×•×Ÿ UnboundLocalError ×©×œ threading âœ…

**×œ×¤× ×™:**
```python
def start_recording_worker(app):
    # ... code ...
    if retry_count < 2:
        import time
        import threading  # âŒ ×‘×¢×™×”: import ××§×•××™
        
        retry_thread = threading.Thread(...)  # UnboundLocalError!
```

**××—×¨×™:**
```python
# ×‘×¨××© ×”×§×•×‘×¥
import threading  # âœ… import ×‘×¨××ª ×”××•×“×•×œ

def start_recording_worker(app):
    # ... code ...
    if retry_count < 2:
        import time
        # threading ×›×‘×¨ ×§×™×™×!
        
        retry_thread = threading.Thread(...)  # ×¢×•×‘×“!
```

---

### 2ï¸âƒ£ ×¢×¦×™×¨×ª ×¡×¤×× ×”×§×œ×˜×•×ª ××•×˜×•××˜×™ âœ…

**×œ×¤× ×™ (×—×©×©):**
```
××©×ª××© ×¤×•×ª×— ×“×£ "×©×™×—×•×ª ××—×¨×•× ×•×ª"
    â†“
list_calls() ××—×–×™×¨ 50 ×©×™×—×•×ª
    â†“
??? ×”×× ××•×¨×™×“ 50 ×”×§×œ×˜×•×ª ××•×˜×•××˜×™×ª ???
    â†“
ğŸ’¥ ×¡×¤××!
```

**××—×¨×™ (×××•××ª):**
```
××©×ª××© ×¤×•×ª×— ×“×£ "×©×™×—×•×ª ××—×¨×•× ×•×ª"
    â†“
list_calls() ××—×–×™×¨ ×¨×§ ××˜×-×“××˜×”
    â†“
××¤×¡ ×”×•×¨×“×•×ª! âœ…
    â†“
×¨×§ ×›×©×œ×•×—×¦×™× "â–¶ × ×’×Ÿ" â†’ ×”×•×¨×“×” ×‘×•×“×“×ª
```

---

### 3ï¸âƒ£ ××¢×¨×›×ª Semaphore: 3 ×”×•×¨×“×•×ª ××§×‘×™×œ×•×ª ×œ×¢×¡×§ âœ…

#### ××¨×›×™×˜×§×˜×•×¨×”

**×œ×¤× ×™ (Counter):**
```
rec_slots:123 = "2"  â† ××¡×¤×¨ ×©×œ× (GET/INCR/DECR)
```
âŒ ×‘×¢×™×”: ×œ× ××˜×•××™, ××™×Ÿ ×¨×©×™××ª call_sid

**××—×¨×™ (SET):**
```
rec_slots:123 = {"CAaaa", "CAbbb", "CAccc"}  â† SET ×©×œ call_sid
```
âœ… ×™×ª×¨×•×Ÿ: ××˜×•××™ ×¢× SADD/SREM/SCARD

#### ×ª×¨×©×™× ×–×¨×™××”

```
××©×ª××© ×œ×•×—×¥ "â–¶ × ×’×Ÿ" ×¢×œ ×”×§×œ×˜×”
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API: stream_recording()             â”‚
â”‚ (server/routes_calls.py)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â†“ 1. ×‘×“×™×§×”: ×”×× ×§×™×™× ××§×•××™×ª?
    â†“
    âœ“ ×›×Ÿ â†’ 200 OK (stream ××™×™×“×™)
    âœ— ×œ× â†’ ×”××©×š â†“
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ×‘×“×™×§×”: rec_inflight ×§×™×™×?      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    âœ“ ×›×Ÿ â†’ 202 "processing" (×‘×œ×™ enqueue)
    âœ— ×œ× â†’ ×”××©×š â†“
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. try_acquire_slot()               â”‚
â”‚ (Lua script - ××˜×•××™)                â”‚
â”‚                                     â”‚
â”‚ if SCARD(rec_slots) < 3:           â”‚
â”‚     SADD rec_slots call_sid        â”‚
â”‚     SETEX rec_inflight 120s        â”‚
â”‚     return 1                        â”‚
â”‚ else:                               â”‚
â”‚     RPUSH rec_queue call_sid       â”‚
â”‚     SADD rec_queued                 â”‚
â”‚     return 0                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”œâ”€ 1 (×ª×¤×¡ slot) â†’ enqueue ×œ×¢×•×‘×“ â†’ 202 "processing"
    â”‚                   ğŸ§ RECORDING_ENQUEUE
    â”‚
    â””â”€ 0 (×ª×•×¨ ××œ×)   â†’ 202 "queued"
                        â³ RECORDING_QUEUED
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORKER: download_recording_only()   â”‚
â”‚ (server/tasks_recording.py)        â”‚
â”‚                                     â”‚
â”‚ ××•×¨×™×“ ×§×•×‘×¥ ×-Twilio                 â”‚
â”‚ ×©×•××¨ ×‘-R2/×“×™×¡×§                      â”‚
â”‚                                     â”‚
â”‚ finally:                            â”‚
â”‚   release_slot()  â† ×ª××™×“!          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ release_slot()                      â”‚
â”‚ (Lua script - ××˜×•××™)                â”‚
â”‚                                     â”‚
â”‚ SREM rec_slots call_sid            â”‚
â”‚ DEL rec_inflight                    â”‚
â”‚ next = LPOP rec_queue              â”‚
â”‚                                     â”‚
â”‚ if next:                            â”‚
â”‚     SADD rec_slots next            â”‚
â”‚     SETEX rec_inflight next        â”‚
â”‚     enqueue next job                â”‚
â”‚     â¡ï¸ RECORDING_NEXT              â”‚
â”‚                                     â”‚
â”‚ âœ… RECORDING_DONE                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ×“×•×’××”: 10 ×”×§×œ×˜×•×ª ×‘×‘×ª ××—×ª

```
××©×ª××© ×œ×•×—×¥ 10 ×¤×¢××™× "â–¶ × ×’×Ÿ" ××”×¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redis State: rec_slots:123                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ CA1  â”‚ CA2  â”‚ CA3  â”‚  â”‚ Queue: CA4, CA5, â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜  â”‚ CA6, CA7, CA8,   â”‚ â”‚
â”‚ â†‘ 3 ×¤×¢×™×œ×™× (MAX)        â”‚ CA9, CA10         â”‚ â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†‘ 7 ×‘×ª×•×¨             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ§ RECORDING_ENQUEUE business_id=123 sid=CA1xxx active=1/3
ğŸ§ RECORDING_ENQUEUE business_id=123 sid=CA2xxx active=2/3
ğŸ§ RECORDING_ENQUEUE business_id=123 sid=CA3xxx active=3/3
â³ RECORDING_QUEUED business_id=123 sid=CA4xxx queue_len=1
â³ RECORDING_QUEUED business_id=123 sid=CA5xxx queue_len=2
â³ RECORDING_QUEUED business_id=123 sid=CA6xxx queue_len=3
â³ RECORDING_QUEUED business_id=123 sid=CA7xxx queue_len=4
â³ RECORDING_QUEUED business_id=123 sid=CA8xxx queue_len=5
â³ RECORDING_QUEUED business_id=123 sid=CA9xxx queue_len=6
â³ RECORDING_QUEUED business_id=123 sid=CA10xx queue_len=7

... CA1 ××¡×™×™× ×”×•×¨×“×” ...

âœ… RECORDING_DONE business_id=123 sid=CA1xxx active=2/3
â¡ï¸ RECORDING_NEXT business_id=123 sid=CA4xxx active=3/3

... CA2 ××¡×™×™× ×”×•×¨×“×” ...

âœ… RECORDING_DONE business_id=123 sid=CA2xxx active=2/3
â¡ï¸ RECORDING_NEXT business_id=123 sid=CA5xxx active=3/3

... ×•×›×Ÿ ×”×œ××” ×¢×“ ×©×”×›×œ ××¡×™×™×
```

---

## ğŸ”‘ Redis Keys

| Key | Type | Content | TTL | Purpose |
|-----|------|---------|-----|---------|
| `rec_slots:123` | SET | `{"CA1", "CA2", "CA3"}` | âˆ | 3 ×¤×¢×™×œ×™× |
| `rec_inflight:123:CA1` | STRING | `"processing"` | 120s | ××•× ×¢ ×›×¤×™×œ×•×™×•×ª |
| `rec_queued:123` | SET | `{"CA4", "CA5", ...}` | 20min | ×‘×ª×•×¨ (dedup) |
| `rec_queue:123` | LIST | `["CA4", "CA5", ...]` | âˆ | FIFO ×ª×•×¨ |

---

## âœ… ×§×¨×™×˜×¨×™×•× ×™× ×¢××“×•

| # | ×“×¨×™×©×” | ×¡×˜×˜×•×¡ |
|---|-------|-------|
| 1 | ×ª×™×§×•×Ÿ threading UnboundLocalError | âœ… |
| 2 | ××¤×¡ enqueue ×‘×˜×¢×™× ×ª ×“×£ | âœ… |
| 3 | 3 ××§×‘×™×œ×™ ×œ×¢×¡×§ (SET) | âœ… |
| 4 | ××¤×¡ rate_limit ×™×©×Ÿ | âœ… |
| 5 | ×œ×•×’×™× × ×›×•× ×™× | âœ… |
| 6 | ××˜×•××™ (Lua) | âœ… |
| 7 | Worker ×‘×œ×‘×“ ××•×¨×™×“ | âœ… |
| 8 | ×‘×“×™×§×•×ª ×¢×•×‘×¨×•×ª | âœ… |
| 9 | ××‘×˜×—×” (CodeQL) | âœ… 0 alerts |

---

## ğŸš€ ×¤×¨×™×¡×”

### ××©×ª× ×™ ×¡×‘×™×‘×”

```bash
# Worker Service ×‘×œ×‘×“:
ENABLE_SCHEDULERS=true

# API Service:
ENABLE_SCHEDULERS=false  # ××• ×œ× ××•×’×“×¨

# ×©× ×™×”× ×¦×¨×™×›×™×:
REDIS_URL=redis://...
```

### ×‘×“×™×§×•×ª ××—×¨×™ ×¤×¨×™×¡×”

```bash
# 1. ×˜×¢×™× ×ª ×“×£ Recent Calls â†’ 0 ×œ×•×’×™× ×©×œ RECORDING_ENQUEUE
grep "RECORDING_ENQUEUE" /var/log/app.log

# 2. ×œ×—×™×¦×” ×¢×œ 10 ×”×§×œ×˜×•×ª â†’ 3 active, 7 queued
# ×¦×¨×™×š ×œ×¨××•×ª:
# ğŸ§ RECORDING_ENQUEUE ... active=1/3
# ğŸ§ RECORDING_ENQUEUE ... active=2/3
# ğŸ§ RECORDING_ENQUEUE ... active=3/3
# â³ RECORDING_QUEUED ... queue_len=1
# â³ RECORDING_QUEUED ... queue_len=2
# ...

# 3. ×‘×“×™×§×ª Redis
redis-cli SCARD rec_slots:123
# ×¦×¨×™×š ×œ×”×—×–×™×¨ 0-3
```

---

## ğŸ“ ×§×‘×¦×™× ×©×©×•× ×•

1. âœï¸ `server/tasks_recording.py` - ×ª×™×§×•×Ÿ threading, ×”×¡×¨×ª rate limiting
2. âœï¸ `server/recording_semaphore.py` - SET ×‘××§×•× counter, ××˜×•××™×•×ª
3. â• `test_recording_semaphore_fix.py` - ×‘×“×™×§×•×ª ××§×™×¤×•×ª
4. â• `RECORDING_SYSTEM_FIX_SUMMARY.md` - ×ª×™×¢×•×“ ××œ×

---

## ğŸ‰ ×¡×˜×˜×•×¡ ×¡×•×¤×™

âœ… **×”×›×œ ×¢×•×‘×“!**
- ××¤×¡ ×©×’×™××•×ª
- ××¤×¡ ×—×•×œ×©×•×ª ××‘×˜×—×”  
- ×›×œ ×”×‘×“×™×§×•×ª ×¢×•×‘×¨×•×ª
- ×ª×™×¢×•×“ ××œ×
- ××•×›×Ÿ ×œ×¤×¨×•×“×§×©×Ÿ

---

*× ×•×¦×¨: 2026-01-25*
