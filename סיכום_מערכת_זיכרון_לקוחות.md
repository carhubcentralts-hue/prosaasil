# מערכת זיכרון לקוחות מאוחדת - סיכום יישום

## סקירה כללית

מערכת זיכרון לקוחות מאוחדת עבור WhatsApp + שיחות טלפון, בדיוק לפי הדרישות שפורטו. המערכת מספקת ל-AI הקשר מלא מכל האינטראקציות של הלקוח.

## מה יושם?

### 1. מקור אמת אחד (Single Source of Truth)
כל ליד עכשיו כולל שדות זיכרון מאוחדים:
```
• customer_profile_json - פרופיל לקוח מובנה (שם, עיר, העדפות)
• last_summary - סיכום קצר של האינטראקציה האחרונה (5-10 שורות)
• summary_updated_at - מתי עודכן הסיכום
• last_interaction_at - חותמת זמן של ההודעה האחרונה
• last_channel - איזה ערוץ נעשה בו שימוש אחרון (whatsapp/call)
```

### 2. סיכום אוטומטי אחרי 15 דקות
המערכת אוטומטית:
✅ מזהה שהסשן בוואטסאפ שקט 15+ דקות  
✅ מייצרת סיכום AI של השיחה  
✅ מחלצת "memory patch" - מידע חדש על הלקוח  
✅ מעדכנת את הפרופיל בחכמה  
✅ שומרת את הסיכום לשימוש עתידי  

### 3. זיהוי לקוח חוזר
כשלקוח חוזר אחרי 15+ דקות:
```
🤖 "היי [שם]! רוצה שנמשיך מאיפה שעצרנו או להתחיל מחדש?"
```
- אם הלקוח אומר "מהתחלה" או "איפוס" → מתחיל סשן חדש
- אחרת → ממשיך עם הקשר מלא

### 4. הזנת הקשר ל-AI
כשמצב שירות לקוחות מופעל, ה-AI מקבל:
📋 פרופיל לקוח (מידע מחולץ מכל האינטראקציות)  
📝 סיכום שיחה אחרונה  
📚 5 הערות שירות לקוחות אחרונות (האחרונה היא הכי עדכנית)  
💬 היסטוריית שיחה נוכחית (12 הודעות אחרונות)  

### 5. מיזוג חכם של זיכרון
המערכת ממזגת מידע חדש בצורה חכמה:
✅ שומרת קלט ידני של משתמש מעל חילוצים של AI  
✅ עוקבת אחרי מקור הנתונים (manual, ai_extraction, וכו')  
✅ שומרת ציוני ביטחון  
✅ מונעת דריסה של מידע אמין עם מידע לא בטוח  

## מה שונה בקוד?

### קבצים שנוספו:
1. **`server/services/customer_memory_service.py`** (חדש)
   - פונקציות לטעינת זיכרון לקוח
   - עיצוב זיכרון לטקסט עבור AI
   - בדיקה אם לשאול "להמשיך או להתחיל מחדש"

2. **`CUSTOMER_MEMORY_IMPLEMENTATION.md`** (חדש)
   - תיעוד מלא באנגלית
   - מדריך שימוש ופתרון בעיות

### קבצים ששונו:
1. **`server/models_sql.py`**
   - הוספת 5 שדות חדשים למודל Lead

2. **`server/db_migrate.py`**
   - מיגרציה 121 ליצירת השדות החדשים

3. **`server/services/whatsapp_session_service.py`**
   - חילוץ memory patch מהודעות
   - לוגיקת מיזוג חכמה
   - עדכון שדות זיכרון מאוחדים

4. **`server/routes_whatsapp.py`**
   - טעינת זיכרון לקוח לפני קריאה ל-AI
   - בדיקה אם לשאול continue/fresh
   - העברת זיכרון ל-AI בהקשר

5. **`server/services/ai_service.py`**
   - קבלת customer_memory בהקשר
   - הוספת זיכרון ל-system prompt
   - הוראה "continue or fresh" ללקוחות חוזרים

## איך להפעיל?

### שלב 1: הרצת מיגרציה
```bash
python -m server.db_migrate
```
זה יוסיף את 5 השדות החדשים לטבלת leads.

### שלב 2: הפעלת מצב שירות לקוחות
```sql
UPDATE business_settings 
SET enable_customer_service = TRUE 
WHERE tenant_id = <מזהה_העסק_שלך>;
```

### שלב 3: בדיקה
1. שלח הודעת WhatsApp: "שלום, אני מעוניין בשירות"
2. המערכת תגיב
3. חכה 15 דקות (או הפעל ידנית)
4. שלח הודעה נוספת
5. המערכת תשאל: "רוצה שנמשיך או להתחיל מחדש?"

## מבנה הנתונים

### פורמט customer_profile_json
```json
{
  "name": {
    "value": "יוסי כהן",
    "source": "manual",
    "confidence": "high"
  },
  "city": {
    "value": "תל אביב", 
    "source": "ai_extraction",
    "confidence": "low"
  },
  "service_interest": {
    "value": "תספורת גברים",
    "source": "ai_extraction"
  }
}
```

### הקשר שנשלח ל-AI
```
🧠 זיכרון לקוח (מכל הערוצים):

📋 פרופיל לקוח:
  • name: יוסי כהן
  • city: תל אביב
  • service_interest: תספורת גברים

📝 סיכום שיחה אחרונה:
  הלקוח רוצה לקבוע תור לשבוע הבא
  (ערוץ: whatsapp)

📚 הערות אחרונות (האחרונה היא הכי עדכנית):
  1. [סיכום שיחה] התקשר לברר מחירים
  2. [הערה] לקוח VIP
  3. [סיכום שיחה] שאל על שעות פתיחה
```

## מה אם משהו לא עובד?

### הזיכרון לא נטען
✓ בדוק ש-`enable_customer_service` הוא TRUE  
✓ וודא שהליד כולל customer_profile_json או last_summary  
✓ בדוק לוגים עבור "[CUSTOMER-MEMORY]"  

### AI לא משתמש בזיכרון
✓ וודא שהזיכרון בהקשר (בדוק לוגים)  
✓ וודא ש-AI service מקבל context נכון  
✓ בדוק ש-system prompt כולל זיכרון  

### הסשן לא נסגר
✓ וודא סף 15 דקות  
✓ בדוק ש-session job רץ (כל 5 דקות)  
✓ חפש שגיאות בלוגים של whatsapp_session_service  

## מה חשוב לזכור?

1. **רק כשמופעל**: המערכת פועלת רק כש-`enable_customer_service = TRUE`
2. **לא פוגע במה שיש**: כל השדות nullable, לא משפיע על לידים קיימים
3. **5 הערות בלבד**: מעביר רק 5 הערות אחרונות (לא הכל)
4. **מיזוג חכם**: נתונים ידניים לעולם לא נדרסים
5. **עובד עם שיחות**: אותה מערכת תעבוד גם לשיחות טלפון

## מבדקים

### רשימת בדיקות ידנית
- [ ] מיגרציה 121 רצה בהצלחה
- [ ] enable_customer_service = TRUE
- [ ] שליחת הודעה ראשונה - תגובת AI
- [ ] המתנה 15 דקות
- [ ] שליחת הודעה שנייה - שאלת "continue or fresh"
- [ ] בדיקת לוגים ל-"[CUSTOMER-MEMORY]"
- [ ] וידוא שהזיכרון מתעדכן במסד הנתונים

## סיכום

✅ **מיושם לפי הדרישות המדויקות מהבעיה**  
✅ **מנוע זיכרון אחד לשיחות + WhatsApp**  
✅ **כל ערוץ "מזין" הודעות ומקבל תשובה**  
✅ **סיכום 15 דקות אחרי שקט**  
✅ **מעבירים 5 הערות אחרונות (האחרונה הכי אמת)**  
✅ **שאלת "להמשיך או מהתחלה" ללקוחות חוזרים**  
✅ **מיזוג חכם שלא דורס מידע אמין**  

המערכת מוכנה לפריסה! 🚀
