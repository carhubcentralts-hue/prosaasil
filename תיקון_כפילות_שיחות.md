# תיקון כפילות שיחות וסיווג כיוון שיחות

## הבעיה שתוקנה

### 1. כפילות רשומות שיחה
**הבעיה:** Twilio יוצר לפעמים שני רשומות לאותה שיחה:
- Parent Call (outbound-api) - שיחה קצרה של שניה
- Child Leg (outbound-dial) - השיחה האמיתית

**הפתרון:**
- הוספנו שדה `parent_call_sid` למעקב אחרי קשרי הורה-ילד
- ה-API מסנן אוטומטית שיחות הורה קצרות
- מציג רק את רגלי הילד (השיחות האמיתיות)

### 2. מיפוי כיוון שגוי
**הבעיה:** Twilio מחזיר ערכים כמו `outbound-api`, `outbound-dial` שלא מופו נכון

**הפתרון:**
- הוספנו שדה `twilio_direction` לשמירת הערך המקורי מ-Twilio
- יצרנו פונקציה `normalize_call_direction()` שממפה:
  - `outbound-*` → `outbound`
  - `inbound-*` → `inbound`
  - אחרת → `unknown`

### 3. אין פילטר בממשק
**הבעיה:** לא היה פילטר לסינון שיחות נכנסות/יוצאות בטאב שיחות טלפון

**הפתרון:**
- הוספנו dropdown עם אפשרויות: "כל השיחות", "שיחות נכנסות", "שיחות יוצאות"
- הפילטר עובד בצד לקוח (מהיר ללא טעינה נוספת)

### 4. Webhooks לא תפסו נתונים
**הבעיה:** ה-webhooks לא תפסו את `Direction` ו-`ParentCallSid` מ-Twilio

**הפתרון:**
- עדכנו את כל ה-webhooks:
  - `/webhook/incoming_call`
  - `/webhook/call_status`
  - `/webhook/handle_recording`
  - `/webhook/stream_status`
- כולם עכשיו תופסים ושומרים את הנתונים החדשים

## שינויים בקוד

### מסד נתונים (Migration 41)
```sql
-- שדה חדש: parent_call_sid
ALTER TABLE call_log ADD COLUMN parent_call_sid VARCHAR(64);
CREATE INDEX idx_call_log_parent_call_sid ON call_log(parent_call_sid);

-- שדה חדש: twilio_direction
ALTER TABLE call_log ADD COLUMN twilio_direction VARCHAR(32);
CREATE INDEX idx_call_log_twilio_direction ON call_log(twilio_direction);
```

### קוד Backend

#### 1. פונקציית נרמול כיוון (`server/tasks_recording.py`)
```python
def normalize_call_direction(twilio_direction):
    """
    ממיר ערכי Twilio Direction לערכים פשוטים
    outbound-api/outbound-dial → outbound
    inbound → inbound
    """
    if not twilio_direction:
        return "unknown"
    
    twilio_dir_lower = str(twilio_direction).lower()
    
    if twilio_dir_lower.startswith("outbound"):
        return "outbound"
    elif twilio_dir_lower.startswith("inbound"):
        return "inbound"
    else:
        return "unknown"
```

#### 2. Upsert Logic (`server/tasks_recording.py`)
```python
def save_call_status_async(call_sid, status, duration=0, direction="inbound", 
                          twilio_direction=None, parent_call_sid=None):
    """
    UPSERT logic: מעדכן אם קיים, יוצר אם לא
    מונע כפילויות ממספר קריאות webhook
    """
    call_log = CallLog.query.filter_by(call_sid=call_sid).first()
    
    if call_log:
        # UPDATE: עדכון רשומה קיימת
        call_log.call_status = status
        if duration > 0:
            call_log.duration = duration
        if twilio_direction:
            call_log.twilio_direction = twilio_direction
            call_log.direction = normalize_call_direction(twilio_direction)
        if parent_call_sid:
            call_log.parent_call_sid = parent_call_sid
    # else: רשומה לא קיימת - אמור להיווצר ב-incoming_call
```

#### 3. סינון שיחות הורה (`server/routes_calls.py`)
```python
@calls_bp.route("/api/calls", methods=["GET"])
def list_calls():
    """
    מסנן שיחות הורה קצרות כברירת מחדל
    מציג רק שיחות אמיתיות או רגלי ילד
    """
    # ...
    if not show_all:
        # סינון חכם: העדף רגלי ילד על פני שיחות הורה
        query = query.filter(
            or_(
                Call.parent_call_sid.isnot(None),  # זה רגל ילד
                and_(
                    Call.parent_call_sid.is_(None),  # אין הורה
                    or_(
                        not_(parent_exists),  # ולא הורה של שיחה אחרת
                        Call.duration > 1  # או משך משמעותי
                    )
                )
            )
        )
```

### קוד Frontend (`client/src/pages/Leads/LeadDetailPage.tsx`)

#### פילטר כיוון
```typescript
function CallsTab({ calls, loading, leadId, onRefresh }) {
  const [directionFilter, setDirectionFilter] = useState<'all' | 'incoming' | 'outgoing'>('all');

  // סינון שיחות לפי כיוון
  const filteredCalls = directionFilter === 'all' 
    ? calls 
    : calls.filter(call => call.call_type === directionFilter);

  return (
    <Card>
      <div className="flex items-center justify-between">
        <h3>היסטוריית שיחות טלפון</h3>
        
        {/* פילטר כיוון */}
        <select value={directionFilter} onChange={(e) => setDirectionFilter(e.target.value)}>
          <option value="all">כל השיחות</option>
          <option value="incoming">שיחות נכנסות</option>
          <option value="outgoing">שיחות יוצאות</option>
        </select>
      </div>
      
      {/* רשימת שיחות מסוננת */}
      {filteredCalls.map(call => ...)}
    </Card>
  );
}
```

## הרצת המיגרציה

### אופציה 1: סקריפט ייעודי
```bash
python3 run_call_fix_migration.py
```

### אופציה 2: מיגרציה רגילה
```bash
python3 -m server.db_migrate
```

### אופציה 3: דרך השרת
המיגרציה תרוץ אוטומטית כשהשרת עולה.

## בדיקה שהתיקון עובד

### 1. בדוק שהשדות נוספו
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'call_log' 
  AND column_name IN ('parent_call_sid', 'twilio_direction');
```

### 2. בצע שיחת בדיקה
1. התקשר למספר המערכת
2. בדוק בממשק:
   - השיחה מסווגת כ"שיחה נכנסת"
   - אין שיחות כפולות
   - הפילטר עובד

### 3. בדוק במסד הנתונים
```sql
-- שיחות עם parent_call_sid (רגלי ילד)
SELECT call_sid, parent_call_sid, direction, twilio_direction, duration
FROM call_log
WHERE parent_call_sid IS NOT NULL
ORDER BY created_at DESC
LIMIT 10;

-- התפלגות כיוונים
SELECT direction, COUNT(*) as count
FROM call_log
GROUP BY direction;
```

## שאלות ותשובות

**ש: מה קורה לשיחות ישנות?**
ת: שיחות ישנות לא יעודכנו. השדות החדשים יהיו NULL. רק שיחות חדשות יתפסו את הנתונים.

**ש: האם זה ישבור משהו קיים?**
ת: לא. השדות חדשים הם nullable והקוד תומך גם בשיחות ללא הנתונים האלה.

**ש: מה אם אני רוצה לראות גם שיחות הורה?**
ת: הוסף `?show_all=true` ל-URL של ה-API:
```
/api/calls?show_all=true
```

**ש: איך אני יודע שזה עובד?**
ת: 
1. בדוק שהמיגרציה רצה בהצלחה
2. בצע שיחת בדיקה
3. ראה שיחה אחת בממשק (לא כפולה)
4. בדוק ש-direction מוצג נכון

## תיעוד טכני

### Webhooks שעודכנו

1. **`/webhook/incoming_call`** - תפיסת Direction ו-ParentCallSid בשיחות נכנסות
2. **`/webhook/call_status`** - עדכון סטטוס עם נתוני כיוון
3. **`/webhook/handle_recording`** - תיקון באג + תפיסת נתונים
4. **`/webhook/stream_status`** - תפיסת נתונים בזרם

### שדות חדשים ב-CallLog

| שדה | סוג | תיאור |
|-----|-----|-------|
| `parent_call_sid` | VARCHAR(64) | SID של שיחת ההורה (אם זה רגל ילד) |
| `twilio_direction` | VARCHAR(32) | הערך המקורי מ-Twilio (outbound-api, outbound-dial, וכו') |

### תהליך הסינון

```
Webhook מ-Twilio
    ↓
תפיסת Direction + ParentCallSid
    ↓
normalize_call_direction()
    ↓
שמירה ב-DB (direction + twilio_direction)
    ↓
API מסנן שיחות הורה
    ↓
UI מציג רק שיחות אמיתיות
```

## סיכום

✅ כפילויות שיחה - **תוקן**
✅ מיפוי כיוון - **תוקן**
✅ פילטר בממשק - **נוסף**
✅ תפיסת נתונים בwebhooks - **תוקן**
✅ מיגרציות - **מוכן**

השינויים ממזערים מאוד ומדויקים - רק מה שצריך לתקן את הבעיה.
