# ×ª×™×§×•×Ÿ ×›×¤×™×œ×•×™×•×ª ×‘××™×’×¨×¦×™×•×ª - ×¡×™×›×•× ×”×—×§×™×¨×” ×•×”×ª×™×§×•×Ÿ

## ×¨×§×¢ - ×”×‘×¢×™×” ×”××§×•×¨×™×ª

××”×œ×•×’×™×:
- Migration 109 × ×›×©×œ×ª ×¢×œ `ALTER TABLE call_log ADD COLUMN started_at...` ×¢× statement timeout
- ××—×¨×™ ×–×” ×”××¢×¨×›×ª ×××©×™×›×” ×•××“×¤×™×¡×” "Migration completed successfully"
- ×”××¤×œ×™×§×¦×™×” × ×•×¤×œ×ª ×¢×: `UndefinedColumn: column call_log.started_at does not exist`
- ×™×© ×œ×•×’×™× ×©×œ "already exists" ×‘××™×’×¨×¦×™×•×ª ××—×¨×•×ª (×¨×™×¦×•×ª ×—×•×–×¨×•×ª)

## ×ª×•×¦××•×ª ×”×—×§×™×¨×”

### 1. ×›×¤×™×œ×•×™×•×ª ×‘×§×•×‘×¥ - âœ… ×œ× × ××¦××•

×‘×“×§× ×• ×× ×™×© ×”×’×“×¨×•×ª ×›×¤×•×œ×•×ª ×©×œ ××•×ª×Ÿ ×¢××•×“×•×ª ×‘-`db_migrate.py`:

**×ª×•×¦××”**: ××™×Ÿ ×›×¤×™×œ×•×™×•×ª!
- `started_at`, `ended_at`, `duration_sec` ××•×¤×™×¢×™× ×¨×§ ×‘××™×’×¨×¦×™×” 109
- ×¢××•×“×•×ª ×“×•××•×ª ×‘×˜×‘×œ×” ××—×¨×•×ª:
  - `stream_started_at`, `stream_ended_at`, `stream_duration_sec` (××™×’×¨×¦×™×” ××—×¨×ª)
  - `dial_started_at` (×‘×˜×‘×œ×” ××—×¨×ª - outbound_call_jobs)
  - `audio_duration_sec` (×¢××•×“×” ××—×¨×ª)

### 2. Idempotency - âœ… ×›×‘×¨ ×ª×§×™×Ÿ

×”××™×’×¨×¦×™×” ×›×‘×¨ ××©×ª××©×ª ×‘-`IF NOT EXISTS`:

```sql
ALTER TABLE call_log ADD COLUMN IF NOT EXISTS started_at TIMESTAMP DEFAULT NULL
ALTER TABLE call_log ADD COLUMN IF NOT EXISTS ended_at TIMESTAMP DEFAULT NULL
ALTER TABLE call_log ADD COLUMN IF NOT EXISTS duration_sec INTEGER DEFAULT NULL
```

×–×” ××•××¨ ×©××¤×©×¨ ×œ×”×¨×™×¥ ××ª ×”××™×’×¨×¦×™×” ×¤×¢××™×™× ×‘×œ×™ ×©×ª×©×‘×•×¨.

### 3. ×¨×™×¦×” ×›×¤×•×œ×” ××›××” ×©×™×¨×•×ª×™× - âœ… ×›×‘×¨ ×ª×•×§×Ÿ

×‘×“×§× ×• ××ª `docker-compose.yml` ×•-`docker-compose.prod.yml`:
- ×™×© ×©×™×¨×•×ª ×™×™×¢×•×“×™ `migrate` ×©×¨×¥ ×¤×¢× ××—×ª ×‘×œ×‘×“
- ×›×œ ×”×©×™×¨×•×ª×™× ×”××—×¨×™× (API, worker, calls) ××’×“×™×¨×™× `RUN_MIGRATIONS=0`
- ×›×œ ×”×©×™×¨×•×ª×™× ××—×›×™× ×œ-`migrate` ×œ×¡×™×™× ×‘×”×¦×œ×—×” ×œ×¤× ×™ ×©×”× ××ª×—×™×œ×™×

### 4. ×”×‘××’ ×”×××™×ª×™ - âŒ × ××¦× ×•×ª×•×§×Ÿ!

**×”×‘×¢×™×”**: ×›××©×¨ ××™×’×¨×¦×™×” 109 × ×›×©×œ×ª, ×”×§×•×“:
1. ××“×¤×™×¡ "âŒ Migration 109 failed"
2. ××’×“×™×¨ `migration_success = False`
3. ××“×¤×™×¡ "âš ï¸ Migration 109 incomplete"
4. **×××©×™×š ×œ×”×¨×™×¥ ××™×’×¨×¦×™×•×ª 110, 111...**
5. **××“×¤×™×¡ "âœ… Migration completed successfully!" ×‘×¡×•×£**
6. **×™×•×¦× ×¢× exit code 0**

**×”×ª×•×¦××”**: Docker ×—×•×©×‘ ×©×”××™×’×¨×¦×™×” ×”×¦×œ×™×—×” ×•××¢×œ×” ××ª ×”×©×™×¨×•×ª×™×, ××‘×œ ×”×¡×›×™××” ×—×¡×¨×” ×¢××•×“×•×ª!

## ×”×ª×™×§×•×Ÿ ×©×‘×™×¦×¢× ×•

### 1. Fail Hard ×¢×œ ×©×’×™××•×ª DDL

×©×™× ×™× ×• ××ª ×”×§×•×“ ×›×š ×©×›××©×¨ `exec_ddl` × ×›×©×œ (timeout, lock, ×•×›×•'):

```python
except Exception as e:
    checkpoint(f"âŒ Migration 109 failed: {e}")
    logger.error(f"Migration 109 error: {e}", exc_info=True)
    db.session.rollback()
    # ğŸ”¥ CRITICAL: Fail hard - stop all migrations and exit with error
    checkpoint("ğŸš« STOPPING: Migration 109 is critical - cannot continue with failed migration")
    raise Exception(f"Critical migration 109 failed: {e}")
```

### 2. Fail Hard ×¢×œ ××™××•×ª ×›×™×©×œ×•×Ÿ

×× ×¢××•×“×” ×œ× × ×•×¡×¤×” (××¤×™×œ×• ×œ×œ× ×—×¨×™×’):

```python
column_exists_now = check_column_exists('call_log', 'started_at')
if column_exists_now:
    # Success path
    migrations_applied.append('109_call_log_started_at')
else:
    checkpoint("  âŒ started_at column failed to add")
    raise Exception("Failed to add started_at column to call_log")
```

×–×” ××•× ×¢ ××¦×‘ ×©×‘×• ×”×¢××•×“×” ×œ× × ×•×¡×¤×” ××‘×œ ×”××¢×¨×›×ª ×œ× ×™×•×“×¢×ª ×¢×œ ×–×”.

### 3. Fail Hard ×× ××™×’×¨×¦×™×” ×¡×•×× ×” ×›×œ× ××•×¦×œ×—×ª

×‘×¡×•×£ ×‘×œ×•×§ ×”××™×’×¨×¦×™×”:

```python
if migration_success:
    checkpoint("âœ… Migration 109 complete...")
else:
    checkpoint("âš ï¸ Migration 109 incomplete - check logs for details")
    raise Exception("Migration 109 failed but exception was not raised properly")
```

## ××™×š ×–×” ××ª×‘×˜× ×›×¢×ª

### ×ª×¨×—×™×©: Migration 109 × ×›×©×œ×ª

**×œ×¤× ×™ ×”×ª×™×§×•×Ÿ**:
```
âŒ Migration 109 failed: statement timeout
âš ï¸ Migration 109 incomplete - check logs for details
Migration 110: Adding summary_status...
âœ… Migration 110 complete
Migration 111: Adding composite index...
âœ… Migration 111 complete
âœ… Migration completed successfully!
```
â†’ Exit code: 0
â†’ Docker ××¢×œ×” ××ª ×”×©×™×¨×•×ª×™×
â†’ ×”××¤×œ×™×§×¦×™×” × ×•×¤×œ×ª ×¢×œ `UndefinedColumn`

**××—×¨×™ ×”×ª×™×§×•×Ÿ**:
```
âŒ Migration 109 failed: statement timeout
ğŸš« STOPPING: Migration 109 is critical - cannot continue with failed migration
âŒ MIGRATION FAILED: Critical migration 109 failed: statement timeout
```
â†’ Exit code: 1
â†’ Docker ×œ× ××¢×œ×” ×©×™×¨×•×ª×™× ×ª×œ×•×™×™×
â†’ ×”××¢×¨×›×ª ×œ× ×¢×•×œ×” ×¢× ×¡×›×™××” ×©×‘×•×¨×”

## ×œ××” ×–×” × ×¨××” "×¨×¥ ×¤×¢××™×™×" ×‘×œ×•×’×™×

×”×¡×™×‘×” ×œ×¨×™×¦×•×ª ×—×•×–×¨×•×ª:

1. **Container restarts**: ×× ×”-migrate container × ×›×©×œ ×•×™×© ×œ×• `restart: always`, ×”×•× ×™× ×¡×” ×©×•×‘
   - **×ª×•×§×Ÿ**: `restart: "no"` ×‘-docker-compose.yml

2. **Lock contention**: ×× ×”××™×’×¨×¦×™×” ×¨×¦×” ×ª×•×š ×›×“×™ ×©×”××¤×œ×™×§×¦×™×” ×¢×•×‘×“×ª:
   - ××™×’×¨×¦×™×” ×× ×¡×” ×œ×§×‘×œ exclusive lock ×¢×œ call_log
   - ××¤×œ×™×§×¦×™×” ×›×‘×¨ ××©×ª××©×ª ×‘×˜×‘×œ×”
   - Timeout â†’ Retry
   - **×ª×•×§×Ÿ**: ×›×œ ×”×©×™×¨×•×ª×™× ××—×›×™× ×œ-migrate ×œ×¡×™×™×

3. **Silent failures**: ××™×’×¨×¦×™×” × ×›×©×œ×ª ××‘×œ ×™×•×¦××ª ×¢× 0
   - Docker ××ª×—×™×œ ××ª ×”×©×™×¨×•×ª×™×
   - ×©×™×¨×•×ª×™× ×¨×•××™× ×¡×›×™××” ×—×¡×¨×”
   - **×ª×•×§×Ÿ**: ×¢×›×©×™×• ×™×•×¦××ª ×¢× 1

## ×‘×“×™×§×•×ª ×©×”×¨×¦× ×•

× ×•×¦×¨ ×§×•×‘×¥ `test_migration_109_fail_hard.py` ×©××××ª:

1. âœ… ××™×Ÿ ×›×¤×™×œ×•×™×•×ª ×©×œ ×”×¢××•×“×•×ª
2. âœ… ×”××™×’×¨×¦×™×” ××©×ª××©×ª ×‘-IF NOT EXISTS (idempotent)
3. âœ… ×”××™×’×¨×¦×™×” ×ª×™×›×©×œ ×¢× exception ×›××©×¨ ×™×© ×©×’×™××”
4. âœ… ×¨×§ ×©×™×¨×•×ª migrate ××¨×™×¥ ××™×’×¨×¦×™×•×ª

## ×¡×™×›×•× ×”×©×™× ×•×™×™×

### ×§×‘×¦×™× ×©×©×•× ×•:
1. `server/db_migrate.py` - ×”×•×¡×¤×ª fail-hard logic ×œ××™×’×¨×¦×™×” 109

### ×§×‘×¦×™× ×—×“×©×™×:
1. `test_migration_109_fail_hard.py` - ×‘×“×™×§×•×ª ××™××•×ª

### ×”×ª× ×”×’×•×ª ×—×“×©×”:
- âœ… Migration 109 ×ª×™×›×©×œ hard ×¢×œ ×›×œ ×©×’×™××”
- âœ… Exit code 1 ×›××©×¨ ××™×’×¨×¦×™×” × ×›×©×œ×ª
- âœ… Docker ×œ× ×™×¢×œ×” ×©×™×¨×•×ª×™× ×× ××™×’×¨×¦×™×” × ×›×©×œ×ª
- âœ… ××™×Ÿ ×™×•×ª×¨ "Migration completed successfully" ×›××©×¨ 109 × ×›×©×œ×”

## ×¤×¨×™×¡×” ×œ×¤×¨×•×“×§×©×Ÿ

×”×©×™××•×© ×–×”×” ×œ×§×•×“×, ××‘×œ ×¢×›×©×™×• ×”××¢×¨×›×ª ×‘×˜×•×—×” ×™×•×ª×¨:

```bash
# Stop services
docker compose down

# Start (migrations run first)
docker compose up -d

# Check migration status
docker compose logs migrate

# If migration failed, system will NOT start
# Fix the issue and try again
```

## ×–×™×”×•×™ ×‘×¢×™×•×ª

### ×›×™×¦×“ ×œ×–×”×•×ª ×©×”×ª×™×§×•×Ÿ ×¢×•×‘×“?

×× ××™×’×¨×¦×™×” × ×›×©×œ×ª, ×ª×¨××”:
```
âŒ Migration 109 failed: <error>
ğŸš« STOPPING: Migration 109 is critical - cannot continue
âŒ MIGRATION FAILED: Critical migration 109 failed: <error>
```

×•×œ× ×ª×¨××”:
- âœ… Migration completed successfully
- âœ… Migration 110 complete
- Container exit code = 0

### ×× ×”××™×’×¨×¦×™×” ×ª×§×•×¢×”

×× ×”××™×’×¨×¦×™×” ×ª×§×•×¢×” ×¢×œ lock timeout:
1. ×•×•×“× ×©×›×œ ×”×©×™×¨×•×ª×™× ×× ×•×ª×§×™× ××”×“××˜×”×‘×™×™×¡
2. ×”×¨×¥ migration ×‘× ×¤×¨×“:
   ```bash
   docker compose run --rm migrate
   ```

## ××” ×¢×•×“ ×‘×“×§× ×•

1. âœ… ××™×Ÿ duplicate keys ×‘××¤×ª ××™×’×¨×¦×™×•×ª
2. âœ… ××™×Ÿ ×©×ª×™ ××™×’×¨×¦×™×•×ª ×©××•×¡×™×¤×•×ª ××ª ××•×ª×Ÿ ×¢××•×“×•×ª
3. âœ… ×¨×§ migrate service ××¨×™×¥ ××™×’×¨×¦×™×•×ª (API=0, worker=0, calls=0)
4. âœ… Migration idempotent (IF NOT EXISTS) - ××¤×©×¨ ×œ×”×¨×™×¥ ×©×•×‘

## ×¡×™×›×•×

×”×‘×¢×™×” ×œ× ×”×™×™×ª×” **×›×¤×™×œ×•×™×•×ª** ××œ× **failure handling ×œ×§×•×™**:
- ×”××™×’×¨×¦×™×” **×”×™×™×ª×”** idempotent âœ…
- ×”××™×’×¨×¦×™×” **×œ× ×”×™×™×ª×”** fail-safe âŒ (×¢×›×©×™×• ×›×Ÿ âœ…)

×”×ª×™×§×•×Ÿ ××‘×˜×™×— ×©×× ××™×’×¨×¦×™×” 109 × ×›×©×œ×ª, ×”××¢×¨×›×ª ×œ× ×ª×¢×œ×” ×¢× ×¡×›×™××” ×©×‘×•×¨×”.
