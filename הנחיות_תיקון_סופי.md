# ğŸ”¥ ×”× ×—×™×•×ª ×¡×•×¤×™×•×ª - ×ª×™×§×•×Ÿ 521 ×•-NGINX

## âœ… ××” ×ª×•×§×Ÿ

### 1. ×§×•× ×¤×™×’ docker-compose.prod.yml
- âœ… NGINX ××¤× ×” ×œ-**prosaas-api:5000** (×œ× backend)
- âœ… NGINX ××¤× ×” ×œ-**prosaas-calls:5050** (×œ× backend)
- âœ… backend ×× ×•×˜×¨×œ ×‘×¤×¨×•×“ (profiles: legacy)
- âœ… ×›×œ ×”×ª×œ×•×™×•×ª ××ª×•×§× ×•×ª

### 2. ×”×©×™×¨×•×ª×™× ×”×¤×¢×™×œ×™× ×‘×¤×¨×•×“×§×©×Ÿ
```
âœ… prosaas-api:5000      - REST API
âœ… prosaas-calls:5050    - WebSocket + Twilio
âœ… prosaas-worker        - Background jobs
âœ… prosaas-redis         - Queue
âœ… prosaas-nginx         - Reverse proxy
âœ… prosaas-frontend      - Static files
âœ… prosaas-baileys       - WhatsApp
âœ… prosaas-n8n           - Automation
```

### 3. ×¡×§×¨×™×¤×˜×™× ×—×“×©×™×
- âœ… `scripts/deploy-prod.sh` - ×“×¤×œ×•×™ ×¨×’×™×œ
- âœ… `scripts/force-rebuild.sh` - ×“×¤×œ×•×™ ×›×•×— ×¢×œ×™×•×Ÿ (no cache)

---

## ğŸš€ ××™×š ×œ×¤×¨×•×¡ (3 ××¤×©×¨×•×™×•×ª)

### ××¤×©×¨×•×ª 1: ×“×¤×œ×•×™ ×¨×’×™×œ (××”×™×¨)
```bash
./scripts/deploy-prod.sh
```
**×–××Ÿ**: ~5 ×“×§×•×ª  
**××ª×™**: ×›×©×”×§×•× ×¤×™×’ ×ª×§×™×Ÿ ×•×¨×§ ×¦×¨×™×š ×œ×¢×“×›×Ÿ ×§×•×“

### ××¤×©×¨×•×ª 2: ×›×•×— ×¨×‘× ×™×ª ×¢× nginx rebuild
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache --pull nginx
docker compose -f docker-compose.yml -f docker-compose.prod.yml build --pull prosaas-api prosaas-calls worker
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate
```
**×–××Ÿ**: ~7 ×“×§×•×ª  
**××ª×™**: ×›×©-nginx ×œ× ××¢×“×›×Ÿ ××ª ×”-build args

### ××¤×©×¨×•×ª 3: ×›×•×— ×¢×œ×™×•×Ÿ ××œ× (×”×›×™ ×›×‘×“)
```bash
./scripts/force-rebuild.sh
```
**×–××Ÿ**: ~10-15 ×“×§×•×ª  
**××ª×™**: ×›×©×”×›×œ × ×“×¤×§ ×•×¨×•×¦×™× ×œ×”×ª×—×™×œ ×××¤×¡

---

## ğŸ” ××™×š ×œ×•×•×“× ×©×”×›×œ ×ª×§×™×Ÿ

### ×‘×“×™×§×” 1: ×”×©×™×¨×•×ª×™× ×¨×¦×™×
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
```

×¦×¨×™×š ×œ×¨××•×ª:
```
NAME                 STATUS
prosaas-api          Up (healthy)
prosaas-calls        Up (healthy)
prosaas-nginx        Up (healthy)
prosaas-worker       Up (healthy)
...
```

### ×‘×“×™×§×” 2: NGINX ×§×•× ×¤×™×’ × ×›×•×Ÿ
```bash
docker exec prosaas-nginx nginx -T | grep proxy_pass
```

×¦×¨×™×š ×œ×¨××•×ª:
```
proxy_pass http://prosaas-api:5000/api/;
proxy_pass http://prosaas-calls:5050;
```

âŒ **×× ×¨×•××™× backend:5000** - ×¦×¨×™×š rebuild ×¢× --no-cache!

### ×‘×“×™×§×” 3: ××™×Ÿ ×©×’×™××•×ª ×‘-logs
```bash
docker logs prosaas-nginx --tail 50
```

×¦×¨×™×š ×œ×¨××•×ª:
```
âœ… nginx started successfully
âœ… configuration ok
```

âŒ **×× ×¨×•××™× "host not found"** - ×”×§×•× ×¤×™×’ ×œ× ×”×ª×¢×“×›×Ÿ!

### ×‘×“×™×§×” 4: health endpoint
```bash
curl http://localhost/health
# ×¦×¨×™×š ×œ×”×—×–×™×¨: ok

curl http://localhost/api/health
# ×¦×¨×™×š ×œ×”×—×–×™×¨: JSON ×¢× status
```

---

## âŒ ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª × ×¤×•×¦×•×ª

### ×‘×¢×™×” 1: "host not found in upstream"

**×¡×™×‘×”**: NGINX ×¢×“×™×™×Ÿ ×¢× ×§×•× ×¤×™×’ ×™×©×Ÿ (cached build)

**×¤×ª×¨×•×Ÿ**:
```bash
# ××•×¤×¦×™×” A - rebuild ×¨×§ nginx
docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache nginx
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate nginx

# ××•×¤×¦×™×” B - force rebuild ××œ×
./scripts/force-rebuild.sh
```

### ×‘×¢×™×” 2: prosaas-api ×œ× ×¢×•×œ×”

**×‘×“×™×§×”**:
```bash
docker logs prosaas-api
```

**×¡×™×‘×•×ª ××¤×©×¨×™×•×ª**:
- âŒ .env ×—×¡×¨ ××©×ª× ×™×
- âŒ DATABASE_URL ×œ× ×ª×§×™×Ÿ
- âŒ Redis ×œ× ×–××™×Ÿ

**×¤×ª×¨×•×Ÿ**:
```bash
# ×‘×“×•×§ Redis
docker logs prosaas-redis

# ×‘×“×•×§ .env
cat .env | grep DATABASE_URL
```

### ×‘×¢×™×” 3: worker ×œ× ××¢×‘×“ jobs

**×‘×“×™×§×”**:
```bash
docker logs prosaas-worker | grep RQ_QUEUES
```

×¦×¨×™×š ×œ×¨××•×ª:
```
RQ_QUEUES=high,default,low,receipts,receipts_sync
```

**×¤×ª×¨×•×Ÿ**:
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml restart worker
```

### ×‘×¢×™×” 4: 521 ×-Cloudflare

**×¡×™×‘×•×ª ××¤×©×¨×™×•×ª**:
1. âŒ NGINX ×œ× ×××–×™×Ÿ ×¢×œ 80/443
2. âŒ SSL ×œ× ××•×’×“×¨ × ×›×•×Ÿ
3. âŒ Origin server down

**×‘×“×™×§×”**:
```bash
# ××§×•××™ - ×¦×¨×™×š ×œ×¢×‘×•×“
curl http://localhost/health

# ×× ××§×•××™ ×¢×•×‘×“ ××‘×œ cloudflare ×œ× - ×‘×¢×™×™×ª SSL
ls -la docker/nginx/ssl/
```

---

## ğŸ“‹ Checklist ×œ×¤× ×™ ×¤×¨×™×¡×”

- [ ] ×™×© ×œ×™ `.env` ×¢× ×›×œ ×”××©×ª× ×™×
- [ ] SSL certificates ×§×™×™××™× ×‘-`docker/nginx/ssl/`
- [ ] ×¢×©×™×ª×™ `git pull` ×œ×§×•×“ ×”××—×¨×•×Ÿ
- [ ] ××™×Ÿ containers ×¨×¦×™× ××§×•×“× (××• ×©×× ×™ ×¢×•×©×” down)
- [ ] ×™×© ×œ×™ ×“×™×¡×§ ××¡×¤×™×§ (docker images ×’×“×•×œ×™×)

## ğŸ“‹ Checklist ××—×¨×™ ×¤×¨×™×¡×”

- [ ] `docker compose ps` - ×›×œ ×”×©×™×¨×•×ª×™× Up + healthy
- [ ] `docker exec prosaas-nginx nginx -T | grep proxy_pass` - ×¨×•××” prosaas-api:5000
- [ ] `docker logs prosaas-nginx` - ××™×Ÿ "host not found"
- [ ] `curl http://localhost/health` - ××—×–×™×¨ ok
- [ ] `curl http://localhost/api/health` - ××—×–×™×¨ JSON
- [ ] `docker logs prosaas-api` - ××™×Ÿ errors
- [ ] `docker logs prosaas-worker` - worker listening to queues

---

## ğŸ¯ ×”×¡×™×›×•× (TL;DR)

### ×”×‘×¢×™×” ×”××§×•×¨×™×ª
NGINX ×”×™×” ××¤× ×” ×œ-backend:5000 ×©×œ× ×§×™×™× ×‘×¤×¨×•×“

### ×”×ª×™×§×•×Ÿ
NGINX ×¢×›×©×™×• ××¤× ×” ×œ-prosaas-api:5000 ×•-prosaas-calls:5050

### ×”×‘×¢×™×” ×”×©× ×™×”
Docker ×œ× rebuild ××ª nginx ××•×˜×•××˜×™×ª ×›×™ ×™×© cache

### ×”×¤×ª×¨×•×Ÿ
```bash
# ×× ×”×›×œ ×˜×•×‘ - ×“×¤×œ×•×™ ×¨×’×™×œ
./scripts/deploy-prod.sh

# ×× nginx ×œ× ××ª×¢×“×›×Ÿ - ×›×•×— ×¢×œ×™×•×Ÿ
./scripts/force-rebuild.sh
```

### ×”×•×›×—×” ×©×”×›×œ ×¢×•×‘×“
```bash
docker exec prosaas-nginx nginx -T | grep proxy_pass | grep prosaas-api
docker exec prosaas-nginx nginx -T | grep proxy_pass | grep prosaas-calls
```

×× ×©× ×™ ×”×¤×§×•×“×•×ª ××—×–×™×¨×•×ª ×ª×•×¦××•×ª - **×–×” ×¢×•×‘×“!** âœ…

---

## ğŸ†˜ ×¢×–×¨×” × ×•×¡×¤×ª

×× ××—×¨×™ ×›×œ ×–×” ×¢×“×™×™×Ÿ ×œ× ×¢×•×‘×“:

1. **×ª×¤×¢×™×œ**: `./scripts/force-rebuild.sh`
2. **×ª×‘×“×•×§**: `docker compose ps`
3. **×ª×©×œ×— ×œ×™**:
   ```bash
   docker logs prosaas-nginx --tail 100 > nginx.log
   docker exec prosaas-nginx nginx -T > nginx-config.txt
   docker compose ps > services-status.txt
   ```

×•×× ×™ ××¨××” ××” ×”×‘×¢×™×”!
