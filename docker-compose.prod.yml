# ===========================================
# ProSaaS - Production Overrides with Service Separation
# ===========================================
#
# Use with: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# This file implements production optimization:
# - Service separation: API / Calls / Worker / WhatsApp
# - Redis for queue management
# - WebSocket optimization with proper upgrades
# - Resource limits per service
# - SSL/TLS configuration for Nginx reverse proxy
# - External managed database (no local postgres)
#
# SSL Setup:
# 1. Obtain SSL certificates (from Cloudflare Origin Certificate)
# 2. Place certificates in the repository at:
#    - docker/nginx/ssl/prosaas-origin.crt
#    - docker/nginx/ssl/prosaas-origin.key
# 3. The nginx container will mount these certificates from the repo directory
#
# ===========================================
# Compose v2 (no version key)
services:
  # ===========================================
  # Nginx Reverse Proxy - Production SSL + Separate Services
  # ===========================================
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
      args:
        USE_SSL: "true"
    volumes:
      # Only mount SSL certificates (read-only)
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    # Add production service dependencies
    depends_on:
      prosaas-api:
        condition: service_healthy
      prosaas-calls:
        condition: service_healthy
      frontend:
        condition: service_healthy
      n8n:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    networks:
      - prosaas-net

  # ===========================================
  # Redis - Production Overrides
  # ===========================================
  redis:
    # Override to not expose port in production
    ports: []
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    networks:
      - prosaas-net

  # ===========================================
  # Disable local database in production
  # (Use managed DB like Railway, Supabase, Neon, etc.)
  # ===========================================
  db:
    profiles:
      - local-db-only  # Won't start unless explicitly requested

  # ===========================================
  # Worker Service - Production Overrides
  # Worker is defined in base docker-compose.yml
  # This overrides dependencies and resource limits for production
  # ===========================================
  worker:
    environment:
      FLASK_ENV: production
      RUN_MIGRATIONS_ON_START: 0
      PRODUCTION: ${PRODUCTION:-1}
      RQ_QUEUES: high,default,low,receipts,receipts_sync
      # üî• SCHEDULERS: Enable schedulers only in worker to prevent duplicate cleanup logs
      ENABLE_SCHEDULERS: "true"
      # üî• LOGGING - Production mode (minimal logs)
      LOG_LEVEL: INFO
      PYTHONUNBUFFERED: 1
    # üî• DNS FIX: Use external DNS to prevent transient failures
    dns:
      - 1.1.1.1
      - 8.8.8.8
    dns_search: ["."]
    dns_opt:
      - ndots:0
      - timeout:2
      - attempts:2
    # Add production service dependencies
    depends_on:
      redis:
        condition: service_healthy
      prosaas-api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - prosaas-net
  
  prosaas-api:
    build:
      context: .
      dockerfile: Dockerfile.backend.light
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      FLASK_ENV: production
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      RUN_MIGRATIONS_ON_START: 1
      PRODUCTION: ${PRODUCTION:-1}
      ATTACHMENT_STORAGE_DRIVER: ${ATTACHMENT_STORAGE_DRIVER:-r2}
      ATTACHMENT_SECRET: ${ATTACHMENT_SECRET}
      R2_ACCOUNT_ID: ${R2_ACCOUNT_ID}
      R2_BUCKET_NAME: ${R2_BUCKET_NAME}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
      R2_ENDPOINT: ${R2_ENDPOINT}
      REDIS_URL: redis://redis:6379/0
      SERVICE_ROLE: api
      # üî• TTS WARMUP: Optional - disable TTS warmup if needed (does not affect DB)
      # Set to "true" to skip TTS client warmup (useful for faster deployments)
      DISABLE_TTS_WARMUP: ${DISABLE_TTS_WARMUP:-false}
      # üî• SCHEDULERS: Disable schedulers in API service (only worker should run them)
      ENABLE_SCHEDULERS: "false"
      # üî• LOGGING - Production mode (minimal logs)
      LOG_LEVEL: INFO
      PYTHONUNBUFFERED: 1
    # üî• DNS FIX: Use external DNS to prevent transient failures
    dns:
      - 1.1.1.1
      - 8.8.8.8
    dns_search: ["."]
    dns_opt:
      - ndots:0
      - timeout:2
      - attempts:2
    expose:
      - "5000"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5000/health"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - prosaas-net

  # ===========================================
  # Calls Service (WebSocket + Twilio streaming only)
  # Handles: /ws/twilio-media, Twilio webhooks for calls
  # Optimized for: High concurrency, low latency, backpressure
  # 
  # ‚ö†Ô∏è CRITICAL: SINGLE WORKER ONLY
  # State (stream_registry, call sessions) is IN-MEMORY
  # Multi-worker would cause lost call context and crashes
  # See: STATE_MANAGEMENT_CONSTRAINTS.md
  # ===========================================
  prosaas-calls:
    build:
      context: .
      dockerfile: Dockerfile.backend.light
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      FLASK_ENV: production
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      RUN_MIGRATIONS_ON_START: 0
      PRODUCTION: ${PRODUCTION:-1}
      ATTACHMENT_STORAGE_DRIVER: ${ATTACHMENT_STORAGE_DRIVER:-r2}
      ATTACHMENT_SECRET: ${ATTACHMENT_SECRET}
      R2_ACCOUNT_ID: ${R2_ACCOUNT_ID}
      R2_BUCKET_NAME: ${R2_BUCKET_NAME}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
      R2_ENDPOINT: ${R2_ENDPOINT}
      REDIS_URL: redis://redis:6379/0
      SERVICE_ROLE: calls
      PORT: 5050
      # üî• TTS WARMUP: Optional - disable TTS warmup if needed (does not affect DB)
      # Set to "true" to skip TTS client warmup (useful for faster deployments)
      DISABLE_TTS_WARMUP: ${DISABLE_TTS_WARMUP:-false}
      # üî• SCHEDULERS: Disable schedulers in calls service (only worker should run them)
      ENABLE_SCHEDULERS: "false"
      # üî• LOGGING - Production mode (minimal logs)
      LOG_LEVEL: INFO
      PYTHONUNBUFFERED: 1
    # üî• DNS FIX: Use external DNS to prevent transient failures
    dns:
      - 1.1.1.1
      - 8.8.8.8
    dns_search: ["."]
    dns_opt:
      - ndots:0
      - timeout:2
      - attempts:2
    # ‚ö†Ô∏è CRITICAL: --workers MUST be 1 (not 4!)
    # Reason: stream_registry is in-memory, not Redis
    # Multi-worker = lost call state = crashes
    # To scale: Refactor stream_registry to Redis first
    # üî• PRODUCTION LOGGING: --log-level info to minimize access logs
    command: ["uvicorn", "asgi:app", "--host", "0.0.0.0", "--port", "5050", "--ws", "websockets", "--timeout-keep-alive", "75", "--timeout-graceful-shutdown", "30", "--log-level", "info"]
    expose:
      - "5050"
    volumes:
      - recordings_data:/app/server/recordings
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '3'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 1G
    networks:
      - prosaas-net

  # ===========================================
  # Baileys WhatsApp Service - Production settings
  # ===========================================
  baileys:
    environment:
      # üî• FIX #1: Override backend URL to use prosaas-api service in production
      FLASK_BASE_URL: http://prosaas-api:5000
      BACKEND_BASE_URL: http://prosaas-api:5000
      # üî• LOGGING - Production mode (minimal logs)
      LOG_LEVEL: INFO
    depends_on:
      prosaas-api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    networks:
      - prosaas-net

  # ===========================================
  # Frontend - Production settings
  # Remove backend dependency since frontend is static files
  # ===========================================
  frontend:
    depends_on: []
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    networks:
      - prosaas-net

  # ===========================================
  # n8n - Production settings
  # Add network configuration
  # ===========================================
  n8n:
    networks:
      - prosaas-net

# ===========================================
# Docker Networks (shared)
# ===========================================
networks:
  prosaas-net:
    external: true
    name: ${DOCKER_NETWORK_NAME:-prosaas-net}

# ===========================================
# Volumes (shared)
# ===========================================
volumes:
  recordings_data:
  whatsapp_auth:
  n8n_data:
