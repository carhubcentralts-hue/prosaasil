# ===========================================
# ProSaaS - Production Overrides with Service Separation
# ===========================================
#
# Use with: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# This file implements production optimization:
# - Service separation: API / Calls / Worker / WhatsApp
# - Redis for queue management
# - WebSocket optimization with proper upgrades
# - Resource limits per service
# - SSL/TLS configuration for Nginx reverse proxy
# - External managed database (no local postgres)
#
# SSL Setup:
# 1. Obtain SSL certificates (from Cloudflare Origin Certificate)
# 2. Place certificates in the repository at:
#    - docker/nginx/ssl/prosaas-origin.crt
#    - docker/nginx/ssl/prosaas-origin.key
# 3. The nginx container will mount these certificates from the repo directory
#
# ===========================================

version: '3.8'

services:
  # ===========================================
  # Nginx Reverse Proxy - Production SSL + Separate Services
  # Note: Config templating happens at BUILD time, not runtime
  # ===========================================
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
      args:
        # Use actual service names: backend (not prosaas-api/prosaas-calls)
        # Both API and calls go to backend:5000 (single monolith in current deployment)
        API_UPSTREAM: backend:5000
        CALLS_UPSTREAM: backend:5000
        FRONTEND_UPSTREAM: frontend
        USE_SSL: "true"
    volumes:
      # Only mount SSL certificates (read-only)
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    # Add production service dependencies - use actual service names
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
      n8n:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ===========================================
  # Redis - Queue Management for Background Jobs
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: prosaas-redis
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    networks:
      - prosaas-network

  # ===========================================
  # Disable local database in production
  # (Use managed DB like Railway, Supabase, Neon, etc.)
  # ===========================================
  db:
    profiles:
      - local-db-only  # Won't start unless explicitly requested

  # ===========================================
  # Backend API Service - Production Overrides
  # Use the single backend service (monolith), not split services
  # ===========================================
  backend:
    environment:
      FLASK_ENV: production
      PRODUCTION: ${PRODUCTION:-1}
      RUN_MIGRATIONS_ON_START: 1
      LOG_LEVEL: INFO
      PYTHONUNBUFFERED: 1
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ===========================================
  # Worker Service - Production Overrides
  # Worker is defined in base docker-compose.yml
  # This overrides dependencies and resource limits for production
  # ===========================================
  worker:
    environment:
      FLASK_ENV: production
      RUN_MIGRATIONS_ON_START: 0
      PRODUCTION: ${PRODUCTION:-1}
      RQ_QUEUES: high,default,low,receipts,receipts_sync
      # ðŸ”¥ LOGGING - Production mode (minimal logs)
      LOG_LEVEL: INFO
      PYTHONUNBUFFERED: 1
    # ðŸ”¥ DNS FIX: Use external DNS to prevent transient failures
    dns:
      - 1.1.1.1
      - 8.8.8.8
    dns_search: ["."]
    dns_opt:
      - ndots:0
      - timeout:2
      - attempts:2
    # Add production service dependencies - use actual service: backend
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
  
  # ===========================================
  # NOTE: prosaas-api and prosaas-calls services REMOVED
  # Current deployment uses single backend service (monolith)
  # To enable split architecture in future, uncomment and update nginx dependencies
  # ===========================================

  # ===========================================
  # Baileys WhatsApp Service - Production settings
  # ===========================================
  baileys:
    depends_on:
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # ===========================================
  # Frontend - Production settings
  # Remove backend dependency since frontend is static files
  # ===========================================
  frontend:
    depends_on: []
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

# ===========================================
# Docker Networks (shared)
# ===========================================
networks:
  prosaas-network:
    driver: bridge

# ===========================================
# Volumes (shared)
# ===========================================
volumes:
  recordings_data:
  whatsapp_auth:
  n8n_data:
