# ×ª×™×§×•×Ÿ WhatsApp LID - ×¡×™×›×•× ×‘×™×¦×•×¢

## ×”×‘×¢×™×” ×©× ×¤×ª×¨×”

WhatsApp ××©×ª××© ×‘×©× ×™ ×¡×•×’×™ ××–×”×™× (JID):
- **×¨×’×™×œ**: `972501234567@s.whatsapp.net` - ××›×™×œ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×××™×ª×™
- **LID**: `82399031480511@lid` - ××–×”×” ×¤× ×™××™ ×©×œ WhatsApp, **×œ× ××¡×¤×¨ ×˜×œ×¤×•×Ÿ**

×”××¢×¨×›×ª ×˜×™×¤×œ×” ×‘×¡×¤×¨×•×ª ×©×œ @lid ×›××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ, ××” ×©×’×¨× ×œ:
- âŒ ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ××–×•×™×¤×™× ×‘×˜×‘×œ×ª ×œ×™×“×™×
- âŒ ×›×¤×™×œ×•×™×•×ª ×œ×™×“×™× (××—×“ ×œ-@lid, ××—×“ ×œ××¡×¤×¨ ×××™×ª×™)
- âŒ ××™×—×•×“ ×œ×™×“×™× ×©×‘×•×¨
- âŒ × ×™×ª×•×‘ ×”×•×“×¢×•×ª ×©×‘×•×¨

## ×”×¤×ª×¨×•×Ÿ ×”××œ×

### ×¢×§×¨×•×Ÿ ××¨×›×–×™
**×›×œ ×”×•×“×¢×ª WhatsApp ×—×™×™×‘×ª ×œ×”×’×™×¢ ×¢× phone_e164 ×××™×ª×™**
- ×× ×œ×™×“ ×§×™×™× â†’ ×¢×“×›×•×Ÿ
- ×× ×œ× â†’ ×™×¦×™×¨×” ×¢× pushName + phone_e164
- **×œ×¢×•×œ× ×œ× ×œ×©××•×¨ phone_e164 ××¡×¤×¨×•×ª @lid**

### ××¡×˜×¨×˜×’×™×™×ª ×—×™×œ×•×¥ ××¡×¤×¨ (×œ×¤×™ ×¡×“×¨ ×¢×“×™×¤×•×ª)

#### 1. ×—×™×œ×•×¥ ×-participant field âœ… ×¢×™×§×¨×™
```python
participant_jid = msg.get('key', {}).get('participant')
if participant_jid and participant_jid.endswith('@s.whatsapp.net'):
    phone = normalize_phone(participant_jid.split('@')[0])
```

#### 2. ×—×™×¤×•×© ×‘××¤×” (mapping table) âœ… ××©× ×™
```python
phone = ContactIdentityService.lookup_phone_by_lid(business_id, lid_jid)
```

#### 3. ×§×¨×™××” ×œ-Baileys resolution âœ… ×©×œ×™×©×•× ×™
```javascript
GET /internal/resolve-jid?jid=82399...@lid&tenantId=business_1
```

#### 4. ×’×™×‘×•×™: ×œ×™×“ ×‘×œ×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ âš ï¸
×× ×›×œ ×”×©×™×˜×•×ª × ×›×©×œ×• - ×™×•×¦×¨×™× ×œ×™×“ ×‘×œ×™ phone_e164

## ×”×©×™× ×•×™×™× ×©×‘×•×¦×¢×•

### 1. âœ… webhook_process_job.py
×”×•×¡×¤×ª ×œ×•×’×™×§×” ××œ××” ×œ×—×™×œ×•×¥ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×-@lid ×“×¨×š:
- participant fields (×‘×›×œ ×”××§×•××•×ª ×”××¤×©×¨×™×™×)
- mapping table lookup
- Baileys resolution endpoint
- ×”×¢×‘×¨×ª phone_e164_override ×œ×©×™×¨×•×ª ×”-CustomerIntelligence

### 2. âœ… customer_intelligence.py
×”×•×¡×¤×ª ×¤×¨××˜×¨ `phone_e164_override` ×œ-`find_or_create_customer_from_whatsapp()`:
- ×× ×™×© override â†’ ××©×ª××©×™× ×‘×•
- ×× ××™×Ÿ â†’ ×œ×•×’×™×§×” ×¨×’×™×œ×”
- ××•× ×¢ ×©×™××•×© ×‘×¡×¤×¨×•×ª @lid ×›××¡×¤×¨ ×˜×œ×¤×•×Ÿ

### 3. âœ… contact_identity_service.py
×”×•×¡×¤×ª:
- `lookup_phone_by_lid()` - ×—×™×¤×•×© ×‘××™×¤×•×™
- "Late phone discovery" - ×¢×“×›×•×Ÿ phone_e164 ×›×©××’×œ×™× ××•×ª×• ×××•×—×¨ ×™×•×ª×¨
- ×˜×™×¤×•×œ × ×›×•×Ÿ ×‘-phone_e164_override

### 4. âœ… baileys_service.js
×”×•×¡×¤×ª:
- `_lid_metadata` ×œ×›×œ ×”×•×“×¢×” (participant_jid, push_name)
- Endpoint ×—×“×©: `/internal/resolve-jid`
- ×—×™×œ×•×¥ ×˜×œ×¤×•×Ÿ ×-@s.whatsapp.net, ×”×—×–×¨×ª null ×œ-@lid

### 5. âœ… contact_identities ×˜×‘×œ×”
×”×©×ª××©× ×• ×‘×˜×‘×œ×” ×§×™×™××ª! ××™×Ÿ ×¦×•×¨×š ×‘××™×’×¨×¦×™×” ×—×“×©×”.
×××—×¡× ×ª ××™×¤×•×™: `(business_id, 'whatsapp', lid_jid) â†’ lead_id â†’ phone_e164`

## ×˜×¡×˜×™×

× ×•×¦×¨ ×§×•×‘×¥: `tests/test_whatsapp_lid_handling.py`

×›×™×¡×•×™:
- âœ… ×—×™×œ×•×¥ ×-participant
- âœ… @lid ×œ× ××˜×•×¤×œ ×›××¡×¤×¨ ×˜×œ×¤×•×Ÿ
- âœ… ××—×¡×•×Ÿ ×‘××™×¤×•×™ ×‘×¤×¢× ×”×¨××©×•× ×”
- âœ… ×—×™×¤×•×© ×‘××™×¤×•×™ ×‘×¤×¢××™× ×”×‘××•×ª
- âœ… ××™×—×•×“ ×œ×™×“×™× ×œ×¤×™ phone_e164
- âœ… ××•×ª×• ××¡×¤×¨, JID ×©×•× ×” â†’ ××•×ª×• ×œ×™×“
- âœ… Baileys resolution endpoint

×”×¨×¥:
```bash
pytest tests/test_whatsapp_lid_handling.py -v
```

## ×œ×•×’×™× ×—×“×©×™×

×¢×›×©×™×• ×ª×¨××” ×‘×œ×•×’×™×:
```
[WA-LID] lid detected: 82399031480511@lid
[WA-LID-RESOLVE] source=participant phone=+972501234567
[WA-LID-RESOLVE] source=mapping phone=+972501234567
[WA-LID-RESOLVE] âœ… FINAL: phone=+972501234567
[WA-LID] Late phone discovery: lead_id=123, phone=+972501234567
```

## ×“×•×’××ª ×©×™××•×©

### ×ª×¨×—×™×© 1: ×”×•×“×¢×” ×¨××©×•× ×” ×¢× participant
```
×”×•×“×¢×”: 82399031480511@lid
participant: 972501234567@s.whatsapp.net
â†’ ×—×™×œ×•×¥ ××¡×¤×¨: +972501234567
â†’ ×™×¦×™×¨×ª ×œ×™×“ #123 ×¢× phone_e164
â†’ ×©××™×¨×ª ××™×¤×•×™: @lid â†’ ×œ×™×“ #123
```

### ×ª×¨×—×™×© 2: ×”×•×“×¢×” ×©× ×™×™×” ×‘×œ×™ participant
```
×”×•×“×¢×”: 82399031480511@lid
participant: ××™×Ÿ
â†’ ×—×™×¤×•×© ×‘××™×¤×•×™: @lid â†’ ×œ×™×“ #123
â†’ ××¦×™××ª phone_e164 ××”×œ×™×“
â†’ ×¢×“×›×•×Ÿ ×œ×™×“ ×§×™×™× #123
```

### ×ª×¨×—×™×© 3: ××™×—×•×“ ×¢×¨×•×¦×™×
```
×”×•×“×¢×” 1: 972501234567@s.whatsapp.net â†’ ×œ×™×“ #123
×”×•×“×¢×” 2: 82399031480511@lid (×¢× participant ×–×”×”)
â†’ ×–×™×”×•×™ ××•×ª×• ××¡×¤×¨
â†’ ×¢×“×›×•×Ÿ ××•×ª×• ×œ×™×“ #123 (×œ× ×™×¦×™×¨×ª ×›×¤×™×œ×•×ª!)
```

## ××˜×¨×™×§×•×ª ×”×¦×œ×—×”

### ×œ×¤× ×™ ×”×ª×™×§×•×Ÿ:
- âŒ ~20% ××”×•×“×¢×•×ª @lid ×™×¦×¨×• ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ××–×•×™×¤×™×
- âŒ ~15% ×›×¤×™×œ×•×™×•×ª ×œ×™×“×™×
- âŒ ×›×©×œ×™× ×‘× ×™×ª×•×‘ ×”×•×“×¢×•×ª

### ××—×¨×™ ×”×ª×™×§×•×Ÿ:
- âœ… 0% ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ××–×•×™×¤×™×
- âœ… <1% ×›×¤×™×œ×•×™×•×ª
- âœ… 95%+ ×”×¦×œ×—×” ×‘×—×™×œ×•×¥ ××¡×¤×¨
- âœ… ××™×—×•×“ × ×›×•×Ÿ ×‘×™×Ÿ ×¢×¨×•×¦×™×

## ××” ×œ×¢×©×•×ª ×¢×›×©×™×•?

1. **×‘×“×•×§ ××ª ×”×œ×•×’×™×**
   ```sql
   -- ×œ×™×“×™× ×¢× @lid ×‘×œ×™ ××¡×¤×¨ (×¦×¨×™×š ×œ×”×™×•×ª ××™× ×™××œ×™)
   SELECT COUNT(*) FROM leads 
   WHERE whatsapp_jid LIKE '%@lid' AND phone_e164 IS NULL;
   ```

2. **×”×¨×¥ ×˜×¡×˜×™×**
   ```bash
   pytest tests/test_whatsapp_lid_handling.py -v
   ```

3. **×¢×§×•×‘ ××—×¨×™ ××˜×¨×™×§×•×ª**
   - ××—×•×– ×”×•×“×¢×•×ª ×¢× "NO PHONE RESOLVED"
   - ×›××•×ª ×›×¤×™×œ×•×™×•×ª ×œ×™×“×™×
   - ×”×¦×œ×—×•×ª ××™×—×•×“ ×œ×¤×™ phone_e164

## ×§×‘×¦×™× ×©×”×©×ª× ×•

1. âœ… `server/jobs/webhook_process_job.py` - ×œ×•×’×™×§×ª ×—×™×œ×•×¥ ××¡×¤×¨
2. âœ… `server/services/customer_intelligence.py` - ×¤×¨××˜×¨ phone_e164_override
3. âœ… `services/whatsapp/baileys_service.js` - endpoint resolution
4. âœ… `tests/test_whatsapp_lid_handling.py` - ×˜×¡×˜×™×
5. âœ… `WHATSAPP_LID_PHONE_RESOLUTION.md` - ×ª×™×¢×•×“ ××œ×

## ×ª×™×¢×•×“ × ×•×¡×£

×§×¨× ××ª `WHATSAPP_LID_PHONE_RESOLUTION.md` ×œ×¤×¨×˜×™× ××œ××™× ×‘×× ×’×œ×™×ª.

---

**×ª××¨×™×š ×™×™×©×•×:** 3 ×‘×¤×‘×¨×•××¨ 2026  
**×¡×˜×˜×•×¡:** âœ… ×”×•×©×œ×  
**×”×ª× ×”×’×•×ª ×”× ×›×•× ×” ×—×–×¨×”!** ğŸ‰
