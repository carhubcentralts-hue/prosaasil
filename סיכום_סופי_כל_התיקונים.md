# ×¡×™×›×•× ×¡×•×¤×™ - ×›×œ ×”×ª×™×§×•× ×™× ×‘××§×•× ××—×“

## ğŸ¯ 3 ×‘×¢×™×•×ª ×§×¨×™×˜×™×•×ª ×ª×•×§× ×•

### 1. âœ… Migration Lock Timeout - ×ª×•×§×Ÿ
**×”×‘×¢×™×”:** `pg_advisory_lock` ×—×•×¡× ×œ× ×¦×— ×•× ×›×©×œ ×¢× `statement_timeout`

**×”×¤×ª×¨×•×Ÿ:**
- ×”×—×œ×¤×” ×œ-`pg_try_advisory_lock` ×¢× retry loop
- `statement_timeout=120s` ×œ×—×™×‘×•×¨ ××™×’×¨×¦×™×”
- Graceful skip ×‘××§×•× crash
- `RUN_MIGRATIONS=1` ×¨×§ ×‘-prosaas-api

---

### 2. âœ… Recording Worker Loop - ×ª×•×§×Ÿ
**×”×‘×¢×™×”:** ×”×§×œ×˜×•×ª × ×›× ×¡×•×ª ×œ×ª×•×¨ ××‘×œ ×œ× × ×¦×¨×›×•×ª (Worker ×œ× ×¨×¥)

**×”×¤×ª×¨×•×Ÿ:**
- Recording worker thread ××ª×—×™×œ ×¢×›×©×™×• ×‘-`server/worker.py`
- Worker ×¨×¥ ×ª××™×“, ×‘×œ×™ ×ª×œ×•×ª ×‘-ENABLE_SCHEDULERS
- ×œ×•×’×™× ×—×“×©×™×: `WORKER_PICKED`, `WORKER_DOWNLOAD_DONE`, ×•×›×•'

---

### 3. âœ… Background Jobs Constraint - ×ª×•×§×Ÿ (×—×“×©!)
**×”×‘×¢×™×”:** 
```
IntegrityError: background_jobs violates check constraint "chk_job_type"
```

**×”×¡×™×‘×”:** ×”×§×•×“ ××©×ª××© ×‘-`job_type='delete_leads'` ××‘×œ ×”-DB ×××¤×©×¨ ×¨×§ `'delete_receipts_all'`

**×”×¤×ª×¨×•×Ÿ:**
- **Migration 104** ××¢×“×›×Ÿ ××ª ×”-constraint
- ×××¤×©×¨ ××ª ×›×œ 6 ×¡×•×’×™ ×”-jobs:
  1. `delete_receipts_all`
  2. `delete_leads` (×—×“×©)
  3. `update_leads` (×—×“×©)
  4. `delete_imported_leads` (×—×“×©)
  5. `enqueue_outbound_calls` (×—×“×©)
  6. `broadcast` (×—×“×©)

---

## ğŸ“ ××” ×©×•× ×” ×‘×§×•×“

### server/db_migrate.py
```python
# Migration 104: ×¢×“×›×•×Ÿ constraint
ALTER TABLE background_jobs DROP CONSTRAINT IF EXISTS chk_job_type;
ALTER TABLE background_jobs ADD CONSTRAINT chk_job_type
CHECK (job_type IN (
    'delete_receipts_all',
    'delete_leads',
    'update_leads',
    'delete_imported_leads',
    'enqueue_outbound_calls',
    'broadcast'
));
```

### server/worker.py
```python
# ×”×ª×—×œ×ª recording worker thread
from server.tasks_recording import start_recording_worker
recording_thread = threading.Thread(
    target=start_recording_worker,
    args=(app,),
    daemon=True,
    name="RecordingWorker"
)
recording_thread.start()
```

### server/routes_leads.py
```python
# Error handling ×œ×× ×™×¢×ª crash
try:
    db.session.commit()
except Exception as e:
    if 'chk_job_type' in str(e):
        return jsonify({
            "error": "Database migration required",
            "details": "Contact administrator"
        }), 503
    raise
```

---

## ğŸš€ ××™×š ×œ×¤×¨×•×¡

### ×©×œ×‘ 1: ×¢×¦×•×¨ ×©×™×¨×•×ª×™×
```bash
docker-compose down
```

### ×©×œ×‘ 2: ×¢×œ×” ××—×“×©
```bash
docker-compose up -d
```

### ×©×œ×‘ 3: ×‘×“×•×§ ×œ×•×’×™×

#### ××™×’×¨×¦×™×•×ª (prosaas-api)
```bash
docker-compose logs prosaas-api | grep "Migration 104"
```
**×¦×¤×•×™ ×œ×¨××•×ª:**
```
âœ… Migration 104 complete: job_type constraint updated
```

#### Recording Worker
```bash
docker-compose logs worker | grep "RECORDING WORKER"
```
**×¦×¤×•×™ ×œ×¨××•×ª:**
```
âœ… RECORDING WORKER STARTED
   This worker processes recording downloads and transcription
```

#### ×¢×™×‘×•×“ ×”×§×œ×˜×•×ª
```bash
docker-compose logs -f worker | grep "WORKER_"
```
**×¦×¤×•×™ ×œ×¨××•×ª (××—×¨×™ ×©×™×—×”):**
```
ğŸ¯ [WORKER_PICKED] job_type=download_only call_sid=CA...
âœ… [WORKER_DOWNLOAD_DONE] call_sid=CA... bytes=123456
ğŸ”“ [WORKER_RELEASE_SLOT] call_sid=CA... reason=success
```

---

## âœ… 30 ×©×•×¨×•×ª ×œ×•×’ ×œ×“×•×’××” (××—×¨×™ ×¤×¨×™×¡×” ××•×¦×œ×—×ª)

```
[2026-01-26 11:00:01] INFO [server.app_factory] ğŸ”§ MIGRATION CHECKPOINT: Starting apply_migrations()
[2026-01-26 11:00:01] INFO [server.db_migrate] âœ… Set statement_timeout to 120s for migration connection
[2026-01-26 11:00:01] INFO [server.db_migrate] âœ… Acquired migration lock
[2026-01-26 11:00:02] INFO [server.db_migrate] Migration 104: Updating background_jobs job_type constraint
[2026-01-26 11:00:02] INFO [server.db_migrate]   â†’ Dropping old chk_job_type constraint...
[2026-01-26 11:00:02] INFO [server.db_migrate]   â†’ Creating updated chk_job_type constraint with all job types...
[2026-01-26 11:00:02] INFO [server.db_migrate] âœ… Migration 104 complete: job_type constraint updated
[2026-01-26 11:00:02] INFO [server.db_migrate]    âœ… Allowed job types: delete_receipts_all, delete_leads, update_leads, delete_imported_leads, enqueue_outbound_calls, broadcast
[2026-01-26 11:00:03] INFO [server.db_migrate] âœ… Released migration lock
[2026-01-26 11:00:03] INFO [server.app_factory] âœ… MIGRATIONS COMPLETE

[2026-01-26 11:00:05] INFO [server.worker] âœ“ Flask app initialized
[2026-01-26 11:00:05] INFO [server.worker] âœ“ Redis connection established
[2026-01-26 11:00:05] INFO [server.worker] ğŸ”¨ WORKER QUEUES CONFIGURATION
[2026-01-26 11:00:05] INFO [server.worker] âœ… Heartbeat monitoring started (every 30s)
[2026-01-26 11:00:05] INFO [server.worker] âœ… RECORDING WORKER STARTED
[2026-01-26 11:00:05] INFO [server.worker]    This worker processes recording downloads and transcription
[2026-01-26 11:00:05] INFO [server.worker]    Watch for logs: WORKER_PICKED, WORKER_DOWNLOAD_DONE
[2026-01-26 11:00:06] INFO [server.tasks_recording] âœ… [WORKER] Recording worker loop started
[2026-01-26 11:00:06] INFO [server.tasks_recording] ğŸ”§ [WORKER] All downloads happen here, not in API!

# ... ×©×™×—×” ×¢× ×”×§×œ×˜×” ...

[2026-01-26 11:05:20] INFO [server.tasks_recording] ğŸ¯ [WORKER_PICKED] job_type=download_only call_sid=CA123... business_id=42 recording_sid=RE987... retry=0
[2026-01-26 11:05:20] INFO [server.tasks_recording] âœ… [WORKER_SLOT_ACQUIRED] call_sid=CA123... business_id=42
[2026-01-26 11:05:20] INFO [server.tasks_recording] ğŸ¬ [DOWNLOAD_START] call_sid=CA123... recording_sid=RE987... attempt=1
[2026-01-26 11:05:23] INFO [server.tasks_recording] âœ… [WORKER_DOWNLOAD_DONE] call_sid=CA123... file=CA123.mp3 bytes=245678 duration_ms=3245
[2026-01-26 11:05:23] INFO [server.tasks_recording] ğŸ”“ [WORKER_RELEASE_SLOT] call_sid=CA123... business_id=42 reason=success
[2026-01-26 11:05:23] INFO [server.tasks_recording] ğŸ”“ [RECORDING_SLOT_RELEASED] call_sid=CA123... business_id=42 reason=success active_after=0/3

# ××—×™×§×ª ×œ×™×“×™× ×‘×‘××œ×§ (×¢×›×©×™×• ×¢×•×‘×“!)

[2026-01-26 11:10:15] INFO [server.routes_leads] ğŸ—‘ï¸ Creating bulk delete job: 50 leads (tenant=42)
[2026-01-26 11:10:15] INFO [server.routes_leads] ğŸš€ Enqueued RQ job for bulk delete, job_id=123
[2026-01-26 11:10:16] INFO [server.jobs.delete_leads_job] ğŸ”¨ JOB PICKED queue='maintenance' job_id=delete_leads_123
[2026-01-26 11:10:20] INFO [server.jobs.delete_leads_job] âœ… Deleted 50 leads successfully
```

---

## ğŸ¯ ××¡×§× ×”: "×¡×’×•×¨, ×–×” ×¢×•×‘×“"

×× ××—×¨×™ ×”×¤×¨×™×¡×” ×ª×¨××”:

1. âœ… `Migration 104 complete` - Migration ×¨×¦×”
2. âœ… `RECORDING WORKER STARTED` - Worker ××ª×—×™×œ
3. âœ… `WORKER_PICKED` + `WORKER_DOWNLOAD_DONE` - Worker ××¢×‘×“
4. âœ… ××—×™×§×ª/×¢×“×›×•×Ÿ ×œ×™×“×™× ×¢×•×‘×“ ×œ×œ× ×©×’×™××•×ª

**××– ×›×œ 3 ×”×‘×¢×™×•×ª ×ª×•×§× ×•!** ğŸ‰

---

## ğŸ” ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª

### ×‘×¢×™×”: Migration 104 ×œ× ×¨×¥
```bash
# ×‘×“×•×§ ×× prosaas-api ×¢×œ×”
docker-compose ps prosaas-api

# ×‘×“×•×§ ×œ×•×’×™×
docker-compose logs prosaas-api | grep Migration
```

**×¤×ª×¨×•×Ÿ:** ×•×“× ×©-`RUN_MIGRATIONS=1` ×‘-prosaas-api

---

### ×‘×¢×™×”: Recording worker ×œ× ×¨×¥
```bash
# ×‘×“×•×§ ×× worker ×¢×œ×”
docker-compose ps worker

# ×‘×“×•×§ ×× thread ×”×ª×—×™×œ
docker-compose logs worker | grep "RECORDING WORKER"
```

**×¤×ª×¨×•×Ÿ:** ×•×“× ×©-worker command ×”×•× `python -m server.worker`

---

### ×‘×¢×™×”: ×¢×“×™×™×Ÿ ×©×’×™××ª constraint
```bash
# ×‘×“×•×§ ×× constraint ×¢×•×“×›×Ÿ ×‘DB
docker-compose exec prosaas-api python -c "
from server.app_factory import create_app
from server.db import db
app = create_app()
with app.app_context():
    result = db.session.execute('SELECT conname, pg_get_constraintdef(oid) FROM pg_constraint WHERE conname = \'chk_job_type\'')
    print(result.fetchone())
"
```

**×¤×ª×¨×•×Ÿ:** ×× constraint ×œ× ×¢×•×“×›×Ÿ, ×”×¨×¥ ××™×’×¨×¦×™×•×ª ×™×“× ×™×ª ××• restart prosaas-api

---

## ğŸ‰ ×”×›×œ ××•×›×Ÿ!

×›×œ 3 ×”×‘×¢×™×•×ª ×ª×•×§× ×•:
- âœ… Migration lock timeout
- âœ… Recording worker loop
- âœ… Background jobs constraint

**×”××¢×¨×›×ª ××•×›× ×” ×œ×¢×‘×•×“×”!** ğŸš€
