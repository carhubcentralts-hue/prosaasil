# תיקון אימות WhatsApp באנדרואיד

## הבעיה
חיבור WhatsApp עובד בהתחלה, אפילו שולח הודעות, אבל אחרי ~דקה-דקה וחצי נבעט עם `logged_out` רק באנדרואיד.
(iPhone עובד בסדר עם אותו קוד)

## הסיבה
אנדרואיד בודק יותר קפדני מ-iPhone:
1. זיהוי דפדפן (browser tuple)
2. סשנים כפולים בזמן סריקת QR
3. קבצי אימות פגומים מכתיבה מקבילה
4. סטטוס "connected" מוקדם מדי

## התיקונים שבוצעו

### 1️⃣ הסרת browser override ✅
- הסרנו: `browser: ['Ubuntu', 'Chrome', '22.04.4']`
- עכשיו Baileys בוחר אוטומטית (תואם לגרסה)

### 2️⃣ ניקוי auth רק על logged_out אמיתי ✅
- מוחקים auth רק על `DisconnectReason.loggedOut` (401)
- שומרים auth על 428/440/515 (ניתוקים זמניים)

### 3️⃣ ביטול auto-restart אחרי logged_out ✅
- אין restart אוטומטי אחרי logged_out
- משתמש חייב ללחוץ "התחל" מחדש

### 4️⃣ /start אידמפוטנטי ✅
- נוסף `startingLocks` למניעת סשנים כפולים
- מחזיר שגיאה אם start כבר רץ

### 5️⃣ mutex לשמירת auth ✅
- נוסף `credsLock` למניעת כתיבה מקבילה
- מונע קבצים פגומים

### 6️⃣ תיקון connected מוקדם מדי ✅
- דורש הכל: connection=open + sock.user.id + state.creds.me.id
- לא מדווח connected עד שהכל מוכן

### 7️⃣ תיקון NameError ✅
- כבר מתוקן: `from_identifier` מוגדר לפני שימוש

## בדיקות נדרשות

### אנדרואיד
- [ ] סרוק QR, שלח הודעה מיד
- [ ] חכה 2 דקות, שלח הודעה נוספת
- [ ] וודא שלא נבעט

### iPhone
- [ ] וודא שעדיין עובד

### מקרי קצה
- [ ] רענון דף בזמן סריקת QR (לא אמור לשכפל)
- [ ] לחיצות מהירות על "התחל" (אמור להחזיר שגיאה)
- [ ] ניתוק זמני (אמור להתחבר מחדש בלי QR)

## שינויים נראים למשתמש

1. **אחרי logged_out**: חייב ללחוץ "התחל" ידנית (לא אוטומטי)
2. **בזמן סריקת QR**: לחיצות כפולות יחזירו שגיאה
3. **ניתוקים זמניים**: יתחבר מחדש אוטומטית בלי QR

## הצלחה
✅ אנדרואיד נשאר מחובר מעבר לדקה וחצי
✅ iPhone ממשיך לעבוד
✅ פחות סשנים כפולים
✅ auth נמחק רק על logout אמיתי

---
**תאריך:** 2026-01-10
**סטטוס:** מוכן לבדיקה
