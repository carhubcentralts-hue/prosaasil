<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ×ª×™×§×•×Ÿ ××¦×‘</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .card { 
            background: white; 
            margin: 10px 0; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button { 
            background: #7c3aed; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 16px;
        }
        .reset { background: #ef4444; }
        .admin { background: #3b82f6; }
        .business { background: #10b981; }
        .log { background: #f3f4f6; padding: 15px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        .status { padding: 15px; border-radius: 4px; margin: 10px 0; font-weight: bold; }
        .good { background: #d1fae5; color: #065f46; }
        .bad { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ×ª×™×§×•×Ÿ ××¦×‘ ×”××¢×¨×›×ª</h1>
    <p>×›×œ×™ ×œ×ª×™×§×•×Ÿ ××”×™×¨ ×©×œ ×‘×¢×™×•×ª ×”×©×ª×œ×˜×•×ª</p>

    <div class="card">
        <h2>××¦×‘ × ×•×›×—×™</h2>
        <div id="current-status" class="log">×‘×•×“×§...</div>
        <button onclick="checkCurrentStatus()">×‘×“×•×§ ××¦×‘</button>
    </div>

    <div class="card">
        <h2>×¤×¢×•×œ×•×ª ×ª×™×§×•×Ÿ</h2>
        <button onclick="forceResetToAdmin()" class="reset">××™×¤×•×¡ ×›×•×œ×œ ×œ×× ×”×œ</button>
        <button onclick="forceGoToAdmin()" class="admin">×¢×‘×•×¨ ×œ×× ×”×œ</button>
        <button onclick="forceGoToBusiness()" class="business">×¢×‘×•×¨ ×œ×¢×¡×§</button>
        <div id="action-result" class="log">×œ× ×‘×•×¦×¢</div>
    </div>

    <div class="card">
        <h2>×‘×“×™×§×ª ×”×©×ª×œ×˜×•×ª</h2>
        <button onclick="testTakeoverFlow()" class="business">×‘×“×•×§ ×–×¨×™××ª ×”×©×ª×œ×˜×•×ª</button>
        <div id="takeover-result" class="log">×œ× ×‘×“×•×§</div>
    </div>

    <script>
        function checkCurrentStatus() {
            const currentUrl = window.location.pathname;
            const localStorage_data = {
                token: localStorage.getItem('auth_token') ? '×™×©' : '××™×Ÿ',
                role: localStorage.getItem('user_role') || '×œ× ××•×’×“×¨',
                business_id: localStorage.getItem('business_id') || '×œ× ××•×’×“×¨',
                admin_takeover: localStorage.getItem('admin_takeover_mode') || '×œ× ×¤×¢×™×œ',
                user_name: localStorage.getItem('user_name') || '×œ× ××•×’×“×¨',
                original_token: localStorage.getItem('original_admin_token') ? '×™×©' : '××™×Ÿ'
            };
            
            let statusClass = 'good';
            let statusText = 'âœ… ××¦×‘ ×ª×§×™×Ÿ';
            
            // ×–×™×”×•×™ ×‘×¢×™×•×ª
            if (localStorage_data.role === 'business' && currentUrl.includes('/admin/')) {
                statusClass = 'bad';
                statusText = 'âŒ ×‘×¢×™×”: role=business ××‘×œ ×‘×¢××•×“ admin';
            } else if (localStorage_data.role === 'admin' && currentUrl.includes('/business/')) {
                statusClass = 'bad';
                statusText = 'âŒ ×‘×¢×™×”: role=admin ××‘×œ ×‘×¢××•×“ business'; 
            } else if (localStorage_data.admin_takeover === 'true' && !currentUrl.includes('/business/')) {
                statusClass = 'bad';
                statusText = 'âŒ ×‘×¢×™×”: ×”×©×ª×œ×˜×•×ª ×¤×¢×™×œ×” ××‘×œ ×œ× ×‘×¢××•×“ business';
            }
            
            document.getElementById('current-status').innerHTML = 
                `<div class="status ${statusClass}">${statusText}</div>` +
                `URL × ×•×›×—×™: ${currentUrl}<br>` +
                `×˜×•×›×Ÿ: ${localStorage_data.token}<br>` +
                `×ª×¤×§×™×“: ${localStorage_data.role}<br>` +
                `×¢×¡×§: ${localStorage_data.business_id}<br>` +
                `×”×©×ª×œ×˜×•×ª: ${localStorage_data.admin_takeover}<br>` +
                `×©×: ${localStorage_data.user_name}<br>` +
                `×˜×•×›×Ÿ ××§×•×¨×™: ${localStorage_data.original_token}`;
        }

        function forceResetToAdmin() {
            console.log('ğŸ”„ Force reset to admin');
            
            // × ×™×§×•×™ ×›×•×œ×œ
            localStorage.removeItem('admin_takeover_mode');
            localStorage.removeItem('business_id');
            localStorage.removeItem('original_admin_token');
            
            // ×”×’×“×¨×ª ×× ×”×œ
            localStorage.setItem('auth_token', 'fake_admin_token');
            localStorage.setItem('user_role', 'admin');
            localStorage.setItem('user_name', '×× ×”×œ');
            
            document.getElementById('action-result').innerHTML = 'âœ… ××™×¤×•×¡ ×”×•×©×œ× - ×¢×•×‘×¨ ×œ×× ×”×œ...';
            
            setTimeout(() => {
                window.location.href = '/admin/dashboard';
            }, 1000);
        }

        function forceGoToAdmin() {
            console.log('ğŸ”„ Force go to admin dashboard');
            document.getElementById('action-result').innerHTML = 'ğŸ”„ ×¢×•×‘×¨ ×œ×× ×”×œ...';
            window.location.href = '/admin/dashboard';
        }

        function forceGoToBusiness() {
            console.log('ğŸ”„ Force go to business dashboard');
            document.getElementById('action-result').innerHTML = 'ğŸ”„ ×¢×•×‘×¨ ×œ×¢×¡×§...';
            window.location.href = '/business/dashboard';
        }

        async function testTakeoverFlow() {
            try {
                document.getElementById('takeover-result').innerHTML = 'ğŸ§ª ×‘×•×“×§ ×–×¨×™××ª ×”×©×ª×œ×˜×•×ª...';
                
                // ××™×¤×•×¡ ×œ×× ×”×œ
                localStorage.setItem('auth_token', 'fake_admin_token');
                localStorage.setItem('user_role', 'admin');
                localStorage.setItem('user_name', '×× ×”×œ');
                localStorage.removeItem('admin_takeover_mode');
                localStorage.removeItem('business_id');
                
                // ×”×©×ª×œ×˜×•×ª ×¢×œ ×¢×¡×§ #1
                const response = await fetch('/api/admin/impersonate/1', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer fake_admin_token',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ×¢×“×›×•×Ÿ localStorage
                    localStorage.setItem('admin_takeover_mode', 'true');
                    localStorage.setItem('original_admin_token', 'fake_admin_token');
                    localStorage.setItem('business_id', '1');
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('user_role', 'business');
                    localStorage.setItem('user_name', `×× ×”×œ ×©×•×œ×˜ ×‘-${data.business.name}`);
                    
                    document.getElementById('takeover-result').innerHTML = 
                        `âœ… ×”×©×ª×œ×˜×•×ª ×”×•×©×œ××”!<br>` +
                        `×¢×¡×§: ${data.business.name}<br>` +
                        `×¢×•×‘×¨ ×œ×¢××•×“ ×”×¢×¡×§...`;
                    
                    setTimeout(() => {
                        window.location.href = '/business/dashboard';
                    }, 2000);
                } else {
                    throw new Error(data.error || '×”×©×ª×œ×˜×•×ª × ×›×©×œ×”');
                }
            } catch (error) {
                document.getElementById('takeover-result').innerHTML = 
                    `âŒ ×©×’×™××”: ${error.message}`;
            }
        }

        // ×‘×“×™×§×” ×¨××©×•× ×™×ª
        checkCurrentStatus();
        
        // ×¨×¢× ×•×Ÿ ×›×œ 3 ×©× ×™×•×ª
        setInterval(checkCurrentStatus, 3000);
    </script>
</body>
</html>