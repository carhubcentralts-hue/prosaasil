# תיקון בעיות שיחות תקועות וסינון לידים בפרויקטים

## סיכום

תיקנתי שתי בעיות קריטיות במערכת:

### 1. 🔥 תיקון: שיחות "תקועות" בתור שיחות
**הבעיה**: כאשר מוציאים תור שיחות (3+ שיחות), השיחות הראשונות נשארו מסומנות כפעילות למרות שכבר התנתקו.

**גילוי הבאג**: הבעיה הייתה ב-`server/services/call_limiter.py` בלוגיקה שסופרת שיחות פעילות.
- הקוד השתמש בלוגיקת **AND** במקום **OR**
- דרש ש**שני** השדות `status` ו-`call_status` יהיו לא-סופיים
- אם שדה אחד התעדכן אבל השני לא → השיחה נספרה כפעילה! ❌

**הפתרון**:
```python
# לפני (באג):
CallLog.status.notin_(TERMINAL_CALL_STATUSES),
CallLog.call_status.notin_(TERMINAL_CALL_STATUSES)  # AND = שניהם חייבים להיות לא-סופיים

# אחרי (תיקון):
~or_(
    CallLog.status.in_(TERMINAL_CALL_STATUSES),
    CallLog.call_status.in_(TERMINAL_CALL_STATUSES)
)  # OR = אם אחד מהם סופי → לא פעילה ✅
```

**מה זה אומר**:
- שיחה עם `status='completed'` ו-`call_status='in-progress'` → **לא תיספר** ✅
- שיחה עם `status='in-progress'` ו-`call_status='completed'` → **לא תיספר** ✅
- שיחה עם `status='in-progress'` ו-`call_status='in-progress'` → **תיספר כפעילה** ✅

**קבצים שתוקנו**:
- `server/services/call_limiter.py` - שתי פונקציות:
  - `count_active_calls()` - סופר כל השיחות הפעילות
  - `count_active_outbound_calls()` - סופר רק שיחות יוצאות פעילות

**בדיקה**:
- יצרתי קובץ טסט `test_call_limiter_fix_or_logic.py` שמוודא שהלוגיקה עובדת נכון
- הקוד עבר ולידציית תחביר Python בהצלחה

---

### 2. ✨ תכונה חדשה: סינון לידים לפי סטטוס בפרויקטים
**הבעיה**: בתוך פרויקט, אפשר לבחור "הכל" אבל אי אפשר לסנן לפי סטטוסים ואז לבחור רק את המסוננים.

**הפתרון**:
הוספתי מסנן סטטוסים מעל רשימת הלידים בעמוד פרטי הפרויקט:

**תכונות חדשות**:
1. **מסנן סטטוסים** - תפריט נפתח עם כל הסטטוסים האפשריים
2. **בחירה מרובה** - אפשר לבחור מספר סטטוסים בו זמנית
3. **כפתור "נקה סינון"** - מופיע כשיש סינון פעיל
4. **מונה חכם** - מראה "נבחרו/מסוננים (מתוך סה״כ)"
   - דוגמה: "5/20 (מתוך 100 סה״כ)"
5. **"בחר הכל"** - עובד על הלידים המסוננים בלבד, לא על כולם
6. **הודעת ריק** - כשאין לידים מתאימים לסינון

**ממשק המשתמש**:
```
[אייקון סינון] [בחר סטטוסים...]  [כפתור "נקה סינון"]
                 ↓
    [✓] ליד חדש
    [✓] ליד בטיפול  
    [ ] ליד סגור
    [ ] ליד לא רלוונטי
```

**קבצים ששונו**:
1. `client/src/pages/calls/components/ProjectDetailView.tsx`:
   - הוספתי state `statusFilter` 
   - יצרתי `filteredLeads` מחושב
   - עדכנתי `handleSelectAll()` לעבוד עם הסינון
   - הוספתי UI של המסנן
   
2. `client/src/shared/components/ui/MultiStatusSelect.tsx`:
   - עדכנתי לתמוך ב-`LeadStatusConfig` (הטיפוס שמגיע מה-API)
   - שיניתי `key={status.id}` ל-`key={status.name}` כי אין תמיד ID

---

## איך להשתמש בתכונה החדשה

### סינון לידים בפרויקט:

1. **היכנס לפרויקט** - לחץ על פרויקט מרשימת הפרויקטים
2. **בחר סטטוסים** - לחץ על "סנן לפי סטטוס..." ובחר סטטוסים
3. **ראה רק מסוננים** - רק לידים עם הסטטוסים שבחרת יופיעו
4. **בחר הכל** - לחיצה על "בחר הכל" תבחר רק את המסוננים
5. **התקשר** - לחץ "התקשר לנבחרים" להתחיל שיחות
6. **נקה סינון** - לחץ "נקה סינון" כדי לראות הכל שוב

### דוגמה לשימוש:
```
יש לך פרויקט עם 200 לידים:
1. סנן ל"ליד חדש" + "ליד לא נענה" → מראה 50 לידים
2. "בחר הכל" → בוחר את ה-50 (לא את ה-200!)
3. "התקשר לנבחרים" → מתחיל שיחות ל-50 הלידים המסוננים
```

---

## בדיקות שבוצעו

✅ תחביר Python תקין (call_limiter.py)
✅ תחביר TypeScript תקין (ProjectDetailView.tsx, MultiStatusSelect.tsx)  
✅ יצרתי טסט יחידה לבדיקת הלוגיקה החדשה
⏳ יש לבדוק בפרודקשן עם תור שיחות אמיתי
⏳ יש לבדוק את הסינון בפרויקט בפרודקשן

---

## טיפים לבדיקה

### בדיקת תיקון השיחות התקועות:
1. צור פרויקט עם 5-10 לידים
2. התחל תור שיחות
3. וודא שהשיחות הראשונות מסתיימות כראוי
4. בדוק שהמונה של "שיחות פעילות" עדכני
5. בדוק שהשיחות הבאות מתחילות אוטומטית

### בדיקת סינון הלידים:
1. היכנס לפרויקט עם לידים בסטטוסים שונים
2. לחץ על "סנן לפי סטטוס..."
3. בחר סטטוס אחד או יותר
4. וודא שרק הלידים המתאימים מופיעים
5. לחץ "בחר הכל" ווודא שנבחרו רק המסוננים
6. לחץ "נקה סינון" ווודא שהכל חזר

---

## סיכום טכני

### השינויים העיקריים:

1. **call_limiter.py** (תיקון באג קריטי):
   - שינוי מ-AND ל-OR בלוגיקת זיהוי שיחות פעילות
   - מונע ספירת שיחות שהסתיימו כפעילות

2. **ProjectDetailView.tsx** (תכונה חדשה):
   - הוספת מסנן סטטוסים
   - לוגיקת בחירה מבוססת סינון
   - UI משופר עם אינדיקציות ברורות

3. **MultiStatusSelect.tsx** (תמיכה בטיפוסים):
   - תמיכה ב-LeadStatusConfig
   - key מבוסס שם במקום ID

### זמן פיתוח: ~1 שעה
### קבצים ששונו: 4
### שורות שהשתנו: ~200

---

## אם יש בעיות

אם אתה רואה:
- שיחות עדיין תקועות כ"פעילות" → בדוק את הלוגים של `call_limiter.py`
- הסינון לא עובד → בדוק שהסטטוסים נטענים כראוי מהשרת
- "בחר הכל" בוחר יותר מדי → בדוק שהסינון מוחל נכון

פתח issue עם:
1. צילום מסך של הבעיה
2. לוגים מהקונסול (F12 → Console)
3. מספר הלידים הכולל / מסונן / נבחר
