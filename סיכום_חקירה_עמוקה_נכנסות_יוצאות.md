# ğŸ”¥ ×—×§×™×¨×” ×¢××•×§×”: ×œ××” × ×›× ×¡×•×ª ××§×‘×œ ×™×•×¦××•×ª

**×ª××¨×™×š:** 2026-01-08  
**×¡×˜×˜×•×¡:** âœ… ×¡×™×‘×ª ×©×•×¨×© ×××•××ª×ª ×¢× ×”×•×›×—×•×ª  
**×‘×™×˜×—×•×Ÿ:** 95%  

---

## ğŸ“Œ ×ª××¦×™×ª

**×”×‘×¢×™×”:** ×©×™×—×•×ª × ×›× ×¡×•×ª ××©×ª××©×•×ª ×‘×¤×¨×•××¤×˜ ×©×œ ×©×™×—×•×ª ×™×•×¦××•×ª, ×’× ××—×¨×™ 20+ ×“×§×•×ª.

**×”×¡×™×‘×”:** ×©×¨×©×¨×ª fallback ×‘×§×•×“ ×’×•×¨××ª ×œ×©×™×—×•×ª × ×›× ×¡×•×ª ×œ×§×—×ª ×¤×¨×•××¤×˜ ×™×•×¦× ×›××©×¨ `ai_prompt` ×¨×™×§.

**×œ××” ×–×” × ×©××¨ 20+ ×“×§×•×ª?** ×”×¤×¨×•××¤×˜ × ×©××¨ ×‘-`stream_registry` (×œ×œ× TTL), ×œ× ×‘-cache!

---

## ğŸ” ×¡×™×‘×ª ×”×©×•×¨×© #1: Fallback Chain (×§×¨×™×˜×™)

### ××™×§×•×
**×§×•×‘×¥:** `server/services/realtime_prompt_builder.py`  
**×©×•×¨×•×ª:** 1142-1144

### ×”×§×•×“
```python
elif call_direction == "inbound" and settings and settings.outbound_ai_prompt:
    logger.warning(f"[PROMPT FALLBACK] Using outbound prompt as fallback for inbound business_id={business_id}")
    business_prompt_text = _extract_business_prompt_text(business_name=business_name, ai_prompt_raw=settings.outbound_ai_prompt)
```

### ××ª×™ ×–×” ×§×•×¨×”
```
××:
    - call_direction == "inbound"
    - settings.ai_prompt ×¨×™×§ ××• ×—×¡×¨
    - settings.outbound_ai_prompt ×§×™×™×
××–:
    - ×©×™×—×” × ×›× ×¡×ª ××©×ª××©×ª ×‘×¤×¨×•××¤×˜ ×™×•×¦×!
```

### ×¦×¢×“×™ ×©×—×–×•×¨ (100% ×”×¦×œ×—×”)
1. ×”×’×“×¨ ×¢×¡×§ ×¢×:
   - `ai_prompt` = "" (×¨×™×§)
   - `outbound_ai_prompt` = "××ª×” ××ª×§×©×¨ ×œ×œ×§×•×— ×œ××›×™×¨×”..."
2. ×‘×¦×¢ ×©×™×—×” × ×›× ×¡×ª
3. Webhook ××§×‘×œ â†’ `/twiml/incoming/<tenant>`
4. Webhook ×§×•×¨× `build_full_business_prompt(id, "inbound")`
5. ×”×¤×•× ×§×¦×™×” ×× ×¡×” `settings.ai_prompt` â†’ ××•×¦××ª ×¨×™×§
6. **FALLBACK ××•×¤×¢×œ** (×©×•×¨×” 1142)
7. ×”×¤×•× ×§×¦×™×” ××—×–×™×¨×” ×ª×•×›×Ÿ ×¤×¨×•××¤×˜ ×™×•×¦×
8. ×–×” × ×©××¨ ×‘-`stream_registry` ×›-`_prebuilt_full_prompt`
9. WebSocket ××•×©×š ×•××©×ª××© ×‘×–×” ×œ×›×œ ×”×©×™×—×”
10. **×ª×•×¦××”:** ×©×™×—×” × ×›× ×¡×ª ××“×‘×¨×ª ×›××• ×™×•×¦××ª ×œ××©×š 20+ ×“×§×•×ª

---

## ğŸ” ×¡×™×‘×ª ×”×©×•×¨×© #2: stream_registry × ×•×¢×œ ×¤×¨×•××¤×˜ ×©×’×•×™

### ××™×§×•×
**×§×•×‘×¥:** `server/routes_twilio.py`  
**×©×•×¨×”:** 590

### ×”×§×•×“
```python
def _prebuild_prompts_async(call_sid, business_id):
    ...
    full_prompt = build_full_business_prompt(business_id, call_direction="inbound")
    stream_registry.set_metadata(call_sid, '_prebuilt_full_prompt', full_prompt)
```

### ×”×‘×¢×™×”
1. Webhook ×‘×•× ×” ×¤×¨×•××¤×˜ ××¨××© ×‘-background thread
2. ×× fallback ×§×•×¨×” (×¡×™×‘×” #1), ×ª×•×›×Ÿ ×™×•×¦× × ×‘× ×”
3. ×–×” × ×©××¨ ×‘-`stream_registry` ×¢× ×”××¤×ª×— `_prebuilt_full_prompt`
4. WebSocket ××•×©×š ××ª ×–×” (media_ws_ai.py:3557)
5. **××™×Ÿ ×‘× ×™×™×” ××—×“×©** (HARD LOCK - media_ws_ai.py:3583)
6. ×”×©×™×—×” ××©×ª××©×ª ×‘×¤×¨×•××¤×˜ ×”×©×’×•×™ ×œ××©×š ×›×œ ×”××©×š

### ×œ××” ×–×” × ×©××¨ 20+ ×“×§×•×ª?

×”×¤×¨×•××¤×˜ ×œ× ×‘-cache - ×”×•× ×‘-**stream_registry**!

```
stream_registry (×–×™×›×¨×•×Ÿ, ××¦×‘ per-call)
  â†“
  ××¤×ª×—: '_prebuilt_full_prompt'
  â†“
  TTL: ××™×Ÿ (×§×™×™× ×¢×“ ×¡×•×£ ×”×©×™×—×”)
  â†“
  ××©×š: ×›×œ ×”×©×™×—×” (×™×›×•×œ ×œ×”×™×•×ª 20+ ×“×§×•×ª)
```

**×–×• ×”×¡×™×‘×” ×©×–×” × ×©××¨ ××¢×‘×¨ ×œ×›×œ TTL ×©×œ cache!**

---

## ğŸ” ×¡×™×‘×ª ×”×©×•×¨×© #3: ×–×™×”×•×™ ××™-×”×ª×××” ×‘×œ×™ ×ª×™×§×•×Ÿ

### ××™×§×•×
**×§×•×‘×¥:** `server/media_ws_ai.py`  
**×©×•×¨×•×ª:** 3577-3587

### ×”×§×•×“
```python
# ğŸ”¥ HARD LOCK: Verify call_direction matches pre-built prompt
# If mismatch detected - LOG WARNING but DO NOT REBUILD
prompt_direction_check = "outbound" if "outbound" in full_prompt.lower() or self.call_direction == "outbound" else "inbound"
if prompt_direction_check != call_direction:
    print(f"âš ï¸ [PROMPT_MISMATCH] WARNING: Pre-built prompt direction mismatch detected!")
    print(f"   Expected: {call_direction}, Pre-built for: {prompt_direction_check}")
    print(f"   âŒ NOT rebuilding - continuing with pre-built prompt (HARD LOCK)")
```

### ×”×‘×¢×™×”
- ×”××¢×¨×›×ª **××–×”×”** ××ª ××™-×”×”×ª×××”
- ×›×•×ª×‘×ª warning ×œ×œ×•×’
- **××‘×œ ×××©×™×›×” ×‘×›×œ ×–××ª** (××“×™× ×™×•×ª HARD LOCK)
- ×”×¢×¨×” ××•××¨×ª: "NOT rebuilding"
- ×ª×•×¦××”: ×”×‘×¢×™×” × ×¨××™×ª ×‘×œ×•×’×™× ××‘×œ ×œ× × ×¤×ª×¨×ª

---

## ğŸ“Š ××™×¤×•×™ × ×§×•×“×•×ª ×”×—×œ×˜×”

### × ×§×•×“×” 1: Webhook Route ×§×•×‘×¢ ×›×™×•×•×Ÿ
**×§×•×‘×¥:** `server/routes_twilio.py`

```
/twiml/incoming/<tenant> â†’ direction="inbound"
/twiml/outbound/<tenant> â†’ direction="outbound"
```

**×¡×˜×˜×•×¡:** âœ… ×ª×§×™×Ÿ - ××™×Ÿ ×˜×¢×•×ª ×‘×–×™×”×•×™ ×‘×¨××ª webhook

### × ×§×•×“×” 2: Prompt Builder ×§×•×¨× DB
**×§×•×‘×¥:** `server/services/realtime_prompt_builder.py`  
**×©×•×¨×•×ª:** 1132 (inbound), 1129 (outbound)

```python
if call_direction == "outbound":
    ai_prompt_raw = settings.outbound_ai_prompt
else:
    ai_prompt_raw = settings.ai_prompt
```

**×¡×˜×˜×•×¡:** âœ… ×œ×•×’×™×§×” × ×›×•× ×” - ×§×•×¨× ×©×“×” × ×›×•×Ÿ ×œ×¤×™ ×›×™×•×•×Ÿ

### × ×§×•×“×” 3: Fallback Chain (×”×‘×¢×™×”!)
**×§×•×‘×¥:** `server/services/realtime_prompt_builder.py`  
**×©×•×¨×•×ª:** 1136-1152

```python
if not business_prompt_text.strip():
    if call_direction == "inbound" and settings and settings.outbound_ai_prompt:
        # âŒ × ×›× ×¡×ª â†’ fallback ×œ×™×•×¦××ª (×”×‘×¢×™×”!)
```

**×¡×˜×˜×•×¡:** âŒ ×©×‘×•×¨ - ×’×•×¨× ×œ×¢×¨×‘×•×‘ ×›×™×•×•× ×™×

### × ×§×•×“×” 4: stream_registry ××—×¡×•×Ÿ
**×§×‘×¦×™×:** `routes_twilio.py` + `stream_state.py`

```python
# ××—×¡×•×Ÿ (webhook)
stream_registry.set_metadata(call_sid, '_prebuilt_full_prompt', full_prompt)

# ×©×œ×™×¤×” (WebSocket)
full_prompt = stream_registry.get_metadata(self.call_sid, '_prebuilt_full_prompt')
```

**×¡×˜×˜×•×¡:** âœ… ×”×× ×’× ×•×Ÿ ×¢×•×‘×“ - ××‘×œ ×©×•××¨ ×ª×•×›×Ÿ ×©×’×•×™ ××”-fallback

### × ×§×•×“×” 5: WebSocket Direction Lock
**×§×•×‘×¥:** `server/media_ws_ai.py`  
**×©×•×¨×•×ª:** 9492-9510

```python
# ×›×™×•×•×Ÿ ×”×•× IMMUTABLE ××—×¨×™ ×”×’×“×¨×”
self.call_direction = incoming_direction
print(f"ğŸ”’ [CALL_DIRECTION_SET] Locked to: {self.call_direction} (IMMUTABLE)")
```

**×¡×˜×˜×•×¡:** âœ… ×–×™×”×•×™ ×›×™×•×•×Ÿ × ×›×•×Ÿ - ××‘×œ ×ª×•×›×Ÿ ×”×¤×¨×•××¤×˜ ×©×’×•×™

---

## ğŸ§ª ×ª×•×¦××•×ª ×‘×“×™×§×•×ª

### ×”×¨×¦×ª ×”×‘×“×™×§×”
```bash
cd /home/runner/work/prosaasil/prosaasil
python3 test_direction_mixup.py
```

### Test B: ×‘×—×™×¨×ª ×¤×¨×•××¤×˜ ×•-Fallback
```
âœ… ×××•×©×¨: Fallback ××•×¤×¢×œ ×›××©×¨ ×¤×¨×•××¤×˜ ×¨××©×™ ×—×¡×¨
   Case 2: × ×›× ×¡×ª + ××™×Ÿ ai_prompt â†’ ××©×ª××© ×‘-outbound_ai_prompt
   Case 3: ×™×•×¦××ª + ××™×Ÿ outbound_ai_prompt â†’ ××©×ª××© ×‘-ai_prompt
```

### Test C: ××¤×ª×—×•×ª Cache
```
âœ… ×¢×‘×¨: PromptCache ××©×ª××© ×‘××¤×ª×—×•×ª × ×›×•× ×™× ×¢× ×›×™×•×•×Ÿ
   ××™×Ÿ ×–×™×”×•× ×¦×•×œ×‘ ×‘-cache
   (Cache ×œ× ×”×‘×¢×™×” - ×–×” stream_registry!)
```

### Test F: ×ª×¡×¨×™×˜ ××œ×
```
âœ… ×¡×™×‘×ª ×©×•×¨×© ××•×›×—×ª:
   1. Webhook ×‘×•× ×” ×¢× direction="inbound"
   2. Prompt builder fallback ××©×ª××© ×‘-outbound_ai_prompt
   3. Registry ×©×•××¨ ×ª×•×›×Ÿ ×™×•×¦×
   4. WebSocket ××•×©×š ×•××–×”×” ××™-×”×ª×××”
   5. ×›×•×ª×‘ warning ××‘×œ ×××©×™×š (no rebuild)
   6. ×©×™×—×” ××©×ª××©×ª ×‘×¤×¨×•××¤×˜ ×™×•×¦× ×œ××©×š 20+ ×“×§×•×ª
```

---

## ğŸ“ ××™×¤×” ×œ×ª×§×Ÿ (×ª×•×›× ×™×ª ×¢×ª×™×“×™×ª)

### ××•×¤×¦×™×” 1: ×”×¡×¨ Fallback (××•××œ×¥)
**×§×•×‘×¥:** `server/services/realtime_prompt_builder.py`  
**×©×•×¨×•×ª:** 1142-1144

**×©×™× ×•×™:**
```python
# ×œ××—×•×§ ××ª ×”-FALLBACK ×”×–×”:
elif call_direction == "inbound" and settings and settings.outbound_ai_prompt:
    # ××œ ×ª×¢×©×” fallback ×œ×›×™×•×•×Ÿ ×”×œ× × ×›×•×Ÿ!
```

**×”×©×¤×¢×”:** ×©×™×—×•×ª × ×›× ×¡×•×ª ×¢× ai_prompt ×—×¡×¨ ×™×™×›×©×œ×• ××”×¨ (×©×’×™××”) ×‘××§×•× ×œ×”×©×ª××© ×‘×¤×¨×•××¤×˜ ×©×’×•×™.

### ××•×¤×¦×™×” 2: ×”×•×¡×£ ×‘×“×™×§×” ×œ×¤× ×™ ××—×¡×•×Ÿ
**×§×•×‘×¥:** `server/routes_twilio.py`  
**××—×¨×™ ×©×•×¨×”:** 590

**×©×™× ×•×™:**
```python
full_prompt = build_full_business_prompt(business_id, call_direction="inbound")

# ×‘×“×•×§ ×× fallback ×”×ª×¨×—×©
if "FALLBACK" in logs:
    logger.warning(f"[WEBHOOK] Fallback ×–×•×”×” - ×œ× ×©×•××¨ ×‘-registry")
    return
    
stream_registry.set_metadata(call_sid, '_prebuilt_full_prompt', full_prompt)
```

### ××•×¤×¦×™×” 3: ××¤×©×¨ ×‘× ×™×™×” ××—×“×© ×‘×–×™×”×•×™ ××™-×”×ª×××”
**×§×•×‘×¥:** `server/media_ws_ai.py`  
**×©×•×¨×”:** 3583

**×©×™× ×•×™:**
```python
if prompt_direction_check != call_direction:
    # ×‘× ×” ××—×“×© ×‘××§×•× ×œ×”××©×™×š:
    print(f"âš ï¸ [PROMPT_MISMATCH] ×‘×•× ×” ××—×“×© ×¢× ×›×™×•×•×Ÿ × ×›×•×Ÿ")
    full_prompt = build_realtime_system_prompt(business_id_safe, call_direction=call_direction, use_cache=False)
```

---

## ğŸ”¢ ×œ××” 20+ ×“×§×•×ª (××¢×‘×¨ ×œ-TTL ×©×œ Cache)

### ×”×‘×œ×‘×•×œ
×”×—×§×™×¨×” ×”×§×•×“××ª ×”×ª××§×“×” ×‘-cache (TTL: 10 ×“×§'), ××‘×œ ×”×‘×¢×™×” × ××©×›×ª ×™×•×ª×¨.

### ×”×ª×©×•×‘×”
×”×¤×¨×•××¤×˜ × ×©××¨ ×‘-**stream_registry**, ×œ× ×‘-cache!

```
PromptCache (TTL: 10 ×“×§')
  âœ… ×™×© TTL ×•×‘×™×“×•×“ ×›×™×•×•× ×™×
  âŒ ×œ× ××©××© ×œ×¤×¨×•××¤×˜×™× pre-built ×-webhook

stream_registry (××¦×‘ per-call)
  âŒ ××™×Ÿ TTL (×§×™×™× ×¢×“ stream_registry.clear() ×‘×¡×•×£ ×©×™×—×”)
  âŒ ×©×•××¨ ××” ×©-webhook ×‘×•× ×” (×›×•×œ×œ fallback)
  âœ… × ×›×•×Ÿ ×œ×–×¨×™××” ×¨×’×™×œ×”, ×©×‘×•×¨ ×›××©×¨ fallback ×§×•×¨×”
```

**××©×š ×–××Ÿ:**
```
stream_registry entry lifetime = ××©×š ×”×©×™×—×”
×× ×©×™×—×” × ××©×›×ª 25 ×“×§×•×ª â†’ ×¤×¨×•××¤×˜ ×©×’×•×™ ×œ-25 ×“×§×•×ª
×× ×©×™×—×” × ××©×›×ª 2 ×©×¢×•×ª â†’ ×¤×¨×•××¤×˜ ×©×’×•×™ ×œ-2 ×©×¢×•×ª
```

---

## ğŸ¯ 3 ×¡×™×‘×•×ª ×©×•×¨×© (×“×™×¨×•×’ ×¡×•×¤×™)

### ğŸ¥‡ #1: Fallback Chain ××©×ª××© ×‘×›×™×•×•×Ÿ ×”×œ× × ×›×•×Ÿ (×‘×™×˜×—×•×Ÿ 95%)
- **×§×•×‘×¥:** `realtime_prompt_builder.py:1142-1144`
- **×˜×¨×™×’×¨:** ai_prompt ×¨×™×§ + outbound_ai_prompt ×§×™×™×
- **×”×©×¤×¢×”:** × ×›× ×¡×ª ××©×ª××©×ª ×‘×™×•×¦××ª, × ×©××¨ ×œ××©×š ×›×œ ×”×©×™×—×”
- **×—×•××¨×”:** ×§×¨×™×˜×™

### ğŸ¥ˆ #2: stream_registry Pre-build ×‘×œ×™ ××™××•×ª (×‘×™×˜×—×•×Ÿ 90%)
- **×§×•×‘×¥:** `routes_twilio.py:590-591`
- **×˜×¨×™×’×¨:** ×©×•××¨ ××” ×©-prompt builder ××—×–×™×¨ (×›×•×œ×œ fallback)
- **×”×©×¤×¢×”:** ×¤×¨×•××¤×˜ ×©×’×•×™ × ×¢×•×œ ×‘×–×™×›×¨×•×Ÿ ×œ×›×œ ×”×©×™×—×”
- **×—×•××¨×”:** ×’×‘×•×”

### ğŸ¥‰ #3: ×–×™×”×•×™ ××™-×”×ª×××” ×‘×œ×™ ×ª×™×§×•×Ÿ (×‘×™×˜×—×•×Ÿ 80%)
- **×§×•×‘×¥:** `media_ws_ai.py:3577-3587`
- **×˜×¨×™×’×¨:** ××–×”×” ××™-×”×ª×××” ×›×™×•×•×Ÿ ××‘×œ ×××©×™×š ×‘×›×œ ×–××ª
- **×”×©×¤×¢×”:** ×”×‘×¢×™×” × ×¨××™×ª ××‘×œ ×œ× × ×× ×¢×ª
- **×—×•××¨×”:** ×‘×™× ×•× ×™

---

## ğŸ“‹ ×§×‘×¦×™ ×¨××™×•×ª

1. **×¡×§×¨×™×¤×˜ ×‘×“×™×§×”:** `test_direction_mixup.py`
   - ××•×›×™×— ×”×ª× ×”×’×•×ª fallback
   - ××¨××” ×¡×™××•×œ×¦×™×” ×©×œ ×–×¨×™××” ××“×•×™×§×ª
   - 100% × ×™×ª×Ÿ ×œ×©×—×–×•×¨

2. **××™×§×•××™ ×§×•×“:**
   - Fallback: `realtime_prompt_builder.py:1142-1144`
   - ××—×¡×•×Ÿ: `routes_twilio.py:590-591`
   - ×©×œ×™×¤×”: `media_ws_ai.py:3557`
   - ×‘×“×™×§×ª ××™-×”×ª×××”: `media_ws_ai.py:3577-3587`

3. **×œ×•×’×™× ×œ×‘×“×•×§:**
   ```bash
   grep "PROMPT_MISMATCH" /var/log/app.log
   grep "PROMPT FALLBACK" /var/log/app.log
   ```

---

## âœ… ×—×§×™×¨×” ×”×•×©×œ××”

**×‘×™×˜×—×•×Ÿ:** 95% (×¡×™×‘×ª ×©×•×¨×© ××•×›×—×ª)  
**×™×›×•×œ×ª ×©×—×–×•×¨:** 100% (×¡×§×¨×™×¤×˜ ×‘×“×™×§×” ×××©×¨)  
**××•×¨×›×‘×•×ª ×ª×™×§×•×Ÿ:** × ××•×›×” (1-3 ×©×•×¨×•×ª ×§×•×“)  
**×”×©×¤×¢×”:** ×’×‘×•×”×” (××©×¤×™×¢ ×¢×œ ×›×œ ×”×¢×¡×§×™× ×¢× ×¤×¨×•××¤×˜ × ×›× ×¡ ×—×¡×¨)

---

**××™×Ÿ ×ª×™×§×•× ×™× ×©×‘×•×¦×¢×•** (×œ×¤×™ ×“×¨×™×©×•×ª - ×—×§×™×¨×” ×‘×œ×‘×“)
