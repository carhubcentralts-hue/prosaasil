# תיקון בעיית הקונטקסט של הערות לידים - סיכום

## הבעיה שדווחה
הבינה המלאכותית בשיחות לא קיבלה את ההערות והמידע הקיים על הלקוח מהדטהבייס, ולא עדכנה הערות חדשות במהלך או אחרי השיחה.

## הפתרון שיושם

### 1. טעינת הערות בתחילת שיחה
כעת, בתחילת כל שיחה:
- המערכת טוענת את 3 ההערות האחרונות של הליד מהדטהבייס
- כל הערה מקוצרת ל-150 תווים (סה"כ מקסימום 450 תווים)
- ההערות מוזרקות לקונטקסט של הבינה המלאכותית דרך מערכת NAME_ANCHOR

**פורמט ההזרקה:**
```
Customer name: שי. Use it naturally. Previous notes: הערה 1 | הערה 2 | הערה 3
```

### 2. שימוש בהערות במהלך השיחה
הבינה המלאכותית מקבלת את ההקשר המלא:
- יודעת על בעיות קודמות
- יודעת על העדפות הלקוח
- יודעת על פגישות קודמות
- יכולה לספק שירות מותאם אישית

**דוגמה:**
אם בהערה כתוב "לקוח ביקש תיקון בלמים בביקור הקודם", הבינה המלאכותית יכולה לשאול "איך הבלמים? האם התיקון שעשינו עזר?"

### 3. שמירת הערות בסוף שיחה
אחרי כל שיחה:
- המערכת יוצרת הערה חדשה מסוג `call_summary`
- ההערה מכילה את התמלול הראשון של השיחה (500 תווים)
- ההערה מקושרת לשיחה דרך `call_id`
- ההערה מסומנת כ-AI-generated (created_by = NULL)

## קבצים ששונו

### 1. `server/services/realtime_prompt_builder.py`
- פונקציה `build_name_anchor_message()` עודכנה לקבל פרמטר `lead_notes`
- ההערות מתווספות בפורמט קריא: "Previous notes: ..."
- קיצור אוטומטי ל-500 תווים מקסימום

### 2. `server/media_ws_ai.py` 
**שלושה שינויים:**

#### א. בזיהוי הלקוח (שורות ~3471-3530):
```python
# טעינת הערות מהדטהבייס
recent_notes = LeadNote.query.filter_by(
    lead_id=lead_for_context.id,
    tenant_id=business_id_safe
).order_by(LeadNote.created_at.desc()).limit(3).all()

# שילוב ההערות למחרוזת אחת
self.pending_lead_notes = " | ".join(notes_parts)
```

#### ב. בהזרקת NAME_ANCHOR (4 מקומות):
```python
name_anchor_text = build_name_anchor_message(
    customer_name, 
    use_name_policy, 
    customer_gender,
    lead_notes  # 🔥 הוספנו פרמטר הערות
)
```

#### ג. בסיום שיחה (שורות ~15803-15835):
```python
# יצירת הערה חדשה
lead_note = LeadNote(
    lead_id=call_log.lead_id,
    tenant_id=call_log.business_id,
    note_type='call_summary',
    content=note_content,
    call_id=call_log.id,
    created_at=datetime.utcnow(),
    created_by=None  # AI-generated
)
db.session.add(lead_note)
db.session.commit()
```

## בדיקות

### בדיקות אוטומטיות
- ✅ `test_lead_notes_context.py` - 5 מבחנים עברו בהצלחה
- ✅ `test_lead_notes_integration.py` - בדיקת אינטגרציה מלאה
- ✅ אין שגיאות תחביר בקבצים ששונו

### מדריך בדיקה ידנית
קובץ `MANUAL_TESTING_GUIDE_LEAD_NOTES.md` מכיל:
- שאילתות SQL להוספת נתוני בדיקה
- 3 תרחישי בדיקה מפורטים
- הדרכה לדיבאג
- מה לחפש בלוגים

## איך לבדוק בסביבת הפרודקשן

### 1. יצירת נתוני בדיקה
```sql
-- מצא/צור ליד
SELECT id, full_name, phone_e164, tenant_id FROM leads WHERE phone_e164 = '+972504294724';

-- הוסף הערות לבדיקה (החלף LEAD_ID ו-TENANT_ID)
INSERT INTO lead_notes (lead_id, tenant_id, note_type, content, created_at, created_by)
VALUES 
  (3, 4, 'manual', 'לקוח ביקש תיקון בלמים בביקור הקודם', NOW(), 1),
  (3, 4, 'manual', 'הלקוח העדיף טכנאי בשם אלי', NOW(), 1);
```

### 2. ביצוע שיחת בדיקה
1. התקשר למספר הטלפון של הליד
2. בדוק בלוגים שההערות נטענו:
   ```
   ✅ [NOTES] Fetched 3 notes from Lead (lead_id=3)
   📝 [NOTES] Preview: לקוח ביקש תיקון בלמים...
   ```
3. במהלך השיחה, שאל את הבינה המלאכותית: "מה אתה יודע עלי?"
4. **תוצאה צפויה:** הבינה המלאכותית תזכיר את הבעיות/העדפות מההערות

### 3. אימות שמירת הערות
אחרי שהשיחה מסתיימת:
1. בדוק בלוגים:
   ```
   ✅ [FINALIZE] Created lead note for lead_id=3 from call CA...
   ```
2. בדוק בדטהבייס:
   ```sql
   SELECT id, note_type, LEFT(content, 100), created_at 
   FROM lead_notes 
   WHERE lead_id = 3 
   ORDER BY created_at DESC 
   LIMIT 1;
   ```
3. **תוצאה צפויה:** הערה חדשה עם `note_type='call_summary'` והתמלול

## יתרונות הפתרון

### 1. רציפות בשיחות
- לקוח חוזר לא צריך לחזור על הבעיה שלו
- הבינה המלאכותית "זוכרת" פגישות ובעיות קודמות
- חוויית משתמש משופרת משמעותית

### 2. יעילות טוקנים
- רק 3 הערות אחרונות (450 תווים מקסימום)
- לא מכביד על המודל
- איזון מושלם בין קונטקסט למהירות תגובה

### 3. תיעוד אוטומטי
- כל שיחה מתועדת אוטומטית
- ניתן לעקוב אחרי היסטוריית הלקוח
- מועיל לניתוח ושיפור השירות

## מה הלאה?

### לפריסה מיידית:
1. ✅ הקוד כבר נבדק וללא שגיאות
2. ✅ תיעוד מלא של הפיצ'ר
3. ⏳ נדרש פריסה לסביבת הפרודקשן
4. ⏳ ביצוע בדיקה ידנית עם שיחות אמיתיות

### אופציות להרחבה עתידית:
- הגדלת מספר ההערות שנטענות (כרגע 3, אפשר 5-10)
- סינון הערות לפי סוג (רק call_summary או רק manual)
- הצגת הערות בממשק המשתמש במהלך השיחה
- יצירת סיכומים חכמים יותר עם AI

## תמיכה ודיבאג

### בדיקת הערות קיימות
```sql
SELECT 
  l.full_name,
  ln.note_type,
  LEFT(ln.content, 100) as preview,
  ln.created_at
FROM lead_notes ln
JOIN leads l ON ln.lead_id = l.id
WHERE l.phone_e164 = '+972504294724'
ORDER BY ln.created_at DESC;
```

### חיפוש בלוגים
חפש בלוגים של הבקאנד:
- `[NOTES] Fetched` - הערות נטענו
- `[NAME_ANCHOR] Injected` - הקונטקסט הוזרק
- `[FINALIZE] Created lead note` - הערה נשמרה

---

**סטטוס:** ✅ התיקון הושלם ונבדק
**נדרש:** פריסה לפרודקשן ובדיקה ידנית
**מסמכים:** `MANUAL_TESTING_GUIDE_LEAD_NOTES.md`
