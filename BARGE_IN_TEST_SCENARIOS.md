# ðŸ§ª Barge-In Testing Scenarios

## ×ž×“×¨×™×š ×‘×“×™×§×•×ª ×ž×”×™×¨ ×œ×‘×¨×’-××™×Ÿ

×”×©×™× ×•×™×™× ×©×‘×•×¦×¢×•:
- âš¡ ×–×ž×Ÿ ×–×™×”×•×™: 300ms (×‘×ž×§×•× 500ms)
- ðŸ”“ ×ª×ž×™×“ ×¤×¢×™×œ ×ž×ª×—×™×œ×ª ×”×©×™×—×”
- ðŸ›¡ï¸ ×”×’× ×” ×ž×¤× ×™ ×¨×¢×©×™ ×¨×§×¢
- ðŸ“Š ×œ×•×’×™× ×‘×¨×•×¨×™×

---

## ×ª×¡×¨×™×˜×™ ×‘×“×™×§×”

### 1ï¸âƒ£ ×‘×¨×’-××™×Ÿ ×¢×œ ×”×‘×¨×›×”

**××™×š ×œ×‘×“×•×§:**
1. ×”×ª×§×©×¨ ×œ×ž×¢×¨×›×ª
2. ×›×©×”× ×¦×™×’ ×ž×ª×—×™×œ ×œ×‘×¨×š (×´×”×™×™ ×–×” ×ž××ª×¨...×´)
3. ×—×ª×•×š ××•×ª×• ×‘××ž×¦×¢ ×ž×©×¤×˜ ×•××ž×¨: **×´×©×œ×•×, ×× ×™ ×¦×¨×™×š ×¢×–×¨×”×´**

**×ª×•×¦××” ×¦×¤×•×™×”:**
- âœ… ×”× ×¦×™×’ ×ž×¤×¡×™×§ ×œ×“×‘×¨ ×ª×•×š 300ms
- âœ… ×”×ž×¢×¨×›×ª ×ž×ª×—×™×œ×” ×œ×”××–×™×Ÿ ×œ×š ×ž×™×“
- âœ… ×”×ž×©×¤×˜ ×©×œ×š × ×©×ž×¢ ×‘×ž×œ×•××• (×œ× ×—×¡×¨ ×”×ª×—×œ×”)
- âœ… ×‘×œ×•×’×™× ×™×•×¤×™×¢: `ðŸ” [BARGE-IN] User interrupted AI - stopping TTS...`

**×× ×œ× ×¢×•×‘×“:**
- âŒ ×”× ×¦×™×’ ×ž×ž×©×™×š ×œ×“×‘×¨ ××—×¨×™ ×©×”×ª×—×œ×ª
- âŒ ×œ× ×©×•×ž×¢×™× ××ª ×”×”×ª×—×œ×” ×©×œ ×”×ž×©×¤×˜ ×©×œ×š
- âŒ ×”×ž×¢×¨×›×ª ×œ× ×ž×’×™×‘×” ×œ×ž×” ×©××ž×¨×ª

---

### 2ï¸âƒ£ ×‘×¨×’-××™×Ÿ ×‘××ž×¦×¢ ×ª×©×•×‘×” ××¨×•×›×”

**××™×š ×œ×‘×“×•×§:**
1. ×©××œ ×©××œ×” ×©×ª×’×¨×•× ×œ×ª×©×•×‘×” ××¨×•×›×”: **×´×ª×¡×¤×¨ ×œ×™ ×¢×œ ×”×©×™×¨×•×ª×™× ×©×œ×›××´**
2. ×›×©×”× ×¦×™×’ ×ž×ª×—×™×œ ×œ×”×¡×‘×™×¨ (×ª×Ÿ ×œ×• ×œ×“×‘×¨ 2-3 ×©× ×™×•×ª)
3. ×—×ª×•×š ××•×ª×• ×‘××ž×¦×¢: **×´×¨×’×¢, ×™×© ×œ×™ ×©××œ×”×´**

**×ª×•×¦××” ×¦×¤×•×™×”:**
- âœ… ×”× ×¦×™×’ × ×¤×¡×§ ×ž×™×“ (×ª×•×š 300ms)
- âœ… ××ª×” × ×©×ž×¢ ×‘×‘×™×¨×•×¨
- âœ… ×”×ž×¢×¨×›×ª ×ž×’×™×‘×” ×œ×©××œ×” ×”×—×“×©×” ×©×œ×š
- âœ… ×‘×œ×•×’×™×: `ðŸ” [BARGE-IN] User interrupted AI...`

**×× ×œ× ×¢×•×‘×“:**
- âŒ ×”× ×¦×™×’ ×ž×ž×©×™×š ×œ×“×‘×¨ ×›×ž×” ×©× ×™×•×ª ×œ××—×¨ ×”×—×™×ª×•×š
- âŒ ×”×ž×¢×¨×›×ª ×œ× ×©×•×ž×¢×ª ××ª ×”×©××œ×” ×”×—×“×©×”
- âŒ ×™×© echo ××• ×›×¤×™×œ×•×ª

---

### 3ï¸âƒ£ ××™×Ÿ ×‘×¨×’-××™×Ÿ ×¢×œ ×¨×¢×© ×¨×§×¢

**××™×š ×œ×‘×“×•×§:**
1. ×”×ª×§×©×¨ ×œ×ž×¢×¨×›×ª
2. ×›×©×”× ×¦×™×’ ×ž×“×‘×¨, ×ª×Ÿ ×¨×¢×©×™× ×§×¦×¨×™×:
   - ðŸ’¨ × ×©×™×ž×” ×—×–×§×”
   - ðŸ¤§ ×©×™×¢×•×œ ×§×¦×¨
   - ðŸŽµ ×ž×•×–×™×§×” ×‘×¨×§×¢
   - ðŸš— ×¨×¢×© ×ª× ×•×¢×”
   - ðŸ“± ×¦×¤×¦×•×£/×‘×™×¤ ×§×¦×¨

**×ª×•×¦××” ×¦×¤×•×™×”:**
- âœ… ×”× ×¦×™×’ ×ž×ž×©×™×š ×œ×“×‘×¨ ×œ×œ× ×”×¤×¨×¢×”
- âœ… ×¨×§ ×“×™×‘×•×¨ ××ž×™×ª×™ (×ž×™×œ×™×) ×’×•×¨× ×œ×‘×¨×’-××™×Ÿ
- âœ… ×‘×œ×•×’×™× ××™×Ÿ `[BARGE-IN]` ×¢×œ ×¨×¢×©×™×

**×× ×œ× ×¢×•×‘×“:**
- âŒ ×”× ×¦×™×’ × ×—×ª×š ×¢×œ ×¨×¢×© ×§×¦×¨
- âŒ ×™×•×ª×¨ ×ž×“×™ ×¨×’×™×© ×œ×¨×¢×©×™ ×¨×§×¢
- âŒ ×‘×œ×•×’×™× ×ž×œ××™× ×‘××™×¨×•×¢×™ barge-in ×©×’×•×™×™×

---

### 4ï¸âƒ£ ×ž×¡×¤×¨ ×‘×¨×’-××™× ×™× ×‘××•×ª×” ×©×™×—×”

**××™×š ×œ×‘×“×•×§:**
1. ×”×ª×§×©×¨ ×œ×ž×¢×¨×›×ª
2. ×—×ª×•×š ××ª ×”× ×¦×™×’ 3-4 ×¤×¢×ž×™× ×‘×ž×”×œ×š ×”×©×™×—×”:
   - ×¤×¢× 1: ×¢×œ ×”×‘×¨×›×”
   - ×¤×¢× 2: ×‘××ž×¦×¢ ×ª×©×•×‘×”
   - ×¤×¢× 3: ××—×¨×™ ×©×ª×™×§×” ×©×œ ×”×œ×§×•×—
   - ×¤×¢× 4: ×¢×œ ×©××œ×ª ×”×ž×©×š

**×ª×•×¦××” ×¦×¤×•×™×”:**
- âœ… ×›×œ ×‘×¨×’-××™×Ÿ ×¢×•×‘×“ ×‘××•×ª×” ×¢×§×‘×™×•×ª
- âœ… ××™×Ÿ ×”×™×“×¨×“×¨×•×ª ×‘×‘×™×¦×•×¢×™×
- âœ… ×”×ž×¢×¨×›×ª ×—×•×–×¨×ª ×œ×”×§×©×‘×” ××—×¨×™ ×›×œ ×‘×¨×’-××™×Ÿ

**×× ×œ× ×¢×•×‘×“:**
- âŒ ×‘×¨×’-××™×Ÿ ×”×¨××©×•×Ÿ ×¢×•×‘×“ ××‘×œ ×”×©× ×™×™× ×œ×
- âŒ ×™×© ×”×©×”×™×•×ª ×”×•×œ×›×•×ª ×•×’×“×œ×•×ª
- âŒ ×”×ž×¢×¨×›×ª × ×ª×§×¢×ª ××—×¨×™ ×‘×¨×’-××™×Ÿ

---

### 5ï¸âƒ£ ×‘×¨×’-××™×Ÿ ×ž×”×™×¨ (×‘×“×™×§×ª ×–×ž×Ÿ ×ª×’×•×‘×”)

**××™×š ×œ×‘×“×•×§:**
1. ×”×ª×§×©×¨ ×œ×ž×¢×¨×›×ª
2. ×©×™× ×œ×‘ ×œ×©×¢×•×Ÿ ×›×©×”× ×¦×™×’ ×ž×ª×—×™×œ ×œ×“×‘×¨
3. ×—×ª×•×š ××•×ª×• ×•×©×™× ×œ×‘ ×›×ž×” ×–×ž×Ÿ ×œ×•×§×— ×¢×“ ×©×”×•× × ×¤×¡×§

**×ª×•×¦××” ×¦×¤×•×™×”:**
- âœ… ×”× ×¦×™×’ × ×¢×¦×¨ ×ª×•×š **200-300ms** ×ž×¨×’×¢ ×©×”×ª×—×œ×ª ×œ×“×‘×¨
- âœ… ×–×” ×ž×¨×’×™×© ×˜×‘×¢×™ ×›×ž×• ×©×™×—×” ×¨×’×™×œ×”
- âœ… ××™×Ÿ ×´×–× ×‘×´ ×©×œ ×“×™×‘×•×¨ ××—×¨×™ ×”×—×™×ª×•×š

**×ž×“×™×“×” ×˜×›× ×™×ª (××•×¤×¦×™×•× ×œ×™):**
```bash
# ×‘×œ×•×’×™× ×ª×¨××”:
ðŸ” [BARGE-IN] User interrupted AI - stopping TTS...
    â””â”€ Detection: rms=XXX >= 60, continuous=15 frames (300ms)
```

---

## ðŸ” ×ž×” ×œ×—×¤×© ×‘×œ×•×’×™×

### âœ… ×œ×•×’×™× ×ª×§×™× ×™×:
```
ðŸ” [BARGE-IN] User interrupted AI - stopping TTS and switching to user speech
    â””â”€ Detection: rms=125.0 >= 60.0, continuous=15 frames (300ms)
ðŸ” [BARGE-IN] Stopping AI response and audio playback...
âœ… [BARGE-IN] Cancelled response abc123...
ðŸŽ¤ [REALTIME] BARGE-IN complete â€“ AI FULLY STOPPED, user can speak
```

### âŒ ×‘×¢×™×•×ª ××¤×©×¨×™×•×ª ×‘×œ×•×’×™×:
```
# ×× ×¨×•××™× ×”×¨×‘×” ×›××œ×” - ×¨×’×™×©×•×ª ×™×ª×¨:
ðŸ” [BARGE-IN] User interrupted AI...
ðŸ” [BARGE-IN] User interrupted AI...
ðŸ” [BARGE-IN] User interrupted AI...

# ×× ×œ× ×¨×•××™× ×‘×›×œ×œ - ×‘×¨×’-××™×Ÿ ×œ× ×¢×•×‘×“:
(××™×Ÿ ×œ×•×’×™× ×©×œ BARGE-IN ×›×©××ª×” ×ž× ×¡×” ×œ×—×ª×•×š)

# ×× ×¨×•××™× timeout ××• error:
âš ï¸ [BARGE-IN] Failed to cancel response: timeout
âŒ [TX_LOOP] Send failed...
```

---

## ðŸ› ï¸ ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×ž×”×™×¨

### ×× ×‘×¨×’-××™×Ÿ ×œ× ×¢×•×‘×“ ×‘×›×œ×œ:

1. **×‘×“×•×§ ×©×”×©×¨×ª ×”×•×¤×¢×œ ×ž×—×“×©:**
   ```bash
   # ×¢×¦×•×¨ ×•×”×¤×¢×œ ×ž×—×“×©
   ./stop_services.sh
   ./start_production.sh
   ```

2. **×—×¤×© ×©×’×™××•×ª ×‘×œ×•×’×™×:**
   ```bash
   grep -i "barge" logs/server.log | tail -50
   ```

3. **×•×•×“× ×©×”×§×•×‘×¥ ×¢×•×“×›×Ÿ:**
   ```bash
   grep "BARGE_IN_VOICE_FRAMES = 15" server/media_ws_ai.py
   grep "self.barge_in_enabled = True" server/media_ws_ai.py
   ```

### ×× ×™×© ×¨×¢×© ×™×ª×¨ (false positives):

×–×” × ×“×™×¨, ××‘×œ ×× ×”× ×¦×™×’ × ×—×ª×š ×¢×œ ×¨×¢×©×™×:
1. ×‘×“×•×§ ××ª ×¨×ž×ª ×”×¨×¢×© ×”×¡×‘×™×‘×ª×™
2. ×‘×“×•×§ ×‘×œ×•×’×™× ××ª ×¢×¨×›×™ ×”-RMS ×©×’×•×¨×ž×™× ×œ×‘×¢×™×”
3. ×™×™×ª×›×Ÿ ×©×¦×¨×™×š ×œ×”×¢×œ×•×ª threshold (××‘×œ ×œ× ×ž×•×ž×œ×¥)

### ×× ×‘×¨×’-××™×Ÿ ××™×˜×™ ×ž×“×™:

×× ×œ×•×§×— ×™×•×ª×¨ ×ž-500ms:
1. ×‘×“×•×§ ×¢×•×ž×¡ CPU/×¨×©×ª
2. ×—×¤×© ×‘×œ×•×’×™× delays ××• timeouts
3. ×‘×“×•×§ ×©×œ× ×¢×•×‘×¨ fallback ×œ-Google STT

---

## ðŸ“Š ×ž×˜×¨×™×§×•×ª ×”×¦×œ×—×”

| ×ž×“×“ | ×¢×¨×š ×¦×¤×•×™ |
|-----|----------|
| ×–×ž×Ÿ ×–×™×”×•×™ ×‘×¨×’-××™×Ÿ | 200-300ms |
| ××—×•×– ×”×¦×œ×—×” | >95% |
| False positives (×¨×¢×©) | <2% |
| ×ž×¡×¤×¨ ×‘×¨×’-××™× ×™× ×œ×©×™×—×” | ×œ×œ× ×”×’×‘×œ×” |
| ×–×ž×Ÿ ×”×ª××•×©×©×•×ª | <500ms |

---

## âœ… Checklist ×¡×•×¤×™

- [ ] ×‘×¨×’-××™×Ÿ ×¢×•×‘×“ ×¢×œ ×‘×¨×›×”
- [ ] ×‘×¨×’-××™×Ÿ ×¢×•×‘×“ ×‘××ž×¦×¢ ×ª×©×•×‘×”
- [ ] ××™×Ÿ false positives ×¢×œ ×¨×¢×©
- [ ] ×ž×¡×¤×¨ ×‘×¨×’-××™× ×™× ×‘××•×ª×” ×©×™×—×”
- [ ] ×–×ž×Ÿ ×ª×’×•×‘×” â‰¤ 300ms
- [ ] ×œ×•×’×™× ×‘×¨×•×¨×™× ×•×œ×œ× ×©×’×™××•×ª
- [ ] ×œ× ×©×™×‘×©× ×• ×“×‘×¨×™× ××—×¨×™× (greeting, prompts, etc.)

---

**ðŸŽ‰ ×× ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• - ×‘×¨×’-××™×Ÿ ×ž×•×›×Ÿ ×œ×¤×¨×•×“×§×©×Ÿ!**
