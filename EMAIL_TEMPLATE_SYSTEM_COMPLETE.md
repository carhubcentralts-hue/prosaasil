# מערכת תבניות מייל - הושלמה בהצלחה ✅

## תיאור הבעיה המקורית

במערכת המיילים הקיימת, כאשר נשלח מייל עם תבנית, הסינטקס של Handlebars/Mustache (כמו `{{#if signature}}` או `{{lead.first_name}}`) הופיע כטקסט גולמי במייל במקום להירנדר כראוי. זה גרם למיילים להראות לא מקצועיים עם קוד טכני גלוי.

## הפתרון שיושם

### 1. רינדור תבניות עם Jinja2 ✅

**מה נעשה:**
- הוחלף מנגנון החלפת מחרוזות פשוט ב-Jinja2 - מנוע תבניות מלא ועוצמתי
- תמיכה מלאה במשתנים: `{{lead.first_name}}`, `{{business.name}}`, `{{agent.name}}`
- תמיכה בבלוקים תנאיים: `{% if signature %}...{% endif %}`
- טיפול בטוח ב-autoescape למניעת XSS

**קובץ:** `server/services/email_service.py`

**דוגמה לשימוש:**
```html
<p>שלום {% if lead %}{{lead.first_name}}{% else %}שם{% endif %},</p>
<p>אנחנו ב-{{business.name}} שמחים ליצור איתך קשר.</p>
{% if signature %}
<div style="border-top: 1px solid #ddd; padding-top: 10px;">
  {{signature}}
</div>
{% endif %}
```

### 2. שלוש תבניות ברירת מחדל ✅

**Migration 62** יוצר אוטומטית 3 תבניות לכל עסק:

#### תבנית 1: ברכת ברירת מחדל
- **שם:** "ברירת מחדל - ברכה"
- **סוג:** welcome
- **נושא:** "שלום מ-{{business.name}}"
- **שימוש:** מייל היכרות ראשוני ללקוחות חדשים

#### תבנית 2: תזכורת לקביעת שיחה
- **שם:** "תזכורת - קביעת שיחה"
- **סוג:** followup
- **נושא:** "תזכורת - {{business.name}}"
- **שימוש:** מעקב אחרי לידים שלא הגיבו

#### תבנית 3: הודעת מעקב מהירה
- **שם:** "מעקב - הודעה מהירה"
- **סוג:** quick_followup
- **נושא:** "רק רציתי לוודא - {{business.name}}"
- **שימוש:** בדיקת מצב מהירה עם הליד

**קובץ:** `server/db_migrate.py` (שורות 2148-2346)

### 3. עריכת תבניות בממשק ✅

**מה נוסף:**
- כפתור **"תבנית חדשה"** בטאב תבניות (רק למנהלים)
- כפתור **"ערוך"** על כל תבנית
- מודל עריכה מלא עם:
  - שדה שם התבנית
  - שדה נושא המייל
  - שדה תוכן HTML (עם הסברים על Jinja2)
  - שדה תוכן טקסט רגיל (אופציונלי)
  - רמזים על משתנים זמינים
  
**קובץ:** `client/src/pages/emails/EmailsPage.tsx`

**אבטחה:**
- רק משתמשים עם תפקיד `system_admin`, `owner`, או `admin` יכולים לערוך
- כל התבניות מבודדות לפי `business_id`
- HTML מנוקה (sanitized) למניעת XSS

### 4. שיפורים נוספים ✅

#### טיפול בשגיאות משופר
- הצגת שגיאות ברורות כאשר טעינת לידים נכשלת
- לוגים לקונסול לצורכי דיבוג
- אייקונים ויזואליים להתראות

#### תמיכה בחתימה (Signature)
- משתנה `signature` מוזרק אוטומטית מה-`footer_html` של העסק
- ניתן להשתמש ב-`{% if signature %}` בתבניות
- נשמר בהגדרות המייל של העסק

## API Endpoints

### תבניות
- `GET /api/email/templates` - רשימת תבניות
- `POST /api/email/templates` - יצירת תבנית חדשה
- `PUT /api/email/templates/:id` - עדכון תבנית
- `DELETE /api/email/templates/:id` - מחיקה רכה
- `POST /api/email/templates/:id/preview` - תצוגה מקדימה

### מיילים
- `POST /api/leads/:id/email` - שליחת מייל לליד
- `GET /api/leads/:id/emails` - היסטוריית מיילים של ליד
- `GET /api/email/messages` - רשימת כל המיילים

### הגדרות
- `GET /api/email/settings` - הגדרות מייל של העסק
- `POST /api/email/settings` - שמירת הגדרות
- `POST /api/email/settings/test` - שליחת מייל בדיקה

## תרחישי שימוש

### שימוש 1: שליחת מייל ללקוח חדש
1. עבור לדף "מיילים" → טאב "שלח ללידים"
2. חפש את הליד לפי שם/טלפון/מייל
3. לחץ "שלח מייל"
4. בחר תבנית (למשל "ברירת מחדל - ברכה")
5. ערוך את הנושא/תוכן לפי הצורך
6. לחץ "שלח מייל"

### שימוש 2: יצירת תבנית חדשה
1. עבור לדף "מיילים" → טאב "תבניות"
2. לחץ "תבנית חדשה"
3. מלא שם, נושא, ותוכן
4. השתמש במשתנים: `{{lead.first_name}}`, `{{business.name}}`
5. הוסף בלוקים תנאיים: `{% if signature %}...{% endif %}`
6. לחץ "צור תבנית"

### שימוש 3: עריכת תבנית קיימת
1. עבור לדף "מיילים" → טאב "תבניות"
2. לחץ "ערוך" על התבנית שברצונך לערוך
3. שנה את השדות
4. לחץ "שמור שינויים"

## משתנים זמינים

### משתני ליד (Lead)
- `{{lead.first_name}}` - שם פרטי
- `{{lead.last_name}}` - שם משפחה
- `{{lead.email}}` - כתובת מייל
- `{{lead.phone}}` - מספר טלפון

### משתני עסק (Business)
- `{{business.name}}` - שם העסק
- `{{business.phone}}` - טלפון העסק

### משתני סוכן (Agent)
- `{{agent.name}}` - שם הסוכן ששלח
- `{{agent.email}}` - מייל הסוכן

### משתנים נוספים
- `{{signature}}` - חתימת העסק (מהגדרות)

## בלוקים תנאיים

```jinja2
{% if lead %}
  שלום {{lead.first_name}},
{% else %}
  שלום שם,
{% endif %}

{% if signature %}
<div class="signature">
  {{signature}}
</div>
{% endif %}
```

## בדיקות שבוצעו ✅

1. ✅ רינדור משתנים בסיסי: `{{name}}` → "World"
2. ✅ רינדור משתנים מקוננים: `{{lead.first_name}}` → "John"
3. ✅ בלוקים תנאיים עם תוכן: `{% if signature %}Best regards{% endif %}` → "Best regards"
4. ✅ בלוקים תנאיים ריקים: `{% if signature %}{% endif %}` (כאשר signature ריק) → לא מופיע כלום
5. ✅ API endpoints: כל ה-endpoints עובדים כראוי
6. ✅ אבטחה: רק admins יכולים לערוך, tenant isolation עובד

## קבצים שהשתנו

### Backend
- `server/services/email_service.py` - רינדור Jinja2, תמיכה בחתימה
- `server/db_migrate.py` - Migration 62 ליצירת תבניות ברירת מחדל
- `server/email_api.py` - (ללא שינוי - API כבר היה מוכן)

### Frontend
- `client/src/pages/emails/EmailsPage.tsx` - עריכת תבניות, טיפול משופר בשגיאות
- `client/src/pages/Leads/LeadDetailPage.tsx` - (ללא שינוי - כבר עובד טוב)

## הפעלת המערכת

### שלב 1: הרצת המיגרציות
```bash
cd /home/runner/work/prosaasil/prosaasil
python -m server.db_migrate
```

זה יבדוק אם יש עסקים ללא תבניות ויצור להם אוטומטית 3 תבניות.

### שלב 2: אין צורך בשינויים נוספים
המערכת עובדת אוטומטית! כל עסק חדש שייווצר יקבל את 3 התבניות אוטומטית.

## דוגמה למייל שנשלח

**לפני התיקון:**
```
שלום {{lead.first_name}},

אנחנו ב-{{business.name}} שמחים ליצור איתך קשר.

{{#if signature}}
{{signature}}
{{/if}}
```

**אחרי התיקון:**
```
שלום ישראל,

אנחנו ב-שי דירות ומשרדים בע״מ שמחים ליצור איתך קשר.

בברכה,
צוות שי דירות
טלפון: 03-1234567
info@example.com
```

## תמיכה ותחזוקה

### בעיות נפוצות

**בעיה: תבניות לא נוצרו אוטומטית**
- **פתרון:** הרץ את `python -m server.db_migrate` ידנית

**בעיה: משתנים לא מתרנדרים**
- **פתרון:** בדוק שהסינטקס נכון: `{{variable}}` ולא `{variable}`

**בעיה: חתימה לא מופיעה**
- **פתרון:** הגדר את `footer_html` בהגדרות המייל של העסק

### איך לדבג

1. בדוק את הקונסול בדפדפן - יש לוגים
2. בדוק את לוגי השרת
3. נסה לשלוח מייל בדיקה מהגדרות
4. השתמש ב-preview לפני שליחה

## סיכום

✅ **הושלם בהצלחה** - מערכת תבניות מייל מלאה ופועלת
✅ **3 תבניות ברירת מחדל** - נוצרות אוטומטית לכל עסק
✅ **עריכת תבניות** - ממשק מלא ליצירה ועריכה
✅ **רינדור נכון** - Jinja2 מטפל בכל המשתנים והתנאים
✅ **מאובטח** - הפרדה בין עסקים, רק admins יכולים לערוך
✅ **פשוט לשימוש** - ממשק ידידותי עם רמזים והסברים

---

**תאריך:** 4 בינואר 2026
**גרסה:** Build 350+
**סטטוס:** ✅ מוכן לפרודקשן
