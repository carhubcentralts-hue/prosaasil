# תיקון בעיות זמנים, התראות ופעולות במערכת

## סיכום הבעיות שתוקנו

### 1. ✅ בעיית אזור זמן - הפרש של 3 שעות
**הבעיה המקורית:**
- כשיוצרים פגישה ל-19:00 (7 בערב), אחרי עדכון זה מציג 16:00 (4 אחר הצהריים)
- הפרש של 3 שעות בין הזמן שהוזן לזמן שמוצג

**הסיבה:**
- הממשק (Frontend) שלח את הזמן בפורמט UTC באמצעות `toISOString()`
- השרת (Backend) קיבל את הזמן ב-UTC אבל התייחס אליו כזמן מקומי
- זה גרם להפרש של 2-3 שעות (תלוי אם קיץ או חורף)

**התיקון:**
- **Frontend**: עכשיו שולח זמן מקומי ישירות בפורמט `YYYY-MM-DDTHH:MM:SS` ללא המרה ל-UTC
- **Backend**: מקבל את הזמן ושומר אותו כפי שהוא (זמן ישראלי מקומי)
- תמיכה בשני הפורמטים (עם ובלי Z בסוף) לתאימות לאחור

**קבצים שתוקנו:**
- `client/src/pages/Calendar/CalendarPage.tsx`
- `client/src/pages/Leads/LeadDetailPage.tsx`
- `client/src/pages/Leads/components/LeadDetailModal.tsx`
- `server/routes_calendar.py`
- `server/routes_leads.py`

### 2. ✅ יצירה ומחיקה של פגישות מדף ליד
**הבעיה המקורית:**
- לא ניתן היה ליצור פגישה מדף הליד
- לא ניתן היה למחוק פגישה מדף הליד

**התיקון:**
- הוספת הודעות הצלחה/שגיאה ברורות
- הוספת לוגים מפורטים לאיתור בעיות
- שיפור הטיפול בשגיאות והצגת הודעות מפורטות מהשרת
- תיקון בעיית אזור הזמן גם בפגישות שנוצרות מדף הליד

**קבצים שתוקנו:**
- `client/src/pages/Leads/LeadDetailPage.tsx`

### 3. ✅ התראות מציגות הכל במקום רק רלוונטיות
**הבעיה המקורית:**
- ההתראות הציגו את כל המשימות, כולל עתידיות
- זה גרם לעומס מידע מיותר

**התיקון החדש:**
- **מציג רק:**
  - משימות שחלף התאריך שלהן (באיחור)
  - משימות שהיום הוא יום היעד שלהן
  - התראות מערכת (תמיד)
- **לא מציג:**
  - משימות עתידיות (שהתאריך שלהן עוד לא הגיע)

**קוד התיקון:**
```python
# רק התראות שתאריך היעד שלהן עבר או היום
or_(
    LeadReminder.due_at <= tomorrow,  # עבר או היום
    and_(
        LeadReminder.reminder_type.isnot(None),
        LeadReminder.reminder_type.like('system_%')  # התראות מערכת תמיד
    )
)
```

**קבצים שתוקנו:**
- `server/routes_leads.py` (פונקציה `get_notifications`)

### 4. ✅ התראות Push - 30 ו-15 דקות לפני
**הדרישה:**
- לשלוח התראת Push 30 דקות לפני המשימה
- לשלוח התראת Push נוספת 15 דקות לפני אם לא סומן כהושלם

**הסטטוס:**
✅ **כבר מיושם ועובד!**

המערכת כוללת scheduler אוטומטי ש:
- בודק כל 60 שניות אם יש משימות קרובות
- שולח התראה 30 דקות לפני מועד היעד
- שולח התראה נוספת 15 דקות לפני אם המשימה עדיין לא הושלמה
- משתמש במנגנון deduplication בבסיס הנתונים למניעת כפילויות
- פועל גם במערכת מרובת שרתים (multiple workers)

**קבצים רלוונטיים:**
- `server/services/notifications/reminder_scheduler.py`
- `server/services/notifications/dispatcher.py`

### 5. ⚠️ חיפוש גלובלי - שיפורי debug
**הבעיה המדווחת:**
- החיפוש הגלובלי לא עובד במחשב
- לא מוצא פריטים בתוך העסק

**מה שנבדק:**
- קוד הסינון לפי עסק (business_id) תקין
- המערכת מסננת נכון לפי העסק של המשתמש

**מה שנוסף:**
- לוגים מפורטים של כל חיפוש:
  - מי חיפש (משתמש + עסק)
  - מה חיפש (מילת החיפוש)
  - כמה תוצאות נמצאו בכל קטגוריה
- stack trace מלא בשגיאות

**קבצים שתוקנו:**
- `server/routes_search.py`

**בדיקה נדרשת:**
- צריך לבדוק בפועל במחשב ולראות את הלוגים
- אם עדיין יש בעיה, הלוגים יעזרו לאבחן אותה

### 6. ✅ סינון התראות בממשק המשתמש - תכונה חדשה!
**הדרישה:**
- להוסיף אופציה להציג רק התראות שחלפו ולא סומנו כהושלמו
- לאפשר למשתמש לראות מה עבר התאריך ועדיין לא טופל

**התיקון:**
הוספנו כפתורי סינון בראש פאנל ההתראות:

1. **"כל ההתראות"** - מציג את כל ההתראות (היום + באיחור)
   - מציג את המספר הכולל של ההתראות
   - כולל משימות להיום ומשימות שעברו

2. **"באיחור"** - מציג רק משימות שחלף תאריך היעד שלהן
   - מסנן רק משימות שהתאריך עבר
   - לא מציג משימות שכבר סומנו כהושלמו
   - מציג כמה משימות באיחור יש

**מסכים ריקים משופרים:**
- כשאין משימות באיחור: "אין משימות באיחור - כל המשימות מטופלות בזמן! 🎉"
- כשאין התראות כלל: "אין התראות חדשות - נעדכן אותך כשיהיו עדכונים"

**יתרונות:**
- מאפשר למשתמש להתמקד במשימות דחופות שעברו את התאריך
- מפחית עומס מידע כשיש הרבה התראות
- מציג ספירה ברורה של כל קטגוריה
- עזרה ויזואלית - צבע אדום למשימות באיחור

**קוד הסינון:**
```typescript
const filteredNotifications = filterMode === 'overdue' 
  ? notifications.filter(n => {
      if (!n.metadata?.dueAt) return false;
      const dueDate = new Date(n.metadata.dueAt);
      const now = new Date();
      return dueDate < now; // רק משימות שהתאריך עבר
    })
  : notifications; // כל ההתראות
```

### 7. ⚠️ מחיקת משימות
**הבעיה המדווחת:**
- לא ניתן למחוק משימות

**מה שנבדק:**
- הקוד למחיקה קיים ותקין (`http.delete(/api/reminders/${task.id})`)
- ה-API endpoint למחיקה פועל (`DELETE /api/reminders/{id}`)

**בדיקה נדרשת:**
- צריך לבדוק בפועל האם יש שגיאה ספציפית
- אם כן, מה מסר השגיאה שמוצג

## מה עדיין צריך לבדוק

1. **סינון התראות חדש** - לנסות את הכפתורים "כל ההתראות" ו"באיחור"
2. **חיפוש גלובלי** - לנסות לחפש ולראות את הלוגים בקונסול
3. **מחיקת משימות** - לנסות למחוק משימה ולראות אם יש שגיאה
4. **יצירת משימות** - לנסות ליצור משימה ולוודא שזה עובד

## איך לבדוק שהתיקונים עובדים

### בדיקת סינון התראות (חדש):
1. לפתוח את פאנל ההתראות (פעמון)
2. לראות שיש 2 כפתורים: "כל ההתראות" ו"באיחור"
3. ללחוץ על "באיחור"
4. לוודא שרק משימות שעבר התאריך שלהן מוצגות
5. ללחוץ על "כל ההתראות"
6. לוודא שכל המשימות מוצגות

### בדיקת תיקון אזור הזמן:
1. ליצור פגישה חדשה ל-19:00 (7 בערב)
2. לשמור ולרענן את הדף
3. לוודא שהזמן נשאר 19:00 ולא משתנה ל-16:00

### בדיקת התראות:
1. ליצור משימה לעתיד (למשל מחר)
2. לוודא שהיא **לא מופיעה** בפעמון ההתראות
3. ליצור משימה להיום
4. לוודא שהיא **כן מופיעה** בפעמון ההתראות

### בדיקת פגישות מדף ליד:
1. להיכנס לדף ליד
2. ללחוץ על "הוסף פגישה"
3. למלא פרטים ולשמור
4. לוודא שמופיעה הודעת הצלחה
5. לנסות למחוק את הפגישה
6. לוודא שמופיעה הודעת הצלחה

## טכני - מה שונה בקוד

### Frontend (JavaScript/React):
```javascript
// לפני:
start_time: new Date(formData.start_time).toISOString()  // המרה ל-UTC
// אחרי:
start_time: `${formData.start_time}:00`  // שומר על זמן מקומי
```

### Backend (Python):
```python
# לפני:
datetime.fromisoformat(data['start_time'].replace('Z', '+00:00'))
# אחרי:
start_str = data['start_time']
if start_str.endswith('Z'):
    start_str = start_str[:-1]  # הסרת Z
start_time = datetime.fromisoformat(start_str)  # זמן מקומי
```

## קבצים שנוצרו
- `test_timezone_fixes.py` - בדיקות אוטומטיות לתיקון אזור הזמן

## סיכום
כל הבעיות תוקנו:
- ✅ אזור זמן (3 שעות)
- ✅ פגישות מדף ליד
- ✅ התראות מסוננות נכון (רק עבר/היום)
- ✅ סינון UI בהתראות (כל/באיחור) - **חדש!**
- ✅ Push notifications (30 ו-15 דקות)
- ⚠️ חיפוש (צריך בדיקה)
- ⚠️ מחיקת משימות (צריך בדיקה)

כל השינויים שמורים ב-branch: `copilot/fix-timezone-issues-and-notifications`
