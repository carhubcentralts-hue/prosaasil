# רשימת בדיקות סופית לפריסה ✅

## 🎯 תיקונים שבוצעו

### 1. Barge-In + VAD (המשימה המקורית)
- ✅ כלל זהב: speech_started → ביטול מיידי
- ✅ הפחתת רגישות VAD (0.50 → 0.91)
- ✅ תגובה מהירה יותר (8 → 3 frames)

### 2. בעיות פריסה קריטיות (דרישות חדשות)
- ✅ תיקון SyntaxError ב-topic_classifier.py
- ✅ הוספת נעילה למיגרציות (PostgreSQL advisory lock)
- ✅ Auth endpoints יעבדו אחרי הפריסה

---

## ✅ בדיקות לפני פריסה (הכל עבר)

```bash
# בדיקת syntax
✅ python3 -m py_compile server/config/calls.py
✅ python3 -m py_compile server/media_ws_ai.py
✅ python3 -m py_compile server/services/topic_classifier.py
✅ python3 -m py_compile server/db_migrate.py

# אימות ערכי תצורה
✅ SERVER_VAD_THRESHOLD = 0.91
✅ SERVER_VAD_SILENCE_MS = 650
✅ BARGE_IN_VOICE_FRAMES = 3
```

---

## 🚀 בדיקות אחרי פריסה (חובה לבצע!)

### A. בדיקת הפעלת שרת

```bash
# 1. חפש בלוגים - השרת עלה בהצלחה?
grep "Blueprint.*registered" /var/log/app.log
```

**צפוי לראות:**
```
✅ Blueprint 'auth' registered
✅ Blueprint 'api' registered
✅ Blueprint 'routes_ai_topics' registered
✅ Blueprint 'routes_ai_prompt' registered
```

**אם לא רואים:** 😱
- בדוק שגיאות Python בלוגים
- ודא שה-SyntaxError תוקן
- אתחל את השרת

---

### B. בדיקת Auth Endpoints

```bash
# 2. בדוק CSRF endpoint
curl -i https://your-domain.com/api/auth/csrf
```
**צפוי:** `200 OK` + CSRF token

```bash
# 3. בדוק ME endpoint  
curl -i https://your-domain.com/api/auth/me
```
**צפוי:** `200 OK` (מחובר) או `401 Unauthorized` (לא מחובר)

```bash
# 4. בדוק Login endpoint
curl -X POST https://your-domain.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"wrong"}'
```
**צפוי:** `401 Unauthorized` (סיסמה שגויה) או `200 OK` (הצלחה)

**אם 404/405:** 😱
- השרת לא טען blueprints
- בדוק לוגים של app startup
- יתכן שיש SyntaxError שלא זוהה

---

### C. בדיקת מיגרציות (אם יש כמה containers)

```bash
# 5. חפש בלוגים - מיגרציות רצו בלי deadlock?
grep "migration" /var/log/app.log | grep -i "lock\|deadlock"
```

**צפוי לראות (Container 1):**
```
✅ Acquired migration lock immediately
Applied 42 migrations: ...
✅ Released migration lock
```

**צפוי לראות (Container 2+):**
```
⚠️ Another process is running migrations - waiting...
✅ Acquired migration lock after waiting
No migrations needed - database is up to date
✅ Released migration lock
```

**אם רואים deadlock:** 😱
- זה לא אמור לקרות עכשיו!
- בדוק שהקוד החדש נפרס
- ודא שה-PostgreSQL advisory lock בשימוש

---

### D. בדיקת Barge-In בשיחות

**איך לבדוק:**
1. צור שיחה נכנסת/יוצאת
2. המתן לתגובת AI
3. דבר באמצע התגובה
4. ודא שה-AI **נעצר מיד**

**צפוי:**
- ✅ AI נעצר תוך 60-200ms
- ✅ לא נשמע המשך של התשובה הישנה
- ✅ AI מתחיל תשובה חדשה על בסיס מה שאמרת

**אם AI ממשיך לדבר:** 😱
- יתכן שהקוד לא נפרס
- בדוק logs של barge-in:
  ```bash
  grep "BARGE-IN.*GOLDEN RULE" /var/log/app.log
  ```
- אמור לראות: `✅ GOLDEN RULE: Cancelled response...`

---

### E. בדיקת VAD (רגישות)

**איך לבדוק:**
1. צור שיחה
2. עמוד בשקט (ללא דיבור)
3. תן רעש רקע קל (מוזיקה רחוקה, שיחה ברקע)
4. ודא שהתמלול **לא מתחיל**

**צפוי:**
- ✅ שקט = אין תמלול
- ✅ רעש רקע קל = אין תמלול
- ✅ דיבור אמיתי = תמלול מתחיל

**אם מתחיל תמלול על רעש:** 😱
- יתכן שהערכים לא התעדכנו
- בדוק בקוד:
  ```bash
  grep "SERVER_VAD_THRESHOLD" server/config/calls.py
  ```
- אמור להיות: `0.91` (לא `0.50`)

---

## 📊 לוח בדיקות (מלא כל שורה אחרי הבדיקה)

| # | בדיקה | סטטוס | הערות |
|---|--------|-------|-------|
| 1 | השרת עלה בלי שגיאות | ⬜ |  |
| 2 | Blueprints נרשמו | ⬜ |  |
| 3 | `/api/auth/csrf` עובד | ⬜ |  |
| 4 | `/api/auth/me` עובד | ⬜ |  |
| 5 | `/api/auth/login` עובד | ⬜ |  |
| 6 | מיגרציות רצו בלי deadlock | ⬜ |  |
| 7 | Barge-in עוצר AI מיד | ⬜ |  |
| 8 | VAD לא רגיש מדי | ⬜ |  |
| 9 | שיחות עובדות כרגיל | ⬜ |  |
| 10 | לקוחות יכולים להתחבר | ⬜ |  |

---

## 🆘 מה לעשות אם משהו לא עובד?

### בעיה: השרת לא עולה
```bash
# בדוק שגיאות Python
tail -100 /var/log/app.log | grep -i "error\|exception\|syntax"

# אם יש SyntaxError:
python3 -m py_compile server/services/topic_classifier.py

# אם עדיין לא עובד:
git status  # ודא שכל השינויים נשלחו
git pull    # משוך את הקוד החדש
```

### בעיה: Auth endpoints לא עובדים
```bash
# בדוק blueprints
grep "Blueprint" /var/log/app.log

# אם לא נרשמו - יש SyntaxError
# תקן ואתחל את השרת
```

### בעיה: מיגרציות deadlock
```bash
# בדוק אם advisory lock בשימוש
grep "advisory_lock" server/db_migrate.py

# אם לא - הקוד החדש לא נפרס
git pull
# אתחל containers
```

### בעיה: Barge-in לא עובד
```bash
# בדוק logs
grep "BARGE-IN" /var/log/app.log | tail -50

# אמור לראות:
# "✅ GOLDEN RULE: Cancelled response..."

# אם לא - בדוק שה-config עודכן
grep "BARGE_IN_VOICE_FRAMES" server/config/calls.py
# אמור להיות: 3 (לא 8)
```

### בעיה: VAD רגיש מדי
```bash
# בדוק threshold
grep "SERVER_VAD_THRESHOLD" server/config/calls.py

# אם עדיין 0.50:
# הקוד החדש לא נפרס
git pull
# אתחל את השרת
```

---

## 💡 טיפים

1. **תמיד בדוק logs קודם** - רוב הבעיות נראות בלוגים
2. **ודא שהקוד נפרס** - `git log --oneline -5` אמור להראות את התיקונים
3. **אתחל את השרת** - אחרי כל שינוי קוד
4. **בדוק בשיחה אמיתית** - לא רק unit tests
5. **תעד בעיות** - תצלום מסך + logs = עזרה מהירה

---

## 📞 צור קשר

אם יש בעיות אחרי הפריסה:
1. תצלום מסך של הבעיה
2. קטע מה-logs (50 שורות אחרונות)
3. פרטי הבדיקה שביצעת
4. מה עבד ומה לא

**בהצלחה! 🚀**
