name: Production CI/CD

on:
  push:
    branches: [ main, develop, copilot/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend: Linting, Testing, and Security
  backend:
    name: Backend Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install ruff pytest pytest-cov pip-audit requests_mock
      
      - name: Lint with ruff
        run: |
          # Run ruff for code quality checks
          ruff check server/ --output-format=github
      
      - name: Run tests
        run: |
          # Run unit tests that don't require external services
          pytest tests/test_appointment_reminder_weekday_fix.py \
                 tests/test_business_settings_cache.py \
                 tests/test_cors_recording_playback.py \
                 tests/test_export_leads_by_status.py \
                 tests/test_hebrew_datetime_year_correction.py \
                 tests/test_scheduled_messages_first_name.py \
                 tests/test_webhook_payload.py \
                 tests/test_ssot_wiring.py \
                 -v --tb=short
        env:
          OPENAI_API_KEY: test-key-for-ci
          DATABASE_URL: sqlite:///test.db
        
      - name: Security audit with pip-audit
        run: |
          # Scan for known vulnerabilities in dependencies using locked requirements
          if [ -f requirements.lock ]; then
            pip-audit --desc --requirement requirements.lock
          else
            pip-audit --desc --requirement <(pip freeze)
          fi
        continue-on-error: false
  
  # Frontend: Lint, Typecheck, Test, Build, Audit, Sourcemap Validation
  frontend:
    name: Frontend Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        working-directory: ./client

      - name: Lint (ESLint)
        run: npm run lint
        working-directory: ./client

      - name: Typecheck (tsc)
        run: npm run typecheck
        working-directory: ./client

      - name: Unit tests (Vitest)
        run: npm run test
        working-directory: ./client
      
      - name: Run npm audit
        run: |
          # Check for vulnerabilities (production only)
          # Fail on high/critical vulnerabilities
          # If false positives exist, document them in client/AUDIT_ALLOWLIST.md
          npm audit --omit=dev --audit-level=high
        working-directory: ./client
      
      - name: Build frontend (production mode)
        run: |
          # Build with production settings (no sourcemaps)
          npm run build -- --mode production
        working-directory: ./client
        env:
          NODE_ENV: production
      
      - name: Verify no sourcemaps in production build
        run: |
          # Fail if any .map files are found in dist
          if find ./client/dist -name "*.map" | grep -q .; then
            echo "âŒ ERROR: Sourcemap files found in production build!"
            find ./client/dist -name "*.map"
            exit 1
          else
            echo "âœ… SUCCESS: No sourcemap files in production build"
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ./client/dist
          retention-days: 7
  
  # Docker: Build validation
  docker:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Validate docker-compose configuration
        run: |
          # Validate production compose file
          docker compose -f docker-compose.yml -f docker-compose.prod.yml config > /dev/null
          echo "âœ… docker-compose.prod.yml is valid"
      
      - name: Build backend image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend.light
          push: false
          tags: prosaas-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build frontend image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: false
          tags: prosaas-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # E2E: End-to-End Testing with Playwright
  e2e:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [docker]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Create .env file for E2E tests
        run: |
          cat > .env << EOF
          DATABASE_URL=sqlite:///test.db
          SECRET_KEY=test-secret-key-for-e2e
          OPENAI_API_KEY=test-key-for-e2e
          FLASK_ENV=test
          ENABLE_DEMO_MODE=true
          EOF
      
      - name: Start Docker Compose services
        run: |
          # Start services in detached mode
          docker compose up -d
          
          # Wait for services to be healthy
          echo "â³ Waiting for services to be healthy..."
          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:5000/healthz > /dev/null 2>&1; then
              echo "âœ… Backend is healthy"
              break
            fi
            sleep 2
            elapsed=$((elapsed + 2))
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "âŒ Services failed to start within ${timeout}s"
            docker compose logs
            exit 1
          fi
          
          # Additional wait for frontend
          sleep 5
          echo "âœ… All services are ready"
      
      - name: Run Playwright tests
        run: npm run test:e2e
        env:
          CI: true
          BASE_URL: http://localhost:5000
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: test-results/
          retention-days: 7
      
      - name: Stop Docker Compose services
        if: always()
        run: docker compose down -v

  # Security: Overall security summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, e2e]
    if: always()
    
    steps:
      - name: Generate security summary
        run: |
          echo "## ðŸ”’ Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backend security audit completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Frontend vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Production build validated (no sourcemaps)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker configuration validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… E2E tests executed (Playwright)" >> $GITHUB_STEP_SUMMARY
