# מדריך מערכת התראות ופעמון 🔔

## סקירה כללית

מערכת ההתראות מספקת התראות בזמן אמת עבור משימות ותזכורות, עם פעמון אינטראקטיבי ו-pop-up דחוף.

## רכיבי המערכת

### 1. Backend - מתזמן התראות (`reminder_scheduler.py`)

המתזמן רץ ברקע ושולח התראות push בזמנים הבאים:

- **30 דקות לפני** - ⏰ "תזכורת בעוד חצי שעה"
- **15 דקות לפני** - ⏰ "תזכורת בעוד רבע שעה!"
- **5 דקות לפני** - 🔔 "תזכורת בעוד 5 דקות!" (חדש!)

**תכונות:**
- בדיקה כל דקה (CHECK_INTERVAL_SECONDS = 60)
- מניעת כפילויות עם DB-backed deduplication
- תמיכה במספר workers/replicas
- ניקוי אוטומטי של רשומות ישנות (7 ימים)

### 2. Frontend - פאנל ההתראות (`NotificationPanel.tsx`)

פאנל אינטראקטיבי הנגיש דרך הפעמון בתפריט העליון.

**תכונות:**
- **סינון חכם:**
  - "כל ההתראות" - מציג את כל ההתראות הפעילות
  - "באיחור" - מציג רק משימות שעבר זמן היעד שלהן
  
- **תצוגה ברורה:**
  - סמלים לפי סוג (משימה, פגישה, מערכת)
  - צבעים לפי עדיפות (דחוף, גבוה, בינוני, נמוך)
  - זמן יחסי ("עוד 30 דקות", "לפני שעה", "עכשיו")
  
- **פעולות מהירות:**
  - "סמן כהושלם" - מסיים משימה ישירות מהפאנל
  - לחיצה על התראה - פותח פרטים מלאים
  - ניווט ישיר לליד או למשימה הרלוונטית

### 3. Frontend - Pop-up דחוף (`UrgentNotificationPopup`)

Pop-up שמופיע אוטומטית להתראות חשובות.

**מתי מופיע:**
- התראות מערכת (כמו ניתוק WhatsApp)
- משימות דחופות או בעדיפות גבוהה **שהגיע זמנן**
- משימות שמיועדות תוך **30 דקות** ועדיין לא הושלמו

**תכונות:**
- עיצוב בולט עם צבעים לפי דחיפות
- כפתור "סמן כהושלם" לטיפול מהיר
- אפשרות לדחיית התראה או סגירת כל ה-pop-ups
- תמיכה במספר התראות (מעבר בין התראות)

### 4. Context - ניהול מצב (`NotificationContext.tsx`)

מנהל את מצב ההתראות ברמת האפליקציה.

**תכונות:**
- **Polling אוטומטי:** בדיקה כל 30 שניות להתראות חדשות
- **Cache חכם:** שמירת מצב בין רענונים
- **Callbacks:** עדכון מונה בפעמון בזמן אמת
- **פילטור:** מסנן התראות דחופות לפי זמן ועדיפות

## זרימת עבודה טיפוסית

### תרחיש 1: יצירת תזכורת חדשה

1. משתמש יוצר תזכורת לשיחה עם לקוח מחר בשעה 10:00
2. הנתונים נשמרים ב-DB עם `due_at` = "2024-01-18T10:00:00"
3. המתזמן בודק כל דקה האם יש תזכורות שמתקרבות
4. **30 דקות לפני (09:30):**
   - המתזמן זוהה שהתזכורת תוך 30 דקות
   - שולח התראה: "⏰ תזכורת בעוד חצי שעה"
   - רושם ב-DB שהתראת 30 דקות נשלחה
5. **15 דקות לפני (09:45):**
   - המתזמן זוהה שהתזכורת תוך 15 דקות
   - שולח התראה: "⏰ תזכורת בעוד רבע שעה!"
   - רושם ב-DB שהתראת 15 דקות נשלחה
6. **5 דקות לפני (09:55):**
   - המתזמן זוהה שהתזכורת תוך 5 דקות
   - שולח התראה: "🔔 תזכורת בעוד 5 דקות!"
   - רושם ב-DB שהתראת 5 דקות נשלחה

### תרחיש 2: חווית משתמש

1. **09:30** - משתמש רואה badge אדום על הפעמון (1)
2. לוחץ על הפעמון → פאנל נפתח
3. רואה: "⏰ בקרוב - שם לקוח: משימה - בעוד 30 דקות"
4. **Pop-up גם מופיע** (כי זה תוך 30 דקות ובעדיפות גבוהה)
5. אפשרויות:
   - לחץ "סמן כהושלם" (אם כבר טיפל)
   - לחץ "פתח ליד" (לפרטי הליד)
   - לחץ "אישור" (לדחיית ה-pop-up)
6. **09:45** - התראה נוספת: "⏰ תזכורת בעוד רבע שעה!"
7. **09:55** - התראה אחרונה: "🔔 תזכורת בעוד 5 דקות!"

## הגדרות טכניות

### Backend

```python
# reminder_scheduler.py
INITIAL_DELAY_SECONDS = 30  # המתן לפני בדיקה ראשונה
CHECK_INTERVAL_SECONDS = 60  # בדוק כל דקה
CLEANUP_DAYS = 7  # נקה רשומות ישנות

# זמני התראה
window_30_start = now + timedelta(minutes=29)
window_30_end = now + timedelta(minutes=31)
window_15_start = now + timedelta(minutes=14)
window_15_end = now + timedelta(minutes=16)
window_5_start = now + timedelta(minutes=4)
window_5_end = now + timedelta(minutes=6)
```

### Frontend

```typescript
// NotificationContext.tsx
const POLLING_INTERVAL = 30000; // 30 שניות

// Pop-up window
const thirtyMinutesFromNow = new Date(now.getTime() + 30 * 60 * 1000);

// Priority mapping
case 'overdue': return { priority: 'urgent', ... }
case 'today': return { priority: 'high', ... }
case 'soon': return { priority: 'high', ... }
case 'tomorrow': return { priority: 'medium', ... }
```

## API Endpoints

### GET `/api/notifications`
מחזיר רשימת התראות פעילות

**Response:**
```json
{
  "success": true,
  "notifications": [
    {
      "id": "123",
      "title": "שיחה עם לקוח",
      "due_date": "2024-01-18T10:00:00",
      "category": "soon",
      "priority": "high",
      "lead_id": 456,
      "lead_name": "יוסי כהן"
    }
  ],
  "count": 1
}
```

### PATCH `/api/reminders/{id}`
מסמן תזכורת כהושלמה

**Request:**
```json
{
  "completed": true
}
```

## בדיקות

### בדיקה ידנית

1. צור תזכורת חדשה לעוד 31 דקות
2. חכה 1 דקה
3. וודא שהתראת 30 דקות הגיעה
4. בדוק שה-badge על הפעמון התעדכן
5. פתח את הפאנל וראה את ההתראה
6. וודא ש-pop-up מופיע

### בדיקה אוטומטית

```bash
python test_5_minute_notification.py
```

## טיפול בבעיות נפוצות

### הפעמון לא מציג מספר נכון
- בדוק שה-polling פועל (console.log)
- בדוק את ה-API response
- וודא שהסינון עובד

### Pop-up לא מופיע
- בדוק שההתראה בעדיפות high/urgent
- וודא שההתראה תוך 30 דקות
- בדוק שהתראה לא נדחתה כבר

### התראות כפולות
- המערכת מונעת כפילויות דרך DB
- אם יש כפילויות, בדוק את ה-deduplication logic

## שינויים אחרונים

- ✅ הוספת התראה ב-5 דקות לפני
- ✅ הרחבת חלון pop-up ל-30 דקות
- ✅ שיפור סינון באיחור/הכל
- ✅ תיקון תצוגת זמנים

## תיעוד נוסף

- `TIMEZONE_NOTIFICATION_FIX_SUMMARY.md` - תיקוני זמנים
- `test_notification_display_fix.py` - בדיקות תצוגה
- `test_5_minute_notification.py` - בדיקות 5 דקות
