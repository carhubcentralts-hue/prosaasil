# מדריך מלא למערכת הפרומפטים - Realtime AI

## 🎯 סקירה כללית

המערכת בנויה על **הפרדה מושלמת** בין 3 שכבות:

1. **SYSTEM PROMPT** - כללי התנהגות (אוניברסלי, זהה לכל העסקים)
2. **BUSINESS PROMPT** - תוכן ותסריט (ייחודי לכל עסק, מגיע מה-DB)
3. **CUSTOMER DATA** - נתונים (שם לקוח, תאריך וכו')

---

## 📋 שכבה 1: SYSTEM PROMPT (כללי התנהגות)

### מיקום בקוד
- **קובץ**: `server/services/realtime_prompt_builder.py`
- **פונקציה**: `_build_universal_system_prompt(call_direction)`
- **משתמשים בו**: `build_global_system_prompt()`

### תוכן השכבה
```
✅ כללי שפה ודקדוק (עברית טבעית)
✅ כללי שימוש בשם לקוח
✅ כללי Turn-taking (להפסיק כשהלקוח מדבר)
✅ כללי בידוד עסקים (Isolation)
✅ כללי סגנון וטון
✅ כללי אמת (transcript is truth)
```

### ❌ מה שאין בשכבה הזו
```
❌ תוכן עסקי ספציפי
❌ שמות עסקים
❌ תסריטים
❌ הוראות ספציפיות לעסק
❌ מחירים, שעות פתיחה, שירותים
```

### גודל הפרומפט
- **RAW**: ~2,600 תווים
- **אחרי sanitization**: ~2,580 תווים
- **גבול**: 3,000 תווים (כדי לא לחתוך)

### כללי שימוש בשם לקוח (הכי חשוב!)
```
RULE: Use the CUSTOMER's name ONLY if the Business Prompt requests name usage.

פירוש: ה-AI לא יחליט בעצמו להשתמש בשם!
רק אם הפרומפט העסקי אומר במפורש "תשתמש בשם" - אז הוא ישתמש.

דוגמאות להוראות בפרומפט עסקי שיגרמו לשימוש בשם:
- "תשתמש בשם הלקוח"
- "פנה בשמו של הלקוח"
- "קרא ללקוח בשמו"
- "תשתמש בשם כדי ליצור קרבה"
- "אם יש שם, השתמש בו"
```

---

## 📋 שכבה 2: BUSINESS PROMPT (תוכן ותסריט)

### מיקום בקוד
- **קובץ**: `server/models_sql.py` (טבלאות `Business` ו-`BusinessSettings`)
- **שדות**:
  - `BusinessSettings.ai_prompt` - פרומפט לשיחות נכנסות
  - `BusinessSettings.outbound_ai_prompt` - פרומפט לשיחות יוצאות
  - `Business.system_prompt` - legacy (fallback בלבד)

### תוכן השכבה
```
✅ תסריט השיחה
✅ מה לומר ללקוח
✅ איזה שאלות לשאול
✅ איך להתנהג באופן ספציפי
✅ האם להשתמש בשם לקוח או לא
✅ מה המטרה של השיחה
```

### הבדלים בין שיחות נכנסות ויוצאות

#### Inbound (נכנסות)
- הלקוח התקשר לעסק
- טון: "ברוך הבא, במה אוכל לעזור?"
- שדה: `ai_prompt`

#### Outbound (יוצאות)
- העסק התקשר ללקוח
- טון: "שלום, מדבר מחברת X"
- שדה: `outbound_ai_prompt`

### דוגמאות פרומפטים עסקיים

**דוגמה 1: עם שימוש בשם**
```
אתה נציג מכירות מקצועי של חברת השרברבים.
תשתמש בשם הלקוח כדי ליצור קרבה אישית.
שאל על הבעיה שלו והצע פתרון מהיר.
```

**דוגמה 2: בלי שימוש בשם**
```
אתה נציג שירות מקצועי של חברת השרברבים.
תהיה עניין ומנומס, שאל על הבעיה והצע פתרון.
```

**ההבדל**: דוגמה 1 תגרום ל-AI להשתמש בשם, דוגמה 2 לא.

### גודל הפרומפט
- **אין הגבלה!** העסק שולט על התוכן שלו
- המערכת לא חותכת את הפרומפט העסקי
- אורך ממוצע: 500-2000 תווים (תלוי בעסק)

---

## 📋 שכבה 3: CUSTOMER DATA (נתונים)

### מיקום בקוד
- **קובץ**: `server/media_ws_ai.py`
- **שורות**: 3104-3145 (הזרקה ראשונית), 4316-4357 (הזרקה מאוחרת)

### תוכן השכבה
```
Customer name: דוד כהן
```

פורמט פשוט וקצר! למה?
- כדי שה-AI לא יקרא את זה בקול
- רק יידע שהשם קיים
- ישתמש בו אם הפרומפט העסקי מבקש

### מנגנון ההזרקה

#### 3 נקודות הזרקה:
1. **בתחילת השיחה** (אם השם זמין)
2. **כש-CRM context נוצר** (במהלך השיחה)
3. **אחרי prompt upgrade** (אם יש pending)

#### מנגנון אנטי-כפילות (אידמפוטנטי)
```python
# Flag לעקוב אחר הזרקה
self._customer_name_injected = "דוד כהן"

# בדיקה לפני כל הזרקה
if not hasattr(self, '_customer_name_injected'):
    # הזרק רק פעם אחת
```

### ולידציה
השם מוזרק רק אם:
- קיים שדה `customer_name` ב-CRM context
- הערך אינו: `null`, `""`, `"unknown"`, `"test"`, `"-"`, `"n/a"`

---

## 🔄 זרימת השיחה המלאה

### שלב 1: התחברות ל-Realtime API
```
1. פתיחת WebSocket connection
2. שליחת session.update עם COMPACT prompt (~420 chars)
   - רק תסריט ברכה מהיר
```

### שלב 2: הזרקת SYSTEM PROMPT
```
3. conversation.item.create (role="system")
   - כללי התנהגות
   - כללי שפה
   - כללי שימוש בשם
   ⏱️ קורה לפני הברכה!
```

### שלב 3: הזרקת CUSTOMER DATA
```
4. conversation.item.create (role="system")
   - "Customer name: דוד כהן"
   ⏱️ קורה לפני הברכה! (אם השם זמין)
```

### שלב 4: ברכה
```
5. response.create (is_greeting=True)
   - AI מברך את הלקוח
   - אם הפרומפט אומר "תשתמש בשם" והשם זמין → "שלום דוד!"
   - אחרת → "שלום, במה אוכל לעזור?"
```

### שלב 5: שדרוג לפרומפט מלא (Prompt Upgrade)
```
6. conversation.item.create (role="system")
   - הפרומפט העסקי המלא
   ⏱️ קורה אחרי הברכה
   - נותן ל-AI את כל ההקשר
```

### שלב 6: המשך השיחה
```
7. AI ממשיך לפי הפרומפט העסקי
   - שואל שאלות
   - אוסף מידע
   - משתמש בשם (אם הפרומפט ביקש)
```

---

## 🎯 תרחישי שימוש

### תרחיש 1: שיחה יוצאת + שם זמין + פרומפט מבקש שם
```
Setup:
- Business: חברת השרברבים
- Direction: outbound
- Business Prompt: "תשתמש בשם הלקוח ליצור קרבה"
- Customer Name: "דוד כהן"

תוצאה:
✅ AI: "היי דוד, מה נשמע? אני מתקשר מחברת השרברבים..."
```

### תרחיש 2: שיחה יוצאת + שם זמין + פרומפט לא מבקש שם
```
Setup:
- Business: חברת השרברבים
- Direction: outbound
- Business Prompt: "תהיה מקצועי ועניני"
- Customer Name: "דוד כהן"

תוצאה:
✅ AI: "שלום, מדבר מחברת השרברבים..."
❌ לא ישתמש בשם כי הפרומפט לא ביקש!
```

### תרחיש 3: שיחה נכנסת + שם לא זמין + פרומפט מבקש שם
```
Setup:
- Business: שירות לקוחות
- Direction: inbound
- Business Prompt: "תשתמש בשם הלקוח אם זמין"
- Customer Name: None

תוצאה:
✅ AI: "ברוך הבא, במה אוכל לעזור?"
✅ לא ישתמש בשם כי הוא לא זמין
```

### תרחיש 4: שיחה נכנסת + שם זמין + פרומפט מבקש שם
```
Setup:
- Business: שירות לקוחות
- Direction: inbound
- Business Prompt: "פנה ללקוח בשמו וברך אותו"
- Customer Name: "שרה לוי"

תוצאה:
✅ AI: "שלום שרה, ברוכה הבאה! במה אוכל לעזור לך?"
```

---

## ✅ וידוא תקינות המערכת

### צ'ק ליסט מהיר
```
✅ הזרקת שם נעשית ב-conversation.item.create לפני response.create
✅ role="system" (לא "user") - כדי שלא יוקרא בקול
✅ פורמט פשוט: "Customer name: דוד" (לא ניסוחים ארוכים)
✅ יש מנגנון no-duplicate injection (flag: _customer_name_injected)
✅ בפרומפט סיסטם כתוב: "ONLY if Business Prompt requests"
✅ בפרומפט עסקי שולט אם להשתמש בשם או לא
```

### בדיקת תקינות
```bash
# הרץ את הטסטים
python test_hebrew_natural_ai.py
python test_customer_name_validation.py

# צפוי: ✅ ALL TESTS PASSED!
```

---

## 🔧 פתרון בעיות נפוצות

### בעיה: AI לא משתמש בשם למרות שהשם זמין

**פתרון 1**: בדוק את הפרומפט העסקי
```
האם הפרומפט כולל משפטים כמו:
- "תשתמש בשם הלקוח"
- "פנה בשמו"
- "קרא ללקוח בשמו"

אם לא - זו לא באג! זה המערכת עובדת נכון.
```

**פתרון 2**: בדוק שהשם מוזרק
```
חפש בלוגים:
[CRM_CONTEXT] Injected customer_name='דוד כהן'

אם אין - השם לא הוזרק. בדוק:
- outbound_lead_name זמין?
- customer_name בליד תקין?
- לא "unknown" או "-"?
```

**פתרון 3**: בדוק שהפרומפט הסיסטם לא נחתך
```python
from server.services.realtime_prompt_builder import build_global_system_prompt
prompt = build_global_system_prompt(call_direction='outbound')
print(f"Length: {len(prompt)} chars")
print("Has name rules:", "Customer Name Usage:" in prompt)
print("Has complete ending:", "Business Prompt" in prompt[-200:])

# צפוי: Length ~2580, שניהם True
```

### בעיה: AI קורא "Customer name: דוד" בקול

**סיבה**: ה-role צריך להיות "system" ולא "user"

**בדיקה**:
```python
# בקוד media_ws_ai.py שורה 3124
"role": "system"  # ✅ נכון
"role": "user"    # ❌ יקרא בקול!
```

### בעיה: השם מוזרק כמה פעמים

**פתרון**: המנגנון האידמפוטנטי צריך למנוע זאת
```python
# בדוק שהבדיקה קיימת:
if not hasattr(self, '_customer_name_injected'):
    # הזרק
    self._customer_name_injected = customer_name
```

---

## 📊 גדלים והגבלות

### COMPACT prompt (session.update.instructions)
- **גודל**: 420 תווים מקסימום
- **תוכן**: רק תסריט ברכה
- **מטרה**: ברכה מהירה

### GLOBAL SYSTEM prompt (conversation.item.create)
- **גודל**: 3000 תווים מקסימום (גבול)
- **גודל בפועל**: ~2580 תווים
- **תוכן**: כללי התנהגות
- **מטרה**: הוראות כלליות

### BUSINESS prompt (מה-DB)
- **גודל**: אין הגבלה!
- **תוכן**: תסריט ותוכן עסקי
- **מטרה**: תוכן ספציפי לעסק

### CUSTOMER DATA (conversation.item.create)
- **גודל**: 20-50 תווים
- **תוכן**: "Customer name: דוד"
- **מטרה**: נתונים בלבד

---

## 🎯 עקרונות מפתח

1. **הפרדה מוחלטת**: System ≠ Business ≠ Data
2. **דינמיות מלאה**: אין hardcoding של עסקים
3. **שליטה עסקית**: הפרומפט העסקי שולט בהכל
4. **אידמפוטנטיות**: כל דבר מוזרק פעם אחת בלבד
5. **בידוד**: כל עסק עצמאי, אין cross-contamination

---

## 📝 סיכום

המערכת בנויה כך ש:

✅ **כללי ההתנהגות** (שפה, טון, שימוש בשם) - אוניברסליים
✅ **התוכן והתסריט** - ייחודיים לכל עסק
✅ **הנתונים** (שם לקוח) - מוזרקים באופן דינמי
✅ **השליטה** - בידי הפרומפט העסקי

אם רוצים שה-AI ישתמש בשם → כותבים בפרומפט "תשתמש בשם הלקוח"
אם לא רוצים → לא כותבים

**זה פשוט כל כך! 🎉**
