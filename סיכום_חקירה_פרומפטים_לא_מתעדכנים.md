# ğŸ” ×¡×™×›×•× ×—×§×™×¨×”: ×¤×¨×•××¤×˜×™× ×œ× ××ª×¢×“×›× ×™×

**×ª××¨×™×š:** 2026-01-08  
**×¡×˜×˜×•×¡:** âœ… ×”×•×©×œ× - ×–×•×”×ª×” ×¡×™×‘×ª ×©×•×¨×©  

---

## ğŸ“Œ ×ª××¦×™×ª ×× ×”×œ×™×

×–×•×”×ª×” ×‘×¢×™×” ×§×¨×™×˜×™×ª: **×›××©×¨ ××©×ª××© ××¢×“×›×Ÿ ×¤×¨×•××¤×˜ (× ×›× ×¡×•×ª/×™×•×¦××•×ª) ×“×¨×š ×”-CRM, ×”×©×™× ×•×™ ×œ× × ×›× ×¡ ×œ×ª×•×§×£ ××™×™×“×™×ª. ×©×™×—×•×ª ×—×“×©×•×ª ×××©×™×›×•×ª ×œ×§×‘×œ ××ª ×”×¤×¨×•××¤×˜ ×”×™×©×Ÿ ×¢×“ 10 ×“×§×•×ª.**

### ×”×¡×™×‘×”

×”××¢×¨×›×ª ××©×ª××©×ª ×‘**×©× ×™ ×× ×’× ×•× ×™ cache × ×¤×¨×“×™×**:
1. âœ… `AIService._cache` - **××ª×¢×“×›×Ÿ ×›×¨××•×™** (TTL: 5 ×“×§×•×ª)
2. âŒ `PromptCache` - **×œ× ××ª×¢×“×›×Ÿ!** (TTL: 10 ×“×§×•×ª)

×›××©×¨ ××©×ª××© ××©× ×” ×¤×¨×•××¤×˜, ×”×§×•×“ ×× ×§×” ×¨×§ ××ª cache #1, ××š ×œ× ××ª #2.  
**×ª×•×¦××”:** ×©×™×—×•×ª ×—×“×©×•×ª ××§×‘×œ×•×ª ×¤×¨×•××¤×˜ ×™×©×Ÿ ×-cache #2 ×œ××©×š ×¢×“ 10 ×“×§×•×ª.

---

## ğŸ¯ ×××¦××™× ×¢×™×§×¨×™×™×

### 1. ××¤×ª ×–×¨×™××” - ××™×š ×¤×¨×•××¤×˜ ×¢×•×‘×¨ ××”DB ×œOpenAI

```
××©×ª××© ××¢×“×›×Ÿ ×¤×¨×•××¤×˜ ×‘-CRM
    â†“
API: /api/admin/businesses/<id>/prompt [PUT]
    â†“
DB: ×¢×“×›×•×Ÿ settings.ai_prompt / settings.outbound_ai_prompt
    â†“
invalidate_business_cache(business_id)
    â†“
âœ… ×× ×§×” AIService._cache (5 ×“×§')
âŒ ×œ× ×× ×§×” PromptCache (10 ×“×§')
    â†“
×©×™×—×” ×—×“×©×” ××’×™×¢×”
    â†“
build_realtime_system_prompt()
    â†“
×‘×•×“×§ PromptCache.get(business_id, direction)
    â†“
ğŸš¨ ××—×–×™×¨ ×¤×¨×•××¤×˜ ×™×©×Ÿ! (×¢×“×™×™×Ÿ ×‘-cache)
    â†“
session.update â†’ ×©×•×œ×— ×¤×¨×•××¤×˜ ×™×©×Ÿ ×œ-OpenAI
    â†“
×”×©×™×—×” ××ª× ×”×œ×ª ×œ×¤×™ ×”×¤×¨×•××¤×˜ ×”×™×©×Ÿ
```

### 2. ×¨×©×™××ª Caches ×‘××¢×¨×›×ª

| Cache | ×§×•×‘×¥ | TTL | ××¤×ª×— | ×”×× ××ª× ×§×”? |
|-------|------|-----|------|------------|
| **PromptCache** | `prompt_cache.py` | 600s (10 ×“×§') | `"{business_id}:{direction}"` | âŒ ×œ× |
| **AIService._cache** | `ai_service.py` | 300s (5 ×“×§') | `"business_{id}_{channel}"` | âœ… ×›×Ÿ |
| **stream_registry** | `stream_state.py` | ×œ× ×™×“×•×¢ | `call_sid` | âš ï¸ ×œ× ×‘×“×•×§ |
| **OpenAI Session** | OpenAI API | per-call | session_id | âœ… ×›×Ÿ (×›×œ ×©×™×—×” ×—×“×©×”) |

### 3. Session Lifecycle - ×¡×“×¨ ××™×¨×•×¢×™×

```
1. WebSocket ××ª×—×‘×¨ (Twilio â†’ Server)
2. ××ª×—×™×œ RX loop (××§×©×™×‘ ×œ××™×¨×•×¢×™×)
3. ×‘×•× ×” ×¤×¨×•××¤×˜ ××œ× (×-cache ××• DB)
4. ×©×•×œ×— session.update ×¢× instructions
5. ×××ª×™×Ÿ ×œ-session.updated ××™×©×•×¨ (×¢×“ 8 ×©× ×™×•×ª)
6. ×¨×§ ××– ×©×•×œ×— response.create (×‘×¨×›×”)
7. ×›×œ ×ª×©×•×‘×•×ª ×”-AI ××©×ª××©×•×ª ×‘-instructions ××”-session
```

**âš ï¸ ×—×©×•×‘:** ××™ ××¤×©×¨ ×œ×¢×“×›×Ÿ instructions ×‘×××¦×¢ ×©×™×—×” - ×–×” ×œ×¤×™ ×¢×™×¦×•×‘ ×©×œ OpenAI.  
×›×œ ×©×™×—×” ×—×“×©×” = session ×—×“×© = instructions ×—×“×©×™× (×× cache × ×§×™).

### 4. Tenant Isolation - ×‘×™×“×•×“ ×¢×¡×§×™×

**âœ… ××‘×•×“×“ ×›×¨××•×™:**
- ×›×œ ×¢×¡×§ ×™×© ×œ×• `business_id` ×™×™×—×•×“×™
- cache keys ×›×•×œ×œ×™× ××ª `business_id`
- queries ×œ-DB ××¡× × ×™× ×œ×¤×™ `business_id`
- ××™×Ÿ global state ××©×•×ª×£

**âš ï¸ ×—×©×“ ×¤×•×˜× ×¦×™××œ×™:**
- ×× `business_id` ×”×•× `None` ××• `0`, ×›×œ ×”×©×™×—×•×ª ×¢× ×¢×¨×š ×–×” ×™×©×ª×¤×• cache
- ×“×•×¨×© ×‘×“×™×§×” ×‘×œ×•×’×™×

### 5. ×‘×—×™×¨×ª ×¤×¨×•××¤×˜ ×œ×¤×™ ×›×™×•×•×Ÿ (Inbound/Outbound)

**×©×™×—×•×ª × ×›× ×¡×•×ª:**
```python
# ×§×¨×™××” ×: settings.ai_prompt
# ×× ×—×¡×¨ â†’ fallback ×œ: settings.outbound_ai_prompt
# ×× ×—×¡×¨ â†’ fallback ×œ: business.system_prompt
# ×× ×—×¡×¨ â†’ fallback ×œ: ×ª×‘× ×™×ª ×§×‘×•×¢×”
```

**×©×™×—×•×ª ×™×•×¦××•×ª:**
```python
# ×§×¨×™××” ×: settings.outbound_ai_prompt
# ×× ×—×¡×¨ â†’ fallback ×œ: settings.ai_prompt (ğŸš¨ ×¢×œ×•×œ ×œ×‘×œ×‘×œ!)
# ×× ×—×¡×¨ â†’ fallback ×œ: ×ª×‘× ×™×ª ×§×‘×•×¢×”
```

**ğŸš¨ ×‘×¢×™×” ×¤×•×˜× ×¦×™××œ×™×ª:** ×× outbound ×—×¡×¨, ×™×™×§×— inbound â†’ ×™×›×•×œ ×œ×’×¨×•× ×œ×¢×¨×‘×•×‘ ×‘×™×Ÿ ×›×™×•×•× ×™×.

---

## ğŸ” Top 5 ×”×©×¢×¨×•×ª (×××•×™× ×•×ª ×œ×¤×™ ×¡×‘×™×¨×•×ª)

### ğŸ¥‡ #1: PromptCache ×œ× ××ª× ×§×” (×¡×‘×™×¨×•×ª: 95%)

**×××¦××™×:**
- âœ… `PromptCache.invalidate()` ×¤×•× ×§×¦×™×” ×§×™×™××ª
- âŒ `invalidate_business_cache()` ×œ× ×§×•×¨××ª ×œ×”
- âœ… TTL ×©×œ 10 ×“×§×•×ª ××ª××™× ×œ×ª×¡××™× ×™× ("××¤×™×œ×• ××—×¨×™ 10 ×“×§")

**×”×•×›×—×”:**
```python
# ×§×•×‘×¥: server/services/ai_service.py:255
def invalidate_business_cache(business_id: int):
    # × ×™×§×•×™ AIService._cache - ×§×™×™×
    service = get_ai_service()
    cache_keys_to_remove = [...]
    for key in cache_keys_to_remove:
        if key in service._cache:
            del service._cache[key]
    
    # âŒ ×—×¡×¨: × ×™×§×•×™ PromptCache!
    # ×¦×¨×™×š ×œ×”×•×¡×™×£:
    # from server.services.prompt_cache import get_prompt_cache
    # cache = get_prompt_cache()
    # cache.invalidate(business_id)
```

**×¤×ª×¨×•×Ÿ ××•××œ×¥:**
```python
def invalidate_business_cache(business_id: int):
    # 1. × ×§×” AIService cache (×§×™×™×)
    service = get_ai_service()
    # ...
    
    # 2. × ×§×” PromptCache (×—×¡×¨!)
    try:
        from server.services.prompt_cache import get_prompt_cache
        cache = get_prompt_cache()
        cache.invalidate(business_id)  # ×× ×§×” inbound ×•×’× outbound
        logger.info(f"âœ… PromptCache invalidated: {business_id}")
    except Exception as e:
        logger.error(f"âŒ Failed to invalidate PromptCache: {e}")
```

---

### ğŸ¥ˆ #2: ×¢×¨×‘×•×‘ ×‘×™×Ÿ ×›×™×•×•× ×™× ×‘-cache key (×¡×‘×™×¨×•×ª: 30%)

**×ª×¡×¨×™×˜:**
1. ××©×ª××© ××¢×“×›×Ÿ ×¨×§ `outbound_ai_prompt`
2. `ai_prompt` (inbound) ×¨×™×§
3. ×©×™×—×” × ×›× ×¡×ª ×× ×¡×” ×œ×˜×¢×•×Ÿ `ai_prompt`
4. fallback ×œ×•×§×— `outbound_ai_prompt` ×‘××§×•×
5. PromptCache ×©×•××¨ ××ª ×–×” ×‘×ª×•×¨ "inbound" â†’ ×©×’×•×™!
6. ×›×œ ×”×©×™×—×•×ª ×”× ×›× ×¡×•×ª ×¢×›×©×™×• ××©×ª××©×•×ª ×‘×¤×¨×•××¤×˜ ×™×•×¦×

**×‘×“×™×§×”:**
- ×”×•×¡×£ ×œ×•×’ ×¢× direction ×‘×›×œ × ×§×•×“×ª cache
- ×—×¤×© ××–×”×¨×•×ª "PROMPT FALLBACK" ×‘×œ×•×’×™×
- ×•×“× ×©×”-cache key ×ª××™×“ ×ª×•×× ×œ×›×™×•×•×Ÿ ×”×××™×ª×™ ×©×œ ×”×©×™×—×”

---

### ğŸ¥‰ #3: stream_registry ××—×–×™×§ ×¤×¨×•××¤×˜ ×™×©×Ÿ (×¡×‘×™×¨×•×ª: 25%)

**×ª×¡×¨×™×˜:**
1. webhook ××§×‘×œ ×©×™×—×” â†’ ×‘×•× ×” ×¤×¨×•××¤×˜ â†’ ×©×•××¨ ×‘-`stream_registry`
2. ××©×ª××© ××¢×“×›×Ÿ ×¤×¨×•××¤×˜ ×‘-CRM
3. ×©×™×—×” ××ª×—×™×œ×” (×œ×¤× ×™ timeout ×©×œ webhook) â†’ ××©×ª××© ×‘×¤×¨×•××¤×˜ ×™×©×Ÿ ××”-registry

**×‘×“×™×§×”:**
```python
# ×§×•×‘×¥: media_ws_ai.py:3554
pre_computed = stream_registry.get_prompt_for_call(self.call_sid)
if pre_computed:
    # ××©×ª××© ×‘×¤×¨×•××¤×˜ ××•×›×Ÿ ××¨××© ××”-webhook
    greeting_prompt = pre_computed
else:
    # ×‘×•× ×” ×¤×¨×•××¤×˜ ×˜×¨×™
    greeting_prompt = build_realtime_system_prompt(...)
```

- ×”×•×¡×£ ×œ×•×’ ×œ×¤× ×™ `if pre_computed:` ×¢× hash ×©×œ ×”×¤×¨×•××¤×˜
- ×”×©×•×•×” registry prompt hash ××•×œ fresh-built prompt hash
- ×× ×©×•× ×™× â†’ ×‘×¢×™×” ×‘-registry

---

### ğŸ… #4: ×©×™××•×© ×—×•×–×¨ ×‘-session ×‘×™×Ÿ ×©×™×—×•×ª (×¡×‘×™×¨×•×ª: 5%)

**×¡×‘×™×¨×•×ª × ××•×›×” ×›×™:**
- ×›×œ ×©×™×—×” ×™×•×¦×¨×ª OpenAI Realtime client ×—×“×©
- WebSocket × ×¡×’×¨ ××—×¨×™ ×›×œ ×©×™×—×”
- ×œ× ×–×•×”×” session pooling ××• reuse

**×‘×“×™×§×”:**
- ×—×¤×© ××¡×¤×¨ ××™×¨×•×¢×™ `session.created` ×¢× ××•×ª×• `session_id`
- ×¦×¨×™×š ×œ×¨××•×ª `session_id` ×™×™×—×•×“×™ ×œ×›×œ ×©×™×—×”

---

### ğŸ–ï¸ #5: ×“×œ×™×¤×ª tenant_id (×¡×‘×™×¨×•×ª: 5%)

**×‘×“×™×§×” ×¤×•×˜× ×¦×™××œ×™×ª:**
```python
# ×× business_id ×”×•× None:
cache_key = f"{None}:inbound"  # ×›×œ ×”×©×™×—×•×ª ×¢× None ×™×©×ª×¤×• ××ª ×–×”!
```

**×‘×“×™×§×”:**
- ×”×•×¡×£ ×œ×•×’ ×¢× ×¢×¨×š `business_id` ×‘×›×œ ×”×ª×—×‘×¨×•×ª WebSocket
- ×—×¤×© ×©×™×—×•×ª ×¢× `business_id=None` ××• `0`
- ×‘×“×•×§ ×œ×•×’×™× ×¢×‘×•×¨ cache_key="None:" ××• cache_key="0:"

---

## ğŸ“Š ×œ×•×’×™× ××•××œ×¦×™×

### ×§×‘×•×¦×” A: ××¢×§×‘ ××—×¨ prompt hash (×¢×“×™×¤×•×ª ×’×‘×•×”×”)

**× ×§×•×“×” 1: ×œ×¤× ×™ ×‘×“×™×§×ª cache**
```python
# ×§×•×‘×¥: realtime_prompt_builder.py:1260
logger.info(
    f"[PROMPT_LOAD] business_id={business_id}, direction={call_direction}, "
    f"use_cache={use_cache}, timestamp={datetime.now().isoformat()}"
)
```

**× ×§×•×“×” 2: cache hit**
```python
# ×§×•×‘×¥: prompt_cache.py:74
prompt_hash = hashlib.md5(entry.system_prompt.encode()).hexdigest()[:12]
cached_age_sec = time.time() - entry.cached_at
logger.info(
    f"[PROMPT_CACHE_HIT] business_id={business_id}, direction={direction}, "
    f"prompt_hash={prompt_hash}, cached_age_sec={cached_age_sec:.1f}, "
    f"prompt_len={len(entry.system_prompt)}"
)
```

**× ×§×•×“×” 3: ×§×¨×™××” ×DB (cache miss)**
```python
# ×§×•×‘×¥: realtime_prompt_builder.py:1488
prompt_hash = hashlib.md5(business_prompt.encode()).hexdigest()[:12]
settings_updated_at = settings.updated_at.isoformat() if settings else "unknown"
logger.info(
    f"[PROMPT_DB_READ] business_id={business_id}, direction=inbound, "
    f"prompt_hash={prompt_hash}, prompt_len={len(business_prompt)}, "
    f"db_updated_at={settings_updated_at}"
)
```

### ×§×‘×•×¦×” B: ××¢×§×‘ ××—×¨ session.update (×¢×“×™×¤×•×ª ×’×‘×•×”×”)

**× ×§×•×“×” 4: ×œ×¤× ×™ session.update**
```python
# ×§×•×‘×¥: media_ws_ai.py:3737
prompt_hash = hashlib.md5(greeting_prompt.encode()).hexdigest()[:12]
logger.info(
    f"[SESSION_UPDATE_SEND] call_sid={self.call_sid[:12]}, business_id={self.business_id}, "
    f"direction={self.call_direction}, prompt_hash={prompt_hash}, "
    f"instructions_len={len(greeting_prompt)}"
)
```

**× ×§×•×“×” 5: ××™×©×•×¨ session.updated**
```python
# ×§×•×‘×¥: media_ws_ai.py:5495
instructions_received = session_data.get("instructions", "")
received_hash = hashlib.md5(instructions_received.encode()).hexdigest()[:12]
expected_hash = self._business_prompt_hash
logger.info(
    f"[SESSION_UPDATED] call_sid={self.call_sid[:12]}, "
    f"received_hash={received_hash}, expected_hash={expected_hash}, "
    f"hash_match={received_hash == expected_hash}"
)
```

### ×§×‘×•×¦×” C: ××¢×§×‘ ××—×¨ invalidation (ğŸ”¥ ×§×¨×™×˜×™!)

**× ×§×•×“×” 6: ××—×¨×™ ×¢×“×›×•×Ÿ ×‘-API**
```python
# ×§×•×‘×¥: routes_ai_prompt.py:248
logger.info(
    f"[PROMPT_UPDATE_API] business_id={business_id}, "
    f"timestamp={datetime.utcnow().isoformat()}, "
    f"inbound_len={len(calls_prompt)}, outbound_len={len(outbound_calls_prompt)}"
)
```

**× ×§×•×“×” 7: × ×™×§×•×™ PromptCache (×—×¡×¨! ×¦×¨×™×š ×œ×”×•×¡×™×£)**
```python
# ×§×•×‘×¥: routes_ai_prompt.py:250 (××—×¨×™ invalidate_business_cache)
# ×”×•×¡×£ ×§×•×“ ×—×“×©:
try:
    from server.services.prompt_cache import get_prompt_cache
    cache = get_prompt_cache()
    cache.invalidate(business_id)
    logger.info(f"âœ… PromptCache invalidated: {business_id} (both directions)")
except Exception as e:
    logger.error(f"âŒ Failed to invalidate PromptCache: {e}")
```

---

## ğŸ§ª ×¡×§×¨×™×¤×˜×™× ×œ××™××•×ª

### ×¡×§×¨×™×¤×˜ 1: ×‘×“×™×§×ª ××¦×‘ cache

```bash
cd /home/runner/work/prosaasil/prosaasil
python3 << 'EOF'
import sys
sys.path.insert(0, '/home/runner/work/prosaasil/prosaasil')

from server.services.prompt_cache import get_prompt_cache
from server.services.ai_service import get_ai_service
import time, hashlib

business_id = 123  # ×”×—×œ×£ ×œ××¡×¤×¨ ×¢×¡×§ ×¨×œ×•×•× ×˜×™

print(f"\nğŸ” ×‘×•×“×§ caches ×¢×‘×•×¨ ×¢×¡×§ {business_id}")
print("=" * 60)

# 1. PromptCache
cache = get_prompt_cache()
for direction in ["inbound", "outbound"]:
    entry = cache.get(business_id, direction=direction)
    if entry:
        age = time.time() - entry.cached_at
        h = hashlib.md5(entry.system_prompt.encode()).hexdigest()[:12]
        print(f"\nğŸ“¦ PromptCache ({direction}):")
        print(f"  âœ… ×§×™×™×")
        print(f"  ×’×™×œ: {age:.1f}s (TTL: 600s)")
        print(f"  Hash: {h}")
        print(f"  ××•×¨×š: {len(entry.system_prompt)} ×ª×•×•×™×")
    else:
        print(f"\nğŸ“¦ PromptCache ({direction}): âŒ ×œ× ×‘-cache")

# 2. AIService Cache
service = get_ai_service()
for channel in ["calls", "whatsapp"]:
    key = f"business_{business_id}_{channel}"
    if key in service._cache:
        data, timestamp = service._cache[key]
        age = time.time() - timestamp
        print(f"\nğŸ“¦ AIService._cache ({channel}):")
        print(f"  âœ… ×§×™×™×")
        print(f"  ×’×™×œ: {age:.1f}s (TTL: 300s)")
    else:
        print(f"\nğŸ“¦ AIService._cache ({channel}): âŒ ×œ× ×‘-cache")
EOF
```

### ×¡×§×¨×™×¤×˜ 2: ×‘×“×™×§×ª invalidation

```bash
cd /home/runner/work/prosaasil/prosaasil
python3 << 'EOF'
import sys
sys.path.insert(0, '/home/runner/work/prosaasil/prosaasil')

from server.services.prompt_cache import get_prompt_cache
from server.services.ai_service import invalidate_business_cache

business_id = 123

print(f"\nğŸ§ª ×‘×•×“×§ invalidation ×¢×‘×•×¨ ×¢×¡×§ {business_id}")
print("=" * 60)

cache = get_prompt_cache()

print("\n1ï¸âƒ£ ××¦×‘ cache ×¨××©×•× ×™:")
for direction in ["inbound", "outbound"]:
    entry = cache.get(business_id, direction=direction)
    print(f"  {direction}: {'CACHED' if entry else 'EMPTY'}")

print("\n2ï¸âƒ£ ××¨×™×¥ invalidate_business_cache()...")
invalidate_business_cache(business_id)

print("\n3ï¸âƒ£ PromptCache ××—×¨×™ invalidation:")
for direction in ["inbound", "outbound"]:
    entry = cache.get(business_id, direction=direction)
    status = "CACHED" if entry else "CLEARED"
    result = "âŒ ×‘×¢×™×”!" if entry else "âœ… ×ª×§×™×Ÿ"
    print(f"  {direction}: {status} {result}")

if any(cache.get(business_id, d) for d in ["inbound", "outbound"]):
    print("\nâš ï¸ ×‘×¢×™×” ×–×•×”×ª×”: PromptCache ×œ× ×”×ª× ×§×”!")
    print("  â†’ ×–×• ×”×¡×™×‘×” ×©×¤×¨×•××¤×˜×™× ×œ× ××ª×¢×“×›× ×™×")
else:
    print("\nâœ… PromptCache ×”×ª× ×§×” ×›×¨××•×™")
EOF
```

---

## ğŸ“‹ ×¡×™×›×•× + ×”××œ×¦×•×ª

### âœ… ××” ××•×©×¨

1. **PromptCache ×œ× ××ª× ×§×”** - ×¨××ª ×‘×™×˜×—×•×Ÿ: 95%
   - ×—×•××¨×”: ×’×‘×•×”×”
   - ×”×©×¤×¢×”: ××©×ª××©×™× ×¨×•××™× ×¤×¨×•××¤×˜ ×™×©×Ÿ ×¢×“ 10 ×“×§×•×ª
   - ×¤×ª×¨×•×Ÿ: ×©×•×¨×” ××—×ª ×©×œ ×§×•×“ (×¨××” ×œ××¢×œ×”)

2. **×œ×•×’×™× ×—×¡×¨×™×** - ×¨××ª ×‘×™×˜×—×•×Ÿ: 100%
   - ×—×•××¨×”: ×‘×™× ×•× ×™×ª
   - ×”×©×¤×¢×”: ××™ ××¤×©×¨ ×œ××‘×—×Ÿ ×‘×¢×™×•×ª ×¤×¨×•××¤×˜ ×‘×–××Ÿ ×××ª
   - ×¤×ª×¨×•×Ÿ: 7 × ×§×•×“×•×ª ×œ×•×’ ×§×¨×™×˜×™×•×ª (×¨××” ×œ××¢×œ×”)

### âš ï¸ ××¤×©×¨×™

1. **×¢×¨×‘×•×‘ ×›×™×•×•× ×™×** - ×¨××ª ×‘×™×˜×—×•×Ÿ: 30%
   - ×“×•×¨×© ×‘×“×™×§×” × ×•×¡×¤×ª ×‘×œ×•×’×™×

2. **stream_registry ×™×©×Ÿ** - ×¨××ª ×‘×™×˜×—×•×Ÿ: 25%
   - ×“×•×¨×© ×‘×“×™×§×” × ×•×¡×¤×ª

### ×¢×“×™×¤×•×™×•×ª ×ª×™×§×•×Ÿ

**P0 (×§×¨×™×˜×™ - ×œ×ª×§×Ÿ ××™×“):**
```python
# ×§×•×‘×¥: server/services/ai_service.py:255
def invalidate_business_cache(business_id: int):
    # ... ×§×•×“ ×§×™×™× ×œ× ×™×§×•×™ AIService ...
    
    # ×”×•×¡×£ ××ª ×–×”:
    try:
        from server.services.prompt_cache import get_prompt_cache
        cache = get_prompt_cache()
        cache.invalidate(business_id)
        logger.info(f"âœ… PromptCache invalidated: {business_id}")
    except Exception as e:
        logger.error(f"âŒ Failed to invalidate PromptCache: {e}")
```

**P1 (×’×‘×•×” - ×”×•×¡×£ ×œ×•×’×™×):**
- × ×§×•×“×•×ª 1-5 ××§×‘×•×¦×•×ª A ×•-B
- ×××¤×©×¨ debugging ×©×œ ×‘×¢×™×•×ª ×¢×ª×™×“×™×•×ª

**P2 (×‘×™× ×•× ×™ - ×©×¤×¨ validation):**
- ×”×•×¡×£ ×‘×“×™×§×ª direction ×‘fallback chain
- ×”×–×”×¨ ×× ×¤×¨×•××¤×˜ ×›×™×•×•×Ÿ ×œ× × ×›×•×Ÿ × ×œ×§×—
- ×”×•×¡×£ ×‘×“×™×§×ª cache key (×“×—×” None/0)

---

## ğŸ“„ ××¡××›×™× × ×•×¡×¤×™×

**×“×•×— ××œ× ×‘×× ×’×œ×™×ª:** `PROMPT_INVESTIGATION_REPORT.md`
- 1100+ ×©×•×¨×•×ª
- flow maps ××¤×•×¨×˜×™×
- 10 × ×§×•×“×•×ª ×œ×•×’ ×¢× file:line ××“×•×™×§×™×
- 2 ×¡×§×¨×™×¤×˜×™ Python ×œ××™××•×ª

---

**×¡×•×£ ×”×¡×™×›×•×**

*×“×•×— ×–×” ××›×™×œ ×¨×§ ×××¦××™× ×•×”××œ×¦×•×ª - ×œ×œ× ×ª×™×§×•× ×™× ×‘×¤×•×¢×œ.*
