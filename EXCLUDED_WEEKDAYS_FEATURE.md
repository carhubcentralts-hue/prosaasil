# ימי הדרה והודעה לתזמון חוזר - Excluded Weekdays & Recurring Message

## 🎯 סקירה כללית

שיפורים לדף תזמון הודעות שמוסיפים שני פיצ'רים חסרים:
1. שדה הודעה לתזמון חוזר
2. אפשרות לבחור ימים שבהם לא תפעל האוטומציה

## ✨ יכולות חדשות

### 1. הודעה לתזמון חוזר (RECURRING_TIME)
- **בעבר**: לא היה שדה להזנת הודעה בתזמון חוזר
- **עכשיו**: שדה טקסט מלא להזנת תוכן ההודעה
- **תמיכה במשתנים**: `{lead_name}`, `{phone}`, `{business_name}`, `{status}`

### 2. ימי הדרה (Excluded Weekdays)
- **מטרה**: לאפשר לבחור ימים שבהם האוטומציה לא תפעל, גם אם החוק פעיל
- **חל על**: תזמון STATUS_CHANGE בלבד (לא RECURRING_TIME)
- **UI**: כפתורי ימים - לחיצה על יום הופכת אותו לאדום (מודר)
- **דוגמה**: אם בוחרים שישי ושבת כימי הדרה, לא יישלחו הודעות בימים אלו

## 📊 דוגמאות שימוש

### דוגמה 1: תזמון חוזר עם הודעה
```
- סוג תזמון: תזמון חוזר בימים ושעות ספציפיים
- ימים: ראשון, רביעי
- שעות: 10:00, 16:00
- סטטוסים: "ליד חם"
- הודעה: "שלום {lead_name}, רציתי לבדוק איך התקדמת עם ההחלטה?"
```

### דוגמה 2: תזמון לפי שינוי סטטוס עם ימי הדרה
```
- סוג תזמון: תזמון לפי שינוי סטטוס
- סטטוסים: "לקוח חדש"
- ימי הדרה: שישי, שבת
- הודעה מיידית: "ברוכים הבאים!"
- תוצאה: הודעת קבלת פנים תישלח רק בימים א'-ה', לא בסופי שבוע
```

## 🔧 שינויים טכניים

### Database (Migration 137)
```sql
ALTER TABLE scheduled_message_rules 
ADD COLUMN excluded_weekdays JSON NULL;
```

- `excluded_weekdays`: מערך של אינדקסים של ימים [0-6] (0=ראשון, 6=שבת) או null
- `null` = אין הדרות (כל הימים מותרים)
- דוגמה: `[5, 6]` = הדרת שישי ושבת

### Frontend Changes
1. **ScheduledMessagesPage.tsx**
   - הוספת שדה `recurring_message` לתזמון חוזר
   - הוספת UI לבחירת ימי הדרה (כפתורים)
   - ולידציה: חובה למלא הודעה בתזמון חוזר
   - העברת ימי הדרה ל-API רק עבור STATUS_CHANGE

2. **scheduledMessages.ts**
   - עדכון interfaces: `ScheduledRule`, `CreateRuleRequest`, `UpdateRuleRequest`
   - הוספת שדה `excluded_weekdays: number[] | null`

### Backend Changes
1. **models_sql.py**
   - הוספת עמודה `excluded_weekdays` ל-`ScheduledMessageRule`
   
2. **scheduled_messages_service.py**
   - עדכון `create_rule()` - תמיכה ב-`excluded_weekdays`
   - עדכון `update_rule()` - תמיכה ב-`excluded_weekdays`
   - הוספת פונקציה `is_excluded_weekday()` - בודק אם יום מודר
   - עדכון `create_scheduled_tasks_for_lead()` - בדיקת ימי הדרה לפני יצירת משימות

3. **routes_scheduled_messages.py**
   - עדכון API endpoints להעברת `excluded_weekdays`
   - הוספת השדה לתגובות JSON

### Logic Flow
1. כאשר ליד משנה סטטוס והחוק הוא STATUS_CHANGE:
   - בדיקה: האם היום הנוכחי בתוך `excluded_weekdays`?
   - אם כן - לא נוצרת משימה
   - אם לא - משימה נוצרת כרגיל

2. כאשר משימה מתוזמנת לעתיד:
   - בדיקה: האם התאריך המתוכנן בתוך `excluded_weekdays`?
   - אם כן - המשימה מדולגת
   - אם לא - המשימה נוצרת

## 🎨 UI/UX

### בוחר ימי הדרה
- **מיקום**: מתחת לבחירת סוג התזמון, רק ב-STATUS_CHANGE
- **עיצוב**: כפתורים של ימי השבוע
- **צבעים**:
  - לבן/אפור = יום מותר
  - אדום = יום מודר
- **טקסט עזר**: "ימים שבהם לא תפעל האוטומציה (אופציונלי)"

### שדה הודעה לתזמון חוזר
- **מיקום**: בתוך ההגדרות של תזמון חוזר
- **סוג**: textarea עם 4 שורות
- **חובה**: כן (*)
- **טקסט עזר**: "משתנים זמינים: {lead_name}, {phone}, {business_name}, {status}"

## 📝 פורמט ימים

**חשוב**: המערכת משתמשת בפורמט אמריקאי:
- 0 = ראשון (Sunday)
- 1 = שני (Monday)
- 2 = שלישי (Tuesday)
- 3 = רביעי (Wednesday)
- 4 = חמישי (Thursday)
- 5 = שישי (Friday)
- 6 = שבת (Saturday)

## 🔒 התנהגות

### תזמון חוזר (RECURRING_TIME)
- `active_weekdays` - ימים שבהם תישלח ההודעה
- `excluded_weekdays` - לא משמש (null)

### תזמון לפי שינוי סטטוס (STATUS_CHANGE)
- `active_weekdays` - לא משמש במקרה הרגיל (null)
- `excluded_weekdays` - ימים שבהם לא תישלח ההודעה

## 🧪 בדיקות

### Manual Testing Checklist
- [x] יצירת חוק חדש עם תזמון חוזר
- [x] מילוי שדה ההודעה בתזמון חוזר
- [x] שמירת החוק בהצלחה
- [x] יצירת חוק STATUS_CHANGE עם ימי הדרה
- [x] בחירת ימי הדרה (למשל שישי-שבת)
- [x] שמירה בהצלחה
- [ ] וידוא שהודעות לא נשלחות בימי הדרה
- [ ] וידוא שהודעות נשלחות בימים אחרים
- [ ] עריכת חוק קיים

## 🐛 תיקוני באגים

### באג: חסר שדה הודעה בתזמון חוזר
- **תיאור**: משתמש בוחר תזמון חוזר אבל אין שדה להזנת הודעה
- **פתרון**: הוספת שדה `recurring_message` ב-UI ושליחתו ל-`message_text` בשרת

### באג: לא ניתן לבחור ימי הדרה
- **תיאור**: האופציה לבחור ימים שבהם האוטומציה לא תפעל הוסרה
- **פתרון**: הוספת שדה `excluded_weekdays` והחזרת ה-UI

## 🚀 Deployment

1. Pull השינויים
2. Migration 137 תרוץ אוטומטית בעליית השרת
3. הפיצ'ר זמין לשימוש מיד!

## 📞 Support

בעיות או שאלות? פנה למפתח.
