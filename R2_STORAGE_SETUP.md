# Cloudflare R2 Storage Setup Guide

## Overview
The attachments system supports both local filesystem and Cloudflare R2 (S3-compatible) storage through a unified abstraction layer.

**Default**: Local filesystem storage  
**Optional**: Cloudflare R2 (requires configuration)

## Architecture

```
AttachmentService
    ↓
AttachmentStorageProvider (Abstract)
    ↓
├── LocalStorageProvider (default)
└── R2StorageProvider (optional)
```

## Switching to R2 Storage

### Prerequisites
1. Cloudflare account with R2 enabled
2. R2 bucket created
3. R2 API token with read/write permissions

### Configuration

Set these environment variables:

```bash
# Enable R2 storage
ATTACHMENT_STORAGE_DRIVER=r2

# R2 Configuration (NO hardcoded values in code)
R2_ACCOUNT_ID=your-cloudflare-account-id
R2_ACCESS_KEY_ID=your-r2-access-key-id
R2_SECRET_ACCESS_KEY=your-r2-secret-access-key
R2_BUCKET_NAME=your-bucket-name

# Optional: Customize TTL for signed URLs (default: 900 seconds = 15 minutes)
ATTACHMENT_SIGN_TTL_SECONDS=900
```

### Install boto3 (Required for R2)

```bash
pip install boto3
# or
poetry add boto3
```

### Restart Application

```bash
# The system will automatically use R2 on restart
python -m server.app
```

## How It Works

### Storage Key Format
Both local and R2 use the same storage key format for consistency:

```
attachments/{business_id}/{yyyy}/{mm}/{attachment_id}.ext
```

Example:
```
attachments/5/2026/01/123.jpg
```

### Local Storage
- Files stored in: `./storage/attachments/{storage_key}`
- Signed URLs: Internal endpoints with HMAC tokens
- Download: `/api/attachments/{id}/download?expires={ts}&sig={signature}`

### R2 Storage
- Files stored in: R2 bucket with key = `{storage_key}`
- Signed URLs: S3 presigned URLs (generated by AWS SDK)
- Download: Direct from Cloudflare R2 (e.g., `https://{account}.r2.cloudflarestorage.com/...`)

## Fallback Behavior

If R2 is selected but configuration is missing or invalid:

1. System logs **ERROR** message
2. Automatically falls back to **local storage**
3. Application continues to work (no crash)

Example log:
```
❌ R2 storage selected but missing environment variables: R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY
⚠️ Falling back to local storage
✅ Using local filesystem storage provider
```

## Security Features

### Multi-Tenant Isolation
- ✅ Storage keys include `business_id`
- ✅ API validates business ownership before access
- ✅ No cross-tenant data leakage

### Signed URLs
- ✅ All access through time-limited signed URLs
- ✅ No permanent public URLs
- ✅ TTL configurable (default: 15 minutes)

### No Hardcoded Secrets
- ✅ All credentials from environment variables
- ✅ No bucket names in code
- ✅ No account IDs in code

## Testing

### Test Local Storage (Default)
```bash
# No configuration needed
curl -X POST http://localhost:5000/api/attachments/upload \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.jpg" \
  -F "channel=email"
```

### Test R2 Storage
```bash
# Set environment variables first
export ATTACHMENT_STORAGE_DRIVER=r2
export R2_ACCOUNT_ID=...
export R2_ACCESS_KEY_ID=...
export R2_SECRET_ACCESS_KEY=...
export R2_BUCKET_NAME=...

# Restart server and test
curl -X POST http://localhost:5000/api/attachments/upload \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.jpg" \
  -F "channel=email"
```

### Verify Storage Provider
Check server logs on startup:
```
✅ Using R2 (Cloudflare) storage provider
[R2_STORAGE] Initialized with bucket: your-bucket-name
```

or

```
✅ Using local filesystem storage provider
[LOCAL_STORAGE] Initialized with root: ./storage/attachments
```

## Migration from Local to R2

### Option 1: Fresh Start (Recommended)
1. Set R2 environment variables
2. Restart server
3. New uploads go to R2
4. Old files remain on local storage (accessible via DB records)

### Option 2: Migrate Existing Files
```python
# Migration script (create as needed)
from server.services.storage import get_attachment_storage
from server.models_sql import Attachment

# Get all attachments
attachments = Attachment.query.all()

for att in attachments:
    if att.storage_provider == 'local':
        # Read from local
        local_path = f"./storage/attachments/{att.storage_key}"
        with open(local_path, 'rb') as f:
            file_data = f.read()
        
        # Upload to R2
        r2_storage = get_attachment_storage()
        # ... upload logic
        
        # Update DB
        att.storage_provider = 'r2'
        db.session.commit()
```

## Troubleshooting

### "R2 provider not available"
- **Cause**: boto3 not installed
- **Fix**: `pip install boto3`

### "Missing required environment variables"
- **Cause**: R2 config incomplete
- **Fix**: Set all 4 required R2 env vars

### "Cannot access R2 bucket"
- **Cause**: Invalid credentials or bucket doesn't exist
- **Fix**: 
  1. Verify bucket name in Cloudflare dashboard
  2. Verify API token has correct permissions
  3. Check account ID matches

### Files not downloading
- **Local**: Check ATTACHMENT_SECRET is set
- **R2**: Check presigned URL expiration (default: 15min)

## Cost Considerations

### Cloudflare R2 Pricing (as of 2024)
- Storage: $0.015/GB/month
- Class A operations (writes): $4.50/million
- Class B operations (reads): $0.36/million
- **Egress: FREE** (major advantage over S3)

### Recommendation
- **Small deployments**: Local storage (free, simple)
- **Medium-Large**: R2 (scalable, no egress fees)
- **Multi-region**: R2 (globally distributed)

## Production Checklist

Before deploying to production:

- [ ] R2 bucket created in Cloudflare
- [ ] API tokens generated with minimal permissions
- [ ] All 4 R2 environment variables set
- [ ] boto3 installed in production environment
- [ ] ATTACHMENT_SECRET changed from default
- [ ] Backup strategy for R2 bucket configured
- [ ] Monitoring/alerts setup for storage failures
- [ ] Test upload/download in production environment

## Environment Variables Summary

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `ATTACHMENT_STORAGE_DRIVER` | No | `local` | Storage type: `local` or `r2` |
| `R2_ACCOUNT_ID` | If R2 | - | Cloudflare account ID |
| `R2_ACCESS_KEY_ID` | If R2 | - | R2 API access key |
| `R2_SECRET_ACCESS_KEY` | If R2 | - | R2 API secret key |
| `R2_BUCKET_NAME` | If R2 | - | R2 bucket name |
| `ATTACHMENT_SECRET` | Yes | `change-me-in-production` | HMAC secret for local storage signatures |
| `ATTACHMENT_SIGN_TTL_SECONDS` | No | `900` | Signed URL TTL (seconds) |

## Support

For issues or questions:
1. Check logs for ERROR messages
2. Verify all environment variables are set correctly
3. Test with local storage first to isolate R2-specific issues
4. Review Cloudflare R2 documentation for bucket/permission setup
