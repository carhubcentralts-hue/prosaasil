# תיעוד: שינוי סטטוס חכם לשיחות ללא סיכום

## סקירה כללית

המערכת משתמשת כעת בלוגיקה חכמה לשינוי סטטוס לידים גם כאשר אין סיכום שיחה זמין. זה מאפשר לזהות מצבים שונים על בסיס משך השיחה וההיסטוריה של הליד.

## מצבים נתמכים

### 1. שיחות קצרות (פחות מ-5 שניות) - אין מענה

כאשר שיחה נמשכת פחות מ-5 שניות **ללא סיכום שיחה**, המערכת מזהה זאת כ"אין מענה".

**הפרוגרסיה החכמה:**
- **ניסיון ראשון**: הליד עובר לסטטוס "אין מענה" או "אין מענה 1" (לפי מה שקיים במערכת)
- **ניסיון שני**: הליד עובר לסטטוס "אין מענה 2" (אם קיים)
- **ניסיון שלישי**: הליד עובר לסטטוס "אין מענה 3" (אם קיים)

**דוגמאות לשמות סטטוסים נתמכים:**
- `no_answer`, `no_answer_1`, `no_answer_2`, `no_answer_3`
- `אין מענה`, `אין מענה 2`, `אין מענה 3`
- `לא ענה`, `לא ענה 2`, `לא ענה 3`

**לוגיקת Fallback:**
- אם יש רק סטטוס "אין מענה" אחד, המערכת תשתמש בו לכל הניסיונות
- אם יש "אין מענה" ו"אין מענה 2" בלבד, הניסיון השלישי יעבור ל"אין מענה 2"
- המערכת אינטליגנטית ומתאימה את עצמה לסטטוסים הקיימים בעסק

### 2. שיחות בינוניות (20-30 שניות) - ניתוק פתאומי

כאשר שיחה נמשכת 20-30 שניות **ללא סיכום שיחה**, המערכת מזהה זאת כסטטוס של "נענה אך ניתק" או דומה.

**סדר עדיפויות לזיהוי סטטוס:**
1. **עדיפות ראשונה**: סטטוסים עם "נענה" ו"ניתק" (למשל: `answered_but_disconnected`, `נענה_אך_ניתק`)
2. **עדיפות שנייה**: סטטוסים עם "נוצר קשר" (למשל: `contacted`, `נוצר קשר`)
3. **עדיפות שלישית**: סטטוסים עם "ניסיון קשר" (למשל: `attempting`, `ניסיון קשר`)

**דוגמאות לשמות סטטוסים נתמכים:**
- `answered_but_disconnected`, `answered_disconnected`
- `נענה אך ניתק`, `נענה וניתק`
- `contacted`, `נוצר קשר`
- `attempting`, `ניסיון קשר`

### 3. שיחות עם סיכום - הלוגיקה הקיימת

כאשר **קיים סיכום שיחה**, המערכת ממשיכה לפעול כרגיל:
- שימוש ב-AI (GPT-4) לניתוח הסיכום
- התאמה מבוססת מילות מפתח (keywords)
- זיהוי כוונות הלקוח (מעוניין, לא מעוניין, נקבעה פגישה, וכו')

## איך זה עובד?

### תהליך קבלת ההחלטה

```
┌─────────────────────────────────────┐
│ שיחה מסתיימת                        │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│ יש סיכום/תמלול?                    │
└──┬───────────────────────┬──────────┘
   │ כן                    │ לא
   │                       │
   ▼                       ▼
┌──────────┐      ┌────────────────────┐
│ לוגיקה  │      │ בדוק משך שיחה      │
│ רגילה   │      └─┬──────────────────┘
│ (AI/    │        │
│ Keywords)│        ▼
└──────────┘   ┌───────────────────────┐
               │ < 5 שניות?           │
               └─┬─────────────────┬───┘
                 │ כן              │ לא
                 │                 │
                 ▼                 ▼
           ┌──────────┐      ┌──────────┐
           │ אין מענה │      │ 20-30    │
           │ + ספירת │      │ שניות?   │
           │ ניסיונות│      └─┬────┬───┘
           └──────────┘        │ כן │ לא
                               │    │
                               ▼    ▼
                          ┌────────┐ ┌─────┐
                          │ ניתוק  │ │ אין │
                          │ פתאומי │ │תוצאה│
                          └────────┘ └─────┘
```

### קוד לדוגמה

```python
from server.services.lead_auto_status_service import suggest_lead_status_from_call

# דוגמה: שיחה קצרה ללא סיכום
suggested_status = suggest_lead_status_from_call(
    tenant_id=1,
    lead_id=123,
    call_direction='outbound',
    call_summary=None,  # אין סיכום
    call_transcript=None,  # אין תמלול
    call_duration=3  # 3 שניות - קצר מאוד
)
# תוצאה: 'no_answer' או 'no_answer_2' (לפי ניסיון)

# דוגמה: שיחה בינונית ללא סיכום
suggested_status = suggest_lead_status_from_call(
    tenant_id=1,
    lead_id=123,
    call_direction='outbound',
    call_summary=None,  # אין סיכום
    call_transcript=None,  # אין תמלול
    call_duration=26  # 26 שניות - בטווח הבינוני
)
# תוצאה: 'contacted' או 'answered_but_disconnected' (לפי סטטוסים זמינים)
```

## הגדרת סטטוסים במערכת

### איך להוסיף סטטוסי "אין מענה" מדורגים

1. היכנס לניהול סטטוסים במערכת
2. צור את הסטטוסים הבאים:
   - **אין מענה** (name: `no_answer`)
   - **אין מענה 2** (name: `no_answer_2`)
   - **אין מענה 3** (name: `no_answer_3`)

### איך להוסיף סטטוס "נענה אך ניתק"

1. היכנס לניהול סטטוסים במערכת
2. צור סטטוס חדש:
   - **תווית**: נענה אך ניתק
   - **שם פנימי**: `answered_but_disconnected` או `נענה_אך_ניתק`

## פרטים טכניים

### קבצים שונו

1. **`server/services/lead_auto_status_service.py`**
   - הוספת פרמטר `call_duration` למתודה `suggest_status()`
   - לוגיקה חדשה לטיפול בשיחות ללא סיכום
   - מתודה חדשה: `_handle_no_answer_with_progression()`
   - מתודה חדשה: `_handle_mid_length_disconnect()`

2. **`server/tasks_recording.py`**
   - העברת `call_duration` לשירות הסטטוס האוטומטי

### שאילתות מסד נתונים

המערכת מבצעת את השאילתות הבאות:
- שליפת 10 השיחות האחרונות של הליד
- בדיקת סטטוס נוכחי של הליד
- ספירת ניסיונות "אין מענה" קודמים

## בדיקות (Testing)

### הרצת בדיקות

```bash
# בדיקות לוגיקה קיימת (אין רגרסיה)
python test_auto_status_logic.py

# בדיקות ללוגיקה החדשה
python test_smart_status_no_summary.py
```

### תרחישי בדיקה מומלצים

1. **שיחה קצרה (2 שניות)** → אמור לעבור ל"אין מענה"
2. **3 שיחות קצרות ברצף** → אמור להתקדם: אין מענה → אין מענה 2 → אין מענה 3
3. **שיחה של 25 שניות ללא סיכום** → אמור לעבור ל"נוצר קשר" או דומה
4. **שיחה עם סיכום** → אמור להמשיך לעבוד כרגיל (AI/Keywords)

## Troubleshooting

### הסטטוס לא משתנה

1. בדוק שקיים סטטוס "אין מענה" במערכת
2. בדוק את הלוגים: `[AutoStatus]`
3. וודא ש`call_duration` מועבר כראוי

### הפרוגרסיה לא עובדת (תמיד נשאר "אין מענה")

1. בדוק שקיימים סטטוסים `no_answer_2` ו-`no_answer_3`
2. וודא שהסטטוס הנוכחי של הליד מכיל "אין מענה"
3. בדוק את הלוגים לפרטים על הניסיון הנוכחי

### שיחות של 25 שניות לא מזוהות

1. בדוק שקיים סטטוס "נוצר קשר" או "ניסיון קשר"
2. וודא שאין סיכום/תמלול בשיחה
3. בדוק את הלוגים: `[AutoStatus] Mid-length disconnect`

## שיפורים עתידיים אפשריים

- הוספת תמיכה בטווחי זמן נוספים
- למידה אוטומטית של סטטוסים לפי התנהגות
- התאמה אישית של סף הזמנים לכל עסק
- דוחות מפורטים על הצלחת הזיהוי

## סיכום

הלוגיקה החכמה מאפשרת למערכת לטפל בצורה אוטומטית ואינטליגנטית בשיחות שלא יצרו סיכום, תוך שמירה על התנהגות קיימת לשיחות עם סיכום. המערכת מתאימה את עצמה לסטטוסים הזמינים בכל עסק ומספקת fallback חכם במקרים שונים.
