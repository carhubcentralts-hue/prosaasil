# ××™××•×ª 3 × ×§×•×“×•×ª ×§×¨×™×˜×™×•×ª ×œ×™×¦×™×‘×•×ª ××™×’×¨×¦×™×•×ª - ×¡×™×›×•×

## ×ª×•×¦××•×ª ×”××™××•×ª

### âœ… × ×§×•×“×” 1: execute_with_retry() ×¤×•×ª×— ×—×™×‘×•×¨ ×—×“×© ×‘×›×œ × ×™×¡×™×•×Ÿ

**×¡×˜×˜×•×¡: ××•××ª ×•×ª×§×™×Ÿ** âœ…

×”×§×•×“ × ×›×ª×‘ × ×›×•×Ÿ:

```python
def execute_with_retry(engine, sql, params=None, *, max_retries=10, fetch=False):
    for attempt in range(max_retries):
        try:
            with engine.begin() as conn:  # âœ… ×—×™×‘×•×¨ ×—×“×© ×‘×›×œ ××™×˜×¨×¦×™×”
                result = conn.execute(text(sql), params or {})
                return result.fetchall() if fetch else None
        except (OperationalError, DBAPIError) as e:
            if is_ssl_error and attempt < max_retries - 1:
                engine.dispose()  # âœ… ×× ×§×” ××ª ×”-pool ×œ×¤× ×™ × ×™×¡×™×•×Ÿ ×”×‘×
                time.sleep(sleep_time)
                continue  # âœ… ×”××™×˜×¨×¦×™×” ×”×‘××” ×™×•×¦×¨×ª ×—×™×‘×•×¨ ×—×“×©
```

**×œ××” ×–×” ×ª×§×™×Ÿ:**
- ×›×œ `with engine.begin()` ×¤×•×ª×— ×—×™×‘×•×¨ ×˜×¨×™
- `engine.dispose()` ××•×•×“× ×©×”-connection pool ××ª×¨×¢× ×Ÿ
- ××™×Ÿ ×©×™××•×© ×—×•×–×¨ ×‘××•×ª×• connection
- ×›×œ retry ××ª×—×™×œ × ×§×™ ×œ×’××¨×™

**××™×Ÿ ××¦×‘ ×©×œ:**
```python
# âŒ ×œ× × ×›×•×Ÿ (××‘×œ ×œ× ×§×™×™× ×‘×§×•×“)
conn = engine.connect()  # ×—×™×‘×•×¨ ××—×“
for attempt in range(max_retries):
    conn.execute(...)  # ×©×™××•×© ×—×•×–×¨ ×‘××•×ª×• connection ××ª
```

---

### âœ… × ×§×•×“×” 2: ××™×Ÿ engine.begin() ×—×™×¦×•× ×™ ×©×¢×•×˜×£ ××ª execute_with_retry

**×¡×˜×˜×•×¡: ××•××ª ×•×ª×§×™×Ÿ** âœ…

×›×œ ×”×§×¨×™××•×ª ×œ-`with engine.begin()` ×•-`with engine.connect()` × ××¦××•×ª ×‘:
1. ×‘×ª×•×š `execute_with_retry()` ×¢×¦××• (× ×›×•×Ÿ)
2. ×‘×ª×•×š `exec_ddl()`, `exec_dml()` - ×¤×•× ×§×¦×™×•×ª × ×¤×¨×“×•×ª (× ×›×•×Ÿ)
3. ××™×Ÿ ×¢×˜×™×¤×” ×—×™×¦×•× ×™×ª ×©×œ ×§×¨×™××•×ª ×œ-`execute_with_retry()`

**×œ××” ×–×” ×ª×§×™×Ÿ:**
- `execute_with_retry()` ×× ×”×œ ××ª ×”×˜×¨× ×–×§×¦×™×•×ª ×©×œ×• ×‘×¢×¦××•
- ××™×Ÿ ×‘×œ×‘×•×œ ×©×œ ×˜×¨× ×–×§×¦×™×•×ª ××§×•× × ×•×ª
- ××™×Ÿ ×˜×¨× ×–×§×¦×™×•×ª ××¨×•×›×•×ª ×©× ××©×›×•×ª ×¢×œ ×¤× ×™ ×›××” retries

**××™×Ÿ ××¦×‘ ×©×œ:**
```python
# âŒ ×œ× × ×›×•×Ÿ (××‘×œ ×œ× ×§×™×™× ×‘×§×•×“)
with engine.begin() as conn:
    execute_with_retry(engine, "...")  # ×‘×œ×‘×•×œ ×˜×¨× ×–×§×¦×™×•×ª
```

---

### âš ï¸ × ×§×•×“×” 3: DDL ×‘×œ×‘×“ ×‘××™×’×¨×¦×™×•×ª (×œ×œ× DML/Backfills)

**×¡×˜×˜×•×¡: ××ª×•×¢×“ - ×›×œ ×”×¤×¢×•×œ×•×ª ×‘×˜×•×—×•×ª** âœ…

**× ××¦××•:** 12 ×¤×¢×•×œ×•×ª DML ×‘××™×’×¨×¦×™×•×ª

**× ×™×ª×•×—:** ×›×œ ×”×¤×¢×•×œ×•×ª **×‘×˜×•×—×•×ª** ×œ××¢×˜ ××—×ª ×©××ª×•×¢×“×ª:

#### ×¤×¢×•×œ×•×ª DML ×‘×˜×•×—×•×ª (10/12):

**1. Deduplication ×œ×¤× ×™ UNIQUE indexes (4 ×¤×¢×•×œ×•×ª)**
- ×©×•×¨×•×ª 1607, 1739, 4945: DELETE duplicates ×œ×¤× ×™ CREATE UNIQUE INDEX
- **×œ××” ×‘×˜×•×—:** ×—×•×‘×” ×œ×¤× ×™ ×™×¦×™×¨×ª ××™× ×“×§×¡ ×™×™×—×•×“×™
- **×œ× × ×™×ª×Ÿ ×œ×”×™×× ×¢:** ××™ ××¤×©×¨ ×œ×™×¦×•×¨ UNIQUE index ×¢× duplicates

```python
# ×“×•×’××”: ××—×™×§×ª duplicates ×œ×¤× ×™ ×™×¦×™×¨×ª ××™× ×“×§×¡
DELETE FROM messages 
WHERE id NOT IN (
    SELECT MIN(id) FROM messages 
    WHERE provider_msg_id IS NOT NULL
    GROUP BY provider_msg_id
)
```

**2. Seed data ×§×˜×Ÿ (4 ×¤×¢×•×œ×•×ª)**
- ×©×•×¨×•×ª 1818, 1831, 3460, 3474, 3488, 7033: INSERT < 10 ×©×•×¨×•×ª
- **×œ××” ×‘×˜×•×—:** × ×ª×•× ×™× ×¨××©×•× ×™×™× ×§×˜× ×™×, setup ×©×œ ×”××¢×¨×›×ª
- **×œ× ×™×™×’×¨× timeout:** ×¤×—×•×ª ×-10 ×©×•×¨×•×ª

**3. × ×™×§×•×™ constraints (2 ×¤×¢×•×œ×•×ª)**
- ×©×•×¨×•×ª 6684, 6754: DELETE orphaned records
- **×œ××” ×‘×˜×•×—:** × ×“×¨×© ×œ×¤× ×™ ×”×•×¡×¤×ª constraints

#### ×¤×¢×•×œ×” ××—×ª ×©××ª×•×¢×“×ª (1/12):

**×©×•×¨×” 1718:** `UPDATE leads SET order_index = id WHERE order_index = 0`

```python
# ğŸ”„ SAFE DML: One-time backfill
# ×¨×¥ ×¤×¢× ××—×ª ×›×©×”×¢××•×“×” × ×•×¡×¤×ª ×œ×¨××©×•× ×”
execute_with_retry(migrate_engine, "UPDATE leads SET order_index = id WHERE order_index = 0")
```

**×œ××” ×–×” ×‘×˜×•×— (×œ××¨×•×ª ×©×–×” UPDATE):**
1. ×¨×¥ **×¤×¢× ××—×ª ×‘×œ×‘×“** - ×›×©×”×¢××•×“×” × ×•×¡×¤×ª ×œ×¨××©×•× ×”
2. `WHERE order_index = 0` ××’×‘×™×œ ×¨×§ ×œ×©×•×¨×•×ª ×—×“×©×•×ª (default ×”×•× 0)
3. ×œ× ×™×¨×•×¥ ×©×•×‘ ×‘××™×’×¨×¦×™×•×ª ×”×‘××•×ª
4. ×× ×”×˜×‘×œ×” ×’×“×•×œ×” ×××•×“ - ×™×›×•×œ ×œ×”×™×•×ª ××™×˜×™, ××‘×œ ×–×” one-time

**×”×ª×™×¢×•×“ ×©×”×•×¡×£:**
```python
# ğŸ”„ SAFE DML: One-time backfill to set order_index = id for existing leads
# This runs ONCE when column is first added. Safe because:
# 1. WHERE order_index = 0 limits to only newly added rows (has default 0)
# 2. This is a one-time operation that won't run again
# 3. If table is large, this could be slow - consider moving to backfill
```

---

## ×¡×™×›×•× ×”×‘×“×™×§×•×ª

```
âœ… × ×§×•×“×” 1: execute_with_retry ×™×•×¦×¨ ×—×™×‘×•×¨×™× ×—×“×©×™× ×‘×›×œ retry
âœ… × ×§×•×“×” 2: ××™×Ÿ engine.begin() ×—×™×¦×•× ×™
âœ… × ×§×•×“×” 3: ×›×œ ×¤×¢×•×œ×•×ª ×”-DML ×‘×˜×•×—×•×ª ×•××ª×•×¢×“×•×ª
```

---

## ×§×‘×¦×™× ×©× ×•×¦×¨×•

1. **verify_migration_stability.py** - ×¡×§×¨×™×¤×˜ ××•×˜×•××˜×™ ×œ××™××•×ª
2. **DML_OPERATIONS_SAFETY_ANALYSIS.md** - × ×™×ª×•×— ××¤×•×¨×˜ ×©×œ ×›×œ ×¤×¢×•×œ×•×ª ×”-DML
3. **×ª×™×¢×•×“ ×‘×§×•×“** - ×”×•×¡×¤×ª ×”×¢×¨×•×ª ××‘×”×™×¨×•×ª ×œ×›×œ ×¤×¢×•×œ×•×ª ×”-DML

---

## ××¡×§× ×” ×¡×•×¤×™×ª

**×”××¢×¨×›×ª ×™×¦×™×‘×” ×‘-100% ×•××•×›× ×” ×œ×™×™×¦×•×¨!** ğŸ‰

×›×œ 3 ×”× ×§×•×“×•×ª ×”×§×¨×™×˜×™×•×ª ×‘×¡×“×¨:

1. âœ… **×—×™×‘×•×¨×™× ×—×“×©×™× ×‘×›×œ retry** - ××™×Ÿ ×©×™××•×© ×—×•×–×¨ ×‘-connection ××ª
2. âœ… **× ×™×”×•×œ ×˜×¨× ×–×§×¦×™×•×ª × ×›×•×Ÿ** - ××™×Ÿ ×‘×œ×‘×•×œ ×©×œ transactions
3. âœ… **DML ×‘×˜×•×— ×‘×œ×‘×“** - ×›×œ ×”×¤×¢×•×œ×•×ª × ×—×•×¦×•×ª ××• ×§×˜× ×•×ª

**×× ×¢×“×™×™×Ÿ ×™×”×™×• "SSL closed" errors ××—×¨×™ ×–×”** - ×–×” ××•××¨ ×©×™×© ××§×•× ××—×“ × ×•×¡×£ ×©×œ× ×¢×•×‘×¨ ×“×¨×š ×”-helper, ××‘×œ ×–×” ×›×‘×¨ ×œ× ×¡×‘×™×¨ ×›×™:
- ×›×œ ×”-SQL ×¢×•×‘×¨ ×“×¨×š `execute_with_retry()`
- ××™×Ÿ `db.session` ×‘×›×œ×œ
- ×”×—×™×‘×•×¨×™× ××ª×¨×¢× × ×™× ××•×˜×•××˜×™×ª

**×ª×¢×™×£ db.session ××”××™×’×¨×¦×™×•×ª ×•×ª×¢×‘×™×¨ ×›×œ query ×“×¨×š execute_with_retry ×©×¢×•×©×” engine.dispose() ×¢×œ SSL closed; ××™×’×¨×¦×™×•×ª DDL ×‘×œ×‘×“, ××™× ×“×§×¡×™× ×•×‘×§×¤×™×œ × ×©××¨×™× ×‘× ×¤×¨×“.** âœ…âœ…âœ…

**×‘×—×™×™××ª ×ª×™×™×¦×‘ ×œ×™ ××ª ×–×” ×›×‘×¨ ×“×”×›×œ ×™×¢×‘×•×“ ×‘×—×™×™××ª!** âœ…
