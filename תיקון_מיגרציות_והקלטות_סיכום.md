# תיקון Loop של הקלטות ובעיות Lock במיגרציות - סיכום

## 🔥 הבעיות שתוקנו

### בעיה 1: מיגרציות נתקעות על Lock
**תסמינים:**
- `pg_advisory_lock` חוסם לנצח ונכשל עם `statement_timeout`
- מספר קונטיינרים מנסים להריץ מיגרציות במקביל
- המערכת קורסת כשהמיגרציות נכשלות

### בעיה 2: Loop בהקלטות
**תסמינים:**
- הקלטות נכנסות לתור (`ENQUEUE`) אבל לא נצרכות
- אין לוגים מה־Worker
- לא ברור איזה קונטיינר צריך להריץ מיגרציות

---

## ✅ הפתרון

### A) תיקון לוגיקת Lock (server/db_migrate.py)

**שינויים:**
1. החלפת `pg_advisory_lock` החוסם ב-`pg_try_advisory_lock` עם retry loop
2. הגדרת `statement_timeout=120s` באופן מקומי לחיבור המיגרציה
3. הוספת משתנה סביבה `MIGRATION_LOCK_WAIT_SECONDS` (ברירת מחדל: 30 שניות)
4. החזרת `'skip'` במקום קריסה כשלא מצליחים לקבל Lock
5. שימוש ב-parameterized queries לשחרור ה-Lock

**קוד לדוגמה:**
```python
LOCK_ID = 1234567890
LOCK_WAIT_SECONDS = int(os.getenv("MIGRATION_LOCK_WAIT_SECONDS", "30"))
STATEMENT_TIMEOUT = os.getenv("MIGRATION_STATEMENT_TIMEOUT", "120s")

conn.execute(text(f"SET LOCAL statement_timeout = '{STATEMENT_TIMEOUT}'"))

start_time = time.time()
while time.time() - start_time < LOCK_WAIT_SECONDS:
    result = conn.execute(text("SELECT pg_try_advisory_lock(:id)"), {"id": LOCK_ID})
    lock_acquired = result.scalar()
    if lock_acquired:
        break
    time.sleep(1)

if not lock_acquired:
    return 'skip'  # אל תקרוס - דלג על המיגרציות
```

---

### B) בקרת הרצת מיגרציות (server/app_factory.py + docker-compose)

**משתנה סביבה חדש: `RUN_MIGRATIONS`**
- `RUN_MIGRATIONS=1` - הקונטיינר יריץ מיגרציות
- `RUN_MIGRATIONS=0` - הקונטיינר ידלג על מיגרציות (ברירת מחדל)

**הגדרה ב-docker-compose.yml:**
```yaml
services:
  prosaas-api:
    environment:
      RUN_MIGRATIONS: "1"  # רק ה-API מריץ מיגרציות
  
  worker:
    environment:
      RUN_MIGRATIONS: "0"  # Worker לעולם לא מריץ מיגרציות
  
  prosaas-calls:
    environment:
      RUN_MIGRATIONS: "0"  # Calls לעולם לא מריץ מיגרציות
```

**טיפול ב-'skip' ב-app_factory.py:**
```python
migrations_result = apply_migrations()

if migrations_result == 'skip':
    logger.info("✅ MIGRATIONS SKIPPED: Lock timeout or disabled")
    logger.info("   This is safe - migrations will run in designated container")
    return  # אל תקרוס - המשך באופן רגיל
```

---

### C) שיפור לוגים של Worker (server/tasks_recording.py)

**לוגים חדשים מובנים:**

1. **WORKER_PICKED** - כשה-Worker מושך עבודה מהתור
   ```
   🎯 [WORKER_PICKED] job_type=download_only call_sid=CA123... business_id=42
   ```

2. **WORKER_SLOT_ACQUIRED** - כשה-Worker תופס Slot לעסק
   ```
   ✅ [WORKER_SLOT_ACQUIRED] call_sid=CA123... business_id=42
   ```

3. **WORKER_DOWNLOAD_DONE** - כשההורדה הסתיימה בהצלחה
   ```
   ✅ [WORKER_DOWNLOAD_DONE] call_sid=CA123... file=CA123.mp3 bytes=1234567
   ```

4. **WORKER_RELEASE_SLOT** - כשה-Slot משוחרר
   ```
   🔓 [WORKER_RELEASE_SLOT] call_sid=CA123... business_id=42 reason=success
   ```

5. **WORKER_JOB_FAILED** - כשהעבודה נכשלה
   ```
   ❌ [WORKER_JOB_FAILED] call_sid=CA123... reason=db_error type=OperationalError
   ```

**שיפורי אבטחה:**
- לא רושמים נתיבים מלאים (רק שמות קבצים)
- ניקוי הודעות שגיאה מה-DB (למנוע חשיפת מידע רגיש)
- הגבלת אורך הודעות שגיאה

---

## 🔧 משתני סביבה חדשים

### `RUN_MIGRATIONS`
- **ברירת מחדל:** `"0"`
- **ערכים:** `"1"` (הפעל) או `"0"` (דלג)
- **שימוש:** קובע איזה קונטיינר מריץ מיגרציות

### `MIGRATION_LOCK_WAIT_SECONDS`
- **ברירת מחדל:** `30` שניות
- **שימוש:** זמן המתנה מקסימלי ל-Lock לפני ויתור

### `MIGRATION_STATEMENT_TIMEOUT`
- **ברירת מחדל:** `"120s"`
- **פורמט:** PostgreSQL interval (`"120s"`, `"2min"`, וכו')
- **שימוש:** Timeout לפקודות SQL במהלך מיגרציות

---

## 📋 בדיקות

### בדיקה אוטומטית
נוצר סקריפט בדיקה מקיף: `test_migration_lock_timeout_fix.py`

**הרצה:**
```bash
python test_migration_lock_timeout_fix.py
```

**תוצאות:**
```
✅ PASS: db_migrate lock fix
✅ PASS: app_factory skip handling
✅ PASS: docker-compose RUN_MIGRATIONS
✅ PASS: worker logging
```

### סריקת אבטחה
הרצנו CodeQL - **0 פגיעויות אבטחה נמצאו** ✅

---

## 🎯 יתרונות התיקון

1. **אין קריסות** - המערכת לא קורסת כשיש Lock timeout
2. **בקרה ברורה** - רק קונטיינר אחד מריץ מיגרציות
3. **לוגים ברורים** - קל לזהות מה ה-Worker עושה
4. **אבטחה** - אין חשיפה של מידע רגיש בלוגים
5. **גמישות** - ניתן להגדיר Timeouts בהתאם לצורך

---

## 📊 התנהגות חדשה

### כאשר RUN_MIGRATIONS=1
1. הקונטיינר מנסה לקבל Lock עם `pg_try_advisory_lock`
2. אם מקבל Lock → מריץ מיגרציות
3. אם ה-Lock תפוס → מנסה שוב למשך `MIGRATION_LOCK_WAIT_SECONDS`
4. אם עדיין תפוס → **דולג על מיגרציות בלי לקרוס**

### כאשר RUN_MIGRATIONS=0
הקונטיינר מדלג על מיגרציות מיד ללא ניסיון לקבל Lock.

### דילוג חן (Graceful Skip)
- הקונטיינר ממשיך לעלות באופן רגיל
- הלוגים מציינים בבירור שהמיגרציות דולגו
- **המערכת לא קורסת** - זה בטוח כי מיגרציות ירוצו בקונטיינר אחר

---

## 🚀 פריסה

### שלב 1: עדכון קוד
הקוד כבר מעודכן ב-PR הזה.

### שלב 2: הגדרת משתני סביבה
ודא שב-`docker-compose.yml` ו-`docker-compose.prod.yml`:
- רק `prosaas-api` יש `RUN_MIGRATIONS: "1"`
- כל השאר יש `RUN_MIGRATIONS: "0"`

### שלב 3: פריסה
```bash
docker-compose down
docker-compose up -d
```

### שלב 4: בדיקת לוגים
חפש את הלוגים החדשים:
```bash
# לוגים של מיגרציות
docker-compose logs prosaas-api | grep MIGRATION

# לוגים של Worker
docker-compose logs worker | grep WORKER_
```

---

## 🔍 פתרון בעיות

### בעיה: הקונטיינר קורס עם "Migration failed"
**פתרון:** בדוק אם יש Lock timeout. הגדל את `MIGRATION_LOCK_WAIT_SECONDS` או ודא שרק קונטיינר אחד יש לו `RUN_MIGRATIONS=1`.

### בעיה: מיגרציות לא רצות בכלל
**פתרון:** ודא שלפחות קונטיינר אחד (בדרך כלל `prosaas-api`) יש `RUN_MIGRATIONS=1`.

### בעיה: אין לוגים מה-Worker
**פתרון:** ודא שה-Worker רץ עם `command: ["python", "-m", "server.worker"]` והוא מאזין לתור `recordings`.

### בעיה: הקלטות לא מתעבדות
**פתרון:** חפש את הלוגים `[WORKER_PICKED]` ו-`[WORKER_JOB_FAILED]`. אם אין כאלה, ייתכן שה-Worker לא רץ בכלל.

---

## 🛡️ אבטחה

כל השינויים שומרים על ערבויות האבטחה הקיימות:
- ✅ אין איבוד מידע - FAQs ו-Leads לעולם לא נמחקים
- ✅ Lock מונע מיגרציות מקבילות
- ✅ דילוג חן לא מקריס את המערכת
- ✅ רק קונטיינר אחד מריץ מיגרציות (מוגדר דרך RUN_MIGRATIONS)
- ✅ Timeout של Lock לא גורם לכשל כללי במערכת
- ✅ אין חשיפת מידע רגיש בלוגים

---

## 📝 תיעוד נוסף

ראה `MIGRATION_LOCK_FIX_ENV_VARS.md` לתיעוד מלא על משתני הסביבה החדשים.
