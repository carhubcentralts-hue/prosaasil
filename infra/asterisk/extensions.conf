;
; Asterisk Dialplan Configuration for ProSaaS AI Call Center
; Routes incoming/outgoing calls through Stasis (ARI) for AI processing
;

[general]
static=yes
writeprotect=no

;==================================
; INBOUND CALLS (from DID Provider)
;==================================
[from-trunk]
; All incoming calls from SIP trunk enter here

exten => _X.,1,NoOp(=== INCOMING CALL ===)
 same => n,Set(CALL_ID=${UNIQUEID})
 same => n,Set(__CALL_ID=${UNIQUEID})
 same => n,Set(__DIRECTION=inbound)
 same => n,Answer()
 
 ; Determine tenant_id from DID mapping
 ; For now, use first active business (can be enhanced with DID lookup)
 same => n,Set(__TENANT_ID=${TENANT_ID:-1})
 
 ; Start recording (MixMonitor captures entire call)
 ; Format: /var/spool/asterisk/recordings/{tenant_id}/{call_id}.wav
 same => n,Set(RECORDING_DIR=/var/spool/asterisk/recordings/${TENANT_ID})
 same => n,System(mkdir -p ${RECORDING_DIR})
 same => n,MixMonitor(${RECORDING_DIR}/${CALL_ID}.wav,b)
 
 ; Enter Stasis application (ARI takes control)
 ; ARI will create bridge and connect to Media Gateway
 same => n,Stasis(prosaas_ai,${TENANT_ID},inbound,${CALL_ID})
 
 ; If Stasis exits, hangup
 same => n,Hangup()

;==================================
; OUTBOUND CALLS (originated via ARI)
;==================================
[from-internal]
; Outbound calls originate here via ARI

exten => _X.,1,NoOp(=== OUTBOUND CALL ===)
 same => n,Set(CALL_ID=${UNIQUEID})
 same => n,Set(__CALL_ID=${UNIQUEID})
 same => n,Set(__DIRECTION=outbound)
 
 ; Recording already set via ARI channel variables
 ; MixMonitor started before dial
 
 ; Dial through SIP trunk (DIDWW)
 same => n,Dial(PJSIP/${EXTEN}@didww,60,Ttg)
 
 ; If dial fails, enter Stasis for cleanup
 same => n,Stasis(prosaas_ai,${TENANT_ID},outbound,${CALL_ID})
 same => n,Hangup()

;==================================
; FAILOVER / ERROR HANDLING
;==================================
[from-trunk-failed]
; Fallback for failed inbound calls

exten => failed,1,NoOp(Call failed: ${HANGUPCAUSE})
 same => n,Hangup()
