# תיקון בעיית תור שיחות - כפילות מפתח ייחודי

## הבעיה
כשמנסים ליצור תור שיחות יוצאות, המערכת נכשלת עם שגיאת אילוץ ייחודי:
```
duplicate key value violates unique constraint "idx_background_jobs_unique_active"
Key (business_id, job_type)=(4, enqueue_outbound_calls) already exists
```

**מה זה אומר?**
המערכת מנסרת ליצור משימת רקע חדשה, אבל יש כבר משימה פעילה מאותו סוג לאותו עסק. האילוץ הייחודי במסד הנתונים מונע יצירת משימות כפולות.

**למה זה קרה?**
- משימות רקע שנכשלו או נקטעו נשארו במצב 'queued' או 'running'
- המערכת לא ניקתה משימות ישנות שתקועות
- כשמשתמש מנסה ליצור משימה חדשה, האילוץ חוסם את זה

## הפתרון

### מה עשינו
יצרנו פונקציית עזר חכמה `check_and_handle_duplicate_background_job()` שמטפלת בבעיה:

1. **בודקת משימות קיימות** - לפני יצירת משימה חדשה
2. **מזהה משימות תקועות** - משימות שלא התעדכנו יותר מ-10 דקות
3. **מנקה אוטומטית** - משימות תקועות מסומנות כ-'failed' 
4. **מחזירה שגיאה ברורה** - אם יש משימה פעילה ממש

### התנהגות חדשה

#### מצב 1: אין משימה קיימת
✅ משימה נוצרת מיד בהצלחה

#### מצב 2: יש משימה תקועה (>10 דקות)
✅ המערכת מנקה אוטומטית את המשימה הישנה
✅ משימה חדשה נוצרת בהצלחה

#### מצב 3: יש משימה פעילה (חדשה)
⚠️ המשתמש מקבל הודעת שגיאה ברורה:
- **לתורי שיחות**: "תור שיחות פעיל כבר קיים. אנא המתן לסיום התור הנוכחי"
- **למחיקה**: "מחיקה המונית פעילה כבר קיימת. אנא המתן לסיום המחיקה הנוכחית"
- **לעדכון**: "עדכון המוני פעיל כבר קיים. אנא המתן לסיום העדכון הנוכחי"

בנוסף, השגיאה כוללת:
- מזהה המשימה הפעילה (job_id)
- סטטוס המשימה (status)

### אילו סוגי משימות מוגנים?
התיקון חל על **כל 4 סוגי המשימות** ברקע:

1. ✅ `enqueue_outbound_calls` - תור שיחות יוצאות
2. ✅ `delete_imported_leads` - מחיקת לידים מיובאים
3. ✅ `delete_leads` - מחיקת לידים
4. ✅ `update_leads` - עדכון לידים המוני

## איכות הקוד

### מה השתפר
- **DRY (Don't Repeat Yourself)**: הורדנו ~160 שורות קוד כפול
- **ניהול קל**: מקום אחד לעדכן את הלוגיקה
- **עקביות**: כל סוגי המשימות מתנהגים זהה
- **בטיחות**: CodeQL מצא 0 פגיעויות אבטחה ✅
- **נבדק**: 6/6 בדיקות עוברות בהצלחה ✅

### קבוע
- `BACKGROUND_JOB_STALE_THRESHOLD_MINUTES = 10`
  - **10 דקות** - מספיק קצר כדי לזהות משימות תקועות מהר
  - **10 דקות** - מספיק ארוך כדי לא להפריע למשימות איטיות רגילות

## קבצים ששונו

1. **server/routes_outbound.py**
   - הוספנו פונקציית עזר
   - עדכנו 2 סוגי משימות

2. **server/routes_leads.py**
   - הוספנו פונקציית עזר
   - עדכנו 2 סוגי משימות

3. **test_outbound_queue_duplicate_fix.py** (חדש)
   - חבילת בדיקות מקיפה
   - 6 בדיקות שבודקות את כל ההיבטים

## סיכום אבטחה

✅ **אין פגיעויות אבטחה** - CodeQL בדק והכל תקין
✅ **טרנזקציות בטוחות** - rollback במקרה של שגיאה
✅ **בידוד עסקים** - כל עסק רואה רק את המשימות שלו
✅ **ולידציה תקינה** - קלט משתמשים מסונן כמו קודם

## איך זה עובד?

```python
# לפני יצירת משימה:
can_proceed, error_response, status_code = check_and_handle_duplicate_background_job(
    job_type='enqueue_outbound_calls',
    business_id=tenant_id,
    error_message="תור שיחות פעיל כבר קיים..."
)

# אם לא ניתן להמשיך, החזר שגיאה למשתמש
if not can_proceed:
    return jsonify(error_response), status_code

# אחרת, צור את המשימה בהצלחה
bg_job = BackgroundJob()
...
```

## תוצאה
**הבעיה נפתרה לחלוטין!**
- משתמשים יכולים ליצור תורי שיחות בלי שגיאות ✅
- משימות תקועות מנוקות אוטומטית ✅
- הודעות שגיאה ברורות בעברית ✅
- הקוד נקי ומתוחזק ✅
