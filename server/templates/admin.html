{% extends "base.html" %}

{% block title %}דשבורד מנהל - מערכת CRM{% endblock %}

{% block content %}
<!-- Top Navigation -->
<nav class="bg-white shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <span class="text-2xl font-bold text-blue-600">🏢 מערכת CRM</span>
                </div>
                <div class="hidden md:ml-6 md:flex md:space-x-8">
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">מנהל מערכת</span>
                </div>
            </div>
            <div class="flex items-center">
                <span class="text-gray-700 ml-4">שלום, {{ user.name }}</span>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                    התנתק
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content with Sidebar -->
<div class="flex h-screen bg-gray-50">
    <!-- Sidebar Navigation -->
    <div class="w-64 bg-white shadow-lg">
        <div class="p-6">
            <nav class="space-y-2">
                <a href="#dashboard" onclick="showSection('dashboard')" class="nav-item active flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">📊</span>
                    <span class="mr-3 font-medium">דשבורד ראשי</span>
                </a>
                <a href="#calls" onclick="showSection('calls')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">📞</span>
                    <span class="mr-3 font-medium">ניהול שיחות</span>
                </a>
                <a href="#whatsapp" onclick="showSection('whatsapp')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">💬</span>
                    <span class="mr-3 font-medium">WhatsApp</span>
                </a>
                <a href="#crm" onclick="showSection('crm')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">👥</span>
                    <span class="mr-3 font-medium">CRM לקוחות</span>
                </a>
                <a href="#businesses" onclick="showSection('businesses')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">🏢</span>
                    <span class="mr-3 font-medium">ניהול עסקים</span>
                </a>
                <a href="#invoices" onclick="showSection('invoices')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">🧾</span>
                    <span class="mr-3 font-medium">חשבוניות</span>
                </a>
                <a href="#payments" onclick="showSection('payments')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">💳</span>
                    <span class="mr-3 font-medium">תשלומים</span>
                </a>
                <a href="#contracts" onclick="showSection('contracts')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">📋</span>
                    <span class="mr-3 font-medium">חוזים דיגיטליים</span>
                </a>
                <a href="#analytics" onclick="showSection('analytics')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">📈</span>
                    <span class="mr-3 font-medium">דוחות ואנליטיקה</span>
                </a>
                <a href="#settings" onclick="showSection('settings')" class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <span class="ml-3">⚙️</span>
                    <span class="mr-3 font-medium">הגדרות מערכת</span>
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-auto">

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section-content p-6">
    <!-- KPIs Section -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">סקירה כללית</h2>
        <div id="kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white overflow-hidden shadow-xl rounded-2xl">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">📞</span>
                            </div>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-500">שיחות היום</p>
                            <p class="text-2xl font-semibold text-gray-900" hx-get="/api/admin/kpis/calls" hx-trigger="load" hx-target="this">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow-xl rounded-2xl">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">📱</span>
                            </div>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-500">WhatsApp</p>
                            <p class="text-2xl font-semibold text-gray-900" hx-get="/api/admin/kpis/whatsapp" hx-trigger="load" hx-target="this">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow-xl rounded-2xl">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">👥</span>
                            </div>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-500">עסקים פעילים</p>
                            <p class="text-2xl font-semibold text-gray-900" hx-get="/api/admin/kpis/businesses" hx-trigger="load" hx-target="this">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow-xl rounded-2xl">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">💰</span>
                            </div>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-500">הכנסות חודש</p>
                            <p class="text-2xl font-semibold text-gray-900" hx-get="/api/admin/kpis/revenue" hx-trigger="load" hx-target="this">₪0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tenants Section -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-900">ניהול עסקים</h2>
            <button onclick="showAddBusinessModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                ➕ הוסף עסק חדש
            </button>
        </div>
        <div class="bg-white shadow-xl rounded-2xl overflow-hidden">
            <div id="tenants" hx-get="/api/admin/tenants" hx-trigger="load" class="p-6">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calls Section -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">שיחות אחרונות</h2>
        <div class="bg-white shadow-xl rounded-2xl overflow-hidden">
            <div id="calls" hx-get="/api/admin/calls" hx-trigger="load" class="p-6">
                <div class="animate-pulse space-y-4">
                    <div class="h-4 bg-gray-200 rounded w-full"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        </div>
        </div>

        <!-- Calls Section -->
        <div id="calls-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">ניהול שיחות</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-2">שיחות פעילות</h3>
                    <p class="text-3xl font-bold text-green-600">3</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-2">זמן שיחה ממוצע</h3>
                    <p class="text-3xl font-bold text-blue-600">4:32</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-2">שיעור המרה</h3>
                    <p class="text-3xl font-bold text-purple-600">23%</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <h2 class="text-xl font-semibold">שיחות אחרונות</h2>
                </div>
                <div class="p-6">
                    <div id="calls-list" hx-get="/api/admin/calls" hx-trigger="load">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 border rounded-lg">
                                <div>
                                    <p class="font-semibold">050-1234567</p>
                                    <p class="text-sm text-gray-600">2 דקות</p>
                                </div>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">הושלמה</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Section -->
        <div id="whatsapp-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">ניהול WhatsApp</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-semibold">שיחות פעילות</h2>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">
                                    W
                                </div>
                                <div class="mr-3">
                                    <p class="font-semibold">יעקב כהן</p>
                                    <p class="text-sm text-gray-600">שאלה על דירת 3 חדרים</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-semibold">שליחת הודעה</h2>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <input type="text" placeholder="מספר טלפון" class="w-full px-3 py-2 border rounded-lg">
                            <textarea placeholder="תוכן ההודעה" class="w-full px-3 py-2 border rounded-lg h-24"></textarea>
                            <button class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">שלח הודעה</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CRM Section -->
        <div id="crm-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">ניהול לקוחות CRM</h1>
            
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-xl font-semibold">רשימת לקוחות</h2>
                    <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">הוסף לקוח</button>
                </div>
                <div class="p-6">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-right">שם</th>
                                    <th class="px-4 py-2 text-right">טלפון</th>
                                    <th class="px-4 py-2 text-right">סטטוס</th>
                                    <th class="px-4 py-2 text-right">עדכון אחרון</th>
                                    <th class="px-4 py-2 text-right">פעולות</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-t">
                                    <td class="px-4 py-3">שרה לוי</td>
                                    <td class="px-4 py-3">050-1234567</td>
                                    <td class="px-4 py-3"><span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm">בתהליך</span></td>
                                    <td class="px-4 py-3">אתמול</td>
                                    <td class="px-4 py-3">
                                        <button class="text-blue-600 hover:text-blue-800 ml-2">עריכה</button>
                                        <button class="text-green-600 hover:text-green-800">צור קשר</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Businesses Section -->
        <div id="businesses-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">ניהול עסקים</h1>
            
            <div class="mb-6">
                <button onclick="showAddBusinessModal()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                    ➕ הוסף עסק חדש
                </button>
            </div>
            
            <div id="tenants" hx-get="/api/admin/tenants" hx-trigger="load" class="bg-white rounded-lg shadow p-6">
                <div class="animate-pulse space-y-4">
                    <div class="h-4 bg-gray-200 rounded w-full"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                </div>
            </div>
        </div>

        <!-- Invoices Section -->
        <div id="invoices-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">ניהול חשבוניות</h1>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-500">עמוד חשבוניות ייבנה כאן...</p>
            </div>
        </div>

        <!-- Payments Section -->
        <div id="payments-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">ניהול תשלומים</h1>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-500">עמוד תשלומים ייבנה כאן...</p>
            </div>
        </div>

        <!-- Contracts Section -->
        <div id="contracts-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">חוזים עם חתימות דיגיטליות</h1>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-500">עמוד חוזים דיגיטליים ייבנה כאן...</p>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">דוחות ואנליטיקה</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">טרנדים שבועיים</h3>
                    <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                        <p class="text-gray-500">גרף מגמות</p>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ביצועים לפי עסק</h3>
                    <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                        <p class="text-gray-500">גרף ביצועים</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="section-content p-6 hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">הגדרות מערכת</h1>
            
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">הגדרות Twilio</label>
                            <input type="text" placeholder="Account SID" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">הגדרות OpenAI</label>
                            <input type="text" placeholder="API Key" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <button class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">שמור הגדרות</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Business Modals -->
<div id="businessModals">
    <!-- Add Business Modal -->
    <div id="addBusinessModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4">הוסף עסק חדש</h3>
                <form id="addBusinessForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">שם העסק</label>
                            <input type="text" id="businessName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">סוג עסק</label>
                            <select id="businessType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">בחר סוג עסק</option>
                                <option value="נדלן ותיווך">נדלן ותיווך</option>
                                <option value="שירותים מקצועיים">שירותים מקצועיים</option>
                                <option value="רפואה">רפואה</option>
                                <option value="מסעדנות">מסעדנות</option>
                                <option value="קמעונאות">קמעונאות</option>
                                <option value="אחר">אחר</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">אימייל מנהל</label>
                            <input type="email" id="adminEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">סיסמה ראשונית</label>
                            <input type="password" id="adminPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideAddBusinessModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">ביטול</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">צור עסק</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Business Modal -->
    <div id="editBusinessModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4">עריכת עסק</h3>
                <form id="editBusinessForm">
                    <input type="hidden" id="editBusinessId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">שם העסק</label>
                            <input type="text" id="editBusinessName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">סוג עסק</label>
                            <select id="editBusinessType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="נדלן ותיווך">נדלן ותיווך</option>
                                <option value="שירותים מקצועיים">שירותים מקצועיים</option>
                                <option value="רפואה">רפואה</option>
                                <option value="מסעדנות">מסעדנות</option>
                                <option value="קמעונאות">קמעונאות</option>
                                <option value="אחר">אחר</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">סטטוס</label>
                            <select id="editBusinessStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="true">פעיל</option>
                                <option value="false">לא פעיל</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideEditBusinessModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">ביטול</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">שמור שינויים</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4">שינוי סיסמה</h3>
                <form id="changePasswordForm">
                    <input type="hidden" id="changePasswordBusinessId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">סיסמה חדשה</label>
                            <input type="password" id="newPassword" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">אישור סיסמה</label>
                            <input type="password" id="confirmPassword" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideChangePasswordModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">ביטול</button>
                        <button type="submit" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">שנה סיסמה</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// API Call helper function
async function apiCall(url, options = {}) {
    try {
        const response = await fetch(url, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });
        return response;
    } catch (error) {
        console.error('API call failed:', error);
        throw error;
    }
}

async function logout() {
    try {
        await apiCall('/api/ui/logout', { method: 'POST' });
        window.location.href = '/login';
    } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/login';
    }
}

function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('hidden');
    });
    
    // Remove active class from all nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active', 'bg-blue-50', 'text-blue-600');
    });
    
    // Show selected section
    document.getElementById(sectionName + '-section').classList.remove('hidden');
    
    // Add active class to clicked nav item
    event.target.closest('.nav-item').classList.add('active', 'bg-blue-50', 'text-blue-600');
}

// Auto-refresh every 30 seconds
setInterval(() => {
    if (!document.getElementById('dashboard-section').classList.contains('hidden')) {
        htmx.trigger('#kpis', 'load');
        htmx.trigger('#tenants', 'load');
        htmx.trigger('#calls', 'load');
    }
}, 30000);

// Business Management Functions
async function showAddBusinessModal() {
    document.getElementById('addBusinessModal').classList.remove('hidden');
}

function hideAddBusinessModal() {
    document.getElementById('addBusinessModal').classList.add('hidden');
    document.getElementById('addBusinessForm').reset();
}

async function editBusiness(businessId) {
    try {
        const response = await apiCall(`/api/admin/business/${businessId}`);
        const business = await response.json();
        
        document.getElementById('editBusinessId').value = business.id;
        document.getElementById('editBusinessName').value = business.name;
        document.getElementById('editBusinessType').value = business.business_type;
        document.getElementById('editBusinessStatus').value = business.is_active.toString();
        
        document.getElementById('editBusinessModal').classList.remove('hidden');
    } catch (error) {
        alert('שגיאה בטעינת נתוני העסק');
    }
}

function hideEditBusinessModal() {
    document.getElementById('editBusinessModal').classList.add('hidden');
    document.getElementById('editBusinessForm').reset();
}

async function loginAsBusiness(businessId) {
    if (confirm('האם אתה בטוח שברצונך להתחבר כעסק זה?')) {
        try {
            const response = await apiCall(`/api/admin/login-as-business/${businessId}`, {method: 'POST'});
            const result = await response.json();
            if (result.success) {
                alert('התחברת בהצלחה כעסק! מעביר לדשבורד עסקי...');
                window.location.href = '/app/business';
            } else {
                alert('שגיאה בהתחברות לעסק');
            }
        } catch (error) {
            alert('שגיאה בהתחברות לעסק');
        }
    }
}

async function changePassword(businessId) {
    document.getElementById('changePasswordBusinessId').value = businessId;
    document.getElementById('changePasswordModal').classList.remove('hidden');
}

function hideChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.add('hidden');
    document.getElementById('changePasswordForm').reset();
}

// Form Handlers
document.getElementById('addBusinessForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('businessName').value,
        business_type: document.getElementById('businessType').value,
        admin_email: document.getElementById('adminEmail').value,
        admin_password: document.getElementById('adminPassword').value
    };
    
    try {
        const response = await apiCall('/api/admin/business', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('עסק נוצר בהצלחה!');
            hideAddBusinessModal();
            htmx.trigger('#tenants', 'load'); // Refresh list
        } else {
            alert(result.error || 'שגיאה ביצירת העסק');
        }
    } catch (error) {
        alert('שגיאה ביצירת העסק');
    }
});

document.getElementById('editBusinessForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const businessId = document.getElementById('editBusinessId').value;
    const formData = {
        name: document.getElementById('editBusinessName').value,
        business_type: document.getElementById('editBusinessType').value,
        is_active: document.getElementById('editBusinessStatus').value === 'true'
    };
    
    try {
        const response = await apiCall(`/api/admin/business/${businessId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('עסק עודכן בהצלחה!');
            hideEditBusinessModal();
            htmx.trigger('#tenants', 'load'); // Refresh list
        } else {
            alert(result.error || 'שגיאה בעדכון העסק');
        }
    } catch (error) {
        alert('שגיאה בעדכון העסק');
    }
});

document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const businessId = document.getElementById('changePasswordBusinessId').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        alert('הסיסמאות אינן תואמות');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('הסיסמה חייבת להכיל לפחות 6 תווים');
        return;
    }
    
    try {
        const response = await apiCall(`/api/admin/business/${businessId}/change-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: newPassword})
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('סיסמה שונתה בהצלחה!');
            hideChangePasswordModal();
        } else {
            alert(result.error || 'שגיאה בשינוי הסיסמה');
        }
    } catch (error) {
        alert('שגיאה בשינוי הסיסמה');
    }
});
</script>
{% endblock %}