{% extends "layout.html" %}

{% block content %}
<div class="space-y-6">
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">×©×™×—×•×ª ×”×™×•×</p>
                    <p class="text-2xl font-bold text-gray-900">{{ counters.get('today_calls', 0) }}</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">ğŸ“</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">×¢×¡×§×™× ×¤×¢×™×œ×™×</p>
                    <p class="text-2xl font-bold text-gray-900">{{ counters.get('tenants_active', 0) }}</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">ğŸ¢</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">××©×ª××©×™× ×××ª×™× ×™×</p>
                    <p class="text-2xl font-bold text-gray-900">{{ counters.get('users_pending', 0) }}</p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">â³</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">×¨×•×•×— ×—×•×“×©×™</p>
                    <p class="text-2xl font-bold text-gray-900">â‚ª12,540</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">ğŸ’°</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tenants Section -->
    <section id="tenants" class="space-y-2">
        <div class="flex items-center gap-2">
            <h2 class="font-semibold">× ×™×”×•×œ ×¢×¡×§×™×</h2>
            <button class="btn-primary"
                    hx-get="/ui/admin/tenants/new" hx-target="#modal" hx-swap="innerHTML">â• ×”×•×¡×£ ×¢×¡×§</button>
            <input id="tq" placeholder="×—×™×¤×•×© ×¢×¡×§×™×" class="ml-auto px-3 py-2 border rounded-xl" oninput="loadTenantsAdmin()"/>
        </div>
        <div id="tenantsTable" 
             hx-get="/ui/admin/tenants" 
             hx-trigger="load" 
             hx-swap="innerHTML"></div>
    </section>

    <!-- Users Section -->
    <section id="users" class="space-y-2">
        <div class="flex items-center gap-2">
            <h2 class="font-semibold">× ×™×”×•×œ ××©×ª××©×™×</h2>
            <button class="btn-primary"
                    hx-get="/ui/admin/users/new" hx-target="#modal" hx-swap="innerHTML">â• ××©×ª××© ×—×“×©</button>
            <input id="uq" placeholder="×—×™×¤×•×© ××©×ª××©×™×" class="ml-auto px-3 py-2 border rounded-xl" oninput="loadUsersAdmin()"/>
        </div>
        <div id="usersTable"
             hx-get="/ui/admin/users" 
             hx-trigger="load" 
             hx-swap="innerHTML"></div>
    </section>
</div>

<script>
// Load functions for HTMX tables
function loadUsersAdmin(){
  const q = document.getElementById('uq').value || '';
  const u = new URL('/ui/admin/users', location.origin);
  u.searchParams.set('q', q);
  const sel = document.getElementById('bizSelect');
  if(sel && sel.value) u.searchParams.set('business_id', sel.value);
  htmx.ajax('GET', u.toString(), { target:'#usersTable', swap:'innerHTML' });
}

function loadTenantsAdmin(){
  const q = document.getElementById('tq').value || '';
  const u = new URL('/ui/admin/tenants', location.origin);
  u.searchParams.set('q', q);
  htmx.ajax('GET', u.toString(), { target:'#tenantsTable', swap:'innerHTML' });
}

// Action functions
function editUser(userId) {
  htmx.ajax('GET', `/ui/admin/users/${userId}/edit`, { target:'#modal', swap:'innerHTML' });
}

function changeUserPassword(userId) {
  htmx.ajax('GET', `/ui/admin/users/${userId}/password`, { target:'#modal', swap:'innerHTML' });
}

function editBusiness(businessId) {
  htmx.ajax('GET', `/ui/admin/businesses/${businessId}/edit`, { target:'#modal', swap:'innerHTML' });
}

function loginAsBusiness(businessId) {
  if(confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª×—×‘×¨ ×›×¢×¡×§ ×–×”?')) {
    htmx.ajax('POST', `/api/admin/login-as-business/${businessId}`, { 
      target:'body', 
      swap:'outerHTML',
      headers: {'Content-Type': 'application/json'}
    });
  }
}

function changeBusinessPassword(businessId) {
  htmx.ajax('GET', `/ui/admin/businesses/${businessId}/password`, { target:'#modal', swap:'innerHTML' });
}

// Auto-load tables on page load and refresh every 15 seconds
window.addEventListener('load', function(){ 
  loadUsersAdmin(); 
  loadTenantsAdmin();
  setInterval(loadUsersAdmin, 15000);
  setInterval(loadTenantsAdmin, 15000);
});
</script>
{% endblock %}