{% extends "layout.html" %}

{% block page_title %}××™×–×•×¨ ×× ×”×œ ××¢×¨×›×ª{% endblock %}

{% block content %}
<!-- KPIs Section -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
  <div class="bg-white overflow-hidden shadow-xl rounded-2xl">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold">ğŸ“</span>
          </div>
        </div>
        <div class="mr-4">
          <p class="text-sm font-medium text-gray-500">×©×™×—×•×ª ×”×™×•×</p>
          <p class="text-2xl font-semibold text-gray-900">{{ counters.today_calls or 0 }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-xl rounded-2xl">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold">ğŸ¢</span>
          </div>
        </div>
        <div class="mr-4">
          <p class="text-sm font-medium text-gray-500">×¢×¡×§×™× ×¤×¢×™×œ×™×</p>
          <p class="text-2xl font-semibold text-gray-900">{{ counters.tenants_active or 0 }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-xl rounded-2xl">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold">ğŸ‘¥</span>
          </div>
        </div>
        <div class="mr-4">
          <p class="text-sm font-medium text-gray-500">××©×ª××©×™× ×××ª×™× ×™×</p>
          <p class="text-2xl font-semibold text-gray-900">{{ counters.users_pending or 0 }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-xl rounded-2xl">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold">ğŸ’¬</span>
          </div>
        </div>
        <div class="mr-4">
          <p class="text-sm font-medium text-gray-500">WhatsApp ×œ× × ×§×¨××•</p>
          <p class="text-2xl font-semibold text-gray-900">{{ counters.whatsapp_unread or 0 }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tenants Section -->
<section id="tenants" class="space-y-2 mb-8">
  <div class="flex items-center gap-2">
    <h2 class="font-semibold text-xl">× ×™×”×•×œ ×¢×¡×§×™×</h2>
    <button class="btn-primary"
            hx-get="/ui/admin/tenants/new" hx-target="#modal" hx-swap="innerHTML">â• ×”×•×¡×£ ×¢×¡×§</button>
    <input id="tq" placeholder="×—×™×¤×•×© ×¢×¡×§×™×" class="ml-auto px-3 py-2 border rounded-xl" oninput="loadTenantsAdmin()"/>
  </div>
  <div class="bg-white shadow-xl rounded-2xl overflow-hidden">
    <div id="tenantsTable" class="p-6">
      <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50">
        <div>
          <h4 class="font-medium text-gray-900">×©×™ ×“×™×¨×•×ª ×•××©×¨×“×™× ×‘×¢×´×</h4>
          <p class="text-sm text-gray-500">× ×“×œ×Ÿ ×•×ª×™×•×•×š</p>
        </div>
        <div class="flex items-center space-x-2">
          <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">×¤×¢×™×œ</span>
          <button onclick="editBusiness(13)" class="text-blue-600 hover:text-blue-800 text-sm mr-2">×¢×¨×™×›×”</button>
          <button onclick="loginAsBusiness(13)" class="text-green-600 hover:text-green-800 text-sm mr-2">×”×ª×—×‘×¨ ×›×¢×¡×§</button>
          <button onclick="changeBusinessPassword(13)" class="text-purple-600 hover:text-purple-800 text-sm">×©× ×” ×¡×™×¡××”</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Users Section -->
<section id="users" class="space-y-2 mb-8">
  <div class="flex items-center gap-2">
    <h2 class="font-semibold text-xl">× ×™×”×•×œ ××©×ª××©×™×</h2>
    <button class="btn-primary"
            hx-get="/ui/admin/users/new" hx-target="#modal" hx-swap="innerHTML">â• ××©×ª××© ×—×“×©</button>
    <input id="uq" placeholder="×—×™×¤×•×© ××©×ª××©×™×" class="ml-auto px-3 py-2 border rounded-xl" oninput="loadUsersAdmin()"/>
  </div>
  <div class="bg-white shadow-xl rounded-2xl overflow-hidden">
    <div id="usersTable" class="p-6">
      <!-- ×™×˜×¢×Ÿ ×“×¨×š HTMX -->
    </div>
  </div>
</section>

<!-- Recent Calls Section -->
<section id="calls" class="space-y-2 mb-8">
  <div class="flex items-center gap-2">
    <h2 class="font-semibold text-xl">×©×™×—×•×ª ××—×¨×•× ×•×ª</h2>
  </div>
  <div class="bg-white shadow-xl rounded-2xl overflow-hidden">
    <div id="callsTable" class="p-6">
      <div class="animate-pulse space-y-4">
        <div class="h-4 bg-gray-200 rounded w-full"></div>
        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
      </div>
    </div>
  </div>
</section>

<script>
// Load functions for HTMX tables
function loadUsersAdmin(){
  const q = document.getElementById('uq').value || '';
  const u = new URL('/ui/admin/users', location.origin);
  u.searchParams.set('q', q);
  const sel = document.getElementById('bizSelect');
  if(sel && sel.value) u.searchParams.set('business_id', sel.value);
  htmx.ajax('GET', u.toString(), { target:'#usersTable', swap:'innerHTML' });
}

function loadTenantsAdmin(){
  const q = document.getElementById('tq').value || '';
  const u = new URL('/ui/admin/tenants', location.origin);
  u.searchParams.set('q', q);
  htmx.ajax('GET', u.toString(), { target:'#tenantsTable', swap:'innerHTML' });
}

// Action functions
function editUser(userId) {
  htmx.ajax('GET', `/ui/admin/users/${userId}/edit`, { target:'#modal', swap:'innerHTML' });
}

function changeUserPassword(userId) {
  htmx.ajax('GET', `/ui/admin/users/${userId}/password`, { target:'#modal', swap:'innerHTML' });
}

function editBusiness(businessId) {
  htmx.ajax('GET', `/ui/admin/businesses/${businessId}/edit`, { target:'#modal', swap:'innerHTML' });
}

function loginAsBusiness(businessId) {
  if(confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª×—×‘×¨ ×›×¢×¡×§ ×–×”?')) {
    htmx.ajax('POST', `/api/admin/login-as-business/${businessId}`, { 
      target:'body', 
      swap:'outerHTML',
      headers: {'Content-Type': 'application/json'}
    });
  }
}

function changeBusinessPassword(businessId) {
  htmx.ajax('GET', `/ui/admin/businesses/${businessId}/password`, { target:'#modal', swap:'innerHTML' });
}

// Auto-load tables on page load and refresh every 15 seconds
window.addEventListener('load', ()=>{ 
  loadUsersAdmin(); 
  loadTenantsAdmin();
  setInterval(loadUsersAdmin, 15000);
  setInterval(loadTenantsAdmin, 15000);
});
</script>
{% endblock %}