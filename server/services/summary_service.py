"""
Summary Service - AI-powered DYNAMIC conversation summarization
×©×™×¨×•×ª ×¡×™×›×•× ×—×›× ×•×“×™× ××™ - ××•×ª×× ×œ×›×œ ×¡×•×’ ×¢×¡×§!
BUILD 143 - Dynamic Business-Aware Summaries
"""
import os
import logging
from typing import Optional, Dict, Any

log = logging.getLogger(__name__)

BUSINESS_SUMMARY_TEMPLATES = {
    "real_estate": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª × ×“×œ\"×Ÿ ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™×, ××¤×•×¨×˜×™× ×•××•×‘× ×™× ×©××›×™×œ×™× ××ª ×›×œ ×”××™×“×¢ ×”×—×©×•×‘ ××”×©×™×—×”.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: ××” ×”×œ×§×•×— ××—×¤×©? (××›×™×¨×”/×”×©×›×¨×”/×™×™×¢×•×¥)

2. **×¤×¨×˜×™ ×”× ×›×¡ ×”××‘×•×§×©**:
   - ×¡×•×’ × ×›×¡: (×“×™×¨×”/×‘×™×ª/××©×¨×“/×§×¨×§×¢)
   - ××–×•×¨/×¢×™×¨: (××” ×”××–×•×¨ ×”××•×¢×“×£?)
   - ×ª×§×¦×™×‘: (×›×•×œ×œ ×˜×•×•×— ××—×™×¨×™×)
   - ××¡×¤×¨ ×—×“×¨×™×: (×× ×¦×•×™×Ÿ)
   - ×“×¨×™×©×•×ª ××™×•×—×“×•×ª: (×—× ×™×”, ××"×“, ××¢×œ×™×ª ×•×›×•')

3. **×¤×¨×˜×™ ×§×©×¨**: ×©× ×”×œ×§×•×— ×•××™×š ×œ×™×¦×•×¨ ×§×©×¨

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢×” ×¤×’×™×©×”? (××ª×™?)
   - ×“×—×™×¤×•×ª: (×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ××•×›×”)
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª × ×•×¡×¤×•×ª**: ××™×“×¢ ×—×©×•×‘ ×©×¦×•×™×Ÿ ×‘×©×™×—×”"""
    },
    
    "medical": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×¨×¤×•××™×•×ª ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×•×“×™×¡×§×¨×˜×™×™× ×©××›×™×œ×™× ××ª ×”××™×“×¢ ×”×¨×œ×•×•× ×˜×™ ×œ×˜×™×¤×•×œ.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×™×‘×ª ×”×¤× ×™×™×”**: ××” ×”×‘×¢×™×” ××• ×”×ª×œ×•× ×” ×”×¢×™×§×¨×™×ª?

2. **×¤×¨×˜×™× ×§×œ×™× ×™×™×**:
   - ×ª×¡××™× ×™×: (×ª×™××•×¨ ×”×‘×¢×™×”)
   - ××©×š ×”×–××Ÿ: (××ª×™ ×”×ª×—×™×œ?)
   - ×”×™×¡×˜×•×¨×™×” ×¨×œ×•×•× ×˜×™×ª: (×× ×¦×•×™×Ÿ)
   - ×ª×¨×•×¤×•×ª × ×•×›×—×™×•×ª: (×× ×¦×•×™×Ÿ)

3. **×¤×¨×˜×™ ×”××˜×•×¤×œ**: ×©× ×•×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢ ×ª×•×¨? (××ª×™ ×•×œ××™×–×” ×¨×•×¤×?)
   - ×“×—×™×¤×•×ª: (×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ××•×›×”)
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª ××™×•×—×“×•×ª**: ××œ×¨×’×™×•×ª, ××’×‘×œ×•×ª ××• ×“×’×©×™× ×—×©×•×‘×™×"""
    },
    
    "legal": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ××©×¤×˜×™×•×ª ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×•××“×•×™×§×™× ×©××›×™×œ×™× ××ª ×›×œ ×”×¤×¨×˜×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×™×™×¢×•×¥ ××©×¤×˜×™.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: ×ª×—×•× ××©×¤×˜×™ (× ×–×™×§×™×Ÿ/××©×¤×—×”/×¢×‘×•×“×”/×¤×œ×™×œ×™/××¡×—×¨×™)

2. **×¤×¨×˜×™ ×”×ª×™×§/×”×¢× ×™×™×Ÿ**:
   - ×ª×™××•×¨ ×”×‘×¢×™×”: (××” ×§×¨×”?)
   - ××•×¢×“×™× ×¨×œ×•×•× ×˜×™×™×: (×ª××¨×™×›×™× ×—×©×•×‘×™×)
   - ×¦×“×“×™× ××¢×•×¨×‘×™×: (××™ ×”×¦×“ ×”×©× ×™?)
   - ××¡××›×™× ×§×™×™××™×: (×× ×¦×•×™×Ÿ)

3. **×¤×¨×˜×™ ×”×œ×§×•×—**: ×©× ×•×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢×” ×¤×’×™×©×ª ×™×™×¢×•×¥? (××ª×™?)
   - ×“×—×™×¤×•×ª: (×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ××•×›×” - ×”×ª×™×™×©× ×•×ª?)
   - ××¡××›×™× ×©× ×“×¨×©×™×

5. **×”×¢×¨×•×ª ××©×¤×˜×™×•×ª**: ×¡×•×’×™×•×ª ××™×•×—×“×•×ª ××• ×¡×™×›×•× ×™×"""
    },
    
    "insurance": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×‘×™×˜×•×— ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×”×¤×¨×˜×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×¤×•×œ×™×¡×” ××• ×ª×‘×™×¢×”.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×‘×™×˜×•×— ×—×“×©/×ª×‘×™×¢×”/×©×™× ×•×™ ×¤×•×œ×™×¡×”/×—×™×“×•×©)

2. **×¤×¨×˜×™ ×”×‘×™×˜×•×—**:
   - ×¡×•×’ ×‘×™×˜×•×—: (×¨×›×‘/×“×™×¨×”/×‘×¨×™××•×ª/×—×™×™×)
   - ×¤×¨×˜×™ ×”× ×›×¡/×”××‘×•×˜×—: (××” ××‘×•×˜×—?)
   - ×›×™×¡×•×™×™× × ×“×¨×©×™×: (××” ×—×©×•×‘ ×œ×œ×§×•×—?)
   - ×ª×§×¦×™×‘/×¤×¨××™×”: (×× ×¦×•×™×Ÿ)

3. **×¤×¨×˜×™ ×”×œ×§×•×—**: ×©×, ×’×™×œ ×•×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×©×œ×—×” ×”×¦×¢×”? (××ª×™?)
   - ××¡××›×™× × ×“×¨×©×™×
   - ×¤×¢×•×œ×•×ª ×”××©×š

5. **×”×¢×¨×•×ª**: ×¤×•×œ×™×¡×•×ª ×§×™×™××•×ª, ×”×™×¡×˜×•×¨×™×™×ª ×ª×‘×™×¢×•×ª"""
    },
    
    "automotive": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×¨×›×‘ ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×”×¤×¨×˜×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×§× ×™×™×”/××›×™×¨×”/×©×™×¨×•×ª ×¨×›×‘.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×§× ×™×™×”/××›×™×¨×”/×œ×™×¡×™× ×’/×©×™×¨×•×ª/×ª×™×§×•×Ÿ)

2. **×¤×¨×˜×™ ×”×¨×›×‘**:
   - ×™×¦×¨×Ÿ ×•×“×’×: (××” ××—×¤×©/××¦×™×¢?)
   - ×©× ×” ×•×§×™×œ×•××˜×¨×–': (×× ×¦×•×™×Ÿ)
   - ×ª×§×¦×™×‘: (×˜×•×•×— ××—×™×¨×™×)
   - ×“×¨×™×©×•×ª ××™×•×—×“×•×ª: (×¦×‘×¢, ×ª×•×¡×¤×•×ª, ××¦×‘)

3. **×¤×¨×˜×™ ×”×œ×§×•×—**: ×©× ×•×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢×” × ×¡×™×¢×ª ××‘×—×Ÿ/×¤×’×™×©×”? (××ª×™?)
   - ×¨×›×‘ ××•×¦×¢: (×× × ××¦× ×”×ª×××”)
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª**: ××§×•×¨×•×ª ××™××•×Ÿ, ×¨×›×‘ ×§×•×“× ×œ×”×—×œ×¤×”"""
    },
    
    "fitness": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×›×•×©×¨ ×•×‘×¨×™××•×ª ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×”×¤×¨×˜×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×× ×•×™ ××• ××™××•×Ÿ.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×× ×•×™ ×—×“×©/××™××•×Ÿ ××™×©×™/×©×™×¢×•×¨×™×/××™×“×¢)

2. **×¤×¨×˜×™ ×”×œ×§×•×— ×•××˜×¨×•×ª**:
   - ××˜×¨×ª ×”××™××•×Ÿ: (×™×¨×™×“×” ×‘××©×§×œ/×‘× ×™×™×ª ×©×¨×™×¨/×›×•×©×¨ ×›×œ×œ×™)
   - × ×™×¡×™×•×Ÿ ×§×•×“×: (×× ×¦×•×™×Ÿ)
   - ××’×‘×œ×•×ª/×¤×¦×™×¢×•×ª: (×× ×™×©)
   - ×–××™× ×•×ª: (×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×)

3. **×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª**: ×©× ×•×˜×œ×¤×•×Ÿ

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢ ××™××•×Ÿ × ×™×¡×™×•×Ÿ? (××ª×™?)
   - ×¡×•×’ ×× ×•×™ ×©××¢× ×™×™×Ÿ
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª**: ×ª×§×¦×™×‘, ×”×¢×“×¤×•×ª ××™×•×—×“×•×ª"""
    },
    
    "education": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×—×™× ×•×š ×•×”×©×›×œ×” ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×”×¤×¨×˜×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×œ×™××•×“×™×.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×§×•×¨×¡/×ª×•××¨/×”×›×©×¨×”/××™×“×¢)

2. **×¤×¨×˜×™ ×”×œ×™××•×“×™×**:
   - ×ª×—×•× ×¢× ×™×™×Ÿ: (××” ×¨×•×¦×™× ×œ×œ××•×“?)
   - ×¨××” × ×•×›×—×™×ª: (×¨×§×¢ ×§×™×™×)
   - ××˜×¨×”: (×§×¨×™×™×¨×”/×”×¢×©×¨×”/×”×¡××›×”)
   - ×–××™× ×•×ª: (×œ×™××•×“×™ ×™×•×/×¢×¨×‘/××•× ×œ×™×™×Ÿ)

3. **×¤×¨×˜×™ ×”××ª×¢× ×™×™×Ÿ**: ×©×, ×’×™×œ ×•×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢×” ×¤×’×™×©×ª ×™×™×¢×•×¥? (××ª×™?)
   - ×§×•×¨×¡×™×/××¡×œ×•×œ×™× ××ª××™××™×
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª**: ×ª×§×¦×™×‘, ××•×¢×“×™ ×¤×ª×™×—×”, ××œ×’×•×ª"""
    },
    
    "restaurant": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ××¡×¢×“×•×ª ×•×”×–×× ×•×ª ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×¤×¨×˜×™ ×”×”×–×× ×”.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×”×–×× ×ª ×©×•×œ×—×Ÿ/××™×¨×•×¢/×§×™×™×˜×¨×™× ×’/××™×“×¢)

2. **×¤×¨×˜×™ ×”×”×–×× ×”**:
   - ×ª××¨×™×š ×•×©×¢×”: (××ª×™?)
   - ××¡×¤×¨ ×¡×•×¢×“×™×: (×›××” ×× ×©×™×?)
   - ××•×¤×™ ×”××™×¨×•×¢: (×™×•× ×”×•×œ×“×ª/×¢×¡×§×™/××©×¤×—×ª×™)
   - ×“×¨×™×©×•×ª ××™×•×—×“×•×ª: (×¦××—×•× ×™/×œ×œ× ×’×œ×•×˜×Ÿ/×›×©×¨)

3. **×¤×¨×˜×™ ×”××–××™×Ÿ**: ×©× ×•×˜×œ×¤×•×Ÿ

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× ×”×”×–×× ×” ××•×©×¨×”? (××¡×¤×¨ ×”×–×× ×”?)
   - ×ª×§×¦×™×‘/×× ×•×ª ××•×–×× ×•×ª ××¨××©
   - ×‘×§×©×•×ª ××™×•×—×“×•×ª

5. **×”×¢×¨×•×ª**: ××§×•× ×™×©×™×‘×” ××•×¢×“×£, ×—×’×™×’×” ××™×•×—×“×ª"""
    },
    
    "beauty": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×™×•×¤×™ ×•×˜×™×¤×•×— ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×¤×¨×˜×™ ×”×˜×™×¤×•×œ ×”××‘×•×§×©.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×ª×¡×¤×•×¨×ª/×¦×‘×™×¢×”/×˜×™×¤×•×œ ×¤× ×™×/×× ×™×§×•×¨/××—×¨)

2. **×¤×¨×˜×™ ×”×˜×™×¤×•×œ**:
   - ×¡×•×’ ×”×˜×™×¤×•×œ ×”××‘×•×§×©: (××” ×¨×•×¦×™×?)
   - ×”×¢×“×¤×•×ª: (×¡×’× ×•×Ÿ/×¦×‘×¢/××•×¨×š)
   - ××˜×¤×œ/×ª ××•×¢×“×£/×ª: (×× ×™×©)
   - ×–××™× ×•×ª: (×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×)

3. **×¤×¨×˜×™ ×”×œ×§×•×—/×”**: ×©× ×•×˜×œ×¤×•×Ÿ

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢ ×ª×•×¨? (××ª×™ ×•×œ××™?)
   - ××©×š ×”×˜×™×¤×•×œ ×”××©×•×¢×¨
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª**: ××œ×¨×’×™×•×ª, ×˜×™×¤×•×œ×™× ×§×•×“××™×, ×ª×§×¦×™×‘"""
    },
    
    "consulting": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×™×™×¢×•×¥ ×¢×¡×§×™ ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×”×¤×¨×˜×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×™×™×¢×•×¥.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×™×™×¢×•×¥ ×¢×¡×§×™/×©×™×•×•×§/×¤×™× × ×¡×™/××¨×’×•× ×™)

2. **×¤×¨×˜×™ ×”×¢×¡×§**:
   - ×ª×—×•× ×¤×¢×™×œ×•×ª: (××” ×”×¢×¡×§ ×¢×•×©×”?)
   - ××ª×’×¨/×‘×¢×™×”: (××” ×¦×¨×™×š ×œ×¤×ª×•×¨?)
   - ×’×•×“×œ ×”×¢×¡×§: (×¢×•×‘×“×™×/××—×–×•×¨)
   - ××˜×¨×•×ª: (×œ××Ÿ ×¨×•×¦×™× ×œ×”×’×™×¢?)

3. **×¤×¨×˜×™ ×”×œ×§×•×—**: ×©×, ×ª×¤×§×™×“ ×•×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢×” ×¤×’×™×©×ª ×™×™×¢×•×¥? (××ª×™?)
   - ×“×—×™×¤×•×ª: (×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ××•×›×”)
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª**: ×ª×§×¦×™×‘ ×œ×™×™×¢×•×¥, ×¦×™×¤×™×•×ª, ××¡××›×™× × ×“×¨×©×™×"""
    },
    
    "tech_support": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×ª××™×›×” ×˜×›× ×™×ª ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×”×¤×¨×˜×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×˜×™×¤×•×œ ×‘×‘×¢×™×”.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×ª×§×œ×”/×©××œ×”/×”×“×¨×›×”/×”×ª×§× ×”)

2. **×¤×¨×˜×™ ×”×‘×¢×™×”**:
   - ×ª×™××•×¨ ×”×ª×§×œ×”: (××” ×œ× ×¢×•×‘×“?)
   - ××•×¦×¨/×©×™×¨×•×ª: (×‘××™×–×” ××•×¦×¨ ××“×•×‘×¨?)
   - ××ª×™ ×”×ª×—×™×œ: (×ª×–××•×Ÿ ×”×‘×¢×™×”)
   - ××” × ×•×¡×”: (×¤×ª×¨×•× ×•×ª ×©× ×•×¡×•)

3. **×¤×¨×˜×™ ×”×œ×§×•×—**: ×©×, ××¡×¤×¨ ×œ×§×•×— ×•×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× ×”×‘×¢×™×” × ×¤×ª×¨×”? (×›×Ÿ/×œ×/×‘×˜×™×¤×•×œ)
   - ××¡×¤×¨ ×§×¨×™××”/×˜×™×§×˜
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª**: ×“×—×™×¤×•×ª, SLA, ×˜×›× ××™ ×©×˜×™×¤×œ"""
    },
    
    "travel": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×ª×™×™×¨×•×ª ×•× ×¡×™×¢×•×ª ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™× ×©××›×™×œ×™× ××ª ×›×œ ×¤×¨×˜×™ ×”× ×¡×™×¢×”.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **×¡×•×’ ×”×¤× ×™×™×”**: (×—×•×¤×©×”/×˜×™×¡×•×ª/××œ×•×Ÿ/×—×‘×™×œ×”)

2. **×¤×¨×˜×™ ×”× ×¡×™×¢×”**:
   - ×™×¢×“: (×œ××Ÿ?)
   - ×ª××¨×™×›×™×: (××ª×™ ×•×œ×›××” ×–××Ÿ?)
   - ××¡×¤×¨ × ×•×¡×¢×™×: (××‘×•×’×¨×™×/×™×œ×“×™×)
   - ×ª×§×¦×™×‘: (×˜×•×•×— ××—×™×¨×™×)
   - ×”×¢×“×¤×•×ª: (×¡×•×’ ××œ×•×Ÿ, ×¤×¢×™×œ×•×™×•×ª)

3. **×¤×¨×˜×™ ×”××–××™×Ÿ**: ×©× ×•×˜×œ×¤×•×Ÿ

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×©×œ×—×” ×”×¦×¢×”? (××ª×™?)
   - ×˜×™×¡×•×ª/××œ×•× ×•×ª ×©×”×•×¦×¢×•
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª

5. **×”×¢×¨×•×ª**: ×“×¨×™×©×•×ª ××™×•×—×“×•×ª, ×•×™×–×•×ª, ×‘×™×˜×•×—"""
    },
    
    "general": {
        "system_prompt": "××ª×” ××•××—×” ×¡×™×›×•× ×©×™×—×•×ª ×¢×¡×§×™×•×ª ×‘×¢×‘×¨×™×ª. ×ª×›×ª×•×‘ ×¡×™×›×•××™× ××§×¦×•×¢×™×™×, ×‘×¨×•×¨×™× ×•××•×¢×™×œ×™×.",
        "structure": """ğŸ“‹ ××‘× ×” ×”×¡×™×›×•× ×”× ×“×¨×©:

1. **××˜×¨×ª ×”×©×™×—×”**: ××” ×”×œ×§×•×— ×—×™×¤×© ××• ×‘×™×§×©?

2. **×¤×¨×˜×™× ×¢×™×§×¨×™×™×**:
   - ×ª×™××•×¨ ×”×‘×§×©×”/×¦×•×¨×š
   - ×¤×¨×˜×™× ×¡×¤×¦×™×¤×™×™× ×©×¦×•×™× ×•
   - ×”×¢×“×¤×•×ª ××™×•×—×“×•×ª
   - ×ª×§×¦×™×‘ ××• ××’×‘×œ×•×ª

3. **×¤×¨×˜×™ ×”×œ×§×•×—**: ×©× ×•×¤×¨×˜×™ ×”×ª×§×©×¨×•×ª

4. **×¡×˜×˜×•×¡ ×•××¢×§×‘**:
   - ×”×× × ×§×‘×¢×” ×¤×’×™×©×”/×¤×¢×•×œ×”? (××ª×™?)
   - ×“×—×™×¤×•×ª: (×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ××•×›×”)
   - ×¤×¢×•×œ×•×ª × ×“×¨×©×•×ª ××”×¢×¡×§

5. **×”×¢×¨×•×ª × ×•×¡×¤×•×ª**: ×›×œ ××™×“×¢ ×—×©×•×‘ ××—×¨ ××”×©×™×—×”"""
    }
}

BUSINESS_TYPE_ALIASES = {
    "realestate": "real_estate",
    "property": "real_estate",
    "× ×“×œ×Ÿ": "real_estate",
    "clinic": "medical",
    "doctor": "medical",
    "×¨×¤×•××™": "medical",
    "×§×œ×™× ×™×§×”": "medical",
    "lawyer": "legal",
    "attorney": "legal",
    "×¢×•×¨×š ×“×™×Ÿ": "legal",
    "××©×¤×˜×™": "legal",
    "×‘×™×˜×•×—": "insurance",
    "car": "automotive",
    "garage": "automotive",
    "×¨×›×‘": "automotive",
    "××•×¡×š": "automotive",
    "gym": "fitness",
    "sport": "fitness",
    "×—×“×¨ ×›×•×©×¨": "fitness",
    "school": "education",
    "course": "education",
    "×œ×™××•×“×™×": "education",
    "food": "restaurant",
    "××¡×¢×“×”": "restaurant",
    "×§×™×™×˜×¨×™× ×’": "restaurant",
    "salon": "beauty",
    "spa": "beauty",
    "××¡×¤×¨×”": "beauty",
    "×™×•×¤×™": "beauty",
    "business": "consulting",
    "×¢×¡×§×™": "consulting",
    "support": "tech_support",
    "it": "tech_support",
    "×ª××™×›×”": "tech_support",
    "tourism": "travel",
    "vacation": "travel",
    "×ª×™×™×¨×•×ª": "travel",
    "× ×¡×™×¢×•×ª": "travel",
}

def _normalize_business_type(business_type: str) -> str:
    """Normalize business type to match template keys"""
    if not business_type:
        return "general"
    
    bt_lower = business_type.lower().strip()
    
    if bt_lower in BUSINESS_SUMMARY_TEMPLATES:
        return bt_lower
    
    if bt_lower in BUSINESS_TYPE_ALIASES:
        return BUSINESS_TYPE_ALIASES[bt_lower]
    
    return "general"


def summarize_conversation(
    transcription: str, 
    call_sid: Optional[str] = None,
    business_type: Optional[str] = None,
    business_name: Optional[str] = None
) -> str:
    """
    ×¡×™×›×•× ×“×™× ××™ ×•××§×¦×•×¢×™ ×©×œ ×©×™×—×” - ××•×ª×× ×œ×¡×•×’ ×”×¢×¡×§!
    BUILD 143 - Dynamic Business-Aware Summaries
    
    Args:
        transcription: ×”×ª××œ×•×œ ×”××œ× ×©×œ ×”×©×™×—×”
        call_sid: ××–×”×” ×©×™×—×” ×œ×œ×•×’×™×
        business_type: ×¡×•×’ ×”×¢×¡×§ (real_estate, medical, legal, etc.)
        business_name: ×©× ×”×¢×¡×§ (××•×¤×¦×™×•× ×œ×™)
        
    Returns:
        ×¡×™×›×•× ××§×¦×•×¢×™ ×‘×¢×‘×¨×™×ª (80-150 ××™×œ×™×) ××•×ª×× ×œ×¡×•×’ ×”×¢×¡×§
    """
    if not transcription or len(transcription.strip()) < 10:
        return "×©×™×—×” ×§×¦×¨×” ×œ×œ× ×ª×•×›×Ÿ"
    
    normalized_type = _normalize_business_type(business_type)
    template = BUSINESS_SUMMARY_TEMPLATES.get(normalized_type, BUSINESS_SUMMARY_TEMPLATES["general"])
    
    log.info(f"ğŸ“Š Summarizing call {call_sid} for business type: {normalized_type}")
    
    try:
        from openai import OpenAI
        
        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        
        business_context = f" ×¢×‘×•×¨ {business_name}" if business_name else ""
        
        prompt = f"""×¡×›× ××ª ×”×©×™×—×” ×”×‘××” ×‘×¢×‘×¨×™×ª ×‘×¦×•×¨×” **××§×¦×•×¢×™×ª ×•××¤×•×¨×˜×ª** (80-150 ××™×œ×™×){business_context}.

{template['structure']}

×ª××œ×•×œ ×”×©×™×—×”:
{transcription}

ğŸ“ **×¡×™×›×•× ××§×¦×•×¢×™**:"""
        
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": template['system_prompt']},
                {"role": "user", "content": prompt}
            ],
            max_tokens=350,
            temperature=0.2
        )
        
        summary = response.choices[0].message.content
        if summary:
            summary = summary.strip()
            word_count = len(summary.split())
            
            if word_count < 70:
                log.warning(f"âš ï¸ Summary too short ({word_count} words) for {call_sid} - using fallback")
                return _fallback_summary(transcription, normalized_type)
            elif word_count < 80:
                log.warning(f"âš ï¸ Summary slightly short ({word_count} words) for {call_sid} - acceptable")
            elif word_count > 180:
                log.warning(f"âš ï¸ Summary too long ({word_count} words) for {call_sid} - truncating")
                words = summary.split()
                summary = " ".join(words[:150]) + "..."
            elif word_count > 150:
                log.warning(f"âš ï¸ Summary slightly long ({word_count} words) for {call_sid} - acceptable")
            
            log.info(f"âœ… Dynamic summary generated for {call_sid} ({normalized_type}): {word_count} words")
            return summary
        else:
            log.warning(f"âš ï¸ Empty summary for {call_sid}")
            return _fallback_summary(transcription, normalized_type)
            
    except Exception as e:
        log.error(f"âŒ Summary generation failed for {call_sid}: {e}")
        return _fallback_summary(transcription, normalized_type)


def _fallback_summary(transcription: str, business_type: str = "general") -> str:
    """
    ×¡×™×›×•× fallback ×“×™× ××™ (×‘××§×¨×” ×©×œ ×›×©×œ ×‘-AI)
    """
    words = transcription.strip().split()
    text_lower = transcription.lower()
    
    summary_parts = []
    
    intent_keywords = {
        "real_estate": {"buy": ['×œ×§× ×•×ª', '×§×•× ×”', '×œ×¨×›×•×©'], "rent": ['×œ×©×›×•×¨', '×©×•×›×¨', '×œ×”×©×›×™×¨']},
        "medical": {"appointment": ['×ª×•×¨', '×‘×™×§×•×¨', '×‘×“×™×§×”'], "urgent": ['×“×—×•×£', '×›××‘', '×—×™×¨×•×']},
        "legal": {"consult": ['×™×™×¢×•×¥', '×”×ª×™×™×¢×¦×•×ª'], "case": ['×ª×™×§', '×ª×‘×™×¢×”', '××©×¤×˜']},
    }
    
    type_labels = {
        "real_estate": "× ×“×œ\"×Ÿ",
        "medical": "×¨×¤×•××™",
        "legal": "××©×¤×˜×™",
        "insurance": "×‘×™×˜×•×—",
        "automotive": "×¨×›×‘",
        "fitness": "×›×•×©×¨",
        "education": "×œ×™××•×“×™×",
        "restaurant": "××¡×¢×“×”",
        "beauty": "×™×•×¤×™ ×•×˜×™×¤×•×—",
        "consulting": "×™×™×¢×•×¥ ×¢×¡×§×™",
        "tech_support": "×ª××™×›×” ×˜×›× ×™×ª",
        "travel": "×ª×™×™×¨×•×ª",
        "general": "×›×œ×œ×™"
    }
    
    type_label = type_labels.get(business_type, "×¢×¡×§×™")
    summary_parts.append(f"**×¡×•×’ ×”×¤× ×™×™×”**: ×¤× ×™×™×” {type_label}")
    
    if len(words) >= 80:
        content = " ".join(words[:70])
        summary_parts.append(f"\n\n**×ª×•×›×Ÿ ×”×©×™×—×”**: {content}...")
    elif len(words) >= 40:
        summary_parts.append(f"\n\n**×ª×•×›×Ÿ ×”×©×™×—×”**: {transcription.strip()}")
        summary_parts.append("\n\n**×¤×¨×˜×™×**: ×œ× ×¦×•×™× ×• ×¤×¨×˜×™× ××œ××™× ×‘×©×™×—×”")
    else:
        summary_parts.append(f"\n\n**×ª×•×›×Ÿ ×”×©×™×—×”**: {transcription.strip()}")
        summary_parts.append("\n\n**×¤×¨×˜×™×**: ×”××™×“×¢ ×‘×©×™×—×” ×”×™×” ××•×’×‘×œ, ×™×© ×¦×•×¨×š ×‘××¢×§×‘ × ×•×¡×£")
        summary_parts.append("\n\n**×¤×¨×˜×™ ×§×©×¨**: ×œ× × ××¡×¨×• ×¤×¨×˜×™ ×§×©×¨ ××¤×•×¨×©×™×")
    
    summary_parts.append("\n\n**×¡×˜×˜×•×¡ ×•××¢×§×‘**: ×œ× × ×§×‘×¢×” ×¤×’×™×©×”. ××•××œ×¥ ×œ×—×–×•×¨ ×œ×œ×§×•×— ×•×œ×§×‘×œ ×¤×¨×˜×™× × ×•×¡×¤×™×.")
    summary_parts.append("\n\n**×”×¢×¨×”**: ×¡×™×›×•× ××•×˜×•××˜×™ (××¢×¨×›×ª AI ×–×× ×™×ª ×œ× ×–××™× ×”)")
    
    fallback = "\n".join(summary_parts)
    word_count = len(fallback.split())
    log.info(f"ğŸ“‹ Fallback summary created ({business_type}): {word_count} words")
    return fallback


def extract_lead_info(transcription: str, business_type: Optional[str] = None) -> dict:
    """
    ×—×™×œ×•×¥ ××™×“×¢ ×—×©×•×‘ ××”×©×™×—×” - ×“×™× ××™ ×œ×¤×™ ×¡×•×’ ×”×¢×¡×§
    
    Args:
        transcription: ×”×ª××œ×•×œ ×”××œ×
        business_type: ×¡×•×’ ×”×¢×¡×§
        
    Returns:
        dict ×¢× ××™×“×¢ ×¨×œ×•×•× ×˜×™ ×œ×¡×•×’ ×”×¢×¡×§
    """
    if not transcription or len(transcription.strip()) < 10:
        return {}
    
    normalized_type = _normalize_business_type(business_type)
    
    try:
        from openai import OpenAI
        
        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        
        extraction_templates = {
            "real_estate": '{"area": "××–×•×¨ ××‘×•×§×© ××• null", "property_type": "×“×™×¨×”/×‘×™×ª/××©×¨×“ ××• null", "budget": "×ª×§×¦×™×‘ ××• null", "intent": "××›×™×¨×”/×”×©×›×¨×” ××• null", "meeting_scheduled": true/false}',
            "medical": '{"symptoms": "×ª×¡××™× ×™× ××• null", "urgency": "×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ××•×›×”", "appointment_type": "×¡×•×’ ×ª×•×¨ ××• null", "appointment_scheduled": true/false}',
            "legal": '{"legal_area": "×ª×—×•× ××©×¤×˜×™ ××• null", "case_type": "×¡×•×’ ×ª×™×§ ××• null", "urgency": "×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ××•×›×”", "consultation_scheduled": true/false}',
            "general": '{"request_type": "×¡×•×’ ×‘×§×©×” ××• null", "details": "×¤×¨×˜×™× ×¢×™×§×¨×™×™× ××• null", "urgency": "×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ××•×›×”", "meeting_scheduled": true/false}'
        }
        
        json_template = extraction_templates.get(normalized_type, extraction_templates["general"])
        
        prompt = f"""×—×œ×¥ ××™×“×¢ ××”×©×™×—×” ×”×‘××”:

×ª××œ×•×œ:
{transcription}

×”×—×–×¨ JSON ×‘×¤×•×¨××˜:
{json_template}
"""
        
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": f"××ª×” ××•××—×” ×œ×—×™×œ×•×¥ ××™×“×¢ ××ª×—×•× {normalized_type}. ×”×—×–×¨ ×¨×§ JSON ×ª×§×™×Ÿ."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=150,
            temperature=0.1
        )
        
        import json
        result = json.loads(response.choices[0].message.content)
        log.info(f"âœ… Lead info extracted ({normalized_type}): {result}")
        return result
        
    except Exception as e:
        log.error(f"âŒ Lead info extraction failed: {e}")
        return {}


def get_available_business_types() -> list:
    """Return list of available business types for UI"""
    return list(BUSINESS_SUMMARY_TEMPLATES.keys())
