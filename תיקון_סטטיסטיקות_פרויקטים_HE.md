# ΧΧ™Χ§Χ•Χ Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ Χ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ - ΧΧ™ΧΧ•Χ ΧΧΧ

## Χ΅Χ™Χ›Χ•Χ Χ”Χ‘ΧΆΧ™Χ”
Χ©Χ™Χ—Χ•Χ Χ©Χ”Χ•Χ¤ΧΆΧΧ• ΧΧΧ•Χ Χ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ ΧΧ Χ©Χ•Χ™Χ™Χ›Χ• ΧΦΎ`project_id` Χ‘ΧΧ΅Χ“ Χ”Χ ΧΧ•Χ Χ™Χ, Χ•Χ›ΧΧ•Χ¦ΧΧ” ΧΧ›Χ Χ”Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ Χ©Χ Χ”Χ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ Χ”Χ™Χ• Χ¨Χ™Χ§Χ•Χ ΧΧ• Χ©Χ’Χ•Χ™Χ•Χ.

## β… Χ”Χ¤ΧΧ¨Χ•Χ Χ”ΧΧΧ

### 1. ΧΧ΅Χ“ Χ ΧΧ•Χ Χ™Χ - ΧΧ™Χ’Χ¨Χ¦Χ™Χ•Χ Χ§Χ™Χ™ΧΧ•Χ

**ΧΧ™Χ’Χ¨Χ¦Χ™Χ” 54**: Χ™Χ¦Χ™Χ¨Χ ΧΧ‘ΧΧΧ•Χ Χ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ
- ΧΧ‘ΧΧ `outbound_projects` ΧΆΧ Χ©Χ“Χ•Χ: id, tenant_id, name, description, status, timestamps
- ΧΧ‘ΧΧ `project_leads` - Χ—Χ™Χ‘Χ•Χ¨ Χ‘Χ™Χ Χ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ ΧΧΧ™Χ“Χ™Χ
- ΧΧ™Χ Χ“Χ§Χ΅Χ™Χ ΧΆΧ tenant_id Χ•ΦΎstatus

**ΧΧ™Χ’Χ¨Χ¦Χ™Χ” 54b**: ΧΧΆΧ§Χ‘ ΧΧ—Χ¨ Χ©Χ™Χ—Χ•Χ Χ‘Χ¤Χ¨Χ•Χ™Χ§Χ
```sql
ALTER TABLE call_log ADD COLUMN project_id INTEGER REFERENCES outbound_projects(id) ON DELETE SET NULL;
CREATE INDEX ix_call_log_project_id ON call_log(project_id);
```

**ΧΧ™Χ’Χ¨Χ¦Χ™Χ” 54c**: ΧΧΆΧ§Χ‘ ΧΧ—Χ¨ ΧΧ©Χ™ΧΧ•Χ bulk Χ‘Χ¤Χ¨Χ•Χ™Χ§Χ
```sql
ALTER TABLE outbound_call_jobs ADD COLUMN project_id INTEGER REFERENCES outbound_projects(id) ON DELETE SET NULL;
CREATE INDEX ix_outbound_call_jobs_project_id ON outbound_call_jobs(project_id);
```

### 2. Backend - Χ©Χ™Χ Χ•Χ™Χ™Χ Χ‘ΧΧ•Χ“ΧΧ™Χ Χ•Χ‘ΦΎAPI

#### ΧΧ•Χ“ΧΧ™Χ (`server/models_sql.py`)
- β… Χ”Χ•Χ΅Χ¤Χ `CallLog.project_id`
- β… Χ”Χ•Χ΅Χ¤Χ `OutboundCallJob.project_id`

#### Χ¤Χ•Χ Χ§Χ¦Χ™Χ•Χ ΧΆΧ–Χ¨
- β… `_validate_project_access()` - Χ•ΧΧ™Χ“Χ¦Χ™Χ” Χ©Χ”Χ¤Χ¨Χ•Χ™Χ§Χ Χ§Χ™Χ™Χ Χ•Χ©Χ™Χ™Χ ΧΧΆΧ΅Χ§

#### Endpoints
- β… `POST /api/outbound_calls/start` - ΧΧ§Χ‘Χ project_id ΧΧ•Χ¤Χ¦Χ™Χ•Χ ΧΧ™
- β… `POST /api/outbound/bulk-enqueue` - ΧΧ§Χ‘Χ project_id ΧΧ•Χ¤Χ¦Χ™Χ•Χ ΧΧ™
- β… Χ›Χ Χ™Χ¦Χ™Χ¨Χ CallLog Χ©Χ•ΧΧ¨Χ ΧΧ Χ”ΦΎproject_id
- β… Worker Χ¨Χ§ΧΆ ΧΧΆΧΧ™Χ§ project_id ΧΦΎjob ΧΦΎCallLog

### 3. Frontend - Χ©ΧΧ™Χ—Χ project_id

#### Χ©Χ™Χ Χ•Χ™Χ™Χ Χ‘ΦΎ`OutboundCallsPage.tsx`
- β… Mutation ΧΧ§Χ‘Χ `project_id?: number`
- β… Χ©Χ•ΧΧ— project_id Χ’Χ ΧΦΎbulk-enqueue Χ•Χ’Χ ΧΦΎstart
- β… ProjectDetailView ΧΆΧ•Χ‘Χ¨ ΧΧ selectedProjectId

### 4. Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ - Χ›Χ‘Χ¨ ΧΧ΅Χ•Χ Χ Χ Χ›Χ•Χ

```sql
SELECT COUNT(*), SUM(duration), ...
FROM call_log
WHERE project_id = :project_id AND direction = 'outbound'
```

## π― ΧΧ¨Χ—Χ™Χ©Χ™Χ Χ©Χ Χ‘Χ“Χ§Χ•

### ΧΧ¨Χ—Χ™Χ© 1: Χ©Χ™Χ—Χ•Χ Χ™Χ©Χ™Χ¨Χ•Χ (1-3 ΧΧ™Χ“Χ™Χ)
```
ΧΧ©ΧΧΧ© Χ‘Χ•Χ—Χ¨ 2 ΧΧ™Χ“Χ™Χ Χ‘Χ¤Χ¨Χ•Χ™Χ§Χ β†’ ΧΧ•Χ—Χ¥ "Χ”Χ¤ΧΆΧ Χ©Χ™Χ—Χ•Χ"
β†“
Frontend Χ©Χ•ΧΧ—: { lead_ids: [1,2], project_id: 123 }
β†“
Backend Χ™Χ•Χ¦Χ¨ CallLog ΧΆΧ project_id=123
β†“
Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ ΧΧ¨ΧΧ•Χ 2 Χ©Χ™Χ—Χ•Χ Χ‘Χ¤Χ¨Χ•Χ™Χ§Χ β…
```

### ΧΧ¨Χ—Χ™Χ© 2: Χ©Χ™Χ—Χ•Χ Bulk (Χ™Χ•ΧΧ¨ ΧΦΎ3 ΧΧ™Χ“Χ™Χ)
```
ΧΧ©ΧΧΧ© Χ‘Χ•Χ—Χ¨ 50 ΧΧ™Χ“Χ™Χ Χ‘Χ¤Χ¨Χ•Χ™Χ§Χ β†’ ΧΧ•Χ—Χ¥ "Χ”Χ¤ΧΆΧ Χ©Χ™Χ—Χ•Χ"
β†“
Frontend Χ©Χ•ΧΧ—: { lead_ids: [1..50], project_id: 123 }
β†“
Backend Χ™Χ•Χ¦Χ¨ 50 OutboundCallJob ΧΆΧ project_id=123
β†“
Worker Χ¨Χ§ΧΆ Χ™Χ•Χ¦Χ¨ CallLog ΧΧ›Χ ΧΧ©Χ™ΧΧ” Χ•ΧΧΆΧΧ™Χ§ ΧΧ project_id
β†“
Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ ΧΧ¨ΧΧ•Χ 50 Χ©Χ™Χ—Χ•Χ Χ‘Χ¤Χ¨Χ•Χ™Χ§Χ β…
```

### ΧΧ¨Χ—Χ™Χ© 3: Χ©Χ™Χ—Χ•Χ ΧΧΧ Χ¤Χ¨Χ•Χ™Χ§Χ
```
ΧΧ©ΧΧΧ© ΧΧ¤ΧΆΧ™Χ Χ©Χ™Χ—Χ•Χ ΧΧΧΧ‘ "ΧΧ™Χ“Χ™Χ" (ΧΧ ΧΧ¤Χ¨Χ•Χ™Χ§Χ)
β†“
Frontend ΧΧ Χ©Χ•ΧΧ— project_id
β†“
CallLog Χ Χ•Χ¦Χ¨ ΧΆΧ project_id=NULL
β†“
Χ”Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ Χ©Χ Χ”Χ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ ΧΧ Χ›Χ•ΧΧΧ•Χ ΧΧ Χ”Χ©Χ™Χ—Χ•Χ Χ”ΧΧΧ” β…
```

## π”’ ΧΧ‘ΧΧ—Χ”

### Χ•ΧΧ™Χ“Χ¦Χ™Χ•Χ
- β… **Χ‘Χ™Χ“Χ•Χ“ tenant**: Χ›Χ query Χ‘Χ•Χ“Χ§ `tenant_id = :tenant_id`
- β… **Χ‘ΧΆΧΧ•Χ ΧΆΧ Χ¤Χ¨Χ•Χ™Χ§Χ**: ΧΧ•Χ•Χ“Χ Χ©Χ”Χ¤Χ¨Χ•Χ™Χ§Χ Χ©Χ™Χ™Χ ΧΦΎtenant ΧΧ¤Χ Χ™ Χ§Χ‘ΧΧ Χ©Χ™Χ—Χ•Χ
- β… **Χ©Χ“Χ” ΧΧ•Χ¤Χ¦Χ™Χ•Χ ΧΧ™**: project_id ΧΧ Χ—Χ•Χ‘Χ” - Χ©Χ™Χ—Χ•Χ ΧΧΧ Χ¤Χ¨Χ•Χ™Χ§Χ ΧΆΧ•Χ‘Χ“Χ•Χ Χ¨Χ’Χ™Χ
- β… **NULL Χ‘ΧΧ•Χ—**: Χ©Χ™ΧΧ•Χ© Χ‘ΦΎ`ON DELETE SET NULL` ΧΦΎforeign key
- β… **Χ”Χ’Χ Χ” ΧΦΎSQL Injection**: Χ©Χ™ΧΧ•Χ© Χ‘ΦΎparameterized queries

### CodeQL
- β… **0 Χ¤Χ¨Χ¦Χ•Χ ΧΧ‘ΧΧ—Χ”**: Χ‘Χ“Χ™Χ§Χ” ΧΧ•ΧΧ•ΧΧΧ™Χ ΧΧ ΧΧ¦ΧΧ” Χ‘ΧΆΧ™Χ•Χ

## π“‹ Χ‘Χ“Χ™Χ§Χ•Χ Χ™Χ“Χ Χ™Χ•Χ

### Χ”Χ›Χ Χ”
```bash
cd /home/runner/work/prosaasil/prosaasil
python -m server.db_migrate
```

### 1. Χ¦Χ•Χ¨ Χ¤Χ¨Χ•Χ™Χ§Χ Χ—Χ“Χ©
- ΧΆΧ‘Χ•Χ¨ ΧΧΧΧ‘ "Χ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ"
- ΧΧ—Χ¥ "Χ¤Χ¨Χ•Χ™Χ§Χ Χ—Χ“Χ©"
- Χ”Χ–Χ Χ©Χ Χ•ΧΧ™ΧΧ•Χ¨
- Χ”Χ•Χ΅Χ£ ΧΧ™Χ“Χ™Χ ΧΧ¤Χ¨Χ•Χ™Χ§Χ

### 2. Χ‘Χ¦ΧΆ 2 Χ©Χ™Χ—Χ•Χ Χ™Χ©Χ™Χ¨Χ•Χ
- Χ‘Χ—Χ¨ 2 ΧΧ™Χ“Χ™Χ Χ‘Χ¤Χ¨Χ•Χ™Χ§Χ
- ΧΧ—Χ¥ "Χ”Χ¤ΧΆΧ Χ©Χ™Χ—Χ•Χ"
- Χ‘Χ“Χ•Χ§ Χ‘ΦΎDB:
```sql
SELECT project_id FROM call_log WHERE lead_id IN (X, Y);
-- Χ¦Χ¨Χ™Χ ΧΧ”Χ—Χ–Χ™Χ¨ ΧΧ Χ”ΦΎID Χ©Χ Χ”Χ¤Χ¨Χ•Χ™Χ§Χ
```

### 3. Χ¨ΧΆΧ Χ ΧΧ Χ“Χ£ Χ”Χ¤Χ¨Χ•Χ™Χ§Χ
- ΧΧ¨ΧΧ”: `total_calls=2`
- ΧΧ¨ΧΧ” Χ—ΧΧ•Χ§Χ”: answered, no_answer, failed
- ΧΧ¨ΧΧ”: avg_duration

### 4. Χ‘Χ¦ΧΆ Χ©Χ™Χ—Χ” ΧΧ—Χ•Χ¥ ΧΧ¤Χ¨Χ•Χ™Χ§Χ
- ΧΆΧ‘Χ•Χ¨ ΧΧΧΧ‘ "ΧΧ™Χ“Χ™Χ"
- Χ‘Χ—Χ¨ ΧΧ™Χ“
- Χ”Χ¤ΧΆΧ Χ©Χ™Χ—Χ”
- Χ‘Χ“Χ•Χ§ Χ‘ΦΎDB:
```sql
SELECT project_id FROM call_log WHERE lead_id = Z;
-- Χ¦Χ¨Χ™Χ ΧΧ”Χ—Χ–Χ™Χ¨ NULL
```
- Χ•Χ•Χ“Χ Χ©Χ”Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ Χ©Χ Χ”Χ¤Χ¨Χ•Χ™Χ§Χ ΧΧ Χ”Χ©ΧΧ Χ•

### 5. Χ‘Χ“Χ™Χ§Χ Bulk (Χ™Χ•ΧΧ¨ ΧΦΎ3 ΧΧ™Χ“Χ™Χ)
- Χ‘Χ—Χ¨ 5+ ΧΧ™Χ“Χ™Χ Χ‘Χ¤Χ¨Χ•Χ™Χ§Χ
- ΧΧ—Χ¥ "Χ”Χ¤ΧΆΧ Χ©Χ™Χ—Χ•Χ"
- Χ‘Χ“Χ•Χ§ Χ‘ΦΎDB:
```sql
SELECT project_id FROM outbound_call_jobs 
WHERE lead_id IN (...) 
ORDER BY created_at DESC LIMIT 10;
-- Χ›Χ Χ”Χ©Χ•Χ¨Χ•Χ Χ¦Χ¨Χ™Χ›Χ•Χ ΧΧ”Χ™Χ•Χ ΧΆΧ project_id Χ©Χ Χ”Χ¤Χ¨Χ•Χ™Χ§Χ
```

## β… Χ΅ΧΧΧ•Χ΅ Χ΅Χ•Χ¤Χ™

### ΧΧ” ΧΆΧ•Χ‘Χ“ ΧΆΧ›Χ©Χ™Χ•
1. β… Χ©Χ™Χ—Χ•Χ ΧΧ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ Χ Χ©ΧΧ¨Χ•Χ ΧΆΧ `project_id` Χ‘ΧΧ΅Χ“ Χ”Χ ΧΧ•Χ Χ™Χ
2. β… Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ Χ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ ΧΧ¨ΧΧ•Χ ΧΧ΅Χ¤Χ¨Χ™Χ ΧΧ“Χ•Χ™Χ§Χ™Χ
3. β… Χ©Χ™Χ—Χ•Χ bulk ΧΧΧΆΧ“Χ•Χ Χ Χ›Χ•Χ ΧΧ Χ”ΦΎproject_id
4. β… Χ•ΧΧ™Χ“Χ¦Χ™Χ” ΧΧ•Χ ΧΆΧ Χ’Χ™Χ©Χ” ΧΧ¤Χ¨Χ•Χ™Χ§ΧΧ™Χ ΧΧ ΧΧ§Χ™Χ Χ™Χ
5. β… ΧΧΧ™ΧΧ•Χ ΧΧΧ—Χ•Χ¨ - Χ©Χ™Χ—Χ•Χ ΧΧΧ Χ¤Χ¨Χ•Χ™Χ§Χ ΧΆΧ•Χ‘Χ“Χ•Χ Χ›Χ¨Χ’Χ™Χ

### Χ§Χ‘Χ¦Χ™Χ Χ©Χ©Χ•Χ Χ•
- β… `server/models_sql.py` - Χ”Χ•Χ΅Χ¤Χ project_id ΧΧΧ•Χ“ΧΧ™Χ
- β… `server/routes_outbound.py` - Χ§Χ‘ΧΧ”, Χ•ΧΧ™Χ“Χ¦Χ™Χ” Χ•Χ©ΧΧ™Χ¨Χ” Χ©Χ project_id
- β… `client/src/pages/calls/OutboundCallsPage.tsx` - Χ©ΧΧ™Χ—Χ project_id ΧΧ”ΦΎfrontend

### ΧΧ™Χ’Χ¨Χ¦Χ™Χ•Χ
- β… **Χ›Χ‘Χ¨ Χ§Χ™Χ™ΧΧ•Χ Χ‘ΧΧΆΧ¨Χ›Χ** - Migration 54, 54b, 54c
- β… **idempotent** - Χ‘ΧΧ•Χ— ΧΧ”Χ¨Χ™Χ¥ Χ›ΧΧ” Χ¤ΧΆΧΧ™Χ
- β… **ΧΧ•ΧΧ•ΧΧΧ™Χ•Χ** - Χ Χ‘Χ“Χ§Χ•Χ Χ•ΧΧ•Χ¤ΧΆΧΧ•Χ ΧΧ¤Χ™ Χ”Χ¦Χ•Χ¨Χ

## π‰ Χ΅Χ™Χ›Χ•Χ

Χ”Χ‘ΧΆΧ™Χ” Χ Χ¤ΧΧ¨Χ” Χ‘ΧΧ•Χ¤Χ ΧΧΧ:
- ΧΧ™Χ’Χ¨Χ¦Χ™Χ•Χ Χ§Χ™Χ™ΧΧ•Χ Χ•ΧΧ§Χ™Χ Χ•Χ β…
- Backend ΧΧΧ¤Χ Χ‘ΦΎproject_id Χ Χ›Χ•Χ β…
- Frontend Χ©Χ•ΧΧ— project_id Χ›Χ©Χ¦Χ¨Χ™Χ β…
- Χ΅ΧΧΧ™Χ΅ΧΧ™Χ§Χ•Χ ΧΧ΅Χ•Χ Χ Χ•Χ Χ Χ›Χ•Χ β…
- ΧΧ‘ΧΧ—Χ” Χ‘Χ“Χ•Χ§Χ” β…

**Χ”ΧΧΆΧ¨Χ›Χ ΧΧ•Χ›Χ Χ” ΧΧ©Χ™ΧΧ•Χ©!**
