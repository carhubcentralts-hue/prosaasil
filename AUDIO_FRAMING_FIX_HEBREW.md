# תיקון "דיבור מהיר" - סיכום בעברית

## הבעיה

הדיבור של ה-AI נשמע "מהיר" או כמו "צ'יפמאנק" במהלך שיחות טלפון. ניתוח הלוגים גילה 3 בעיות קריטיות:

1. **TX לא יציב** - רק 6 פריימים בשנייה עם גאפים של ~903ms שגורמים לאודיו להגיע ב"בַּרְסְטִים"
2. **התור כמעט תמיד על הקצה** - q=249/250 פריימים, על סף קריסה
3. **נפילות פריימים בפועל** - 134 פריימים נזרקו, מה שמקצר משפטים וגורם לדיבור להישמע מהר יותר

## הפתרון שהוטמע

### משימה A: Audio Framer (מסגרר אודיו)

**מה זה עושה**: הופך דלתות בגודל משתנה מ-OpenAI לפריימים קבועים של 160 בייט (20ms @ 8kHz μ-law).

**איך זה עובד**:
1. הוספנו באפר `_ai_audio_buf` שאוסף בייטים נכנסים
2. בלולאת האודיו, אנחנו:
   - מצטברים דלתות בגודל משתנה לתוך הבאפר
   - מוציאים פריימים קבועים של 160 בייט
   - שולחים רק פריימים בגודל נכון ל-TX loop
3. מנקים שאריות כשהאודיו מסתיים

**תוצאה**: כל פריים ש-TX loop מקבל הוא בדיוק 160 בייט = 20ms של אודיו

### משימה B: Clocked Sender (שולח עם שעון)

**מה זה עושה**: שולח פריימים בדיוק כל 20ms, מונע ברסטים וגאפים.

**איך זה עובד**:
1. מעקב אחרי `next_send` deadline עם `time.monotonic()`
2. Sleep עד ה-deadline לפני שליחת כל פריים
3. מתקדמים את ה-deadline ב-20ms אחרי כל שליחה
4. מאפסים את השעון כשהתור ריק (מונע drift)

**תוצאה**: אודיו נשלח בדיוק ב-50fps (פריים אחד כל 20ms), אף פעם לא יותר מהר

### משימה C: הפסקת זריקת פריימים

**מה זה עושה**: מגדיל את התור ומונע זריקת פריימים.

**איך זה עובד**:
1. הגדלת `tx_q` מ-250 ל-1000 פריימים (20 שניות באפר)
2. הסרת לוגיקת זריקת פריימים - רק אזהרות ב-50% watermark
3. שימוש ב-blocking put עם timeout כמוצא אחרון (מונע זריקות)

**תוצאה**: באפר של 20 שניות סופג jitter, פריימים נזרקים רק במקרים פתולוגיים קיצוניים

### משימה D: הפחתת לוגים per-frame

**סטטוס**: כבר מיושם בקוד הקיים

הקוד כבר מתעד רק פעם בשנייה ורק כאשר:
- התור >50% מלא, או
- גאפים בין פריימים >40ms

**תוצאה**: אין עלות logging per-frame, השפעה מינימלית על ביצועים

## קריטריוני הצלחה

אחרי התיקון, הלוגים צריכים להראות:

✅ `frames_dropped = 0` לאורך כל השיחה
✅ `TX_METRICS fps` יציב ~50fps
✅ `max_gap_ms` קטן (20-40ms), לא 903ms
✅ `q=` אף פעם לא נוגע בקצה (לא 249/250)
✅ "דיבור מהיר/צ'יפמאנק/הילוך מהיר" נעלם

## איך לבדוק

### 1. בדיקת איכות שמע

התקשר למספר הטסט והקשב:
- האם ה-AI נשמע טבעי? (לא מהיר/צ'יפמאנק)
- האם יש נפילות או קטיעות באודיו?
- האם ה-barge-in עובד חלק?

### 2. בדיקת לוגים - TX Metrics

חפש בלוגים: `[TX_METRICS]`

מה לחפש:
- ✅ `frames` ≈ 50 לשנייה
- ✅ `fps` ≈ 50.0 באופן עקבי
- ✅ `max_gap_ms` בדרך כלל 20-35ms (לעולם לא >100ms)
- ✅ `q` (גודל תור) נשאר הרבה מתחת ל-500

דוגמה טובה:
```
[TX_METRICS] last_1s: frames=50, fps=50.0, max_gap_ms=22.5, q=45/1000
```

### 3. בדיקת לוגים - Frame Drops

חפש: `frames_dropped` או `[AUDIO DROP]` או `[AUDIO CRITICAL]`

תוצאות צפויות:
- ✅ אין הודעות `[AUDIO DROP]`
- ✅ אין הודעות `[AUDIO CRITICAL]`
- ✅ אם יש מטריקות, `frames_dropped=0`

### 4. מטריקות סוף שיחה

חפש: `[CALL_METRICS]`

מה לבדוק:
- ✅ `frames_dropped=0` (הכי חשוב!)
- ✅ `frames_forwarded` ≈ `frames_in`
- ✅ מטריקות שיחה סבירות

## Baseline לביצועים

### לפני התיקון (דוח הבאג)
- fps: 6 פריימים/שנייה
- max_gap_ms: 903ms
- Queue: 249/250 (99% מלא)
- frames_dropped: 134

### אחרי התיקון (יעד)
- fps: 50 פריימים/שנייה
- max_gap_ms: <40ms (בדרך כלל 20-35ms)
- Queue: <500/1000 (מקסימום 50%)
- frames_dropped: 0

### שיפור
- **פי 8** יותר פריימים לשנייה
- **פי 23** הפחתה בגאפ מקסימלי
- **פי 4** יותר קיבולת באפר
- **100%** הפחתה בפריימים שנזרקו

## מה הלאה?

1. **פרוס לסביבת טסט**
2. **בצע שיחת טסט** ובדוק שהאודיו נשמע טבעי
3. **בדוק לוגים** לפי המדדים למעלה
4. **אם הכל עובד** - פרוס לפרודקשן
5. **עקוב אחרי המדדים** בשיחות הראשונות

## קבצים ששונו

- `server/media_ws_ai.py` - הקובץ המרכזי עם כל התיקונים
- `AUDIO_FRAMING_FIX_SUMMARY.md` - סיכום מפורט באנגלית
- `AUDIO_FRAMING_TESTING_GUIDE.md` - מדריך בדיקות מפורט
- `AUDIO_FRAMING_FIX_HEBREW.md` - סיכום זה בעברית

## תמיכה

אם יש בעיות או שאלות:
1. בדוק את `AUDIO_FRAMING_TESTING_GUIDE.md` למדריך בדיקות מפורט
2. בדוק את `AUDIO_FRAMING_FIX_SUMMARY.md` לפרטים טכניים
3. חפש בלוגים את הדפוסים שתוארו למעלה

---

**הערה**: התיקון הזה לא משנה API, לא דורש שינויי תצורה, ותואם לאחור לחלוטין. זה רק משפר את timing ו-framing של האודיו.
