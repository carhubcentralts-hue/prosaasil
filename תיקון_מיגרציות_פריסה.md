# תיקון מיגרציות בסיס נתונים - מדריך פריסה

## סיכום הבעיה
הלוגים של הבקאנד הראו שתי שגיאות בסיס נתונים:
1. עמודה `appointments.call_transcript` לא קיימת
2. עמודה `whatsapp_broadcasts.idempotency_key` לא קיימת

## הפתרון
הוספנו שתי מיגרציות חדשות ל-`server/db_migrate.py`:
- **מיגרציה 48**: מוסיפה עמודת `call_transcript` לטבלת `appointments`
- **מיגרציה 49**: מוסיפה עמודת `idempotency_key` לטבלת `whatsapp_broadcasts` עם אינדקס

## איך להריץ את המיגרציות

### אופציה 1: אוטומטי (מומלץ)
המיגרציות ירוצו אוטומטית כאשר הבקאנד מתחיל. פשוט תפעיל מחדש את הקונטיינר:

```bash
docker-compose restart backend
```

או אם רץ ידנית:
```bash
python run_server.py
```

### אופציה 2: הרצה ידנית
הרץ מיגרציות באופן מפורש לפני הפעלת השרת:

```bash
# באמצעות סקריפט המיגרציה
./run_migrations.sh

# או באמצעות מודול Python ישירות
export MIGRATION_MODE=1
export ASYNC_LOG_QUEUE=0
python -m server.db_migrate
```

### אופציה 3: דוקר קונטיינר
אם הבקאנד כבר רץ בדוקר:

```bash
docker exec prosaas-backend python -m server.db_migrate
```

## אימות

אחרי הרצת המיגרציות, אמת שהעמודות קיימות:

```sql
-- בדוק טבלת appointments
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'appointments' 
AND column_name = 'call_transcript';

-- בדוק טבלת whatsapp_broadcasts
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'whatsapp_broadcasts' 
AND column_name = 'idempotency_key';

-- בדוק שהאינדקס נוצר
SELECT indexname 
FROM pg_indexes 
WHERE tablename = 'whatsapp_broadcasts' 
AND indexname = 'idx_wa_broadcast_idempotency';
```

תוצאות צפויות:
- `appointments.call_transcript` צריך להיות מסוג TEXT
- `whatsapp_broadcasts.idempotency_key` צריך להיות מסוג VARCHAR(64)
- אינדקס `idx_wa_broadcast_idempotency` צריך להיות קיים

## בטיחות המיגרציות

שתי המיגרציות הן **אידמפוטנטיות** - בטוחות להרצה מספר פעמים:
- הן בודקות אם העמודות קיימות לפני הוספתן
- הן משתמשות בטיפול נכון בטרנזקציות עם rollback במקרה של שגיאה
- הן יוצרות אינדקסים עם `IF NOT EXISTS`

## בדיקות

הרץ את חבילת הבדיקות לאימות המיגרציות:

```bash
python test_migrations_48_49.py
```

פלט צפוי:
```
✅ All checks passed! Migrations 48 and 49 are correctly implemented.
```

## מה זה מתקן

### לפני
- עמוד היומן קרס עם שגיאת 500: "column appointments.call_transcript does not exist"
- שידורי WhatsApp נכשלו: "column whatsapp_broadcasts.idempotency_key does not exist"

### אחרי
- פגישות ביומן נטענות בהצלחה
- קמפיינים של שידורי WhatsApp עובדים כראוי עם מניעת כפילויות
- תמלולי שיחה מלאים יכולים להישמר עם פגישות

## הערות נוספות

### לגבי שגיאת 403
שגיאת 403 עבור `/api/admin/businesses` היא **התנהגות צפויה**:
- מסלול זה מוגבל לתפקיד `system_admin` בלבד
- משתמשים עם תפקיד `owner` לא יכולים לגשת לרשימה הגלובלית של כל העסקים
- זו תכונת אבטחה, לא באג
- אם קומפוננט בפרונטאנד מנסה לגשת למסלול זה עם תפקיד שאינו admin, הוא צריך:
  - לבדוק את תפקיד המשתמש קודם ולהסתיר את הקומפוננט
  - או לטפל בשגיאת 403 בצורה עדינה ולהציג הודעה מתאימה

### פרטי המיגרציות

**מיגרציה 48: תמליל שיחה בפגישות**
- מוסיפה עמודת `call_transcript TEXT` לטבלת `appointments`
- שומרת תמליל שיחה מלא משיחות שיוצרות פגישות
- משלימה את `call_summary` שמאחסנת סיכום שנוצר על ידי AI

**מיגרציה 49: אידמפוטנטיות של שידורי WhatsApp**
- מוסיפה עמודת `idempotency_key VARCHAR(64)` לטבלת `whatsapp_broadcasts`
- יוצרת אינדקס `idx_wa_broadcast_idempotency` לחיפושים יעילים
- מונעת יצירת קמפיינים כפולים של שידורים

## ביטול (אם נדרש)

אם אתה צריך לבטל את המיגרציות האלה (לא מומלץ):

```sql
-- הסר מיגרציה 49
DROP INDEX IF EXISTS idx_wa_broadcast_idempotency;
ALTER TABLE whatsapp_broadcasts DROP COLUMN IF EXISTS idempotency_key;

-- הסר מיגרציה 48
ALTER TABLE appointments DROP COLUMN IF EXISTS call_transcript;
```

## צעדים הבאים

אחרי הפריסה:
1. ✅ אמת שהמיגרציות רצו בהצלחה (בדוק לוגים עבור "Migration 48" ו-"Migration 49")
2. ✅ בדוק שעמוד היומן נטען ללא שגיאות
3. ✅ בדוק שיצירת שידור WhatsApp עובדת
4. ✅ עקוב אחר הלוגים לאיתור שגיאות קשורות לבסיס הנתונים
