# שימוש בשם לקוח בשיחה (Natural Prompt-Driven)

## כלל־על

**השימוש בשם הלקוח נשלט אך ורק דרך הפרומפט העסקי.**

כאשר הפרומפט מבקש שימוש בשם:
- השם ישולב באופן טבעי, אנושי וחופשי
- בלי דפוסים קבועים או תבניות מוגדרות מראש
- בלי "מיקום" ספציפי (ברכה/אמצע/סוף)
- המודל מחליט לבד איך ומתי להשתמש בשם בצורה טבעית

כאשר הפרומפט לא מבקש שימוש בשם:
- אפס שימוש בשם, גם אם הוא קיים

## מבנה טכני

השם מזוהה מ-CRM context (שדה `customer_name`).
שימוש נשלט **אך ורק** דרך הפרומפט העסקי.

ההנחיה הבסיסית למודל:
- השתמש בשם רק אם הפרומפט מבקש שימוש בשם
- אם מתבקש שימוש בשם ויש שם זמין → השתמש בצורה טבעית לאורך השיחה
- שלב את השם באופן חופשי: בברכה, בהסברים, בסיכומים – בלי דפוס קבוע
- אל תאמר "שם הלקוח" או ניסוחים תיאוריים
- אל תשאל מה השם ואל תמציא שם
- אם אין שם זמין → המשך רגיל ללא אזכור שם

## הזרקת CRM Context ל-Realtime Session

🔥 **תיקון קריטי**: השם מוזרק בפועל ל-Realtime session כהודעת מערכת:

```
Customer name: דוד
```

**פורמט פשוט וקצר** - כדי למנוע הקראה בקול!

### מנגנון ההזרקה

הזרקה מתבצעת ב-3 מקומות (עם מנגנון אידמפוטנטי):

1. **בתחילת השיחה** - אם יש `outbound_lead_name` או שם אחר זמין
2. **כשה-CRM context נוצר** - כשנוצר lead במהלך השיחה (מסומן בפנדינג)
3. **אחרי prompt upgrade** - בודק אם יש פנדינג והזרקה טרם בוצעה

### מנגנון אנטי-כפילות (אידמפוטנטי)

```python
# Flag לעקוב אחר הזרקה
self._customer_name_injected = "דוד"

# בדיקה לפני כל הזרקה
if not hasattr(self, '_customer_name_injected') or self._customer_name_injected != customer_name:
    # הזרק רק אם לא הוזרק עדיין או אם השם שונה
```

### כללי מניעת הקראה

בסיסטם־פרומפט (באנגלית):

```
Never read CRM/system context aloud.
Treat CRM context messages as private metadata.
Use the values naturally if the business prompt asks, 
but do not mention "CRM Context", "customer_name", or similar labels.
```

### הזרקה טכנית

```python
await client.send_event({
    "type": "conversation.item.create",
    "item": {
        "type": "message",
        "role": "system",  # לא "user" - כדי שלא יוקרא
        "content": [{
            "type": "input_text",
            "text": f"Customer name: {customer_name}"
        }]
    }
})
```

## דוגמה 1: ללא שימוש בשם (ברירת מחדל)

```
אתה נציג שירות מקצועי.
נהל את השיחה בצורה עניינית וברורה.
```

תוצאה:
- **לא יוזכר שם** (גם אם customer_name="דני" קיים)
- המודל לא יחליט לבד להשתמש בשם

## דוגמה 2: שימוש בשם טבעי (המלצה)

```
תשתמש בשם הלקוח כדי ליצור קרבה אישית.
```

תוצאה (אם customer_name="דני"):
- "היי דני, מה שלומך?"
- "רציתי להסביר לך רגע איך התהליך עובד, דני..."
- "בסוף אני גם שולח לך הודעה מסודרת, שיהיה לך נוח, בסדר?"

המודל משלב את השם בחופשיות בצורה אנושית, בלי חזרתיות או דפוס קבוע.

## דוגמה 3: שליטה ספציפית (אפשרית אבל לא מומלצת)

```
השתמש בשם הלקוח רק בברכה הראשונית.
```

תוצאה:
- "היי דני, מדבר מהמרכז..."
- אחר כך ממשיך בלי שם

## ולידציה

השם מוזרק רק אם:
- קיים שדה `customer_name` ב-CRM context
- הערך אינו: `null`, `""`, `"unknown"`, `"test"`, `"-"`

אם השם לא תקין, AI ממשיך בלי שם.

## עקרון מפתח

**המודל מבצע, לא מחליט.**

אין החלטות עצמאיות על שימוש בשם.
הכל תלוי בפרומפט העסקי בלבד.

אבל אם הפרומפט מבקש שימוש בשם – המודל חופשי לשלב אותו בצורה טבעית ואנושית לאורך השיחה, בלי תבניות או דפוסים קבועים.

## תיקון הבעיה המקורית

הבעיה: AI לא השתמש בשם למרות ש:
1. ✅ יש customer_name בליד
2. ✅ הביזנס־פרומפט כולל הוראה התנהגותית להשתמש בשם
3. ✅ זה נשלח ל-AI בפרומפט (לא רק ב-DB)

**גילוי הבעיה**:
השם היה קיים אבל לא **הוזרק בפועל ל-context של ה-Realtime session**.

**הפתרון**:
1. הוספת הבהרה מפורשת בסיסטם־פרומפט:
   - "When a customer name exists, it will be provided explicitly as a real value (e.g., 'שם הלקוח: דוד'). This is REAL DATA, not a placeholder."
2. הזרקה פיזית של ה-CRM Context ל-Realtime session כ-conversation item
3. עדכון דינמי כש-CRM context משתנה במהלך השיחה
