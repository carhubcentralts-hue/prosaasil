# תיקון בעיית מיגרציות - לוח שנה והודעות מתוזמנות

## הבעיה שזוהתה

השרת מדווח על שגיאה:
```
column appointments.calendar_id does not exist
```

**הסיבה**: מיגרציות 115, 116, 117 לא התבצעו בבסיס הנתונים.

## מה המיגרציות האלו עושות?

### מיגרציה 115: מערכת לוחות שנה עסקיים
- ✅ יוצרת טבלה `business_calendars` - לניהול לוחות שנה מרובים
- ✅ יוצרת טבלה `calendar_routing_rules` - לניתוב חכם של פגישות
- ✅ מוסיפה עמודה `calendar_id` לטבלת `appointments`
- ✅ יוצרת לוח ברירת מחדל לכל עסק קיים
- ✅ מקשרת פגישות קיימות ללוח ברירת המחדל

### מיגרציה 116: מערכת הודעות WhatsApp מתוזמנות
- ✅ יוצרת טבלה `scheduled_message_rules` - כללי תזמון הודעות
- ✅ יוצרת טבלה `scheduled_rule_statuses` - קישור לסטטוסים
- ✅ יוצרת טבלה `scheduled_messages_queue` - תור הודעות לשליחה

### מיגרציה 117: הפעלת דף תזמון הודעות
- ✅ מוסיפה את הדף `scheduled_messages` ל-`enabled_pages` לעסקים עם WhatsApp

## למה המיגרציות לא רצו?

יכולות להיות מספר סיבות:
1. **השרת מוגדר כ-worker** - workers לא מריצים מיגרציות
2. **מיגרציות מושבתות** - משתנה סביבה `RUN_MIGRATIONS` לא מוגדר כ-1
3. **נעילת מיגרציה** - תהליך אחר החזיק את הנעילה
4. **שגיאת חיבור לבסיס נתונים** - בעיית תקשורת עם PostgreSQL

## הפתרון - 3 דרכים

### דרך 1: הרצת סקריפט המיגרציה הייעודי (מומלץ)

סקריפט שנוצר במיוחד להרצת מיגרציות 115-117:

```bash
cd /home/runner/work/prosaasil/prosaasil
python migration_run_115_116_117.py
```

הסקריפט:
- ✅ בודק אם המיגרציות כבר רצו
- ✅ מאלץ את המיגרציות לרוץ (עוקף חסימות)
- ✅ מדווח על התקדמות בזמן אמת
- ✅ מאמת שהכל עבד אחרי סיום

### דרך 2: הרצת כל המיגרציות דרך db_migrate.py

```bash
cd /home/runner/work/prosaasil/prosaasil
python -m server.db_migrate
```

זה מריץ את **כל** המיגרציות שעוד לא רצו (לא רק 115-117).

### דרך 3: הרצה מתוך דוקר (אם רץ בקונטיינר)

```bash
docker exec prosaasil-backend python migration_run_115_116_117.py
```

או:

```bash
docker exec prosaasil-backend python -m server.db_migrate
```

## אימות שהמיגרציות רצו

אחרי הרצת המיגרציות, בדוק:

### 1. בדיקה בלוגים
חפש בלוגים:
```
✅ Migration 115 complete: Business calendars and routing rules system added
✅ Migration 116 complete: Scheduled WhatsApp messages system added
✅ Migration 117 complete: 'scheduled_messages' page enabled for WhatsApp businesses
```

### 2. בדיקה בבסיס נתונים
התחבר ל-PostgreSQL ובדוק:

```sql
-- בדוק שהטבלאות קיימות
SELECT table_name FROM information_schema.tables 
WHERE table_name IN ('business_calendars', 'calendar_routing_rules', 
                     'scheduled_message_rules', 'scheduled_rule_statuses', 
                     'scheduled_messages_queue');

-- בדוק שהעמודה calendar_id קיימת
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'appointments' AND column_name = 'calendar_id';

-- בדוק שיש לוחות ברירת מחדל
SELECT business_id, name, type_key FROM business_calendars;

-- בדוק שעסקים עם WhatsApp קיבלו את הדף
SELECT id, name, enabled_pages::text 
FROM business 
WHERE enabled_pages::text LIKE '%scheduled_messages%';
```

### 3. בדיקה בממשק
1. התחבר למערכת
2. עבור לדף "תזמון הודעות WhatsApp"
3. הדף צריך להיטען ללא שגיאות
4. אפשר לראות את הרשימה של כללי תזמון

## מה קורה אחרי המיגרציות?

### לוח שנה
1. לכל עסק נוצר **לוח ברירת מחדל** אוטומטית
2. כל הפגישות הקיימות מקושרות ללוח זה
3. אפשר ליצור לוחות נוספים דרך ממשק הניהול
4. AI יכול לנתב פגישות ללוחות שונים לפי כללים

### הודעות מתוזמנות
1. הדף "תזמון הודעות WhatsApp" יופיע בתפריט
2. אפשר ליצור כללים לשליחת הודעות אוטומטיות
3. הכללים מתעדכנים לפי שינויי סטטוס של לידים
4. ההודעות נשלחות בחלונות זמן מוגדרים

## פתרון בעיות

### שגיאה: "DATABASE_URL not set"
```bash
export DATABASE_URL="postgresql://user:password@host:5432/database"
```

### שגיאה: "Could not acquire lock"
תהליך אחר מריץ מיגרציות. המתן 30 שניות ונסה שוב.

### שגיאה: "ModuleNotFoundError"
וודא שאתה מריץ מתוך סביבת Python הנכונה:
```bash
source .venv/bin/activate  # אם יש venv
```

### המיגרציות רצו אבל עדיין יש שגיאה
1. **אתחל את השרת** - השרת צריך לטעון את המודלים מחדש
2. **נקה cache** - אם יש Redis/cache, נקה אותו
3. **בדוק בלוגים** - חפש שגיאות נוספות

## הרצה אוטומטית בעתיד

המיגרציות אמורות לרוץ **אוטומטית** כשהשרת עולה.

כדי לוודא שזה עובד:
1. ודא ש-`RUN_MIGRATIONS=1` בקובץ `.env`
2. ודא ש-`SERVICE_ROLE` לא מוגדר כ-`worker` בשרת הראשי
3. בדוק בלוגים בעת הפעלת השרת

## קבצים שנוצרו

1. **migration_run_115_116_117.py** - סקריפט הרצה ייעודי למיגרציות אלו
2. **run_migrations_manual.py** - סקריפט כללי להרצת מיגרציות
3. **תיקון_מיגרציות_115_116_117.md** - תיעוד זה בעברית

## לסיכום

הבעיה: **appointments.calendar_id does not exist**
הפתרון: **הרץ מיגרציות 115-117**
הדרך הקלה: `python migration_run_115_116_117.py`

אחרי ההרצה:
- ✅ דף תזמון ההודעות יעבוד
- ✅ מערכת הלוחות תהיה פעילה
- ✅ כל השגיאות ייעלמו

---

**תאריך עדכון אחרון**: 2026-01-29  
**גרסת מיגרציה**: 115-117  
**סטטוס**: ✅ מוכן לשימוש
