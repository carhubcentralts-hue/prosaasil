# מיגרציה 75: הפרדת הערות שירות לקוחות AI מהערות חופשיות

## הבעיה המקורית

```
יש לי בעיה!! תעשה מיגרציה נוספת להערות החופשיות!! ההערות החופשיות והשירות לקוחות AI 
בדף ליד חופפים עם המידע, הוספתי הערה לשירות לקוחות AI וזה הוסיף אותה להערות החופשיות, 
וגם הפוך! תבדל בניהם!! ותוודא שהAI לוקחת מידע רק מהשירות לקוחות AI!!
```

**בקצרה:** הערות חופשיות והערות שירות לקוחות AI חופפות - הוספה לאחד מופיעה גם בשני! צריך להפריד ביניהם ולוודא שה-AI רואה רק את הערות שירות הלקוחות.

## הסיבה לבעיה

בעבר, שני הטאבים השתמשו באותו שדה `note_type='manual'` בטבלת `lead_notes`:

- **טאב שירות לקוחות AI**: הציג הערות עם `note_type IN ('call_summary', 'system', 'manual')` ללא קבצים
- **טאב הערות חופשיות**: הציג הערות עם `note_type='manual'` (עם או בלי קבצים)

זה יצר **חפיפה** - הערות ידניות ללא קבצים הופיעו בשני הטאבים!

## הפתרון: סוג הערה חדש `customer_service_ai`

הוספנו סוג הערה חדש במיוחד להקשר של שירות לקוחות AI:

### הגדרות סוגי ההערות

| סוג הערה | מטרה | נראה ל-AI | ניתן לעריכה | מיקום |
|---------|-------|-----------|-------------|--------|
| `call_summary` | סיכומי שיחות שנוצרו ע"י AI | ✅ כן | ❌ לא | טאב AI |
| `system` | הערות מערכת | ✅ כן | ❌ לא | טאב AI |
| `customer_service_ai` | **הערות ידניות להקשר AI** | ✅ כן | ✅ כן | טאב AI |
| `manual` | הערות חופשיות (עם/בלי קבצים) | ❌ לא | ✅ כן | טאב הערות חופשיות |

## מה השתנה

### 1. מיגרציה בבסיס הנתונים

**מיגרציה 75** עושה שלושה דברים:

1. **מעדכנת הערות קיימות**: משנה הערות ידניות ללא קבצים וללא משתמש ל-`customer_service_ai`
2. **מוסיפה אינדקס**: יוצרת אינדקס `idx_lead_notes_type_tenant` לסינון יעיל
3. **שומרת על הנתונים**: אפס אובדן מידע - רק מעדכנת את השדה note_type

### 2. שינויים בצד השרת

**כלי CRM (`tools_crm_context.py`)**:

```python
# ישן: סינון מורכב של הערות ידניות ללא קבצים
notes_query = LeadNote.query.filter(
    LeadNote.note_type == 'call_summary',
    LeadNote.note_type == 'system',
    db.and_(LeadNote.note_type == 'manual', LeadNote.attachments == None)
)

# חדש: סינון פשוט של הערות שירות לקוחות AI
notes_query = LeadNote.query.filter(
    db.or_(
        LeadNote.note_type == 'call_summary',
        LeadNote.note_type == 'system',
        LeadNote.note_type == 'customer_service_ai'  # סוג חדש
    )
)
```

**API Routes (`routes_leads.py`)**:
- מקבל את השדה `note_type` מהבקשה
- מאמת מול סוגי הערות מותרים
- מחזיר את ה-`note_type` בתגובה

### 3. שינויים בצד הלקוח

**טאב שירות לקוחות AI**:

```typescript
// ישן: סינון הערות ידניות ללא קבצים
const aiNotes = response.notes.filter(note => 
  note.note_type === 'call_summary' || 
  note.note_type === 'system' ||
  (note.note_type === 'manual' && (!note.attachments || note.attachments.length === 0))
);

// חדש: סינון הערות customer_service_ai
const aiNotes = response.notes.filter(note => 
  note.note_type === 'call_summary' || 
  note.note_type === 'system' ||
  note.note_type === 'customer_service_ai'
);
```

**יצירת הערה עם הסוג הנכון**:

```typescript
// ישן: ללא ציון note_type (ברירת מחדל 'manual')
const response = await http.post(`/api/leads/${lead.id}/notes`, {
  content: newNoteContent.trim()
});

// חדש: מציין customer_service_ai
const response = await http.post(`/api/leads/${lead.id}/notes`, {
  content: newNoteContent.trim(),
  note_type: 'customer_service_ai'
});
```

## איך זה עובד עכשיו

### תרחיש 1: הוספת הערה בטאב שירות לקוחות AI

1. משתמש מוסיף הערה: "לקוח מעדיף פגישות בבוקר"
2. Frontend שולח: `{ content: "...", note_type: "customer_service_ai" }`
3. Backend יוצר הערה עם `note_type='customer_service_ai'`
4. ההערה מופיעה **רק** בטאב שירות לקוחות AI
5. ה-AI **כן יכול** לראות את ההערה בשיחות עתידיות

### תרחיש 2: הוספת הערה בטאב הערות חופשיות

1. משתמש מוסיף הערה: "הערות כלליות" עם קובץ מצורף
2. Frontend שולח: `{ content: "...", note_type: "manual" }`
3. Backend יוצר הערה עם `note_type='manual'`
4. ההערה מופיעה **רק** בטאב הערות חופשיות
5. ה-AI **לא יכול** לראות את ההערה

### תרחיש 3: AI קורא הקשר במהלך שיחה

כאשר ה-AI קורא `get_lead_context(business_id, lead_id)`:

```python
# AI מקבל רק את סוגי ההערות הבאים:
- call_summary (סיכומים שנוצרו ע"י AI)
- system (הערות מערכת)
- customer_service_ai (הערות ידניות נראות ל-AI)

# AI לא מקבל:
- manual (הערות חופשיות)
```

## רשימת בדיקות

- [x] מיגרציה 75 נוספה ל-`db_migrate.py`
- [x] Frontend עודכן להשתמש בסוג `customer_service_ai`
- [x] Backend API עודכן לטפל בסוג החדש
- [x] כלי CRM עודכנו לסינון נכון
- [ ] הרצת מיגרציה על בסיס נתונים בדיקה
- [ ] בדיקת הוספת הערה בטאב AI → צריך ליצור `customer_service_ai`
- [ ] בדיקת הוספת הערה בטאב הערות חופשיות → צריך ליצור `manual`
- [ ] בדיקת קריאת הקשר AI → צריך לקבל רק הערות נראות ל-AI
- [ ] אימות שאין חפיפה בין הטאבים

## לפני ואחרי

### לפני מיגרציה 75 ❌

```
טאב שירות לקוחות AI:
  ├─ סיכום שיחה (AI) ✓
  ├─ הערת מערכת ✓
  └─ הערה ידנית (ללא קבצים) ✓  ← בעיה: מופיע גם בהערות חופשיות

טאב הערות חופשיות:
  ├─ הערה ידנית (ללא קבצים) ✓  ← בעיה: מופיע גם בטאב AI
  └─ הערה ידנית (עם קבצים) ✓
```

### אחרי מיגרציה 75 ✅

```
טאב שירות לקוחות AI:
  ├─ סיכום שיחה (AI) ✓
  ├─ הערת מערכת ✓
  └─ הערת שירות לקוחות AI ✓  ← חדש: הערה ידנית נראית ל-AI

טאב הערות חופשיות:
  └─ הערה ידנית (עם/בלי קבצים) ✓  ← נפרד מטאב AI
```

## אבטחה ושמירה על נתונים

✅ **בטוח למולטי-טננט**: כל השאילתות מסוננות לפי `tenant_id`  
✅ **אין אובדן מידע**: המיגרציה רק מעדכנת את note_type  
✅ **תאימות לאחור**: הערות קיימות ממשיכות לעבוד  
✅ **אידמפוטנט**: המיגרציה יכולה לרוץ מספר פעמים בבטחה  

## קבצים ששונו

1. `server/db_migrate.py` - נוספה מיגרציה 75
2. `server/agent_tools/tools_crm_context.py` - עודכן סינון הקשר AI
3. `server/routes_leads.py` - נוסף טיפול ב-note_type
4. `client/src/pages/Leads/LeadDetailPage.tsx` - עודכנה לוגיקת Frontend

## תאריך

**נוצר**: 18 ינואר 2026  
**מספר מיגרציה**: 75  
**סטטוס**: ✅ מוכן לפריסה
