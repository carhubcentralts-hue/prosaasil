# ===========================================
# ProSaaS - Environment Variables Template
# ===========================================
# Copy this file to .env and fill in your actual values
# NEVER commit .env files with real secrets!
# ===========================================

# ===========================================
# DOMAIN & PUBLIC URLS
# ===========================================
# ‚úÖ CRITICAL: Set these to your production domain (e.g., https://prosaas.pro)
PUBLIC_HOST=https://prosaas.pro
PUBLIC_BASE_URL=https://prosaas.pro

# ===========================================
# DOCKER NETWORK CONFIGURATION
# ===========================================
# Docker network name for all services
# ‚ö†Ô∏è IMPORTANT: Run scripts/ensure_docker_network.sh before docker compose up
DOCKER_NETWORK_NAME=prosaas-net

# ===========================================
# DATABASE (Docker local or managed)
# ===========================================
# For Docker local development:
POSTGRES_USER=prosaas
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_DB=prosaas
DB_PORT=5432

# For production (managed database - Railway, Neon, Supabase, etc.):
# ‚ö†Ô∏è CRITICAL FOR SUPABASE: Use separate URLs for pooler and direct connections
#
# DATABASE_URL_POOLER: Connection pooler for API/Worker traffic (pgbouncer/supavisor)
#   - Use for: API requests, worker jobs, frontend calls
#   - Format: postgresql://user:pass@xyz.pooler.supabase.com:5432/postgres
#
# DATABASE_URL_DIRECT: Direct database connection for migrations and DDL
#   - Use for: Migrations, indexer, backfill operations
#   - Format: postgresql://user:pass@xyz.db.supabase.com:5432/postgres
#   - This bypasses the pooler to avoid "ghost locks" during DDL operations
#
# For non-Supabase databases (Railway, Neon, local), set both to the same value.
DATABASE_URL_POOLER=postgresql://user:password@host.pooler.supabase.com:5432/database
DATABASE_URL_DIRECT=postgresql://user:password@host.db.supabase.com:5432/database

# Legacy: DATABASE_URL (fallback - DATABASE_URL_POOLER and DATABASE_URL_DIRECT are recommended)
# If set, this will be used as fallback for both pooler and direct connections
# Recommended to use DATABASE_URL_POOLER and DATABASE_URL_DIRECT for Supabase
DATABASE_URL=postgresql://user:password@host:5432/database

# ===========================================
# N8N AUTOMATION PLATFORM DATABASE
# ===========================================
# n8n needs its own database configuration
# üî• IMPORTANT: Use the SAME database as DATABASE_URL or a separate n8n database
# If using the same database, copy the same credentials
N8N_DB_TYPE=postgresdb
N8N_DB_HOST=your-db-host.com
N8N_DB_PORT=5432
N8N_DB_NAME=postgres
N8N_DB_USER=your-db-user
N8N_DB_PASSWORD=your-db-password
N8N_DB_SSL=true

# N8N Encryption Keys (CRITICAL - keep these secret!)
# ‚ö†Ô∏è WARNING: NO DEFAULTS in docker-compose - these MUST be set in .env
# Generate with: python3 -c "import secrets; print(secrets.token_urlsafe(32))"
N8N_ENCRYPTION_KEY=generate-a-random-32-char-string
N8N_JWT_SECRET=generate-another-random-32-char-string

# N8N Public Configuration
# ‚ö†Ô∏è WARNING: NO DEFAULTS in docker-compose - these MUST be set in .env
# Replace with your actual domain (e.g., n8n.yourdomain.com)
N8N_HOST=n8n.prosaas.pro
N8N_PROTOCOL=https
N8N_EDITOR_BASE_URL=https://n8n.yourdomain.com
N8N_WEBHOOK_URL=https://n8n.yourdomain.com

# ===========================================
# OPENAI API
# ===========================================
OPENAI_API_KEY=sk-your-openai-api-key

# ===========================================
# TWILIO CREDENTIALS
# ===========================================
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your-twilio-auth-token
TWILIO_PHONE_NUMBER=+1234567890

# Twilio Signature Validation (set to false for testing behind proxies)
VALIDATE_TWILIO_SIGNATURE=true

# ===========================================
# WHATSAPP CONFIGURATION
# ===========================================
WHATSAPP_PROVIDER=auto
# ‚úÖ CRITICAL: For Docker deployments, use internal Docker network address
# For Docker: http://baileys:3300
# For local dev: http://127.0.0.1:3300
BAILEYS_BASE_URL=http://baileys:3300
BAILEYS_OUTBOUND_URL=http://baileys:3300/send
BAILEYS_WEBHOOK_SECRET=your-secret-token

# ‚úÖ FIX for 405: Webhook secret for external services (n8n, Zapier)
# This allows external services to send WhatsApp messages via /api/whatsapp/webhook/send
# Generate with: openssl rand -hex 32
WHATSAPP_WEBHOOK_SECRET=your-webhook-secret-generate-random-here

# ‚úÖ Meta WhatsApp Cloud API Configuration (Optional - Alternative to Baileys)
# If you want to use Meta's official WhatsApp Business Cloud API instead of Baileys
# Get these from: https://developers.facebook.com/apps/
META_WA_ACCESS_TOKEN=your-meta-whatsapp-access-token
META_WA_PHONE_NUMBER_ID=your-phone-number-id
META_WA_WABA_ID=your-whatsapp-business-account-id
META_WA_API_VERSION=v21.0
META_WA_VERIFY_TOKEN=your-webhook-verify-token

# ===========================================
# VOICE CALLS - OpenAI Realtime API (RECOMMENDED)
# ===========================================
# ‚úÖ USE_REALTIME_API=true ‚Üí Uses OpenAI Realtime API (no GCP needed!)
# ‚ùå USE_REALTIME_API=false ‚Üí Uses Google Cloud TTS/STT (requires GCP credentials)
USE_REALTIME_API=true

# ===========================================
# GOOGLE CLOUD SERVICES (DISABLED - Production Stability)
# ===========================================
# ‚úÖ DISABLE_GOOGLE=true ‚Üí Disables OLD Google Cloud STT (NOT Gemini!)
# ‚ö†Ô∏è Old Google STT/TTS is DISABLED for production stability
# üî• NOTE: This does NOT affect Gemini API - Gemini works independently!
# üî• NOTE: Google Cloud STT for Gemini provider uses GOOGLE_APPLICATION_CREDENTIALS
DISABLE_GOOGLE=true

# ‚ùå REMOVED: Legacy environment variables (DO NOT USE)
# These variables are no longer supported:
# - GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON (replaced by GOOGLE_APPLICATION_CREDENTIALS)
# - GOOGLE_STT_PROJECT_ID (not needed with service account)
# - GCP_PROJECT_ID (not needed with service account)

# ===========================================
# GEMINI API (Modern AI - LLM + TTS + STT)
# ===========================================
# üî• CRITICAL: Gemini LLM and TTS use GEMINI_API_KEY
# Required if business.ai_provider = 'gemini'
# Get your API key from: https://makersuite.google.com/app/apikey
# ‚ùó Use ONLY this variable name - no fallbacks to other names
# üéØ When set, Gemini will be used for:
#    - LLM (instead of OpenAI GPT)
#    - TTS (instead of OpenAI voices)
#    - Voice preview in settings
GEMINI_API_KEY=

# üîë Google Cloud Speech-to-Text (STT) Service Account
# ‚ö†Ô∏è CRITICAL: STT requires SEPARATE authentication from Gemini!
# Gemini API Key ‚â† Google Cloud STT credentials
# These are two different auth mechanisms, even if in the same project.
# 
# GOOGLE_APPLICATION_CREDENTIALS must point to a service account JSON file
# Example: /root/secrets/gcp-stt-sa.json
# 
# Steps to set up:
# 1. Create a service account in Google Cloud Console
# 2. Grant it "Speech-to-Text User" role
# 3. Download the JSON key file
# 4. Upload to server (e.g., /root/secrets/gcp-stt-sa.json)
# 5. Set this variable to the full path
GOOGLE_APPLICATION_CREDENTIALS=/root/secrets/gcp-stt-sa.json

# ===========================================
# VOICE PARAMETERS (OPTIONAL - for calls)
# ===========================================
MIN_UTT_SEC=1.5
MAX_UTT_SEC=8.0
VAD_RMS=65
BARGE_IN_VOICE_FRAMES=40
VAD_HANGOVER_MS=400
REPLY_REFRACTORY_MS=1500
TTS_SPEAKING_RATE=1.1
TTS_VOICE=he-IL-Standard-A
TTS_RATE=1.0
TTS_PITCH=0.0

# ===========================================
# CALLS CAPACITY MANAGEMENT (P3 Production Stabilization)
# ===========================================
# Maximum number of concurrent active calls
# Production default: 15 (if not set and PRODUCTION=1)
# Development default: 50 (if not set and PRODUCTION=0)
# Increase this value to scale capacity (e.g., 25, 40, 80)
MAX_ACTIVE_CALLS=15

# Behavior when capacity is reached
# - reject: Return TwiML message and hang up (default)
# - voicemail: Redirect to voicemail (future feature)
# - whatsapp: Suggest WhatsApp contact (future feature)
CALLS_OVER_CAPACITY_BEHAVIOR=reject

# Log level for capacity events (DEBUG, INFO, WARNING, ERROR)
CALLS_CAPACITY_LOG_LEVEL=WARNING

# ===========================================
# WORKER QUEUE CONFIGURATION (P3-2 Threads ‚Üí Queue)
# ===========================================
# Use Redis Queue (RQ) for heavy operations instead of threading
# When disabled, falls back to threading (development only)
# Production: ALWAYS keep this enabled (1)
USE_RQ_FOR_RECEIPTS=1

# ===========================================
# FAQ FAST-PATH (Voice Calls Only)
# ===========================================
FAQ_FASTPATH_ENABLED=1
FAQ_MIN_SCORE=0.78
FAQ_CACHE_TTL_SEC=120
FAQ_EMBEDDINGS_ENABLED=1

# ===========================================
# AI & AGENTKIT
# ===========================================
AGENTS_ENABLED=1
AGENT_MAX_OUTPUT_TOKENS=160
AI_FIRST_REPLY_WORDS=24
AI_MAX_WORDS_FIRST_REPLY=24

# ===========================================
# FEATURE FLAGS (Disable unused features)
# ===========================================
# ‚ö†Ô∏è BUILD 154: Payments & Contracts currently disabled
# Set to 'true' only when these features are fully implemented
ENABLE_PAYMENTS=false
ENABLE_CONTRACTS=false

# ===========================================
# SECURITY
# ===========================================
# Flask SECRET_KEY - used for session signing and CSRF protection
# üîí CRITICAL: Generate a strong random secret in production
# Generate with: python3 -c "import secrets; print(secrets.token_hex(32))"
SECRET_KEY=your-super-secret-key-change-in-production
SESSION_TIMEOUT=3600

# Internal Secret - for operational/internal endpoints
# üîí CRITICAL: Required in production for /api/jobs/*, /health/details endpoints
# Generate with: python3 -c "import secrets; print(secrets.token_hex(32))"
# Used via X-Internal-Secret header for internal monitoring and health checks
INTERNAL_SECRET=your_internal_secret_here

# ===========================================
# SENDGRID EMAIL SERVICE
# ===========================================
# ‚úÖ ONLY SendGrid credentials in ENV - all business logic in code
# SendGrid API key for sending emails (password reset, notifications, etc.)
# Get your API key from: https://app.sendgrid.com/settings/api_keys
# NOTE: System works without SendGrid, but password reset won't send actual emails
SENDGRID_API_KEY=SG_your-sendgrid-api-key-here
MAIL_FROM_EMAIL=noreply@prosaas.pro
MAIL_FROM_NAME=PROSAAS
MAIL_REPLY_TO=support@prosaas.pro

# ===========================================
# AUTH SYSTEM CONFIGURATION
# ===========================================
# ‚úÖ All timeouts and expiry values are hardcoded in auth_service.py
# - ACCESS_TOKEN: 90 minutes
# - REFRESH_TOKEN: 24 hours (default) / 30 days (remember me)
# - IDLE_TIMEOUT: 75 minutes
# - PASSWORD_RESET: 60 minutes
# No ENV variables needed - business logic stays in code!

# ===========================================
# SERVER PORTS (Docker)
# ===========================================
BACKEND_PORT=5000
BAILEYS_PORT=3300
FRONTEND_PORT=80

# ===========================================
# ENVIRONMENT
# ===========================================
DEBUG=false
DEBUG_TX=false  # Set to true to enable TX loop diagnostics and stack traces
FLASK_ENV=production
NODE_ENV=production
# üî• CRITICAL: Set to 1 for production mode
# Enforces: R2 storage, secure cookies, no fallback secrets
PRODUCTION=1

# Cookie Security (enforced in production when PRODUCTION=1)
# COOKIE_SECURE: Set to 'true' to enforce HTTPS-only cookies
# SAMESITE: 'Lax' for same-site requests, 'None' only if cross-site is required
COOKIE_SECURE=true
SAMESITE=Lax

# Service Role (CRITICAL for migration control)
# api    - Main API service (runs migrations on startup)
# worker - Background worker service (NEVER runs migrations)
# This prevents workers from trying to run migrations which causes:
# - pg_advisory_lock timeouts
# - Duplicate migration runs
# - Unnecessary database load
SERVICE_ROLE=api

# Database Migration Enforcement
# MIGRATIONS_ENFORCE=true   # Production: Server won't start if schema drift detected
# MIGRATIONS_ENFORCE=false  # Local/Debug: Allow startup with warnings
# Default: false (for backwards compatibility)
MIGRATIONS_ENFORCE=false

# Run migrations on startup (production recommended for API service)
# Only affects API service - workers NEVER run migrations regardless of this setting
RUN_MIGRATIONS_ON_START=1

# ===========================================
# ATTACHMENT STORAGE - R2 Configuration (REQUIRED in Production)
# ===========================================
# ‚úÖ CRITICAL: In production, ATTACHMENT_STORAGE_DRIVER must be 'r2'
# ‚ùå Local storage is NOT allowed in production
ATTACHMENT_STORAGE_DRIVER=r2

# üîí ATTACHMENT_SECRET - MUST be changed in production!
# Generate with: python3 -c "import secrets; print(secrets.token_urlsafe(32))"
ATTACHMENT_SECRET=CHANGE_ME_TO_RANDOM_SECRET_KEY_IN_PRODUCTION

# üåê Cloudflare R2 Configuration (REQUIRED when ATTACHMENT_STORAGE_DRIVER=r2)
# Get these from: https://dash.cloudflare.com ‚Üí R2 ‚Üí Manage R2 API Tokens
R2_ACCOUNT_ID=your-cloudflare-account-id-here
R2_BUCKET_NAME=prosaas-attachment
R2_ACCESS_KEY_ID=your-r2-access-key-id-here
R2_SECRET_ACCESS_KEY=your-r2-secret-access-key-here
R2_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com

# ===========================================
# IMPORTANT: R2 Storage Notes
# ===========================================
# 1. ALL file uploads (CRM, WhatsApp, Contracts) use the SAME R2 bucket
# 2. Logical separation is in the DATABASE (attachments, contract_files tables)
# 3. Physical storage is unified in R2 with different key prefixes
# 4. NO separate R2 configuration needed for contracts - they use AttachmentService
# 5. In production, if R2 is not configured, the system will FAIL (no silent fallback)

# ===========================================
# n8n WORKFLOW AUTOMATION
# ===========================================
# n8n UI will be accessible at: https://prosaas.pro/n8n
# Webhooks at: https://prosaas.pro/n8n/webhook/...

# n8n Server Settings (Docker)
N8N_PORT=5678
N8N_USER=admin
N8N_PASSWORD=your_secure_n8n_password
TZ=Asia/Jerusalem

# n8n Integration (Backend sends events to n8n)
# Set N8N_ENABLED=true to activate event sending
N8N_ENABLED=false
N8N_WEBHOOK_URL=https://prosaas.pro/n8n/webhook/your-workflow-id
N8N_WEBHOOK_SECRET=your_secret_token_here

# ===========================================
# GMAIL RECEIPTS INTEGRATION
# ===========================================
# Get these from Google Cloud Console:
# 1. Create a project at https://console.cloud.google.com
# 2. Enable Gmail API
# 3. Create OAuth 2.0 credentials (Web application)
# 4. Add redirect URI: https://prosaas.pro/api/gmail/oauth/callback

GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REDIRECT_URI=https://prosaas.pro/api/gmail/oauth/callback

# Encryption key for storing OAuth refresh tokens (generate with: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())")
ENCRYPTION_KEY=your-fernet-encryption-key
